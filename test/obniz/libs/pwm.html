<!doctype>
<html>
  <head>
    <title>Test</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/Users/kido/Documents/extra/obniz/obnizjs//node_modules/mocha/mocha.css" />
    <script src="/Users/kido/Documents/extra/obniz/obnizjs//node_modules/mocha/mocha.js"></script> 
    <script src="/Users/kido/Documents/extra/obniz/obnizjs//node_modules/chai/chai.js"></script> 
    <script src="/Users/kido/Documents/extra/obniz/obnizjs//node_modules/sinon/pkg/sinon.js"></script> 
    <script src="/Users/kido/Documents/extra/obniz/obnizjs//index.js"></script> 
    <script src="/Users/kido/Documents/extra/obniz/obnizjs//test/testUtil-browser.ejs"></script> 
  </head>
  <body>
    <script>
      expect = chai.expect;
      assert = chai.assert;
      mocha.setup('bdd');
      
      chai.use(testUtil.obnizAssert);
    </script>
    <div id="mocha"></div>
    <script>
        
      describe("obniz.libs.pwm", function () {
  beforeEach(function (done) {
    return testUtil.setupObnizPromise(this,done);   
  });
 
  afterEach(function (done) {
    return testUtil.releaseObnizePromise(this,done);
  });
  
  
  it("getpwm",  function () {
    var pwm = this.obniz.getpwm();
    
    expect(this.obniz).to.be.finished;
    expect(pwm).to.be.equal(this.obniz.pwm0);
  });
  
  it.skip("getpwm double",  function () {
    var pwm1 = this.obniz.getpwm();
    var pwm2 = this.obniz.getpwm();
    
    expect(this.obniz).to.be.finished;
    expect(pwm1).to.be.equal(this.obniz.pwm0);
    expect(pwm2).to.be.equal(this.obniz.pwm1);
  });
  
  it("start io",  function () {
    var pwm = this.obniz.getpwm();
    pwm.start(11);
    
    expect(this.obniz).send({pwm0:{"io": 11}});
    expect(this.obniz).to.be.finished;
    expect(pwm).to.be.equal(this.obniz.pwm0);
  });
  
  it.skip("start io invalid",  function () {
    var pwm = this.obniz.getpwm();
    pwm.start(15);
    
    expect(this.obniz).send({pwm0:{"io": 15}});
    expect(this.obniz).to.be.finished;
    expect(pwm).to.be.equal(this.obniz.pwm0);
  });
  
  it("freq",  function () {
    var pwm = this.obniz.getpwm();
    pwm.start(10); 
    expect(this.obniz).send({pwm0:{"io": 10}});
    pwm.freq(1000);
    expect(this.obniz).send({pwm0:{"freq": 1000}});
    
    expect(this.obniz).to.be.finished;
    expect(pwm).to.be.equal(this.obniz.pwm0);
  });
  
  it("pulse",  function () {
    var pwm = this.obniz.getpwm();
    pwm.start(9); 
    expect(this.obniz).send({pwm0:{"io": 9}});
    pwm.freq(500); 
    expect(this.obniz).send({pwm0:{"freq": 500}});
    pwm.pulse(0.5); 
    expect(this.obniz).send({pwm0:{"pulse": 0.5}});
    
    expect(this.obniz).to.be.finished;
    expect(pwm).to.be.equal(this.obniz.pwm0);
  });
  
  it("duty",  function () {
    var pwm = this.obniz.getpwm();
    pwm.start(9); 
    expect(this.obniz).send({pwm0:{"io": 9}});
    pwm.freq(500); 
    expect(this.obniz).send({pwm0:{"freq": 500}});
    pwm.duty(0.5); 
    expect(this.obniz).send({pwm0:{"duty": 0.5}});
    
    expect(this.obniz).to.be.finished;
    expect(pwm).to.be.equal(this.obniz.pwm0);
  });
  
  
  it("force working",  function () {
    var pwm = this.obniz.getpwm();
    pwm.start(9); 
    expect(this.obniz).send({pwm0:{"io": 9}});
    pwm.freq(500); 
    expect(this.obniz).send({pwm0:{"freq": 500}});
    pwm.duty(0.5); 
    expect(this.obniz).send({pwm0:{"duty": 0.5}});
    pwm.forceWorking(true);
    expect(this.obniz).send({pwm0:{"force_working": true}});
    
    expect(this.obniz).to.be.finished;
    expect(pwm).to.be.equal(this.obniz.pwm0);
  });
  
  it("modulate",  function () {
    var pwm = this.obniz.getpwm();
    pwm.start(11);   // start pwm. output at io11
    expect(this.obniz).send({pwm0:{"io": 11}});
    pwm.freq(38000); // set pwm frequency to 38khz
    expect(this.obniz).send({pwm0:{"freq": 38000}});

    // signal for room heater's remote signal
    var arr = [255,0,0,0,0,0,0,255,255,254,1,192,62,3,255,254,3,192,63,255,192,60,3,224,62,3,255,254,3,255,254,3,224,62,3,224,63,255,192,63,255,224,62,3,224,62,3,224,62,3,224,62,3,240,31,3,240,31,1,240,31,1,255,255,1,240,31,1,240,31,1,248,31,129,240,31,255,248,31,129,248,15,128,248,15,255,248,15,128,248,15,128,248,15,128,252,15,255,255];

    pwm.modulate("am", 0.00007, arr); // am modulate. symbol length = 70usec.

    expect(this.obniz).send({pwm0:{"modulate": {data : arr, "symbol_sec": 0.00007, "type": "am"}}});
    expect(this.obniz).to.be.finished;
    expect(pwm).to.be.equal(this.obniz.pwm0);
  });
  it("modulateのドキュメントに詳細or具体例が必要");
  
  it("end",  function () {
    var pwm = this.obniz.getpwm();
    pwm.start(11); 
    expect(this.obniz).send({pwm0:{"io": 11}});
    pwm.end();   
    expect(this.obniz).send({pwm0: null});
    expect(this.obniz).to.be.finished;
    expect(pwm).to.be.equal(this.obniz.pwm0);
  });
});

      mocha.run();
    </script> 
  </body>
</html>
<!doctype>
<html>
  <head>
    <title>Test</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/Users/kido/Documents/extra/obniz/obnizjs//node_modules/mocha/mocha.css" />
    <script src="/Users/kido/Documents/extra/obniz/obnizjs//node_modules/mocha/mocha.js"></script> 
    <script src="/Users/kido/Documents/extra/obniz/obnizjs//node_modules/chai/chai.js"></script> 
    <script src="/Users/kido/Documents/extra/obniz/obnizjs//node_modules/sinon/pkg/sinon.js"></script> 
    <script src="/Users/kido/Documents/extra/obniz/obnizjs//index.js"></script> 
    <script src="/Users/kido/Documents/extra/obniz/obnizjs//test/testUtil-browser.ejs"></script> 
  </head>
  <body>
    <script>
      expect = chai.expect;
      assert = chai.assert;
      mocha.setup('bdd');
      
      chai.use(testUtil.obnizAssert);
    </script>
    <div id="mocha"></div>
    <script>
        
      describe("obniz.libs.switch", function () {
  beforeEach(function (done) {
    return testUtil.setupObnizPromise(this,done);
    
  });
  
  afterEach(function (done) {
    return testUtil.releaseObnizePromise(this,done);
  });
  
  it("onchange", function () {
    var stub = sinon.stub();
    this.obniz.switch.onchange = stub;
    expect(this.obniz).to.be.obniz;
    sinon.assert.callCount(stub, 0);
    
    testUtil.receiveJson(this.obniz,  {"switch":{"state":"none"}});
    
    sinon.assert.callCount(stub, 1);
    expect(stub.getCall(0).args[0]).to.be.equal("none");
    
    expect(this.obniz).to.be.finished;
  });
  
  it.skip("onchange changeしてないのにaction:getに反応しちゃってる", function () {
    var stub = sinon.stub();
    this.obniz.switch.onchange = stub;
    expect(this.obniz).to.be.obniz;
    sinon.assert.callCount(stub, 0);
    
    testUtil.receiveJson(this.obniz,  {"switch":{"state":"push", "action":"get"}});
    
    sinon.assert.callCount(stub, 0);
    
    expect(this.obniz).to.be.finished;
  });
  
  it("inputWaitLeft", function () {
    
    return new Promise(function(resolve, reject){
      this.obniz.switch.getWait().then(function(result){
        expect(result).to.be.equal("left");  
        resolve();
      });

      expect(this.obniz).to.be.obniz;
      expect(this.obniz).send({"switch":"get"});  
        expect(this.obniz).to.be.finished;

      setTimeout(function(){    
        testUtil.receiveJson(this.obniz,  {"switch":{"state":"left", "action":"get"}});
      }.bind(this),10);
    }.bind(this));
    
  });
  
});

      mocha.run();
    </script> 
  </body>
</html>
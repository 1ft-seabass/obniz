"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const ObnizComponents_1 = __importDefault(require("./ObnizComponents"));
class ObnizSystemMethods extends ObnizComponents_1.default {
    constructor(id, options) {
        super(id, options);
    }
    wait(msec) {
        if (msec < 0) {
            msec = 0;
        }
        else if (msec > 60 * 1000) {
            msec = 60 * 1000;
        }
        this.send({ system: { wait: msec } });
        return new Promise((resolve) => setTimeout(resolve, msec));
    }
    reset() {
        this.send({ system: { reset: true } });
        this._resetComponents();
    }
    reboot() {
        this.send({ system: { reboot: true } });
    }
    selfCheck() {
        this.send({ system: { self_check: true } });
    }
    keepWorkingAtOffline(working) {
        this.send({ system: { keep_working_at_offline: working } });
    }
    resetOnDisconnect(reset) {
        this.send({ ws: { reset_obniz_on_ws_disconnection: reset } });
    }
    sleepSeconds(sec) {
        if (sec < 1) {
            // min 1s
            sec = 1;
        }
        else if (sec > 60 * 60 * 18) {
            // max 18h (60(s)*60(m)*18(h))
            throw new Error("Error max 18h(64800) sleep");
        }
        this.send({ system: { sleep_seconds: sec } });
    }
    sleepMinute(minute) {
        if (minute < 1) {
            // min 1m
            minute = 1;
        }
        else if (minute > 60 * 24 * 45) {
            // max 45day (60(m)*24(h)*45(d))
            throw new Error("max 45day(64800m) sleep");
        }
        this.send({ system: { sleep_minute: minute } });
    }
    sleep(date) {
        if (!(date instanceof Date)) {
            throw new Error("Date instance argument required");
        }
        let sleepTime = Math.floor((date - new Date()) / 1000);
        this.print_debug(`sleep time : ${sleepTime}s`);
        if (sleepTime <= 0) {
            throw new Error(`past sleep time : ${sleepTime}s`);
        }
        if (sleepTime <= 60 * 60 * 18) {
            this.sleepSeconds(sleepTime);
            return;
        }
        sleepTime = Math.floor(sleepTime / 60);
        this.print_debug(`sleep time : ${sleepTime}m`);
        if (sleepTime <= 60 * 24 * 45) {
            this.sleepMinute(sleepTime);
        }
        else {
            throw new Error(`over max sleep time : ${sleepTime}m`);
        }
    }
    sleepIoTrigger(trigger) {
        if (typeof trigger !== "boolean") {
            throw new Error("sleepIoTrigger need boolean arg");
        }
        this.send({ system: { sleep_io_trigger: trigger } });
    }
    pingWait(unixtime, rand, forceGlobalNetwork) {
        unixtime = unixtime || new Date().getTime();
        const upper = Math.floor(unixtime / Math.pow(2, 32));
        const lower = unixtime - upper * Math.pow(2, 32);
        rand = rand || Math.floor(Math.random() * Math.pow(2, 4));
        const buf = [];
        buf.push((upper >>> (8 * 3)) & 0xff);
        buf.push((upper >>> (8 * 2)) & 0xff);
        buf.push((upper >>> (8 * 1)) & 0xff);
        buf.push((upper >>> (8 * 0)) & 0xff);
        buf.push((lower >>> (8 * 3)) & 0xff);
        buf.push((lower >>> (8 * 2)) & 0xff);
        buf.push((lower >>> (8 * 1)) & 0xff);
        buf.push((lower >>> (8 * 0)) & 0xff);
        buf.push((rand >>> (8 * 3)) & 0xff);
        buf.push((rand >>> (8 * 2)) & 0xff);
        buf.push((rand >>> (8 * 1)) & 0xff);
        buf.push((rand >>> (8 * 0)) & 0xff);
        const obj = {
            system: {
                ping: {
                    key: buf,
                },
            },
        };
        this.send(obj, { local_connect: forceGlobalNetwork ? false : true });
        return new Promise((resolve) => {
            const callback = (systemObj) => {
                for (let i = 0; i < buf.length; i++) {
                    if (buf[i] !== systemObj.pong.key[i]) {
                        return;
                    }
                }
                this.removePongObserver(callback);
                const _upper = ((systemObj.pong.key[0] << (8 * 3)) >>> 0) +
                    ((systemObj.pong.key[1] << (8 * 2)) >>> 0) +
                    ((systemObj.pong.key[2] << (8 * 1)) >>> 0) +
                    ((systemObj.pong.key[3] << (8 * 0)) >>> 0);
                const _lower = ((systemObj.pong.key[4] << (8 * 3)) >>> 0) +
                    ((systemObj.pong.key[5] << (8 * 2)) >>> 0) +
                    ((systemObj.pong.key[6] << (8 * 1)) >>> 0) +
                    ((systemObj.pong.key[7] << (8 * 0)) >>> 0);
                const obnizJsPingUnixtime = _upper * Math.pow(2, 32) + _lower;
                const obnizJsPongUnixtime = new Date().getTime();
                const allTime = obnizJsPongUnixtime - obnizJsPingUnixtime;
                const timeJs2server = systemObj.pong.pingServerTime - obnizJsPingUnixtime;
                const timeServer2Obniz = systemObj.pong.obnizTime - systemObj.pong.pingServerTime;
                const timeObniz2Server = systemObj.pong.pongServerTime - systemObj.pong.obnizTime;
                const timeServer2Js = obnizJsPongUnixtime - systemObj.pong.pongServerTime;
                const str = `ping ${allTime}ms (js --[${timeJs2server}ms]--> server --[${timeServer2Obniz}ms]--> obniz --[${timeObniz2Server}ms]--> server --[${timeServer2Js}ms]--> js)`;
                this.print_debug(str);
                resolve(str);
            };
            this.addPongObserver(callback);
        });
    }
}
exports.default = ObnizSystemMethods;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9PYm5pelN5c3RlbU1ldGhvZHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSx3RUFBZ0Q7QUFFaEQsTUFBcUIsa0JBQW1CLFNBQVEseUJBQWU7SUFDN0QsWUFBWSxFQUFPLEVBQUUsT0FBWTtRQUMvQixLQUFLLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3JCLENBQUM7SUFFTSxJQUFJLENBQUMsSUFBUztRQUNuQixJQUFJLElBQUksR0FBRyxDQUFDLEVBQUU7WUFDWixJQUFJLEdBQUcsQ0FBQyxDQUFDO1NBQ1Y7YUFBTSxJQUFJLElBQUksR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFO1lBQzNCLElBQUksR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO1NBQ2xCO1FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFDLE1BQU0sRUFBRSxFQUFDLElBQUksRUFBRSxJQUFJLEVBQUMsRUFBQyxDQUFDLENBQUM7UUFDbEMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFTSxLQUFLO1FBQ1YsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFDLE1BQU0sRUFBRSxFQUFDLEtBQUssRUFBRSxJQUFJLEVBQUMsRUFBQyxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVNLE1BQU07UUFDWCxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUMsTUFBTSxFQUFFLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBQyxFQUFDLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRU0sU0FBUztRQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBQyxNQUFNLEVBQUUsRUFBQyxVQUFVLEVBQUUsSUFBSSxFQUFDLEVBQUMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFTSxvQkFB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LFFBQVEsR0FBRyxRQUFRLElBQUksSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM1QyxNQUFNLEtBQUssR0FBUSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzFELE1BQU0sS0FBSyxHQUFRLFFBQVEsR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDdEQsSUFBSSxHQUFHLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzFELE1BQU0sR0FBRyxHQUFRLEVBQUUsQ0FBQztRQUVwQixHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDckMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3JDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUNyQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDckMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3JDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFD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Q0FBQyxRQUFRLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQXhKRCxxQ0F3SkMiLCJmaWxlIjoic3JjL29ibml6L09ibml6U3lzdGVtTWV0aG9kcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPYm5pekNvbXBvbmVudHMgZnJvbSBcIi4vT2JuaXpDb21wb25lbnRzXCI7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9ibml6U3lzdGVtTWV0aG9kcyBleHRlbmRzIE9ibml6Q29tcG9uZW50cyB7XG4gIGNvbnN0cnVjdG9yKGlkOiBhbnksIG9wdGlvbnM6IGFueSkge1xuICAgIHN1cGVyKGlkLCBvcHRpb25zKTtcbiAgfVxuXG4gIHB1YmxpYyB3YWl0KG1zZWM6IGFueSkge1xuICAgIGlmIChtc2VjIDwgMCkge1xuICAgICAgbXNlYyA9IDA7XG4gICAgfSBlbHNlIGlmIChtc2VjID4gNjAgKiAxMDAwKSB7XG4gICAgICBtc2VjID0gNjAgKiAxMDAwO1xuICAgIH1cbiAgICB0aGlzLnNlbmQoe3N5c3RlbToge3dhaXQ6IG1zZWN9fSk7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zZWMpKTtcbiAgfVxuXG4gIHB1YmxpYyByZXNldCgpIHtcbiAgICB0aGlzLnNlbmQoe3N5c3RlbToge3Jlc2V0OiB0cnVlfX0pO1xuICAgIHRoaXMuX3Jlc2V0Q29tcG9uZW50cygpO1xuICB9XG5cbiAgcHVibGljIHJlYm9vdCgpIHtcbiAgICB0aGlzLnNlbmQoe3N5c3RlbToge3JlYm9vdDogdHJ1ZX19KTtcbiAgfVxuXG4gIHB1YmxpYyBzZWxmQ2hlY2soKSB7XG4gICAgdGhpcy5zZW5kKHtzeXN0ZW06IHtzZWxmX2NoZWNrOiB0cnVlfX0pO1xuICB9XG5cbiAgcHVibGljIGtlZXBXb3JraW5nQXRPZmZsaW5lKHdvcmtpbmc6IGFueSkge1xuICAgIHRoaXMuc2VuZCh7c3lzdGVtOiB7a2VlcF93b3JraW5nX2F0X29mZmxpbmU6IHdvcmtpbmd9fSk7XG4gIH1cblxuICBwdWJsaWMgcmVzZXRPbkRpc2Nvbm5lY3QocmVzZXQ6IGFueSkge1xuICAgIHRoaXMuc2VuZCh7d3M6IHtyZXNldF9vYm5pel9vbl93c19kaXNjb25uZWN0aW9uOiByZXNldH19KTtcbiAgfVxuXG4gIHB1YmxpYyBzbGVlcFNlY29uZHMoc2VjOiBhbnkpIHtcbiAgICBpZiAoc2VjIDwgMSkge1xuICAgICAgLy8gbWluIDFzXG4gICAgICBzZWMgPSAxO1xuICAgIH0gZWxzZSBpZiAoc2VjID4gNjAgKiA2MCAqIDE4KSB7XG4gICAgICAvLyBtYXggMThoICg2MChzKSo2MChtKSoxOChoKSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkVycm9yIG1heCAxOGgoNjQ4MDApIHNsZWVwXCIpO1xuICAgIH1cbiAgICB0aGlzLnNlbmQoe3N5c3RlbToge3NsZWVwX3NlY29uZHM6IHNlY319KTtcbiAgfVxuXG4gIHB1YmxpYyBzbGVlcE1pbnV0ZShtaW51dGU6IGFueSkge1xuICAgIGlmIChtaW51dGUgPCAxKSB7XG4gICAgICAvLyBtaW4gMW1cbiAgICAgIG1pbnV0ZSA9IDE7XG4gICAgfSBlbHNlIGlmIChtaW51dGUgPiA2MCAqIDI0ICogNDUpIHtcbiAgICAgIC8vIG1heCA0NWRheSAoNjAobSkqMjQoaCkqNDUoZCkpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJtYXggNDVkYXkoNjQ4MDBtKSBzbGVlcFwiKTtcbiAgICB9XG4gICAgdGhpcy5zZW5kKHtzeXN0ZW06IHtzbGVlcF9taW51dGU6IG1pbnV0ZX19KTtcbiAgfVxuXG4gIHB1YmxpYyBzbGVlcChkYXRlOiBhbnkpIHtcbiAgICBpZiAoIShkYXRlIGluc3RhbmNlb2YgRGF0ZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkRhdGUgaW5zdGFuY2UgYXJndW1lbnQgcmVxdWlyZWRcIik7XG4gICAgfVxuICAgIGxldCBzbGVlcFRpbWU6IGFueSA9IE1hdGguZmxvb3IoKChkYXRlIGFzIGFueSkgLSAobmV3IERhdGUoKSBhcyBhbnkpKSAvIDEwMDApO1xuICAgIHRoaXMucHJpbnRfZGVidWcoYHNsZWVwIHRpbWUgOiAke3NsZWVwVGltZX1zYCk7XG4gICAgaWYgKHNsZWVwVGltZSA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHBhc3Qgc2xlZXAgdGltZSA6ICR7c2xlZXBUaW1lfXNgKTtcbiAgICB9XG4gICAgaWYgKHNsZWVwVGltZSA8PSA2MCAqIDYwICogMTgpIHtcbiAgICAgIHRoaXMuc2xlZXBTZWNvbmRzKHNsZWVwVGltZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHNsZWVwVGltZSA9IE1hdGguZmxvb3Ioc2xlZXBUaW1lIC8gNjApO1xuICAgIHRoaXMucHJpbnRfZGVidWcoYHNsZWVwIHRpbWUgOiAke3NsZWVwVGltZX1tYCk7XG4gICAgaWYgKHNsZWVwVGltZSA8PSA2MCAqIDI0ICogNDUpIHtcbiAgICAgIHRoaXMuc2xlZXBNaW51dGUoc2xlZXBUaW1lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBvdmVyIG1heCBzbGVlcCB0aW1lIDogJHtzbGVlcFRpbWV9bWApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzbGVlcElvVHJpZ2dlcih0cmlnZ2VyOiBhbnkpIHtcbiAgICBpZiAodHlwZW9mIHRyaWdnZXIgIT09IFwiYm9vbGVhblwiKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJzbGVlcElvVHJpZ2dlciBuZWVkIGJvb2xlYW4gYXJnXCIpO1xuICAgIH1cbiAgICB0aGlzLnNlbmQoe3N5c3RlbToge3NsZWVwX2lvX3RyaWdnZXI6IHRyaWdnZXJ9fSk7XG4gIH1cblxuICBwdWJsaWMgcGluZ1dhaXQodW5peHRpbWU6IGFueSwgcmFuZDogYW55LCBmb3JjZUdsb2JhbE5ldHdvcms6IGFueSkge1xuICAgIHVuaXh0aW1lID0gdW5peHRpbWUgfHwgbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgY29uc3QgdXBwZXI6IGFueSA9IE1hdGguZmxvb3IodW5peHRpbWUgLyBNYXRoLnBvdygyLCAzMikpO1xuICAgIGNvbnN0IGxvd2VyOiBhbnkgPSB1bml4dGltZSAtIHVwcGVyICogTWF0aC5wb3coMiwgMzIpO1xuICAgIHJhbmQgPSByYW5kIHx8IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIE1hdGgucG93KDIsIDQpKTtcbiAgICBjb25zdCBidWY6IGFueSA9IFtdO1xuXG4gICAgYnVmLnB1c2goKHVwcGVyID4+PiAoOCAqIDMpKSAmIDB4ZmYpO1xuICAgIGJ1Zi5wdXNoKCh1cHBlciA+Pj4gKDggKiAyKSkgJiAweGZmKTtcbiAgICBidWYucHVzaCgodXBwZXIgPj4+ICg4ICogMSkpICYgMHhmZik7XG4gICAgYnVmLnB1c2goKHVwcGVyID4+PiAoOCAqIDApKSAmIDB4ZmYpO1xuICAgIGJ1Zi5wdXNoKChsb3dlciA+Pj4gKDggKiAzKSkgJiAweGZmKTtcbiAgICBidWYucHVzaCgobG93ZXIgPj4+ICg4ICogMikpICYgMHhmZik7XG4gICAgYnVmLnB1c2goKGxvd2VyID4+PiAoOCAqIDEpKSAmIDB4ZmYpO1xuICAgIGJ1Zi5wdXNoKChsb3dlciA+Pj4gKDggKiAwKSkgJiAweGZmKTtcbiAgICBidWYucHVzaCgocmFuZCA+Pj4gKDggKiAzKSkgJiAweGZmKTtcbiAgICBidWYucHVzaCgocmFuZCA+Pj4gKDggKiAyKSkgJiAweGZmKTtcbiAgICBidWYucHVzaCgocmFuZCA+Pj4gKDggKiAxKSkgJiAweGZmKTtcbiAgICBidWYucHVzaCgocmFuZCA+Pj4gKDggKiAwKSkgJiAweGZmKTtcblxuICAgIGNvbnN0IG9iajogYW55ID0ge1xuICAgICAgc3lzdGVtOiB7XG4gICAgICAgIHBpbmc6IHtcbiAgICAgICAgICBrZXk6IGJ1ZixcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHRoaXMuc2VuZChvYmosIHtsb2NhbF9jb25uZWN0OiBmb3JjZUdsb2JhbE5ldHdvcmsgPyBmYWxzZSA6IHRydWV9KTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSAoKHJlc29sdmU6IGFueSApID0+IHtcbiAgICAgIGNvbnN0IGNhbGxiYWNrOiBhbnkgPSAoc3lzdGVtT2JqOiBhbnkpID0+IHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWYubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBpZiAoYnVmW2ldICE9PSBzeXN0ZW1PYmoucG9uZy5rZXlbaV0pIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZW1vdmVQb25nT2JzZXJ2ZXIoY2FsbGJhY2spO1xuICAgICAgICBjb25zdCBfdXBwZXI6IGFueSA9XG4gICAgICAgICAgKChzeXN0ZW1PYmoucG9uZy5rZXlbMF0gPDwgKDggKiAzKSkgPj4+IDApICtcbiAgICAgICAgICAoKHN5c3RlbU9iai5wb25nLmtleVsxXSA8PCAoOCAqIDIpKSA+Pj4gMCkgK1xuICAgICAgICAgICgoc3lzdGVtT2JqLnBvbmcua2V5WzJdIDw8ICg4ICogMSkpID4+PiAwKSArXG4gICAgICAgICAgKChzeXN0ZW1PYmoucG9uZy5rZXlbM10gPDwgKDggKiAwKSkgPj4+IDApO1xuICAgICAgICBjb25zdCBfbG93ZXI6IGFueSA9XG4gICAgICAgICAgKChzeXN0ZW1PYmoucG9uZy5rZXlbNF0gPDwgKDggKiAzKSkgPj4+IDApICtcbiAgICAgICAgICAoKHN5c3RlbU9iai5wb25nLmtleVs1XSA8PCAoOCAqIDIpKSA+Pj4gMCkgK1xuICAgICAgICAgICgoc3lzdGVtT2JqLnBvbmcua2V5WzZdIDw8ICg4ICogMSkpID4+PiAwKSArXG4gICAgICAgICAgKChzeXN0ZW1PYmoucG9uZy5rZXlbN10gPDwgKDggKiAwKSkgPj4+IDApO1xuICAgICAgICBjb25zdCBvYm5pekpzUGluZ1VuaXh0aW1lOiBhbnkgPSBfdXBwZXIgKiBNYXRoLnBvdygyLCAzMikgKyBfbG93ZXI7XG4gICAgICAgIGNvbnN0IG9ibml6SnNQb25nVW5peHRpbWU6IGFueSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICBjb25zdCBhbGxUaW1lOiBhbnkgPSBvYm5pekpzUG9uZ1VuaXh0aW1lIC0gb2JuaXpKc1BpbmdVbml4dGltZTtcbiAgICAgICAgY29uc3QgdGltZUpzMnNlcnZlcjogYW55ID0gc3lzdGVtT2JqLnBvbmcucGluZ1NlcnZlclRpbWUgLSBvYm5pekpzUGluZ1VuaXh0aW1lO1xuICAgICAgICBjb25zdCB0aW1lU2VydmVyMk9ibml6OiBhbnkgPVxuICAgICAgICAgIHN5c3RlbU9iai5wb25nLm9ibml6VGltZSAtIHN5c3RlbU9iai5wb25nLnBpbmdTZXJ2ZXJUaW1lO1xuICAgICAgICBjb25zdCB0aW1lT2JuaXoyU2VydmVyOiBhbnkgPVxuICAgICAgICAgIHN5c3RlbU9iai5wb25nLnBvbmdTZXJ2ZXJUaW1lIC0gc3lzdGVtT2JqLnBvbmcub2JuaXpUaW1lO1xuICAgICAgICBjb25zdCB0aW1lU2VydmVyMkpzOiBhbnkgPSBvYm5pekpzUG9uZ1VuaXh0aW1lIC0gc3lzdGVtT2JqLnBvbmcucG9uZ1NlcnZlclRpbWU7XG4gICAgICAgIGNvbnN0IHN0cjogYW55ID0gYHBpbmcgJHthbGxUaW1lfW1zIChqcyAtLVske3RpbWVKczJzZXJ2ZXJ9bXNdLS0+IHNlcnZlciAtLVske3RpbWVTZXJ2ZXIyT2JuaXp9bXNdLS0+IG9ibml6IC0tWyR7dGltZU9ibml6MlNlcnZlcn1tc10tLT4gc2VydmVyIC0tWyR7dGltZVNlcnZlcjJKc31tc10tLT4ganMpYDtcblxuICAgICAgICB0aGlzLnByaW50X2RlYnVnKHN0cik7XG4gICAgICAgIHJlc29sdmUoc3RyKTtcbiAgICAgIH07XG4gICAgICB0aGlzLmFkZFBvbmdPYnNlcnZlcihjYWxsYmFjayk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==

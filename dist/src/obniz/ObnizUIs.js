"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const ObnizSystemMethods_1 = __importDefault(require("./ObnizSystemMethods"));
class ObnizUIs extends ObnizSystemMethods_1.default {
    constructor(id, options) {
        super(id, options);
    }
    isValidObnizId(str) {
        if (typeof str !== "string" || str.length < 8) {
            return null;
        }
        str = str.replace("-", "");
        let id = parseInt(str);
        if (isNaN(id)) {
            id = null;
        }
        return id !== null;
    }
    wsconnect(desired_server) {
        this.showOffLine();
        if (!this.isValidObnizId(this.id)) {
            if (this.isNode) {
                this.error("invalid obniz id");
            }
            else {
                const filled = _ReadCookie("obniz-last-used") || "";
                this.prompt(filled, (obnizid) => {
                    this.id = obnizid;
                    this.wsconnect(desired_server);
                });
            }
            return;
        }
        super.wsconnect(desired_server);
    }
    showAlertUI(obj) {
        if (this.isNode || !document.getElementById(this.options.debug_dom_id)) {
            return;
        }
        const dom = `
    <div style="background-color:${obj.alert === "warning" ? "#ffee35" : "#ff7b34"}">${obj.message}</div>`;
        document
            .getElementById(this.options.debug_dom_id)
            .insertAdjacentHTML("beforeend", dom);
    }
    getDebugDoms() {
        if (this.isNode) {
            return;
        }
        const loaderDom = document.querySelector("#loader");
        const debugDom = document.querySelector("#" + this.options.debug_dom_id);
        let statusDom = document.querySelector("#" + this.options.debug_dom_id + " #online-status");
        if (debugDom && !statusDom) {
            statusDom = document.createElement("div");
            statusDom.id = "online-status";
            statusDom.style.color = "#FFF";
            statusDom.style.padding = "5px";
            statusDom.style.textAlign = "center";
            debugDom.insertBefore(statusDom, debugDom.firstChild);
        }
        return { loaderDom, debugDom, statusDom };
    }
    /* online offline */
    _callOnConnect() {
        this.updateOnlineUI();
        super._callOnConnect();
    }
    close() {
        super.close();
        this.updateOnlineUI();
    }
    _disconnectLocal() {
        super._disconnectLocal();
        this.updateOnlineUI();
    }
    updateOnlineUI() {
        if (this.isNode) {
            return;
        }
        const isConnected = this.socket && this.socket.readyState === 1;
        const isConnectedLocally = this.socket_local && this.socket_local.readyState === 1;
        if (isConnected && isConnectedLocally) {
            this.showOnLine(true);
        }
        else if (isConnected) {
            this.showOnLine(false);
        }
        else {
            this.showOffLine();
        }
    }
    showOnLine(isConnectedLocally) {
        if (this.isNode) {
            return;
        }
        const doms = this.getDebugDoms();
        if (doms.loaderDom) {
            doms.loaderDom.style.display = "none";
        }
        if (doms.statusDom) {
            doms.statusDom.style.backgroundColor = isConnectedLocally
                ? "#0cd362"
                : "#31965d";
            doms.statusDom.style.color = "#FFF";
            doms.statusDom.innerHTML =
                (this.id ? "online : " + this.id : "online") +
                    (isConnectedLocally ? " via local_connect" : " via internet");
        }
    }
    showOffLine() {
        if (this.isNode) {
            return;
        }
        const doms = this.getDebugDoms();
        if (doms.loaderDom) {
            doms.loaderDom.style.display = "block";
        }
        if (doms.statusDom) {
            doms.statusDom.style.backgroundColor = "#d9534f";
            doms.statusDom.style.color = "#FFF";
            doms.statusDom.innerHTML = this.id ? "offline : " + this.id : "offline";
        }
    }
}
exports.default = ObnizUIs;
function _ReadCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(";");
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === " ") {
            c = c.substring(1, c.length);
        }
        if (c.indexOf(nameEQ) === 0) {
            return c.substring(nameEQ.length, c.length);
        }
    }
    return null;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9PYm5pelVJcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLDhFQUFzRDtBQUV0RCxNQUFxQixRQUFTLFNBQVEsNEJBQWtCO0lBQ3RELFlBQVksRUFBTyxFQUFFLE9BQVk7UUFDL0IsS0FBSyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNyQixDQUFDO0lBRU0sY0FBYyxDQUFDLEdBQVc7UUFDL0IsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUksR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDN0MsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELEdBQUcsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMzQixJQUFJLEVBQUUsR0FBUSxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUIsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLEVBQUU7WUFDYixFQUFFLEdBQUcsSUFBSSxDQUFDO1NBQ1g7UUFDRCxPQUFPLEVBQUUsS0FBSyxJQUFJLENBQUM7SUFDckIsQ0FBQztJQUVNLFNBQVMsQ0FBQyxjQUFtQjtRQUNsQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFO1lBQ2pDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDZixJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7YUFDaEM7aUJBQU07Z0JBQ0wsTUFBTSxNQUFNLEdBQVEsV0FBVyxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxDQUFDO2dCQUN6RCxJQUFJLENBQUMsTUFBTSxDQUNULE1BQU0sRUFDTixDQUFDLE9BQVksRUFBRyxFQUFFO29CQUNoQixJQUFJLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQztvQkFDbEIsSUFBSSxDQUFDLFNBQVMsQ0FB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ZSxHQUFHLFNBQVMsQ0FBQztZQUNqRCxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDO1lBQ3BDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7U0FDekU7SUFDSCxDQUFDO0NBQ0Y7QUExSUQsMkJBMElDO0FBRUQsU0FBUyxXQUFXLENBQUMsSUFBUztJQUM1QixNQUFNLE1BQU0sR0FBUSxJQUFJLEdBQUcsR0FBRyxDQUFDO0lBQy9CLE1BQU0sRUFBRSxHQUFRLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzNDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ2xDLElBQUksQ0FBQyxHQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuQixPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQzFCLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDOUI7UUFDRCxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQzNCLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUM3QztLQUNGO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDIiwiZmlsZSI6InNyYy9vYm5pei9PYm5pelVJcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPYm5pelN5c3RlbU1ldGhvZHMgZnJvbSBcIi4vT2JuaXpTeXN0ZW1NZXRob2RzXCI7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9ibml6VUlzIGV4dGVuZHMgT2JuaXpTeXN0ZW1NZXRob2RzIHtcbiAgY29uc3RydWN0b3IoaWQ6IGFueSwgb3B0aW9uczogYW55KSB7XG4gICAgc3VwZXIoaWQsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHVibGljIGlzVmFsaWRPYm5peklkKHN0cjogc3RyaW5nICkge1xuICAgIGlmICh0eXBlb2Ygc3RyICE9PSBcInN0cmluZ1wiIHx8IHN0ci5sZW5ndGggPCA4KSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgc3RyID0gc3RyLnJlcGxhY2UoXCItXCIsIFwiXCIpO1xuICAgIGxldCBpZDogYW55ID0gcGFyc2VJbnQoc3RyKTtcbiAgICBpZiAoaXNOYU4oaWQpKSB7XG4gICAgICBpZCA9IG51bGw7XG4gICAgfVxuICAgIHJldHVybiBpZCAhPT0gbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyB3c2Nvbm5lY3QoZGVzaXJlZF9zZXJ2ZXI6IGFueSkge1xuICAgIHRoaXMuc2hvd09mZkxpbmUoKTtcbiAgICBpZiAoIXRoaXMuaXNWYWxpZE9ibml6SWQodGhpcy5pZCkpIHtcbiAgICAgIGlmICh0aGlzLmlzTm9kZSkge1xuICAgICAgICB0aGlzLmVycm9yKFwiaW52YWxpZCBvYm5peiBpZFwiKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGZpbGxlZDogYW55ID0gX1JlYWRDb29raWUoXCJvYm5pei1sYXN0LXVzZWRcIikgfHwgXCJcIjtcbiAgICAgICAgdGhpcy5wcm9tcHQoXG4gICAgICAgICAgZmlsbGVkLFxuICAgICAgICAgIChvYm5pemlkOiBhbnkgKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmlkID0gb2JuaXppZDtcbiAgICAgICAgICAgIHRoaXMud3Njb25uZWN0KGRlc2lyZWRfc2VydmVyKTtcbiAgICAgICAgICB9LFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBzdXBlci53c2Nvbm5lY3QoZGVzaXJlZF9zZXJ2ZXIpO1xuICB9XG5cbiAgcHVibGljIHNob3dBbGVydFVJKG9iajogYW55KSB7XG4gICAgaWYgKHRoaXMuaXNOb2RlIHx8ICFkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLm9wdGlvbnMuZGVidWdfZG9tX2lkKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBkb206IGFueSA9IGBcbiAgICA8ZGl2IHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjoke1xuICAgICAgb2JqLmFsZXJ0ID09PSBcIndhcm5pbmdcIiA/IFwiI2ZmZWUzNVwiIDogXCIjZmY3YjM0XCJcbiAgICB9XCI+JHtvYmoubWVzc2FnZX08L2Rpdj5gO1xuICAgIGRvY3VtZW50XG4gICAgICAuZ2V0RWxlbWVudEJ5SWQodGhpcy5vcHRpb25zLmRlYnVnX2RvbV9pZCkhXG4gICAgICAuaW5zZXJ0QWRqYWNlbnRIVE1MKFwiYmVmb3JlZW5kXCIsIGRvbSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RGVidWdEb21zKCkge1xuICAgIGlmICh0aGlzLmlzTm9kZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBsb2FkZXJEb206IGFueSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIjbG9hZGVyXCIpO1xuICAgIGNvbnN0IGRlYnVnRG9tOiBhbnkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI1wiICsgdGhpcy5vcHRpb25zLmRlYnVnX2RvbV9pZCk7XG4gICAgbGV0IHN0YXR1c0RvbTogYW55ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcbiAgICAgIFwiI1wiICsgdGhpcy5vcHRpb25zLmRlYnVnX2RvbV9pZCArIFwiICNvbmxpbmUtc3RhdHVzXCIsXG4gICAgKTtcbiAgICBpZiAoZGVidWdEb20gJiYgIXN0YXR1c0RvbSkge1xuICAgICAgc3RhdHVzRG9tID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgIHN0YXR1c0RvbS5pZCA9IFwib25saW5lLXN0YXR1c1wiO1xuICAgICAgc3RhdHVzRG9tLnN0eWxlLmNvbG9yID0gXCIjRkZGXCI7XG4gICAgICBzdGF0dXNEb20uc3R5bGUucGFkZGluZyA9IFwiNXB4XCI7XG4gICAgICBzdGF0dXNEb20uc3R5bGUudGV4dEFsaWduID0gXCJjZW50ZXJcIjtcbiAgICAgIGRlYnVnRG9tLmluc2VydEJlZm9yZShzdGF0dXNEb20sIGRlYnVnRG9tLmZpcnN0Q2hpbGQpO1xuICAgIH1cbiAgICByZXR1cm4ge2xvYWRlckRvbSwgZGVidWdEb20sIHN0YXR1c0RvbX07XG4gIH1cblxuICAvKiBvbmxpbmUgb2ZmbGluZSAqL1xuXG4gIHB1YmxpYyBfY2FsbE9uQ29ubmVjdCgpIHtcbiAgICB0aGlzLnVwZGF0ZU9ubGluZVVJKCk7XG4gICAgc3VwZXIuX2NhbGxPbkNvbm5lY3QoKTtcbiAgfVxuXG4gIHB1YmxpYyBjbG9zZSgpIHtcbiAgICBzdXBlci5jbG9zZSgpO1xuICAgIHRoaXMudXBkYXRlT25saW5lVUkoKTtcbiAgfVxuXG4gIHB1YmxpYyBfZGlzY29ubmVjdExvY2FsKCkge1xuICAgIHN1cGVyLl9kaXNjb25uZWN0TG9jYWwoKTtcbiAgICB0aGlzLnVwZGF0ZU9ubGluZVVJKCk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlT25saW5lVUkoKSB7XG4gICAgaWYgKHRoaXMuaXNOb2RlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaXNDb25uZWN0ZWQ6IGFueSA9IHRoaXMuc29ja2V0ICYmIHRoaXMuc29ja2V0LnJlYWR5U3RhdGUgPT09IDE7XG4gICAgY29uc3QgaXNDb25uZWN0ZWRMb2NhbGx5OiBhbnkgPVxuICAgICAgdGhpcy5zb2NrZXRfbG9jYWwgJiYgdGhpcy5zb2NrZXRfbG9jYWwucmVhZHlTdGF0ZSA9PT0gMTtcbiAgICBpZiAoaXNDb25uZWN0ZWQgJiYgaXNDb25uZWN0ZWRMb2NhbGx5KSB7XG4gICAgICB0aGlzLnNob3dPbkxpbmUodHJ1ZSk7XG4gICAgfSBlbHNlIGlmIChpc0Nvbm5lY3RlZCkge1xuICAgICAgdGhpcy5zaG93T25MaW5lKGZhbHNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zaG93T2ZmTGluZSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzaG93T25MaW5lKGlzQ29ubmVjdGVkTG9jYWxseTogYW55KSB7XG4gICAgaWYgKHRoaXMuaXNOb2RlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGRvbXM6IGFueSA9IHRoaXMuZ2V0RGVidWdEb21zKCk7XG4gICAgaWYgKGRvbXMubG9hZGVyRG9tKSB7XG4gICAgICBkb21zLmxvYWRlckRvbS5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XG4gICAgfVxuICAgIGlmIChkb21zLnN0YXR1c0RvbSkge1xuICAgICAgZG9tcy5zdGF0dXNEb20uc3R5bGUuYmFja2dyb3VuZENvbG9yID0gaXNDb25uZWN0ZWRMb2NhbGx5XG4gICAgICAgID8gXCIjMGNkMzYyXCJcbiAgICAgICAgOiBcIiMzMTk2NWRcIjtcbiAgICAgIGRvbXMuc3RhdHVzRG9tLnN0eWxlLmNvbG9yID0gXCIjRkZGXCI7XG4gICAgICBkb21zLnN0YXR1c0RvbS5pbm5lckhUTUwgPVxuICAgICAgICAodGhpcy5pZCA/IFwib25saW5lIDogXCIgKyB0aGlzLmlkIDogXCJvbmxpbmVcIikgK1xuICAgICAgICAoaXNDb25uZWN0ZWRMb2NhbGx5ID8gXCIgdmlhIGxvY2FsX2Nvbm5lY3RcIiA6IFwiIHZpYSBpbnRlcm5ldFwiKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2hvd09mZkxpbmUoKSB7XG4gICAgaWYgKHRoaXMuaXNOb2RlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZG9tczogYW55ID0gdGhpcy5nZXREZWJ1Z0RvbXMoKTtcbiAgICBpZiAoZG9tcy5sb2FkZXJEb20pIHtcbiAgICAgIGRvbXMubG9hZGVyRG9tLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XG4gICAgfVxuICAgIGlmIChkb21zLnN0YXR1c0RvbSkge1xuICAgICAgZG9tcy5zdGF0dXNEb20uc3R5bGUuYmFja2dyb3VuZENvbG9yID0gXCIjZDk1MzRmXCI7XG4gICAgICBkb21zLnN0YXR1c0RvbS5zdHlsZS5jb2xvciA9IFwiI0ZGRlwiO1xuICAgICAgZG9tcy5zdGF0dXNEb20uaW5uZXJIVE1MID0gdGhpcy5pZCA/IFwib2ZmbGluZSA6IFwiICsgdGhpcy5pZCA6IFwib2ZmbGluZVwiO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBfUmVhZENvb2tpZShuYW1lOiBhbnkpIHtcbiAgY29uc3QgbmFtZUVROiBhbnkgPSBuYW1lICsgXCI9XCI7XG4gIGNvbnN0IGNhOiBhbnkgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoXCI7XCIpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGNhLmxlbmd0aDsgaSsrKSB7XG4gICAgbGV0IGM6IGFueSA9IGNhW2ldO1xuICAgIHdoaWxlIChjLmNoYXJBdCgwKSA9PT0gXCIgXCIpIHtcbiAgICAgIGMgPSBjLnN1YnN0cmluZygxLCBjLmxlbmd0aCk7XG4gICAgfVxuICAgIGlmIChjLmluZGV4T2YobmFtZUVRKSA9PT0gMCkge1xuICAgICAgcmV0dXJuIGMuc3Vic3RyaW5nKG5hbWVFUS5sZW5ndGgsIGMubGVuZ3RoKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG4iXX0=

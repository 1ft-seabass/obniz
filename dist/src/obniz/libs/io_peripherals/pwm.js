"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = __importDefault(require("../utils/util"));
class PeripheralPWM {
    constructor(Obniz, id) {
        this.Obniz = Obniz;
        this.id = id;
        this._reset();
    }
    _reset() {
        this.state = {};
        this.used = false;
    }
    sendWS(obj) {
        const wsObj = {};
        wsObj["pwm" + this.id] = obj;
        this.Obniz.send(wsObj);
    }
    start(params) {
        const err = util_1.default._requiredKeys(params, ["io"]);
        if (err) {
            throw new Error("pwm start param '" + err + "' required, but not found ");
        }
        this.params = util_1.default._keyFilter(params, ["io", "drive", "pull"]);
        const io = this.params.io;
        const ioObj = this.Obniz.getIO(io);
        ioObj.drive(this.params.drive || "5v");
        ioObj.pull(this.params.pull || null);
        this.state = {
            io,
            freq: 1000,
        };
        this.sendWS({
            io,
        });
        this.used = true;
    }
    freq(freq) {
        if (!this.used) {
            throw new Error(`pwm${this.id} is not started`);
        }
        freq *= 1;
        if (typeof freq !== "number") {
            throw new Error("please provide freq in number");
        }
        this.state.freq = freq;
        this.sendWS({
            freq,
        });
        if (typeof this.state.duty === "number") {
            this.duty(this.state.duty);
        }
    }
    pulse(pulse_width) {
        if (!this.used) {
            throw new Error(`pwm${this.id} is not started`);
        }
        this.state.pulse = pulse_width;
        delete this.state.duty;
        this.sendWS({
            pulse: pulse_width,
        });
    }
    duty(duty) {
        if (!this.used) {
            throw new Error(`pwm${this.id} is not started`);
        }
        duty *= 1;
        if (typeof this.state.freq !== "number" || this.state.freq <= 0) {
            throw new Error("please provide freq first.");
        }
        if (typeof duty !== "number") {
            throw new Error("please provide duty in number");
        }
        if (duty < 0) {
            duty = 0;
        }
        if (duty > 100) {
            duty = 100;
        }
        const pulse_width = (1.0 / this.state.freq) * 1000 * duty * 0.01;
        this.state.duty = duty;
        this.sendWS({
            pulse: pulse_width,
        });
    }
    isUsed() {
        return this.used;
    }
    end() {
        this.state = {};
        this.sendWS(null);
        this.used = false;
    }
    modulate(type, symbol_length, data) {
        if (!this.used) {
            throw new Error(`pwm${this.id} is not started`);
        }
        this.sendWS({
            modulate: {
                type,
                symbol_length,
                data,
            },
        });
    }
}
exports.default = PeripheralPWM;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2lvX3BlcmlwaGVyYWxzL3B3bS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHlEQUFzQztBQUV0QyxNQUFNLGFBQWE7SUFPakIsWUFBWSxLQUFVLEVBQUUsRUFBTztRQUM3QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBRU0sTUFBTTtRQUNYLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDO0lBQ3BCLENBQUM7SUFFTSxNQUFNLENBQUMsR0FBUTtRQUNwQixNQUFNLEtBQUssR0FBUSxFQUFFLENBQUM7UUFDdEIsS0FBSyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQzdCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFTSxLQUFLLENBQUMsTUFBVztRQUN0QixNQUFNLEdBQUcsR0FBUSxjQUFTLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDekQsSUFBSSxHQUFHLEVBQUU7WUFDUCxNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixHQUFHLEdBQUcsR0FBRyw0QkFBNEIsQ0FBQyxDQUFDO1NBQzNFO1FBQ0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxjQUFTLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUVwRSxNQUFNLEVBQUUsR0FBUSxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUMvQixNQUFNLEtBQUssR0FBUSxJQUFJLENBQUMsS0FB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TUFBTTtRQUNYLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDO0lBRU0sR0FBRztRQUNSLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEIsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUVNLFFBQVEsQ0FBQyxJQUFTLEVBQUUsYUFBa0IsRUFBRSxJQUFTO1FBQ3RELElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ2QsTUFBTSxJQUFJLEtBQUssQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFLGlCQUFpQixDQUFDLENBQUM7U0FDakQ7UUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQ1YsUUFBUSxFQUFFO2dCQUNSLElBQUk7Z0JBQ0osYUFBYTtnQkFDYixJQUFJO2FBQ0w7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUFFRCxrQkFBZSxhQUFhLENBQUMiLCJmaWxlIjoic3JjL29ibml6L2xpYnMvaW9fcGVyaXBoZXJhbHMvcHdtLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9ibml6VXRpbCBmcm9tIFwiLi4vdXRpbHMvdXRpbFwiO1xuXG5jbGFzcyBQZXJpcGhlcmFsUFdNIHtcbiAgcHVibGljIE9ibml6OiBhbnk7XG4gIHB1YmxpYyBpZDogYW55O1xuICBwdWJsaWMgc3RhdGU6IGFueTtcbiAgcHVibGljIHVzZWQ6IGFueTtcbiAgcHVibGljIHBhcmFtczogYW55O1xuXG4gIGNvbnN0cnVjdG9yKE9ibml6OiBhbnksIGlkOiBhbnkpIHtcbiAgICB0aGlzLk9ibml6ID0gT2JuaXo7XG4gICAgdGhpcy5pZCA9IGlkO1xuICAgIHRoaXMuX3Jlc2V0KCk7XG4gIH1cblxuICBwdWJsaWMgX3Jlc2V0KCkge1xuICAgIHRoaXMuc3RhdGUgPSB7fTtcbiAgICB0aGlzLnVzZWQgPSBmYWxzZTtcbiAgfVxuXG4gIHB1YmxpYyBzZW5kV1Mob2JqOiBhbnkpIHtcbiAgICBjb25zdCB3c09iajogYW55ID0ge307XG4gICAgd3NPYmpbXCJwd21cIiArIHRoaXMuaWRdID0gb2JqO1xuICAgIHRoaXMuT2JuaXouc2VuZCh3c09iaik7XG4gIH1cblxuICBwdWJsaWMgc3RhcnQocGFyYW1zOiBhbnkpIHtcbiAgICBjb25zdCBlcnI6IGFueSA9IE9ibml6VXRpbC5fcmVxdWlyZWRLZXlzKHBhcmFtcywgW1wiaW9cIl0pO1xuICAgIGlmIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcInB3bSBzdGFydCBwYXJhbSAnXCIgKyBlcnIgKyBcIicgcmVxdWlyZWQsIGJ1dCBub3QgZm91bmQgXCIpO1xuICAgIH1cbiAgICB0aGlzLnBhcmFtcyA9IE9ibml6VXRpbC5fa2V5RmlsdGVyKHBhcmFtcywgW1wiaW9cIiwgXCJkcml2ZVwiLCBcInB1bGxcIl0pO1xuXG4gICAgY29uc3QgaW86IGFueSA9IHRoaXMucGFyYW1zLmlvO1xuICAgIGNvbnN0IGlvT2JqOiBhbnkgPSB0aGlzLk9ibml6LmdldElPKGlvKTtcblxuICAgIGlvT2JqLmRyaXZlKHRoaXMucGFyYW1zLmRyaXZlIHx8IFwiNXZcIik7XG4gICAgaW9PYmoucHVsbCh0aGlzLnBhcmFtcy5wdWxsIHx8IG51bGwpO1xuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGlvLFxuICAgICAgZnJlcTogMTAwMCxcbiAgICB9O1xuICAgIHRoaXMuc2VuZFdTKHtcbiAgICAgIGlvLFxuICAgIH0pO1xuICAgIHRoaXMudXNlZCA9IHRydWU7XG4gIH1cblxuICBwdWJsaWMgZnJlcShmcmVxOiBhbnkpIHtcbiAgICBpZiAoIXRoaXMudXNlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBwd20ke3RoaXMuaWR9IGlzIG5vdCBzdGFydGVkYCk7XG4gICAgfVxuICAgIGZyZXEgKj0gMTtcbiAgICBpZiAodHlwZW9mIGZyZXEgIT09IFwibnVtYmVyXCIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcInBsZWFzZSBwcm92aWRlIGZyZXEgaW4gbnVtYmVyXCIpO1xuICAgIH1cbiAgICB0aGlzLnN0YXRlLmZyZXEgPSBmcmVxO1xuICAgIHRoaXMuc2VuZFdTKHtcbiAgICAgIGZyZXEsXG4gICAgfSk7XG4gICAgaWYgKHR5cGVvZiB0aGlzLnN0YXRlLmR1dHkgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgIHRoaXMuZHV0eSh0aGlzLnN0YXRlLmR1dHkpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBwdWxzZShwdWxzZV93aWR0aDogYW55KSB7XG4gICAgaWYgKCF0aGlzLnVzZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgcHdtJHt0aGlzLmlkfSBpcyBub3Qgc3RhcnRlZGApO1xuICAgIH1cblxuICAgIHRoaXMuc3RhdGUucHVsc2UgPSBwdWxzZV93aWR0aDtcbiAgICBkZWxldGUgdGhpcy5zdGF0ZS5kdXR5O1xuICAgIHRoaXMuc2VuZFdTKHtcbiAgICAgIHB1bHNlOiBwdWxzZV93aWR0aCxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBkdXR5KGR1dHk6IGFueSkge1xuICAgIGlmICghdGhpcy51c2VkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHB3bSR7dGhpcy5pZH0gaXMgbm90IHN0YXJ0ZWRgKTtcbiAgICB9XG4gICAgZHV0eSAqPSAxO1xuICAgIGlmICh0eXBlb2YgdGhpcy5zdGF0ZS5mcmVxICE9PSBcIm51bWJlclwiIHx8IHRoaXMuc3RhdGUuZnJlcSA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwbGVhc2UgcHJvdmlkZSBmcmVxIGZpcnN0LlwiKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBkdXR5ICE9PSBcIm51bWJlclwiKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwbGVhc2UgcHJvdmlkZSBkdXR5IGluIG51bWJlclwiKTtcbiAgICB9XG4gICAgaWYgKGR1dHkgPCAwKSB7XG4gICAgICBkdXR5ID0gMDtcbiAgICB9XG4gICAgaWYgKGR1dHkgPiAxMDApIHtcbiAgICAgIGR1dHkgPSAxMDA7XG4gICAgfVxuICAgIGNvbnN0IHB1bHNlX3dpZHRoOiBhbnkgPSAoMS4wIC8gdGhpcy5zdGF0ZS5mcmVxKSAqIDEwMDAgKiBkdXR5ICogMC4wMTtcbiAgICB0aGlzLnN0YXRlLmR1dHkgPSBkdXR5O1xuICAgIHRoaXMuc2VuZFdTKHtcbiAgICAgIHB1bHNlOiBwdWxzZV93aWR0aCxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBpc1VzZWQoKSB7XG4gICAgcmV0dXJuIHRoaXMudXNlZDtcbiAgfVxuXG4gIHB1YmxpYyBlbmQoKSB7XG4gICAgdGhpcy5zdGF0ZSA9IHt9O1xuICAgIHRoaXMuc2VuZFdTKG51bGwpO1xuICAgIHRoaXMudXNlZCA9IGZhbHNlO1xuICB9XG5cbiAgcHVibGljIG1vZHVsYXRlKHR5cGU6IGFueSwgc3ltYm9sX2xlbmd0aDogYW55LCBkYXRhOiBhbnkpIHtcbiAgICBpZiAoIXRoaXMudXNlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBwd20ke3RoaXMuaWR9IGlzIG5vdCBzdGFydGVkYCk7XG4gICAgfVxuICAgIHRoaXMuc2VuZFdTKHtcbiAgICAgIG1vZHVsYXRlOiB7XG4gICAgICAgIHR5cGUsXG4gICAgICAgIHN5bWJvbF9sZW5ndGgsXG4gICAgICAgIGRhdGEsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFBlcmlwaGVyYWxQV007XG4iXX0=

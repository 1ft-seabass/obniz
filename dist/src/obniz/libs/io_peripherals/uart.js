"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = __importDefault(require("../utils/util"));
const isNode = typeof window === "undefined";
class PeripheralUART {
    constructor(Obniz, id) {
        this.Obniz = Obniz;
        this.id = id;
        this._reset();
    }
    _reset() {
        this.received = new Uint8Array([]);
        this.used = false;
    }
    start(params) {
        const err = util_1.default._requiredKeys(params, ["tx", "rx"]);
        if (err) {
            throw new Error("uart start param '" + err + "' required, but not found ");
        }
        this.params = util_1.default._keyFilter(params, [
            "tx",
            "rx",
            "baud",
            "stop",
            "bits",
            "parity",
            "flowcontrol",
            "rts",
            "cts",
            "drive",
            "pull",
            "gnd",
        ]);
        const ioKeys = ["rx", "tx", "rts", "cts", "gnd"];
        for (const key of ioKeys) {
            if (this.params[key] && !this.Obniz.isValidIO(this.params[key])) {
                throw new Error("uart start param '" + key + "' are to be valid io no");
            }
        }
        if (this.params.hasOwnProperty("drive")) {
            this.Obniz.getIO(this.params.rx).drive(this.params.drive);
            this.Obniz.getIO(this.params.tx).drive(this.params.drive);
        }
        else {
            this.Obniz.getIO(this.params.rx).drive("5v");
            this.Obniz.getIO(this.params.tx).drive("5v");
        }
        if (this.params.hasOwnProperty("pull")) {
            this.Obniz.getIO(this.params.rx).pull(this.params.pull);
            this.Obniz.getIO(this.params.tx).pull(this.params.pull);
        }
        else {
            this.Obniz.getIO(this.params.rx).pull(null);
            this.Obniz.getIO(this.params.tx).pull(null);
        }
        if (this.params.hasOwnProperty("gnd")) {
            this.Obniz.getIO(this.params.gnd).output(false);
            const ioNames = {};
            ioNames[this.params.gnd] = "gnd";
            this.Obniz.display.setPinNames("uart" + this.id, ioNames);
        }
        const obj = {};
        const sendParams = util_1.default._keyFilter(this.params, [
            "tx",
            "rx",
            "baud",
            "stop",
            "bits",
            "parity",
            "flowcontrol",
            "rts",
            "cts",
        ]);
        obj["uart" + this.id] = sendParams;
        this.Obniz.send(obj);
        this.received = [];
        this.used = true;
    }
    send(data) {
        if (!this.used) {
            throw new Error(`uart${this.id} is not started`);
        }
        let send_data = null;
        if (data === undefined) {
            return;
        }
        if (typeof data === "number") {
            data = [data];
        }
        if (isNode && data instanceof Buffer) {
            send_data = [...data];
        }
        else if (data.constructor === Array) {
            send_data = data;
        }
        else if (typeof data === "string") {
            const buf = Buffer.from(data);
            send_data = [...buf];
        }
        const obj = {};
        obj["uart" + this.id] = {};
        obj["uart" + this.id].data = send_data;
        //  console.log(obj);
        this.Obniz.send(obj);
    }
    isDataExists() {
        return this.received && this.received.length > 0;
    }
    readBytes() {
        const results = [];
        if (this.isDataExists()) {
            for (let i = 0; i < this.received.length; i++) {
                results.push(this.received[i]);
            }
        }
        this.received = [];
        return results;
    }
    readByte() {
        const results = [];
        if (this.isDataExists()) {
            return results.unshift();
        }
        return null;
    }
    readText() {
        let string = null;
        if (this.isDataExists()) {
            const data = this.readBytes();
            string = this.tryConvertString(data);
        }
        this.received = [];
        return string;
    }
    tryConvertString(data) {
        return util_1.default.dataArray2string(data);
    }
    notified(obj) {
        if (this.onreceive) {
            const string = this.tryConvertString(obj.data);
            this.onreceive(obj.data, string);
        }
        else {
            if (!this.received) {
                this.received = [];
            }
            this.received.push.apply(this.received, obj.data);
        }
    }
    isUsed() {
        return this.used;
    }
    end() {
        const obj = {};
        obj["uart" + this.id] = null;
        this.params = null;
        this.Obniz.send(obj);
        this.used = false;
    }
}
exports.default = PeripheralUART;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2lvX3BlcmlwaGVyYWxzL3VhcnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSx5REFBc0M7QUFDdEMsTUFBTSxNQUFNLEdBQVEsT0FBTyxNQUFNLEtBQUssV0FBVyxDQUFDO0FBRWxELE1BQU0sY0FBYztJQVFsQixZQUFZLEtBQVUsRUFBRSxFQUFPO1FBQzdCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxNQUFNO1FBQ1gsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRU0sS0FBSyxDQUFDLE1BQVc7UUFDdEIsTUFBTSxHQUFHLEdBQVEsY0FBUyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMvRCxJQUFJLEdBQUcsRUFBRTtZQUNQLE1BQU0sSUFBSSxLQUFLLENBQ2Isb0JBQW9CLEdBQUcsR0FBRyxHQUFHLDRCQUE0QixDQUMxRCxDQUFDO1NBQ0g7UUFDRCxJQUFJLENBQUMsTUFBTSxHQUFHLGNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFO1lBQ3pDLElBQUk7WUFDSixJQUFJO1lBQ0osTUFBTTtZQUNOLE1BQU07WUFDTixNQUFNO1lBQ04sUUFBUTtZQUNSLGFBQWE7WUFDYixLQUFLO1lBQ0wsS0FBSztZQUNMLE9BQU87WUFDUCxNQUFNO1lBQ04sS0FBSztTQUNOLENBQUMsQ0FBQztRQUVILE1BQU0sTUFBTSxHQUFRLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3RELEtBQUss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QUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFTSxRQUFRLENBQUMsR0FBUTtRQUN0QixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEIsTUFBTSxNQUFNLEdBQVEsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNwRCxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7U0FDbEM7YUFBTTtZQUNMLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNsQixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQzthQUNwQjtZQUVELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNuRDtJQUNILENBQUM7SUFFTSxNQUFNO1FBQ1gsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFFTSxHQUFHO1FBQ1IsTUFBTSxHQUFHLEdBQVEsRUFBRSxDQUFDO1FBQ3BCLEdBQUcsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUM3QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztRQUNuQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztJQUNwQixDQUFDO0NBQ0Y7QUFFRCxrQkFBZSxjQUFjLENBQUMiLCJmaWxlIjoic3JjL29ibml6L2xpYnMvaW9fcGVyaXBoZXJhbHMvdWFydC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPYm5pelV0aWwgZnJvbSBcIi4uL3V0aWxzL3V0aWxcIjtcbmNvbnN0IGlzTm9kZTogYW55ID0gdHlwZW9mIHdpbmRvdyA9PT0gXCJ1bmRlZmluZWRcIjtcblxuY2xhc3MgUGVyaXBoZXJhbFVBUlQge1xuICBwdWJsaWMgT2JuaXo6IGFueTtcbiAgcHVibGljIGlkOiBhbnk7XG4gIHB1YmxpYyByZWNlaXZlZDogYW55O1xuICBwdWJsaWMgdXNlZDogYW55O1xuICBwdWJsaWMgcGFyYW1zOiBhbnk7XG4gIHB1YmxpYyBvbnJlY2VpdmU6IGFueTtcblxuICBjb25zdHJ1Y3RvcihPYm5pejogYW55LCBpZDogYW55KSB7XG4gICAgdGhpcy5PYm5peiA9IE9ibml6O1xuICAgIHRoaXMuaWQgPSBpZDtcbiAgICB0aGlzLl9yZXNldCgpO1xuICB9XG5cbiAgcHVibGljIF9yZXNldCgpIHtcbiAgICB0aGlzLnJlY2VpdmVkID0gbmV3IFVpbnQ4QXJyYXkoW10pO1xuICAgIHRoaXMudXNlZCA9IGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN0YXJ0KHBhcmFtczogYW55KSB7XG4gICAgY29uc3QgZXJyOiBhbnkgPSBPYm5pelV0aWwuX3JlcXVpcmVkS2V5cyhwYXJhbXMsIFtcInR4XCIsIFwicnhcIl0pO1xuICAgIGlmIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJ1YXJ0IHN0YXJ0IHBhcmFtICdcIiArIGVyciArIFwiJyByZXF1aXJlZCwgYnV0IG5vdCBmb3VuZCBcIixcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMucGFyYW1zID0gT2JuaXpVdGlsLl9rZXlGaWx0ZXIocGFyYW1zLCBbXG4gICAgICBcInR4XCIsXG4gICAgICBcInJ4XCIsXG4gICAgICBcImJhdWRcIixcbiAgICAgIFwic3RvcFwiLFxuICAgICAgXCJiaXRzXCIsXG4gICAgICBcInBhcml0eVwiLFxuICAgICAgXCJmbG93Y29udHJvbFwiLFxuICAgICAgXCJydHNcIixcbiAgICAgIFwiY3RzXCIsXG4gICAgICBcImRyaXZlXCIsXG4gICAgICBcInB1bGxcIixcbiAgICAgIFwiZ25kXCIsXG4gICAgXSk7XG5cbiAgICBjb25zdCBpb0tleXM6IGFueSA9IFtcInJ4XCIsIFwidHhcIiwgXCJydHNcIiwgXCJjdHNcIiwgXCJnbmRcIl07XG4gICAgZm9yIChjb25zdCBrZXkgb2YgaW9LZXlzKSB7XG4gICAgICBpZiAodGhpcy5wYXJhbXNba2V5XSAmJiAhdGhpcy5PYm5pei5pc1ZhbGlkSU8odGhpcy5wYXJhbXNba2V5XSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwidWFydCBzdGFydCBwYXJhbSAnXCIgKyBrZXkgKyBcIicgYXJlIHRvIGJlIHZhbGlkIGlvIG5vXCIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLnBhcmFtcy5oYXNPd25Qcm9wZXJ0eShcImRyaXZlXCIpKSB7XG4gICAgICB0aGlzLk9ibml6LmdldElPKHRoaXMucGFyYW1zLnJ4KS5kcml2ZSh0aGlzLnBhcmFtcy5kcml2ZSk7XG4gICAgICB0aGlzLk9ibml6LmdldElPKHRoaXMucGFyYW1zLnR4KS5kcml2ZSh0aGlzLnBhcmFtcy5kcml2ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuT2JuaXouZ2V0SU8odGhpcy5wYXJhbXMucngpLmRyaXZlKFwiNXZcIik7XG4gICAgICB0aGlzLk9ibml6LmdldElPKHRoaXMucGFyYW1zLnR4KS5kcml2ZShcIjV2XCIpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnBhcmFtcy5oYXNPd25Qcm9wZXJ0eShcInB1bGxcIikpIHtcbiAgICAgIHRoaXMuT2JuaXouZ2V0SU8odGhpcy5wYXJhbXMucngpLnB1bGwodGhpcy5wYXJhbXMucHVsbCk7XG4gICAgICB0aGlzLk9ibml6LmdldElPKHRoaXMucGFyYW1zLnR4KS5wdWxsKHRoaXMucGFyYW1zLnB1bGwpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLk9ibml6LmdldElPKHRoaXMucGFyYW1zLnJ4KS5wdWxsKG51bGwpO1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnBhcmFtcy50eCkucHVsbChudWxsKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wYXJhbXMuaGFzT3duUHJvcGVydHkoXCJnbmRcIikpIHtcbiAgICAgIHRoaXMuT2JuaXouZ2V0SU8odGhpcy5wYXJhbXMuZ25kKS5vdXRwdXQoZmFsc2UpO1xuICAgICAgY29uc3QgaW9OYW1lczogYW55ID0ge307XG4gICAgICBpb05hbWVzW3RoaXMucGFyYW1zLmduZF0gPSBcImduZFwiO1xuICAgICAgdGhpcy5PYm5pei5kaXNwbGF5LnNldFBpbk5hbWVzKFwidWFydFwiICsgdGhpcy5pZCwgaW9OYW1lcyk7XG4gICAgfVxuXG4gICAgY29uc3Qgb2JqOiBhbnkgPSB7fTtcbiAgICBjb25zdCBzZW5kUGFyYW1zOiBhbnkgPSBPYm5pelV0aWwuX2tleUZpbHRlcih0aGlzLnBhcmFtcywgW1xuICAgICAgXCJ0eFwiLFxuICAgICAgXCJyeFwiLFxuICAgICAgXCJiYXVkXCIsXG4gICAgICBcInN0b3BcIixcbiAgICAgIFwiYml0c1wiLFxuICAgICAgXCJwYXJpdHlcIixcbiAgICAgIFwiZmxvd2NvbnRyb2xcIixcbiAgICAgIFwicnRzXCIsXG4gICAgICBcImN0c1wiLFxuICAgIF0pO1xuICAgIG9ialtcInVhcnRcIiArIHRoaXMuaWRdID0gc2VuZFBhcmFtcztcbiAgICB0aGlzLk9ibml6LnNlbmQob2JqKTtcbiAgICB0aGlzLnJlY2VpdmVkID0gW107XG4gICAgdGhpcy51c2VkID0gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyBzZW5kKGRhdGE6IGFueSkge1xuICAgIGlmICghdGhpcy51c2VkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHVhcnQke3RoaXMuaWR9IGlzIG5vdCBzdGFydGVkYCk7XG4gICAgfVxuICAgIGxldCBzZW5kX2RhdGE6IGFueSA9IG51bGw7XG4gICAgaWYgKGRhdGEgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGRhdGEgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgIGRhdGEgPSBbZGF0YV07XG4gICAgfVxuICAgIGlmIChpc05vZGUgJiYgZGF0YSBpbnN0YW5jZW9mIEJ1ZmZlcikge1xuICAgICAgc2VuZF9kYXRhID0gWy4uLmRhdGFdO1xuICAgIH0gZWxzZSBpZiAoZGF0YS5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHtcbiAgICAgIHNlbmRfZGF0YSA9IGRhdGE7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgZGF0YSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgY29uc3QgYnVmOiBhbnkgPSBCdWZmZXIuZnJvbShkYXRhKTtcbiAgICAgIHNlbmRfZGF0YSA9IFsuLi5idWZdO1xuICAgIH1cbiAgICBjb25zdCBvYmo6IGFueSA9IHt9O1xuICAgIG9ialtcInVhcnRcIiArIHRoaXMuaWRdID0ge307XG4gICAgb2JqW1widWFydFwiICsgdGhpcy5pZF0uZGF0YSA9IHNlbmRfZGF0YTtcbiAgICAvLyAgY29uc29sZS5sb2cob2JqKTtcbiAgICB0aGlzLk9ibml6LnNlbmQob2JqKTtcbiAgfVxuXG4gIHB1YmxpYyBpc0RhdGFFeGlzdHMoKSB7XG4gICAgcmV0dXJuIHRoaXMucmVjZWl2ZWQgJiYgdGhpcy5yZWNlaXZlZC5sZW5ndGggPiAwO1xuICB9XG5cbiAgcHVibGljIHJlYWRCeXRlcygpIHtcbiAgICBjb25zdCByZXN1bHRzOiBhbnkgPSBbXTtcbiAgICBpZiAodGhpcy5pc0RhdGFFeGlzdHMoKSkge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnJlY2VpdmVkLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHJlc3VsdHMucHVzaCh0aGlzLnJlY2VpdmVkW2ldKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5yZWNlaXZlZCA9IFtdO1xuICAgIHJldHVybiByZXN1bHRzO1xuICB9XG5cbiAgcHVibGljIHJlYWRCeXRlKCkge1xuICAgIGNvbnN0IHJlc3VsdHM6IGFueSA9IFtdO1xuICAgIGlmICh0aGlzLmlzRGF0YUV4aXN0cygpKSB7XG4gICAgICByZXR1cm4gcmVzdWx0cy51bnNoaWZ0KCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHVibGljIHJlYWRUZXh0KCkge1xuICAgIGxldCBzdHJpbmc6IGFueSA9IG51bGw7XG4gICAgaWYgKHRoaXMuaXNEYXRhRXhpc3RzKCkpIHtcbiAgICAgIGNvbnN0IGRhdGE6IGFueSA9IHRoaXMucmVhZEJ5dGVzKCk7XG4gICAgICBzdHJpbmcgPSB0aGlzLnRyeUNvbnZlcnRTdHJpbmcoZGF0YSk7XG4gICAgfVxuICAgIHRoaXMucmVjZWl2ZWQgPSBbXTtcbiAgICByZXR1cm4gc3RyaW5nO1xuICB9XG5cbiAgcHVibGljIHRyeUNvbnZlcnRTdHJpbmcoZGF0YTogYW55KSB7XG4gICAgcmV0dXJuIE9ibml6VXRpbC5kYXRhQXJyYXkyc3RyaW5nKGRhdGEpO1xuICB9XG5cbiAgcHVibGljIG5vdGlmaWVkKG9iajogYW55KSB7XG4gICAgaWYgKHRoaXMub25yZWNlaXZlKSB7XG4gICAgICBjb25zdCBzdHJpbmc6IGFueSA9IHRoaXMudHJ5Q29udmVydFN0cmluZyhvYmouZGF0YSk7XG4gICAgICB0aGlzLm9ucmVjZWl2ZShvYmouZGF0YSwgc3RyaW5nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCF0aGlzLnJlY2VpdmVkKSB7XG4gICAgICAgIHRoaXMucmVjZWl2ZWQgPSBbXTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5yZWNlaXZlZC5wdXNoLmFwcGx5KHRoaXMucmVjZWl2ZWQsIG9iai5kYXRhKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgaXNVc2VkKCkge1xuICAgIHJldHVybiB0aGlzLnVzZWQ7XG4gIH1cblxuICBwdWJsaWMgZW5kKCkge1xuICAgIGNvbnN0IG9iajogYW55ID0ge307XG4gICAgb2JqW1widWFydFwiICsgdGhpcy5pZF0gPSBudWxsO1xuICAgIHRoaXMucGFyYW1zID0gbnVsbDtcbiAgICB0aGlzLk9ibml6LnNlbmQob2JqKTtcbiAgICB0aGlzLnVzZWQgPSBmYWxzZTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBQZXJpcGhlcmFsVUFSVDtcbiJdfQ==

"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = __importDefault(require("../utils/util"));
class PeripheralI2C {
    constructor(Obniz, id) {
        this.Obniz = Obniz;
        this.id = id;
        this._reset();
        this.onerror = undefined;
    }
    _reset() {
        this.observers = [];
        this.state = {};
        this.used = false;
        this.onwritten = undefined;
    }
    addObserver(callback) {
        if (callback) {
            this.observers.push(callback);
        }
    }
    start(arg) {
        const err = util_1.default._requiredKeys(arg, ["mode", "sda", "scl"]);
        if (err) {
            throw new Error("I2C start param '" + err + "' required, but not found ");
        }
        this.state = util_1.default._keyFilter(arg, [
            "mode",
            "sda",
            "scl",
            "pull",
            "gnd",
        ]);
        const ioKeys = ["sda", "scl", "gnd"];
        for (const key of ioKeys) {
            if (this.state[key] && !this.Obniz.isValidIO(this.state[key])) {
                throw new Error("i2c start param '" + key + "' are to be valid io no");
            }
        }
        const mode = this.state.mode;
        const clock = typeof arg.clock === "number" ? parseInt(arg.clock) : null;
        const slave_address = typeof arg.slave_address === "number"
            ? parseInt(arg.slave_address)
            : null;
        const slave_address_length = typeof arg.slave_address_length === "number"
            ? parseInt(arg.slave_address_length)
            : null;
        if (mode !== "master" && mode !== "slave") {
            throw new Error("i2c: invalid mode " + mode);
        }
        if (mode === "master") {
            if (clock === null) {
                throw new Error("i2c: please specify clock when master mode");
            }
            if (clock <= 0 || clock > 1 * 1000 * 1000) {
                throw new Error("i2c: invalid clock " + clock);
            }
            if (arg.pull === "5v" && clock > 400 * 1000) {
                throw new Error("i2c: please use under 400khz when internal 5v internal pull-up");
            }
            if (arg.pull === "3v" && clock > 100 * 1000) {
                throw new Error("i2c: please use under 100khz when internal 3v internal pull-up");
            }
        }
        else {
            if (slave_address === null) {
                throw new Error("i2c: please specify slave_address");
            }
            if (slave_address < 0 || slave_address > 0x7f) {
                throw new Error("i2c: invalid slave_address");
            }
            if (slave_address < 0 || slave_address > 0x7f) {
                throw new Error("i2c: invalid slave_address");
            }
            if (slave_address_length !== null && slave_address_length !== 7) {
                throw new Error("i2c: invalid slave_address_length. please specify 7");
            }
        }
        this.Obniz.getIO(this.state.sda).drive("open-drain");
        this.Obniz.getIO(this.state.scl).drive("open-drain");
        if (this.state.pull) {
            this.Obniz.getIO(this.state.sda).pull(this.state.pull);
            this.Obniz.getIO(this.state.scl).pull(this.state.pull);
        }
        else {
            this.Obniz.getIO(this.state.sda).pull(null);
            this.Obniz.getIO(this.state.scl).pull(null);
        }
        if (this.state.gnd !== undefined) {
            this.Obniz.getIO(this.state.gnd).output(false);
            const ioNames = {};
            ioNames[this.state.gnd] = "gnd";
            this.Obniz.display.setPinNames("i2c" + this.id, ioNames);
        }
        const startObj = util_1.default._keyFilter(this.state, ["mode", "sda", "scl"]);
        if (mode === "master") {
            startObj.clock = clock;
        }
        else {
            startObj.slave_address = slave_address;
            if (slave_address_length) {
                startObj.slave_address_length = slave_address_length;
            }
        }
        const obj = {};
        obj["i2c" + this.id] = startObj;
        this.used = true;
        this.Obniz.send(obj);
    }
    write(address, data) {
        if (!this.used) {
            throw new Error(`i2c${this.id} is not started`);
        }
        address = parseInt(address);
        if (isNaN(address)) {
            throw new Error("i2c: please specify address");
        }
        if (address < 0 || address > 0x7f) {
            throw new Error("i2c: invalid address");
        }
        if (!data) {
            throw new Error("i2c: please provide data");
        }
        if (data.length > 1024) {
            throw new Error("i2c: data should be under 1024 bytes");
        }
        const obj = {};
        obj["i2c" + this.id] = {
            address,
            data,
        };
        this.Obniz.send(obj);
    }
    readWait(address, length) {
        if (!this.used) {
            throw new Error(`i2c${this.id} is not started`);
        }
        address = parseInt(address);
        if (isNaN(address)) {
            throw new Error("i2c: please specify address");
        }
        if (address < 0 || address > 0x7f) {
            throw new Error("i2c: invalid address");
        }
        length = parseInt(length);
        if (isNaN(length) || length < 0) {
            throw new Error("i2c: invalid length to read");
        }
        if (length > 1024) {
            throw new Error("i2c: data length should be under 1024 bytes");
        }
        const self = this;
        return new Promise((resolve, reject) => {
            self.addObserver(resolve);
            const obj = {};
            obj["i2c" + self.id] = {
                address,
                read: length,
            };
            self.Obniz.send(obj);
        });
    }
    notified(obj) {
        if (obj && typeof obj === "object") {
            if (obj.data) {
                if (obj.mode === "slave" && typeof this.onwritten === "function") {
                    this.onwritten(obj.data, obj.address);
                }
                else {
                    // TODO: we should compare byte length from sent
                    const callback = this.observers.shift();
                    if (callback) {
                        callback(obj.data);
                    }
                }
            }
            if (obj.warning) {
                this.Obniz.warning({
                    alert: "warning",
                    message: `i2c${this.id}: ${obj.warning.message}`,
                });
            }
            if (obj.error) {
                const message = `i2c${this.id}: ${obj.error.message}`;
                if (typeof this.onerror === "function") {
                    this.onerror(new Error(message));
                }
                else {
                    this.Obniz.error({
                        alert: "error",
                        message,
                    });
                }
            }
        }
    }
    isUsed() {
        return this.used;
    }
    end() {
        this.state = {};
        const obj = {};
        obj["i2c" + this.id] = null;
        this.Obniz.send(obj);
        this.used = false;
    }
}
exports.default = PeripheralI2C;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2lvX3BlcmlwaGVyYWxzL2kyYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHlEQUFzQztBQUV0QyxNQUFNLGFBQWE7SUFTakIsWUFBWSxLQUFVLEVBQUUsRUFBTztRQUM3QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNkLElBQUksQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDO0lBQzNCLENBQUM7SUFFTSxNQUFNO1FBQ1gsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7UUFDbEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7SUFDN0IsQ0FBQztJQUVNLFdBQVcsQ0FBQyxRQUFhO1FBQzlCLElBQUksUUFBUSxFQUFFO1lBQ1osSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDL0I7SUFDSCxDQUFDO0lBRU0sS0FBSyxDQUFDLEdBQVE7UUFDbkIsTUFBTSxHQUFHLEdBQVEsY0FBUyxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDdEUsSUFBSSxHQUFHLEVBQUU7WUFDUCxNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixHQUFHLEdBQUcsR0FBRyw0QkFBNEIsQ0FBQyxDQUFDO1NBQzNFO1FBQ0QsSUFBSSxDQUFDLEtBQUssR0FBRyxjQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNyQyxNQUFNO1lBQ04sS0FBSztZQUNMLEtBQUs7WUFDTCxNQUFNO1lBQ04sS0FBSztTQUNOLENBQUMsQ0FBQztRQUVI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LEdBQUcsQ0FBQyxLQUFLLEVBQUU7Z0JBQ2IsTUFBTSxPQUFPLEdBQVEsTUFBTSxJQUFJLENBQUMsRUFBRSxLQUFLLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQzNELElBQUksT0FBTyxJQUFJLENBQUMsT0FBTyxLQUFLLFVBQVUsRUFBRTtvQkFDdEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2lCQUNsQztxQkFBTTtvQkFDTCxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQzt3QkFDZixLQUFLLEVBQUUsT0FBTzt3QkFDZCxPQUFPO3FCQUNSLENBQUMsQ0FBQztpQkFDSjthQUNGO1NBQ0Y7SUFDSCxDQUFDO0lBRU0sTUFBTTtRQUNYLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDO0lBRU0sR0FBRztRQUNSLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLE1BQU0sR0FBRyxHQUFRLEVBQUUsQ0FBQztRQUNwQixHQUFHLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDNUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7SUFDcEIsQ0FBQztDQUNGO0FBRUQsa0JBQWUsYUFBYSxDQUFDIiwiZmlsZSI6InNyYy9vYm5pei9saWJzL2lvX3BlcmlwaGVyYWxzL2kyYy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPYm5pelV0aWwgZnJvbSBcIi4uL3V0aWxzL3V0aWxcIjtcblxuY2xhc3MgUGVyaXBoZXJhbEkyQyB7XG4gIHB1YmxpYyBPYm5pejogYW55O1xuICBwdWJsaWMgaWQ6IGFueTtcbiAgcHVibGljIG9uZXJyb3I6IGFueTtcbiAgcHVibGljIG9ic2VydmVyczogYW55O1xuICBwdWJsaWMgc3RhdGU6IGFueTtcbiAgcHVibGljIHVzZWQ6IGFueTtcbiAgcHVibGljIG9ud3JpdHRlbjogYW55O1xuXG4gIGNvbnN0cnVjdG9yKE9ibml6OiBhbnksIGlkOiBhbnkpIHtcbiAgICB0aGlzLk9ibml6ID0gT2JuaXo7XG4gICAgdGhpcy5pZCA9IGlkO1xuICAgIHRoaXMuX3Jlc2V0KCk7XG4gICAgdGhpcy5vbmVycm9yID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHVibGljIF9yZXNldCgpIHtcbiAgICB0aGlzLm9ic2VydmVycyA9IFtdO1xuICAgIHRoaXMuc3RhdGUgPSB7fTtcbiAgICB0aGlzLnVzZWQgPSBmYWxzZTtcbiAgICB0aGlzLm9ud3JpdHRlbiA9IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHB1YmxpYyBhZGRPYnNlcnZlcihjYWxsYmFjazogYW55KSB7XG4gICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICB0aGlzLm9ic2VydmVycy5wdXNoKGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc3RhcnQoYXJnOiBhbnkpIHtcbiAgICBjb25zdCBlcnI6IGFueSA9IE9ibml6VXRpbC5fcmVxdWlyZWRLZXlzKGFyZywgW1wibW9kZVwiLCBcInNkYVwiLCBcInNjbFwiXSk7XG4gICAgaWYgKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSTJDIHN0YXJ0IHBhcmFtICdcIiArIGVyciArIFwiJyByZXF1aXJlZCwgYnV0IG5vdCBmb3VuZCBcIik7XG4gICAgfVxuICAgIHRoaXMuc3RhdGUgPSBPYm5pelV0aWwuX2tleUZpbHRlcihhcmcsIFtcbiAgICAgIFwibW9kZVwiLFxuICAgICAgXCJzZGFcIixcbiAgICAgIFwic2NsXCIsXG4gICAgICBcInB1bGxcIixcbiAgICAgIFwiZ25kXCIsXG4gICAgXSk7XG5cbiAgICBjb25zdCBpb0tleXM6IGFueSA9IFtcInNkYVwiLCBcInNjbFwiLCBcImduZFwiXTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBpb0tleXMpIHtcbiAgICAgIGlmICh0aGlzLnN0YXRlW2tleV0gJiYgIXRoaXMuT2JuaXouaXNWYWxpZElPKHRoaXMuc3RhdGVba2V5XSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaTJjIHN0YXJ0IHBhcmFtICdcIiArIGtleSArIFwiJyBhcmUgdG8gYmUgdmFsaWQgaW8gbm9cIik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgbW9kZTogYW55ID0gdGhpcy5zdGF0ZS5tb2RlO1xuICAgIGNvbnN0IGNsb2NrOiBhbnkgPSB0eXBlb2YgYXJnLmNsb2NrID09PSBcIm51bWJlclwiID8gcGFyc2VJbnQoYXJnLmNsb2NrKSA6IG51bGw7XG4gICAgY29uc3Qgc2xhdmVfYWRkcmVzczogYW55ID1cbiAgICAgIHR5cGVvZiBhcmcuc2xhdmVfYWRkcmVzcyA9PT0gXCJudW1iZXJcIlxuICAgICAgICA/IHBhcnNlSW50KGFyZy5zbGF2ZV9hZGRyZXNzKVxuICAgICAgICA6IG51bGw7XG4gICAgY29uc3Qgc2xhdmVfYWRkcmVzc19sZW5ndGg6IGFueSA9XG4gICAgICB0eXBlb2YgYXJnLnNsYXZlX2FkZHJlc3NfbGVuZ3RoID09PSBcIm51bWJlclwiXG4gICAgICAgID8gcGFyc2VJbnQoYXJnLnNsYXZlX2FkZHJlc3NfbGVuZ3RoKVxuICAgICAgICA6IG51bGw7XG5cbiAgICBpZiAobW9kZSAhPT0gXCJtYXN0ZXJcIiAmJiBtb2RlICE9PSBcInNsYXZlXCIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcImkyYzogaW52YWxpZCBtb2RlIFwiICsgbW9kZSk7XG4gICAgfVxuICAgIGlmIChtb2RlID09PSBcIm1hc3RlclwiKSB7XG4gICAgICBpZiAoY2xvY2sgPT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaTJjOiBwbGVhc2Ugc3BlY2lmeSBjbG9jayB3aGVuIG1hc3RlciBtb2RlXCIpO1xuICAgICAgfVxuICAgICAgaWYgKGNsb2NrIDw9IDAgfHwgY2xvY2sgPiAxICogMTAwMCAqIDEwMDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaTJjOiBpbnZhbGlkIGNsb2NrIFwiICsgY2xvY2spO1xuICAgICAgfVxuICAgICAgaWYgKGFyZy5wdWxsID09PSBcIjV2XCIgJiYgY2xvY2sgPiA0MDAgKiAxMDAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBcImkyYzogcGxlYXNlIHVzZSB1bmRlciA0MDBraHogd2hlbiBpbnRlcm5hbCA1diBpbnRlcm5hbCBwdWxsLXVwXCIsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoYXJnLnB1bGwgPT09IFwiM3ZcIiAmJiBjbG9jayA+IDEwMCAqIDEwMDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIFwiaTJjOiBwbGVhc2UgdXNlIHVuZGVyIDEwMGtoeiB3aGVuIGludGVybmFsIDN2IGludGVybmFsIHB1bGwtdXBcIixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHNsYXZlX2FkZHJlc3MgPT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaTJjOiBwbGVhc2Ugc3BlY2lmeSBzbGF2ZV9hZGRyZXNzXCIpO1xuICAgICAgfVxuICAgICAgaWYgKHNsYXZlX2FkZHJlc3MgPCAwIHx8IHNsYXZlX2FkZHJlc3MgPiAweDdmKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImkyYzogaW52YWxpZCBzbGF2ZV9hZGRyZXNzXCIpO1xuICAgICAgfVxuICAgICAgaWYgKHNsYXZlX2FkZHJlc3MgPCAwIHx8IHNsYXZlX2FkZHJlc3MgPiAweDdmKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImkyYzogaW52YWxpZCBzbGF2ZV9hZGRyZXNzXCIpO1xuICAgICAgfVxuICAgICAgaWYgKHNsYXZlX2FkZHJlc3NfbGVuZ3RoICE9PSBudWxsICYmIHNsYXZlX2FkZHJlc3NfbGVuZ3RoICE9PSA3KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImkyYzogaW52YWxpZCBzbGF2ZV9hZGRyZXNzX2xlbmd0aC4gcGxlYXNlIHNwZWNpZnkgN1wiKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLk9ibml6LmdldElPKHRoaXMuc3RhdGUuc2RhKS5kcml2ZShcIm9wZW4tZHJhaW5cIik7XG4gICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnN0YXRlLnNjbCkuZHJpdmUoXCJvcGVuLWRyYWluXCIpO1xuXG4gICAgaWYgKHRoaXMuc3RhdGUucHVsbCkge1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnN0YXRlLnNkYSkucHVsbCh0aGlzLnN0YXRlLnB1bGwpO1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnN0YXRlLnNjbCkucHVsbCh0aGlzLnN0YXRlLnB1bGwpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLk9ibml6LmdldElPKHRoaXMuc3RhdGUuc2RhKS5wdWxsKG51bGwpO1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnN0YXRlLnNjbCkucHVsbChudWxsKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zdGF0ZS5nbmQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnN0YXRlLmduZCkub3V0cHV0KGZhbHNlKTtcbiAgICAgIGNvbnN0IGlvTmFtZXM6IGFueSA9IHt9O1xuICAgICAgaW9OYW1lc1t0aGlzLnN0YXRlLmduZF0gPSBcImduZFwiO1xuICAgICAgdGhpcy5PYm5pei5kaXNwbGF5LnNldFBpbk5hbWVzKFwiaTJjXCIgKyB0aGlzLmlkLCBpb05hbWVzKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdGFydE9iajogYW55ID0gT2JuaXpVdGlsLl9rZXlGaWx0ZXIodGhpcy5zdGF0ZSwgW1wibW9kZVwiLCBcInNkYVwiLCBcInNjbFwiXSk7XG4gICAgaWYgKG1vZGUgPT09IFwibWFzdGVyXCIpIHtcbiAgICAgIHN0YXJ0T2JqLmNsb2NrID0gY2xvY2s7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN0YXJ0T2JqLnNsYXZlX2FkZHJlc3MgPSBzbGF2ZV9hZGRyZXNzO1xuICAgICAgaWYgKHNsYXZlX2FkZHJlc3NfbGVuZ3RoKSB7XG4gICAgICAgIHN0YXJ0T2JqLnNsYXZlX2FkZHJlc3NfbGVuZ3RoID0gc2xhdmVfYWRkcmVzc19sZW5ndGg7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qgb2JqOiBhbnkgPSB7fTtcbiAgICBvYmpbXCJpMmNcIiArIHRoaXMuaWRdID0gc3RhcnRPYmo7XG4gICAgdGhpcy51c2VkID0gdHJ1ZTtcbiAgICB0aGlzLk9ibml6LnNlbmQob2JqKTtcbiAgfVxuXG4gIHB1YmxpYyB3cml0ZShhZGRyZXNzOiBhbnksIGRhdGE6IGFueSkge1xuICAgIGlmICghdGhpcy51c2VkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGkyYyR7dGhpcy5pZH0gaXMgbm90IHN0YXJ0ZWRgKTtcbiAgICB9XG4gICAgYWRkcmVzcyA9IHBhcnNlSW50KGFkZHJlc3MpO1xuICAgIGlmIChpc05hTihhZGRyZXNzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaTJjOiBwbGVhc2Ugc3BlY2lmeSBhZGRyZXNzXCIpO1xuICAgIH1cbiAgICBpZiAoYWRkcmVzcyA8IDAgfHwgYWRkcmVzcyA+IDB4N2YpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcImkyYzogaW52YWxpZCBhZGRyZXNzXCIpO1xuICAgIH1cbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcImkyYzogcGxlYXNlIHByb3ZpZGUgZGF0YVwiKTtcbiAgICB9XG4gICAgaWYgKGRhdGEubGVuZ3RoID4gMTAyNCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaTJjOiBkYXRhIHNob3VsZCBiZSB1bmRlciAxMDI0IGJ5dGVzXCIpO1xuICAgIH1cbiAgICBjb25zdCBvYmo6IGFueSA9IHt9O1xuICAgIG9ialtcImkyY1wiICsgdGhpcy5pZF0gPSB7XG4gICAgICBhZGRyZXNzLFxuICAgICAgZGF0YSxcbiAgICB9O1xuICAgIHRoaXMuT2JuaXouc2VuZChvYmopO1xuICB9XG5cbiAgcHVibGljIHJlYWRXYWl0KGFkZHJlc3M6IGFueSwgbGVuZ3RoOiBhbnkpIHtcbiAgICBpZiAoIXRoaXMudXNlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBpMmMke3RoaXMuaWR9IGlzIG5vdCBzdGFydGVkYCk7XG4gICAgfVxuICAgIGFkZHJlc3MgPSBwYXJzZUludChhZGRyZXNzKTtcbiAgICBpZiAoaXNOYU4oYWRkcmVzcykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcImkyYzogcGxlYXNlIHNwZWNpZnkgYWRkcmVzc1wiKTtcbiAgICB9XG4gICAgaWYgKGFkZHJlc3MgPCAwIHx8IGFkZHJlc3MgPiAweDdmKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpMmM6IGludmFsaWQgYWRkcmVzc1wiKTtcbiAgICB9XG4gICAgbGVuZ3RoID0gcGFyc2VJbnQobGVuZ3RoKTtcbiAgICBpZiAoaXNOYU4obGVuZ3RoKSB8fCBsZW5ndGggPCAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpMmM6IGludmFsaWQgbGVuZ3RoIHRvIHJlYWRcIik7XG4gICAgfVxuICAgIGlmIChsZW5ndGggPiAxMDI0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpMmM6IGRhdGEgbGVuZ3RoIHNob3VsZCBiZSB1bmRlciAxMDI0IGJ5dGVzXCIpO1xuICAgIH1cbiAgICBjb25zdCBzZWxmOiBhbnkgPSB0aGlzO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZTogYW55LCByZWplY3Q6IGFueSkgPT4ge1xuICAgICAgc2VsZi5hZGRPYnNlcnZlcihyZXNvbHZlKTtcbiAgICAgIGNvbnN0IG9iajogYW55ID0ge307XG4gICAgICBvYmpbXCJpMmNcIiArIHNlbGYuaWRdID0ge1xuICAgICAgICBhZGRyZXNzLFxuICAgICAgICByZWFkOiBsZW5ndGgsXG4gICAgICB9O1xuICAgICAgc2VsZi5PYm5pei5zZW5kKG9iaik7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgbm90aWZpZWQob2JqOiBhbnkpIHtcbiAgICBpZiAob2JqICYmIHR5cGVvZiBvYmogPT09IFwib2JqZWN0XCIpIHtcbiAgICAgIGlmIChvYmouZGF0YSkge1xuICAgICAgICBpZiAob2JqLm1vZGUgPT09IFwic2xhdmVcIiAmJiB0eXBlb2YgdGhpcy5vbndyaXR0ZW4gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgIHRoaXMub253cml0dGVuKG9iai5kYXRhLCBvYmouYWRkcmVzcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gVE9ETzogd2Ugc2hvdWxkIGNvbXBhcmUgYnl0ZSBsZW5ndGggZnJvbSBzZW50XG4gICAgICAgICAgY29uc3QgY2FsbGJhY2s6IGFueSA9IHRoaXMub2JzZXJ2ZXJzLnNoaWZ0KCk7XG4gICAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhvYmouZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAob2JqLndhcm5pbmcpIHtcbiAgICAgICAgdGhpcy5PYm5pei53YXJuaW5nKHtcbiAgICAgICAgICBhbGVydDogXCJ3YXJuaW5nXCIsXG4gICAgICAgICAgbWVzc2FnZTogYGkyYyR7dGhpcy5pZH06ICR7b2JqLndhcm5pbmcubWVzc2FnZX1gLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGlmIChvYmouZXJyb3IpIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZTogYW55ID0gYGkyYyR7dGhpcy5pZH06ICR7b2JqLmVycm9yLm1lc3NhZ2V9YDtcbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLm9uZXJyb3IgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgIHRoaXMub25lcnJvcihuZXcgRXJyb3IobWVzc2FnZSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuT2JuaXouZXJyb3Ioe1xuICAgICAgICAgICAgYWxlcnQ6IFwiZXJyb3JcIixcbiAgICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgaXNVc2VkKCkge1xuICAgIHJldHVybiB0aGlzLnVzZWQ7XG4gIH1cblxuICBwdWJsaWMgZW5kKCkge1xuICAgIHRoaXMuc3RhdGUgPSB7fTtcbiAgICBjb25zdCBvYmo6IGFueSA9IHt9O1xuICAgIG9ialtcImkyY1wiICsgdGhpcy5pZF0gPSBudWxsO1xuICAgIHRoaXMuT2JuaXouc2VuZChvYmopO1xuICAgIHRoaXMudXNlZCA9IGZhbHNlO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFBlcmlwaGVyYWxJMkM7XG4iXX0=

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class Display {
    constructor(Obniz) {
        this.Obniz = Obniz;
        this.width = 128;
        this.height = 64;
        this._canvas = null;
        this._reset();
    }
    _reset() {
        this._pos = { x: 0, y: 0 };
        this.autoFlush = true;
    }
    warnCanvasAvailability() {
        if (this.Obniz.isNode) {
            throw new Error("obniz.js require node-canvas to draw rich contents. see more detail on docs");
        }
        else {
            throw new Error("obniz.js cant create canvas element to body");
        }
    }
    _preparedCanvas() {
        if (this._canvas) {
            return this._canvas;
        }
        if (this.Obniz.isNode) {
            try {
                const { createCanvas } = require("canvas");
                this._canvas = createCanvas(this.width, this.height);
            }
            catch (e) {
                // this.warnCanvasAvailability();
                return null;
            }
        }
        else {
            const identifier = "obnizcanvas-" + this.Obniz.id;
            let canvas = document.getElementById(identifier);
            if (!canvas) {
                canvas = document.createElement("canvas");
                canvas.setAttribute("id", identifier);
                canvas.style.visibility = "hidden";
                canvas.width = this.width;
                canvas.height = this.height;
                canvas.style["-webkit-font-smoothing"] = "none";
                const body = document.getElementsByTagName("body")[0];
                body.appendChild(canvas);
            }
            this._canvas = canvas;
        }
        const ctx = this._canvas.getContext("2d");
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, this.width, this.height);
        ctx.fillStyle = "#FFF";
        ctx.strokeStyle = "#FFF";
        this._pos.x = 0;
        this._pos.y = 0;
        this.fontSize = 16;
        ctx.font = `${this.fontSize}px Arial`;
        return this._canvas;
    }
    _ctx() {
        const canvas = this._preparedCanvas();
        if (canvas) {
            return canvas.getContext("2d");
        }
    }
    font(font, size) {
        const ctx = this._ctx();
        if (typeof size !== "number") {
            size = 16;
        }
        if (typeof font !== "string") {
            font = "Arial";
        }
        this.fontSize = size;
        ctx.font = "" + +" " + size + "px " + font;
    }
    clear() {
        const ctx = this._ctx();
        this._pos.x = 0;
        this._pos.y = 0;
        if (ctx) {
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, this.width, this.height);
            ctx.fillStyle = "#FFF";
            ctx.strokeStyle = "#FFF";
            this.draw(ctx);
        }
        else {
            const obj = {};
            obj.display = {
                clear: true,
            };
            this.Obniz.send(obj);
        }
    }
    pos(x, y) {
        this._ctx(); // crete first
        if (typeof x === "number") {
            this._pos.x = x;
        }
        if (typeof y === "number") {
            this._pos.y = y;
        }
        return this._pos;
    }
    print(text) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.fillText(text, this._pos.x, this._pos.y + this.fontSize);
            this.draw(ctx);
            this._pos.y += this.fontSize;
        }
        else {
            const obj = {};
            obj.display = {
                text: "" + text,
            };
            this.Obniz.send(obj);
        }
    }
    line(x_0, y_0, x_1, y_1) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.beginPath();
            ctx.moveTo(x_0, y_0);
            ctx.lineTo(x_1, y_1);
            ctx.stroke();
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    rect(x, y, width, height, mustFill) {
        const ctx = this._ctx();
        if (ctx) {
            if (mustFill) {
                ctx.fillRect(x, y, width, height);
            }
            else {
                ctx.strokeRect(x, y, width, height);
            }
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    circle(x, y, r, mustFill) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            if (mustFill) {
                ctx.fill();
            }
            else {
                ctx.stroke();
            }
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    qr(text, correction) {
        const obj = {};
        obj.display = {
            qr: {
                text,
            },
        };
        if (correction) {
            obj.display.qr.correction = correction;
        }
        this.Obniz.send(obj);
    }
    raw(data) {
        const obj = {};
        obj.display = {
            raw: data,
        };
        this.Obniz.send(obj);
    }
    setPinName(io, moduleName, funcName) {
        const obj = {};
        obj.display = {};
        obj.display.pin_assign = {};
        obj.display.pin_assign[io] = {
            module_name: moduleName,
            pin_name: funcName,
        };
        this.Obniz.send(obj);
    }
    setPinNames(moduleName, data) {
        const obj = {};
        obj.display = {};
        obj.display.pin_assign = {};
        let noAssignee = true;
        for (const key in data) {
            noAssignee = false;
            obj.display.pin_assign[key] = {
                module_name: moduleName,
                pin_name: data[key],
            };
        }
        if (!noAssignee) {
            this.Obniz.send(obj);
        }
    }
    _draw(ctx) {
        const stride = this.width / 8;
        const vram = new Array(stride * 64);
        const imageData = ctx.getImageData(0, 0, this.width, this.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];
            const index = Math.floor(i / 4);
            const line = Math.floor(index / this.width);
            const col = Math.floor((index - line * this.width) / 8);
            const bits = Math.floor(index - line * this.width) % 8;
            if (bits === 0) {
                vram[line * stride + col] = 0x00;
            }
            if (brightness > 0x7f) {
                vram[line * stride + col] |= 0x80 >> bits;
            }
        }
        this.raw(vram);
    }
    draw(ctx) {
        if (this.autoFlush) {
            this._draw(ctx);
        }
    }
    drawing(autoFlush) {
        this.autoFlush = autoFlush === true;
        const ctx = this._ctx();
        if (ctx) {
            this.draw(ctx);
        }
    }
}
exports.default = Display;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9kaXNwbGF5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTSxPQUFPO0lBVVgsWUFBWSxLQUFVO1FBQ3BCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDO1FBQ2pCLElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBRWpCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBRU0sTUFBTTtRQUNYLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUMsQ0FBQztRQUN6QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztJQUN4QixDQUFDO0lBRU0sc0JBQXNCO1FBQzNCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUU7WUFDckIsTUFBTSxJQUFJLEtBQUssQ0FDYiw2RUFBNkUsQ0FDOUUsQ0FBQztTQUNIO2FBQU07WUFDTCxNQUFNLElBQUksS0FBSyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7U0FDaEU7SUFDSCxDQUFDO0lBRU0sZUFBZTtRQUNwQixJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDaEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO1NBQ3JCO1FBQ0QsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRTtZQUNyQixJQUFJO2dCQUNGLE1BQU0sRUFBQyxZQUFZLEVBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ3pDLElBQUksQ0FBQyxPQUFPLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3REO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1YsaUNBQWlDO2dCQUNqQyxPQUFPLElBQUksQ0FBQzthQUNiO1NBQ0Y7YUFBTTtZQUNMLE1BQU0sVUFBVSxHQUFRLGNBQWMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUN2RCxJQUFJLE1BQU0sR0FBUSxRQUFRLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3RELElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ1gsTUFBTSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO2dCQUN0QyxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUM7Z0JBQ25DLE1BQU0sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztnQkFDMUIsTUFBTSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO2dCQUM1QixNQUFNLENBQUMsS0FBSyxDQUFDLHdCQUF3QixDQUFDLEdBQUcsTUFBTSxDQUFDO2dCQUNoRCxNQUFNLElBQUksR0FBUSxRQUFRLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzNELElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDMUI7WUFDRCxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztTQUN2QjtRQUNELE1BQU0sR0FBRyxHQUFRLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQy9DLEdBQUcsQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDO1FBQ3ZCLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM1QyxHQUFHLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQztRQUN2QixHQUFHLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQztRQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hCLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ25CLEdBQUcsQ0FBQyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsUUFBUSxVQUFVLENBQUM7UUFDdEMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUFFTSxJQUFJO1FBQ1QsTUFBTSxNQUFNLEdBQVEsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQzNDLElBQUksTUFBTSxFQUFFO1lBQ1YsT0FBTyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2hDO0lBQ0gsQ0FBQztJQUVNLElBQUksQ0FBQyxJQUFTLEVBQUUsSUFBUztRQUM5QixNQUFNLEdBQUcsR0FBUSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDN0IsSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDNUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztTQUNYO1FBQ0QsSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDNUIsSUFBSSxHQUFHLE9BQU8sQ0FBQztTQUNoQjtRQUNELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLEdBQUcsQ0FBQyxJQUFJLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLElBQUksR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDO0lBQzdDLENBQUM7SUFFTSxLQUFLO1FBQ1YsTUFBTSxHQUFHLEdBQVEsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEIsSUFBSSxHQUFHLEVBQUU7WUFDUCxHQUFHLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQztZQUN2QixHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDNUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUM7WUFDdkIsR0FBRyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUM7WUFDekIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNoQjthQUFNO1lBQ0wsTUFBTSxHQUFHLEdBQVEsRUFBRSxDQUFDO1lBQ3BCLEdBQUcsQ0FBQyxPQUFPLEdBQUc7Z0JBQ1osS0FBSyxFQUFFLElBQUk7YUFDWixDQUFDO1lBQ0YsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDdEI7SUFDSCxDQUFDO0lBRU0sR0FBRyxDQUFDLENBQU0sRUFBRSxDQUFNO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLGNBQWM7UUFDM0IsSUFBSSxPQUFPLENBQUMsS0FBSyxRQUFRLEVBQUU7WUFDekIsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2pCO1FBQ0QsSUFBSSxPQUFPLENBQUMsS0FBSyxRQUFRLEVBQUU7WUFDekIsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2pCO1FBQ0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFFTSxLQUFLLENBQUMsSUFBUztRQUNwQixNQUFNLEdBQUcsR0FBUSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDN0IsSUFBSSxHQUFHLEVBQUU7WUFDUCxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDN0QsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUM7U0FDOUI7YUFBTTtZQUNMLE1BQU0sR0FBRyxHQUFRLEVBQUUsQ0FBQztZQUNwQixHQUFHLENBQUMsT0FBTyxHQUFHO2dCQUNaLElBQUksRUFBRSxFQUFFLEdBQUcsSUFBSTthQUNoQixDQUFDO1lBQ0YsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDdEI7SUFDSCxDQUFDO0lBRU0sSUFBSSxDQUFDLEdBQVEsRUFBRSxHQUFRLEVBQUUsR0FBUSxFQUFFLEdBQVE7UUFDaEQsTUFBTSxHQUFHLEdBQVEsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzdCLElBQUksR0FBRyxFQUFFO1lBQ1AsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ2hCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3JCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3JCLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNiLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDaEI7YUFBTTtZQUNMLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1NBQy9CO0lBQ0gsQ0FBQztJQUVNLElBQUksQ0FBQyxDQUFNLEVBQUUsQ0FBTSxFQUFFLEtBQVUsRUFBRSxNQUFXLEVBQUUsUUFBYTtRQUNoRSxNQUFNLEdBQUcsR0FBUSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDN0IsSUFBSSxHQUFHLEVBQUU7WUFDUCxJQUFJLFFBQVEsRUFBRTtnQkFDWixHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2FBQ25DO2lCQUFNO2dCQUNMLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7YUFDckM7WUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2hCO2FBQU07WUFDTCxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztTQUMvQjtJQUNILENBQUM7SUFFTSxNQUFNLENBQUMsQ0FBTSxFQUFFLENBQU0sRUFBRSxDQUFNLEVBQUUsUUFBYTtRQUNqRCxNQUFNLEdBQUcsR0FBUSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDN0IsSUFBSSxHQUFHLEVBQUU7WUFDUCxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDaEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNqQyxJQUFJLFFBQVEsRUFBRTtnQkFDWixHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDWjtpQkFBTTtnQkFDTCxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDZDtZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDaEI7YUFBTTtZQUNMLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1NBQy9CO0lBQ0gsQ0FBQztJQUVNLEVBQUUsQ0FBQyxJQUFTLEVBQUUsVUFBZTtRQUNsQyxNQUFNLEdBQUcsR0FBUSxFQUFFLENBQUM7UUFDcEIsR0FBRyxDQUFDLE9BQU8sR0FBRztZQUNaLEVBQUUsRUFBRTtnQkFDRixJQUFJO2FBQ0w7U0FDRixDQUFDO1FBQ0YsSUFBSSxVQUFVLEVBQUU7WUFDZCxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1NBQ3hDO1FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUVNLEdBQUcsQ0FBQyxJQUFTO1FBQ2xCLE1BQU0sR0FBRyxHQUFRLEVBQUUsQ0FBQztRQUNwQixHQUFHLENBQUMsT0FBTyxHQUFHO1lBQ1osR0FBRyxFQUFFLElBQUk7U0FDVixDQUFDO1FBQ0YsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUVNLFVBQVUsQ0FBQyxFQUFPLEVBQUUsVUFBZSxFQUFFLFFBQWE7UUFDdkQsTUFBTSxHQUFHLEdBQVEsRUFBRSxDQUFDO1FBQ3BCLEdBQUcsQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUM1QixHQUFHLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsR0FBRztZQUMzQixXQUFXLEVBQUUsVUFBVTtZQUN2QixRQUFRLEVBQUUsUUFBUTtTQUNuQixDQUFDO1FBRUYsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUVNLFdBQVcsQ0FBQyxVQUFlLEVBQUUsSUFBUztRQUMzQyxNQUFNLEdBQUcsR0FBUSxFQUFFLENBQUM7UUFDcEIsR0FBRyxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDakIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksVUFBVSxHQUFRLElBQUksQ0FBQztRQUMzQixLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksRUFBRTtZQUN0QixVQUFVLEdBQUcsS0FBSyxDQUFDO1lBQ25CLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHO2dCQUM1QixXQUFXLEVBQUUsVUFBVTtnQkFDdkIsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUM7YUFDcEIsQ0FBQztTQUNIO1FBQ0QsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3RCO0lBQ0gsQ0FBQztJQUVNLEtBQUssQ0FBQyxHQUFRO1FBQ25CLE1BQU0sTUFBTSxHQUFRLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ25DLE1BQU0sSUFBSSxHQUFRLElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUMsQ0FBQztRQUN6QyxNQUFNLFNBQVMsR0FBUSxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdkUsTUFBTSxJQUFJLEdBQVEsU0FBUyxDQUFDLElBQUksQ0FBQztRQUVqQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3ZDLE1BQU0sVUFBVSxHQUFRLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDaEYsTUFBTSxLQUFLLEdBQVEsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDckMsTUFBTSxJQUFJLEdBQVEsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2pELE1BQU0sR0FBRyxHQUFRLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUM3RCxNQUFNLElBQUksR0FBUSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM1RCxJQUFJLElBQUksS0FBSyxDQUFDLEVBQUU7Z0JBQ2QsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLEdBQUcsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDO2FBQ2xDO1lBQ0QsSUFBSSxVQUFVLEdBQUcsSUFBSSxFQUFFO2dCQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDO2FBQzNDO1NBQ0Y7UUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pCLENBQUM7SUFFTSxJQUFJLENBQUMsR0FBUTtRQUNsQixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNqQjtJQUNILENBQUM7SUFFTSxPQUFPLENBQUMsU0FBYztRQUMzQixJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsS0FBSyxJQUFJLENBQUM7UUFDcEMsTUFBTSxHQUFHLEdBQVEsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzdCLElBQUksR0FBRyxFQUFFO1lBQ1AsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNoQjtJQUNILENBQUM7Q0FDRjtBQUVELGtCQUFlLE9BQU8sQ0FBQyIsImZpbGUiOiJzcmMvb2JuaXovbGlicy9lbWJlZHMvZGlzcGxheS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIERpc3BsYXkge1xuICBwdWJsaWMgT2JuaXo6IGFueTtcbiAgcHVibGljIHdpZHRoOiBhbnk7XG4gIHB1YmxpYyBoZWlnaHQ6IGFueTtcbiAgcHVibGljIF9jYW52YXM6IGFueTtcbiAgcHVibGljIF9wb3M6IGFueTtcbiAgcHVibGljIGF1dG9GbHVzaDogYW55O1xuICBwdWJsaWMgZm9udFNpemU6IGFueTtcbiAgcHVibGljIGNyZWF0ZUNhbnZhczogYW55O1xuXG4gIGNvbnN0cnVjdG9yKE9ibml6OiBhbnkpIHtcbiAgICB0aGlzLk9ibml6ID0gT2JuaXo7XG4gICAgdGhpcy53aWR0aCA9IDEyODtcbiAgICB0aGlzLmhlaWdodCA9IDY0O1xuXG4gICAgdGhpcy5fY2FudmFzID0gbnVsbDtcbiAgICB0aGlzLl9yZXNldCgpO1xuICB9XG5cbiAgcHVibGljIF9yZXNldCgpIHtcbiAgICB0aGlzLl9wb3MgPSB7eDogMCwgeTogMH07XG4gICAgdGhpcy5hdXRvRmx1c2ggPSB0cnVlO1xuICB9XG5cbiAgcHVibGljIHdhcm5DYW52YXNBdmFpbGFiaWxpdHkoKSB7XG4gICAgaWYgKHRoaXMuT2JuaXouaXNOb2RlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwib2JuaXouanMgcmVxdWlyZSBub2RlLWNhbnZhcyB0byBkcmF3IHJpY2ggY29udGVudHMuIHNlZSBtb3JlIGRldGFpbCBvbiBkb2NzXCIsXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJvYm5pei5qcyBjYW50IGNyZWF0ZSBjYW52YXMgZWxlbWVudCB0byBib2R5XCIpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBfcHJlcGFyZWRDYW52YXMoKSB7XG4gICAgaWYgKHRoaXMuX2NhbnZhcykge1xuICAgICAgcmV0dXJuIHRoaXMuX2NhbnZhcztcbiAgICB9XG4gICAgaWYgKHRoaXMuT2JuaXouaXNOb2RlKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7Y3JlYXRlQ2FudmFzfSA9IHJlcXVpcmUoXCJjYW52YXNcIik7XG4gICAgICAgIHRoaXMuX2NhbnZhcyA9IGNyZWF0ZUNhbnZhcyh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIC8vIHRoaXMud2FybkNhbnZhc0F2YWlsYWJpbGl0eSgpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgaWRlbnRpZmllcjogYW55ID0gXCJvYm5pemNhbnZhcy1cIiArIHRoaXMuT2JuaXouaWQ7XG4gICAgICBsZXQgY2FudmFzOiBhbnkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZGVudGlmaWVyKTtcbiAgICAgIGlmICghY2FudmFzKSB7XG4gICAgICAgIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XG4gICAgICAgIGNhbnZhcy5zZXRBdHRyaWJ1dGUoXCJpZFwiLCBpZGVudGlmaWVyKTtcbiAgICAgICAgY2FudmFzLnN0eWxlLnZpc2liaWxpdHkgPSBcImhpZGRlblwiO1xuICAgICAgICBjYW52YXMud2lkdGggPSB0aGlzLndpZHRoO1xuICAgICAgICBjYW52YXMuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7XG4gICAgICAgIGNhbnZhcy5zdHlsZVtcIi13ZWJraXQtZm9udC1zbW9vdGhpbmdcIl0gPSBcIm5vbmVcIjtcbiAgICAgICAgY29uc3QgYm9keTogYW55ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJib2R5XCIpWzBdO1xuICAgICAgICBib2R5LmFwcGVuZENoaWxkKGNhbnZhcyk7XG4gICAgICB9XG4gICAgICB0aGlzLl9jYW52YXMgPSBjYW52YXM7XG4gICAgfVxuICAgIGNvbnN0IGN0eDogYW55ID0gdGhpcy5fY2FudmFzLmdldENvbnRleHQoXCIyZFwiKTtcbiAgICBjdHguZmlsbFN0eWxlID0gXCIjMDAwXCI7XG4gICAgY3R4LmZpbGxSZWN0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTtcbiAgICBjdHguZmlsbFN0eWxlID0gXCIjRkZGXCI7XG4gICAgY3R4LnN0cm9rZVN0eWxlID0gXCIjRkZGXCI7XG4gICAgdGhpcy5fcG9zLnggPSAwO1xuICAgIHRoaXMuX3Bvcy55ID0gMDtcbiAgICB0aGlzLmZvbnRTaXplID0gMTY7XG4gICAgY3R4LmZvbnQgPSBgJHt0aGlzLmZvbnRTaXplfXB4IEFyaWFsYDtcbiAgICByZXR1cm4gdGhpcy5fY2FudmFzO1xuICB9XG5cbiAgcHVibGljIF9jdHgoKSB7XG4gICAgY29uc3QgY2FudmFzOiBhbnkgPSB0aGlzLl9wcmVwYXJlZENhbnZhcygpO1xuICAgIGlmIChjYW52YXMpIHtcbiAgICAgIHJldHVybiBjYW52YXMuZ2V0Q29udGV4dChcIjJkXCIpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBmb250KGZvbnQ6IGFueSwgc2l6ZTogYW55KSB7XG4gICAgY29uc3QgY3R4OiBhbnkgPSB0aGlzLl9jdHgoKTtcbiAgICBpZiAodHlwZW9mIHNpemUgIT09IFwibnVtYmVyXCIpIHtcbiAgICAgIHNpemUgPSAxNjtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBmb250ICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICBmb250ID0gXCJBcmlhbFwiO1xuICAgIH1cbiAgICB0aGlzLmZvbnRTaXplID0gc2l6ZTtcbiAgICBjdHguZm9udCA9IFwiXCIgKyArXCIgXCIgKyBzaXplICsgXCJweCBcIiArIGZvbnQ7XG4gIH1cblxuICBwdWJsaWMgY2xlYXIoKSB7XG4gICAgY29uc3QgY3R4OiBhbnkgPSB0aGlzLl9jdHgoKTtcbiAgICB0aGlzLl9wb3MueCA9IDA7XG4gICAgdGhpcy5fcG9zLnkgPSAwO1xuICAgIGlmIChjdHgpIHtcbiAgICAgIGN0eC5maWxsU3R5bGUgPSBcIiMwMDBcIjtcbiAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7XG4gICAgICBjdHguZmlsbFN0eWxlID0gXCIjRkZGXCI7XG4gICAgICBjdHguc3Ryb2tlU3R5bGUgPSBcIiNGRkZcIjtcbiAgICAgIHRoaXMuZHJhdyhjdHgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBvYmo6IGFueSA9IHt9O1xuICAgICAgb2JqLmRpc3BsYXkgPSB7XG4gICAgICAgIGNsZWFyOiB0cnVlLFxuICAgICAgfTtcbiAgICAgIHRoaXMuT2JuaXouc2VuZChvYmopO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBwb3MoeDogYW55LCB5OiBhbnkpIHtcbiAgICB0aGlzLl9jdHgoKTsgLy8gY3JldGUgZmlyc3RcbiAgICBpZiAodHlwZW9mIHggPT09IFwibnVtYmVyXCIpIHtcbiAgICAgIHRoaXMuX3Bvcy54ID0geDtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB5ID09PSBcIm51bWJlclwiKSB7XG4gICAgICB0aGlzLl9wb3MueSA9IHk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9wb3M7XG4gIH1cblxuICBwdWJsaWMgcHJpbnQodGV4dDogYW55KSB7XG4gICAgY29uc3QgY3R4OiBhbnkgPSB0aGlzLl9jdHgoKTtcbiAgICBpZiAoY3R4KSB7XG4gICAgICBjdHguZmlsbFRleHQodGV4dCwgdGhpcy5fcG9zLngsIHRoaXMuX3Bvcy55ICsgdGhpcy5mb250U2l6ZSk7XG4gICAgICB0aGlzLmRyYXcoY3R4KTtcbiAgICAgIHRoaXMuX3Bvcy55ICs9IHRoaXMuZm9udFNpemU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG9iajogYW55ID0ge307XG4gICAgICBvYmouZGlzcGxheSA9IHtcbiAgICAgICAgdGV4dDogXCJcIiArIHRleHQsXG4gICAgICB9O1xuICAgICAgdGhpcy5PYm5pei5zZW5kKG9iaik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGxpbmUoeF8wOiBhbnksIHlfMDogYW55LCB4XzE6IGFueSwgeV8xOiBhbnkpIHtcbiAgICBjb25zdCBjdHg6IGFueSA9IHRoaXMuX2N0eCgpO1xuICAgIGlmIChjdHgpIHtcbiAgICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICAgIGN0eC5tb3ZlVG8oeF8wLCB5XzApO1xuICAgICAgY3R4LmxpbmVUbyh4XzEsIHlfMSk7XG4gICAgICBjdHguc3Ryb2tlKCk7XG4gICAgICB0aGlzLmRyYXcoY3R4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy53YXJuQ2FudmFzQXZhaWxhYmlsaXR5KCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlY3QoeDogYW55LCB5OiBhbnksIHdpZHRoOiBhbnksIGhlaWdodDogYW55LCBtdXN0RmlsbDogYW55KSB7XG4gICAgY29uc3QgY3R4OiBhbnkgPSB0aGlzLl9jdHgoKTtcbiAgICBpZiAoY3R4KSB7XG4gICAgICBpZiAobXVzdEZpbGwpIHtcbiAgICAgICAgY3R4LmZpbGxSZWN0KHgsIHksIHdpZHRoLCBoZWlnaHQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY3R4LnN0cm9rZVJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7XG4gICAgICB9XG4gICAgICB0aGlzLmRyYXcoY3R4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy53YXJuQ2FudmFzQXZhaWxhYmlsaXR5KCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNpcmNsZSh4OiBhbnksIHk6IGFueSwgcjogYW55LCBtdXN0RmlsbDogYW55KSB7XG4gICAgY29uc3QgY3R4OiBhbnkgPSB0aGlzLl9jdHgoKTtcbiAgICBpZiAoY3R4KSB7XG4gICAgICBjdHguYmVnaW5QYXRoKCk7XG4gICAgICBjdHguYXJjKHgsIHksIHIsIDAsIE1hdGguUEkgKiAyKTtcbiAgICAgIGlmIChtdXN0RmlsbCkge1xuICAgICAgICBjdHguZmlsbCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY3R4LnN0cm9rZSgpO1xuICAgICAgfVxuICAgICAgdGhpcy5kcmF3KGN0eCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMud2FybkNhbnZhc0F2YWlsYWJpbGl0eSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBxcih0ZXh0OiBhbnksIGNvcnJlY3Rpb246IGFueSkge1xuICAgIGNvbnN0IG9iajogYW55ID0ge307XG4gICAgb2JqLmRpc3BsYXkgPSB7XG4gICAgICBxcjoge1xuICAgICAgICB0ZXh0LFxuICAgICAgfSxcbiAgICB9O1xuICAgIGlmIChjb3JyZWN0aW9uKSB7XG4gICAgICBvYmouZGlzcGxheS5xci5jb3JyZWN0aW9uID0gY29ycmVjdGlvbjtcbiAgICB9XG4gICAgdGhpcy5PYm5pei5zZW5kKG9iaik7XG4gIH1cblxuICBwdWJsaWMgcmF3KGRhdGE6IGFueSkge1xuICAgIGNvbnN0IG9iajogYW55ID0ge307XG4gICAgb2JqLmRpc3BsYXkgPSB7XG4gICAgICByYXc6IGRhdGEsXG4gICAgfTtcbiAgICB0aGlzLk9ibml6LnNlbmQob2JqKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRQaW5OYW1lKGlvOiBhbnksIG1vZHVsZU5hbWU6IGFueSwgZnVuY05hbWU6IGFueSkge1xuICAgIGNvbnN0IG9iajogYW55ID0ge307XG4gICAgb2JqLmRpc3BsYXkgPSB7fTtcbiAgICBvYmouZGlzcGxheS5waW5fYXNzaWduID0ge307XG4gICAgb2JqLmRpc3BsYXkucGluX2Fzc2lnbltpb10gPSB7XG4gICAgICBtb2R1bGVfbmFtZTogbW9kdWxlTmFtZSxcbiAgICAgIHBpbl9uYW1lOiBmdW5jTmFtZSxcbiAgICB9O1xuXG4gICAgdGhpcy5PYm5pei5zZW5kKG9iaik7XG4gIH1cblxuICBwdWJsaWMgc2V0UGluTmFtZXMobW9kdWxlTmFtZTogYW55LCBkYXRhOiBhbnkpIHtcbiAgICBjb25zdCBvYmo6IGFueSA9IHt9O1xuICAgIG9iai5kaXNwbGF5ID0ge307XG4gICAgb2JqLmRpc3BsYXkucGluX2Fzc2lnbiA9IHt9O1xuICAgIGxldCBub0Fzc2lnbmVlOiBhbnkgPSB0cnVlO1xuICAgIGZvciAoY29uc3Qga2V5IGluIGRhdGEpIHtcbiAgICAgIG5vQXNzaWduZWUgPSBmYWxzZTtcbiAgICAgIG9iai5kaXNwbGF5LnBpbl9hc3NpZ25ba2V5XSA9IHtcbiAgICAgICAgbW9kdWxlX25hbWU6IG1vZHVsZU5hbWUsXG4gICAgICAgIHBpbl9uYW1lOiBkYXRhW2tleV0sXG4gICAgICB9O1xuICAgIH1cbiAgICBpZiAoIW5vQXNzaWduZWUpIHtcbiAgICAgIHRoaXMuT2JuaXouc2VuZChvYmopO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBfZHJhdyhjdHg6IGFueSkge1xuICAgIGNvbnN0IHN0cmlkZTogYW55ID0gdGhpcy53aWR0aCAvIDg7XG4gICAgY29uc3QgdnJhbTogYW55ID0gbmV3IEFycmF5KHN0cmlkZSAqIDY0KTtcbiAgICBjb25zdCBpbWFnZURhdGE6IGFueSA9IGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpO1xuICAgIGNvbnN0IGRhdGE6IGFueSA9IGltYWdlRGF0YS5kYXRhO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArPSA0KSB7XG4gICAgICBjb25zdCBicmlnaHRuZXNzOiBhbnkgPSAwLjM0ICogZGF0YVtpXSArIDAuNSAqIGRhdGFbaSArIDFdICsgMC4xNiAqIGRhdGFbaSArIDJdO1xuICAgICAgY29uc3QgaW5kZXg6IGFueSA9IE1hdGguZmxvb3IoaSAvIDQpO1xuICAgICAgY29uc3QgbGluZTogYW55ID0gTWF0aC5mbG9vcihpbmRleCAvIHRoaXMud2lkdGgpO1xuICAgICAgY29uc3QgY29sOiBhbnkgPSBNYXRoLmZsb29yKChpbmRleCAtIGxpbmUgKiB0aGlzLndpZHRoKSAvIDgpO1xuICAgICAgY29uc3QgYml0czogYW55ID0gTWF0aC5mbG9vcihpbmRleCAtIGxpbmUgKiB0aGlzLndpZHRoKSAlIDg7XG4gICAgICBpZiAoYml0cyA9PT0gMCkge1xuICAgICAgICB2cmFtW2xpbmUgKiBzdHJpZGUgKyBjb2xdID0gMHgwMDtcbiAgICAgIH1cbiAgICAgIGlmIChicmlnaHRuZXNzID4gMHg3Zikge1xuICAgICAgICB2cmFtW2xpbmUgKiBzdHJpZGUgKyBjb2xdIHw9IDB4ODAgPj4gYml0cztcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5yYXcodnJhbSk7XG4gIH1cblxuICBwdWJsaWMgZHJhdyhjdHg6IGFueSkge1xuICAgIGlmICh0aGlzLmF1dG9GbHVzaCkge1xuICAgICAgdGhpcy5fZHJhdyhjdHgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBkcmF3aW5nKGF1dG9GbHVzaDogYW55KSB7XG4gICAgdGhpcy5hdXRvRmx1c2ggPSBhdXRvRmx1c2ggPT09IHRydWU7XG4gICAgY29uc3QgY3R4OiBhbnkgPSB0aGlzLl9jdHgoKTtcbiAgICBpZiAoY3R4KSB7XG4gICAgICB0aGlzLmRyYXcoY3R4KTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRGlzcGxheTtcbiJdfQ==

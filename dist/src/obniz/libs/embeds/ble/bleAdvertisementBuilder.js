"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const bleHelper_1 = __importDefault(require("./bleHelper"));
class BleAdvertisementBuilder {
    constructor(Obniz, json) {
        this.Obniz = Obniz;
        this.rows = {};
        if (json) {
            if (json.localName) {
                this.setCompleteLocalName(json.localName);
            }
            if (json.manufacturerData &&
                json.manufacturerData.companyCode &&
                json.manufacturerData.data) {
                this.setManufacturerSpecificData(json.manufacturerData.companyCode, json.manufacturerData.data);
            }
            if (json.serviceUuids) {
                for (const uuid of json.serviceUuids) {
                    this.setUuid(uuid);
                }
            }
        }
        if (typeof this.extendEvalJson === "function") {
            this.extendEvalJson(json);
        }
    }
    setRow(type, data) {
        this.rows[type] = data;
    }
    getRow(type) {
        return this.rows[type] || [];
    }
    build() {
        const data = [];
        for (const key in this.rows) {
            if (this.rows[key].length === 0) {
                continue;
            }
            data.push(this.rows[key].length + 1);
            data.push(parseInt(key));
            Array.prototype.push.apply(data, this.rows[key]);
        }
        if (data.length > 31) {
            this.Obniz.error("Too large data. Advertise/ScanResponse data are must be less than 32 byte.");
        }
        return data;
    }
    setStringData(type, string) {
        const data = [];
        for (let i = 0; i < string.length; i++) {
            data.push(string.charCodeAt(i));
        }
        this.setRow(type, data);
    }
    setShortenedLocalName(name) {
        this.setStringData(0x08, name);
    }
    setCompleteLocalName(name) {
        this.setStringData(0x09, name);
    }
    setManufacturerSpecificData(companyCode, data) {
        const row = [];
        row.push(companyCode & 0xff);
        row.push((companyCode >> 8) & 0xff);
        Array.prototype.push.apply(row, data);
        this.setRow(0xff, row);
    }
    setUuid(uuid) {
        const uuidData = this.convertUuid(uuid);
        let type;
        if (uuidData.length === 16) {
            type = 0x06;
        }
        else if (uuidData.length === 4) {
            type = 0x04;
        }
        else if (uuidData.length === 2) {
            type = 0x02;
        }
        this.setRow(type, uuidData);
    }
    convertUuid(uuid) {
        const uuidNumeric = bleHelper_1.default.uuidFilter(uuid);
        if (uuidNumeric.length !== 32 &&
            uuidNumeric.length !== 8 &&
            uuidNumeric.length !== 4) {
            this.Obniz.error("BLE uuid must be 16/32/128 bit . (example: c28f0ad5-a7fd-48be-9fd0-eae9ffd3a8bb for 128bit)");
        }
        const data = [];
        for (let i = uuidNumeric.length; i > 1; i -= 2) {
            data.push(parseInt(uuidNumeric[i - 2] + uuidNumeric[i - 1], 16));
        }
        return data;
    }
    setIbeaconData(uuid, major, minor, txPower) {
        const data = [];
        data.push(0x02, 0x15); // fixed data
        const uuidData = this.convertUuid(uuid);
        Array.prototype.push.apply(data, uuidData);
        data.push((major >> 8) & 0xff);
        data.push((major >> 0) & 0xff);
        data.push((minor >> 8) & 0xff);
        data.push((minor >> 0) & 0xff);
        data.push((txPower >> 0) & 0xff);
        this.setManufacturerSpecificData(0x004c, data);
        return;
    }
    extendEvalJson(json) {
        if (json) {
            if (json.flags) {
                if (json.flags.includes("limited_discoverable_mode")) {
                    this.setLeLimitedDiscoverableModeFlag();
                }
                if (json.flags.includes("general_discoverable_mode")) {
                    this.setLeGeneralDiscoverableModeFlag();
                }
                if (json.flags.includes("br_edr_not_supported")) {
                    this.setBrEdrNotSupportedFlag();
                }
                if (json.flags.includes("le_br_edr_controller")) {
                    this.setLeBrEdrControllerFlag();
                }
                if (json.flags.includes("le_br_edr_host")) {
                    this.setLeBrEdrHostFlag();
                }
            }
        }
    }
    setFlags(flag) {
        const data = this.getRow(0x01);
        data[0] = (data[0] || 0) | flag;
        this.setRow(0x01, data);
    }
    setLeLimitedDiscoverableModeFlag() {
        this.setFlags(0x01);
    }
    setLeGeneralDiscoverableModeFlag() {
        this.setFlags(0x02);
    }
    setBrEdrNotSupportedFlag() {
        this.setFlags(0x04);
    }
    setLeBrEdrControllerFlag() {
        this.setFlags(0x08);
    }
    setLeBrEdrHostFlag() {
        this.setFlags(0x10);
    }
}
exports.default = BleAdvertisementBuilder;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGUvYmxlQWR2ZXJ0aXNlbWVudEJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw0REFBb0M7QUFFcEMsTUFBTSx1QkFBdUI7SUFJM0IsWUFBWSxLQUFVLEVBQUUsSUFBUztRQUMvQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUVmLElBQUksSUFBSSxFQUFFO1lBQ1IsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNsQixJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzNDO1lBQ0QsSUFDRSxJQUFJLENBQUMsZ0JBQWdCO2dCQUNyQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVztnQkFDakMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFDMUI7Z0JBQ0EsSUFBSSxDQUFDLDJCQUEyQixDQUM5QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUNqQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUMzQixDQUFDO2FBQ0g7WUFDRCxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7Z0JBQ3JCLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtvQkFDcEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDcEI7YUFDRjtTQUNGO1FBQ0QsSUFBSSxPQUFPLElBQUksQ0FBQyxjQUFjLEtBQUssVUFBVSxFQUFFO1lBQzdDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDM0I7SUFDSCxDQUFDO0lBRU0sTUFBTSxDQUFDLElBQVMsRUFBRSxJQUFTO1FBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQ3pCLENBQUM7SUFFTSxNQUFNLENBQUMsSUFBUztRQUNyQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFTSxLQUFLO1FBQ1YsTUFBTSxJQUFJLEdBQVEsRUFBRSxDQUFDO1FBQ3JCLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtZQUMzQixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDL0IsU0FBUzthQUNWO1lBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ2xEO1FBQ0QsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFBRTtZQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FDZCw0RUFBNEUsQ0FDN0UsQ0FBQztTQUNIO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU0sYUFBYSxDQUFDLElBQVMsRUFBRSxNQUFXO1FBQ3pDLE1BQU0sSUFBSSxHQUFRLEVBQUUsQ0FBQztRQUVyQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN0QyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNqQztRQUVELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFTSxxQkFBcUIsQ0FBQyxJQUFTO1FBQ3BDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFTSxvQkFBb0IsQ0FBQyxJQUFTO1FBQ25DLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFTSwyQkFBMkIsQ0FBQyxXQUFnQixFQUFFLElBQVM7UUFDNUQsTUFBTSxHQUFHLEdBQVEsRUFBRSxDQUFDO1FBQ3BCLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQzdCLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDcEMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRU0sT0FBTyxDQUFDLElBQVM7UUFDdEIsTUFBTSxRQUFRLEdBQWEsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNsRCxJQUFJLElBQVMsQ0FBQztRQUNkLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxFQUFFLEVBQUU7WUFDMUIsSUFBSSxHQUFHLElBQUksQ0FBQztTQUNiO2FBQU0sSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUNoQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1NBRWI7YUFBTSxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ2hDLElBQUksR0FBRyxJQUFJLENBQUM7U0FDYjtRQUNELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFTSxXQUFXLENBQUMsSUFBUztRQUMxQixNQUFNLFdBQVcsR0FBUSxtQkFBUyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwRCxJQUNFLFdBQVcsQ0FBQyxNQUFNLEtBQUssRUFBRTtZQUN6QixXQUFXLENBQUMsTUFBTSxLQUFLLENBQUM7WUFDeEIsV0FBVyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQ3hCO1lBQ0EsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQ2QsNkZBQTZGLENBQzlGLENBQUM7U0FDSDtRQUVELE1BQU0sSUFBSSxHQUFRLEVBQUUsQ0FBQztRQUNyQixLQUFLLElBQUksQ0FBQyxHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzlDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsV0FBVyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ2xFO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU0sY0FBYyxDQUFDLElBQVMsRUFBRSxLQUFVLEVBQUUsS0FBVSxFQUFFLE9BQVk7UUFDbkUsTUFBTSxJQUFJLEdBQVEsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsYUFBYTtRQUVwQyxNQUFNLFFBQVEsR0FBUSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdDLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFM0MsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRWpDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDL0MsT0FBTztJQUNULENBQUM7SUFFTSxjQUFjLENBQUMsSUFBUztRQUM3QixJQUFJLElBQUksRUFBRTtZQUNSLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDZCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLDJCQUEyQixDQUFDLEVBQUU7b0JBQ3BELElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxDQUFDO2lCQUN6QztnQkFDRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLDJCQUEyQixDQUFDLEVBQUU7b0JBQ3BELElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxDQUFDO2lCQUN6QztnQkFDRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLHNCQUFzQixDQUFDLEVBQUU7b0JBQy9DLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO2lCQUNqQztnQkFDRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLHNCQUFzQixDQUFDLEVBQUU7b0JBQy9DLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO2lCQUNqQztnQkFDRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLEVBQUU7b0JBQ3pDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO2lCQUMzQjthQUNGO1NBQ0Y7SUFDSCxDQUFDO0lBRU0sUUFBUSxDQUFDLElBQVM7UUFDdkIsTUFBTSxJQUFJLEdBQVEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFTSxnQ0FBZ0M7UUFDckMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QixDQUFDO0lBRU0sZ0NBQWdDO1FBQ3JDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEIsQ0FBQztJQUVNLHdCQUF3QjtRQUM3QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFTSx3QkFBd0I7UUFDN0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QixDQUFDO0lBRU0sa0JBQWtCO1FBQ3ZCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBRUQsa0JBQWUsdUJBQXVCLENBQUMiLCJmaWxlIjoic3JjL29ibml6L2xpYnMvZW1iZWRzL2JsZS9ibGVBZHZlcnRpc2VtZW50QnVpbGRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCbGVIZWxwZXIgZnJvbSBcIi4vYmxlSGVscGVyXCI7XG5cbmNsYXNzIEJsZUFkdmVydGlzZW1lbnRCdWlsZGVyIHtcbiAgcHVibGljIE9ibml6OiBhbnk7XG4gIHB1YmxpYyByb3dzOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoT2JuaXo6IGFueSwganNvbjogYW55KSB7XG4gICAgdGhpcy5PYm5peiA9IE9ibml6O1xuICAgIHRoaXMucm93cyA9IHt9O1xuXG4gICAgaWYgKGpzb24pIHtcbiAgICAgIGlmIChqc29uLmxvY2FsTmFtZSkge1xuICAgICAgICB0aGlzLnNldENvbXBsZXRlTG9jYWxOYW1lKGpzb24ubG9jYWxOYW1lKTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAganNvbi5tYW51ZmFjdHVyZXJEYXRhICYmXG4gICAgICAgIGpzb24ubWFudWZhY3R1cmVyRGF0YS5jb21wYW55Q29kZSAmJlxuICAgICAgICBqc29uLm1hbnVmYWN0dXJlckRhdGEuZGF0YVxuICAgICAgKSB7XG4gICAgICAgIHRoaXMuc2V0TWFudWZhY3R1cmVyU3BlY2lmaWNEYXRhKFxuICAgICAgICAgIGpzb24ubWFudWZhY3R1cmVyRGF0YS5jb21wYW55Q29kZSxcbiAgICAgICAgICBqc29uLm1hbnVmYWN0dXJlckRhdGEuZGF0YSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChqc29uLnNlcnZpY2VVdWlkcykge1xuICAgICAgICBmb3IgKGNvbnN0IHV1aWQgb2YganNvbi5zZXJ2aWNlVXVpZHMpIHtcbiAgICAgICAgICB0aGlzLnNldFV1aWQodXVpZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHR5cGVvZiB0aGlzLmV4dGVuZEV2YWxKc29uID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIHRoaXMuZXh0ZW5kRXZhbEpzb24oanNvbik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNldFJvdyh0eXBlOiBhbnksIGRhdGE6IGFueSkge1xuICAgIHRoaXMucm93c1t0eXBlXSA9IGRhdGE7XG4gIH1cblxuICBwdWJsaWMgZ2V0Um93KHR5cGU6IGFueSkge1xuICAgIHJldHVybiB0aGlzLnJvd3NbdHlwZV0gfHwgW107XG4gIH1cblxuICBwdWJsaWMgYnVpbGQoKSB7XG4gICAgY29uc3QgZGF0YTogYW55ID0gW107XG4gICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5yb3dzKSB7XG4gICAgICBpZiAodGhpcy5yb3dzW2tleV0ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBkYXRhLnB1c2godGhpcy5yb3dzW2tleV0ubGVuZ3RoICsgMSk7XG4gICAgICBkYXRhLnB1c2gocGFyc2VJbnQoa2V5KSk7XG4gICAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShkYXRhLCB0aGlzLnJvd3Nba2V5XSk7XG4gICAgfVxuICAgIGlmIChkYXRhLmxlbmd0aCA+IDMxKSB7XG4gICAgICB0aGlzLk9ibml6LmVycm9yKFxuICAgICAgICBcIlRvbyBsYXJnZSBkYXRhLiBBZHZlcnRpc2UvU2NhblJlc3BvbnNlIGRhdGEgYXJlIG11c3QgYmUgbGVzcyB0aGFuIDMyIGJ5dGUuXCIsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgcHVibGljIHNldFN0cmluZ0RhdGEodHlwZTogYW55LCBzdHJpbmc6IGFueSkge1xuICAgIGNvbnN0IGRhdGE6IGFueSA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHJpbmcubGVuZ3RoOyBpKyspIHtcbiAgICAgIGRhdGEucHVzaChzdHJpbmcuY2hhckNvZGVBdChpKSk7XG4gICAgfVxuXG4gICAgdGhpcy5zZXRSb3codHlwZSwgZGF0YSk7XG4gIH1cblxuICBwdWJsaWMgc2V0U2hvcnRlbmVkTG9jYWxOYW1lKG5hbWU6IGFueSkge1xuICAgIHRoaXMuc2V0U3RyaW5nRGF0YSgweDA4LCBuYW1lKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRDb21wbGV0ZUxvY2FsTmFtZShuYW1lOiBhbnkpIHtcbiAgICB0aGlzLnNldFN0cmluZ0RhdGEoMHgwOSwgbmFtZSk7XG4gIH1cblxuICBwdWJsaWMgc2V0TWFudWZhY3R1cmVyU3BlY2lmaWNEYXRhKGNvbXBhbnlDb2RlOiBhbnksIGRhdGE6IGFueSkge1xuICAgIGNvbnN0IHJvdzogYW55ID0gW107XG4gICAgcm93LnB1c2goY29tcGFueUNvZGUgJiAweGZmKTtcbiAgICByb3cucHVzaCgoY29tcGFueUNvZGUgPj4gOCkgJiAweGZmKTtcbiAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShyb3csIGRhdGEpO1xuICAgIHRoaXMuc2V0Um93KDB4ZmYsIHJvdyk7XG4gIH1cblxuICBwdWJsaWMgc2V0VXVpZCh1dWlkOiBhbnkpIHtcbiAgICBjb25zdCB1dWlkRGF0YTogbnVtYmVyW10gPSB0aGlzLmNvbnZlcnRVdWlkKHV1aWQpO1xuICAgIGxldCB0eXBlOiBhbnk7XG4gICAgaWYgKHV1aWREYXRhLmxlbmd0aCA9PT0gMTYpIHtcbiAgICAgIHR5cGUgPSAweDA2O1xuICAgIH0gZWxzZSBpZiAodXVpZERhdGEubGVuZ3RoID09PSA0KSB7XG4gICAgICB0eXBlID0gMHgwNDtcblxuICAgIH0gZWxzZSBpZiAodXVpZERhdGEubGVuZ3RoID09PSAyKSB7XG4gICAgICB0eXBlID0gMHgwMjtcbiAgICB9XG4gICAgdGhpcy5zZXRSb3codHlwZSwgdXVpZERhdGEpO1xuICB9XG5cbiAgcHVibGljIGNvbnZlcnRVdWlkKHV1aWQ6IGFueSk6IG51bWJlcltdIHtcbiAgICBjb25zdCB1dWlkTnVtZXJpYzogYW55ID0gQmxlSGVscGVyLnV1aWRGaWx0ZXIodXVpZCk7XG4gICAgaWYgKFxuICAgICAgdXVpZE51bWVyaWMubGVuZ3RoICE9PSAzMiAmJlxuICAgICAgdXVpZE51bWVyaWMubGVuZ3RoICE9PSA4ICYmXG4gICAgICB1dWlkTnVtZXJpYy5sZW5ndGggIT09IDRcbiAgICApIHtcbiAgICAgIHRoaXMuT2JuaXouZXJyb3IoXG4gICAgICAgIFwiQkxFIHV1aWQgbXVzdCBiZSAxNi8zMi8xMjggYml0IC4gKGV4YW1wbGU6IGMyOGYwYWQ1LWE3ZmQtNDhiZS05ZmQwLWVhZTlmZmQzYThiYiBmb3IgMTI4Yml0KVwiLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBkYXRhOiBhbnkgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gdXVpZE51bWVyaWMubGVuZ3RoOyBpID4gMTsgaSAtPSAyKSB7XG4gICAgICBkYXRhLnB1c2gocGFyc2VJbnQodXVpZE51bWVyaWNbaSAtIDJdICsgdXVpZE51bWVyaWNbaSAtIDFdLCAxNikpO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRJYmVhY29uRGF0YSh1dWlkOiBhbnksIG1ham9yOiBhbnksIG1pbm9yOiBhbnksIHR4UG93ZXI6IGFueSkge1xuICAgIGNvbnN0IGRhdGE6IGFueSA9IFtdO1xuICAgIGRhdGEucHVzaCgweDAyLCAweDE1KTsgLy8gZml4ZWQgZGF0YVxuXG4gICAgY29uc3QgdXVpZERhdGE6IGFueSA9IHRoaXMuY29udmVydFV1aWQodXVpZCk7XG4gICAgQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkoZGF0YSwgdXVpZERhdGEpO1xuXG4gICAgZGF0YS5wdXNoKChtYWpvciA+PiA4KSAmIDB4ZmYpO1xuICAgIGRhdGEucHVzaCgobWFqb3IgPj4gMCkgJiAweGZmKTtcbiAgICBkYXRhLnB1c2goKG1pbm9yID4+IDgpICYgMHhmZik7XG4gICAgZGF0YS5wdXNoKChtaW5vciA+PiAwKSAmIDB4ZmYpO1xuICAgIGRhdGEucHVzaCgodHhQb3dlciA+PiAwKSAmIDB4ZmYpO1xuXG4gICAgdGhpcy5zZXRNYW51ZmFjdHVyZXJTcGVjaWZpY0RhdGEoMHgwMDRjLCBkYXRhKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBwdWJsaWMgZXh0ZW5kRXZhbEpzb24oanNvbjogYW55KSB7XG4gICAgaWYgKGpzb24pIHtcbiAgICAgIGlmIChqc29uLmZsYWdzKSB7XG4gICAgICAgIGlmIChqc29uLmZsYWdzLmluY2x1ZGVzKFwibGltaXRlZF9kaXNjb3ZlcmFibGVfbW9kZVwiKSkge1xuICAgICAgICAgIHRoaXMuc2V0TGVMaW1pdGVkRGlzY292ZXJhYmxlTW9kZUZsYWcoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoanNvbi5mbGFncy5pbmNsdWRlcyhcImdlbmVyYWxfZGlzY292ZXJhYmxlX21vZGVcIikpIHtcbiAgICAgICAgICB0aGlzLnNldExlR2VuZXJhbERpc2NvdmVyYWJsZU1vZGVGbGFnKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGpzb24uZmxhZ3MuaW5jbHVkZXMoXCJicl9lZHJfbm90X3N1cHBvcnRlZFwiKSkge1xuICAgICAgICAgIHRoaXMuc2V0QnJFZHJOb3RTdXBwb3J0ZWRGbGFnKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGpzb24uZmxhZ3MuaW5jbHVkZXMoXCJsZV9icl9lZHJfY29udHJvbGxlclwiKSkge1xuICAgICAgICAgIHRoaXMuc2V0TGVCckVkckNvbnRyb2xsZXJGbGFnKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGpzb24uZmxhZ3MuaW5jbHVkZXMoXCJsZV9icl9lZHJfaG9zdFwiKSkge1xuICAgICAgICAgIHRoaXMuc2V0TGVCckVkckhvc3RGbGFnKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2V0RmxhZ3MoZmxhZzogYW55KSB7XG4gICAgY29uc3QgZGF0YTogYW55ID0gdGhpcy5nZXRSb3coMHgwMSk7XG4gICAgZGF0YVswXSA9IChkYXRhWzBdIHx8IDApIHwgZmxhZztcbiAgICB0aGlzLnNldFJvdygweDAxLCBkYXRhKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRMZUxpbWl0ZWREaXNjb3ZlcmFibGVNb2RlRmxhZygpIHtcbiAgICB0aGlzLnNldEZsYWdzKDB4MDEpO1xuICB9XG5cbiAgcHVibGljIHNldExlR2VuZXJhbERpc2NvdmVyYWJsZU1vZGVGbGFnKCkge1xuICAgIHRoaXMuc2V0RmxhZ3MoMHgwMik7XG4gIH1cblxuICBwdWJsaWMgc2V0QnJFZHJOb3RTdXBwb3J0ZWRGbGFnKCkge1xuICAgIHRoaXMuc2V0RmxhZ3MoMHgwNCk7XG4gIH1cblxuICBwdWJsaWMgc2V0TGVCckVkckNvbnRyb2xsZXJGbGFnKCkge1xuICAgIHRoaXMuc2V0RmxhZ3MoMHgwOCk7XG4gIH1cblxuICBwdWJsaWMgc2V0TGVCckVkckhvc3RGbGFnKCkge1xuICAgIHRoaXMuc2V0RmxhZ3MoMHgxMCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQmxlQWR2ZXJ0aXNlbWVudEJ1aWxkZXI7XG4iXX0=

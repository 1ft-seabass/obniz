"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// var debug = require('debug')('bindings');
const debug = () => {
};
const events = require("events");
const os = require("os");
const AclStream = require("./acl-stream");
const Gap = require("./gap");
const Gatt = require("./gatt");
class BlenoBindings extends events.EventEmitter {
    constructor(hciProtocol) {
        super();
        this._state = null;
        this._advertising = false;
        this._hci = hciProtocol;
        this._gap = new Gap(this._hci);
        this._gatt = new Gatt(this._hci);
        this._address = null;
        this._handle = null;
        this._aclStream = null;
    }
    startAdvertising(name, serviceUuids) {
        this._advertising = true;
        this._gap.startAdvertising(name, serviceUuids);
    }
    startAdvertisingIBeacon(data) {
        this._advertising = true;
        this._gap.startAdvertisingIBeacon(data);
    }
    startAdvertisingWithEIRData(advertisementData, scanData) {
        this._advertising = true;
        this._gap.startAdvertisingWithEIRData(advertisementData, scanData);
    }
    stopAdvertising() {
        this._advertising = false;
        this._gap.stopAdvertising();
    }
    setServices(services) {
        this._gatt.setServices(services);
        this.emit("servicesSet");
    }
    disconnect() {
        if (this._handle) {
            debug("disconnect by server");
            this._hci.disconnect(this._handle);
        }
    }
    updateRssi() {
        if (this._handle) {
            this._hci.readRssi(this._handle);
        }
    }
    init() {
        this._gap.on("advertisingStart", this.onAdvertisingStart.bind(this));
        this._gap.on("advertisingStop", this.onAdvertisingStop.bind(this));
        this._gatt.on("mtuChange", this.onMtuChange.bind(this));
        this._hci.on("stateChange", this.onStateChange.bind(this));
        this._hci.on("addressChange", this.onAddressChange.bind(this));
        this._hci.on("readLocalVersion", this.onReadLocalVersion.bind(this));
        this._hci.on("leConnComplete", this.onLeConnComplete.bind(this));
        this._hci.on("leConnUpdateComplete", this.onLeConnUpdateComplete.bind(this));
        this._hci.on("rssiRead", this.onRssiRead.bind(this));
        this._hci.on("disconnComplete", this.onDisconnComplete.bind(this));
        this._hci.on("encryptChange", this.onEncryptChange.bind(this));
        this._hci.on("leLtkNegReply", this.onLeLtkNegReply.bind(this));
        this._hci.on("aclDataPkt", this.onAclDataPkt.bind(this));
        this.emit("platform", os.platform());
    }
    onStateChange(state) {
        if (this._state === state) {
            return;
        }
        this._state = state;
        if (state === "unauthorized") {
            console.log("bleno warning: adapter state unauthorized, please run as root or with sudo");
            console.log("               or see README for information on running without root/sudo:");
            console.log("               https://github.com/sandeepmistry/bleno#running-on-linux");
        }
        else if (state === "unsupported") {
            console.log("bleno warning: adapter does not support Bluetooth Low Energy (BLE, Bluetooth Smart).");
            console.log("               Try to run with environment variable:");
            console.log("               [sudo] BLENO_HCI_DEVICE_ID=x node ...");
        }
        this.emit("stateChange", state);
    }
    onAddressChange(address) {
        this.emit("addressChange", address);
    }
    onReadLocalVersion(hciVer, hciRev, lmpVer, manufacturer, lmpSubVer) {
    }
    onAdvertisingStart(error) {
        this.emit("advertisingStart", error);
    }
    onAdvertisingStop() {
        this.emit("advertisingStop");
    }
    onLeConnComplete(status, handle, role, addressType, address, interval, latency, supervisionTimeout, masterClockAccuracy) {
        if (role !== 1) {
            // not slave, ignore
            return;
        }
        this._address = address;
        this._handle = handle;
        this._aclStream = new AclStream(this._hci, handle, this._hci.addressType, this._hci.address, addressType, address);
        this._gatt.setAclStream(this._aclStream);
        this.emit("accept", address);
    }
    onLeConnUpdateComplete(handle, interval, latency, supervisionTimeout) {
        // no-op
    }
    onDisconnComplete(handle, reason) {
        if (this._handle !== handle) {
            return; // not peripheral
        }
        if (this._aclStream) {
            this._aclStream.push(null, null);
        }
        const address = this._address;
        this._address = null;
        this._handle = null;
        this._aclStream = null;
        if (address) {
            this.emit("disconnect", address); // TODO: use reason
        }
        if (this._advertising) {
            this._gap.restartAdvertising();
        }
    }
    onEncryptChange(handle, encrypt) {
        if (this._handle === handle && this._aclStream) {
            this._aclStream.pushEncrypt(encrypt);
        }
    }
    onLeLtkNegReply(handle) {
        if (this._handle === handle && this._aclStream) {
            this._aclStream.pushLtkNegReply();
        }
    }
    onMtuChange(mtu) {
        this.emit("mtuChange", mtu);
    }
    onRssiRead(handle, rssi) {
        this.emit("rssiUpdate", rssi);
    }
    onAclDataPkt(handle, cid, data) {
        if (this._handle === handle && this._aclStream) {
            this._aclStream.push(cid, data);
        }
    }
}
exports.default = BlenoBindings;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvcHJvdG9jb2wvcGVyaXBoZXJhbC9iaW5kaW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDRDQUE0QztBQUM1QyxNQUFNLEtBQUssR0FBUSxHQUFHLEVBQUU7QUFDeEIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxNQUFNLEdBQVEsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3RDLE1BQU0sRUFBRSxHQUFRLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUU5QixNQUFNLFNBQVMsR0FBUSxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFFL0MsTUFBTSxHQUFHLEdBQVEsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ2xDLE1BQU0sSUFBSSxHQUFRLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUVwQyxNQUFNLGFBQWMsU0FBUSxNQUFNLENBQUMsWUFBWTtJQVc3QyxZQUFZLFdBQWdCO1FBQzFCLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7UUFFbkIsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7UUFFMUIsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUM7UUFDeEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0IsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFakMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7SUFDekIsQ0FBQztJQUVNLGdCQUFnQixDQUFDLElBQVMsRUFBRSxZQUFpQjtRQUNsRCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUks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Q0FBQztJQUVNLFVBQVUsQ0FBQyxNQUFXLEVBQUUsSUFBVTtRQUN2QyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRU0sWUFBWSxDQUFDLE1BQVcsRUFBRSxHQUFTLEVBQUUsSUFBVTtRQUNwRCxJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssTUFBTSxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDOUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztDQUNGO0FBRUQsa0JBQWUsYUFBYSxDQUFDIiwiZmlsZSI6InNyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvcHJvdG9jb2wvcGVyaXBoZXJhbC9iaW5kaW5ncy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHZhciBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJykoJ2JpbmRpbmdzJyk7XG5jb25zdCBkZWJ1ZzogYW55ID0gKCkgPT4ge1xufTtcblxuY29uc3QgZXZlbnRzOiBhbnkgPSByZXF1aXJlKFwiZXZlbnRzXCIpO1xuY29uc3Qgb3M6IGFueSA9IHJlcXVpcmUoXCJvc1wiKTtcblxuY29uc3QgQWNsU3RyZWFtOiBhbnkgPSByZXF1aXJlKFwiLi9hY2wtc3RyZWFtXCIpO1xuXG5jb25zdCBHYXA6IGFueSA9IHJlcXVpcmUoXCIuL2dhcFwiKTtcbmNvbnN0IEdhdHQ6IGFueSA9IHJlcXVpcmUoXCIuL2dhdHRcIik7XG5cbmNsYXNzIEJsZW5vQmluZGluZ3MgZXh0ZW5kcyBldmVudHMuRXZlbnRFbWl0dGVyIHtcbiAgcHVibGljIF9zdGF0ZTogYW55O1xuICBwdWJsaWMgX2FkdmVydGlzaW5nOiBhbnk7XG4gIHB1YmxpYyBfaGNpOiBhbnk7XG4gIHB1YmxpYyBfZ2FwOiBhbnk7XG4gIHB1YmxpYyBfZ2F0dDogYW55O1xuICBwdWJsaWMgX2FkZHJlc3M6IGFueTtcbiAgcHVibGljIF9oYW5kbGU6IGFueTtcbiAgcHVibGljIF9hY2xTdHJlYW06IGFueTtcbiAgcHVibGljIGVtaXQ6IGFueTtcblxuICBjb25zdHJ1Y3RvcihoY2lQcm90b2NvbDogYW55KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9zdGF0ZSA9IG51bGw7XG5cbiAgICB0aGlzLl9hZHZlcnRpc2luZyA9IGZhbHNlO1xuXG4gICAgdGhpcy5faGNpID0gaGNpUHJvdG9jb2w7XG4gICAgdGhpcy5fZ2FwID0gbmV3IEdhcCh0aGlzLl9oY2kpO1xuICAgIHRoaXMuX2dhdHQgPSBuZXcgR2F0dCh0aGlzLl9oY2kpO1xuXG4gICAgdGhpcy5fYWRkcmVzcyA9IG51bGw7XG4gICAgdGhpcy5faGFuZGxlID0gbnVsbDtcbiAgICB0aGlzLl9hY2xTdHJlYW0gPSBudWxsO1xuICB9XG5cbiAgcHVibGljIHN0YXJ0QWR2ZXJ0aXNpbmcobmFtZTogYW55LCBzZXJ2aWNlVXVpZHM6IGFueSkge1xuICAgIHRoaXMuX2FkdmVydGlzaW5nID0gdHJ1ZTtcblxuICAgIHRoaXMuX2dhcC5zdGFydEFkdmVydGlzaW5nKG5hbWUsIHNlcnZpY2VVdWlkcyk7XG4gIH1cblxuICBwdWJsaWMgc3RhcnRBZHZlcnRpc2luZ0lCZWFjb24oZGF0YTogYW55KSB7XG4gICAgdGhpcy5fYWR2ZXJ0aXNpbmcgPSB0cnVlO1xuXG4gICAgdGhpcy5fZ2FwLnN0YXJ0QWR2ZXJ0aXNpbmdJQmVhY29uKGRhdGEpO1xuICB9XG5cbiAgcHVibGljIHN0YXJ0QWR2ZXJ0aXNpbmdXaXRoRUlSRGF0YShhZHZlcnRpc2VtZW50RGF0YTogYW55LCBzY2FuRGF0YTogYW55KSB7XG4gICAgdGhpcy5fYWR2ZXJ0aXNpbmcgPSB0cnVlO1xuXG4gICAgdGhpcy5fZ2FwLnN0YXJ0QWR2ZXJ0aXNpbmdXaXRoRUlSRGF0YShhZHZlcnRpc2VtZW50RGF0YSwgc2NhbkRhdGEpO1xuICB9XG5cbiAgcHVibGljIHN0b3BBZHZlcnRpc2luZygpIHtcbiAgICB0aGlzLl9hZHZlcnRpc2luZyA9IGZhbHNlO1xuXG4gICAgdGhpcy5fZ2FwLnN0b3BBZHZlcnRpc2luZygpO1xuICB9XG5cbiAgcHVibGljIHNldFNlcnZpY2VzKHNlcnZpY2VzOiBhbnkpIHtcbiAgICB0aGlzLl9nYXR0LnNldFNlcnZpY2VzKHNlcnZpY2VzKTtcblxuICAgIHRoaXMuZW1pdChcInNlcnZpY2VzU2V0XCIpO1xuICB9XG5cbiAgcHVibGljIGRpc2Nvbm5lY3QoKSB7XG4gICAgaWYgKHRoaXMuX2hhbmRsZSkge1xuICAgICAgZGVidWcoXCJkaXNjb25uZWN0IGJ5IHNlcnZlclwiKTtcblxuICAgICAgdGhpcy5faGNpLmRpc2Nvbm5lY3QodGhpcy5faGFuZGxlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlUnNzaSgpIHtcbiAgICBpZiAodGhpcy5faGFuZGxlKSB7XG4gICAgICB0aGlzLl9oY2kucmVhZFJzc2kodGhpcy5faGFuZGxlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgaW5pdCgpIHtcbiAgICB0aGlzLl9nYXAub24oXCJhZHZlcnRpc2luZ1N0YXJ0XCIsIHRoaXMub25BZHZlcnRpc2luZ1N0YXJ0LmJpbmQodGhpcykpO1xuICAgIHRoaXMuX2dhcC5vbihcImFkdmVydGlzaW5nU3RvcFwiLCB0aGlzLm9uQWR2ZXJ0aXNpbmdTdG9wLmJpbmQodGhpcykpO1xuXG4gICAgdGhpcy5fZ2F0dC5vbihcIm10dUNoYW5nZVwiLCB0aGlzLm9uTXR1Q2hhbmdlLmJpbmQodGhpcykpO1xuXG4gICAgdGhpcy5faGNpLm9uKFwic3RhdGVDaGFuZ2VcIiwgdGhpcy5vblN0YXRlQ2hhbmdlLmJpbmQodGhpcykpO1xuICAgIHRoaXMuX2hjaS5vbihcImFkZHJlc3NDaGFuZ2VcIiwgdGhpcy5vbkFkZHJlc3NDaGFuZ2UuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5faGNpLm9uKFwicmVhZExvY2FsVmVyc2lvblwiLCB0aGlzLm9uUmVhZExvY2FsVmVyc2lvbi5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMuX2hjaS5vbihcImxlQ29ubkNvbXBsZXRlXCIsIHRoaXMub25MZUNvbm5Db21wbGV0ZS5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLl9oY2kub24oXG4gICAgICBcImxlQ29ublVwZGF0ZUNvbXBsZXRlXCIsXG4gICAgICB0aGlzLm9uTGVDb25uVXBkYXRlQ29tcGxldGUuYmluZCh0aGlzKSxcbiAgICApO1xuICAgIHRoaXMuX2hjaS5vbihcInJzc2lSZWFkXCIsIHRoaXMub25Sc3NpUmVhZC5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLl9oY2kub24oXCJkaXNjb25uQ29tcGxldGVcIiwgdGhpcy5vbkRpc2Nvbm5Db21wbGV0ZS5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLl9oY2kub24oXCJlbmNyeXB0Q2hhbmdlXCIsIHRoaXMub25FbmNyeXB0Q2hhbmdlLmJpbmQodGhpcykpO1xuICAgIHRoaXMuX2hjaS5vbihcImxlTHRrTmVnUmVwbHlcIiwgdGhpcy5vbkxlTHRrTmVnUmVwbHkuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5faGNpLm9uKFwiYWNsRGF0YVBrdFwiLCB0aGlzLm9uQWNsRGF0YVBrdC5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMuZW1pdChcInBsYXRmb3JtXCIsIG9zLnBsYXRmb3JtKCkpO1xuICB9XG5cbiAgcHVibGljIG9uU3RhdGVDaGFuZ2Uoc3RhdGU6IGFueSkge1xuICAgIGlmICh0aGlzLl9zdGF0ZSA9PT0gc3RhdGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fc3RhdGUgPSBzdGF0ZTtcblxuICAgIGlmIChzdGF0ZSA9PT0gXCJ1bmF1dGhvcml6ZWRcIikge1xuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgIFwiYmxlbm8gd2FybmluZzogYWRhcHRlciBzdGF0ZSB1bmF1dGhvcml6ZWQsIHBsZWFzZSBydW4gYXMgcm9vdCBvciB3aXRoIHN1ZG9cIixcbiAgICAgICk7XG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgXCIgICAgICAgICAgICAgICBvciBzZWUgUkVBRE1FIGZvciBpbmZvcm1hdGlvbiBvbiBydW5uaW5nIHdpdGhvdXQgcm9vdC9zdWRvOlwiLFxuICAgICAgKTtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBcIiAgICAgICAgICAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9zYW5kZWVwbWlzdHJ5L2JsZW5vI3J1bm5pbmctb24tbGludXhcIixcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gXCJ1bnN1cHBvcnRlZFwiKSB7XG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgXCJibGVubyB3YXJuaW5nOiBhZGFwdGVyIGRvZXMgbm90IHN1cHBvcnQgQmx1ZXRvb3RoIExvdyBFbmVyZ3kgKEJMRSwgQmx1ZXRvb3RoIFNtYXJ0KS5cIixcbiAgICAgICk7XG4gICAgICBjb25zb2xlLmxvZyhcIiAgICAgICAgICAgICAgIFRyeSB0byBydW4gd2l0aCBlbnZpcm9ubWVudCB2YXJpYWJsZTpcIik7XG4gICAgICBjb25zb2xlLmxvZyhcIiAgICAgICAgICAgICAgIFtzdWRvXSBCTEVOT19IQ0lfREVWSUNFX0lEPXggbm9kZSAuLi5cIik7XG4gICAgfVxuXG4gICAgdGhpcy5lbWl0KFwic3RhdGVDaGFuZ2VcIiwgc3RhdGUpO1xuICB9XG5cbiAgcHVibGljIG9uQWRkcmVzc0NoYW5nZShhZGRyZXNzOiBhbnkpIHtcbiAgICB0aGlzLmVtaXQoXCJhZGRyZXNzQ2hhbmdlXCIsIGFkZHJlc3MpO1xuICB9XG5cbiAgcHVibGljIG9uUmVhZExvY2FsVmVyc2lvbihoY2lWZXI6IGFueSwgaGNpUmV2PzogYW55LCBsbXBWZXI/OiBhbnksIG1hbnVmYWN0dXJlcj86IGFueSwgbG1wU3ViVmVyPzogYW55KSB7XG4gIH1cblxuICBwdWJsaWMgb25BZHZlcnRpc2luZ1N0YXJ0KGVycm9yOiBhbnkpIHtcbiAgICB0aGlzLmVtaXQoXCJhZHZlcnRpc2luZ1N0YXJ0XCIsIGVycm9yKTtcbiAgfVxuXG4gIHB1YmxpYyBvbkFkdmVydGlzaW5nU3RvcCgpIHtcbiAgICB0aGlzLmVtaXQoXCJhZHZlcnRpc2luZ1N0b3BcIik7XG4gIH1cblxuICBwdWJsaWMgb25MZUNvbm5Db21wbGV0ZShcbiAgICBzdGF0dXM6IGFueSxcbiAgICBoYW5kbGU/OiBhbnksXG4gICAgcm9sZT86IGFueSxcbiAgICBhZGRyZXNzVHlwZT86IGFueSxcbiAgICBhZGRyZXNzPzogYW55LFxuICAgIGludGVydmFsPzogYW55LFxuICAgIGxhdGVuY3k/OiBhbnksXG4gICAgc3VwZXJ2aXNpb25UaW1lb3V0PzogYW55LFxuICAgIG1hc3RlckNsb2NrQWNjdXJhY3k/OiBhbnksXG4gICkge1xuICAgIGlmIChyb2xlICE9PSAxKSB7XG4gICAgICAvLyBub3Qgc2xhdmUsIGlnbm9yZVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuX2FkZHJlc3MgPSBhZGRyZXNzO1xuICAgIHRoaXMuX2hhbmRsZSA9IGhhbmRsZTtcbiAgICB0aGlzLl9hY2xTdHJlYW0gPSBuZXcgQWNsU3RyZWFtKFxuICAgICAgdGhpcy5faGNpLFxuICAgICAgaGFuZGxlLFxuICAgICAgdGhpcy5faGNpLmFkZHJlc3NUeXBlLFxuICAgICAgdGhpcy5faGNpLmFkZHJlc3MsXG4gICAgICBhZGRyZXNzVHlwZSxcbiAgICAgIGFkZHJlc3MsXG4gICAgKTtcbiAgICB0aGlzLl9nYXR0LnNldEFjbFN0cmVhbSh0aGlzLl9hY2xTdHJlYW0pO1xuXG4gICAgdGhpcy5lbWl0KFwiYWNjZXB0XCIsIGFkZHJlc3MpO1xuICB9XG5cbiAgcHVibGljIG9uTGVDb25uVXBkYXRlQ29tcGxldGUoaGFuZGxlOiBhbnksIGludGVydmFsPzogYW55LCBsYXRlbmN5PzogYW55LCBzdXBlcnZpc2lvblRpbWVvdXQ/OiBhbnkpIHtcbiAgICAvLyBuby1vcFxuICB9XG5cbiAgcHVibGljIG9uRGlzY29ubkNvbXBsZXRlKGhhbmRsZTogYW55LCByZWFzb24/OiBhbnkpIHtcbiAgICBpZiAodGhpcy5faGFuZGxlICE9PSBoYW5kbGUpIHtcbiAgICAgIHJldHVybjsgLy8gbm90IHBlcmlwaGVyYWxcbiAgICB9XG4gICAgaWYgKHRoaXMuX2FjbFN0cmVhbSkge1xuICAgICAgdGhpcy5fYWNsU3RyZWFtLnB1c2gobnVsbCwgbnVsbCk7XG4gICAgfVxuXG4gICAgY29uc3QgYWRkcmVzczogYW55ID0gdGhpcy5fYWRkcmVzcztcblxuICAgIHRoaXMuX2FkZHJlc3MgPSBudWxsO1xuICAgIHRoaXMuX2hhbmRsZSA9IG51bGw7XG4gICAgdGhpcy5fYWNsU3RyZWFtID0gbnVsbDtcblxuICAgIGlmIChhZGRyZXNzKSB7XG4gICAgICB0aGlzLmVtaXQoXCJkaXNjb25uZWN0XCIsIGFkZHJlc3MpOyAvLyBUT0RPOiB1c2UgcmVhc29uXG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX2FkdmVydGlzaW5nKSB7XG4gICAgICB0aGlzLl9nYXAucmVzdGFydEFkdmVydGlzaW5nKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIG9uRW5jcnlwdENoYW5nZShoYW5kbGU6IGFueSwgZW5jcnlwdD86IGFueSkge1xuICAgIGlmICh0aGlzLl9oYW5kbGUgPT09IGhhbmRsZSAmJiB0aGlzLl9hY2xTdHJlYW0pIHtcbiAgICAgIHRoaXMuX2FjbFN0cmVhbS5wdXNoRW5jcnlwdChlbmNyeXB0KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgb25MZUx0a05lZ1JlcGx5KGhhbmRsZTogYW55KSB7XG4gICAgaWYgKHRoaXMuX2hhbmRsZSA9PT0gaGFuZGxlICYmIHRoaXMuX2FjbFN0cmVhbSkge1xuICAgICAgdGhpcy5fYWNsU3RyZWFtLnB1c2hMdGtOZWdSZXBseSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvbk10dUNoYW5nZShtdHU6IGFueSkge1xuICAgIHRoaXMuZW1pdChcIm10dUNoYW5nZVwiLCBtdHUpO1xuICB9XG5cbiAgcHVibGljIG9uUnNzaVJlYWQoaGFuZGxlOiBhbnksIHJzc2k/OiBhbnkpIHtcbiAgICB0aGlzLmVtaXQoXCJyc3NpVXBkYXRlXCIsIHJzc2kpO1xuICB9XG5cbiAgcHVibGljIG9uQWNsRGF0YVBrdChoYW5kbGU6IGFueSwgY2lkPzogYW55LCBkYXRhPzogYW55KSB7XG4gICAgaWYgKHRoaXMuX2hhbmRsZSA9PT0gaGFuZGxlICYmIHRoaXMuX2FjbFN0cmVhbSkge1xuICAgICAgdGhpcy5fYWNsU3RyZWFtLnB1c2goY2lkLCBkYXRhKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQmxlbm9CaW5kaW5ncztcbiJdfQ==

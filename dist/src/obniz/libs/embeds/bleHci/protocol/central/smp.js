"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const events = require("events");
const crypto = require("./crypto");
const SMP_CID = 0x0006;
const SMP_PAIRING_REQUEST = 0x01;
const SMP_PAIRING_RESPONSE = 0x02;
const SMP_PAIRING_CONFIRM = 0x03;
const SMP_PAIRING_RANDOM = 0x04;
const SMP_PAIRING_FAILED = 0x05;
const SMP_ENCRYPT_INFO = 0x06;
const SMP_MASTER_IDENT = 0x07;
class Smp extends events.EventEmitter {
    constructor(aclStream, localAddressType, localAddress, remoteAddressType, remoteAddress) {
        super();
        this._aclStream = aclStream;
        this._iat = Buffer.from([localAddressType === "random" ? 0x01 : 0x00]);
        this._ia = Buffer.from(localAddress
            .split(":")
            .reverse()
            .join(""), "hex");
        this._rat = Buffer.from([remoteAddressType === "random" ? 0x01 : 0x00]);
        this._ra = Buffer.from(remoteAddress
            .split(":")
            .reverse()
            .join(""), "hex");
        this.onAclStreamDataBinded = this.onAclStreamData.bind(this);
        this.onAclStreamEndBinded = this.onAclStreamEnd.bind(this);
        this._aclStream.on("data", this.onAclStreamDataBinded);
        this._aclStream.on("end", this.onAclStreamEndBinded);
    }
    sendPairingRequest() {
        this._preq = Buffer.from([
            SMP_PAIRING_REQUEST,
            0x03,
            0x00,
            0x01,
            0x10,
            0x00,
            0x01,
        ]);
        this.write(this._preq);
    }
    onAclStreamData(cid, data) {
        if (cid !== SMP_CID) {
            return;
        }
        const code = data.readUInt8(0);
        if (SMP_PAIRING_RESPONSE === code) {
            this.handlePairingResponse(data);
        }
        else if (SMP_PAIRING_CONFIRM === code) {
            this.handlePairingConfirm(data);
        }
        else if (SMP_PAIRING_RANDOM === code) {
            this.handlePairingRandom(data);
        }
        else if (SMP_PAIRING_FAILED === code) {
            this.handlePairingFailed(data);
        }
        else if (SMP_ENCRYPT_INFO === code) {
            this.handleEncryptInfo(data);
        }
        else if (SMP_MASTER_IDENT === code) {
            this.handleMasterIdent(data);
        }
    }
    onAclStreamEnd() {
        this._aclStream.removeListener("data", this.onAclStreamDataBinded);
        this._aclStream.removeListener("end", this.onAclStreamEndBinded);
        this.emit("end");
    }
    handlePairingResponse(data) {
        this._pres = data;
        this._tk = Buffer.from("00000000000000000000000000000000", "hex");
        this._r = crypto.r();
        this.write(Buffer.concat([
            Buffer.from([SMP_PAIRING_CONFIRM]),
            crypto.c1(this._tk, this._r, this._pres, this._preq, this._iat, this._ia, this._rat, this._ra),
        ]));
    }
    handlePairingConfirm(data) {
        this._pcnf = data;
        this.write(Buffer.concat([Buffer.from([SMP_PAIRING_RANDOM]), this._r]));
    }
    handlePairingRandom(data) {
        const r = data.slice(1);
        const pcnf = Buffer.concat([
            Buffer.from([SMP_PAIRING_CONFIRM]),
            crypto.c1(this._tk, r, this._pres, this._preq, this._iat, this._ia, this._rat, this._ra),
        ]);
        if (this._pcnf.toString("hex") === pcnf.toString("hex")) {
            const stk = crypto.s1(this._tk, r, this._r);
            this.emit("stk", stk);
        }
        else {
            this.write(Buffer.from([SMP_PAIRING_RANDOM, SMP_PAIRING_CONFIRM]));
            this.emit("fail");
        }
    }
    handlePairingFailed(data) {
        this.emit("fail");
    }
    handleEncryptInfo(data) {
        const ltk = data.slice(1);
        this.emit("ltk", ltk);
    }
    handleMasterIdent(data) {
        const ediv = data.slice(1, 3);
        const rand = data.slice(3);
        this.emit("masterIdent", ediv, rand);
    }
    write(data) {
        this._aclStream.write(SMP_CID, data);
    }
}
exports.default = Smp;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvcHJvdG9jb2wvY2VudHJhbC9zbXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNLE1BQU0sR0FBUSxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFFdEMsTUFBTSxNQUFNLEdBQVEsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBRXhDLE1BQU0sT0FBTyxHQUFRLE1BQU0sQ0FBQztBQUU1QixNQUFNLG1CQUFtQixHQUFRLElBQUksQ0FBQztBQUN0QyxNQUFNLG9CQUFvQixHQUFRLElBQUksQ0FBQztBQUN2QyxNQUFNLG1CQUFtQixHQUFRLElBQUksQ0FBQztBQUN0QyxNQUFNLGtCQUFrQixHQUFRLElBQUksQ0FBQztBQUNyQyxNQUFNLGtCQUFrQixHQUFRLElBQUksQ0FBQztBQUNyQyxNQUFNLGdCQUFnQixHQUFRLElBQUksQ0FBQztBQUNuQyxNQUFNLGdCQUFnQixHQUFRLElBQUksQ0FBQztBQUVuQyxNQUFNLEdBQUksU0FBUSxNQUFNLENBQUMsWUFBWTtJQWVuQyxZQUNFLFNBQWMsRUFDZCxnQkFBcUIsRUFDckIsWUFBaUIsRUFDakIsaUJBQXNCLEVBQ3RCLGFBQWtCO1FBRWxCLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7UUFFNUIsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsZ0JBQWdCLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDdkUsSUFBSSxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUNwQixZQUFZO2FBQ1QsS0FBSyxDQUFDLEdBQUcsQ0FBQzthQUNWLE9BQU8sRUFBRTthQUNULElBQUksQ0FBQyxFQUFFLENBQUMsRUFDWCxLQUFLLENBQ04sQ0FBQztRQUNGLElBQUksQ0FBQyxJQUFJLEdB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L2VtYmVkcy9ibGVIY2kvcHJvdG9jb2wvY2VudHJhbC9zbXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBldmVudHM6IGFueSA9IHJlcXVpcmUoXCJldmVudHNcIik7XG5cbmNvbnN0IGNyeXB0bzogYW55ID0gcmVxdWlyZShcIi4vY3J5cHRvXCIpO1xuXG5jb25zdCBTTVBfQ0lEOiBhbnkgPSAweDAwMDY7XG5cbmNvbnN0IFNNUF9QQUlSSU5HX1JFUVVFU1Q6IGFueSA9IDB4MDE7XG5jb25zdCBTTVBfUEFJUklOR19SRVNQT05TRTogYW55ID0gMHgwMjtcbmNvbnN0IFNNUF9QQUlSSU5HX0NPTkZJUk06IGFueSA9IDB4MDM7XG5jb25zdCBTTVBfUEFJUklOR19SQU5ET006IGFueSA9IDB4MDQ7XG5jb25zdCBTTVBfUEFJUklOR19GQUlMRUQ6IGFueSA9IDB4MDU7XG5jb25zdCBTTVBfRU5DUllQVF9JTkZPOiBhbnkgPSAweDA2O1xuY29uc3QgU01QX01BU1RFUl9JREVOVDogYW55ID0gMHgwNztcblxuY2xhc3MgU21wIGV4dGVuZHMgZXZlbnRzLkV2ZW50RW1pdHRlciB7XG4gIHB1YmxpYyBfYWNsU3RyZWFtOiBhbnk7XG4gIHB1YmxpYyBfaWF0OiBhbnk7XG4gIHB1YmxpYyBfaWE6IGFueTtcbiAgcHVibGljIF9yYXQ6IGFueTtcbiAgcHVibGljIF9yYTogYW55O1xuICBwdWJsaWMgb25BY2xTdHJlYW1EYXRhQmluZGVkOiBhbnk7XG4gIHB1YmxpYyBvbkFjbFN0cmVhbUVuZEJpbmRlZDogYW55O1xuICBwdWJsaWMgX3ByZXE6IGFueTtcbiAgcHVibGljIGVtaXQ6IGFueTtcbiAgcHVibGljIF9wcmVzOiBhbnk7XG4gIHB1YmxpYyBfdGs6IGFueTtcbiAgcHVibGljIF9yOiBhbnk7XG4gIHB1YmxpYyBfcGNuZjogYW55O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGFjbFN0cmVhbTogYW55LFxuICAgIGxvY2FsQWRkcmVzc1R5cGU6IGFueSxcbiAgICBsb2NhbEFkZHJlc3M6IGFueSxcbiAgICByZW1vdGVBZGRyZXNzVHlwZTogYW55LFxuICAgIHJlbW90ZUFkZHJlc3M6IGFueSxcbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9hY2xTdHJlYW0gPSBhY2xTdHJlYW07XG5cbiAgICB0aGlzLl9pYXQgPSBCdWZmZXIuZnJvbShbbG9jYWxBZGRyZXNzVHlwZSA9PT0gXCJyYW5kb21cIiA/IDB4MDEgOiAweDAwXSk7XG4gICAgdGhpcy5faWEgPSBCdWZmZXIuZnJvbShcbiAgICAgIGxvY2FsQWRkcmVzc1xuICAgICAgICAuc3BsaXQoXCI6XCIpXG4gICAgICAgIC5yZXZlcnNlKClcbiAgICAgICAgLmpvaW4oXCJcIiksXG4gICAgICBcImhleFwiLFxuICAgICk7XG4gICAgdGhpcy5fcmF0ID0gQnVmZmVyLmZyb20oW3JlbW90ZUFkZHJlc3NUeXBlID09PSBcInJhbmRvbVwiID8gMHgwMSA6IDB4MDBdKTtcbiAgICB0aGlzLl9yYSA9IEJ1ZmZlci5mcm9tKFxuICAgICAgcmVtb3RlQWRkcmVzc1xuICAgICAgICAuc3BsaXQoXCI6XCIpXG4gICAgICAgIC5yZXZlcnNlKClcbiAgICAgICAgLmpvaW4oXCJcIiksXG4gICAgICBcImhleFwiLFxuICAgICk7XG5cbiAgICB0aGlzLm9uQWNsU3RyZWFtRGF0YUJpbmRlZCA9IHRoaXMub25BY2xTdHJlYW1EYXRhLmJpbmQodGhpcyk7XG4gICAgdGhpcy5vbkFjbFN0cmVhbUVuZEJpbmRlZCA9IHRoaXMub25BY2xTdHJlYW1FbmQuYmluZCh0aGlzKTtcblxuICAgIHRoaXMuX2FjbFN0cmVhbS5vbihcImRhdGFcIiwgdGhpcy5vbkFjbFN0cmVhbURhdGFCaW5kZWQpO1xuICAgIHRoaXMuX2FjbFN0cmVhbS5vbihcImVuZFwiLCB0aGlzLm9uQWNsU3RyZWFtRW5kQmluZGVkKTtcbiAgfVxuXG4gIHB1YmxpYyBzZW5kUGFpcmluZ1JlcXVlc3QoKSB7XG4gICAgdGhpcy5fcHJlcSA9IEJ1ZmZlci5mcm9tKFtcbiAgICAgIFNNUF9QQUlSSU5HX1JFUVVFU1QsXG4gICAgICAweDAzLCAvLyBJTyBjYXBhYmlsaXR5OiBOb0lucHV0Tm9PdXRwdXRcbiAgICAgIDB4MDAsIC8vIE9PQiBkYXRhOiBBdXRoZW50aWNhdGlvbiBkYXRhIG5vdCBwcmVzZW50XG4gICAgICAweDAxLCAvLyBBdXRoZW50aWNhdGlvbiByZXF1aXJlbWVudDogQm9uZGluZyAtIE5vIE1JVE1cbiAgICAgIDB4MTAsIC8vIE1heCBlbmNyeXB0aW9uIGtleSBzaXplXG4gICAgICAweDAwLCAvLyBJbml0aWF0b3Iga2V5IGRpc3RyaWJ1dGlvbjogPG5vbmU+XG4gICAgICAweDAxLCAvLyBSZXNwb25kZXIga2V5IGRpc3RyaWJ1dGlvbjogRW5jS2V5XG4gICAgXSk7XG5cbiAgICB0aGlzLndyaXRlKHRoaXMuX3ByZXEpO1xuICB9XG5cbiAgcHVibGljIG9uQWNsU3RyZWFtRGF0YShjaWQ6IGFueSwgZGF0YT86IGFueSkge1xuICAgIGlmIChjaWQgIT09IFNNUF9DSUQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBjb2RlOiBhbnkgPSBkYXRhLnJlYWRVSW50OCgwKTtcblxuICAgIGlmIChTTVBfUEFJUklOR19SRVNQT05TRSA9PT0gY29kZSkge1xuICAgICAgdGhpcy5oYW5kbGVQYWlyaW5nUmVzcG9uc2UoZGF0YSk7XG4gICAgfSBlbHNlIGlmIChTTVBfUEFJUklOR19DT05GSVJNID09PSBjb2RlKSB7XG4gICAgICB0aGlzLmhhbmRsZVBhaXJpbmdDb25maXJtKGRhdGEpO1xuICAgIH0gZWxzZSBpZiAoU01QX1BBSVJJTkdfUkFORE9NID09PSBjb2RlKSB7XG4gICAgICB0aGlzLmhhbmRsZVBhaXJpbmdSYW5kb20oZGF0YSk7XG4gICAgfSBlbHNlIGlmIChTTVBfUEFJUklOR19GQUlMRUQgPT09IGNvZGUpIHtcbiAgICAgIHRoaXMuaGFuZGxlUGFpcmluZ0ZhaWxlZChkYXRhKTtcbiAgICB9IGVsc2UgaWYgKFNNUF9FTkNSWVBUX0lORk8gPT09IGNvZGUpIHtcbiAgICAgIHRoaXMuaGFuZGxlRW5jcnlwdEluZm8oZGF0YSk7XG4gICAgfSBlbHNlIGlmIChTTVBfTUFTVEVSX0lERU5UID09PSBjb2RlKSB7XG4gICAgICB0aGlzLmhhbmRsZU1hc3RlcklkZW50KGRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvbkFjbFN0cmVhbUVuZCgpIHtcbiAgICB0aGlzLl9hY2xTdHJlYW0ucmVtb3ZlTGlzdGVuZXIoXCJkYXRhXCIsIHRoaXMub25BY2xTdHJlYW1EYXRhQmluZGVkKTtcbiAgICB0aGlzLl9hY2xTdHJlYW0ucmVtb3ZlTGlzdGVuZXIoXCJlbmRcIiwgdGhpcy5vbkFjbFN0cmVhbUVuZEJpbmRlZCk7XG5cbiAgICB0aGlzLmVtaXQoXCJlbmRcIik7XG4gIH1cblxuICBwdWJsaWMgaGFuZGxlUGFpcmluZ1Jlc3BvbnNlKGRhdGE6IGFueSkge1xuICAgIHRoaXMuX3ByZXMgPSBkYXRhO1xuXG4gICAgdGhpcy5fdGsgPSBCdWZmZXIuZnJvbShcIjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwXCIsIFwiaGV4XCIpO1xuICAgIHRoaXMuX3IgPSBjcnlwdG8ucigpO1xuXG4gICAgdGhpcy53cml0ZShcbiAgICAgIEJ1ZmZlci5jb25jYXQoW1xuICAgICAgICBCdWZmZXIuZnJvbShbU01QX1BBSVJJTkdfQ09ORklSTV0pLFxuICAgICAgICBjcnlwdG8uYzEoXG4gICAgICAgICAgdGhpcy5fdGssXG4gICAgICAgICAgdGhpcy5fcixcbiAgICAgICAgICB0aGlzLl9wcmVzLFxuICAgICAgICAgIHRoaXMuX3ByZXEsXG4gICAgICAgICAgdGhpcy5faWF0LFxuICAgICAgICAgIHRoaXMuX2lhLFxuICAgICAgICAgIHRoaXMuX3JhdCxcbiAgICAgICAgICB0aGlzLl9yYSxcbiAgICAgICAgKSxcbiAgICAgIF0pLFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgaGFuZGxlUGFpcmluZ0NvbmZpcm0oZGF0YTogYW55KSB7XG4gICAgdGhpcy5fcGNuZiA9IGRhdGE7XG5cbiAgICB0aGlzLndyaXRlKEJ1ZmZlci5jb25jYXQoW0J1ZmZlci5mcm9tKFtTTVBfUEFJUklOR19SQU5ET01dKSwgdGhpcy5fcl0pKTtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVQYWlyaW5nUmFuZG9tKGRhdGE6IGFueSkge1xuICAgIGNvbnN0IHI6IGFueSA9IGRhdGEuc2xpY2UoMSk7XG5cbiAgICBjb25zdCBwY25mOiBhbnkgPSBCdWZmZXIuY29uY2F0KFtcbiAgICAgIEJ1ZmZlci5mcm9tKFtTTVBfUEFJUklOR19DT05GSVJNXSksXG4gICAgICBjcnlwdG8uYzEoXG4gICAgICAgIHRoaXMuX3RrLFxuICAgICAgICByLFxuICAgICAgICB0aGlzLl9wcmVzLFxuICAgICAgICB0aGlzLl9wcmVxLFxuICAgICAgICB0aGlzLl9pYXQsXG4gICAgICAgIHRoaXMuX2lhLFxuICAgICAgICB0aGlzLl9yYXQsXG4gICAgICAgIHRoaXMuX3JhLFxuICAgICAgKSxcbiAgICBdKTtcblxuICAgIGlmICh0aGlzLl9wY25mLnRvU3RyaW5nKFwiaGV4XCIpID09PSBwY25mLnRvU3RyaW5nKFwiaGV4XCIpKSB7XG4gICAgICBjb25zdCBzdGs6IGFueSA9IGNyeXB0by5zMSh0aGlzLl90aywgciwgdGhpcy5fcik7XG5cbiAgICAgIHRoaXMuZW1pdChcInN0a1wiLCBzdGspO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndyaXRlKEJ1ZmZlci5mcm9tKFtTTVBfUEFJUklOR19SQU5ET00sIFNNUF9QQUlSSU5HX0NPTkZJUk1dKSk7XG5cbiAgICAgIHRoaXMuZW1pdChcImZhaWxcIik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGhhbmRsZVBhaXJpbmdGYWlsZWQoZGF0YTogYW55KSB7XG4gICAgdGhpcy5lbWl0KFwiZmFpbFwiKTtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVFbmNyeXB0SW5mbyhkYXRhOiBhbnkpIHtcbiAgICBjb25zdCBsdGs6IGFueSA9IGRhdGEuc2xpY2UoMSk7XG5cbiAgICB0aGlzLmVtaXQoXCJsdGtcIiwgbHRrKTtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVNYXN0ZXJJZGVudChkYXRhOiBhbnkpIHtcbiAgICBjb25zdCBlZGl2OiBhbnkgPSBkYXRhLnNsaWNlKDEsIDMpO1xuICAgIGNvbnN0IHJhbmQ6IGFueSA9IGRhdGEuc2xpY2UoMyk7XG5cbiAgICB0aGlzLmVtaXQoXCJtYXN0ZXJJZGVudFwiLCBlZGl2LCByYW5kKTtcbiAgfVxuXG4gIHB1YmxpYyB3cml0ZShkYXRhOiBhbnkpIHtcbiAgICB0aGlzLl9hY2xTdHJlYW0ud3JpdGUoU01QX0NJRCwgZGF0YSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgU21wO1xuIl19

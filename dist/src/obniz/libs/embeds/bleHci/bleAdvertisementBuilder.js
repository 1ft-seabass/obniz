"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const bleHelper_1 = __importDefault(require("./bleHelper"));
class BleAdvertisementBuilder {
    constructor(Obniz, json) {
        this.Obniz = Obniz;
        this.rows = {};
        if (json) {
            if (json.localName) {
                this.setCompleteLocalName(json.localName);
            }
            if (json.manufacturerData &&
                json.manufacturerData.companyCode &&
                json.manufacturerData.data) {
                this.setManufacturerSpecificData(json.manufacturerData.companyCode, json.manufacturerData.data);
            }
            if (json.serviceUuids) {
                for (const uuid of json.serviceUuids) {
                    this.setUuid(uuid);
                }
            }
        }
        if (typeof this.extendEvalJson === "function") {
            this.extendEvalJson(json);
        }
    }
    setRow(type, data) {
        this.rows[type] = data;
    }
    getRow(type) {
        return this.rows[type] || [];
    }
    build() {
        const data = [];
        for (const key in this.rows) {
            if (this.rows[key].length === 0) {
                continue;
            }
            data.push(this.rows[key].length + 1);
            data.push(parseInt(key));
            Array.prototype.push.apply(data, this.rows[key]);
        }
        if (data.length > 31) {
            this.Obniz.error("Too large data. Advertise/ScanResponse data are must be less than 32 byte.");
        }
        return data;
    }
    setStringData(type, string) {
        const data = [];
        for (let i = 0; i < string.length; i++) {
            data.push(string.charCodeAt(i));
        }
        this.setRow(type, data);
    }
    setShortenedLocalName(name) {
        this.setStringData(0x08, name);
    }
    setCompleteLocalName(name) {
        this.setStringData(0x09, name);
    }
    setManufacturerSpecificData(companyCode, data) {
        const row = [];
        row.push(companyCode & 0xff);
        row.push((companyCode >> 8) & 0xff);
        Array.prototype.push.apply(row, data);
        this.setRow(0xff, row);
    }
    setUuid(uuid) {
        const uuidData = this.convertUuid(uuid);
        const type = { 16: 0x06, 4: 0x04, 2: 0x02 }[uuidData.length];
        this.setRow(type, uuidData);
    }
    convertUuid(uuid) {
        const uuidNumeric = bleHelper_1.default.uuidFilter(uuid);
        if (uuidNumeric.length !== 32 &&
            uuidNumeric.length !== 8 &&
            uuidNumeric.length !== 4) {
            this.Obniz.error("BLE uuid must be 16/32/128 bit . (example: c28f0ad5-a7fd-48be-9fd0-eae9ffd3a8bb for 128bit)");
        }
        const data = [];
        for (let i = uuidNumeric.length; i > 1; i -= 2) {
            data.push(parseInt(uuidNumeric[i - 2] + uuidNumeric[i - 1], 16));
        }
        return data;
    }
    setIbeaconData(uuid, major, minor, txPower) {
        const data = [];
        data.push(0x02, 0x15); // fixed data
        const uuidData = this.convertUuid(uuid);
        Array.prototype.push.apply(data, uuidData);
        data.push((major >> 8) & 0xff);
        data.push((major >> 0) & 0xff);
        data.push((minor >> 8) & 0xff);
        data.push((minor >> 0) & 0xff);
        data.push((txPower >> 0) & 0xff);
        this.setManufacturerSpecificData(0x004c, data);
        return;
    }
    extendEvalJson(json) {
        if (json) {
            if (json.flags) {
                if (json.flags.includes("limited_discoverable_mode")) {
                    this.setLeLimitedDiscoverableModeFlag();
                }
                if (json.flags.includes("general_discoverable_mode")) {
                    this.setLeGeneralDiscoverableModeFlag();
                }
                if (json.flags.includes("br_edr_not_supported")) {
                    this.setBrEdrNotSupportedFlag();
                }
                if (json.flags.includes("le_br_edr_controller")) {
                    this.setLeBrEdrControllerFlag();
                }
                if (json.flags.includes("le_br_edr_host")) {
                    this.setLeBrEdrHostFlag();
                }
            }
        }
    }
    setFlags(flag) {
        const data = this.getRow(0x01);
        data[0] = (data[0] || 0) | flag;
        this.setRow(0x01, data);
    }
    setLeLimitedDiscoverableModeFlag() {
        this.setFlags(0x01);
    }
    setLeGeneralDiscoverableModeFlag() {
        this.setFlags(0x02);
    }
    setBrEdrNotSupportedFlag() {
        this.setFlags(0x04);
    }
    setLeBrEdrControllerFlag() {
        this.setFlags(0x08);
    }
    setLeBrEdrHostFlag() {
        this.setFlags(0x10);
    }
}
exports.default = BleAdvertisementBuilder;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvYmxlQWR2ZXJ0aXNlbWVudEJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw0REFBb0M7QUFFcEMsTUFBTSx1QkFBdUI7SUFJM0IsWUFBWSxLQUFVLEVBQUUsSUFBUztRQUMvQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUVmLElBQUksSUFBSSxFQUFFO1lBQ1IsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNsQixJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzNDO1lBQ0QsSUFDRSxJQUFJLENBQUMsZ0JBQWdCO2dCQUNyQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVztnQkFDakMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFDMUI7Z0JBQ0EsSUFBSSxDQUFDLDJCQUEyQixDQUM5QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUNqQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUMzQixDQUFDO2FBQ0g7WUFDRCxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7Z0JBQ3JCLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtvQkFDcEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDcEI7YUFDRjtTQUNGO1FBQ0QsSUFBSSxPQUFPLElBQUksQ0FBQyxjQUFjLEtBQUssVUFBVSxFQUFFO1lBQzdDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDM0I7SUFDSCxDQUFDO0lBRU0sTUFBTSxDQUFDLElBQVMsRUFBRSxJQUFTO1FBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQ3pCLENBQUM7SUFFTSxNQUFNLENB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QyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRU0sZ0NBQWdDO1FBQ3JDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEIsQ0FBQztJQUVNLGdDQUFnQztRQUNyQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFTSx3QkFBd0I7UUFDN0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QixDQUFDO0lBRU0sd0JBQXdCO1FBQzdCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEIsQ0FBQztJQUVNLGtCQUFrQjtRQUN2QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7Q0FDRjtBQUVELGtCQUFlLHVCQUF1QixDQUFDIiwiZmlsZSI6InNyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvYmxlQWR2ZXJ0aXNlbWVudEJ1aWxkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmxlSGVscGVyIGZyb20gXCIuL2JsZUhlbHBlclwiO1xuXG5jbGFzcyBCbGVBZHZlcnRpc2VtZW50QnVpbGRlciB7XG4gIHB1YmxpYyBPYm5pejogYW55O1xuICBwdWJsaWMgcm93czogYW55O1xuXG4gIGNvbnN0cnVjdG9yKE9ibml6OiBhbnksIGpzb246IGFueSkge1xuICAgIHRoaXMuT2JuaXogPSBPYm5pejtcbiAgICB0aGlzLnJvd3MgPSB7fTtcblxuICAgIGlmIChqc29uKSB7XG4gICAgICBpZiAoanNvbi5sb2NhbE5hbWUpIHtcbiAgICAgICAgdGhpcy5zZXRDb21wbGV0ZUxvY2FsTmFtZShqc29uLmxvY2FsTmFtZSk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIGpzb24ubWFudWZhY3R1cmVyRGF0YSAmJlxuICAgICAgICBqc29uLm1hbnVmYWN0dXJlckRhdGEuY29tcGFueUNvZGUgJiZcbiAgICAgICAganNvbi5tYW51ZmFjdHVyZXJEYXRhLmRhdGFcbiAgICAgICkge1xuICAgICAgICB0aGlzLnNldE1hbnVmYWN0dXJlclNwZWNpZmljRGF0YShcbiAgICAgICAgICBqc29uLm1hbnVmYWN0dXJlckRhdGEuY29tcGFueUNvZGUsXG4gICAgICAgICAganNvbi5tYW51ZmFjdHVyZXJEYXRhLmRhdGEsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoanNvbi5zZXJ2aWNlVXVpZHMpIHtcbiAgICAgICAgZm9yIChjb25zdCB1dWlkIG9mIGpzb24uc2VydmljZVV1aWRzKSB7XG4gICAgICAgICAgdGhpcy5zZXRVdWlkKHV1aWQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0eXBlb2YgdGhpcy5leHRlbmRFdmFsSnNvbiA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICB0aGlzLmV4dGVuZEV2YWxKc29uKGpzb24pO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXRSb3codHlwZTogYW55LCBkYXRhOiBhbnkpIHtcbiAgICB0aGlzLnJvd3NbdHlwZV0gPSBkYXRhO1xuICB9XG5cbiAgcHVibGljIGdldFJvdyh0eXBlOiBhbnkpIHtcbiAgICByZXR1cm4gdGhpcy5yb3dzW3R5cGVdIHx8IFtdO1xuICB9XG5cbiAgcHVibGljIGJ1aWxkKCkge1xuICAgIGNvbnN0IGRhdGE6IGFueSA9IFtdO1xuICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMucm93cykge1xuICAgICAgaWYgKHRoaXMucm93c1trZXldLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgZGF0YS5wdXNoKHRoaXMucm93c1trZXldLmxlbmd0aCArIDEpO1xuICAgICAgZGF0YS5wdXNoKHBhcnNlSW50KGtleSkpO1xuICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkoZGF0YSwgdGhpcy5yb3dzW2tleV0pO1xuICAgIH1cbiAgICBpZiAoZGF0YS5sZW5ndGggPiAzMSkge1xuICAgICAgdGhpcy5PYm5pei5lcnJvcihcbiAgICAgICAgXCJUb28gbGFyZ2UgZGF0YS4gQWR2ZXJ0aXNlL1NjYW5SZXNwb25zZSBkYXRhIGFyZSBtdXN0IGJlIGxlc3MgdGhhbiAzMiBieXRlLlwiLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRTdHJpbmdEYXRhKHR5cGU6IGFueSwgc3RyaW5nOiBhbnkpIHtcbiAgICBjb25zdCBkYXRhOiBhbnkgPSBbXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RyaW5nLmxlbmd0aDsgaSsrKSB7XG4gICAgICBkYXRhLnB1c2goc3RyaW5nLmNoYXJDb2RlQXQoaSkpO1xuICAgIH1cblxuICAgIHRoaXMuc2V0Um93KHR5cGUsIGRhdGEpO1xuICB9XG5cbiAgcHVibGljIHNldFNob3J0ZW5lZExvY2FsTmFtZShuYW1lOiBhbnkpIHtcbiAgICB0aGlzLnNldFN0cmluZ0RhdGEoMHgwOCwgbmFtZSk7XG4gIH1cblxuICBwdWJsaWMgc2V0Q29tcGxldGVMb2NhbE5hbWUobmFtZTogYW55KSB7XG4gICAgdGhpcy5zZXRTdHJpbmdEYXRhKDB4MDksIG5hbWUpO1xuICB9XG5cbiAgcHVibGljIHNldE1hbnVmYWN0dXJlclNwZWNpZmljRGF0YShjb21wYW55Q29kZTogYW55LCBkYXRhOiBhbnkpIHtcbiAgICBjb25zdCByb3c6IGFueSA9IFtdO1xuICAgIHJvdy5wdXNoKGNvbXBhbnlDb2RlICYgMHhmZik7XG4gICAgcm93LnB1c2goKGNvbXBhbnlDb2RlID4+IDgpICYgMHhmZik7XG4gICAgQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkocm93LCBkYXRhKTtcbiAgICB0aGlzLnNldFJvdygweGZmLCByb3cpO1xuICB9XG5cbiAgcHVibGljIHNldFV1aWQodXVpZDogYW55KSB7XG4gICAgY29uc3QgdXVpZERhdGE6IGFueSA9IHRoaXMuY29udmVydFV1aWQodXVpZCk7XG4gICAgY29uc3QgdHlwZTogYW55ID0gezE2OiAweDA2LCA0OiAweDA0LCAyOiAweDAyfVt1dWlkRGF0YS5sZW5ndGggYXMgKDE2IHwgNCB8IDIpXTtcbiAgICB0aGlzLnNldFJvdyh0eXBlLCB1dWlkRGF0YSk7XG4gIH1cblxuICBwdWJsaWMgY29udmVydFV1aWQodXVpZDogYW55KSB7XG4gICAgY29uc3QgdXVpZE51bWVyaWM6IGFueSA9IEJsZUhlbHBlci51dWlkRmlsdGVyKHV1aWQpO1xuICAgIGlmIChcbiAgICAgIHV1aWROdW1lcmljLmxlbmd0aCAhPT0gMzIgJiZcbiAgICAgIHV1aWROdW1lcmljLmxlbmd0aCAhPT0gOCAmJlxuICAgICAgdXVpZE51bWVyaWMubGVuZ3RoICE9PSA0XG4gICAgKSB7XG4gICAgICB0aGlzLk9ibml6LmVycm9yKFxuICAgICAgICBcIkJMRSB1dWlkIG11c3QgYmUgMTYvMzIvMTI4IGJpdCAuIChleGFtcGxlOiBjMjhmMGFkNS1hN2ZkLTQ4YmUtOWZkMC1lYWU5ZmZkM2E4YmIgZm9yIDEyOGJpdClcIixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgZGF0YTogYW55ID0gW107XG4gICAgZm9yIChsZXQgaSA9IHV1aWROdW1lcmljLmxlbmd0aDsgaSA+IDE7IGkgLT0gMikge1xuICAgICAgZGF0YS5wdXNoKHBhcnNlSW50KHV1aWROdW1lcmljW2kgLSAyXSArIHV1aWROdW1lcmljW2kgLSAxXSwgMTYpKTtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBwdWJsaWMgc2V0SWJlYWNvbkRhdGEodXVpZDogYW55LCBtYWpvcjogYW55LCBtaW5vcjogYW55LCB0eFBvd2VyOiBhbnkpIHtcbiAgICBjb25zdCBkYXRhOiBhbnkgPSBbXTtcbiAgICBkYXRhLnB1c2goMHgwMiwgMHgxNSk7IC8vIGZpeGVkIGRhdGFcblxuICAgIGNvbnN0IHV1aWREYXRhOiBhbnkgPSB0aGlzLmNvbnZlcnRVdWlkKHV1aWQpO1xuICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KGRhdGEsIHV1aWREYXRhKTtcblxuICAgIGRhdGEucHVzaCgobWFqb3IgPj4gOCkgJiAweGZmKTtcbiAgICBkYXRhLnB1c2goKG1ham9yID4+IDApICYgMHhmZik7XG4gICAgZGF0YS5wdXNoKChtaW5vciA+PiA4KSAmIDB4ZmYpO1xuICAgIGRhdGEucHVzaCgobWlub3IgPj4gMCkgJiAweGZmKTtcbiAgICBkYXRhLnB1c2goKHR4UG93ZXIgPj4gMCkgJiAweGZmKTtcblxuICAgIHRoaXMuc2V0TWFudWZhY3R1cmVyU3BlY2lmaWNEYXRhKDB4MDA0YywgZGF0YSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgcHVibGljIGV4dGVuZEV2YWxKc29uKGpzb246IGFueSkge1xuICAgIGlmIChqc29uKSB7XG4gICAgICBpZiAoanNvbi5mbGFncykge1xuICAgICAgICBpZiAoanNvbi5mbGFncy5pbmNsdWRlcyhcImxpbWl0ZWRfZGlzY292ZXJhYmxlX21vZGVcIikpIHtcbiAgICAgICAgICB0aGlzLnNldExlTGltaXRlZERpc2NvdmVyYWJsZU1vZGVGbGFnKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGpzb24uZmxhZ3MuaW5jbHVkZXMoXCJnZW5lcmFsX2Rpc2NvdmVyYWJsZV9tb2RlXCIpKSB7XG4gICAgICAgICAgdGhpcy5zZXRMZUdlbmVyYWxEaXNjb3ZlcmFibGVNb2RlRmxhZygpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChqc29uLmZsYWdzLmluY2x1ZGVzKFwiYnJfZWRyX25vdF9zdXBwb3J0ZWRcIikpIHtcbiAgICAgICAgICB0aGlzLnNldEJyRWRyTm90U3VwcG9ydGVkRmxhZygpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChqc29uLmZsYWdzLmluY2x1ZGVzKFwibGVfYnJfZWRyX2NvbnRyb2xsZXJcIikpIHtcbiAgICAgICAgICB0aGlzLnNldExlQnJFZHJDb250cm9sbGVyRmxhZygpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChqc29uLmZsYWdzLmluY2x1ZGVzKFwibGVfYnJfZWRyX2hvc3RcIikpIHtcbiAgICAgICAgICB0aGlzLnNldExlQnJFZHJIb3N0RmxhZygpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNldEZsYWdzKGZsYWc6IGFueSkge1xuICAgIGNvbnN0IGRhdGE6IGFueSA9IHRoaXMuZ2V0Um93KDB4MDEpO1xuICAgIGRhdGFbMF0gPSAoZGF0YVswXSB8fCAwKSB8IGZsYWc7XG4gICAgdGhpcy5zZXRSb3coMHgwMSwgZGF0YSk7XG4gIH1cblxuICBwdWJsaWMgc2V0TGVMaW1pdGVkRGlzY292ZXJhYmxlTW9kZUZsYWcoKSB7XG4gICAgdGhpcy5zZXRGbGFncygweDAxKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRMZUdlbmVyYWxEaXNjb3ZlcmFibGVNb2RlRmxhZygpIHtcbiAgICB0aGlzLnNldEZsYWdzKDB4MDIpO1xuICB9XG5cbiAgcHVibGljIHNldEJyRWRyTm90U3VwcG9ydGVkRmxhZygpIHtcbiAgICB0aGlzLnNldEZsYWdzKDB4MDQpO1xuICB9XG5cbiAgcHVibGljIHNldExlQnJFZHJDb250cm9sbGVyRmxhZygpIHtcbiAgICB0aGlzLnNldEZsYWdzKDB4MDgpO1xuICB9XG5cbiAgcHVibGljIHNldExlQnJFZHJIb3N0RmxhZygpIHtcbiAgICB0aGlzLnNldEZsYWdzKDB4MTApO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEJsZUFkdmVydGlzZW1lbnRCdWlsZGVyO1xuIl19

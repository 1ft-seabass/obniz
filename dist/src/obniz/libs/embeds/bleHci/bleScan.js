"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const emitter = require("eventemitter3");
const bleHelper_1 = __importDefault(require("./bleHelper"));
class BleScan {
    constructor(obnizBle) {
        this.scanTarget = null;
        this.scanSettings = {};
        this.obnizBle = obnizBle;
        this.emitter = new emitter();
        this.scanedPeripherals = [];
        this._timeoutTimer = null;
    }
    start(target, settings) {
        this.obnizBle.warningIfNotInitialize();
        if (!settings) {
            settings = {};
        }
        const timeout = settings.duration || 30;
        settings.duplicate = settings.duplicate === true ? true : false;
        this.scanSettings = settings;
        target = target || {};
        this.scanTarget = target;
        if (this.scanTarget &&
            this.scanTarget.uuids &&
            Array.isArray(this.scanTarget.uuids)) {
            this.scanTarget.uuids = this.scanTarget.uuids.map((elm) => {
                return bleHelper_1.default.uuidFilter(elm);
            });
        }
        this.scanedPeripherals = [];
        this.obnizBle.centralBindings.startScanning(null, false);
        this.clearTimeoutTimer();
        this._timeoutTimer = setTimeout(() => {
            this._timeoutTimer = null;
            this.end();
        }, timeout * 1000);
    }
    startOneWait(target, settings) {
        let state = 0;
        return new Promise((resolve) => {
            this.emitter.once("onfind", (param) => {
                if (state === 0) {
                    state = 1;
                    this.end();
                    resolve(param);
                }
            });
            this.emitter.once("onfinish", () => {
                if (state === 0) {
                    state = 1;
                    resolve(null);
                }
            });
            this.start(target, settings);
        });
    }
    startAllWait(target, settings) {
        return new Promise((resolve) => {
            this.emitter.once("onfinish", () => {
                resolve(this.scanedPeripherals);
            });
            this.start(target, settings);
        });
    }
    end() {
        this.clearTimeoutTimer();
        this.obnizBle.centralBindings.stopScanning();
    }
    isTarget(peripheral) {
        if (this.scanTarget &&
            this.scanTarget.localName &&
            peripheral.localName !== this.scanTarget.localName) {
            return false;
        }
        if (this.scanTarget && this.scanTarget.uuids) {
            const uuids = peripheral.advertisementServiceUuids().map((e) => {
                return bleHelper_1.default.uuidFilter(e);
            });
            for (const uuid of this.scanTarget.uuids) {
                if (!uuids.includes(uuid)) {
                    return false;
                }
            }
        }
        return true;
    }
    onfinish(data) {
    } // dummy
    onfind(params) {
    } // dummy
    notifyFromServer(notifyName, params) {
        switch (notifyName) {
            case "onfind": {
                if (this.scanSettings.duplicate === false) {
                    // duplicate filter
                    if (this.scanedPeripherals.find((e) => e.address === params.address)) {
                        break;
                    }
                }
                if (this.isTarget(params)) {
                    this.scanedPeripherals.push(params);
                    this.emitter.emit(notifyName, params);
                    this.onfind(params);
                }
                break;
            }
            case "onfinish": {
                this.clearTimeoutTimer();
                this.emitter.emit(notifyName, this.scanedPeripherals);
                this.onfinish(this.scanedPeripherals);
                break;
            }
        }
    }
    clearTimeoutTimer() {
        if (this._timeoutTimer) {
            clearTimeout(this._timeoutTimer);
            this._timeoutTimer = null;
        }
    }
}
exports.default = BleScan;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvYmxlU2Nhbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHlDQUEwQztBQUMxQyw0REFBb0M7QUFFcEMsTUFBTSxPQUFPO0lBUVgsWUFBWSxRQUFhO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUU3QixJQUFJLENBQUMsaUJBQWlCLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO0lBQzVCLENBQUM7SUFFTSxLQUFLLENBQUMsTUFBVyxFQUFFLFFBQWE7UUFDckMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1FBRXZDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDYixRQUFRLEdBQUcsRUFBRSxDQUFDO1NBQ2Y7UUFDRCxNQUFNLE9BQU8sR0FBUSxRQUFRLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztRQUM3QyxRQUFRLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQyxTQUFTLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNoRSxJQUFJLENBQUMsWUFBWSxHQUFHLFFBQVEsQ0FBQztRQUM3QixNQUFNLEdBQUcsTUFBTSxJQUFJLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQztRQUN6QixJQUNFLElBQUksQ0FBQyxVQUFVO1lBQ2YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLO1lBQ3JCLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFDcEM7WUFDQSxJ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LFFBQVEsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztnQkFDdEMsTUFBTTthQUNQO1NBQ0Y7SUFDSCxDQUFDO0lBRU0saUJBQWlCO1FBQ3RCLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUN0QixZQUFZLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1NBQzNCO0lBQ0gsQ0FBQztDQUNGO0FBRUQsa0JBQWUsT0FBTyxDQUFDIiwiZmlsZSI6InNyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvYmxlU2Nhbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBlbWl0dGVyID0gcmVxdWlyZShcImV2ZW50ZW1pdHRlcjNcIik7XG5pbXBvcnQgQmxlSGVscGVyIGZyb20gXCIuL2JsZUhlbHBlclwiO1xuXG5jbGFzcyBCbGVTY2FuIHtcbiAgcHVibGljIHNjYW5UYXJnZXQ6IGFueTtcbiAgcHVibGljIHNjYW5TZXR0aW5nczogYW55O1xuICBwdWJsaWMgb2JuaXpCbGU6IGFueTtcbiAgcHVibGljIGVtaXR0ZXI6IGFueTtcbiAgcHVibGljIHNjYW5lZFBlcmlwaGVyYWxzOiBhbnk7XG4gIHB1YmxpYyBfdGltZW91dFRpbWVyOiBhbnk7XG5cbiAgY29uc3RydWN0b3Iob2JuaXpCbGU6IGFueSkge1xuICAgIHRoaXMuc2NhblRhcmdldCA9IG51bGw7XG4gICAgdGhpcy5zY2FuU2V0dGluZ3MgPSB7fTtcbiAgICB0aGlzLm9ibml6QmxlID0gb2JuaXpCbGU7XG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IGVtaXR0ZXIoKTtcblxuICAgIHRoaXMuc2NhbmVkUGVyaXBoZXJhbHMgPSBbXTtcbiAgICB0aGlzLl90aW1lb3V0VGltZXIgPSBudWxsO1xuICB9XG5cbiAgcHVibGljIHN0YXJ0KHRhcmdldDogYW55LCBzZXR0aW5nczogYW55KSB7XG4gICAgdGhpcy5vYm5pekJsZS53YXJuaW5nSWZOb3RJbml0aWFsaXplKCk7XG5cbiAgICBpZiAoIXNldHRpbmdzKSB7XG4gICAgICBzZXR0aW5ncyA9IHt9O1xuICAgIH1cbiAgICBjb25zdCB0aW1lb3V0OiBhbnkgPSBzZXR0aW5ncy5kdXJhdGlvbiB8fCAzMDtcbiAgICBzZXR0aW5ncy5kdXBsaWNhdGUgPSBzZXR0aW5ncy5kdXBsaWNhdGUgPT09IHRydWUgPyB0cnVlIDogZmFsc2U7XG4gICAgdGhpcy5zY2FuU2V0dGluZ3MgPSBzZXR0aW5ncztcbiAgICB0YXJnZXQgPSB0YXJnZXQgfHwge307XG4gICAgdGhpcy5zY2FuVGFyZ2V0ID0gdGFyZ2V0O1xuICAgIGlmIChcbiAgICAgIHRoaXMuc2NhblRhcmdldCAmJlxuICAgICAgdGhpcy5zY2FuVGFyZ2V0LnV1aWRzICYmXG4gICAgICBBcnJheS5pc0FycmF5KHRoaXMuc2NhblRhcmdldC51dWlkcylcbiAgICApIHtcbiAgICAgIHRoaXMuc2NhblRhcmdldC51dWlkcyA9IHRoaXMuc2NhblRhcmdldC51dWlkcy5tYXAgKChlbG06IGFueSApID0+IHtcbiAgICAgICAgcmV0dXJuIEJsZUhlbHBlci51dWlkRmlsdGVyKGVsbSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgdGhpcy5zY2FuZWRQZXJpcGhlcmFscyA9IFtdO1xuXG4gICAgdGhpcy5vYm5pekJsZS5jZW50cmFsQmluZGluZ3Muc3RhcnRTY2FubmluZyhudWxsLCBmYWxzZSk7XG5cbiAgICB0aGlzLmNsZWFyVGltZW91dFRpbWVyKCk7XG4gICAgdGhpcy5fdGltZW91dFRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLl90aW1lb3V0VGltZXIgPSBudWxsO1xuICAgICAgdGhpcy5lbmQoKTtcbiAgICB9LCB0aW1lb3V0ICogMTAwMCk7XG4gIH1cblxuICBwdWJsaWMgc3RhcnRPbmVXYWl0KHRhcmdldDogYW55LCBzZXR0aW5nczogYW55KSB7XG4gICAgbGV0IHN0YXRlOiBhbnkgPSAwO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlICgocmVzb2x2ZTogYW55ICkgPT4ge1xuICAgICAgdGhpcy5lbWl0dGVyLm9uY2UoXCJvbmZpbmRcIiwgKHBhcmFtOiBhbnkgKSA9PiB7XG4gICAgICAgIGlmIChzdGF0ZSA9PT0gMCkge1xuICAgICAgICAgIHN0YXRlID0gMTtcbiAgICAgICAgICB0aGlzLmVuZCgpO1xuICAgICAgICAgIHJlc29sdmUocGFyYW0pO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5lbWl0dGVyLm9uY2UoXCJvbmZpbmlzaFwiLCAoKSA9PiB7XG4gICAgICAgIGlmIChzdGF0ZSA9PT0gMCkge1xuICAgICAgICAgIHN0YXRlID0gMTtcbiAgICAgICAgICByZXNvbHZlKG51bGwpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5zdGFydCh0YXJnZXQsIHNldHRpbmdzKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBzdGFydEFsbFdhaXQodGFyZ2V0OiBhbnksIHNldHRpbmdzOiBhbnkpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UgKChyZXNvbHZlOiBhbnkgKSA9PiB7XG4gICAgICB0aGlzLmVtaXR0ZXIub25jZShcIm9uZmluaXNoXCIsICgpID0+IHtcbiAgICAgICAgcmVzb2x2ZSh0aGlzLnNjYW5lZFBlcmlwaGVyYWxzKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLnN0YXJ0KHRhcmdldCwgc2V0dGluZ3MpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGVuZCgpIHtcbiAgICB0aGlzLmNsZWFyVGltZW91dFRpbWVyKCk7XG4gICAgdGhpcy5vYm5pekJsZS5jZW50cmFsQmluZGluZ3Muc3RvcFNjYW5uaW5nKCk7XG4gIH1cblxuICBwdWJsaWMgaXNUYXJnZXQocGVyaXBoZXJhbDogYW55KSB7XG4gICAgaWYgKFxuICAgICAgdGhpcy5zY2FuVGFyZ2V0ICYmXG4gICAgICB0aGlzLnNjYW5UYXJnZXQubG9jYWxOYW1lICYmXG4gICAgICBwZXJpcGhlcmFsLmxvY2FsTmFtZSAhPT0gdGhpcy5zY2FuVGFyZ2V0LmxvY2FsTmFtZVxuICAgICkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAodGhpcy5zY2FuVGFyZ2V0ICYmIHRoaXMuc2NhblRhcmdldC51dWlkcykge1xuICAgICAgY29uc3QgdXVpZHM6IGFueSA9IHBlcmlwaGVyYWwuYWR2ZXJ0aXNlbWVudFNlcnZpY2VVdWlkcygpLm1hcCAoKGU6IGFueSApID0+IHtcbiAgICAgICAgcmV0dXJuIEJsZUhlbHBlci51dWlkRmlsdGVyKGUpO1xuICAgICAgfSk7XG4gICAgICBmb3IgKGNvbnN0IHV1aWQgb2YgdGhpcy5zY2FuVGFyZ2V0LnV1aWRzKSB7XG4gICAgICAgIGlmICghdXVpZHMuaW5jbHVkZXModXVpZCkpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwdWJsaWMgb25maW5pc2goZGF0YTogYW55KSB7XG4gIH0gLy8gZHVtbXlcbiAgcHVibGljIG9uZmluZChwYXJhbXM6IGFueSkge1xuICB9IC8vIGR1bW15XG5cbiAgcHVibGljIG5vdGlmeUZyb21TZXJ2ZXIobm90aWZ5TmFtZTogYW55LCBwYXJhbXM6IGFueSkge1xuICAgIHN3aXRjaCAobm90aWZ5TmFtZSkge1xuICAgICAgY2FzZSBcIm9uZmluZFwiOiB7XG4gICAgICAgIGlmICh0aGlzLnNjYW5TZXR0aW5ncy5kdXBsaWNhdGUgPT09IGZhbHNlKSB7XG4gICAgICAgICAgLy8gZHVwbGljYXRlIGZpbHRlclxuICAgICAgICAgIGlmICh0aGlzLnNjYW5lZFBlcmlwaGVyYWxzLmZpbmQoKGU6IGFueSkgPT4gZS5hZGRyZXNzID09PSBwYXJhbXMuYWRkcmVzcykpIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5pc1RhcmdldChwYXJhbXMpKSB7XG4gICAgICAgICAgdGhpcy5zY2FuZWRQZXJpcGhlcmFscy5wdXNoKHBhcmFtcyk7XG4gICAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQobm90aWZ5TmFtZSwgcGFyYW1zKTtcbiAgICAgICAgICB0aGlzLm9uZmluZChwYXJhbXMpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSBcIm9uZmluaXNoXCI6IHtcbiAgICAgICAgdGhpcy5jbGVhclRpbWVvdXRUaW1lcigpO1xuICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdChub3RpZnlOYW1lLCB0aGlzLnNjYW5lZFBlcmlwaGVyYWxzKTtcbiAgICAgICAgdGhpcy5vbmZpbmlzaCh0aGlzLnNjYW5lZFBlcmlwaGVyYWxzKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNsZWFyVGltZW91dFRpbWVyKCkge1xuICAgIGlmICh0aGlzLl90aW1lb3V0VGltZXIpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0VGltZXIpO1xuICAgICAgdGhpcy5fdGltZW91dFRpbWVyID0gbnVsbDtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQmxlU2NhbjtcbiJdfQ==

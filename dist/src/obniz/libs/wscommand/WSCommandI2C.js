"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const WSCommand_1 = __importDefault(require("./WSCommand"));
class WSCommandI2C extends WSCommand_1.default {
    constructor() {
        super();
        this.module = 6;
        this._CommandInit = 0;
        this._CommandDeinit = 1;
        this._CommandWrite = 2;
        this._CommandRead = 3;
        this._CommandSlvWritten = 4;
    }
    // Commands
    initMaster(params, module) {
        const mode = 0;
        const sda = parseInt(params.sda);
        const scl = parseInt(params.scl);
        const clock = parseInt(params.clock);
        const buf = new Uint8Array(8);
        buf[0] = module;
        buf[1] = mode;
        buf[2] = sda;
        buf[3] = scl;
        buf[4] = clock >> (3 * 8);
        buf[5] = clock >> (2 * 8);
        buf[6] = clock >> (1 * 8);
        buf[7] = clock;
        this.sendCommand(this._CommandInit, buf);
    }
    initSlave(params, module) {
        const mode = 1;
        const sda = parseInt(params.sda);
        const scl = parseInt(params.scl);
        const clock = 0;
        let addressLength = params.slave_address_length;
        const address = params.slave_address;
        if (address > 0x7f) {
            addressLength = 10;
        }
        const buf = new Uint8Array(11);
        buf[0] = module;
        buf[1] = mode;
        buf[2] = sda;
        buf[3] = scl;
        buf[4] = clock >> (3 * 8);
        buf[5] = clock >> (2 * 8);
        buf[6] = clock >> (1 * 8);
        buf[7] = clock;
        buf[8] = addressLength;
        buf[9] = address >> 8;
        buf[10] = address;
        this.sendCommand(this._CommandInit, buf);
    }
    deinit(params, module) {
        const buf = new Uint8Array([module]);
        this.sendCommand(this._CommandDeinit, buf);
    }
    write(params, module) {
        let address = parseInt(params.address);
        if (params.address_bits === 10 || address > 0x7f) {
            address = address | 0x8000; // mark 10bit mode
        }
        const buf = new Uint8Array(3 + params.data.length);
        buf[0] = module;
        buf[1] = address >> 8;
        buf[2] = address;
        buf.set(params.data, 3);
        this.sendCommand(this._CommandWrite, buf);
    }
    read(params, module) {
        let address = parseInt(params.address);
        if (params.address_bits === 10 || address > 0x7f) {
            address = address | 0x8000; // mark 10bit mode
        }
        const read_length = params.read;
        const buf = new Uint8Array(7);
        buf[0] = module;
        buf[1] = address >> 8;
        buf[2] = address;
        buf[3] = read_length >> (3 * 8);
        buf[4] = read_length >> (2 * 8);
        buf[5] = read_length >> (1 * 8);
        buf[6] = read_length;
        this.sendCommand(this._CommandRead, buf);
    }
    parseFromJson(json) {
        // 0
        for (let i = 0; i < 1; i++) {
            const module = json["i2c" + i];
            if (module === undefined) {
                continue;
            }
            const schemaData = [
                { uri: "/request/i2c/init_master", onValid: this.initMaster },
                { uri: "/request/i2c/init_slave", onValid: this.initSlave },
                { uri: "/request/i2c/write", onValid: this.write },
                { uri: "/request/i2c/read", onValid: this.read },
                { uri: "/request/i2c/deinit", onValid: this.deinit },
            ];
            const res = this.validateCommandSchema(schemaData, module, "i2c" + i, i);
            if (res.valid === 0) {
                if (res.invalidButLike.length > 0) {
                    throw new Error(res.invalidButLike[0].message);
                }
                else {
                    throw new this.WSCommandNotFoundError(`[i2c${i}]unknown command`);
                }
            }
        }
    }
    notifyFromBinary(objToSend, func, payload) {
        if (func === this._CommandRead && payload.byteLength > 3) {
            const module_index = payload[0];
            const address = (payload[1] << 8) + payload[2];
            const arr = new Array(payload.byteLength - 3);
            for (let i = 0; i < arr.length; i++) {
                arr[i] = payload[i + 3];
            }
            objToSend["i2c" + module_index] = {
                mode: "master",
                address,
                data: arr,
            };
        }
        else if (func === this._CommandSlvWritten && payload.byteLength > 4) {
            const module_index = payload[0];
            // let address_bit_length = payload[1];
            const address = (payload[2] << 8) + payload[3];
            const arr = new Array(payload.byteLength - 4);
            for (let i = 0; i < arr.length; i++) {
                arr[i] = payload[i + 4];
            }
            objToSend["i2c" + module_index] = {
                mode: "slave",
                is_fragmented: true,
                address,
                data: arr,
            };
        }
        else if (func === this.COMMAND_FUNC_ID_ERROR && payload.byteLength > 2) {
            // const _esperr = payload[0];
            const err = payload[1];
            const ref_func_id = payload[2];
            if (ref_func_id === this._CommandWrite ||
                ref_func_id === this._CommandRead) {
                let reason = "" +
                    (ref_func_id === this._CommandWrite ? "writing" : "reading") +
                    " error. ";
                if (err === 7) {
                    // in fact. it is 0x107. but truncated
                    reason += "Communication Timeout. Maybe, target is not connected.";
                }
                else if (err === 255) {
                    reason += "Communication Failed. Maybe, target is not connected.";
                }
                this.envelopError(objToSend, `i2c0`, { message: reason });
            }
            else {
                super.notifyFromBinary(objToSend, func, payload);
            }
        }
        else {
            super.notifyFromBinary(objToSend, func, payload);
        }
    }
}
exports.default = WSCommandI2C;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmRJMkMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw0REFBb0M7QUFFcEMsTUFBTSxZQUFhLFNBQVEsbUJBQVM7SUFhbEM7UUFDRSxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBRWhCLElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVELFdBQVc7SUFFSixVQUFVLENBQUMsTUFBVyxFQUFFLE1BQVc7UUFDeEMsTUFBTSxJQUFJLEdBQVEsQ0FBQyxDQUFDO1FBQ3BCLE1BQU0sR0FBRyxHQUFRLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsTUFBTSxHQUFHLEdBQVEsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0QyxNQUFNLEtBQUssR0FBUSxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTFDLE1BQU0sR0FBRyxHQUFRLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25DLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDaEIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNkLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7UUFDYixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQ2IsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUMxQixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzFCLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDMUIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUVmLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRU0sU0FBUyxDQUFDLE1BQVcsRUFBRSxNQUFXO1FBQ3ZDLE1BQU0sSUFBSSxHQUFRLENBQUMsQ0FBQztRQUNwQixNQUFNLEdBQUcsR0FBUSxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sR0FBRyxHQUFRLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsTUFBTSxLQUFLLEdBQVEsQ0FBQyxDQUFDO1FBRXJCLElBQUksYUFBYSxHQUFRLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQztRQUNyRCxNQUFNLE9BQU8sR0FBUSxNQUFNLENBQUMsYUFBYSxDQUFDO1FBQzFDLElBQUksT0FBTyxHQUFHLElBQUksRUFBRTtZQUNsQixhQUFhLEdBQUcsRUFBRSxDQUFDO1NBQ3BCO1FBRUQsTUFBTSxHQUFHLEdBQVEsSUFBSSxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDcEMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUNoQixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ2QsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUNiLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7UUFDYixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzFCLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDMUIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUMxQixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ2YsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLGFBQWEsQ0FBQztRQUN2QixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxJQUFJLENBQUMsQ0FBQztRQUN0QixHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDO1FBRWxCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRU0sTUFBTSxDQUFDLE1BQVcsRUFBRSxNQUFXO1FBQ3BDLE1BQU0sR0FBRyxHQUFRLElBQUksVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUMxQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVNLEtBQUssQ0FBQyxNQUFXLEVBQUUsTUFBVztRQUNuQyxJQUFJLE9BQU8sR0FBUSxRQUFRLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRTVDLElBQUksTUFBTSxDQUFDLFlBQVksS0FBSyxFQUFFLElBQUksT0FBTyxHQUFHLElBQUksRUFBRTtZQUNoRCxPQUFPLEdBQUcsT0FBTyxHQUFHLE1BQU0sQ0FBQyxDQUFDLGtCQUFrQjtTQUMvQztRQUNELE1BQU0sR0FBRyxHQUFRLElBQUksVUFBVSxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3hELEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDaEIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sSUFBSSxDQUFDLENBQUM7UUFDdEIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQztRQUNqQixHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDeEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFTSxJQUFJLENBQUMsTUFBVyxFQUFFLE1BQVc7UUFDbEMsSUFBSSxPQUFPLEdBQVEsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU1QyxJQUFJLE1BQU0sQ0FBQyxZQUFZLEtBQUssRUFBRSxJQUFJLE9BQU8sR0FBRyxJQUFJLEVBQUU7WUFDaEQsT0FBTyxHQUFHLE9BQU8sR0FBRyxNQUFNLENBQUMsQ0FBQyxrQkFBa0I7U0FDL0M7UUFDRCxNQUFNLFdBQVcsR0FBUSxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ3JDLE1BQU0sR0FBRyxHQUFRLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25DLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDaEIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sSUFBSSxDQUFDLENBQUM7UUFDdEIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQztRQUNqQixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsV0FBVyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2hDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxXQUFXLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDaEMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLFdBQVcsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNoQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsV0FBVyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRU0sYUFBYSxDQUFDLElBQVM7UUFDNUIsSUFBSTtRQUNKLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDMUIsTUFBTSxNQUFNLEdBQVEsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNwQyxJQUFJLE1BQU0sS0FBSyxTQUFTLEVBQUU7Z0JBQ3hCLFNBQVM7YUFDVjtZQUVELE1BQU0sVUFBVSxHQUFRO2dCQUN0QixFQUFDLEdBQUcsRUFBRSwwQkFBMEIsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBQztnQkFDM0QsRUFBQyxHQUFHLEVBQUUseUJBQXlCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUM7Z0JBQ3pELEVBQUMsR0FBRyxFQUFFLG9CQUFvQixFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFDO2dCQUNoRCxFQUFDLEdBQUcsRUFBRSxtQkFBbUIsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBQztnQkFDOUMsRUFBQyxHQUFHLEVBQUUscUJBQXFCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUM7YUFDbkQsQ0FBQztZQUNGLE1BQU0sR0FBRyxHQUFRLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFFOUUsSUFBSSxHQUFHLENBQUMsS0FBSyxLQUFLLENBQUMsRUFBRTtnQkFDbkIsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQ2pDLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDaEQ7cUJBQU07b0JBQ0wsTUFBTSxJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztpQkFDbkU7YUFDRjtTQUNGO0lBQ0gsQ0FBQztJQUVNLGdCQUFnQixDQUFDLFNBQWMsRUFBRSxJQUFTLEVBQUUsT0FBWTtRQUM3RCxJQUFJLElBQUksS0FBSyxJQUFJLENBQUMsWUFBWSxJQUFJLE9BQU8sQ0FBQyxVQUFVLEdBQUcsQ0FBQyxFQUFFO1lBQ3hELE1BQU0sWUFBWSxHQUFRLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQyxNQUFNLE9BQU8sR0FBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFcEQsTUFBTSxHQUFHLEdBQVEsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNuRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDbkMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7YUFDekI7WUFFRCxTQUFTLENBQUMsS0FBSyxHQUFHLFlBQVksQ0FBQyxHQUFHO2dCQUNoQyxJQUFJLEVBQUUsUUFBUTtnQkFDZCxPQUFPO2dCQUNQLElBQUksRUFBRSxHQUFHO2FBQ1YsQ0FBQztTQUNIO2FBQU0sSUFBSSxJQUFJLEtBQUssSUFBSSxDQUFDLGtCQUFrQixJQUFJLE9BQU8sQ0FBQyxVQUFVLEdBQUcsQ0FBQyxFQUFFO1lBQ3JFLE1BQU0sWUFBWSxHQUFRLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQyx1Q0FBdUM7WUFDdkMsTUFBTSxPQUFPLEdBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXBELE1BQU0sR0FBRyxHQUFRLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDbkQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ25DLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2FBQ3pCO1lBRUQsU0FBUyxDQUFDLEtBQUssR0FBRyxZQUFZLENBQUMsR0FBRztnQkFDaEMsSUFBSSxFQUFFLE9BQU87Z0JBQ2IsYUFBYSxFQUFFLElBQUk7Z0JBQ25CLE9BQU87Z0JBQ1AsSUFBSSxFQUFFLEdBQUc7YUFDVixDQUFDO1NBQ0g7YUFBTSxJQUFJLElBQUksS0FBSyxJQUFJLENBQUMscUJBQXFCLElBQUksT0FBTyxDQUFDLFVBQVUsR0FBRyxDQUFDLEVBQUU7WUFDeEUsOEJBQThCO1lBQzlCLE1BQU0sR0FBRyxHQUFRLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM1QixNQUFNLFdBQVcsR0FBUSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFcEMsSUFDRSxXQUFXLEtBQUssSUFBSSxDQUFDLGFBQWE7Z0JBQ2xDLFdBQVcsS0FBSyxJQUFJLENBQUMsWUFBWSxFQUNqQztnQkFDQSxJQUFJLE1BQU0sR0FDUixFQUFFO29CQUNGLENBQUMsV0FBVyxLQUFLLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO29CQUM1RCxVQUFVLENBQUM7Z0JBQ2IsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFO29CQUNiLHNDQUFzQztvQkFDdEMsTUFBTSxJQUFJLHdEQUF3RCxDQUFDO2lCQUNwRTtxQkFBTSxJQUFJLEdBQUcsS0FBSyxHQUFHLEVBQUU7b0JBQ3RCLE1BQU0sSUFBSSx1REFBdUQsQ0FBQztpQkFDbkU7Z0JBQ0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsTUFBTSxFQUFFLEVBQUMsT0FBTyxFQUFFLE1BQU0sRUFBQyxDQUFDLENBQUM7YUFDekQ7aUJBQU07Z0JBQ0wsS0FBSyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7YUFDbEQ7U0FDRjthQUFNO1lBQ0wsS0FBSyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDbEQ7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxrQkFBZSxZQUFZLENBQUMiLCJmaWxlIjoic3JjL29ibml6L2xpYnMvd3Njb21tYW5kL1dTQ29tbWFuZEkyQy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBXU0NvbW1hbmQgZnJvbSBcIi4vV1NDb21tYW5kXCI7XG5cbmNsYXNzIFdTQ29tbWFuZEkyQyBleHRlbmRzIFdTQ29tbWFuZCB7XG4gIHB1YmxpYyBtb2R1bGU6IGFueTtcbiAgcHVibGljIF9Db21tYW5kSW5pdDogYW55O1xuICBwdWJsaWMgX0NvbW1hbmREZWluaXQ6IGFueTtcbiAgcHVibGljIF9Db21tYW5kV3JpdGU6IGFueTtcbiAgcHVibGljIF9Db21tYW5kUmVhZDogYW55O1xuICBwdWJsaWMgX0NvbW1hbmRTbHZXcml0dGVuOiBhbnk7XG4gIHB1YmxpYyBzZW5kQ29tbWFuZDogYW55O1xuICBwdWJsaWMgdmFsaWRhdGVDb21tYW5kU2NoZW1hOiBhbnk7XG4gIHB1YmxpYyBXU0NvbW1hbmROb3RGb3VuZEVycm9yOiBhbnk7XG4gIHB1YmxpYyBDT01NQU5EX0ZVTkNfSURfRVJST1I6IGFueTtcbiAgcHVibGljIGVudmVsb3BFcnJvcjogYW55O1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5tb2R1bGUgPSA2O1xuXG4gICAgdGhpcy5fQ29tbWFuZEluaXQgPSAwO1xuICAgIHRoaXMuX0NvbW1hbmREZWluaXQgPSAxO1xuICAgIHRoaXMuX0NvbW1hbmRXcml0ZSA9IDI7XG4gICAgdGhpcy5fQ29tbWFuZFJlYWQgPSAzO1xuICAgIHRoaXMuX0NvbW1hbmRTbHZXcml0dGVuID0gNDtcbiAgfVxuXG4gIC8vIENvbW1hbmRzXG5cbiAgcHVibGljIGluaXRNYXN0ZXIocGFyYW1zOiBhbnksIG1vZHVsZTogYW55KSB7XG4gICAgY29uc3QgbW9kZTogYW55ID0gMDtcbiAgICBjb25zdCBzZGE6IGFueSA9IHBhcnNlSW50KHBhcmFtcy5zZGEpO1xuICAgIGNvbnN0IHNjbDogYW55ID0gcGFyc2VJbnQocGFyYW1zLnNjbCk7XG4gICAgY29uc3QgY2xvY2s6IGFueSA9IHBhcnNlSW50KHBhcmFtcy5jbG9jayk7XG5cbiAgICBjb25zdCBidWY6IGFueSA9IG5ldyBVaW50OEFycmF5KDgpO1xuICAgIGJ1ZlswXSA9IG1vZHVsZTtcbiAgICBidWZbMV0gPSBtb2RlO1xuICAgIGJ1ZlsyXSA9IHNkYTtcbiAgICBidWZbM10gPSBzY2w7XG4gICAgYnVmWzRdID0gY2xvY2sgPj4gKDMgKiA4KTtcbiAgICBidWZbNV0gPSBjbG9jayA+PiAoMiAqIDgpO1xuICAgIGJ1Zls2XSA9IGNsb2NrID4+ICgxICogOCk7XG4gICAgYnVmWzddID0gY2xvY2s7XG5cbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRJbml0LCBidWYpO1xuICB9XG5cbiAgcHVibGljIGluaXRTbGF2ZShwYXJhbXM6IGFueSwgbW9kdWxlOiBhbnkpIHtcbiAgICBjb25zdCBtb2RlOiBhbnkgPSAxO1xuICAgIGNvbnN0IHNkYTogYW55ID0gcGFyc2VJbnQocGFyYW1zLnNkYSk7XG4gICAgY29uc3Qgc2NsOiBhbnkgPSBwYXJzZUludChwYXJhbXMuc2NsKTtcbiAgICBjb25zdCBjbG9jazogYW55ID0gMDtcblxuICAgIGxldCBhZGRyZXNzTGVuZ3RoOiBhbnkgPSBwYXJhbXMuc2xhdmVfYWRkcmVzc19sZW5ndGg7XG4gICAgY29uc3QgYWRkcmVzczogYW55ID0gcGFyYW1zLnNsYXZlX2FkZHJlc3M7XG4gICAgaWYgKGFkZHJlc3MgPiAweDdmKSB7XG4gICAgICBhZGRyZXNzTGVuZ3RoID0gMTA7XG4gICAgfVxuXG4gICAgY29uc3QgYnVmOiBhbnkgPSBuZXcgVWludDhBcnJheSgxMSk7XG4gICAgYnVmWzBdID0gbW9kdWxlO1xuICAgIGJ1ZlsxXSA9IG1vZGU7XG4gICAgYnVmWzJdID0gc2RhO1xuICAgIGJ1ZlszXSA9IHNjbDtcbiAgICBidWZbNF0gPSBjbG9jayA+PiAoMyAqIDgpO1xuICAgIGJ1Zls1XSA9IGNsb2NrID4+ICgyICogOCk7XG4gICAgYnVmWzZdID0gY2xvY2sgPj4gKDEgKiA4KTtcbiAgICBidWZbN10gPSBjbG9jaztcbiAgICBidWZbOF0gPSBhZGRyZXNzTGVuZ3RoO1xuICAgIGJ1Zls5XSA9IGFkZHJlc3MgPj4gODtcbiAgICBidWZbMTBdID0gYWRkcmVzcztcblxuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZEluaXQsIGJ1Zik7XG4gIH1cblxuICBwdWJsaWMgZGVpbml0KHBhcmFtczogYW55LCBtb2R1bGU6IGFueSkge1xuICAgIGNvbnN0IGJ1ZjogYW55ID0gbmV3IFVpbnQ4QXJyYXkoW21vZHVsZV0pO1xuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZERlaW5pdCwgYnVmKTtcbiAgfVxuXG4gIHB1YmxpYyB3cml0ZShwYXJhbXM6IGFueSwgbW9kdWxlOiBhbnkpIHtcbiAgICBsZXQgYWRkcmVzczogYW55ID0gcGFyc2VJbnQocGFyYW1zLmFkZHJlc3MpO1xuXG4gICAgaWYgKHBhcmFtcy5hZGRyZXNzX2JpdHMgPT09IDEwIHx8IGFkZHJlc3MgPiAweDdmKSB7XG4gICAgICBhZGRyZXNzID0gYWRkcmVzcyB8IDB4ODAwMDsgLy8gbWFyayAxMGJpdCBtb2RlXG4gICAgfVxuICAgIGNvbnN0IGJ1ZjogYW55ID0gbmV3IFVpbnQ4QXJyYXkoMyArIHBhcmFtcy5kYXRhLmxlbmd0aCk7XG4gICAgYnVmWzBdID0gbW9kdWxlO1xuICAgIGJ1ZlsxXSA9IGFkZHJlc3MgPj4gODtcbiAgICBidWZbMl0gPSBhZGRyZXNzO1xuICAgIGJ1Zi5zZXQocGFyYW1zLmRhdGEsIDMpO1xuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZFdyaXRlLCBidWYpO1xuICB9XG5cbiAgcHVibGljIHJlYWQocGFyYW1zOiBhbnksIG1vZHVsZTogYW55KSB7XG4gICAgbGV0IGFkZHJlc3M6IGFueSA9IHBhcnNlSW50KHBhcmFtcy5hZGRyZXNzKTtcblxuICAgIGlmIChwYXJhbXMuYWRkcmVzc19iaXRzID09PSAxMCB8fCBhZGRyZXNzID4gMHg3Zikge1xuICAgICAgYWRkcmVzcyA9IGFkZHJlc3MgfCAweDgwMDA7IC8vIG1hcmsgMTBiaXQgbW9kZVxuICAgIH1cbiAgICBjb25zdCByZWFkX2xlbmd0aDogYW55ID0gcGFyYW1zLnJlYWQ7XG4gICAgY29uc3QgYnVmOiBhbnkgPSBuZXcgVWludDhBcnJheSg3KTtcbiAgICBidWZbMF0gPSBtb2R1bGU7XG4gICAgYnVmWzFdID0gYWRkcmVzcyA+PiA4O1xuICAgIGJ1ZlsyXSA9IGFkZHJlc3M7XG4gICAgYnVmWzNdID0gcmVhZF9sZW5ndGggPj4gKDMgKiA4KTtcbiAgICBidWZbNF0gPSByZWFkX2xlbmd0aCA+PiAoMiAqIDgpO1xuICAgIGJ1Zls1XSA9IHJlYWRfbGVuZ3RoID4+ICgxICogOCk7XG4gICAgYnVmWzZdID0gcmVhZF9sZW5ndGg7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kUmVhZCwgYnVmKTtcbiAgfVxuXG4gIHB1YmxpYyBwYXJzZUZyb21Kc29uKGpzb246IGFueSkge1xuICAgIC8vIDBcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE7IGkrKykge1xuICAgICAgY29uc3QgbW9kdWxlOiBhbnkgPSBqc29uW1wiaTJjXCIgKyBpXTtcbiAgICAgIGlmIChtb2R1bGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc2NoZW1hRGF0YTogYW55ID0gW1xuICAgICAgICB7dXJpOiBcIi9yZXF1ZXN0L2kyYy9pbml0X21hc3RlclwiLCBvblZhbGlkOiB0aGlzLmluaXRNYXN0ZXJ9LFxuICAgICAgICB7dXJpOiBcIi9yZXF1ZXN0L2kyYy9pbml0X3NsYXZlXCIsIG9uVmFsaWQ6IHRoaXMuaW5pdFNsYXZlfSxcbiAgICAgICAge3VyaTogXCIvcmVxdWVzdC9pMmMvd3JpdGVcIiwgb25WYWxpZDogdGhpcy53cml0ZX0sXG4gICAgICAgIHt1cmk6IFwiL3JlcXVlc3QvaTJjL3JlYWRcIiwgb25WYWxpZDogdGhpcy5yZWFkfSxcbiAgICAgICAge3VyaTogXCIvcmVxdWVzdC9pMmMvZGVpbml0XCIsIG9uVmFsaWQ6IHRoaXMuZGVpbml0fSxcbiAgICAgIF07XG4gICAgICBjb25zdCByZXM6IGFueSA9IHRoaXMudmFsaWRhdGVDb21tYW5kU2NoZW1hKHNjaGVtYURhdGEsIG1vZHVsZSwgXCJpMmNcIiArIGksIGkpO1xuXG4gICAgICBpZiAocmVzLnZhbGlkID09PSAwKSB7XG4gICAgICAgIGlmIChyZXMuaW52YWxpZEJ1dExpa2UubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihyZXMuaW52YWxpZEJ1dExpa2VbMF0ubWVzc2FnZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IHRoaXMuV1NDb21tYW5kTm90Rm91bmRFcnJvcihgW2kyYyR7aX1ddW5rbm93biBjb21tYW5kYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbm90aWZ5RnJvbUJpbmFyeShvYmpUb1NlbmQ6IGFueSwgZnVuYzogYW55LCBwYXlsb2FkOiBhbnkpIHtcbiAgICBpZiAoZnVuYyA9PT0gdGhpcy5fQ29tbWFuZFJlYWQgJiYgcGF5bG9hZC5ieXRlTGVuZ3RoID4gMykge1xuICAgICAgY29uc3QgbW9kdWxlX2luZGV4OiBhbnkgPSBwYXlsb2FkWzBdO1xuICAgICAgY29uc3QgYWRkcmVzczogYW55ID0gKHBheWxvYWRbMV0gPDwgOCkgKyBwYXlsb2FkWzJdO1xuXG4gICAgICBjb25zdCBhcnI6IGFueSA9IG5ldyBBcnJheShwYXlsb2FkLmJ5dGVMZW5ndGggLSAzKTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGFycltpXSA9IHBheWxvYWRbaSArIDNdO1xuICAgICAgfVxuXG4gICAgICBvYmpUb1NlbmRbXCJpMmNcIiArIG1vZHVsZV9pbmRleF0gPSB7XG4gICAgICAgIG1vZGU6IFwibWFzdGVyXCIsXG4gICAgICAgIGFkZHJlc3MsXG4gICAgICAgIGRhdGE6IGFycixcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmIChmdW5jID09PSB0aGlzLl9Db21tYW5kU2x2V3JpdHRlbiAmJiBwYXlsb2FkLmJ5dGVMZW5ndGggPiA0KSB7XG4gICAgICBjb25zdCBtb2R1bGVfaW5kZXg6IGFueSA9IHBheWxvYWRbMF07XG4gICAgICAvLyBsZXQgYWRkcmVzc19iaXRfbGVuZ3RoID0gcGF5bG9hZFsxXTtcbiAgICAgIGNvbnN0IGFkZHJlc3M6IGFueSA9IChwYXlsb2FkWzJdIDw8IDgpICsgcGF5bG9hZFszXTtcblxuICAgICAgY29uc3QgYXJyOiBhbnkgPSBuZXcgQXJyYXkocGF5bG9hZC5ieXRlTGVuZ3RoIC0gNCk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykge1xuICAgICAgICBhcnJbaV0gPSBwYXlsb2FkW2kgKyA0XTtcbiAgICAgIH1cblxuICAgICAgb2JqVG9TZW5kW1wiaTJjXCIgKyBtb2R1bGVfaW5kZXhdID0ge1xuICAgICAgICBtb2RlOiBcInNsYXZlXCIsXG4gICAgICAgIGlzX2ZyYWdtZW50ZWQ6IHRydWUsXG4gICAgICAgIGFkZHJlc3MsXG4gICAgICAgIGRhdGE6IGFycixcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmIChmdW5jID09PSB0aGlzLkNPTU1BTkRfRlVOQ19JRF9FUlJPUiAmJiBwYXlsb2FkLmJ5dGVMZW5ndGggPiAyKSB7XG4gICAgICAvLyBjb25zdCBfZXNwZXJyID0gcGF5bG9hZFswXTtcbiAgICAgIGNvbnN0IGVycjogYW55ID0gcGF5bG9hZFsxXTtcbiAgICAgIGNvbnN0IHJlZl9mdW5jX2lkOiBhbnkgPSBwYXlsb2FkWzJdO1xuXG4gICAgICBpZiAoXG4gICAgICAgIHJlZl9mdW5jX2lkID09PSB0aGlzLl9Db21tYW5kV3JpdGUgfHxcbiAgICAgICAgcmVmX2Z1bmNfaWQgPT09IHRoaXMuX0NvbW1hbmRSZWFkXG4gICAgICApIHtcbiAgICAgICAgbGV0IHJlYXNvbjogYW55ID1cbiAgICAgICAgICBcIlwiICtcbiAgICAgICAgICAocmVmX2Z1bmNfaWQgPT09IHRoaXMuX0NvbW1hbmRXcml0ZSA/IFwid3JpdGluZ1wiIDogXCJyZWFkaW5nXCIpICtcbiAgICAgICAgICBcIiBlcnJvci4gXCI7XG4gICAgICAgIGlmIChlcnIgPT09IDcpIHtcbiAgICAgICAgICAvLyBpbiBmYWN0LiBpdCBpcyAweDEwNy4gYnV0IHRydW5jYXRlZFxuICAgICAgICAgIHJlYXNvbiArPSBcIkNvbW11bmljYXRpb24gVGltZW91dC4gTWF5YmUsIHRhcmdldCBpcyBub3QgY29ubmVjdGVkLlwiO1xuICAgICAgICB9IGVsc2UgaWYgKGVyciA9PT0gMjU1KSB7XG4gICAgICAgICAgcmVhc29uICs9IFwiQ29tbXVuaWNhdGlvbiBGYWlsZWQuIE1heWJlLCB0YXJnZXQgaXMgbm90IGNvbm5lY3RlZC5cIjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmVudmVsb3BFcnJvcihvYmpUb1NlbmQsIGBpMmMwYCwge21lc3NhZ2U6IHJlYXNvbn0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3VwZXIubm90aWZ5RnJvbUJpbmFyeShvYmpUb1NlbmQsIGZ1bmMsIHBheWxvYWQpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBzdXBlci5ub3RpZnlGcm9tQmluYXJ5KG9ialRvU2VuZCwgZnVuYywgcGF5bG9hZCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFdTQ29tbWFuZEkyQztcbiJdfQ==

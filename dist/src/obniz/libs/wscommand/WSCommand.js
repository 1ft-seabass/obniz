"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const WSSchema_1 = __importDefault(require("./WSSchema"));
const commandClasses = {};
class WSCommand {
    constructor() {
        this._hw = {
            hw: undefined,
            firmware: undefined,
        };
        // constants
        this.COMMAND_FUNC_ID_ERROR = 0xff;
        this.ioNotUsed = 0xff;
    }
    static get schema() {
        return WSSchema_1.default;
    }
    static get CommandClasses() {
        return commandClasses;
    }
    get WSCommandNotFoundError() {
        return WSCommandNotFoundError;
    }
    static addCommandClass(name, classObj) {
        commandClasses[name] = classObj;
    }
    static framed(module, func, payload) {
        let payload_length = 0;
        if (payload) {
            payload_length = payload.length;
        }
        let length_type;
        if (payload_length <= 0x3f) {
            length_type = 0;
        }
        else if (payload_length <= 0x3fff) {
            length_type = 1;
        }
        else if (payload_length <= 0x3fffffff) {
            length_type = 2;
        }
        else {
            throw new Error("too big payload");
        }
        let length_extra_bytse = length_type === 0 ? 0 : length_type === 1 ? 1 : 3;
        const header_length = 3 + length_extra_bytse;
        const result = new Uint8Array(header_length + payload_length);
        let index = 0;
        result[index++] = module & 0x7f;
        result[index++] = func;
        result[index++] =
            (length_type << 6) | (payload_length >> (length_extra_bytse * 8));
        while (length_extra_bytse > 0) {
            length_extra_bytse--;
            result[index++] = payload_length >> (length_extra_bytse * 8);
        }
        if (payload_length === 0) {
            return result;
        }
        else {
            result.set(payload, header_length);
            return result;
        }
    }
    static dequeueOne(buf) {
        if (!buf || buf.byteLength === 0) {
            return null;
        }
        if (buf.byteLength < 3) {
            throw new Error("something wrong. buf less than 3");
        }
        if (buf[0] & 0x80) {
            throw new Error("reserved bit 1");
        }
        const module = 0x7f & buf[0];
        const func = buf[1];
        const length_type = (buf[2] >> 6) & 0x3;
        const length_extra_bytse = length_type === 0 ? 0 : length_type === 1 ? 1 : 3;
        if (length_type === 4) {
            throw new Error("invalid length");
        }
        let length = (buf[2] & 0x3f) << (length_extra_bytse * 8);
        let index = 3;
        let shift = length_extra_bytse;
        while (shift > 0) {
            shift--;
            length += buf[index] << (shift * 8);
            index++;
        }
        return {
            module,
            func,
            payload: buf.slice(3 + length_extra_bytse, 3 + length_extra_bytse + length),
            next: buf.slice(3 + length_extra_bytse + length),
        };
    }
    static compress(wscommands, json) {
        let ret = null;
        function append(module, func, payload) {
            const frame = WSCommand.framed(module, func, payload);
            if (ret) {
                const combined = new Uint8Array(ret.length + frame.length);
                combined.set(ret, 0);
                combined.set(frame, ret.length);
                ret = combined;
            }
            else {
                ret = frame;
            }
        }
        for (const wscommand of wscommands) {
            wscommand.parsed = append;
            wscommand.parseFromJson(json);
        }
        return ret;
    }
    setHw(obj) {
        this._hw = obj;
    }
    sendCommand(func, payload) {
        if (this.parsed) {
            this.parsed(this.module, func, payload);
        }
    }
    parseFromJson(json) {
        // abstract
    }
    notifyFromBinary(objToSend, func, payload) {
        if (func === this.COMMAND_FUNC_ID_ERROR) {
            if (!objToSend.debug) {
                objToSend.debug = {};
            }
            const err = {
                module: this.module,
                _args: [...payload],
            };
            if (payload.byteLength === 3) {
                err.err0 = payload[0];
                err.err1 = payload[1];
                err.function = payload[2];
                err.message = `Error module=${this.module} func=${err.function} err0=${err.err0} returned=${err.err1}`;
            }
            else {
                err.message = `Error module=${this.module} with + ${err._args}`;
            }
            objToSend.debug.error = err;
        }
        else {
            // unknown
        }
    }
    envelopWarning(objToSend, module_key, obj) {
        if (!objToSend[module_key]) {
            objToSend[module_key] = {};
        }
        objToSend[module_key].warning = obj;
    }
    envelopError(objToSend, module_key, obj) {
        if (!objToSend[module_key]) {
            objToSend[module_key] = {};
        }
        objToSend[module_key].error = obj;
    }
    isValidIO(io) {
        return typeof io === "number" && 0 <= io && io <= 11;
    }
    getSchema(uri) {
        // chack isFirst
        return WSSchema_1.default.getSchema(uri);
    }
    validateCommandSchema(uriList, json, rootPath, customArg) {
        const res = { valid: 0, invalid: 0, results: [], invalidButLike: [] };
        for (const oneRow of uriList) {
            const errors = this.validate(oneRow.uri, json);
            res.results.push(errors);
            if (errors.valid) {
                res.valid++;
                if (oneRow.onValid) {
                    oneRow.onValid.bind(this)(this.filter(oneRow.uri, json), customArg);
                }
            }
            else {
                res.invalid++;
                const message = this.onlyTypeErrorMessage(errors, rootPath);
                if (message) {
                    res.invalidButLike.push({ uri: oneRow.uri, message });
                }
            }
        }
        return res;
    }
    validate(commandUri, json) {
        const schema = this.getSchema(commandUri);
        const results = WSSchema_1.default.validateMultiple(json, schema);
        return results;
    }
    onlyTypeErrorMessage(validateError, rootPath) {
        if (validateError.valid) {
            return true;
        }
        if (validateError.missing && validateError.missing.length > 0) {
            return false;
        }
        const badErrorCodes = [
            WSSchema_1.default.errorCodes.ANY_OF_MISSING,
            WSSchema_1.default.errorCodes.ONE_OF_MISSING,
            WSSchema_1.default.errorCodes.ONE_OF_MULTIPLE,
            WSSchema_1.default.errorCodes.NOT_PASSED,
            WSSchema_1.default.errorCodes.OBJECT_REQUIRED,
            WSSchema_1.default.errorCodes.OBJECT_ADDITIONAL_PROPERTIES,
            WSSchema_1.default.errorCodes.CIRCULAR_REFERENCE,
            WSSchema_1.default.errorCodes.FORMAT_CUSTOM,
            WSSchema_1.default.errorCodes.KEYWORD_CUSTOM,
            WSSchema_1.default.errorCodes.UNKNOWN_PROPERTY,
        ];
        const messages = [];
        for (const error of validateError.errors) {
            if (error.code === WSSchema_1.default.errorCodes.INVALID_TYPE) {
                if (error.params.type === "object" ||
                    error.params.expected === "object") {
                    return false;
                }
            }
            else if (badErrorCodes.includes(error.code)) {
                return false;
            }
            const path = rootPath + (error.dataPath || "").replace(/\//g, ".");
            messages.push(`[${path}]${error.message}`);
        }
        return messages.join(";");
    }
    filter(commandUri, json) {
        const schema = this.getSchema(commandUri);
        return this._filterSchema(schema, json);
    }
    _filterSchema(schema, json) {
        if (schema.$ref) {
            const refSchema = WSSchema_1.default.getSchema(schema.$ref);
            return this._filterSchema(refSchema, json);
        }
        if (json === undefined) {
            return schema.default;
        }
        if (schema.type === "string" ||
            schema.type === "integer" ||
            schema.type === "boolean" ||
            schema.type === "number" ||
            schema.type === "null" ||
            schema.filter === "pass_all") {
            return json;
        }
        if (schema.type === "array") {
            const results = [];
            for (const key in json) {
                results[key] = this._filterSchema(schema.items, json[key]);
            }
            return results;
        }
        if (schema.type === "object") {
            const results = {};
            for (const key in schema.properties) {
                results[key] = this._filterSchema(schema.properties[key], json[key]);
            }
            for (const pattern in schema.patternProperties) {
                const reg = new RegExp(pattern);
                for (const key of Object.keys(json)) {
                    if (reg.test(key)) {
                        results[key] = this._filterSchema(schema.patternProperties[pattern], json[key]);
                    }
                }
            }
            return results;
        }
        throw Error("unknown json schema type");
    }
}
exports.default = WSCommand;
// tslint:disable-next-line:max-classes-per-file
class WSCommandNotFoundError extends Error {
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwwREFBa0M7QUFFbEMsTUFBTSxjQUFjLEdBQVEsRUFBRSxDQUFDO0FBRS9CLE1BQThCLFNBQVM7SUF1SHJDO1FBQ0UsSUFBSSxDQUFDLEdBQUcsR0FBRztZQUNULEVBQUUsRUFBRSxTQUFTO1lBQ2IsUUFBUSxFQUFFLFNBQVM7U0FDcEIsQ0FBQztRQUVGLFlBQVk7UUFDWixJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO0lBQ3hCLENBQUM7SUE5SEQsTUFBTSxLQUFLLE1BQU07UUFDZixPQUFPLGtCQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVELE1BQU0sS0FBSyxjQUFjO1FBQ3ZCLE9BQU8sY0FBYyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxJQUFJLHNCQUFzQjtRQUN4QixPQUFPLHNCQUFzQixDQUFDO0lBQ2hDLENBQUM7SUFFTSxNQUFNLENBQUMsZUFBZSxDQUFDLElBQVMsRUFBRSxRQUFhO1FBQ3BELGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7SUFDbEMsQ0FBQztJQUVNLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBVyxFQUFFLElBQVMsRUFBRSxPQUFZO1FBQ3ZELElBQUksY0FBYyxHQUFRLENBQUMsQ0FBQztRQUM1QixJQUFJLE9BQU8sRUFBRTtZQUNYLGNBQWMsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1NBQ2pDO1FBQ0QsSUFBSSxXQUFnQixDQUFDO1FBQ3JCLElBQUksY0FBYyxJQUFJLElBQUksRUFBRTtZQUMxQixXQUFXLEdBQUcsQ0FBQyxDQUFDO1NBQ2pCO2FBQU0sSUFBSSxjQUFjLElBQUksTUFBTSxFQUFFO1lBQ25DLFdBQVcsR0FBRyxDQUFDLENBQUM7U0FDakI7YUFBTSxJQUFJLGNBQWMsSUFBSSxVQUFVLEVBQUU7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QyxhQUFhLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQzthQUM1RDtZQUNELE9BQU8sT0FBTyxDQUFDO1NBQ2hCO1FBRUQsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUM1QixNQUFNLE9BQU8sR0FBUSxFQUFFLENBQUM7WUFDeEIsS0FBSyxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsVUFBVSxFQUFFO2dCQUNuQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2FBQ3RFO1lBRUQsS0FBSyxNQUFNLE9BQU8sSUFBSSxNQUFNLENBQUMsaUJBQWlCLEVBQUU7Z0JBQzlDLE1BQU0sR0FBRyxHQUFRLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNyQyxLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7b0JBQ25DLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTt3QkFDakIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQy9CLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsRUFDakMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUNWLENBQUM7cUJBQ0g7aUJBQ0Y7YUFDRjtZQUNELE9BQU8sT0FBTyxDQUFDO1NBQ2hCO1FBRUQsTUFBTSxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztJQUMxQyxDQUFDO0NBQ0Y7QUE3VEQsNEJBNlRDO0FBRUQsZ0RBQWdEO0FBQ2hELE1BQU0sc0JBQXVCLFNBQVEsS0FBSztDQUN6QyIsImZpbGUiOiJzcmMvb2JuaXovbGlicy93c2NvbW1hbmQvV1NDb21tYW5kLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFdTU2NoZW1hIGZyb20gXCIuL1dTU2NoZW1hXCI7XG5cbmNvbnN0IGNvbW1hbmRDbGFzc2VzOiBhbnkgPSB7fTtcblxuZXhwb3J0IGRlZmF1bHQgYWJzdHJhY3QgY2xhc3MgV1NDb21tYW5kIHtcblxuICBzdGF0aWMgZ2V0IHNjaGVtYSgpIHtcbiAgICByZXR1cm4gV1NTY2hlbWE7XG4gIH1cblxuICBzdGF0aWMgZ2V0IENvbW1hbmRDbGFzc2VzKCkge1xuICAgIHJldHVybiBjb21tYW5kQ2xhc3NlcztcbiAgfVxuXG4gIGdldCBXU0NvbW1hbmROb3RGb3VuZEVycm9yKCkge1xuICAgIHJldHVybiBXU0NvbW1hbmROb3RGb3VuZEVycm9yO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBhZGRDb21tYW5kQ2xhc3MobmFtZTogYW55LCBjbGFzc09iajogYW55KSB7XG4gICAgY29tbWFuZENsYXNzZXNbbmFtZV0gPSBjbGFzc09iajtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZnJhbWVkKG1vZHVsZTogYW55LCBmdW5jOiBhbnksIHBheWxvYWQ6IGFueSk6IFVpbnQ4QXJyYXkge1xuICAgIGxldCBwYXlsb2FkX2xlbmd0aDogYW55ID0gMDtcbiAgICBpZiAocGF5bG9hZCkge1xuICAgICAgcGF5bG9hZF9sZW5ndGggPSBwYXlsb2FkLmxlbmd0aDtcbiAgICB9XG4gICAgbGV0IGxlbmd0aF90eXBlOiBhbnk7XG4gICAgaWYgKHBheWxvYWRfbGVuZ3RoIDw9IDB4M2YpIHtcbiAgICAgIGxlbmd0aF90eXBlID0gMDtcbiAgICB9IGVsc2UgaWYgKHBheWxvYWRfbGVuZ3RoIDw9IDB4M2ZmZikge1xuICAgICAgbGVuZ3RoX3R5cGUgPSAxO1xuICAgIH0gZWxzZSBpZiAocGF5bG9hZF9sZW5ndGggPD0gMHgzZmZmZmZmZikge1xuICAgICAgbGVuZ3RoX3R5cGUgPSAyO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJ0b28gYmlnIHBheWxvYWRcIik7XG4gICAgfVxuICAgIGxldCBsZW5ndGhfZXh0cmFfYnl0c2U6IGFueSA9IGxlbmd0aF90eXBlID09PSAwID8gMCA6IGxlbmd0aF90eXBlID09PSAxID8gMSA6IDM7XG4gICAgY29uc3QgaGVhZGVyX2xlbmd0aDogYW55ID0gMyArIGxlbmd0aF9leHRyYV9ieXRzZTtcbiAgICBjb25zdCByZXN1bHQ6IGFueSA9IG5ldyBVaW50OEFycmF5KGhlYWRlcl9sZW5ndGggKyBwYXlsb2FkX2xlbmd0aCk7XG4gICAgbGV0IGluZGV4OiBhbnkgPSAwO1xuICAgIHJlc3VsdFtpbmRleCsrXSA9IG1vZHVsZSAmIDB4N2Y7XG4gICAgcmVzdWx0W2luZGV4KytdID0gZnVuYztcbiAgICByZXN1bHRbaW5kZXgrK10gPVxuICAgICAgKGxlbmd0aF90eXBlIDw8IDYpIHwgKHBheWxvYWRfbGVuZ3RoID4+IChsZW5ndGhfZXh0cmFfYnl0c2UgKiA4KSk7XG4gICAgd2hpbGUgKGxlbmd0aF9leHRyYV9ieXRzZSA+IDApIHtcbiAgICAgIGxlbmd0aF9leHRyYV9ieXRzZS0tO1xuICAgICAgcmVzdWx0W2luZGV4KytdID0gcGF5bG9hZF9sZW5ndGggPj4gKGxlbmd0aF9leHRyYV9ieXRzZSAqIDgpO1xuICAgIH1cbiAgICBpZiAocGF5bG9hZF9sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdC5zZXQocGF5bG9hZCwgaGVhZGVyX2xlbmd0aCk7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZGVxdWV1ZU9uZShidWY6IGFueSkge1xuICAgIGlmICghYnVmIHx8IGJ1Zi5ieXRlTGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgaWYgKGJ1Zi5ieXRlTGVuZ3RoIDwgMykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwic29tZXRoaW5nIHdyb25nLiBidWYgbGVzcyB0aGFuIDNcIik7XG4gICAgfVxuICAgIGlmIChidWZbMF0gJiAweDgwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJyZXNlcnZlZCBiaXQgMVwiKTtcbiAgICB9XG4gICAgY29uc3QgbW9kdWxlOiBhbnkgPSAweDdmICYgYnVmWzBdO1xuICAgIGNvbnN0IGZ1bmM6IGFueSA9IGJ1ZlsxXTtcbiAgICBjb25zdCBsZW5ndGhfdHlwZTogYW55ID0gKGJ1ZlsyXSA+PiA2KSAmIDB4MztcbiAgICBjb25zdCBsZW5ndGhfZXh0cmFfYnl0c2U6IGFueSA9IGxlbmd0aF90eXBlID09PSAwID8gMCA6IGxlbmd0aF90eXBlID09PSAxID8gMSA6IDM7XG4gICAgaWYgKGxlbmd0aF90eXBlID09PSA0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpbnZhbGlkIGxlbmd0aFwiKTtcbiAgICB9XG4gICAgbGV0IGxlbmd0aDogYW55ID0gKGJ1ZlsyXSAmIDB4M2YpIDw8IChsZW5ndGhfZXh0cmFfYnl0c2UgKiA4KTtcbiAgICBsZXQgaW5kZXg6IGFueSA9IDM7XG4gICAgbGV0IHNoaWZ0OiBhbnkgPSBsZW5ndGhfZXh0cmFfYnl0c2U7XG4gICAgd2hpbGUgKHNoaWZ0ID4gMCkge1xuICAgICAgc2hpZnQtLTtcbiAgICAgIGxlbmd0aCArPSBidWZbaW5kZXhdIDw8IChzaGlmdCAqIDgpO1xuICAgICAgaW5kZXgrKztcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgbW9kdWxlLFxuICAgICAgZnVuYyxcbiAgICAgIHBheWxvYWQ6IGJ1Zi5zbGljZShcbiAgICAgICAgMyArIGxlbmd0aF9leHRyYV9ieXRzZSxcbiAgICAgICAgMyArIGxlbmd0aF9leHRyYV9ieXRzZSArIGxlbmd0aCxcbiAgICAgICksXG4gICAgICBuZXh0OiBidWYuc2xpY2UoMyArIGxlbmd0aF9leHRyYV9ieXRzZSArIGxlbmd0aCksXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgY29tcHJlc3Mod3Njb21tYW5kczogYW55LCBqc29uOiBhbnkpOiBVaW50OEFycmF5IHwgbnVsbCB7XG4gICAgbGV0IHJldDogYW55ID0gbnVsbDtcblxuICAgIGZ1bmN0aW9uIGFwcGVuZChtb2R1bGU6IGFueSwgZnVuYzogYW55LCBwYXlsb2FkOiBhbnkpIHtcbiAgICAgIGNvbnN0IGZyYW1lOiBhbnkgPSBXU0NvbW1hbmQuZnJhbWVkKG1vZHVsZSwgZnVuYywgcGF5bG9hZCk7XG4gICAgICBpZiAocmV0KSB7XG4gICAgICAgIGNvbnN0IGNvbWJpbmVkOiBhbnkgPSBuZXcgVWludDhBcnJheShyZXQubGVuZ3RoICsgZnJhbWUubGVuZ3RoKTtcbiAgICAgICAgY29tYmluZWQuc2V0KHJldCwgMCk7XG4gICAgICAgIGNvbWJpbmVkLnNldChmcmFtZSwgcmV0Lmxlbmd0aCk7XG4gICAgICAgIHJldCA9IGNvbWJpbmVkO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0ID0gZnJhbWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCB3c2NvbW1hbmQgb2Ygd3Njb21tYW5kcykge1xuICAgICAgd3Njb21tYW5kLnBhcnNlZCA9IGFwcGVuZDtcbiAgICAgIHdzY29tbWFuZC5wYXJzZUZyb21Kc29uKGpzb24pO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xuICB9XG5cbiAgcHVibGljIF9odzogYW55O1xuICBwdWJsaWMgaW9Ob3RVc2VkOiBudW1iZXI7XG4gIHB1YmxpYyBDT01NQU5EX0ZVTkNfSURfRVJST1I6IG51bWJlcjtcblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgbW9kdWxlOiBudW1iZXI7XG4gIHByaXZhdGUgcGFyc2VkPzogKG1vZHVsZTogbnVtYmVyLCBmdW5jOiBudW1iZXIsIHBheWxvYWQ6IFVpbnQ4QXJyYXkpID0+IHZvaWQ7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5faHcgPSB7XG4gICAgICBodzogdW5kZWZpbmVkLFxuICAgICAgZmlybXdhcmU6IHVuZGVmaW5lZCxcbiAgICB9O1xuXG4gICAgLy8gY29uc3RhbnRzXG4gICAgdGhpcy5DT01NQU5EX0ZVTkNfSURfRVJST1IgPSAweGZmO1xuICAgIHRoaXMuaW9Ob3RVc2VkID0gMHhmZjtcbiAgfVxuXG4gIHB1YmxpYyBzZXRIdyhvYmo6IGFueSkge1xuICAgIHRoaXMuX2h3ID0gb2JqO1xuICB9XG5cbiAgcHVibGljIHNlbmRDb21tYW5kKGZ1bmM6IGFueSwgcGF5bG9hZDogYW55KSB7XG4gICAgaWYgKHRoaXMucGFyc2VkKSB7XG4gICAgICB0aGlzLnBhcnNlZCh0aGlzLm1vZHVsZSwgZnVuYywgcGF5bG9hZCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHBhcnNlRnJvbUpzb24oanNvbjogYW55KSB7XG4gICAgLy8gYWJzdHJhY3RcbiAgfVxuXG4gIHB1YmxpYyBub3RpZnlGcm9tQmluYXJ5KG9ialRvU2VuZDogYW55LCBmdW5jOiBhbnksIHBheWxvYWQ6IGFueSkge1xuICAgIGlmIChmdW5jID09PSB0aGlzLkNPTU1BTkRfRlVOQ19JRF9FUlJPUikge1xuICAgICAgaWYgKCFvYmpUb1NlbmQuZGVidWcpIHtcbiAgICAgICAgb2JqVG9TZW5kLmRlYnVnID0ge307XG4gICAgICB9XG4gICAgICBjb25zdCBlcnI6IGFueSA9IHtcbiAgICAgICAgbW9kdWxlOiB0aGlzLm1vZHVsZSxcbiAgICAgICAgX2FyZ3M6IFsuLi5wYXlsb2FkXSxcbiAgICAgIH07XG5cbiAgICAgIGlmIChwYXlsb2FkLmJ5dGVMZW5ndGggPT09IDMpIHtcbiAgICAgICAgZXJyLmVycjAgPSBwYXlsb2FkWzBdO1xuICAgICAgICBlcnIuZXJyMSA9IHBheWxvYWRbMV07XG4gICAgICAgIGVyci5mdW5jdGlvbiA9IHBheWxvYWRbMl07XG4gICAgICAgIGVyci5tZXNzYWdlID0gYEVycm9yIG1vZHVsZT0ke3RoaXMubW9kdWxlfSBmdW5jPSR7ZXJyLmZ1bmN0aW9ufSBlcnIwPSR7XG4gICAgICAgICAgZXJyLmVycjBcbiAgICAgICAgfSByZXR1cm5lZD0ke2Vyci5lcnIxfWA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBlcnIubWVzc2FnZSA9IGBFcnJvciBtb2R1bGU9JHt0aGlzLm1vZHVsZX0gd2l0aCArICR7ZXJyLl9hcmdzfWA7XG4gICAgICB9XG4gICAgICBvYmpUb1NlbmQuZGVidWcuZXJyb3IgPSBlcnI7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHVua25vd25cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZW52ZWxvcFdhcm5pbmcob2JqVG9TZW5kOiBhbnksIG1vZHVsZV9rZXk6IGFueSwgb2JqOiBhbnkpIHtcbiAgICBpZiAoIW9ialRvU2VuZFttb2R1bGVfa2V5XSkge1xuICAgICAgb2JqVG9TZW5kW21vZHVsZV9rZXldID0ge307XG4gICAgfVxuICAgIG9ialRvU2VuZFttb2R1bGVfa2V5XS53YXJuaW5nID0gb2JqO1xuICB9XG5cbiAgcHVibGljIGVudmVsb3BFcnJvcihvYmpUb1NlbmQ6IGFueSwgbW9kdWxlX2tleTogYW55LCBvYmo6IGFueSkge1xuICAgIGlmICghb2JqVG9TZW5kW21vZHVsZV9rZXldKSB7XG4gICAgICBvYmpUb1NlbmRbbW9kdWxlX2tleV0gPSB7fTtcbiAgICB9XG4gICAgb2JqVG9TZW5kW21vZHVsZV9rZXldLmVycm9yID0gb2JqO1xuICB9XG5cbiAgcHVibGljIGlzVmFsaWRJTyhpbzogYW55KSB7XG4gICAgcmV0dXJuIHR5cGVvZiBpbyA9PT0gXCJudW1iZXJcIiAmJiAwIDw9IGlvICYmIGlvIDw9IDExO1xuICB9XG5cbiAgcHVibGljIGdldFNjaGVtYSh1cmk6IGFueSkge1xuICAgIC8vIGNoYWNrIGlzRmlyc3RcblxuICAgIHJldHVybiBXU1NjaGVtYS5nZXRTY2hlbWEodXJpKTtcbiAgfVxuXG4gIHB1YmxpYyB2YWxpZGF0ZUNvbW1hbmRTY2hlbWEodXJpTGlzdDogYW55LCBqc29uOiBhbnksIHJvb3RQYXRoOiBhbnksIGN1c3RvbUFyZzogYW55KSB7XG4gICAgY29uc3QgcmVzOiBhbnkgPSB7dmFsaWQ6IDAsIGludmFsaWQ6IDAsIHJlc3VsdHM6IFtdLCBpbnZhbGlkQnV0TGlrZTogW119O1xuICAgIGZvciAoY29uc3Qgb25lUm93IG9mIHVyaUxpc3QpIHtcbiAgICAgIGNvbnN0IGVycm9yczogYW55ID0gdGhpcy52YWxpZGF0ZShvbmVSb3cudXJpLCBqc29uKTtcbiAgICAgIHJlcy5yZXN1bHRzLnB1c2goZXJyb3JzKTtcbiAgICAgIGlmIChlcnJvcnMudmFsaWQpIHtcbiAgICAgICAgcmVzLnZhbGlkKys7XG4gICAgICAgIGlmIChvbmVSb3cub25WYWxpZCkge1xuICAgICAgICAgIG9uZVJvdy5vblZhbGlkLmJpbmQodGhpcykodGhpcy5maWx0ZXIob25lUm93LnVyaSwganNvbiksIGN1c3RvbUFyZyk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcy5pbnZhbGlkKys7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2U6IGFueSA9IHRoaXMub25seVR5cGVFcnJvck1lc3NhZ2UoZXJyb3JzLCByb290UGF0aCk7XG4gICAgICAgIGlmIChtZXNzYWdlKSB7XG4gICAgICAgICAgcmVzLmludmFsaWRCdXRMaWtlLnB1c2goe3VyaTogb25lUm93LnVyaSwgbWVzc2FnZX0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIHB1YmxpYyB2YWxpZGF0ZShjb21tYW5kVXJpOiBhbnksIGpzb246IGFueSk6IFdTU2NoZW1hLk11bHRpUmVzdWx0IHtcbiAgICBjb25zdCBzY2hlbWE6IGFueSA9IHRoaXMuZ2V0U2NoZW1hKGNvbW1hbmRVcmkpO1xuICAgIGNvbnN0IHJlc3VsdHM6IGFueSA9IFdTU2NoZW1hLnZhbGlkYXRlTXVsdGlwbGUoanNvbiwgc2NoZW1hKTtcbiAgICByZXR1cm4gcmVzdWx0cztcbiAgfVxuXG4gIHB1YmxpYyBvbmx5VHlwZUVycm9yTWVzc2FnZSh2YWxpZGF0ZUVycm9yOiBhbnksIHJvb3RQYXRoOiBhbnkpIHtcbiAgICBpZiAodmFsaWRhdGVFcnJvci52YWxpZCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmICh2YWxpZGF0ZUVycm9yLm1pc3NpbmcgJiYgdmFsaWRhdGVFcnJvci5taXNzaW5nLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBiYWRFcnJvckNvZGVzOiBhbnkgPSBbXG4gICAgICBXU1NjaGVtYS5lcnJvckNvZGVzLkFOWV9PRl9NSVNTSU5HLFxuICAgICAgV1NTY2hlbWEuZXJyb3JDb2Rlcy5PTkVfT0ZfTUlTU0lORyxcbiAgICAgIFdTU2NoZW1hLmVycm9yQ29kZXMuT05FX09GX01VTFRJUExFLFxuICAgICAgV1NTY2hlbWEuZXJyb3JDb2Rlcy5OT1RfUEFTU0VELFxuICAgICAgV1NTY2hlbWEuZXJyb3JDb2Rlcy5PQkpFQ1RfUkVRVUlSRUQsXG4gICAgICBXU1NjaGVtYS5lcnJvckNvZGVzLk9CSkVDVF9BRERJVElPTkFMX1BST1BFUlRJRVMsXG4gICAgICBXU1NjaGVtYS5lcnJvckNvZGVzLkNJUkNVTEFSX1JFRkVSRU5DRSxcbiAgICAgIFdTU2NoZW1hLmVycm9yQ29kZXMuRk9STUFUX0NVU1RPTSxcbiAgICAgIFdTU2NoZW1hLmVycm9yQ29kZXMuS0VZV09SRF9DVVNUT00sXG4gICAgICBXU1NjaGVtYS5lcnJvckNvZGVzLlVOS05PV05fUFJPUEVSVFksXG4gICAgXTtcbiAgICBjb25zdCBtZXNzYWdlczogYW55ID0gW107XG4gICAgZm9yIChjb25zdCBlcnJvciBvZiB2YWxpZGF0ZUVycm9yLmVycm9ycykge1xuICAgICAgaWYgKGVycm9yLmNvZGUgPT09IFdTU2NoZW1hLmVycm9yQ29kZXMuSU5WQUxJRF9UWVBFKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAoZXJyb3IgYXMgYW55KS5wYXJhbXMudHlwZSA9PT0gXCJvYmplY3RcIiB8fFxuICAgICAgICAgIChlcnJvciBhcyBhbnkpLnBhcmFtcy5leHBlY3RlZCA9PT0gXCJvYmplY3RcIlxuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoYmFkRXJyb3JDb2Rlcy5pbmNsdWRlcyhlcnJvci5jb2RlKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHBhdGg6IGFueSA9IHJvb3RQYXRoICsgKGVycm9yLmRhdGFQYXRoIHx8IFwiXCIpLnJlcGxhY2UoL1xcLy9nLCBcIi5cIik7XG4gICAgICBtZXNzYWdlcy5wdXNoKGBbJHtwYXRofV0ke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgfVxuICAgIHJldHVybiBtZXNzYWdlcy5qb2luKFwiO1wiKTtcbiAgfVxuXG4gIHB1YmxpYyBmaWx0ZXIoY29tbWFuZFVyaTogYW55LCBqc29uOiBhbnkpIHtcbiAgICBjb25zdCBzY2hlbWE6IGFueSA9IHRoaXMuZ2V0U2NoZW1hKGNvbW1hbmRVcmkpO1xuICAgIHJldHVybiB0aGlzLl9maWx0ZXJTY2hlbWEoc2NoZW1hLCBqc29uKTtcbiAgfVxuXG4gIHB1YmxpYyBfZmlsdGVyU2NoZW1hKHNjaGVtYTogYW55LCBqc29uOiBhbnkpOiBhbnkge1xuICAgIGlmIChzY2hlbWEuJHJlZikge1xuICAgICAgY29uc3QgcmVmU2NoZW1hOiBhbnkgPSBXU1NjaGVtYS5nZXRTY2hlbWEoc2NoZW1hLiRyZWYpO1xuICAgICAgcmV0dXJuIHRoaXMuX2ZpbHRlclNjaGVtYShyZWZTY2hlbWEsIGpzb24pO1xuICAgIH1cblxuICAgIGlmIChqc29uID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBzY2hlbWEuZGVmYXVsdDtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICBzY2hlbWEudHlwZSA9PT0gXCJzdHJpbmdcIiB8fFxuICAgICAgc2NoZW1hLnR5cGUgPT09IFwiaW50ZWdlclwiIHx8XG4gICAgICBzY2hlbWEudHlwZSA9PT0gXCJib29sZWFuXCIgfHxcbiAgICAgIHNjaGVtYS50eXBlID09PSBcIm51bWJlclwiIHx8XG4gICAgICBzY2hlbWEudHlwZSA9PT0gXCJudWxsXCIgfHxcbiAgICAgIHNjaGVtYS5maWx0ZXIgPT09IFwicGFzc19hbGxcIlxuICAgICkge1xuICAgICAgcmV0dXJuIGpzb247XG4gICAgfVxuXG4gICAgaWYgKHNjaGVtYS50eXBlID09PSBcImFycmF5XCIpIHtcbiAgICAgIGNvbnN0IHJlc3VsdHM6IGFueSA9IFtdO1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4ganNvbikge1xuICAgICAgICByZXN1bHRzW2tleV0gPSB0aGlzLl9maWx0ZXJTY2hlbWEoc2NoZW1hLml0ZW1zLCBqc29uW2tleV0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgfVxuXG4gICAgaWYgKHNjaGVtYS50eXBlID09PSBcIm9iamVjdFwiKSB7XG4gICAgICBjb25zdCByZXN1bHRzOiBhbnkgPSB7fTtcbiAgICAgIGZvciAoY29uc3Qga2V5IGluIHNjaGVtYS5wcm9wZXJ0aWVzKSB7XG4gICAgICAgIHJlc3VsdHNba2V5XSA9IHRoaXMuX2ZpbHRlclNjaGVtYShzY2hlbWEucHJvcGVydGllc1trZXldLCBqc29uW2tleV0pO1xuICAgICAgfVxuXG4gICAgICBmb3IgKGNvbnN0IHBhdHRlcm4gaW4gc2NoZW1hLnBhdHRlcm5Qcm9wZXJ0aWVzKSB7XG4gICAgICAgIGNvbnN0IHJlZzogYW55ID0gbmV3IFJlZ0V4cChwYXR0ZXJuKTtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoanNvbikpIHtcbiAgICAgICAgICBpZiAocmVnLnRlc3Qoa2V5KSkge1xuICAgICAgICAgICAgcmVzdWx0c1trZXldID0gdGhpcy5fZmlsdGVyU2NoZW1hKFxuICAgICAgICAgICAgICBzY2hlbWEucGF0dGVyblByb3BlcnRpZXNbcGF0dGVybl0sXG4gICAgICAgICAgICAgIGpzb25ba2V5XSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0cztcbiAgICB9XG5cbiAgICB0aHJvdyBFcnJvcihcInVua25vd24ganNvbiBzY2hlbWEgdHlwZVwiKTtcbiAgfVxufVxuXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWNsYXNzZXMtcGVyLWZpbGVcbmNsYXNzIFdTQ29tbWFuZE5vdEZvdW5kRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG59XG4iXX0=

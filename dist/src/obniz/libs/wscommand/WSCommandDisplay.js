"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const qr_1 = __importDefault(require("../utils/qr"));
const WSCommand_1 = __importDefault(require("./WSCommand"));
class WSCommandDisplay extends WSCommand_1.default {
    constructor() {
        super();
        this.module = 8;
        this._CommandClear = 0;
        this._CommandPrint = 1;
        this._CommandDrawCampusVerticalBytes = 2;
        this._CommandDrawCampusHorizonalBytes = 3;
        this._CommandDrawIOState = 4;
        this._CommandSetPinName = 5;
    }
    // Commands
    clear(params) {
        this.sendCommand(this._CommandClear, null);
    }
    print(buf) {
        this.sendCommand(this._CommandPrint, buf);
    }
    printText(text) {
        let result;
        const buf = Buffer.from(text, "utf8");
        result = new Uint8Array(buf);
        this.print(result);
    }
    text(params) {
        this.printText(params.text);
    }
    raw(params) {
        this.drawHorizonally(new Uint8Array(params.raw));
    }
    qr(params) {
        const text = params.qr.text;
        const correctionLevel = params.qr.correction || "M";
        const typeNumber = 0; // auto detect type.
        const qr = qr_1.default(typeNumber, correctionLevel);
        qr.addData(text);
        qr.make();
        let size = qr.getModuleCount();
        if (size) {
            size *= 2;
            const modules = qr.getModules();
            const vram = new Uint8Array(1024);
            vram.fill(0);
            for (let row = 0; row < 2; row++) {
                for (let col = 0; col < size + 4; col++) {
                    vram[Math.floor(row * 16 + col / 8)] |= 0x80 >> col % 8;
                    vram[Math.floor((row + size + 2) * 16 + col / 8)] |= 0x80 >> col % 8;
                }
            }
            for (let row = 2; row < size + 2; row++) {
                for (let col = 0; col < 2; col++) {
                    vram[Math.floor(row * 16 + col / 8)] |= 0x80 >> col % 8;
                }
                for (let col = size + 2; col < size + 4; col++) {
                    vram[Math.floor(row * 16 + col / 8)] |= 0x80 >> col % 8;
                }
            }
            for (let row = 0; row < size; row++) {
                for (let col = 0; col < size; col++) {
                    if (!modules[Math.floor(row / 2)][Math.floor(col / 2)]) {
                        vram[Math.floor((row + 2) * 16 + (col + 2) / 8)] |=
                            0x80 >> (col + 2) % 8;
                    }
                }
            }
            this.drawHorizonally(vram);
        }
    }
    pinName(params) {
        for (let i = 0; i < 40; i++) {
            if (typeof params.pin_assign[i] === "object") {
                this.setPinName(i, params.pin_assign[i].module_name || "?", params.pin_assign[i].pin_name || "?");
            }
        }
    }
    drawVertically(buf) {
        this.sendCommand(this._CommandDrawCampusVerticalBytes, buf);
    }
    drawHorizonally(buf) {
        this.sendCommand(this._CommandDrawCampusHorizonalBytes, buf);
    }
    drawIOState(val) {
        const buf = new Uint8Array([!val ? 1 : 0]);
        this.sendCommand(this._CommandDrawIOState, buf);
    }
    setPinName(no, moduleName, pinName) {
        let str = moduleName.slice(0, 4) + " " + pinName;
        str = str.slice(0, 9);
        const buf = new Uint8Array(1);
        buf[0] = no;
        const stringarray = new Uint8Array(Buffer.from(str, "utf8"));
        const combined = new Uint8Array(buf.length + stringarray.length);
        combined.set(buf, 0);
        combined.set(stringarray, 1);
        this.sendCommand(this._CommandSetPinName, combined);
    }
    parseFromJson(json) {
        const module = json.display;
        if (module === undefined) {
            return;
        }
        const schemaData = [
            { uri: "/request/display/clear", onValid: this.clear },
            { uri: "/request/display/text", onValid: this.text },
            { uri: "/request/display/raw", onValid: this.raw },
            { uri: "/request/display/pin_assign", onValid: this.pinName },
            { uri: "/request/display/qr", onValid: this.qr },
        ];
        const res = this.validateCommandSchema(schemaData, module, "display");
        if (res.valid === 0) {
            if (res.invalidButLike.length > 0) {
                throw new Error(res.invalidButLike[0].message);
            }
            else {
                throw new this.WSCommandNotFoundError(`[display]unknown command`);
            }
        }
    }
}
exports.default = WSCommandDisplay;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmREaXNwbGF5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEscURBQWlDO0FBQ2pDLDREQUFvQztBQUVwQyxNQUFNLGdCQUFpQixTQUFRLG1CQUFTO0lBWXRDO1FBQ0UsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUVoQixJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsK0JBQStCLEdBQUcsQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxnQ0FBZ0MsR0FBRyxDQUFDLENBQUM7UUFDMUMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsa0JBQWtCLEdBQUcsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxXQUFXO0lBRUosS0FBSyxDQUFDLE1BQVc7UUFDdEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFTSxLQUFLLENBQUMsR0FBUTtRQUNuQixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVNLFNBQVMsQ0FBQyxJQUFTO1FBQ3hCLElBQUksTUFBVyxDQUFDO1FBQ2hCLE1BQU0sR0FBRyxHQUFRLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzNDLE1BQU0sR0FBRyxJQUFJLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3JCLENBQUM7SUFFTSxJQUFJLENBQUMsTUFBVztRQUNyQixJQUFJLENBQUMsU0FBUyxDQUFDLE1B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QXdCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUM7WUFDcEQsRUFBQyxHQUFHLEVBQUUsdUJBQXVCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUM7WUFDbEQsRUFBQyxHQUFHLEVBQUUsc0JBQXNCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUM7WUFDaEQsRUFBQyxHQUFHLEVBQUUsNkJBQTZCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUM7WUFDM0QsRUFBQyxHQUFHLEVBQUUscUJBQXFCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUM7U0FDL0MsQ0FBQztRQUNGLE1BQU0sR0FBRyxHQUFRLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRTNFLElBQUksR0FBRyxDQUFDLEtBQUssS0FBSyxDQUFDLEVBQUU7WUFDbkIsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ2pDLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUNoRDtpQkFBTTtnQkFDTCxNQUFNLElBQUksSUFBSSxDQUFDLHNCQUFzQixDQUFDLDBCQUEwQixDQUFDLENBQUM7YUFDbkU7U0FDRjtJQUNILENBQUM7Q0FDRjtBQUVELGtCQUFlLGdCQUFnQixDQUFDIiwiZmlsZSI6InNyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmREaXNwbGF5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHFyY29kZSBmcm9tIFwiLi4vdXRpbHMvcXJcIjtcbmltcG9ydCBXU0NvbW1hbmQgZnJvbSBcIi4vV1NDb21tYW5kXCI7XG5cbmNsYXNzIFdTQ29tbWFuZERpc3BsYXkgZXh0ZW5kcyBXU0NvbW1hbmQge1xuICBwdWJsaWMgbW9kdWxlOiBhbnk7XG4gIHB1YmxpYyBfQ29tbWFuZENsZWFyOiBhbnk7XG4gIHB1YmxpYyBfQ29tbWFuZFByaW50OiBhbnk7XG4gIHB1YmxpYyBfQ29tbWFuZERyYXdDYW1wdXNWZXJ0aWNhbEJ5dGVzOiBhbnk7XG4gIHB1YmxpYyBfQ29tbWFuZERyYXdDYW1wdXNIb3Jpem9uYWxCeXRlczogYW55O1xuICBwdWJsaWMgX0NvbW1hbmREcmF3SU9TdGF0ZTogYW55O1xuICBwdWJsaWMgX0NvbW1hbmRTZXRQaW5OYW1lOiBhbnk7XG4gIHB1YmxpYyBzZW5kQ29tbWFuZDogYW55O1xuICBwdWJsaWMgdmFsaWRhdGVDb21tYW5kU2NoZW1hOiBhbnk7XG4gIHB1YmxpYyBXU0NvbW1hbmROb3RGb3VuZEVycm9yOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLm1vZHVsZSA9IDg7XG5cbiAgICB0aGlzLl9Db21tYW5kQ2xlYXIgPSAwO1xuICAgIHRoaXMuX0NvbW1hbmRQcmludCA9IDE7XG4gICAgdGhpcy5fQ29tbWFuZERyYXdDYW1wdXNWZXJ0aWNhbEJ5dGVzID0gMjtcbiAgICB0aGlzLl9Db21tYW5kRHJhd0NhbXB1c0hvcml6b25hbEJ5dGVzID0gMztcbiAgICB0aGlzLl9Db21tYW5kRHJhd0lPU3RhdGUgPSA0O1xuICAgIHRoaXMuX0NvbW1hbmRTZXRQaW5OYW1lID0gNTtcbiAgfVxuXG4gIC8vIENvbW1hbmRzXG5cbiAgcHVibGljIGNsZWFyKHBhcmFtczogYW55KSB7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kQ2xlYXIsIG51bGwpO1xuICB9XG5cbiAgcHVibGljIHByaW50KGJ1ZjogYW55KSB7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kUHJpbnQsIGJ1Zik7XG4gIH1cblxuICBwdWJsaWMgcHJpbnRUZXh0KHRleHQ6IGFueSkge1xuICAgIGxldCByZXN1bHQ6IGFueTtcbiAgICBjb25zdCBidWY6IGFueSA9IEJ1ZmZlci5mcm9tKHRleHQsIFwidXRmOFwiKTtcbiAgICByZXN1bHQgPSBuZXcgVWludDhBcnJheShidWYpO1xuICAgIHRoaXMucHJpbnQocmVzdWx0KTtcbiAgfVxuXG4gIHB1YmxpYyB0ZXh0KHBhcmFtczogYW55KSB7XG4gICAgdGhpcy5wcmludFRleHQocGFyYW1zLnRleHQpO1xuICB9XG5cbiAgcHVibGljIHJhdyhwYXJhbXM6IGFueSkge1xuICAgIHRoaXMuZHJhd0hvcml6b25hbGx5KG5ldyBVaW50OEFycmF5KHBhcmFtcy5yYXcpKTtcbiAgfVxuXG4gIHB1YmxpYyBxcihwYXJhbXM6IGFueSkge1xuICAgIGNvbnN0IHRleHQ6IGFueSA9IHBhcmFtcy5xci50ZXh0O1xuICAgIGNvbnN0IGNvcnJlY3Rpb25MZXZlbDogYW55ID0gcGFyYW1zLnFyLmNvcnJlY3Rpb24gfHwgXCJNXCI7XG5cbiAgICBjb25zdCB0eXBlTnVtYmVyOiBhbnkgPSAwOyAvLyBhdXRvIGRldGVjdCB0eXBlLlxuICAgIGNvbnN0IHFyOiBhbnkgPSBxcmNvZGUodHlwZU51bWJlciwgY29ycmVjdGlvbkxldmVsKTtcbiAgICBxci5hZGREYXRhKHRleHQpO1xuICAgIHFyLm1ha2UoKTtcbiAgICBsZXQgc2l6ZTogYW55ID0gcXIuZ2V0TW9kdWxlQ291bnQoKTtcbiAgICBpZiAoc2l6ZSkge1xuICAgICAgc2l6ZSAqPSAyO1xuICAgICAgY29uc3QgbW9kdWxlczogYW55ID0gcXIuZ2V0TW9kdWxlcygpO1xuICAgICAgY29uc3QgdnJhbTogYW55ID0gbmV3IFVpbnQ4QXJyYXkoMTAyNCk7XG4gICAgICB2cmFtLmZpbGwoMCk7XG5cbiAgICAgIGZvciAobGV0IHJvdyA9IDA7IHJvdyA8IDI7IHJvdysrKSB7XG4gICAgICAgIGZvciAobGV0IGNvbCA9IDA7IGNvbCA8IHNpemUgKyA0OyBjb2wrKykge1xuICAgICAgICAgIHZyYW1bTWF0aC5mbG9vcihyb3cgKiAxNiArIGNvbCAvIDgpXSB8PSAweDgwID4+IGNvbCAlIDg7XG4gICAgICAgICAgdnJhbVtNYXRoLmZsb29yKChyb3cgKyBzaXplICsgMikgKiAxNiArIGNvbCAvIDgpXSB8PSAweDgwID4+IGNvbCAlIDg7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGZvciAobGV0IHJvdyA9IDI7IHJvdyA8IHNpemUgKyAyOyByb3crKykge1xuICAgICAgICBmb3IgKGxldCBjb2wgPSAwOyBjb2wgPCAyOyBjb2wrKykge1xuICAgICAgICAgIHZyYW1bTWF0aC5mbG9vcihyb3cgKiAxNiArIGNvbCAvIDgpXSB8PSAweDgwID4+IGNvbCAlIDg7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChsZXQgY29sID0gc2l6ZSArIDI7IGNvbCA8IHNpemUgKyA0OyBjb2wrKykge1xuICAgICAgICAgIHZyYW1bTWF0aC5mbG9vcihyb3cgKiAxNiArIGNvbCAvIDgpXSB8PSAweDgwID4+IGNvbCAlIDg7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgZm9yIChsZXQgcm93ID0gMDsgcm93IDwgc2l6ZTsgcm93KyspIHtcbiAgICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgc2l6ZTsgY29sKyspIHtcbiAgICAgICAgICBpZiAoIW1vZHVsZXNbTWF0aC5mbG9vcihyb3cgLyAyKV1bTWF0aC5mbG9vcihjb2wgLyAyKV0pIHtcbiAgICAgICAgICAgIHZyYW1bTWF0aC5mbG9vcigocm93ICsgMikgKiAxNiArIChjb2wgKyAyKSAvIDgpXSB8PVxuICAgICAgICAgICAgICAweDgwID4+IChjb2wgKyAyKSAlIDg7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLmRyYXdIb3Jpem9uYWxseSh2cmFtKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcGluTmFtZShwYXJhbXM6IGFueSkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDA7IGkrKykge1xuICAgICAgaWYgKHR5cGVvZiBwYXJhbXMucGluX2Fzc2lnbltpXSA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICB0aGlzLnNldFBpbk5hbWUoXG4gICAgICAgICAgaSxcbiAgICAgICAgICBwYXJhbXMucGluX2Fzc2lnbltpXS5tb2R1bGVfbmFtZSB8fCBcIj9cIixcbiAgICAgICAgICBwYXJhbXMucGluX2Fzc2lnbltpXS5waW5fbmFtZSB8fCBcIj9cIixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZHJhd1ZlcnRpY2FsbHkoYnVmOiBhbnkpIHtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmREcmF3Q2FtcHVzVmVydGljYWxCeXRlcywgYnVmKTtcbiAgfVxuXG4gIHB1YmxpYyBkcmF3SG9yaXpvbmFsbHkoYnVmOiBhbnkpIHtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmREcmF3Q2FtcHVzSG9yaXpvbmFsQnl0ZXMsIGJ1Zik7XG4gIH1cblxuICBwdWJsaWMgZHJhd0lPU3RhdGUodmFsOiBib29sZWFuKSB7XG4gICAgY29uc3QgYnVmOiBhbnkgPSBuZXcgVWludDhBcnJheShbIXZhbCA/IDEgOiAwXSk7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kRHJhd0lPU3RhdGUsIGJ1Zik7XG4gIH1cblxuICBwdWJsaWMgc2V0UGluTmFtZShubzogYW55LCBtb2R1bGVOYW1lOiBhbnksIHBpbk5hbWU6IGFueSkge1xuICAgIGxldCBzdHI6IGFueSA9IG1vZHVsZU5hbWUuc2xpY2UoMCwgNCkgKyBcIiBcIiArIHBpbk5hbWU7XG4gICAgc3RyID0gc3RyLnNsaWNlKDAsIDkpO1xuXG4gICAgY29uc3QgYnVmOiBhbnkgPSBuZXcgVWludDhBcnJheSgxKTtcbiAgICBidWZbMF0gPSBubztcblxuICAgIGNvbnN0IHN0cmluZ2FycmF5OiBhbnkgPSBuZXcgVWludDhBcnJheShCdWZmZXIuZnJvbShzdHIsIFwidXRmOFwiKSk7XG4gICAgY29uc3QgY29tYmluZWQ6IGFueSA9IG5ldyBVaW50OEFycmF5KGJ1Zi5sZW5ndGggKyBzdHJpbmdhcnJheS5sZW5ndGgpO1xuICAgIGNvbWJpbmVkLnNldChidWYsIDApO1xuICAgIGNvbWJpbmVkLnNldChzdHJpbmdhcnJheSwgMSk7XG5cbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRTZXRQaW5OYW1lLCBjb21iaW5lZCk7XG4gIH1cblxuICBwdWJsaWMgcGFyc2VGcm9tSnNvbihqc29uOiBhbnkpIHtcbiAgICBjb25zdCBtb2R1bGU6IGFueSA9IGpzb24uZGlzcGxheTtcbiAgICBpZiAobW9kdWxlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBzY2hlbWFEYXRhOiBhbnkgPSBbXG4gICAgICB7dXJpOiBcIi9yZXF1ZXN0L2Rpc3BsYXkvY2xlYXJcIiwgb25WYWxpZDogdGhpcy5jbGVhcn0sXG4gICAgICB7dXJpOiBcIi9yZXF1ZXN0L2Rpc3BsYXkvdGV4dFwiLCBvblZhbGlkOiB0aGlzLnRleHR9LFxuICAgICAge3VyaTogXCIvcmVxdWVzdC9kaXNwbGF5L3Jhd1wiLCBvblZhbGlkOiB0aGlzLnJhd30sXG4gICAgICB7dXJpOiBcIi9yZXF1ZXN0L2Rpc3BsYXkvcGluX2Fzc2lnblwiLCBvblZhbGlkOiB0aGlzLnBpbk5hbWV9LFxuICAgICAge3VyaTogXCIvcmVxdWVzdC9kaXNwbGF5L3FyXCIsIG9uVmFsaWQ6IHRoaXMucXJ9LFxuICAgIF07XG4gICAgY29uc3QgcmVzOiBhbnkgPSB0aGlzLnZhbGlkYXRlQ29tbWFuZFNjaGVtYShzY2hlbWFEYXRhLCBtb2R1bGUsIFwiZGlzcGxheVwiKTtcblxuICAgIGlmIChyZXMudmFsaWQgPT09IDApIHtcbiAgICAgIGlmIChyZXMuaW52YWxpZEJ1dExpa2UubGVuZ3RoID4gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVzLmludmFsaWRCdXRMaWtlWzBdLm1lc3NhZ2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IHRoaXMuV1NDb21tYW5kTm90Rm91bmRFcnJvcihgW2Rpc3BsYXlddW5rbm93biBjb21tYW5kYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFdTQ29tbWFuZERpc3BsYXk7XG4iXX0=

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class JsonBinaryConverter {
    static convertFromBinaryToJson(schema, binary) {
        const types = {
            "hex": this.hexFromBinary.bind(this),
            "uuid": this.uuidFromBinary.bind(this),
            "number": this.numberFromBinary.bind(this),
            "signed number": this.signedNumberFromBinary.bind(this),
            "int": this.numberFromBinary.bind(this),
            "char": this.numberFromBinary.bind(this),
            "enum": this.enumFromBinary.bind(this),
            "dataArray": this.dataArrayFromBinary.bind(this),
        };
        const json = {};
        let count = 0;
        for (let i = 0; i < schema.length; i++) {
            const data = binary.slice(count, schema[i].length ? count + schema[i].length : undefined);
            json[schema[i].name] = types[schema[i].type](data, schema[i]);
            if (schema[i].length) {
                count += schema[i].length;
            }
            else {
                break;
            }
        }
        return json;
    }
    static hexFromBinary(data, schema) {
        let str = "";
        for (let i = 0; i < data.length; i++) {
            if (schema.endianness && schema.endianness === "little") {
                str = ("00" + data[i].toString(16)).slice(-2) + str;
            }
            else {
                str = str + ("00" + data[i].toString(16)).slice(-2);
            }
        }
        return str;
    }
    static uuidFromBinary(data) {
        const len = data[0] * 16 + data[1];
        if (len === 0) {
            return null;
        }
        const uuidData = data.slice(2);
        let str = "";
        for (let i = 0; i < len; i++) {
            str = ("00" + uuidData[i].toString(16)).slice(-2) + str;
        }
        return str;
    }
    static signedNumberFromBinary(data) {
        // big adian
        let val = data[0] & 0x7f;
        for (let i = 1; i < data.length; i++) {
            val = val * 256 + data[i];
        }
        if ((data[0] & 0x80) !== 0) {
            val = val - Math.pow(2, data.length * 8 - 1);
        }
        return val;
    }
    static numberFromBinary(data) {
        // big adian
        let val = 0;
        for (let i = 0; i < data.length; i++) {
            val = val * 256 + data[i];
        }
        return val;
    }
    static keyForVal(enumvals, val) {
        return Object.keys(enumvals).filter((k) => {
            return enumvals[k] === val;
        })[0];
    }
    static enumFromBinary(data, schema) {
        const enumVals = schema.enum;
        let val = this.numberFromBinary(data);
        if (schema.flags === true) {
            const temp = [];
            for (const key of Object.keys(enumVals)) {
                const flag = enumVals[key] & val;
                if (flag) {
                    temp.push(key);
                }
            }
            val = temp;
        }
        else {
            const tmp = this.keyForVal(enumVals, val);
            if (tmp) {
                val = tmp;
            }
        }
        return val;
    }
    static dataArrayFromBinary(data) {
        const arr = new Array(data.length);
        for (let i = 0; i < data.length; i++) {
            arr[i] = data[i];
        }
        return arr;
    }
    static createSendBuffer(schema, data) {
        const array = [];
        for (let i = 0; i < schema.length; i++) {
            const schemaRow = schema[i];
            let row;
            if (Array.isArray(schemaRow)) {
                for (const key in schemaRow) {
                    const customSchemaRow = Object.assign({}, schemaRow[key], {
                        required: true,
                    });
                    row = this.analyzeSchema(data, customSchemaRow);
                    if (row) {
                        break;
                    }
                }
            }
            else {
                row = this.analyzeSchema(data, schemaRow);
            }
            Array.prototype.push.apply(array, row);
        }
        return new Uint8Array(array);
    }
    static analyzeSchema(allData, schemaRow) {
        const types = {
            hex: this.hexToBinary.bind(this),
            uuid: this.uuidToBinary.bind(this),
            int: this.intToBinary.bind(this),
            char: this.charToBinary.bind(this),
            dataArray: this.dataArrayToBinary.bind(this),
            enum: this.enumToBinary.bind(this),
            string: this.stringToBinary.bind(this),
            text: this.stringToBinary.bind(this),
            flag: this.flagToBinary.bind(this),
        };
        let val;
        if (schemaRow.path) {
            val = this.getProperty(allData, schemaRow.path);
        }
        if (val === undefined && schemaRow.required) {
            return null;
        }
        if (val === undefined && schemaRow.default) {
            val = schemaRow.default;
        }
        const row = types[schemaRow.type](val, schemaRow);
        if (schemaRow.length && row.length !== schemaRow.length) {
            console.log("JSON->BINARY SCHEMA ERROR: (", val, ")", schemaRow);
        }
        return row;
    }
    static getProperty(object, path) {
        if (path === "" || path === undefined) {
            return object;
        }
        if (typeof path === "string") {
            path = path.split(".");
        }
        if (!Array.isArray(path)) {
            path = [path];
        }
        let index = 0;
        const length = path.length;
        while (index < length) {
            object = object[path[index++]];
            if (object === undefined) {
                return undefined;
            }
        }
        return index && index === length ? object : undefined;
    }
    static hexToBinary(data, schema) {
        const array = [];
        const hex = data.toLowerCase().replace(/[^0-9abcdef]/g, "");
        for (let i = 0; i < hex.length / 2; i++) {
            array[i] = parseInt(hex[i * 2] + hex[i * 2 + 1], 16);
        }
        if (schema && schema.endianness && schema.endianness === "little") {
            array.reverse();
        }
        return array;
    }
    static intToBinary(data) {
        const array = [];
        array[0] = (data >> (8 * 3)) & 0xff;
        array[1] = (data >> (8 * 2)) & 0xff;
        array[2] = (data >> (8 * 1)) & 0xff;
        array[3] = (data >> (8 * 0)) & 0xff;
        return array;
    }
    static charToBinary(data) {
        const array = [];
        array[0] = data & 0xff;
        return array;
    }
    static dataArrayToBinary(data) {
        if (!Array.isArray(data)) {
            data = [data];
        }
        return data;
    }
    static uuidToBinary(data) {
        const uuid = this.hexToBinary(data);
        uuid.reverse(); // big endianness -> little endianness;
        const length = uuid.length;
        const array = [];
        array[0] = (length >> (8 * 1)) & 0xff;
        array[1] = (length >> (8 * 0)) & 0xff;
        Array.prototype.push.apply(array, uuid);
        for (let i = array.length; i < 16 + 2; i++) {
            array[i] = 0;
        }
        return array;
    }
    static enumToBinary(data, schema) {
        const array = [];
        array.push(schema.enum[data]);
        return array;
    }
    static flagToBinary(data, schema) {
        if (!Array.isArray(data)) {
            data = [data];
        }
        const flags = schema.flags;
        let value = 0;
        for (const key in flags) {
            if (data.includes(flags[key])) {
                value += parseInt(key);
            }
        }
        const array = [];
        const length = schema.length || 1;
        for (let i = length - 1; i >= 0; i--) {
            array.push((value >> (i * 8)) & 0xff);
        }
        return array;
    }
    static stringToBinary(data) {
        return new Uint8Array(Buffer.from(data, "utf8"));
    }
}
exports.default = JsonBinaryConverter;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9qc29uQmluYXJ5Q29udmVydGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTSxtQkFBbUI7SUFDaEIsTUFBTSxDQUFDLHVCQUF1QixDQUFDLE1BQVcsRUFBRSxNQUFXO1FBQzVELE1BQU0sS0FBSyxHQUFRO1lBQ2pCLEtBQUssRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDcEMsTUFBTSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztZQUN0QyxRQUFRLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDMUMsZUFBZSxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ3ZELEtBQUssRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztZQUN2QyxNQUFNLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDeEMsTUFBTSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztZQUN0QyxXQUFXLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7U0FDakQsQ0FBQztRQUNGLE1BQU0sSUFBSSxHQUFRLEVBQUUsQ0FBQztRQUNyQixJQUFJLEtBQUssR0FBUSxDQUFDLENBQUM7UUFDbkIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDdEMsTUFBTSxJQUFJLEdBQVEsTUFBTSxDQUFDLEtBQUssQ0FDNUIsS0FBSyxFQUNMLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FB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SUFBSSxDQUFDLENBQUM7UUFDdkMsS0FBSyxJQUFJLENBQUMsR0FBRyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDcEMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1NBQ3ZDO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRU0sTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFTO1FBQ3BDLE9BQU8sSUFBSSxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNuRCxDQUFDO0NBQ0Y7QUFFRCxrQkFBZSxtQkFBbUIsQ0FBQyIsImZpbGUiOiJzcmMvb2JuaXovbGlicy93c2NvbW1hbmQvanNvbkJpbmFyeUNvbnZlcnRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIEpzb25CaW5hcnlDb252ZXJ0ZXIge1xuICBwdWJsaWMgc3RhdGljIGNvbnZlcnRGcm9tQmluYXJ5VG9Kc29uKHNjaGVtYTogYW55LCBiaW5hcnk6IGFueSkge1xuICAgIGNvbnN0IHR5cGVzOiBhbnkgPSB7XG4gICAgICBcImhleFwiOiB0aGlzLmhleEZyb21CaW5hcnkuYmluZCh0aGlzKSxcbiAgICAgIFwidXVpZFwiOiB0aGlzLnV1aWRGcm9tQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICBcIm51bWJlclwiOiB0aGlzLm51bWJlckZyb21CaW5hcnkuYmluZCh0aGlzKSxcbiAgICAgIFwic2lnbmVkIG51bWJlclwiOiB0aGlzLnNpZ25lZE51bWJlckZyb21CaW5hcnkuYmluZCh0aGlzKSxcbiAgICAgIFwiaW50XCI6IHRoaXMubnVtYmVyRnJvbUJpbmFyeS5iaW5kKHRoaXMpLFxuICAgICAgXCJjaGFyXCI6IHRoaXMubnVtYmVyRnJvbUJpbmFyeS5iaW5kKHRoaXMpLFxuICAgICAgXCJlbnVtXCI6IHRoaXMuZW51bUZyb21CaW5hcnkuYmluZCh0aGlzKSxcbiAgICAgIFwiZGF0YUFycmF5XCI6IHRoaXMuZGF0YUFycmF5RnJvbUJpbmFyeS5iaW5kKHRoaXMpLFxuICAgIH07XG4gICAgY29uc3QganNvbjogYW55ID0ge307XG4gICAgbGV0IGNvdW50OiBhbnkgPSAwO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2NoZW1hLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBkYXRhOiBhbnkgPSBiaW5hcnkuc2xpY2UoXG4gICAgICAgIGNvdW50LFxuICAgICAgICBzY2hlbWFbaV0ubGVuZ3RoID8gY291bnQgKyBzY2hlbWFbaV0ubGVuZ3RoIDogdW5kZWZpbmVkLFxuICAgICAgKTtcbiAgICAgIGpzb25bc2NoZW1hW2ldLm5hbWVdID0gdHlwZXNbc2NoZW1hW2ldLnR5cGVdKGRhdGEsIHNjaGVtYVtpXSk7XG5cbiAgICAgIGlmIChzY2hlbWFbaV0ubGVuZ3RoKSB7XG4gICAgICAgIGNvdW50ICs9IHNjaGVtYVtpXS5sZW5ndGg7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGpzb247XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGhleEZyb21CaW5hcnkoZGF0YTogYW55LCBzY2hlbWE/OiBhbnkpIHtcbiAgICBsZXQgc3RyOiBhbnkgPSBcIlwiO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKHNjaGVtYS5lbmRpYW5uZXNzICYmIHNjaGVtYS5lbmRpYW5uZXNzID09PSBcImxpdHRsZVwiKSB7XG4gICAgICAgIHN0ciA9IChcIjAwXCIgKyBkYXRhW2ldLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTIpICsgc3RyO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3RyID0gc3RyICsgKFwiMDBcIiArIGRhdGFbaV0udG9TdHJpbmcoMTYpKS5zbGljZSgtMik7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzdHI7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHV1aWRGcm9tQmluYXJ5KGRhdGE6IGFueSkge1xuICAgIGNvbnN0IGxlbjogYW55ID0gZGF0YVswXSAqIDE2ICsgZGF0YVsxXTtcbiAgICBpZiAobGVuID09PSAwKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgdXVpZERhdGE6IGFueSA9IGRhdGEuc2xpY2UoMik7XG4gICAgbGV0IHN0cjogYW55ID0gXCJcIjtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBzdHIgPSAoXCIwMFwiICsgdXVpZERhdGFbaV0udG9TdHJpbmcoMTYpKS5zbGljZSgtMikgKyBzdHI7XG4gICAgfVxuICAgIHJldHVybiBzdHI7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHNpZ25lZE51bWJlckZyb21CaW5hcnkoZGF0YTogYW55KSB7XG4gICAgLy8gYmlnIGFkaWFuXG4gICAgbGV0IHZhbDogYW55ID0gZGF0YVswXSAmIDB4N2Y7XG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICB2YWwgPSB2YWwgKiAyNTYgKyBkYXRhW2ldO1xuICAgIH1cbiAgICBpZiAoKGRhdGFbMF0gJiAweDgwKSAhPT0gMCkge1xuICAgICAgdmFsID0gdmFsIC0gTWF0aC5wb3coMiwgZGF0YS5sZW5ndGggKiA4IC0gMSk7XG4gICAgfVxuICAgIHJldHVybiB2YWw7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIG51bWJlckZyb21CaW5hcnkoZGF0YTogYW55KSB7XG4gICAgLy8gYmlnIGFkaWFuXG4gICAgbGV0IHZhbDogYW55ID0gMDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIHZhbCA9IHZhbCAqIDI1NiArIGRhdGFbaV07XG4gICAgfVxuICAgIHJldHVybiB2YWw7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGtleUZvclZhbChlbnVtdmFsczogYW55LCB2YWw6IGFueSkge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhlbnVtdmFscykuZmlsdGVyICgoazogYW55ICkgPT4ge1xuICAgICAgcmV0dXJuIGVudW12YWxzW2tdID09PSB2YWw7XG4gICAgfSlbMF07XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGVudW1Gcm9tQmluYXJ5KGRhdGE6IGFueSwgc2NoZW1hPzogYW55KSB7XG4gICAgY29uc3QgZW51bVZhbHM6IGFueSA9IHNjaGVtYS5lbnVtO1xuICAgIGxldCB2YWw6IGFueSA9IHRoaXMubnVtYmVyRnJvbUJpbmFyeShkYXRhKTtcblxuICAgIGlmIChzY2hlbWEuZmxhZ3MgPT09IHRydWUpIHtcbiAgICAgIGNvbnN0IHRlbXA6IGFueSA9IFtdO1xuICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoZW51bVZhbHMpKSB7XG4gICAgICAgIGNvbnN0IGZsYWc6IGFueSA9IGVudW1WYWxzW2tleV0gJiB2YWw7XG4gICAgICAgIGlmIChmbGFnKSB7XG4gICAgICAgICAgdGVtcC5wdXNoKGtleSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHZhbCA9IHRlbXA7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHRtcDogYW55ID0gdGhpcy5rZXlGb3JWYWwoZW51bVZhbHMsIHZhbCk7XG4gICAgICBpZiAodG1wKSB7XG4gICAgICAgIHZhbCA9IHRtcDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHZhbDtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZGF0YUFycmF5RnJvbUJpbmFyeShkYXRhOiBhbnkpIHtcbiAgICBjb25zdCBhcnI6IGFueSA9IG5ldyBBcnJheShkYXRhLmxlbmd0aCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBhcnJbaV0gPSBkYXRhW2ldO1xuICAgIH1cbiAgICByZXR1cm4gYXJyO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBjcmVhdGVTZW5kQnVmZmVyKHNjaGVtYTogYW55LCBkYXRhOiBhbnkpIHtcbiAgICBjb25zdCBhcnJheTogYW55ID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY2hlbWEubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHNjaGVtYVJvdzogYW55ID0gc2NoZW1hW2ldO1xuXG4gICAgICBsZXQgcm93OiBhbnk7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShzY2hlbWFSb3cpKSB7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHNjaGVtYVJvdykge1xuICAgICAgICAgIGNvbnN0IGN1c3RvbVNjaGVtYVJvdzogYW55ID0gT2JqZWN0LmFzc2lnbih7fSwgc2NoZW1hUm93W2tleV0sIHtcbiAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJvdyA9IHRoaXMuYW5hbHl6ZVNjaGVtYShkYXRhLCBjdXN0b21TY2hlbWFSb3cpO1xuICAgICAgICAgIGlmIChyb3cpIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcm93ID0gdGhpcy5hbmFseXplU2NoZW1hKGRhdGEsIHNjaGVtYVJvdyk7XG4gICAgICB9XG5cbiAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KGFycmF5LCByb3cpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYXJyYXkpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBhbmFseXplU2NoZW1hKGFsbERhdGE6IGFueSwgc2NoZW1hUm93OiBhbnkpIHtcbiAgICBjb25zdCB0eXBlczogYW55ID0ge1xuICAgICAgaGV4OiB0aGlzLmhleFRvQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICB1dWlkOiB0aGlzLnV1aWRUb0JpbmFyeS5iaW5kKHRoaXMpLFxuICAgICAgaW50OiB0aGlzLmludFRvQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICBjaGFyOiB0aGlzLmNoYXJUb0JpbmFyeS5iaW5kKHRoaXMpLFxuICAgICAgZGF0YUFycmF5OiB0aGlzLmRhdGFBcnJheVRvQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICBlbnVtOiB0aGlzLmVudW1Ub0JpbmFyeS5iaW5kKHRoaXMpLFxuICAgICAgc3RyaW5nOiB0aGlzLnN0cmluZ1RvQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICB0ZXh0OiB0aGlzLnN0cmluZ1RvQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICBmbGFnOiB0aGlzLmZsYWdUb0JpbmFyeS5iaW5kKHRoaXMpLFxuICAgIH07XG5cbiAgICBsZXQgdmFsOiBhbnk7XG4gICAgaWYgKHNjaGVtYVJvdy5wYXRoKSB7XG4gICAgICB2YWwgPSB0aGlzLmdldFByb3BlcnR5KGFsbERhdGEsIHNjaGVtYVJvdy5wYXRoKTtcbiAgICB9XG4gICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkICYmIHNjaGVtYVJvdy5yZXF1aXJlZCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCAmJiBzY2hlbWFSb3cuZGVmYXVsdCkge1xuICAgICAgdmFsID0gc2NoZW1hUm93LmRlZmF1bHQ7XG4gICAgfVxuXG4gICAgY29uc3Qgcm93OiBhbnkgPSB0eXBlc1tzY2hlbWFSb3cudHlwZV0odmFsLCBzY2hlbWFSb3cpO1xuXG4gICAgaWYgKHNjaGVtYVJvdy5sZW5ndGggJiYgcm93Lmxlbmd0aCAhPT0gc2NoZW1hUm93Lmxlbmd0aCkge1xuICAgICAgY29uc29sZS5sb2coXCJKU09OLT5CSU5BUlkgU0NIRU1BIEVSUk9SOiAoXCIsIHZhbCwgXCIpXCIsIHNjaGVtYVJvdyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJvdztcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0UHJvcGVydHkob2JqZWN0OiBhbnksIHBhdGg6IGFueSkge1xuICAgIGlmIChwYXRoID09PSBcIlwiIHx8IHBhdGggPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIG9iamVjdDtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBwYXRoID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBwYXRoID0gcGF0aC5zcGxpdChcIi5cIik7XG4gICAgfVxuICAgIGlmICghQXJyYXkuaXNBcnJheShwYXRoKSkge1xuICAgICAgcGF0aCA9IFtwYXRoXTtcbiAgICB9XG5cbiAgICBsZXQgaW5kZXg6IGFueSA9IDA7IGNvbnN0IGxlbmd0aDogYW55ID0gcGF0aC5sZW5ndGg7XG5cbiAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHtcbiAgICAgIG9iamVjdCA9IG9iamVjdFtwYXRoW2luZGV4KytdXTtcbiAgICAgIGlmIChvYmplY3QgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaW5kZXggJiYgaW5kZXggPT09IGxlbmd0aCA/IG9iamVjdCA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgaGV4VG9CaW5hcnkoZGF0YTogYW55LCBzY2hlbWE/OiBhbnkpIHtcbiAgICBjb25zdCBhcnJheTogYW55ID0gW107XG4gICAgY29uc3QgaGV4OiBhbnkgPSBkYXRhLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvW14wLTlhYmNkZWZdL2csIFwiXCIpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGV4Lmxlbmd0aCAvIDI7IGkrKykge1xuICAgICAgYXJyYXlbaV0gPSBwYXJzZUludChoZXhbaSAqIDJdICsgaGV4W2kgKiAyICsgMV0sIDE2KTtcbiAgICB9XG4gICAgaWYgKHNjaGVtYSAmJiBzY2hlbWEuZW5kaWFubmVzcyAmJiBzY2hlbWEuZW5kaWFubmVzcyA9PT0gXCJsaXR0bGVcIikge1xuICAgICAgYXJyYXkucmV2ZXJzZSgpO1xuICAgIH1cbiAgICByZXR1cm4gYXJyYXk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGludFRvQmluYXJ5KGRhdGE6IGFueSkge1xuICAgIGNvbnN0IGFycmF5OiBhbnkgPSBbXTtcbiAgICBhcnJheVswXSA9IChkYXRhID4+ICg4ICogMykpICYgMHhmZjtcbiAgICBhcnJheVsxXSA9IChkYXRhID4+ICg4ICogMikpICYgMHhmZjtcbiAgICBhcnJheVsyXSA9IChkYXRhID4+ICg4ICogMSkpICYgMHhmZjtcbiAgICBhcnJheVszXSA9IChkYXRhID4+ICg4ICogMCkpICYgMHhmZjtcbiAgICByZXR1cm4gYXJyYXk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGNoYXJUb0JpbmFyeShkYXRhOiBhbnkpIHtcbiAgICBjb25zdCBhcnJheTogYW55ID0gW107XG4gICAgYXJyYXlbMF0gPSBkYXRhICYgMHhmZjtcbiAgICByZXR1cm4gYXJyYXk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGRhdGFBcnJheVRvQmluYXJ5KGRhdGE6IGFueSkge1xuICAgIGlmICghQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgZGF0YSA9IFtkYXRhXTtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHV1aWRUb0JpbmFyeShkYXRhOiBhbnkpIHtcbiAgICBjb25zdCB1dWlkOiBhbnkgPSB0aGlzLmhleFRvQmluYXJ5KGRhdGEpO1xuICAgIHV1aWQucmV2ZXJzZSgpOyAvLyBiaWcgZW5kaWFubmVzcyAtPiBsaXR0bGUgZW5kaWFubmVzcztcbiAgICBjb25zdCBsZW5ndGg6IGFueSA9IHV1aWQubGVuZ3RoO1xuXG4gICAgY29uc3QgYXJyYXk6IGFueSA9IFtdO1xuXG4gICAgYXJyYXlbMF0gPSAobGVuZ3RoID4+ICg4ICogMSkpICYgMHhmZjtcbiAgICBhcnJheVsxXSA9IChsZW5ndGggPj4gKDggKiAwKSkgJiAweGZmO1xuXG4gICAgQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkoYXJyYXksIHV1aWQpO1xuICAgIGZvciAobGV0IGkgPSBhcnJheS5sZW5ndGg7IGkgPCAxNiArIDI7IGkrKykge1xuICAgICAgYXJyYXlbaV0gPSAwO1xuICAgIH1cblxuICAgIHJldHVybiBhcnJheTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZW51bVRvQmluYXJ5KGRhdGE6IGFueSwgc2NoZW1hPzogYW55KSB7XG4gICAgY29uc3QgYXJyYXk6IGFueSA9IFtdO1xuICAgIGFycmF5LnB1c2goc2NoZW1hLmVudW1bZGF0YV0pO1xuICAgIHJldHVybiBhcnJheTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZmxhZ1RvQmluYXJ5KGRhdGE6IGFueSwgc2NoZW1hPzogYW55KSB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGEpKSB7XG4gICAgICBkYXRhID0gW2RhdGFdO1xuICAgIH1cbiAgICBjb25zdCBmbGFnczogYW55ID0gc2NoZW1hLmZsYWdzO1xuICAgIGxldCB2YWx1ZTogYW55ID0gMDtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBmbGFncykge1xuICAgICAgaWYgKGRhdGEuaW5jbHVkZXMoZmxhZ3Nba2V5XSkpIHtcbiAgICAgICAgdmFsdWUgKz0gcGFyc2VJbnQoa2V5KTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgYXJyYXk6IGFueSA9IFtdO1xuICAgIGNvbnN0IGxlbmd0aDogYW55ID0gc2NoZW1hLmxlbmd0aCB8fCAxO1xuICAgIGZvciAobGV0IGkgPSBsZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgYXJyYXkucHVzaCgodmFsdWUgPj4gKGkgKiA4KSkgJiAweGZmKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXJyYXk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHN0cmluZ1RvQmluYXJ5KGRhdGE6IGFueSkge1xuICAgIHJldHVybiBuZXcgVWludDhBcnJheShCdWZmZXIuZnJvbShkYXRhLCBcInV0ZjhcIikpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEpzb25CaW5hcnlDb252ZXJ0ZXI7XG4iXX0=

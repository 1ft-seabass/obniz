"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const WSCommand_1 = __importDefault(require("./WSCommand"));
class WSCommandSystem extends WSCommand_1.default {
    constructor() {
        super();
        this.module = 0;
        this._CommandReboot = 0;
        this._CommandReset = 2;
        this._CommandSelfCheck = 3;
        this._CommandWait = 4;
        this._CommandResetOnDisconnect = 5;
        this._CommandPingPong = 8;
        this._CommandVCC = 9;
        this._CommandSleepSeconds = 10;
        this._CommandSleepMinute = 11;
        this._CommandSleepIoTrigger = 12;
    }
    // Commands
    reboot(params) {
        this.sendCommand(this._CommandReboot, null);
    }
    reset(params) {
        this.sendCommand(this._CommandReset, null);
    }
    selfCheck(params) {
        this.sendCommand(this._CommandSelfCheck, null);
    }
    wait(params) {
        const msec = params.wait;
        const buf = new Uint8Array([msec >> 8, msec]);
        this.sendCommand(this._CommandWait, buf);
    }
    keepWorkingAtOffline(params) {
        this.resetOnDisconnect(!params.keep_working_at_offline);
    }
    ping(params) {
        const unixtime = new Date().getTime();
        const buf = new Uint8Array(params.ping.key.length + 8);
        const upper = Math.floor(unixtime / Math.pow(2, 32));
        const lower = unixtime - upper * Math.pow(2, 32);
        buf[0] = upper >> (8 * 3);
        buf[1] = upper >> (8 * 2);
        buf[2] = upper >> (8 * 1);
        buf[3] = upper >> (8 * 0);
        buf[4] = lower >> (8 * 3);
        buf[5] = lower >> (8 * 2);
        buf[6] = lower >> (8 * 1);
        buf[7] = lower >> (8 * 0);
        for (let i = 0; i < params.ping.key.length; i++) {
            buf[8 + i] = params.ping.key[i];
        }
        this.sendCommand(this._CommandPingPong, buf);
    }
    resetOnDisconnect(mustReset) {
        const buf = new Uint8Array([mustReset ? 1 : 0]);
        this.sendCommand(this._CommandResetOnDisconnect, buf);
    }
    parseFromJson(json) {
        const module = json.system;
        if (module === undefined) {
            return;
        }
        const schemaData = [
            { uri: "/request/system/reboot", onValid: this.reboot },
            { uri: "/request/system/reset", onValid: this.reset },
            { uri: "/request/system/wait", onValid: this.wait },
            { uri: "/request/system/selfCheck", onValid: this.selfCheck },
            {
                uri: "/request/system/keepWorkingAtOffline",
                onValid: this.keepWorkingAtOffline,
            },
            { uri: "/request/system/ping", onValid: this.ping },
            { uri: "/request/system/sleepSeconds", onValid: this.sleepSeconds },
            { uri: "/request/system/sleepMinute", onValid: this.sleepMinute },
            { uri: "/request/system/sleepIoTrigger", onValid: this.sleepIoTrigger },
        ];
        const res = this.validateCommandSchema(schemaData, module, "system");
        if (res.valid === 0) {
            if (res.invalidButLike.length > 0) {
                throw new Error(res.invalidButLike[0].message);
            }
            else {
                throw new this.WSCommandNotFoundError(`[system]unknown command`);
            }
        }
    }
    pong(objToSend, payload) {
        objToSend.system = objToSend.system || {};
        const pongServerTime = new Date().getTime();
        if (payload.length >= 16) {
            payload = Buffer.from(payload);
            const obnizTime = payload.readUIntBE(0, 4) * Math.pow(2, 32) + payload.readUIntBE(4, 4);
            const pingServerTime = payload.readUIntBE(8, 4) * Math.pow(2, 32) + payload.readUIntBE(12, 4);
            const key = [];
            for (let i = 16; i < payload.length; i++) {
                key.push(payload[i]);
            }
            objToSend.system.pong = {
                key,
                obnizTime,
                pingServerTime,
                pongServerTime,
            };
        }
        else {
            objToSend.system.pong = {
                pongServerTime,
            };
        }
    }
    notifyFromBinary(objToSend, func, payload) {
        switch (func) {
            case this._CommandVCC:
                if (payload.byteLength === 3) {
                    let value = (payload[1] << 8) + payload[2];
                    value = value / 100.0;
                    this.envelopWarning(objToSend, "debug", {
                        message: `Low Voltage ${value}v. connect obniz to more powerful USB.`,
                    });
                }
                break;
            case this._CommandPingPong:
                this.pong(objToSend, payload);
                break;
            default:
                super.notifyFromBinary(objToSend, func, payload);
                break;
        }
    }
    sleepSeconds(params) {
        const sec = params.sleep_seconds;
        const buf = new Uint8Array([sec >> 8, sec]);
        this.sendCommand(this._CommandSleepSeconds, buf);
    }
    sleepMinute(params) {
        const minute = params.sleep_minute;
        const buf = new Uint8Array([minute >> 8, minute]);
        this.sendCommand(this._CommandSleepMinute, buf);
    }
    sleepIoTrigger(params) {
        let trigger = params.sleep_io_trigger;
        if (trigger === true) {
            trigger = 1;
        }
        else {
            trigger = 0;
        }
        const buf = new Uint8Array([trigger]);
        this.sendCommand(this._CommandSleepIoTrigger, buf);
    }
}
exports.default = WSCommandSystem;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmRTeXN0ZW0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw0REFBb0M7QUFFcEMsTUFBTSxlQUFnQixTQUFRLG1CQUFTO0lBaUJyQztRQUNFLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFFaEIsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUM7UUFFeEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUM7UUFDdkIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLENBQUMsQ0FBQztRQUMzQixJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMseUJBQXlCLEdBQUcsQ0FBQyxDQUFDO1FBRW5DLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7UUFDMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsbUJBQW1CLEdBQUcsRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxFQUFFLENBQUM7SUFDbkMsQ0FBQztJQUVELFdBQVc7SUFFSixNQUFNLENBQUMsTUFBVztRQUN2QixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVNLEtBQUssQ0FBQyxNQUFXO1FBQ3RCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRU0sU0FBUyxDQUFDLE1BQVc7UUFDMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVNLElBQUksQ0FBQyxNQUFXO1FBQ3JC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QUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVNLGNBQWMsQ0FBQyxNQUFXO1FBQy9CLElBQUksT0FBTyxHQUFRLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztRQUMzQyxJQUFJLE9BQU8sS0FBSyxJQUFJLEVBQUU7WUFDcEIsT0FBTyxHQUFHLENBQUMsQ0FBQztTQUNiO2FBQU07WUFDTCxPQUFPLEdBQUcsQ0FBQyxDQUFDO1NBQ2I7UUFDRCxNQUFNLEdBQUcsR0FBUSxJQUFJLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDckQsQ0FBQztDQUNGO0FBRUQsa0JBQWUsZUFBZSxDQUFDIiwiZmlsZSI6InNyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmRTeXN0ZW0uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgV1NDb21tYW5kIGZyb20gXCIuL1dTQ29tbWFuZFwiO1xuXG5jbGFzcyBXU0NvbW1hbmRTeXN0ZW0gZXh0ZW5kcyBXU0NvbW1hbmQge1xuICBwdWJsaWMgbW9kdWxlOiBhbnk7XG4gIHB1YmxpYyBfQ29tbWFuZFJlYm9vdDogYW55O1xuICBwdWJsaWMgX0NvbW1hbmRSZXNldDogYW55O1xuICBwdWJsaWMgX0NvbW1hbmRTZWxmQ2hlY2s6IGFueTtcbiAgcHVibGljIF9Db21tYW5kV2FpdDogYW55O1xuICBwdWJsaWMgX0NvbW1hbmRSZXNldE9uRGlzY29ubmVjdDogYW55O1xuICBwdWJsaWMgX0NvbW1hbmRQaW5nUG9uZzogYW55O1xuICBwdWJsaWMgX0NvbW1hbmRWQ0M6IGFueTtcbiAgcHVibGljIF9Db21tYW5kU2xlZXBTZWNvbmRzOiBhbnk7XG4gIHB1YmxpYyBfQ29tbWFuZFNsZWVwTWludXRlOiBhbnk7XG4gIHB1YmxpYyBfQ29tbWFuZFNsZWVwSW9UcmlnZ2VyOiBhbnk7XG4gIHB1YmxpYyBzZW5kQ29tbWFuZDogYW55O1xuICBwdWJsaWMgdmFsaWRhdGVDb21tYW5kU2NoZW1hOiBhbnk7XG4gIHB1YmxpYyBXU0NvbW1hbmROb3RGb3VuZEVycm9yOiBhbnk7XG4gIHB1YmxpYyBlbnZlbG9wV2FybmluZzogYW55O1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5tb2R1bGUgPSAwO1xuXG4gICAgdGhpcy5fQ29tbWFuZFJlYm9vdCA9IDA7XG5cbiAgICB0aGlzLl9Db21tYW5kUmVzZXQgPSAyO1xuICAgIHRoaXMuX0NvbW1hbmRTZWxmQ2hlY2sgPSAzO1xuICAgIHRoaXMuX0NvbW1hbmRXYWl0ID0gNDtcbiAgICB0aGlzLl9Db21tYW5kUmVzZXRPbkRpc2Nvbm5lY3QgPSA1O1xuXG4gICAgdGhpcy5fQ29tbWFuZFBpbmdQb25nID0gODtcbiAgICB0aGlzLl9Db21tYW5kVkNDID0gOTtcbiAgICB0aGlzLl9Db21tYW5kU2xlZXBTZWNvbmRzID0gMTA7XG4gICAgdGhpcy5fQ29tbWFuZFNsZWVwTWludXRlID0gMTE7XG4gICAgdGhpcy5fQ29tbWFuZFNsZWVwSW9UcmlnZ2VyID0gMTI7XG4gIH1cblxuICAvLyBDb21tYW5kc1xuXG4gIHB1YmxpYyByZWJvb3QocGFyYW1zOiBhbnkpIHtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRSZWJvb3QsIG51bGwpO1xuICB9XG5cbiAgcHVibGljIHJlc2V0KHBhcmFtczogYW55KSB7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kUmVzZXQsIG51bGwpO1xuICB9XG5cbiAgcHVibGljIHNlbGZDaGVjayhwYXJhbXM6IGFueSkge1xuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZFNlbGZDaGVjaywgbnVsbCk7XG4gIH1cblxuICBwdWJsaWMgd2FpdChwYXJhbXM6IGFueSkge1xuICAgIGNvbnN0IG1zZWM6IGFueSA9IHBhcmFtcy53YWl0O1xuICAgIGNvbnN0IGJ1ZjogYW55ID0gbmV3IFVpbnQ4QXJyYXkoW21zZWMgPj4gOCwgbXNlY10pO1xuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZFdhaXQsIGJ1Zik7XG4gIH1cblxuICBwdWJsaWMga2VlcFdvcmtpbmdBdE9mZmxpbmUocGFyYW1zOiBhbnkpIHtcbiAgICB0aGlzLnJlc2V0T25EaXNjb25uZWN0KCFwYXJhbXMua2VlcF93b3JraW5nX2F0X29mZmxpbmUpO1xuICB9XG5cbiAgcHVibGljIHBpbmcocGFyYW1zOiBhbnkpIHtcbiAgICBjb25zdCB1bml4dGltZTogYW55ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgY29uc3QgYnVmOiBhbnkgPSBuZXcgVWludDhBcnJheShwYXJhbXMucGluZy5rZXkubGVuZ3RoICsgOCk7XG4gICAgY29uc3QgdXBwZXI6IGFueSA9IE1hdGguZmxvb3IodW5peHRpbWUgLyBNYXRoLnBvdygyLCAzMikpO1xuICAgIGNvbnN0IGxvd2VyOiBhbnkgPSB1bml4dGltZSAtIHVwcGVyICogTWF0aC5wb3coMiwgMzIpO1xuICAgIGJ1ZlswXSA9IHVwcGVyID4+ICg4ICogMyk7XG4gICAgYnVmWzFdID0gdXBwZXIgPj4gKDggKiAyKTtcbiAgICBidWZbMl0gPSB1cHBlciA+PiAoOCAqIDEpO1xuICAgIGJ1ZlszXSA9IHVwcGVyID4+ICg4ICogMCk7XG4gICAgYnVmWzRdID0gbG93ZXIgPj4gKDggKiAzKTtcbiAgICBidWZbNV0gPSBsb3dlciA+PiAoOCAqIDIpO1xuICAgIGJ1Zls2XSA9IGxvd2VyID4+ICg4ICogMSk7XG4gICAgYnVmWzddID0gbG93ZXIgPj4gKDggKiAwKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcmFtcy5waW5nLmtleS5sZW5ndGg7IGkrKykge1xuICAgICAgYnVmWzggKyBpXSA9IHBhcmFtcy5waW5nLmtleVtpXTtcbiAgICB9XG5cbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRQaW5nUG9uZywgYnVmKTtcbiAgfVxuXG4gIHB1YmxpYyByZXNldE9uRGlzY29ubmVjdChtdXN0UmVzZXQ6IGFueSkge1xuICAgIGNvbnN0IGJ1ZjogYW55ID0gbmV3IFVpbnQ4QXJyYXkoW211c3RSZXNldCA/IDEgOiAwXSk7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kUmVzZXRPbkRpc2Nvbm5lY3QsIGJ1Zik7XG4gIH1cblxuICBwdWJsaWMgcGFyc2VGcm9tSnNvbihqc29uOiBhbnkpIHtcbiAgICBjb25zdCBtb2R1bGU6IGFueSA9IGpzb24uc3lzdGVtO1xuICAgIGlmIChtb2R1bGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHNjaGVtYURhdGE6IGFueSA9IFtcbiAgICAgIHt1cmk6IFwiL3JlcXVlc3Qvc3lzdGVtL3JlYm9vdFwiLCBvblZhbGlkOiB0aGlzLnJlYm9vdH0sXG4gICAgICB7dXJpOiBcIi9yZXF1ZXN0L3N5c3RlbS9yZXNldFwiLCBvblZhbGlkOiB0aGlzLnJlc2V0fSxcbiAgICAgIHt1cmk6IFwiL3JlcXVlc3Qvc3lzdGVtL3dhaXRcIiwgb25WYWxpZDogdGhpcy53YWl0fSxcbiAgICAgIHt1cmk6IFwiL3JlcXVlc3Qvc3lzdGVtL3NlbGZDaGVja1wiLCBvblZhbGlkOiB0aGlzLnNlbGZDaGVja30sXG4gICAgICB7XG4gICAgICAgIHVyaTogXCIvcmVxdWVzdC9zeXN0ZW0va2VlcFdvcmtpbmdBdE9mZmxpbmVcIixcbiAgICAgICAgb25WYWxpZDogdGhpcy5rZWVwV29ya2luZ0F0T2ZmbGluZSxcbiAgICAgIH0sXG4gICAgICB7dXJpOiBcIi9yZXF1ZXN0L3N5c3RlbS9waW5nXCIsIG9uVmFsaWQ6IHRoaXMucGluZ30sXG4gICAgICB7dXJpOiBcIi9yZXF1ZXN0L3N5c3RlbS9zbGVlcFNlY29uZHNcIiwgb25WYWxpZDogdGhpcy5zbGVlcFNlY29uZHN9LFxuICAgICAge3VyaTogXCIvcmVxdWVzdC9zeXN0ZW0vc2xlZXBNaW51dGVcIiwgb25WYWxpZDogdGhpcy5zbGVlcE1pbnV0ZX0sXG4gICAgICB7dXJpOiBcIi9yZXF1ZXN0L3N5c3RlbS9zbGVlcElvVHJpZ2dlclwiLCBvblZhbGlkOiB0aGlzLnNsZWVwSW9UcmlnZ2VyfSxcbiAgICBdO1xuICAgIGNvbnN0IHJlczogYW55ID0gdGhpcy52YWxpZGF0ZUNvbW1hbmRTY2hlbWEoc2NoZW1hRGF0YSwgbW9kdWxlLCBcInN5c3RlbVwiKTtcblxuICAgIGlmIChyZXMudmFsaWQgPT09IDApIHtcbiAgICAgIGlmIChyZXMuaW52YWxpZEJ1dExpa2UubGVuZ3RoID4gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVzLmludmFsaWRCdXRMaWtlWzBdLm1lc3NhZ2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IHRoaXMuV1NDb21tYW5kTm90Rm91bmRFcnJvcihgW3N5c3RlbV11bmtub3duIGNvbW1hbmRgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcG9uZyhvYmpUb1NlbmQ6IGFueSwgcGF5bG9hZDogYW55KSB7XG4gICAgb2JqVG9TZW5kLnN5c3RlbSA9IG9ialRvU2VuZC5zeXN0ZW0gfHwge307XG4gICAgY29uc3QgcG9uZ1NlcnZlclRpbWU6IGFueSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXG4gICAgaWYgKHBheWxvYWQubGVuZ3RoID49IDE2KSB7XG4gICAgICBwYXlsb2FkID0gQnVmZmVyLmZyb20ocGF5bG9hZCk7XG4gICAgICBjb25zdCBvYm5pelRpbWU6IGFueSA9XG4gICAgICAgIHBheWxvYWQucmVhZFVJbnRCRSgwLCA0KSAqIE1hdGgucG93KDIsIDMyKSArIHBheWxvYWQucmVhZFVJbnRCRSg0LCA0KTtcbiAgICAgIGNvbnN0IHBpbmdTZXJ2ZXJUaW1lOiBhbnkgPVxuICAgICAgICBwYXlsb2FkLnJlYWRVSW50QkUoOCwgNCkgKiBNYXRoLnBvdygyLCAzMikgKyBwYXlsb2FkLnJlYWRVSW50QkUoMTIsIDQpO1xuICAgICAgY29uc3Qga2V5OiBhbnkgPSBbXTtcbiAgICAgIGZvciAobGV0IGkgPSAxNjsgaSA8IHBheWxvYWQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAga2V5LnB1c2gocGF5bG9hZFtpXSk7XG4gICAgICB9XG4gICAgICBvYmpUb1NlbmQuc3lzdGVtLnBvbmcgPSB7XG4gICAgICAgIGtleSxcbiAgICAgICAgb2JuaXpUaW1lLFxuICAgICAgICBwaW5nU2VydmVyVGltZSxcbiAgICAgICAgcG9uZ1NlcnZlclRpbWUsXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBvYmpUb1NlbmQuc3lzdGVtLnBvbmcgPSB7XG4gICAgICAgIHBvbmdTZXJ2ZXJUaW1lLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbm90aWZ5RnJvbUJpbmFyeShvYmpUb1NlbmQ6IGFueSwgZnVuYzogYW55LCBwYXlsb2FkOiBhbnkpIHtcbiAgICBzd2l0Y2ggKGZ1bmMpIHtcbiAgICAgIGNhc2UgdGhpcy5fQ29tbWFuZFZDQzpcbiAgICAgICAgaWYgKHBheWxvYWQuYnl0ZUxlbmd0aCA9PT0gMykge1xuICAgICAgICAgIGxldCB2YWx1ZTogYW55ID0gKHBheWxvYWRbMV0gPDwgOCkgKyBwYXlsb2FkWzJdO1xuICAgICAgICAgIHZhbHVlID0gdmFsdWUgLyAxMDAuMDtcbiAgICAgICAgICB0aGlzLmVudmVsb3BXYXJuaW5nKG9ialRvU2VuZCwgXCJkZWJ1Z1wiLCB7XG4gICAgICAgICAgICBtZXNzYWdlOiBgTG93IFZvbHRhZ2UgJHt2YWx1ZX12LiBjb25uZWN0IG9ibml6IHRvIG1vcmUgcG93ZXJmdWwgVVNCLmAsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgdGhpcy5fQ29tbWFuZFBpbmdQb25nOlxuICAgICAgICB0aGlzLnBvbmcob2JqVG9TZW5kLCBwYXlsb2FkKTtcblxuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgc3VwZXIubm90aWZ5RnJvbUJpbmFyeShvYmpUb1NlbmQsIGZ1bmMsIHBheWxvYWQpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2xlZXBTZWNvbmRzKHBhcmFtczogYW55KSB7XG4gICAgY29uc3Qgc2VjOiBhbnkgPSBwYXJhbXMuc2xlZXBfc2Vjb25kcztcbiAgICBjb25zdCBidWY6IGFueSA9IG5ldyBVaW50OEFycmF5KFtzZWMgPj4gOCwgc2VjXSk7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kU2xlZXBTZWNvbmRzLCBidWYpO1xuICB9XG5cbiAgcHVibGljIHNsZWVwTWludXRlKHBhcmFtczogYW55KSB7XG4gICAgY29uc3QgbWludXRlOiBhbnkgPSBwYXJhbXMuc2xlZXBfbWludXRlO1xuICAgIGNvbnN0IGJ1ZjogYW55ID0gbmV3IFVpbnQ4QXJyYXkoW21pbnV0ZSA+PiA4LCBtaW51dGVdKTtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRTbGVlcE1pbnV0ZSwgYnVmKTtcbiAgfVxuXG4gIHB1YmxpYyBzbGVlcElvVHJpZ2dlcihwYXJhbXM6IGFueSkge1xuICAgIGxldCB0cmlnZ2VyOiBhbnkgPSBwYXJhbXMuc2xlZXBfaW9fdHJpZ2dlcjtcbiAgICBpZiAodHJpZ2dlciA9PT0gdHJ1ZSkge1xuICAgICAgdHJpZ2dlciA9IDE7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRyaWdnZXIgPSAwO1xuICAgIH1cbiAgICBjb25zdCBidWY6IGFueSA9IG5ldyBVaW50OEFycmF5KFt0cmlnZ2VyXSk7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kU2xlZXBJb1RyaWdnZXIsIGJ1Zik7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgV1NDb21tYW5kU3lzdGVtO1xuIl19

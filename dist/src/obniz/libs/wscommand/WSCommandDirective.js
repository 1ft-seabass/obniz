"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const semver = require("semver");
const util_1 = __importDefault(require("../utils/util"));
const WSCommand_1 = __importDefault(require("./WSCommand"));
const WSCommandIO_1 = __importDefault(require("./WSCommandIO"));
const WSCommandPWM_1 = __importDefault(require("./WSCommandPWM"));
class WSCommandDirective extends WSCommand_1.default {
    constructor() {
        super();
        this.module = 1;
        this._CommandRegistrate = 0;
        this._CommandPause = 1;
        this._CommandResume = 2;
        this._CommandNotify = 3;
        this.availableCommands = [new WSCommandIO_1.default(), new WSCommandPWM_1.default()];
    }
    // Commands
    init(params, originalParams) {
        const nameArray = util_1.default.string2dataArray(params.animation.name);
        let frame;
        let offset = 0;
        if (semver.lt(this._hw.firmware, "2.0.0")) {
            // < 2.0.0
            frame = new Uint8Array(1 + nameArray.length + 1);
            // name //
            frame[offset++] = nameArray.length + 1;
            frame.set(nameArray, offset);
            offset += nameArray.length;
            frame[offset++] = 0; // null string
            if (params.animation.status === "registrate" ||
                typeof params.animation.repeat === "number") {
                throw new Error("you need to update your firmware >= 2.0.0");
            }
        }
        else {
            frame = new Uint8Array(1 + nameArray.length + 1 + 1 + 4);
            // name //
            frame[offset++] = nameArray.length + 1;
            frame.set(nameArray, offset);
            offset += nameArray.length;
            frame[offset++] = 0; // null string
            // type and count //
            let type = 0;
            let repeat_count = 0;
            if (params.animation.status === "loop") {
                type = 1; // auto start
            }
            if (typeof params.animation.repeat === "number") {
                repeat_count = params.animation.repeat;
                type += 2;
            }
            frame[offset++] = type;
            frame[offset++] = repeat_count >> (8 * 3);
            frame[offset++] = repeat_count >> (8 * 2);
            frame[offset++] = repeat_count >> (8 * 1);
            frame[offset++] = repeat_count;
        }
        const commandJsonArray = params.animation.states;
        for (let i = 0; i < commandJsonArray.length; i++) {
            const obj = commandJsonArray[i];
            const duration = Math.floor(obj.duration * 1000);
            const state = obj.state;
            // Dry run commands
            let parsedCommands = JSON.parse(JSON.stringify(state));
            if (!Array.isArray(parsedCommands)) {
                parsedCommands = [parsedCommands];
            }
            let compressed = null;
            for (let commandIndex = 0; commandIndex < parsedCommands.length; commandIndex++) {
                const _frame = WSCommand_1.default.compress(this.availableCommands, parsedCommands[commandIndex]);
                if (!_frame) {
                    throw new Error("[io.animation.states.state]only io or pwm commands. Pleave provide state at least one of them.");
                }
                if (compressed) {
                    const _combined = new Uint8Array(compressed.length + _frame.length);
                    _combined.set(compressed, 0);
                    _combined.set(_frame, compressed.length);
                    compressed = _combined;
                }
                else {
                    compressed = _frame;
                }
            }
            if (!compressed) {
                throw new Error("[io.animation.states.state]only io or pwm commands. Pleave provide state at least one of them.");
            }
            const length = compressed.byteLength;
            const commandHeader = new Uint8Array(8);
            commandHeader[0] = length >> (8 * 3);
            commandHeader[1] = length >> (8 * 2);
            commandHeader[2] = length >> (8 * 1);
            commandHeader[3] = length;
            commandHeader[4] = duration >> (8 * 3);
            commandHeader[5] = duration >> (8 * 2);
            commandHeader[6] = duration >> (8 * 1);
            commandHeader[7] = duration;
            const combined = new Uint8Array(frame.byteLength + commandHeader.byteLength + compressed.byteLength);
            combined.set(frame, 0);
            combined.set(commandHeader, frame.byteLength);
            combined.set(compressed, frame.byteLength + commandHeader.byteLength);
            frame = combined;
        }
        if (frame.byteLength > 1000) {
            // 1kbyte over
            throw new Error("[io.animation]Too big animation datas");
        }
        this.sendCommand(this._CommandRegistrate, frame);
    }
    changeState(params) {
        if (params.animation.status === "resume") {
            const nameArray = util_1.default.string2dataArray(params.animation.name);
            const frame = new Uint8Array(nameArray.length + 2);
            frame[0] = nameArray.length + 1;
            frame.set(nameArray, 1);
            frame[frame.byteLength - 1] = 0;
            this.sendCommand(this._CommandResume, frame);
        }
        else if (params.animation.status === "pause") {
            const nameArray = util_1.default.string2dataArray(params.animation.name);
            const frame = new Uint8Array(nameArray.length + 2);
            frame[0] = nameArray.length + 1;
            frame.set(nameArray, 1);
            frame[frame.byteLength - 1] = 0;
            this.sendCommand(this._CommandPause, frame);
        }
    }
    parseFromJson(json) {
        let parentCommandNotFound = false;
        try {
            super.parseFromJson(json);
        }
        catch (err) {
            if (err instanceof this.WSCommandNotFoundError) {
                parentCommandNotFound = true;
            }
            else {
                throw err;
            }
        }
        const module = json.io;
        if (module === undefined) {
            return;
        }
        const schemaData = [
            { uri: "/request/ioAnimation/init", onValid: this.init },
            { uri: "/request/ioAnimation/changeState", onValid: this.changeState },
        ];
        const res = this.validateCommandSchema(schemaData, module, "io", module);
        if (res.valid === 0 && parentCommandNotFound) {
            if (res.invalidButLike.length > 0) {
                throw new Error(res.invalidButLike[0].message);
            }
            else {
                const WSCommandNotFoundError = this.WSCommandNotFoundError;
                throw new WSCommandNotFoundError(`[io.animation]unknown command`);
            }
        }
    }
    notifyFromBinary(objToSend, func, payload) {
        if (func === this._CommandNotify) {
            const name = util_1.default.dataArray2string(payload.slice(2, payload.byteLength - 1)); // remove null string
            objToSend.io = {
                animation: {
                    name,
                    status: "finish",
                },
            };
        }
        else {
            super.notifyFromBinary(objToSend, func, payload);
        }
    }
}
exports.default = WSCommandDirective;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmREaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxpQ0FBa0M7QUFDbEMseURBQXNDO0FBQ3RDLDREQUFvQztBQUNwQyxnRUFBc0M7QUFDdEMsa0VBQXdDO0FBRXhDLE1BQXFCLGtCQUFtQixTQUFRLG1CQUFTO0lBU3ZEO1FBQ0UsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUVoQixJQUFJLENBQUMsa0JBQWtCLEdBQUcsQ0FBQyxDQUFDO1FBQzVCLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQyxDQUFDO1FBRXhCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLElBQUkscUJBQVMsRUFBRSxFQUFFLElBQUksc0JBQVUsRUFBRSxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQUVELFdBQVc7SUFFSixJQUFJLENBQUMsTUFBVyxFQUFFLGNBQW1CO1FBQzFDLE1BQU0sU0FBUyxHQUFRLGNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pFLElBQUksS0FBVSxDQUFDO1FBQ2YsSUFBSSxNQUFNLEdBQVEsQ0FBQyxDQUFDO1FBQ3BCLElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsRUFBRTtZQUN6QyxVQUFVO1lBQ1YsS0FBSyxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2pELFVBQVU7WUFDVixLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztZQUN2QyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUM3QixNQUFNLElBQUksU0FBUyxDQUFDLE1BQU0sQ0FBQztZQUMzQixLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxjQUFjO1lBQ25DLElBQ0UsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEtBQUssWUFBWTtnQkFDeEMsT0FBTyxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sS0FBSyxRQUFRLEVBQzNDO2dCQUNBLE1BQU0sSUFBSSxLQUFLLENBQUMsMkNBQTJDLENBQUMsQ0FBQzthQUM5RDtTQUNGO2FBQU07WUFDTCxLQUFLLEdBQUcsSUFBSSxVQUFVLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN6RCxVQUFVO1lBQ1YsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7WUFDdkMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDN0IsTUFBTSxJQUFJLFNBQVMsQ0FBQyxNQUFNLENBQUM7WUFDM0IsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsY0FBYztZQUNuQyxvQkFBb0I7WUFDcEIsSUFBSSxJQUFJLEdBQVEsQ0FBQyxDQUFDO1lBRWxCLElBQUksWUFBWSxHQUFRLENBQUMsQ0FBQztZQUMxQixJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxLQUFLLE1BQU0sRUFBRTtnQkFDdEMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLGFBQWE7YUFDeEI7WUFDRCxJQUFJLE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEtBQUssUUFBUSxFQUFFO2dCQUMvQyxZQUFZLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7Z0JBQ3ZDLElBQUksSUFBSSxDQUFDLENBQUM7YUFDWDtZQUNELEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztZQUN2QixLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxZQUFZLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDMUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsWUFBWSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLFlBQVksSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxZQUFZLENBQUM7U0FDaEM7UUFFRCxNQUFNLGdCQUFnQixHQUFRLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDO1FBRXRELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDaEQsTUFBTSxHQUFHLEdBQVEsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckMsTUFBTSxRQUFRLEdBQVEsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQ3RELE1BQU0sS0FBSyxHQUFRLEdBQUcsQ0FBQyxLQUFLLENBQUM7WUFFN0IsbUJBQW1CO1lBQ25CLElBQUksY0FBYyxHQUFRLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQzVELElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxFQUFFO2dCQUNsQyxjQUFjLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQzthQUNuQztZQUNELElBQUksVUFBVSxHQUFRLElBQUksQ0FBQztZQUMzQixLQUNFLElBQUksWUFBWSxHQUFRLENBQUMsRUFDekIsWUFBWSxHQUFHLGNBQWMsQ0FBQyxNQUFNLEVBQ3BDLFlBQVksRUFBRSxFQUNkO2dCQUNBLE1BQU0sTUFBTSxHQUFRLG1CQUFTLENBQUMsUUFBUSxDQUNwQyxJQUFJLENBQUMsaUJBQWlCLEVBQ3RCLGNBQWMsQ0FBQyxZQUFZLENBQUMsQ0FDN0IsQ0FBQztnQkFDRixJQUFJLENBQUMsTUFBTSxFQUFFO29CQUNYLE1BQU0sSUFBSSxLQUFLLENBQ2IsZ0dBQWdHLENBQ2pHLENBQUM7aUJBQ0g7Z0JBQ0QsSUFBSSxVQUFVLEVBQUU7b0JBQ2QsTUFBTSxTQUFTLEdBQVEsSUFBSSxVQUFVLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ3pFLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUM3QixTQUFTLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ3pDLFVBQVUsR0FBRyxTQUFTLENBQUM7aUJBQ3hCO3FCQUFNO29CQUNMLFVBQVUsR0FBRyxNQUFNLENBQUM7aUJBQ3JCO2FBQ0Y7WUFDRCxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUNmLE1BQU0sSUFBSSxLQUFLLENBQ2IsZ0dBQWdHLENBQ2pHLENBQUM7YUFDSDtZQUNELE1BQU0sTUFBTSxHQUFRLFVBQVUsQ0FBQyxVQUFVLENBQUM7WUFFMUMsTUFBTSxhQUFhLEdBQVEsSUFBSSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0MsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNyQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLGFBQWEsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDckMsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQztZQUMxQixhQUFhLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3ZDLGFBQWEsQ0FBQyxDQUFDLENBQUMsR0FBRyxRQUFRLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDdkMsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN2QyxhQUFhLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDO1lBRTVCLE1BQU0sUUFBUSxHQUFRLElBQUksVUFBVSxDQUNsQyxLQUFLLENBQUMsVUFBVSxHQUFHLGFBQWEsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FDcEUsQ0FBQztZQUNGLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLFFBQVEsQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUM5QyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVSxHQUFHLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUV0RSxLQUFLLEdBQUcsUUFBUSxDQUFDO1NBQ2xCO1FBRUQsSUFBSSxLQUFLLENBQUMsVUFBVSxHQUFHLElBQUksRUFBRTtZQUMzQixjQUFjO1lBQ2QsTUFBTSxJQUFJLEtBQUssQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO1NBQzFEO1FBRUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVNLFdBQVcsQ0FBQyxNQUFXO1FBQzVCLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEtBQUssUUFBUSxFQUFFO1lBQ3hDLE1BQU0sU0FBUyxHQUFRLGNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3pFLE1BQU0sS0FBSyxHQUFRLElBQUksVUFBVSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDeEQsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ2hDLEtBQUssQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3hCLEtBQUssQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDOUM7YUFBTSxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxLQUFLLE9BQU8sRUFBRTtZQUM5QyxNQUFNLFNBQVMsR0FBUSxjQUFTLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN6RSxNQUFNLEtBQUssR0FBUSxJQUFJLFVBQVUsQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3hELEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztZQUNoQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN4QixLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzdDO0lBQ0gsQ0FBQztJQUVNLGFBQWEsQ0FBQyxJQUFTO1FBQzVCLElBQUkscUJBQXFCLEdBQVEsS0FBSyxDQUFDO1FBQ3ZDLElBQUk7WUFDRixLQUFLLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzNCO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixJQUFJLEdBQUcsWUFBWSxJQUFJLENBQUMsc0JBQXNCLEVBQUU7Z0JBQzlDLHFCQUFxQixHQUFHLElBQUksQ0FBQzthQUM5QjtpQkFBTTtnQkFDTCxNQUFNLEdBQUcsQ0FBQzthQUNYO1NBQ0Y7UUFFRCxNQUFNLE1BQU0sR0FBUSxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQzVCLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtZQUN4QixPQUFPO1NBQ1I7UUFFRCxNQUFNLFVBQVUsR0FBUTtZQUN0QixFQUFDLEdBQUcsRUFBRSwyQkFBMkIsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBQztZQUN0RCxFQUFDLEdBQUcsRUFBRSxrQ0FBa0MsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBQztTQUNyRSxDQUFDO1FBQ0YsTUFBTSxHQUFHLEdBQVEsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRTlFLElBQUksR0FBRyxDQUFDLEtBQUssS0FBSyxDQUFDLElBQUkscUJBQXFCLEVBQUU7WUFDNUMsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ2pDLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUNoRDtpQkFBTTtnQkFDTCxNQUFNLHNCQUFzQixHQUFRLElBQUksQ0FBQyxzQkFBc0IsQ0FBQztnQkFDaEUsTUFBTSxJQUFJLHNCQUFzQixDQUFDLCtCQUErQixDQUFDLENBQUM7YUFDbkU7U0FDRjtJQUNILENBQUM7SUFFTSxnQkFBZ0IsQ0FBQyxTQUFjLEVBQUUsSUFBUyxFQUFFLE9BQVk7UUFDN0QsSUFBSSxJQUFJLEtBQUssSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNoQyxNQUFNLElBQUksR0FBUSxjQUFTLENBQUMsZ0JBQWdCLENBQzFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLENBQ3pDLENBQUMsQ0FBQyxxQkFBcUI7WUFFeEIsU0FBUyxDQUFDLEVBQUUsR0FBRztnQkFDYixTQUFTLEVBQUU7b0JBQ1QsSUFBSTtvQkFDSixNQUFNLEVBQUUsUUFBUTtpQkFDakI7YUFDRixDQUFDO1NBQ0g7YUFBTTtZQUNMLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ2xEO0lBQ0gsQ0FBQztDQUNGO0FBNU1ELHFDQTRNQyIsImZpbGUiOiJzcmMvb2JuaXovbGlicy93c2NvbW1hbmQvV1NDb21tYW5kRGlyZWN0aXZlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHNlbXZlciA9IHJlcXVpcmUoXCJzZW12ZXJcIik7XG5pbXBvcnQgT2JuaXpVdGlsIGZyb20gXCIuLi91dGlscy91dGlsXCI7XG5pbXBvcnQgV1NDb21tYW5kIGZyb20gXCIuL1dTQ29tbWFuZFwiO1xuaW1wb3J0IENvbW1hbmRJTyBmcm9tIFwiLi9XU0NvbW1hbmRJT1wiO1xuaW1wb3J0IENvbW1hbmRQV00gZnJvbSBcIi4vV1NDb21tYW5kUFdNXCI7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdTQ29tbWFuZERpcmVjdGl2ZSBleHRlbmRzIFdTQ29tbWFuZCB7XG4gIHB1YmxpYyAgYXZhaWxhYmxlQ29tbWFuZHM6IGFueTtcblxuICBwcm90ZWN0ZWQgbW9kdWxlOiBudW1iZXI7XG4gIHByb3RlY3RlZCBfQ29tbWFuZFJlZ2lzdHJhdGU6IG51bWJlcjtcbiAgcHJvdGVjdGVkIF9Db21tYW5kUGF1c2U6IG51bWJlcjtcbiAgcHJvdGVjdGVkIF9Db21tYW5kUmVzdW1lOiBudW1iZXI7XG4gIHByb3RlY3RlZCBfQ29tbWFuZE5vdGlmeTogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5tb2R1bGUgPSAxO1xuXG4gICAgdGhpcy5fQ29tbWFuZFJlZ2lzdHJhdGUgPSAwO1xuICAgIHRoaXMuX0NvbW1hbmRQYXVzZSA9IDE7XG4gICAgdGhpcy5fQ29tbWFuZFJlc3VtZSA9IDI7XG4gICAgdGhpcy5fQ29tbWFuZE5vdGlmeSA9IDM7XG5cbiAgICB0aGlzLmF2YWlsYWJsZUNvbW1hbmRzID0gW25ldyBDb21tYW5kSU8oKSwgbmV3IENvbW1hbmRQV00oKV07XG4gIH1cblxuICAvLyBDb21tYW5kc1xuXG4gIHB1YmxpYyBpbml0KHBhcmFtczogYW55LCBvcmlnaW5hbFBhcmFtczogYW55KSB7XG4gICAgY29uc3QgbmFtZUFycmF5OiBhbnkgPSBPYm5pelV0aWwuc3RyaW5nMmRhdGFBcnJheShwYXJhbXMuYW5pbWF0aW9uLm5hbWUpO1xuICAgIGxldCBmcmFtZTogYW55O1xuICAgIGxldCBvZmZzZXQ6IGFueSA9IDA7XG4gICAgaWYgKHNlbXZlci5sdCh0aGlzLl9ody5maXJtd2FyZSwgXCIyLjAuMFwiKSkge1xuICAgICAgLy8gPCAyLjAuMFxuICAgICAgZnJhbWUgPSBuZXcgVWludDhBcnJheSgxICsgbmFtZUFycmF5Lmxlbmd0aCArIDEpO1xuICAgICAgLy8gbmFtZSAvL1xuICAgICAgZnJhbWVbb2Zmc2V0KytdID0gbmFtZUFycmF5Lmxlbmd0aCArIDE7XG4gICAgICBmcmFtZS5zZXQobmFtZUFycmF5LCBvZmZzZXQpO1xuICAgICAgb2Zmc2V0ICs9IG5hbWVBcnJheS5sZW5ndGg7XG4gICAgICBmcmFtZVtvZmZzZXQrK10gPSAwOyAvLyBudWxsIHN0cmluZ1xuICAgICAgaWYgKFxuICAgICAgICBwYXJhbXMuYW5pbWF0aW9uLnN0YXR1cyA9PT0gXCJyZWdpc3RyYXRlXCIgfHxcbiAgICAgICAgdHlwZW9mIHBhcmFtcy5hbmltYXRpb24ucmVwZWF0ID09PSBcIm51bWJlclwiXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwieW91IG5lZWQgdG8gdXBkYXRlIHlvdXIgZmlybXdhcmUgPj0gMi4wLjBcIik7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGZyYW1lID0gbmV3IFVpbnQ4QXJyYXkoMSArIG5hbWVBcnJheS5sZW5ndGggKyAxICsgMSArIDQpO1xuICAgICAgLy8gbmFtZSAvL1xuICAgICAgZnJhbWVbb2Zmc2V0KytdID0gbmFtZUFycmF5Lmxlbmd0aCArIDE7XG4gICAgICBmcmFtZS5zZXQobmFtZUFycmF5LCBvZmZzZXQpO1xuICAgICAgb2Zmc2V0ICs9IG5hbWVBcnJheS5sZW5ndGg7XG4gICAgICBmcmFtZVtvZmZzZXQrK10gPSAwOyAvLyBudWxsIHN0cmluZ1xuICAgICAgLy8gdHlwZSBhbmQgY291bnQgLy9cbiAgICAgIGxldCB0eXBlOiBhbnkgPSAwO1xuXG4gICAgICBsZXQgcmVwZWF0X2NvdW50OiBhbnkgPSAwO1xuICAgICAgaWYgKHBhcmFtcy5hbmltYXRpb24uc3RhdHVzID09PSBcImxvb3BcIikge1xuICAgICAgICB0eXBlID0gMTsgLy8gYXV0byBzdGFydFxuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiBwYXJhbXMuYW5pbWF0aW9uLnJlcGVhdCA9PT0gXCJudW1iZXJcIikge1xuICAgICAgICByZXBlYXRfY291bnQgPSBwYXJhbXMuYW5pbWF0aW9uLnJlcGVhdDtcbiAgICAgICAgdHlwZSArPSAyO1xuICAgICAgfVxuICAgICAgZnJhbWVbb2Zmc2V0KytdID0gdHlwZTtcbiAgICAgIGZyYW1lW29mZnNldCsrXSA9IHJlcGVhdF9jb3VudCA+PiAoOCAqIDMpO1xuICAgICAgZnJhbWVbb2Zmc2V0KytdID0gcmVwZWF0X2NvdW50ID4+ICg4ICogMik7XG4gICAgICBmcmFtZVtvZmZzZXQrK10gPSByZXBlYXRfY291bnQgPj4gKDggKiAxKTtcbiAgICAgIGZyYW1lW29mZnNldCsrXSA9IHJlcGVhdF9jb3VudDtcbiAgICB9XG5cbiAgICBjb25zdCBjb21tYW5kSnNvbkFycmF5OiBhbnkgPSBwYXJhbXMuYW5pbWF0aW9uLnN0YXRlcztcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29tbWFuZEpzb25BcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3Qgb2JqOiBhbnkgPSBjb21tYW5kSnNvbkFycmF5W2ldO1xuICAgICAgY29uc3QgZHVyYXRpb246IGFueSA9IE1hdGguZmxvb3Iob2JqLmR1cmF0aW9uICogMTAwMCk7XG4gICAgICBjb25zdCBzdGF0ZTogYW55ID0gb2JqLnN0YXRlO1xuXG4gICAgICAvLyBEcnkgcnVuIGNvbW1hbmRzXG4gICAgICBsZXQgcGFyc2VkQ29tbWFuZHM6IGFueSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoc3RhdGUpKTtcbiAgICAgIGlmICghQXJyYXkuaXNBcnJheShwYXJzZWRDb21tYW5kcykpIHtcbiAgICAgICAgcGFyc2VkQ29tbWFuZHMgPSBbcGFyc2VkQ29tbWFuZHNdO1xuICAgICAgfVxuICAgICAgbGV0IGNvbXByZXNzZWQ6IGFueSA9IG51bGw7XG4gICAgICBmb3IgKFxuICAgICAgICBsZXQgY29tbWFuZEluZGV4OiBhbnkgPSAwO1xuICAgICAgICBjb21tYW5kSW5kZXggPCBwYXJzZWRDb21tYW5kcy5sZW5ndGg7XG4gICAgICAgIGNvbW1hbmRJbmRleCsrXG4gICAgICApIHtcbiAgICAgICAgY29uc3QgX2ZyYW1lOiBhbnkgPSBXU0NvbW1hbmQuY29tcHJlc3MoXG4gICAgICAgICAgdGhpcy5hdmFpbGFibGVDb21tYW5kcyxcbiAgICAgICAgICBwYXJzZWRDb21tYW5kc1tjb21tYW5kSW5kZXhdLFxuICAgICAgICApO1xuICAgICAgICBpZiAoIV9mcmFtZSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIFwiW2lvLmFuaW1hdGlvbi5zdGF0ZXMuc3RhdGVdb25seSBpbyBvciBwd20gY29tbWFuZHMuIFBsZWF2ZSBwcm92aWRlIHN0YXRlIGF0IGxlYXN0IG9uZSBvZiB0aGVtLlwiLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvbXByZXNzZWQpIHtcbiAgICAgICAgICBjb25zdCBfY29tYmluZWQ6IGFueSA9IG5ldyBVaW50OEFycmF5KGNvbXByZXNzZWQubGVuZ3RoICsgX2ZyYW1lLmxlbmd0aCk7XG4gICAgICAgICAgX2NvbWJpbmVkLnNldChjb21wcmVzc2VkLCAwKTtcbiAgICAgICAgICBfY29tYmluZWQuc2V0KF9mcmFtZSwgY29tcHJlc3NlZC5sZW5ndGgpO1xuICAgICAgICAgIGNvbXByZXNzZWQgPSBfY29tYmluZWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29tcHJlc3NlZCA9IF9mcmFtZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFjb21wcmVzc2VkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBcIltpby5hbmltYXRpb24uc3RhdGVzLnN0YXRlXW9ubHkgaW8gb3IgcHdtIGNvbW1hbmRzLiBQbGVhdmUgcHJvdmlkZSBzdGF0ZSBhdCBsZWFzdCBvbmUgb2YgdGhlbS5cIixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGxlbmd0aDogYW55ID0gY29tcHJlc3NlZC5ieXRlTGVuZ3RoO1xuXG4gICAgICBjb25zdCBjb21tYW5kSGVhZGVyOiBhbnkgPSBuZXcgVWludDhBcnJheSg4KTtcbiAgICAgIGNvbW1hbmRIZWFkZXJbMF0gPSBsZW5ndGggPj4gKDggKiAzKTtcbiAgICAgIGNvbW1hbmRIZWFkZXJbMV0gPSBsZW5ndGggPj4gKDggKiAyKTtcbiAgICAgIGNvbW1hbmRIZWFkZXJbMl0gPSBsZW5ndGggPj4gKDggKiAxKTtcbiAgICAgIGNvbW1hbmRIZWFkZXJbM10gPSBsZW5ndGg7XG4gICAgICBjb21tYW5kSGVhZGVyWzRdID0gZHVyYXRpb24gPj4gKDggKiAzKTtcbiAgICAgIGNvbW1hbmRIZWFkZXJbNV0gPSBkdXJhdGlvbiA+PiAoOCAqIDIpO1xuICAgICAgY29tbWFuZEhlYWRlcls2XSA9IGR1cmF0aW9uID4+ICg4ICogMSk7XG4gICAgICBjb21tYW5kSGVhZGVyWzddID0gZHVyYXRpb247XG5cbiAgICAgIGNvbnN0IGNvbWJpbmVkOiBhbnkgPSBuZXcgVWludDhBcnJheShcbiAgICAgICAgZnJhbWUuYnl0ZUxlbmd0aCArIGNvbW1hbmRIZWFkZXIuYnl0ZUxlbmd0aCArIGNvbXByZXNzZWQuYnl0ZUxlbmd0aCxcbiAgICAgICk7XG4gICAgICBjb21iaW5lZC5zZXQoZnJhbWUsIDApO1xuICAgICAgY29tYmluZWQuc2V0KGNvbW1hbmRIZWFkZXIsIGZyYW1lLmJ5dGVMZW5ndGgpO1xuICAgICAgY29tYmluZWQuc2V0KGNvbXByZXNzZWQsIGZyYW1lLmJ5dGVMZW5ndGggKyBjb21tYW5kSGVhZGVyLmJ5dGVMZW5ndGgpO1xuXG4gICAgICBmcmFtZSA9IGNvbWJpbmVkO1xuICAgIH1cblxuICAgIGlmIChmcmFtZS5ieXRlTGVuZ3RoID4gMTAwMCkge1xuICAgICAgLy8gMWtieXRlIG92ZXJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIltpby5hbmltYXRpb25dVG9vIGJpZyBhbmltYXRpb24gZGF0YXNcIik7XG4gICAgfVxuXG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kUmVnaXN0cmF0ZSwgZnJhbWUpO1xuICB9XG5cbiAgcHVibGljIGNoYW5nZVN0YXRlKHBhcmFtczogYW55KSB7XG4gICAgaWYgKHBhcmFtcy5hbmltYXRpb24uc3RhdHVzID09PSBcInJlc3VtZVwiKSB7XG4gICAgICBjb25zdCBuYW1lQXJyYXk6IGFueSA9IE9ibml6VXRpbC5zdHJpbmcyZGF0YUFycmF5KHBhcmFtcy5hbmltYXRpb24ubmFtZSk7XG4gICAgICBjb25zdCBmcmFtZTogYW55ID0gbmV3IFVpbnQ4QXJyYXkobmFtZUFycmF5Lmxlbmd0aCArIDIpO1xuICAgICAgZnJhbWVbMF0gPSBuYW1lQXJyYXkubGVuZ3RoICsgMTtcbiAgICAgIGZyYW1lLnNldChuYW1lQXJyYXksIDEpO1xuICAgICAgZnJhbWVbZnJhbWUuYnl0ZUxlbmd0aCAtIDFdID0gMDtcbiAgICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZFJlc3VtZSwgZnJhbWUpO1xuICAgIH0gZWxzZSBpZiAocGFyYW1zLmFuaW1hdGlvbi5zdGF0dXMgPT09IFwicGF1c2VcIikge1xuICAgICAgY29uc3QgbmFtZUFycmF5OiBhbnkgPSBPYm5pelV0aWwuc3RyaW5nMmRhdGFBcnJheShwYXJhbXMuYW5pbWF0aW9uLm5hbWUpO1xuICAgICAgY29uc3QgZnJhbWU6IGFueSA9IG5ldyBVaW50OEFycmF5KG5hbWVBcnJheS5sZW5ndGggKyAyKTtcbiAgICAgIGZyYW1lWzBdID0gbmFtZUFycmF5Lmxlbmd0aCArIDE7XG4gICAgICBmcmFtZS5zZXQobmFtZUFycmF5LCAxKTtcbiAgICAgIGZyYW1lW2ZyYW1lLmJ5dGVMZW5ndGggLSAxXSA9IDA7XG4gICAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRQYXVzZSwgZnJhbWUpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBwYXJzZUZyb21Kc29uKGpzb246IGFueSkge1xuICAgIGxldCBwYXJlbnRDb21tYW5kTm90Rm91bmQ6IGFueSA9IGZhbHNlO1xuICAgIHRyeSB7XG4gICAgICBzdXBlci5wYXJzZUZyb21Kc29uKGpzb24pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIHRoaXMuV1NDb21tYW5kTm90Rm91bmRFcnJvcikge1xuICAgICAgICBwYXJlbnRDb21tYW5kTm90Rm91bmQgPSB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IG1vZHVsZTogYW55ID0ganNvbi5pbztcbiAgICBpZiAobW9kdWxlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBzY2hlbWFEYXRhOiBhbnkgPSBbXG4gICAgICB7dXJpOiBcIi9yZXF1ZXN0L2lvQW5pbWF0aW9uL2luaXRcIiwgb25WYWxpZDogdGhpcy5pbml0fSxcbiAgICAgIHt1cmk6IFwiL3JlcXVlc3QvaW9BbmltYXRpb24vY2hhbmdlU3RhdGVcIiwgb25WYWxpZDogdGhpcy5jaGFuZ2VTdGF0ZX0sXG4gICAgXTtcbiAgICBjb25zdCByZXM6IGFueSA9IHRoaXMudmFsaWRhdGVDb21tYW5kU2NoZW1hKHNjaGVtYURhdGEsIG1vZHVsZSwgXCJpb1wiLCBtb2R1bGUpO1xuXG4gICAgaWYgKHJlcy52YWxpZCA9PT0gMCAmJiBwYXJlbnRDb21tYW5kTm90Rm91bmQpIHtcbiAgICAgIGlmIChyZXMuaW52YWxpZEJ1dExpa2UubGVuZ3RoID4gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVzLmludmFsaWRCdXRMaWtlWzBdLm1lc3NhZ2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgV1NDb21tYW5kTm90Rm91bmRFcnJvcjogYW55ID0gdGhpcy5XU0NvbW1hbmROb3RGb3VuZEVycm9yO1xuICAgICAgICB0aHJvdyBuZXcgV1NDb21tYW5kTm90Rm91bmRFcnJvcihgW2lvLmFuaW1hdGlvbl11bmtub3duIGNvbW1hbmRgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbm90aWZ5RnJvbUJpbmFyeShvYmpUb1NlbmQ6IGFueSwgZnVuYzogYW55LCBwYXlsb2FkOiBhbnkpIHtcbiAgICBpZiAoZnVuYyA9PT0gdGhpcy5fQ29tbWFuZE5vdGlmeSkge1xuICAgICAgY29uc3QgbmFtZTogYW55ID0gT2JuaXpVdGlsLmRhdGFBcnJheTJzdHJpbmcoXG4gICAgICAgIHBheWxvYWQuc2xpY2UoMiwgcGF5bG9hZC5ieXRlTGVuZ3RoIC0gMSksXG4gICAgICApOyAvLyByZW1vdmUgbnVsbCBzdHJpbmdcblxuICAgICAgb2JqVG9TZW5kLmlvID0ge1xuICAgICAgICBhbmltYXRpb246IHtcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIHN0YXR1czogXCJmaW5pc2hcIixcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHN1cGVyLm5vdGlmeUZyb21CaW5hcnkob2JqVG9TZW5kLCBmdW5jLCBwYXlsb2FkKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==

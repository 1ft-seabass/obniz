"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class PCA9685_PWM {
    constructor(chip, id) {
        this.chip = chip;
        this.id = id;
        this.value = 0;
        this.state = {};
    }
    freq(frequency) {
        this.chip.freq(frequency);
    }
    pulse(value) {
        this.chip.pulse(this.id, value);
    }
    duty(value) {
        this.chip.duty(this.id, value);
    }
}
// tslint:disable-next-line:max-classes-per-file
class PCA9685 {
    constructor() {
        /* https://www.nxp.com/docs/en/data-sheet/PCA9685.pdf */
        this.keys = [
            "gnd",
            "vcc",
            "scl",
            "sda",
            "oe",
            "i2c",
            "enabled",
            "address",
            "drive",
        ];
        this.requiredKeys = [];
        this.address = 0x40;
        this._commands = {
            MODE1: 0x00,
            MODE2: 0x01,
            SUBADR1: 0x02,
            SUBADR2: 0x03,
            SUBADR3: 0x04,
            PRESCALE: 0xfe,
            LED0_ON_L: 0x06,
            ALL_LED_ON_L: 0xfa,
            bits: {
                ALLCALL: 0x01,
                SLEEP_ENABLE: 0x10,
                AUTO_INCREMENT_ENABLED: 0x20,
                RESTART: 0x80,
                OUTDRV: 0x04,
                INVRT: 0x10,
            },
        };
        this._regs = new Array(1);
        this.pwmNum = 16;
        this.pwms = [];
        this._preparePWM(this.pwmNum);
    }
    static info() {
        return {
            name: "PCA9685",
        };
    }
    wired(obniz) {
        this.obniz = obniz;
        if (obniz.isValidIO(this.params.oe)) {
            this.io_oe = obniz.getIO(this.params.oe);
        }
        this.obniz.setVccGnd(this.params.vcc, this.params.gnd, "5v");
        if (typeof this.params.address === "number") {
            this.address = this.params.address;
        }
        this.params.clock = this.params.clock || 400 * 1000; // for i2c
        this.params.mode = this.params.mode || "master"; // for i2c
        this.params.pull = this.params.pull || "5v"; // for i2c
        this.i2c = obniz.getI2CWithConfig(this.params);
        if (this.obniz.isValidIO(this.params.srclr)) {
            this.io_srclr = this.obniz.getIO(this.params.srclr);
            this.io_srclr.output(true);
        }
        if (typeof this.params.enabled !== "boolean") {
            this.params.enabled = true;
        }
        if (this.io_oe && this.params.enabled) {
            this.io_oe.output(false);
        }
        if (this.params.drive === "open-drain") {
            this.i2c.write(this.address, [
                this._commands.MODE2,
                this._commands.bits.OUTDRV,
            ]);
        }
        let mode1 = this._commands.bits.AUTO_INCREMENT_ENABLED;
        mode1 = mode1 & ~this._commands.bits.SLEEP_ENABLE;
        this.i2c.write(this.address, [this._commands.MODE1, mode1]);
        this.i2c.write(this.address, [
            this._commands.MODE1,
            mode1 | this._commands.bits.RESTART,
        ]);
        this._regs[this._commands.MODE1] = mode1;
        obniz.wait(10);
    }
    _preparePWM(num) {
        for (let i = 0; i < num; i++) {
            this.pwms.push(new PCA9685_PWM(this, i));
        }
    }
    isValidPWM(id) {
        return typeof id === "number" && id >= 0 && id < this.pwmNum;
    }
    getPWM(id) {
        if (!this.isValidPWM(id)) {
            throw new Error("pwm " + id + " is not valid pwm");
        }
        return this.pwms[id];
    }
    freq(frequency) {
        if (typeof frequency !== "number") {
            return;
        }
        if (frequency < 24 || 1526 < frequency) {
            throw new Error("freq must be within 24-1526 hz");
        }
        if (this._freq === frequency) {
            return;
        }
        let prescaleval = 25000000.0; // 25MHz
        prescaleval /= 4096.0; // 12bit
        prescaleval /= frequency * 0.9;
        prescaleval -= 1.0;
        const prescale = Math.floor(Math.floor(prescaleval + 0.5));
        const mode1 = this._regs[this._commands.MODE1];
        this.i2c.write(this.address, [
            this._commands.MODE1,
            (mode1 & 0x7f) | this._commands.bits.SLEEP_ENABLE,
        ]); // enter sleep
        this.i2c.write(this.address, [this._commands.PRESCALE, prescale]);
        this.i2c.write(this.address, [this._commands.MODE1, mode1]); // recover from sleep
        this.obniz.wait(5);
        // save
        this._freq = frequency;
        for (let i = 0; i < this.pwms.length; i++) {
            this.pwms[i].state.freq = this._freq;
        }
    }
    pulse(id, pulse_width) {
        if (typeof this._freq !== "number" || this._freq <= 0) {
            throw new Error("please provide freq first.");
        }
        this.duty(id, (pulse_width / 1000.0 / (1.0 / this._freq)) * 100);
    }
    duty(id, duty) {
        duty *= 1.0;
        if (typeof this._freq !== "number" || this._freq <= 0) {
            throw new Error("please provide freq first.");
        }
        if (typeof duty !== "number") {
            throw new Error("please provide duty in number");
        }
        if (duty < 0) {
            duty = 0;
        }
        if (duty > 100) {
            duty = 100;
        }
        this.getPWM(id).state.duty = duty;
        this.writeSingleONOFF(id, 0, (duty / 100.0) * 4095);
    }
    writeSingleONOFF(id, on, off) {
        this.i2c.write(this.address, [
            this._commands.LED0_ON_L + 4 * id,
            on & 0xff,
            on >> 8,
            off & 0xff,
            off >> 8,
        ]);
    }
    setEnable(enable) {
        if (!this.io_oe && enable === false) {
            throw new Error('pin "oe" is not specified');
        }
        this.io_oe.output(!enable);
    }
}
exports.default = PCA9685;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXJ0cy9Nb3ZpbmcvUENBOTY4NS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLE1BQU0sV0FBVztJQUtmLFlBQVksSUFBUyxFQUFFLEVBQU87UUFDNUIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFDYixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztRQUNmLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO0lBQ2xCLENBQUM7SUFFTSxJQUFJLENBQUMsU0FBYztRQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRU0sS0FBSyxDQUFDLEtBQVU7UUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRU0sSUFBSSxDQUFDLEtBQVU7UUFDcEIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNqQyxDQUFDO0NBQ0Y7QUFFRCxnREFBZ0Q7QUFDaEQsTUFBTSxPQUFPO0lBMEJYO1FBQ0Usd0RBQXdEO1FBQ3hELElBQUksQ0FBQyxJQUFJLEdBQUc7WUFDVixLQUFLO1lBQ0wsS0FBSztZQUNMLEtBQUs7WUFDTCxLQUFLO1lBQ0wsSUFBSTtZQUNKLEtBQUs7WUFDTCxTQUFTO1lBQ1QsU0FBUztZQUNULE9BQU87U0FDUixDQUFDO1FBQ0YsSUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7UUFFdkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFFcEIsSUFBSSxDQUFDLFNBQVMsR0FBRztZQUNmLEtBQUssRUFBRSxJQUFJO1lBQ1gsS0FBSyxFQUFFLElBQUk7WUFDWCxPQUFPLEVBQUUsSUFB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QUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztTQUM5QztRQUNELElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDN0IsQ0FBQztDQUNGO0FBRUQsa0JBQWUsT0FBTyxDQUFDIiwiZmlsZSI6InNyYy9wYXJ0cy9Nb3ZpbmcvUENBOTY4NS9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuY2xhc3MgUENBOTY4NV9QV00ge1xuICBwdWJsaWMgY2hpcDogYW55O1xuICBwdWJsaWMgaWQ6IGFueTtcbiAgcHVibGljIHZhbHVlOiBhbnk7XG4gIHB1YmxpYyBzdGF0ZTogYW55O1xuICBjb25zdHJ1Y3RvcihjaGlwOiBhbnksIGlkOiBhbnkpIHtcbiAgICB0aGlzLmNoaXAgPSBjaGlwO1xuICAgIHRoaXMuaWQgPSBpZDtcbiAgICB0aGlzLnZhbHVlID0gMDtcbiAgICB0aGlzLnN0YXRlID0ge307XG4gIH1cblxuICBwdWJsaWMgZnJlcShmcmVxdWVuY3k6IGFueSkge1xuICAgIHRoaXMuY2hpcC5mcmVxKGZyZXF1ZW5jeSk7XG4gIH1cblxuICBwdWJsaWMgcHVsc2UodmFsdWU6IGFueSkge1xuICAgIHRoaXMuY2hpcC5wdWxzZSh0aGlzLmlkLCB2YWx1ZSk7XG4gIH1cblxuICBwdWJsaWMgZHV0eSh2YWx1ZTogYW55KSB7XG4gICAgdGhpcy5jaGlwLmR1dHkodGhpcy5pZCwgdmFsdWUpO1xuICB9XG59XG5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtY2xhc3Nlcy1wZXItZmlsZVxuY2xhc3MgUENBOTY4NSB7XG5cbiAgcHVibGljIHN0YXRpYyBpbmZvKCkge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiBcIlBDQTk2ODVcIixcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIGtleXM6IGFueTtcbiAgcHVibGljIHJlcXVpcmVkS2V5czogYW55O1xuICBwdWJsaWMgYWRkcmVzczogYW55O1xuICBwdWJsaWMgX2NvbW1hbmRzOiBhbnk7XG4gIHB1YmxpYyBfcmVnczogYW55O1xuICBwdWJsaWMgcHdtTnVtOiBhbnk7XG4gIHB1YmxpYyBwd21zOiBhbnk7XG4gIHB1YmxpYyBvYm5pejogYW55O1xuICBwdWJsaWMgcGFyYW1zOiBhbnk7XG4gIHB1YmxpYyBpb19vZTogYW55O1xuICBwdWJsaWMgaTJjOiBhbnk7XG4gIHB1YmxpYyBpb19zcmNscjogYW55O1xuICBwdWJsaWMgY2hpcDogYW55O1xuICBwdWJsaWMgaWQ6IGFueTtcbiAgcHVibGljIHZhbHVlOiBhbnk7XG4gIHB1YmxpYyBzdGF0ZTogYW55O1xuICBwdWJsaWMgX2ZyZXE6IGFueTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICAvKiBodHRwczovL3d3dy5ueHAuY29tL2RvY3MvZW4vZGF0YS1zaGVldC9QQ0E5Njg1LnBkZiAqL1xuICAgIHRoaXMua2V5cyA9IFtcbiAgICAgIFwiZ25kXCIsXG4gICAgICBcInZjY1wiLFxuICAgICAgXCJzY2xcIixcbiAgICAgIFwic2RhXCIsXG4gICAgICBcIm9lXCIsXG4gICAgICBcImkyY1wiLFxuICAgICAgXCJlbmFibGVkXCIsXG4gICAgICBcImFkZHJlc3NcIixcbiAgICAgIFwiZHJpdmVcIixcbiAgICBdO1xuICAgIHRoaXMucmVxdWlyZWRLZXlzID0gW107XG5cbiAgICB0aGlzLmFkZHJlc3MgPSAweDQwO1xuXG4gICAgdGhpcy5fY29tbWFuZHMgPSB7XG4gICAgICBNT0RFMTogMHgwMCxcbiAgICAgIE1PREUyOiAweDAxLFxuICAgICAgU1VCQURSMTogMHgwMixcbiAgICAgIFNVQkFEUjI6IDB4MDMsXG4gICAgICBTVUJBRFIzOiAweDA0LFxuICAgICAgUFJFU0NBTEU6IDB4ZmUsXG4gICAgICBMRUQwX09OX0w6IDB4MDYsXG4gICAgICBBTExfTEVEX09OX0w6IDB4ZmEsXG4gICAgICBiaXRzOiB7XG4gICAgICAgIEFMTENBTEw6IDB4MDEsXG4gICAgICAgIFNMRUVQX0VOQUJMRTogMHgxMCxcbiAgICAgICAgQVVUT19JTkNSRU1FTlRfRU5BQkxFRDogMHgyMCxcbiAgICAgICAgUkVTVEFSVDogMHg4MCxcblxuICAgICAgICBPVVREUlY6IDB4MDQsXG4gICAgICAgIElOVlJUOiAweDEwLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdGhpcy5fcmVncyA9IG5ldyBBcnJheSgxKTtcblxuICAgIHRoaXMucHdtTnVtID0gMTY7XG4gICAgdGhpcy5wd21zID0gW107XG4gICAgdGhpcy5fcHJlcGFyZVBXTSh0aGlzLnB3bU51bSk7XG4gIH1cblxuICBwdWJsaWMgd2lyZWQob2JuaXo6IGFueSkge1xuICAgIHRoaXMub2JuaXogPSBvYm5pejtcblxuICAgIGlmIChvYm5pei5pc1ZhbGlkSU8odGhpcy5wYXJhbXMub2UpKSB7XG4gICAgICB0aGlzLmlvX29lID0gb2JuaXouZ2V0SU8odGhpcy5wYXJhbXMub2UpO1xuICAgIH1cblxuICAgIHRoaXMub2JuaXouc2V0VmNjR25kKHRoaXMucGFyYW1zLnZjYywgdGhpcy5wYXJhbXMuZ25kLCBcIjV2XCIpO1xuXG4gICAgaWYgKHR5cGVvZiB0aGlzLnBhcmFtcy5hZGRyZXNzID09PSBcIm51bWJlclwiKSB7XG4gICAgICB0aGlzLmFkZHJlc3MgPSB0aGlzLnBhcmFtcy5hZGRyZXNzO1xuICAgIH1cblxuICAgIHRoaXMucGFyYW1zLmNsb2NrID0gdGhpcy5wYXJhbXMuY2xvY2sgfHwgNDAwICogMTAwMDsgLy8gZm9yIGkyY1xuICAgIHRoaXMucGFyYW1zLm1vZGUgPSB0aGlzLnBhcmFtcy5tb2RlIHx8IFwibWFzdGVyXCI7IC8vIGZvciBpMmNcbiAgICB0aGlzLnBhcmFtcy5wdWxsID0gdGhpcy5wYXJhbXMucHVsbCB8fCBcIjV2XCI7IC8vIGZvciBpMmNcbiAgICB0aGlzLmkyYyA9IG9ibml6LmdldEkyQ1dpdGhDb25maWcodGhpcy5wYXJhbXMpO1xuXG4gICAgaWYgKHRoaXMub2JuaXouaXNWYWxpZElPKHRoaXMucGFyYW1zLnNyY2xyKSkge1xuICAgICAgdGhpcy5pb19zcmNsciA9IHRoaXMub2JuaXouZ2V0SU8odGhpcy5wYXJhbXMuc3JjbHIpO1xuICAgICAgdGhpcy5pb19zcmNsci5vdXRwdXQodHJ1ZSk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiB0aGlzLnBhcmFtcy5lbmFibGVkICE9PSBcImJvb2xlYW5cIikge1xuICAgICAgdGhpcy5wYXJhbXMuZW5hYmxlZCA9IHRydWU7XG4gICAgfVxuICAgIGlmICh0aGlzLmlvX29lICYmIHRoaXMucGFyYW1zLmVuYWJsZWQpIHtcbiAgICAgIHRoaXMuaW9fb2Uub3V0cHV0KGZhbHNlKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wYXJhbXMuZHJpdmUgPT09IFwib3Blbi1kcmFpblwiKSB7XG4gICAgICB0aGlzLmkyYy53cml0ZSh0aGlzLmFkZHJlc3MsIFtcbiAgICAgICAgdGhpcy5fY29tbWFuZHMuTU9ERTIsXG4gICAgICAgIHRoaXMuX2NvbW1hbmRzLmJpdHMuT1VURFJWLFxuICAgICAgXSk7XG4gICAgfVxuXG4gICAgbGV0IG1vZGUxOiBhbnkgPSB0aGlzLl9jb21tYW5kcy5iaXRzLkFVVE9fSU5DUkVNRU5UX0VOQUJMRUQ7XG4gICAgbW9kZTEgPSBtb2RlMSAmIH50aGlzLl9jb21tYW5kcy5iaXRzLlNMRUVQX0VOQUJMRTtcbiAgICB0aGlzLmkyYy53cml0ZSh0aGlzLmFkZHJlc3MsIFt0aGlzLl9jb21tYW5kcy5NT0RFMSwgbW9kZTFdKTtcbiAgICB0aGlzLmkyYy53cml0ZSh0aGlzLmFkZHJlc3MsIFtcbiAgICAgIHRoaXMuX2NvbW1hbmRzLk1PREUxLFxuICAgICAgbW9kZTEgfCB0aGlzLl9jb21tYW5kcy5iaXRzLlJFU1RBUlQsXG4gICAgXSk7XG5cbiAgICB0aGlzLl9yZWdzW3RoaXMuX2NvbW1hbmRzLk1PREUxXSA9IG1vZGUxO1xuXG4gICAgb2JuaXoud2FpdCgxMCk7XG4gIH1cblxuICBwdWJsaWMgX3ByZXBhcmVQV00obnVtOiBhbnkpIHtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtOyBpKyspIHtcbiAgICAgIHRoaXMucHdtcy5wdXNoKG5ldyBQQ0E5Njg1X1BXTSh0aGlzLCBpKSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGlzVmFsaWRQV00oaWQ6IGFueSkge1xuICAgIHJldHVybiB0eXBlb2YgaWQgPT09IFwibnVtYmVyXCIgJiYgaWQgPj0gMCAmJiBpZCA8IHRoaXMucHdtTnVtO1xuICB9XG5cbiAgcHVibGljIGdldFBXTShpZDogYW55KSB7XG4gICAgaWYgKCF0aGlzLmlzVmFsaWRQV00oaWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwd20gXCIgKyBpZCArIFwiIGlzIG5vdCB2YWxpZCBwd21cIik7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnB3bXNbaWRdO1xuICB9XG5cbiAgcHVibGljIGZyZXEoZnJlcXVlbmN5OiBhbnkpIHtcbiAgICBpZiAodHlwZW9mIGZyZXF1ZW5jeSAhPT0gXCJudW1iZXJcIikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoZnJlcXVlbmN5IDwgMjQgfHwgMTUyNiA8IGZyZXF1ZW5jeSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiZnJlcSBtdXN0IGJlIHdpdGhpbiAyNC0xNTI2IGh6XCIpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fZnJlcSA9PT0gZnJlcXVlbmN5KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBwcmVzY2FsZXZhbDogYW55ID0gMjUwMDAwMDAuMDsgLy8gMjVNSHpcbiAgICBwcmVzY2FsZXZhbCAvPSA0MDk2LjA7IC8vIDEyYml0XG4gICAgcHJlc2NhbGV2YWwgLz0gZnJlcXVlbmN5ICogMC45O1xuICAgIHByZXNjYWxldmFsIC09IDEuMDtcblxuICAgIGNvbnN0IHByZXNjYWxlOiBhbnkgPSBNYXRoLmZsb29yKE1hdGguZmxvb3IocHJlc2NhbGV2YWwgKyAwLjUpKTtcbiAgICBjb25zdCBtb2RlMTogYW55ID0gdGhpcy5fcmVnc1t0aGlzLl9jb21tYW5kcy5NT0RFMV07XG5cbiAgICB0aGlzLmkyYy53cml0ZSh0aGlzLmFkZHJlc3MsIFtcbiAgICAgIHRoaXMuX2NvbW1hbmRzLk1PREUxLFxuICAgICAgKG1vZGUxICYgMHg3ZikgfCB0aGlzLl9jb21tYW5kcy5iaXRzLlNMRUVQX0VOQUJMRSxcbiAgICBdKTsgLy8gZW50ZXIgc2xlZXBcbiAgICB0aGlzLmkyYy53cml0ZSh0aGlzLmFkZHJlc3MsIFt0aGlzLl9jb21tYW5kcy5QUkVTQ0FMRSwgcHJlc2NhbGVdKTtcbiAgICB0aGlzLmkyYy53cml0ZSh0aGlzLmFkZHJlc3MsIFt0aGlzLl9jb21tYW5kcy5NT0RFMSwgbW9kZTFdKTsgLy8gcmVjb3ZlciBmcm9tIHNsZWVwXG5cbiAgICB0aGlzLm9ibml6LndhaXQoNSk7XG5cbiAgICAvLyBzYXZlXG4gICAgdGhpcy5fZnJlcSA9IGZyZXF1ZW5jeTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucHdtcy5sZW5ndGg7IGkrKykge1xuICAgICAgdGhpcy5wd21zW2ldLnN0YXRlLmZyZXEgPSB0aGlzLl9mcmVxO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBwdWxzZShpZDogYW55LCBwdWxzZV93aWR0aDogYW55KSB7XG4gICAgaWYgKHR5cGVvZiB0aGlzLl9mcmVxICE9PSBcIm51bWJlclwiIHx8IHRoaXMuX2ZyZXEgPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwicGxlYXNlIHByb3ZpZGUgZnJlcSBmaXJzdC5cIik7XG4gICAgfVxuICAgIHRoaXMuZHV0eShpZCwgKHB1bHNlX3dpZHRoIC8gMTAwMC4wIC8gKDEuMCAvIHRoaXMuX2ZyZXEpKSAqIDEwMCk7XG4gIH1cblxuICBwdWJsaWMgZHV0eShpZDogYW55LCBkdXR5OiBhbnkpIHtcbiAgICBkdXR5ICo9IDEuMDtcbiAgICBpZiAodHlwZW9mIHRoaXMuX2ZyZXEgIT09IFwibnVtYmVyXCIgfHwgdGhpcy5fZnJlcSA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwbGVhc2UgcHJvdmlkZSBmcmVxIGZpcnN0LlwiKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBkdXR5ICE9PSBcIm51bWJlclwiKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwbGVhc2UgcHJvdmlkZSBkdXR5IGluIG51bWJlclwiKTtcbiAgICB9XG4gICAgaWYgKGR1dHkgPCAwKSB7XG4gICAgICBkdXR5ID0gMDtcbiAgICB9XG4gICAgaWYgKGR1dHkgPiAxMDApIHtcbiAgICAgIGR1dHkgPSAxMDA7XG4gICAgfVxuICAgIHRoaXMuZ2V0UFdNKGlkKS5zdGF0ZS5kdXR5ID0gZHV0eTtcbiAgICB0aGlzLndyaXRlU2luZ2xlT05PRkYoaWQsIDAsIChkdXR5IC8gMTAwLjApICogNDA5NSk7XG4gIH1cblxuICBwdWJsaWMgd3JpdGVTaW5nbGVPTk9GRihpZDogYW55LCBvbjogYW55LCBvZmY6IGFueSkge1xuICAgIHRoaXMuaTJjLndyaXRlKHRoaXMuYWRkcmVzcywgW1xuICAgICAgdGhpcy5fY29tbWFuZHMuTEVEMF9PTl9MICsgNCAqIGlkLFxuICAgICAgb24gJiAweGZmLFxuICAgICAgb24gPj4gOCxcbiAgICAgIG9mZiAmIDB4ZmYsXG4gICAgICBvZmYgPj4gOCxcbiAgICBdKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRFbmFibGUoZW5hYmxlOiBhbnkpIHtcbiAgICBpZiAoIXRoaXMuaW9fb2UgJiYgZW5hYmxlID09PSBmYWxzZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdwaW4gXCJvZVwiIGlzIG5vdCBzcGVjaWZpZWQnKTtcbiAgICB9XG4gICAgdGhpcy5pb19vZS5vdXRwdXQoIWVuYWJsZSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUENBOTY4NTtcbiJdfQ==

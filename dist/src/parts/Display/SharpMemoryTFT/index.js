"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class SharpMemoryTFT {
    constructor() {
        this.keys = [
            "vcc",
            "gnd",
            "vcc_a",
            "gnd_a",
            "sclk",
            "mosi",
            "cs",
            "disp",
            "extcomin",
            "extmode",
            "width",
            "height",
        ];
        this.requiredKeys = ["sclk", "mosi", "cs", "width", "height"];
        this.commands = {};
        this.commands.write = 0x80;
        this.commands.clear = 0x20;
        this.commands.vcom = 0x40;
        this._canvas = null;
        this._reset();
    }
    static info() {
        return {
            name: "SharpMemoryTFT",
        };
    }
    wired(obniz) {
        this.obniz = obniz;
        this.io_cs = obniz.getIO(this.params.cs);
        if (this.params.disp && this.params.extcomin && this.params.extmode) {
            this.io_disp = obniz.getIO(this.params.disp);
            this.io_extcomin = obniz.getIO(this.params.extcomin);
            this.io_extmode = obniz.getIO(this.params.extmode);
            this.io_disp.output(true);
            this.io_extcomin.output(false);
            this.io_extmode.output(false);
        }
        obniz.setVccGnd(this.params.vcc, this.params.gnd, "5v");
        obniz.setVccGnd(this.params.vcc_a, this.params.gnd_a, "5v");
        this.params.mode = "master";
        this.params.frequency = 1000 * 1000;
        this.params.clk = this.params.sclk;
        this.params.drive = "5v"; // It over spec for frequency. But VIN-HI require 0.7VCC<=.
        this.spi = this.obniz.getSpiWithConfig(this.params);
        this.width = this.params.width;
        this.height = this.params.height;
        this.obniz.wait(100);
    }
    _reverseBits(data) {
        let revData = 0;
        for (let i = 0; i < 8; i++) {
            revData += data & 0x01;
            data >>= 1;
            if (i < 7) {
                revData <<= 1;
            }
        }
        return revData;
    }
    sendLSB(data) {
        this.spi.write([this._reverseBits(data)]);
    }
    sendClear() {
        this.io_cs.output(true);
        this.spi.write([this.commands.clear | 0x00, 0x00]);
        this.io_cs.output(false);
    }
    raw(rawData) {
        let oldline;
        let currentline;
        const totalbytes = (this.width * this.height) / 8;
        let array = new Array(1024);
        let index = 0;
        array[index++] = this.commands.write | this.commands.vcom;
        oldline = currentline = 1;
        array[index++] = this._reverseBits(currentline);
        this.io_cs.output(true);
        for (let i = 0; i < totalbytes; i++) {
            array[index++] = rawData[i]; // lsb
            currentline = Math.floor((i + 1) / (this.width / 8) + 1);
            if (currentline !== oldline) {
                array[index++] = 0x00;
                if (currentline <= this.height) {
                    array[index++] = this._reverseBits(currentline);
                }
                oldline = currentline;
            }
            if (index >= 1021) {
                // regarding SPI max.
                this.spi.write(array.slice(0, index));
                array = new Array(1024);
                index = 0;
            }
        }
        if (index > 0) {
            this.spi.write(array.slice(0, index));
        }
        this.spi.write([0x00]);
        this.io_cs.output(false);
    }
    // copy from display.js
    _reset() {
        this._pos = { x: 0, y: 0 };
        this.autoFlush = true;
    }
    warnCanvasAvailability() {
        if (this.obniz.isNode) {
            throw new Error("MemoryDisplay require node-canvas to draw rich contents. see more detail on docs");
        }
        else {
            throw new Error("MemoryDisplay cant create canvas element to body");
        }
    }
    _preparedCanvas() {
        if (this._canvas) {
            return this._canvas;
        }
        if (this.obniz.isNode) {
            try {
                const { createCanvas } = require("canvas");
                this._canvas = createCanvas(this.width, this.height);
            }
            catch (e) {
                // this.warnCanvasAvailability();
                return null;
            }
        }
        else {
            const identifier = "MemoryDispCanvas-" + this.obniz.id;
            let canvas = document.getElementById(identifier);
            if (!canvas) {
                canvas = document.createElement("canvas");
                canvas.setAttribute("id", identifier);
                canvas.style.visibility = "hidden";
                canvas.width = this.width;
                canvas.height = this.height;
                canvas.style["-webkit-font-smoothing"] = "none";
                const body = document.getElementsByTagName("body")[0];
                body.appendChild(canvas);
            }
            this._canvas = canvas;
        }
        const ctx = this._canvas.getContext("2d");
        ctx.fillStyle = "#FFF";
        ctx.fillRect(0, 0, this.width, this.height);
        ctx.fillStyle = "#000";
        ctx.strokeStyle = "#000";
        this._pos.x = 0;
        this._pos.y = 0;
        this.fontSize = 16;
        ctx.font = `${this.fontSize}px Arial`;
        return this._canvas;
    }
    _ctx() {
        const canvas = this._preparedCanvas();
        if (canvas) {
            return canvas.getContext("2d");
        }
    }
    font(font, size) {
        const ctx = this._ctx();
        if (typeof size !== "number") {
            size = 16;
        }
        if (typeof font !== "string") {
            font = "Arial";
        }
        this.fontSize = size;
        ctx.font = "" + size + "px " + font;
    }
    clear() {
        const ctx = this._ctx();
        this._pos.x = 0;
        this._pos.y = 0;
        if (ctx) {
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, this.width, this.height);
            ctx.fillStyle = "#000";
            ctx.strokeStyle = "#000";
            this.draw(ctx);
        }
        else {
            this.sendClear();
        }
    }
    pos(x, y) {
        this._ctx(); // crete first
        if (typeof x === "number") {
            this._pos.x = x;
        }
        if (typeof y === "number") {
            this._pos.y = y;
        }
        return this._pos;
    }
    print(text) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.fillText(text, this._pos.x, this._pos.y + this.fontSize);
            this.draw(ctx);
            this._pos.y += this.fontSize;
        }
        else {
            /*
            let obj = {};
            obj['display'] = {
              text: '' + text,
            };
            this.obniz.send(obj);
            */
        }
    }
    line(x_0, y_0, x_1, y_1) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.beginPath();
            ctx.moveTo(x_0, y_0);
            ctx.lineTo(x_1, y_1);
            ctx.stroke();
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    rect(x, y, width, height, mustFill) {
        const ctx = this._ctx();
        if (ctx) {
            if (mustFill) {
                ctx.fillRect(x, y, width, height);
            }
            else {
                ctx.strokeRect(x, y, width, height);
            }
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    circle(x, y, r, mustFill) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            if (mustFill) {
                ctx.fill();
            }
            else {
                ctx.stroke();
            }
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    _draw(ctx) {
        const stride = this.width / 8;
        const vram = new Array(stride * 64);
        const imageData = ctx.getImageData(0, 0, this.width, this.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];
            const index = Math.floor(i / 4);
            const line = Math.floor(index / this.width);
            const col = Math.floor((index - line * this.width) / 8);
            const bits = Math.floor(index - line * this.width) % 8;
            if (bits === 0) {
                vram[line * stride + col] = 0x00;
            }
            if (brightness > 0x73) {
                vram[line * stride + col] |= 0x80 >> bits;
            }
        }
        this.raw(vram);
    }
    draw(ctx) {
        if (this.autoFlush) {
            this._draw(ctx);
        }
    }
    drawing(autoFlush) {
        this.autoFlush = autoFlush === true;
        const ctx = this._ctx();
        if (ctx) {
            this.draw(ctx);
        }
    }
}
exports.default = SharpMemoryTFT;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXJ0cy9EaXNwbGF5L1NoYXJwTWVtb3J5VEZUL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTSxjQUFjO0lBMEJsQjtRQUNFLElBQUksQ0FBQyxJQUFJLEdBQUc7WUFDVixLQUFLO1lBQ0wsS0FBSztZQUNMLE9BQU87WUFDUCxPQUFPO1lBQ1AsTUFBTTtZQUNOLE1BQU07WUFDTixJQUFJO1lBQ0osTUFBTTtZQUNOLFVBQVU7WUFDVixTQUFTO1lBQ1QsT0FBTztZQUNQLFFBQVE7U0FDVCxDQUFDO1FBRUYsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUU5RCxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDM0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQzNCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUUxQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUNwQixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQWpETSxNQUFNLENBQUMsSUFBSTtRQUNoQixPQUFPO1lBQ0wsSUFBSSxFQUFFLGdCQUFnQjtTQUN2QixDQUFDO0lBQ0osQ0FBQztJQStDTSxLQUFLLENBQUMsS0FBVTtRQUNyQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUVuQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUV6QyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFO1lBQ25FLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3JELElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQy9CO1FBRUQsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN4RCxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTVELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQztRQUM1QixJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ3BDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ25DLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLDJEQUEyRDtRQUNyRixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMs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QUcsR0FBUSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDN0IsSUFBSSxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2hCO0lBQ0gsQ0FBQztDQUNGO0FBRUQsa0JBQWUsY0FBYyxDQUFDIiwiZmlsZSI6InNyYy9wYXJ0cy9EaXNwbGF5L1NoYXJwTWVtb3J5VEZUL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY2xhc3MgU2hhcnBNZW1vcnlURlQge1xuXG4gIHB1YmxpYyBzdGF0aWMgaW5mbygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogXCJTaGFycE1lbW9yeVRGVFwiLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMga2V5czogYW55O1xuICBwdWJsaWMgcmVxdWlyZWRLZXlzOiBhbnk7XG4gIHB1YmxpYyBjb21tYW5kczogYW55O1xuICBwdWJsaWMgX2NhbnZhczogYW55O1xuICBwdWJsaWMgb2JuaXo6IGFueTtcbiAgcHVibGljIGlvX2NzOiBhbnk7XG4gIHB1YmxpYyBwYXJhbXM6IGFueTtcbiAgcHVibGljIGlvX2Rpc3A6IGFueTtcbiAgcHVibGljIGlvX2V4dGNvbWluOiBhbnk7XG4gIHB1YmxpYyBpb19leHRtb2RlOiBhbnk7XG4gIHB1YmxpYyBzcGk6IGFueTtcbiAgcHVibGljIHdpZHRoOiBhbnk7XG4gIHB1YmxpYyBoZWlnaHQ6IGFueTtcbiAgcHVibGljIF9wb3M6IGFueTtcbiAgcHVibGljIGF1dG9GbHVzaDogYW55O1xuICBwdWJsaWMgZm9udFNpemU6IGFueTtcbiAgcHVibGljIGNyZWF0ZUNhbnZhczogYW55O1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMua2V5cyA9IFtcbiAgICAgIFwidmNjXCIsXG4gICAgICBcImduZFwiLFxuICAgICAgXCJ2Y2NfYVwiLFxuICAgICAgXCJnbmRfYVwiLFxuICAgICAgXCJzY2xrXCIsXG4gICAgICBcIm1vc2lcIixcbiAgICAgIFwiY3NcIixcbiAgICAgIFwiZGlzcFwiLFxuICAgICAgXCJleHRjb21pblwiLFxuICAgICAgXCJleHRtb2RlXCIsXG4gICAgICBcIndpZHRoXCIsXG4gICAgICBcImhlaWdodFwiLFxuICAgIF07XG5cbiAgICB0aGlzLnJlcXVpcmVkS2V5cyA9IFtcInNjbGtcIiwgXCJtb3NpXCIsIFwiY3NcIiwgXCJ3aWR0aFwiLCBcImhlaWdodFwiXTtcblxuICAgIHRoaXMuY29tbWFuZHMgPSB7fTtcbiAgICB0aGlzLmNvbW1hbmRzLndyaXRlID0gMHg4MDtcbiAgICB0aGlzLmNvbW1hbmRzLmNsZWFyID0gMHgyMDtcbiAgICB0aGlzLmNvbW1hbmRzLnZjb20gPSAweDQwO1xuXG4gICAgdGhpcy5fY2FudmFzID0gbnVsbDtcbiAgICB0aGlzLl9yZXNldCgpO1xuICB9XG5cbiAgcHVibGljIHdpcmVkKG9ibml6OiBhbnkpIHtcbiAgICB0aGlzLm9ibml6ID0gb2JuaXo7XG5cbiAgICB0aGlzLmlvX2NzID0gb2JuaXouZ2V0SU8odGhpcy5wYXJhbXMuY3MpO1xuXG4gICAgaWYgKHRoaXMucGFyYW1zLmRpc3AgJiYgdGhpcy5wYXJhbXMuZXh0Y29taW4gJiYgdGhpcy5wYXJhbXMuZXh0bW9kZSkge1xuICAgICAgdGhpcy5pb19kaXNwID0gb2JuaXouZ2V0SU8odGhpcy5wYXJhbXMuZGlzcCk7XG4gICAgICB0aGlzLmlvX2V4dGNvbWluID0gb2JuaXouZ2V0SU8odGhpcy5wYXJhbXMuZXh0Y29taW4pO1xuICAgICAgdGhpcy5pb19leHRtb2RlID0gb2JuaXouZ2V0SU8odGhpcy5wYXJhbXMuZXh0bW9kZSk7XG4gICAgICB0aGlzLmlvX2Rpc3Aub3V0cHV0KHRydWUpO1xuICAgICAgdGhpcy5pb19leHRjb21pbi5vdXRwdXQoZmFsc2UpO1xuICAgICAgdGhpcy5pb19leHRtb2RlLm91dHB1dChmYWxzZSk7XG4gICAgfVxuXG4gICAgb2JuaXouc2V0VmNjR25kKHRoaXMucGFyYW1zLnZjYywgdGhpcy5wYXJhbXMuZ25kLCBcIjV2XCIpO1xuICAgIG9ibml6LnNldFZjY0duZCh0aGlzLnBhcmFtcy52Y2NfYSwgdGhpcy5wYXJhbXMuZ25kX2EsIFwiNXZcIik7XG5cbiAgICB0aGlzLnBhcmFtcy5tb2RlID0gXCJtYXN0ZXJcIjtcbiAgICB0aGlzLnBhcmFtcy5mcmVxdWVuY3kgPSAxMDAwICogMTAwMDtcbiAgICB0aGlzLnBhcmFtcy5jbGsgPSB0aGlzLnBhcmFtcy5zY2xrO1xuICAgIHRoaXMucGFyYW1zLmRyaXZlID0gXCI1dlwiOyAvLyBJdCBvdmVyIHNwZWMgZm9yIGZyZXF1ZW5jeS4gQnV0IFZJTi1ISSByZXF1aXJlIDAuN1ZDQzw9LlxuICAgIHRoaXMuc3BpID0gdGhpcy5vYm5pei5nZXRTcGlXaXRoQ29uZmlnKHRoaXMucGFyYW1zKTtcblxuICAgIHRoaXMud2lkdGggPSB0aGlzLnBhcmFtcy53aWR0aDtcbiAgICB0aGlzLmhlaWdodCA9IHRoaXMucGFyYW1zLmhlaWdodDtcblxuICAgIHRoaXMub2JuaXoud2FpdCgxMDApO1xuICB9XG5cbiAgcHVibGljIF9yZXZlcnNlQml0cyhkYXRhOiBhbnkpIHtcbiAgICBsZXQgcmV2RGF0YTogYW55ID0gMDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDg7IGkrKykge1xuICAgICAgcmV2RGF0YSArPSBkYXRhICYgMHgwMTtcbiAgICAgIGRhdGEgPj49IDE7XG4gICAgICBpZiAoaSA8IDcpIHtcbiAgICAgICAgcmV2RGF0YSA8PD0gMTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJldkRhdGE7XG4gIH1cblxuICBwdWJsaWMgc2VuZExTQihkYXRhOiBhbnkpIHtcbiAgICB0aGlzLnNwaS53cml0ZShbdGhpcy5fcmV2ZXJzZUJpdHMoZGF0YSldKTtcbiAgfVxuXG4gIHB1YmxpYyBzZW5kQ2xlYXIoKSB7XG4gICAgdGhpcy5pb19jcy5vdXRwdXQodHJ1ZSk7XG4gICAgdGhpcy5zcGkud3JpdGUoW3RoaXMuY29tbWFuZHMuY2xlYXIgfCAweDAwLCAweDAwXSk7XG4gICAgdGhpcy5pb19jcy5vdXRwdXQoZmFsc2UpO1xuICB9XG5cbiAgcHVibGljIHJhdyhyYXdEYXRhOiBhbnkpIHtcbiAgICBsZXQgb2xkbGluZTogYW55OyBsZXQgIGN1cnJlbnRsaW5lOiBhbnk7XG4gICAgY29uc3QgdG90YWxieXRlczogYW55ID0gKHRoaXMud2lkdGggKiB0aGlzLmhlaWdodCkgLyA4O1xuICAgIGxldCBhcnJheTogYW55ID0gbmV3IEFycmF5KDEwMjQpO1xuICAgIGxldCBpbmRleDogYW55ID0gMDtcbiAgICBhcnJheVtpbmRleCsrXSA9IHRoaXMuY29tbWFuZHMud3JpdGUgfCB0aGlzLmNvbW1hbmRzLnZjb207XG4gICAgb2xkbGluZSA9IGN1cnJlbnRsaW5lID0gMTtcbiAgICBhcnJheVtpbmRleCsrXSA9IHRoaXMuX3JldmVyc2VCaXRzKGN1cnJlbnRsaW5lKTtcbiAgICB0aGlzLmlvX2NzLm91dHB1dCh0cnVlKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRvdGFsYnl0ZXM7IGkrKykge1xuICAgICAgYXJyYXlbaW5kZXgrK10gPSByYXdEYXRhW2ldOyAvLyBsc2JcbiAgICAgIGN1cnJlbnRsaW5lID0gTWF0aC5mbG9vcigoaSArIDEpIC8gKHRoaXMud2lkdGggLyA4KSArIDEpO1xuICAgICAgaWYgKGN1cnJlbnRsaW5lICE9PSBvbGRsaW5lKSB7XG4gICAgICAgIGFycmF5W2luZGV4KytdID0gMHgwMDtcbiAgICAgICAgaWYgKGN1cnJlbnRsaW5lIDw9IHRoaXMuaGVpZ2h0KSB7XG4gICAgICAgICAgYXJyYXlbaW5kZXgrK10gPSB0aGlzLl9yZXZlcnNlQml0cyhjdXJyZW50bGluZSk7XG4gICAgICAgIH1cbiAgICAgICAgb2xkbGluZSA9IGN1cnJlbnRsaW5lO1xuICAgICAgfVxuICAgICAgaWYgKGluZGV4ID49IDEwMjEpIHtcbiAgICAgICAgLy8gcmVnYXJkaW5nIFNQSSBtYXguXG4gICAgICAgIHRoaXMuc3BpLndyaXRlKGFycmF5LnNsaWNlKDAsIGluZGV4KSk7XG4gICAgICAgIGFycmF5ID0gbmV3IEFycmF5KDEwMjQpO1xuICAgICAgICBpbmRleCA9IDA7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChpbmRleCA+IDApIHtcbiAgICAgIHRoaXMuc3BpLndyaXRlKGFycmF5LnNsaWNlKDAsIGluZGV4KSk7XG4gICAgfVxuICAgIHRoaXMuc3BpLndyaXRlKFsweDAwXSk7XG4gICAgdGhpcy5pb19jcy5vdXRwdXQoZmFsc2UpO1xuICB9XG5cbiAgLy8gY29weSBmcm9tIGRpc3BsYXkuanNcblxuICBwdWJsaWMgX3Jlc2V0KCkge1xuICAgIHRoaXMuX3BvcyA9IHt4OiAwLCB5OiAwfTtcbiAgICB0aGlzLmF1dG9GbHVzaCA9IHRydWU7XG4gIH1cblxuICBwdWJsaWMgd2FybkNhbnZhc0F2YWlsYWJpbGl0eSgpIHtcbiAgICBpZiAodGhpcy5vYm5pei5pc05vZGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJNZW1vcnlEaXNwbGF5IHJlcXVpcmUgbm9kZS1jYW52YXMgdG8gZHJhdyByaWNoIGNvbnRlbnRzLiBzZWUgbW9yZSBkZXRhaWwgb24gZG9jc1wiLFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWVtb3J5RGlzcGxheSBjYW50IGNyZWF0ZSBjYW52YXMgZWxlbWVudCB0byBib2R5XCIpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBfcHJlcGFyZWRDYW52YXMoKSB7XG4gICAgaWYgKHRoaXMuX2NhbnZhcykge1xuICAgICAgcmV0dXJuIHRoaXMuX2NhbnZhcztcbiAgICB9XG4gICAgaWYgKHRoaXMub2JuaXouaXNOb2RlKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7Y3JlYXRlQ2FudmFzfSA9IHJlcXVpcmUoXCJjYW52YXNcIik7XG4gICAgICAgIHRoaXMuX2NhbnZhcyA9IGNyZWF0ZUNhbnZhcyh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIC8vIHRoaXMud2FybkNhbnZhc0F2YWlsYWJpbGl0eSgpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgaWRlbnRpZmllcjogYW55ID0gXCJNZW1vcnlEaXNwQ2FudmFzLVwiICsgdGhpcy5vYm5pei5pZDtcbiAgICAgIGxldCBjYW52YXM6IGFueSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkZW50aWZpZXIpO1xuICAgICAgaWYgKCFjYW52YXMpIHtcbiAgICAgICAgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImNhbnZhc1wiKTtcbiAgICAgICAgY2FudmFzLnNldEF0dHJpYnV0ZShcImlkXCIsIGlkZW50aWZpZXIpO1xuICAgICAgICBjYW52YXMuc3R5bGUudmlzaWJpbGl0eSA9IFwiaGlkZGVuXCI7XG4gICAgICAgIGNhbnZhcy53aWR0aCA9IHRoaXMud2lkdGg7XG4gICAgICAgIGNhbnZhcy5oZWlnaHQgPSB0aGlzLmhlaWdodDtcbiAgICAgICAgY2FudmFzLnN0eWxlW1wiLXdlYmtpdC1mb250LXNtb290aGluZ1wiXSA9IFwibm9uZVwiO1xuICAgICAgICBjb25zdCBib2R5OiBhbnkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImJvZHlcIilbMF07XG4gICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQoY2FudmFzKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2NhbnZhcyA9IGNhbnZhcztcbiAgICB9XG4gICAgY29uc3QgY3R4OiBhbnkgPSB0aGlzLl9jYW52YXMuZ2V0Q29udGV4dChcIjJkXCIpO1xuICAgIGN0eC5maWxsU3R5bGUgPSBcIiNGRkZcIjtcbiAgICBjdHguZmlsbFJlY3QoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpO1xuICAgIGN0eC5maWxsU3R5bGUgPSBcIiMwMDBcIjtcbiAgICBjdHguc3Ryb2tlU3R5bGUgPSBcIiMwMDBcIjtcbiAgICB0aGlzLl9wb3MueCA9IDA7XG4gICAgdGhpcy5fcG9zLnkgPSAwO1xuICAgIHRoaXMuZm9udFNpemUgPSAxNjtcbiAgICBjdHguZm9udCA9IGAke3RoaXMuZm9udFNpemV9cHggQXJpYWxgO1xuICAgIHJldHVybiB0aGlzLl9jYW52YXM7XG4gIH1cblxuICBwdWJsaWMgX2N0eCgpIHtcbiAgICBjb25zdCBjYW52YXM6IGFueSA9IHRoaXMuX3ByZXBhcmVkQ2FudmFzKCk7XG4gICAgaWYgKGNhbnZhcykge1xuICAgICAgcmV0dXJuIGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGZvbnQoZm9udDogYW55LCBzaXplOiBhbnkpIHtcbiAgICBjb25zdCBjdHg6IGFueSA9IHRoaXMuX2N0eCgpO1xuICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gXCJudW1iZXJcIikge1xuICAgICAgc2l6ZSA9IDE2O1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGZvbnQgIT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGZvbnQgPSBcIkFyaWFsXCI7XG4gICAgfVxuICAgIHRoaXMuZm9udFNpemUgPSBzaXplO1xuICAgIGN0eC5mb250ID0gXCJcIiArIHNpemUgKyBcInB4IFwiICsgZm9udDtcbiAgfVxuXG4gIHB1YmxpYyBjbGVhcigpIHtcbiAgICBjb25zdCBjdHg6IGFueSA9IHRoaXMuX2N0eCgpO1xuICAgIHRoaXMuX3Bvcy54ID0gMDtcbiAgICB0aGlzLl9wb3MueSA9IDA7XG4gICAgaWYgKGN0eCkge1xuICAgICAgY3R4LmZpbGxTdHlsZSA9IFwiI2ZmZlwiO1xuICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTtcbiAgICAgIGN0eC5maWxsU3R5bGUgPSBcIiMwMDBcIjtcbiAgICAgIGN0eC5zdHJva2VTdHlsZSA9IFwiIzAwMFwiO1xuICAgICAgdGhpcy5kcmF3KGN0eCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2VuZENsZWFyKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHBvcyh4OiBhbnksIHk6IGFueSkge1xuICAgIHRoaXMuX2N0eCgpOyAvLyBjcmV0ZSBmaXJzdFxuICAgIGlmICh0eXBlb2YgeCA9PT0gXCJudW1iZXJcIikge1xuICAgICAgdGhpcy5fcG9zLnggPSB4O1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHkgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgIHRoaXMuX3Bvcy55ID0geTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3BvcztcbiAgfVxuXG4gIHB1YmxpYyBwcmludCh0ZXh0OiBhbnkpIHtcbiAgICBjb25zdCBjdHg6IGFueSA9IHRoaXMuX2N0eCgpO1xuICAgIGlmIChjdHgpIHtcbiAgICAgIGN0eC5maWxsVGV4dCh0ZXh0LCB0aGlzLl9wb3MueCwgdGhpcy5fcG9zLnkgKyB0aGlzLmZvbnRTaXplKTtcbiAgICAgIHRoaXMuZHJhdyhjdHgpO1xuICAgICAgdGhpcy5fcG9zLnkgKz0gdGhpcy5mb250U2l6ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgLypcbiAgICAgIGxldCBvYmogPSB7fTtcbiAgICAgIG9ialsnZGlzcGxheSddID0ge1xuICAgICAgICB0ZXh0OiAnJyArIHRleHQsXG4gICAgICB9O1xuICAgICAgdGhpcy5vYm5pei5zZW5kKG9iaik7XG4gICAgICAqL1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBsaW5lKHhfMDogYW55LCB5XzA6IGFueSwgeF8xOiBhbnksIHlfMTogYW55KSB7XG4gICAgY29uc3QgY3R4OiBhbnkgPSB0aGlzLl9jdHgoKTtcbiAgICBpZiAoY3R4KSB7XG4gICAgICBjdHguYmVnaW5QYXRoKCk7XG4gICAgICBjdHgubW92ZVRvKHhfMCwgeV8wKTtcbiAgICAgIGN0eC5saW5lVG8oeF8xLCB5XzEpO1xuICAgICAgY3R4LnN0cm9rZSgpO1xuICAgICAgdGhpcy5kcmF3KGN0eCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMud2FybkNhbnZhc0F2YWlsYWJpbGl0eSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyByZWN0KHg6IGFueSwgeTogYW55LCB3aWR0aDogYW55LCBoZWlnaHQ6IGFueSwgbXVzdEZpbGw6IGFueSkge1xuICAgIGNvbnN0IGN0eDogYW55ID0gdGhpcy5fY3R4KCk7XG4gICAgaWYgKGN0eCkge1xuICAgICAgaWYgKG11c3RGaWxsKSB7XG4gICAgICAgIGN0eC5maWxsUmVjdCh4LCB5LCB3aWR0aCwgaGVpZ2h0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGN0eC5zdHJva2VSZWN0KHgsIHksIHdpZHRoLCBoZWlnaHQpO1xuICAgICAgfVxuICAgICAgdGhpcy5kcmF3KGN0eCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMud2FybkNhbnZhc0F2YWlsYWJpbGl0eSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjaXJjbGUoeDogYW55LCB5OiBhbnksIHI6IGFueSwgbXVzdEZpbGw6IGFueSkge1xuICAgIGNvbnN0IGN0eDogYW55ID0gdGhpcy5fY3R4KCk7XG4gICAgaWYgKGN0eCkge1xuICAgICAgY3R4LmJlZ2luUGF0aCgpO1xuICAgICAgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJICogMik7XG4gICAgICBpZiAobXVzdEZpbGwpIHtcbiAgICAgICAgY3R4LmZpbGwoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGN0eC5zdHJva2UoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZHJhdyhjdHgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndhcm5DYW52YXNBdmFpbGFiaWxpdHkoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgX2RyYXcoY3R4OiBhbnkpIHtcbiAgICBjb25zdCBzdHJpZGU6IGFueSA9IHRoaXMud2lkdGggLyA4O1xuICAgIGNvbnN0IHZyYW06IGFueSA9IG5ldyBBcnJheShzdHJpZGUgKiA2NCk7XG4gICAgY29uc3QgaW1hZ2VEYXRhOiBhbnkgPSBjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTtcbiAgICBjb25zdCBkYXRhOiBhbnkgPSBpbWFnZURhdGEuZGF0YTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgKz0gNCkge1xuICAgICAgY29uc3QgYnJpZ2h0bmVzczogYW55ID0gMC4zNCAqIGRhdGFbaV0gKyAwLjUgKiBkYXRhW2kgKyAxXSArIDAuMTYgKiBkYXRhW2kgKyAyXTtcbiAgICAgIGNvbnN0IGluZGV4OiBhbnkgPSBNYXRoLmZsb29yKGkgLyA0KTtcbiAgICAgIGNvbnN0IGxpbmU6IGFueSA9IE1hdGguZmxvb3IoaW5kZXggLyB0aGlzLndpZHRoKTtcbiAgICAgIGNvbnN0IGNvbDogYW55ID0gTWF0aC5mbG9vcigoaW5kZXggLSBsaW5lICogdGhpcy53aWR0aCkgLyA4KTtcbiAgICAgIGNvbnN0IGJpdHM6IGFueSA9IE1hdGguZmxvb3IoaW5kZXggLSBsaW5lICogdGhpcy53aWR0aCkgJSA4O1xuICAgICAgaWYgKGJpdHMgPT09IDApIHtcbiAgICAgICAgdnJhbVtsaW5lICogc3RyaWRlICsgY29sXSA9IDB4MDA7XG4gICAgICB9XG4gICAgICBpZiAoYnJpZ2h0bmVzcyA+IDB4NzMpIHtcbiAgICAgICAgdnJhbVtsaW5lICogc3RyaWRlICsgY29sXSB8PSAweDgwID4+IGJpdHM7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMucmF3KHZyYW0pO1xuICB9XG5cbiAgcHVibGljIGRyYXcoY3R4OiBhbnkpIHtcbiAgICBpZiAodGhpcy5hdXRvRmx1c2gpIHtcbiAgICAgIHRoaXMuX2RyYXcoY3R4KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZHJhd2luZyhhdXRvRmx1c2g6IGFueSkge1xuICAgIHRoaXMuYXV0b0ZsdXNoID0gYXV0b0ZsdXNoID09PSB0cnVlO1xuICAgIGNvbnN0IGN0eDogYW55ID0gdGhpcy5fY3R4KCk7XG4gICAgaWYgKGN0eCkge1xuICAgICAgdGhpcy5kcmF3KGN0eCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFNoYXJwTWVtb3J5VEZUO1xuIl19

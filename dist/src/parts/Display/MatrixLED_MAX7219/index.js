"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class MatrixLED_MAX7219 {
    constructor() {
        this.keys = ["vcc", "gnd", "din", "cs", "clk"];
        this.requiredKeys = ["din", "cs", "clk"];
    }
    static info() {
        return {
            name: "MatrixLED_MAX7219",
        };
    }
    wired(obniz) {
        this.cs = obniz.getIO(this.params.cs);
        // logich high must 3.5v <=
        if (obniz.isValidIO(this.params.vcc)) {
            obniz.getIO(this.params.vcc).output(true);
        }
        if (obniz.isValidIO(this.params.gnd)) {
            obniz.getIO(this.params.gnd).output(false);
        }
        // max 10Mhz but motor driver can't
        this.params.frequency = this.params.frequency || 10 * 1000 * 1000;
        this.params.mode = "master";
        this.params.mosi = this.params.din;
        this.params.drive = "3v";
        this.spi = this.obniz.getSpiWithConfig(this.params);
        // reset a onece
        this.cs.output(true);
        this.cs.output(false);
        this.cs.output(true);
    }
    init(width, height) {
        this.width = width;
        this.height = height;
        this.preparevram(width, height);
        this.initModule();
    }
    initModule() {
        this.write([0x09, 0x00]); // Code B decode for digits 3-0 No decode for digits 7-4
        this.write([0x0a, 0x05]); // brightness 9/32 0 to f
        this.write([0x0b, 0x07]); // Display digits 0 1 2 3 4 567
        this.write([0x0c, 0x01]); // Shutdown to normal operation
        this.write([0x0f, 0x00]);
        this.passingCommands();
        this.obniz.wait(10);
    }
    test() {
        this.write([0x0f, 0x00]); // test command
        this.passingCommands();
    }
    passingCommands() {
        for (let i = 8; i < this.width; i += 8) {
            // this needed for number of unit
            this.write([0x00, 0x00]);
        }
    }
    brightness(val) {
        this.write([0x0a, val]); // 0 to 15;
        this.passingCommands();
    }
    preparevram(width, height) {
        this.vram = [];
        for (let i = 0; i < height; i++) {
            const dots = new Array(width / 8);
            for (let ii = 0; ii < dots.length; ii++) {
                dots[ii] = 0x00;
            }
            this.vram.push(dots);
        }
    }
    write(data) {
        this.cs.output(false);
        this.spi.write(data);
        this.cs.output(true);
    }
    writeVram() {
        for (let line_num = 0; line_num < this.height; line_num++) {
            const addr = line_num + 1;
            const line = this.vram[line_num];
            const data = [];
            for (let col = 0; col < line.length; col++) {
                data.push(addr);
                data.push(line[col]);
            }
            this.write(data);
        }
    }
    clear() {
        for (let line_num = 0; line_num < this.height; line_num++) {
            const line = this.vram[line_num];
            for (let col = 0; col < line.length; col++) {
                this.vram[line_num][col] = 0x00;
            }
            this.writeVram();
        }
    }
    draw(ctx) {
        const imageData = ctx.getImageData(0, 0, this.width, this.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];
            const index = Math.floor(i / 4);
            const line = Math.floor(index / this.width);
            const col = Math.floor((index - line * this.width) / 8);
            const bits = Math.floor(index - line * this.width) % 8;
            if (bits === 0) {
                this.vram[line][col] = 0x00;
            }
            if (brightness > 0x7f) {
                this.vram[line][col] |= 0x80 >> bits;
            }
        }
        this.writeVram();
    }
}
exports.default = MatrixLED_MAX7219;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXJ0cy9EaXNwbGF5L01hdHJpeExFRF9NQVg3MjE5L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTSxpQkFBaUI7SUFrQnJCO1FBQ0UsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMvQyxJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBbkJNLE1BQU0sQ0FBQyxJQUFJO1FBQ2hCLE9BQU87WUFDTCxJQUFJLEVBQUUsbUJBQW1CO1NBQzFCLENBQUM7SUFDSixDQUFDO0lBaUJNLEtBQUssQ0FBQyxLQUFVO1FBQ3JCLElBQUksQ0FBQyxFQUFFLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3RDLDJCQUEyQjtRQUMzQixJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNwQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzNDO1FBQ0QsSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDcEMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM1QztRQUVELG1DQUFtQztRQUNuQyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsSUFBSSxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztR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QUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDNUQsSUFBSSxJQUFJLEtBQUssQ0FBQyxFQUFFO2dCQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDO2FBQzdCO1lBQ0QsSUFBSSxVQUFVLEdBQUcsSUFBSSxFQUFFO2dCQUNyQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksSUFBSSxJQUFJLENBQUM7YUFDdEM7U0FDRjtRQUVELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNuQixDQUFDO0NBQ0Y7QUFFRCxrQkFBZSxpQkFBaUIsQ0FBQyIsImZpbGUiOiJzcmMvcGFydHMvRGlzcGxheS9NYXRyaXhMRURfTUFYNzIxOS9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIE1hdHJpeExFRF9NQVg3MjE5IHtcblxuICBwdWJsaWMgc3RhdGljIGluZm8oKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IFwiTWF0cml4TEVEX01BWDcyMTlcIixcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIGtleXM6IGFueTtcbiAgcHVibGljIHJlcXVpcmVkS2V5czogYW55O1xuICBwdWJsaWMgY3M6IGFueTtcbiAgcHVibGljIHBhcmFtczogYW55O1xuICBwdWJsaWMgc3BpOiBhbnk7XG4gIHB1YmxpYyBvYm5pejogYW55O1xuICBwdWJsaWMgd2lkdGg6IGFueTtcbiAgcHVibGljIGhlaWdodDogYW55O1xuICBwdWJsaWMgdnJhbTogYW55O1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMua2V5cyA9IFtcInZjY1wiLCBcImduZFwiLCBcImRpblwiLCBcImNzXCIsIFwiY2xrXCJdO1xuICAgIHRoaXMucmVxdWlyZWRLZXlzID0gW1wiZGluXCIsIFwiY3NcIiwgXCJjbGtcIl07XG4gIH1cblxuICBwdWJsaWMgd2lyZWQob2JuaXo6IGFueSkge1xuICAgIHRoaXMuY3MgPSBvYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5jcyk7XG4gICAgLy8gbG9naWNoIGhpZ2ggbXVzdCAzLjV2IDw9XG4gICAgaWYgKG9ibml6LmlzVmFsaWRJTyh0aGlzLnBhcmFtcy52Y2MpKSB7XG4gICAgICBvYm5pei5nZXRJTyh0aGlzLnBhcmFtcy52Y2MpLm91dHB1dCh0cnVlKTtcbiAgICB9XG4gICAgaWYgKG9ibml6LmlzVmFsaWRJTyh0aGlzLnBhcmFtcy5nbmQpKSB7XG4gICAgICBvYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5nbmQpLm91dHB1dChmYWxzZSk7XG4gICAgfVxuXG4gICAgLy8gbWF4IDEwTWh6IGJ1dCBtb3RvciBkcml2ZXIgY2FuJ3RcbiAgICB0aGlzLnBhcmFtcy5mcmVxdWVuY3kgPSB0aGlzLnBhcmFtcy5mcmVxdWVuY3kgfHwgMTAgKiAxMDAwICogMTAwMDtcbiAgICB0aGlzLnBhcmFtcy5tb2RlID0gXCJtYXN0ZXJcIjtcbiAgICB0aGlzLnBhcmFtcy5tb3NpID0gdGhpcy5wYXJhbXMuZGluO1xuICAgIHRoaXMucGFyYW1zLmRyaXZlID0gXCIzdlwiO1xuICAgIHRoaXMuc3BpID0gdGhpcy5vYm5pei5nZXRTcGlXaXRoQ29uZmlnKHRoaXMucGFyYW1zKTtcblxuICAgIC8vIHJlc2V0IGEgb25lY2VcbiAgICB0aGlzLmNzLm91dHB1dCh0cnVlKTtcbiAgICB0aGlzLmNzLm91dHB1dChmYWxzZSk7XG4gICAgdGhpcy5jcy5vdXRwdXQodHJ1ZSk7XG4gIH1cblxuICBwdWJsaWMgaW5pdCh3aWR0aDogYW55LCBoZWlnaHQ6IGFueSkge1xuICAgIHRoaXMud2lkdGggPSB3aWR0aDtcbiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDtcbiAgICB0aGlzLnByZXBhcmV2cmFtKHdpZHRoLCBoZWlnaHQpO1xuICAgIHRoaXMuaW5pdE1vZHVsZSgpO1xuICB9XG5cbiAgcHVibGljIGluaXRNb2R1bGUoKSB7XG4gICAgdGhpcy53cml0ZShbMHgwOSwgMHgwMF0pOyAvLyBDb2RlIEIgZGVjb2RlIGZvciBkaWdpdHMgMy0wIE5vIGRlY29kZSBmb3IgZGlnaXRzIDctNFxuICAgIHRoaXMud3JpdGUoWzB4MGEsIDB4MDVdKTsgLy8gYnJpZ2h0bmVzcyA5LzMyIDAgdG8gZlxuICAgIHRoaXMud3JpdGUoWzB4MGIsIDB4MDddKTsgLy8gRGlzcGxheSBkaWdpdHMgMCAxIDIgMyA0IDU2N1xuICAgIHRoaXMud3JpdGUoWzB4MGMsIDB4MDFdKTsgLy8gU2h1dGRvd24gdG8gbm9ybWFsIG9wZXJhdGlvblxuICAgIHRoaXMud3JpdGUoWzB4MGYsIDB4MDBdKTtcbiAgICB0aGlzLnBhc3NpbmdDb21tYW5kcygpO1xuICAgIHRoaXMub2JuaXoud2FpdCgxMCk7XG4gIH1cblxuICBwdWJsaWMgdGVzdCgpIHtcbiAgICB0aGlzLndyaXRlKFsweDBmLCAweDAwXSk7IC8vIHRlc3QgY29tbWFuZFxuICAgIHRoaXMucGFzc2luZ0NvbW1hbmRzKCk7XG4gIH1cblxuICBwdWJsaWMgcGFzc2luZ0NvbW1hbmRzKCkge1xuICAgIGZvciAobGV0IGkgPSA4OyBpIDwgdGhpcy53aWR0aDsgaSArPSA4KSB7XG4gICAgICAvLyB0aGlzIG5lZWRlZCBmb3IgbnVtYmVyIG9mIHVuaXRcbiAgICAgIHRoaXMud3JpdGUoWzB4MDAsIDB4MDBdKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYnJpZ2h0bmVzcyh2YWw6IGFueSkge1xuICAgIHRoaXMud3JpdGUoWzB4MGEsIHZhbF0pOyAvLyAwIHRvIDE1O1xuICAgIHRoaXMucGFzc2luZ0NvbW1hbmRzKCk7XG4gIH1cblxuICBwdWJsaWMgcHJlcGFyZXZyYW0od2lkdGg6IGFueSwgaGVpZ2h0OiBhbnkpIHtcbiAgICB0aGlzLnZyYW0gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhlaWdodDsgaSsrKSB7XG4gICAgICBjb25zdCBkb3RzOiBhbnkgPSBuZXcgQXJyYXkod2lkdGggLyA4KTtcbiAgICAgIGZvciAobGV0IGlpID0gMDsgaWkgPCBkb3RzLmxlbmd0aDsgaWkrKykge1xuICAgICAgICBkb3RzW2lpXSA9IDB4MDA7XG4gICAgICB9XG4gICAgICB0aGlzLnZyYW0ucHVzaChkb3RzKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgd3JpdGUoZGF0YTogYW55KSB7XG4gICAgdGhpcy5jcy5vdXRwdXQoZmFsc2UpO1xuICAgIHRoaXMuc3BpLndyaXRlKGRhdGEpO1xuICAgIHRoaXMuY3Mub3V0cHV0KHRydWUpO1xuICB9XG5cbiAgcHVibGljIHdyaXRlVnJhbSgpIHtcbiAgICBmb3IgKGxldCBsaW5lX251bSA9IDA7IGxpbmVfbnVtIDwgdGhpcy5oZWlnaHQ7IGxpbmVfbnVtKyspIHtcbiAgICAgIGNvbnN0IGFkZHI6IGFueSA9IGxpbmVfbnVtICsgMTtcbiAgICAgIGNvbnN0IGxpbmU6IGFueSA9IHRoaXMudnJhbVtsaW5lX251bV07XG4gICAgICBjb25zdCBkYXRhOiBhbnkgPSBbXTtcbiAgICAgIGZvciAobGV0IGNvbCA9IDA7IGNvbCA8IGxpbmUubGVuZ3RoOyBjb2wrKykge1xuICAgICAgICBkYXRhLnB1c2goYWRkcik7XG4gICAgICAgIGRhdGEucHVzaChsaW5lW2NvbF0pO1xuICAgICAgfVxuICAgICAgdGhpcy53cml0ZShkYXRhKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2xlYXIoKSB7XG4gICAgZm9yIChsZXQgbGluZV9udW0gPSAwOyBsaW5lX251bSA8IHRoaXMuaGVpZ2h0OyBsaW5lX251bSsrKSB7XG4gICAgICBjb25zdCBsaW5lOiBhbnkgPSB0aGlzLnZyYW1bbGluZV9udW1dO1xuICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgbGluZS5sZW5ndGg7IGNvbCsrKSB7XG4gICAgICAgIHRoaXMudnJhbVtsaW5lX251bV1bY29sXSA9IDB4MDA7XG4gICAgICB9XG4gICAgICB0aGlzLndyaXRlVnJhbSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBkcmF3KGN0eDogYW55KSB7XG4gICAgY29uc3QgaW1hZ2VEYXRhOiBhbnkgPSBjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTtcbiAgICBjb25zdCBkYXRhOiBhbnkgPSBpbWFnZURhdGEuZGF0YTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgKz0gNCkge1xuICAgICAgY29uc3QgYnJpZ2h0bmVzczogYW55ID0gMC4zNCAqIGRhdGFbaV0gKyAwLjUgKiBkYXRhW2kgKyAxXSArIDAuMTYgKiBkYXRhW2kgKyAyXTtcbiAgICAgIGNvbnN0IGluZGV4OiBhbnkgPSBNYXRoLmZsb29yKGkgLyA0KTtcbiAgICAgIGNvbnN0IGxpbmU6IGFueSA9IE1hdGguZmxvb3IoaW5kZXggLyB0aGlzLndpZHRoKTtcbiAgICAgIGNvbnN0IGNvbDogYW55ID0gTWF0aC5mbG9vcigoaW5kZXggLSBsaW5lICogdGhpcy53aWR0aCkgLyA4KTtcbiAgICAgIGNvbnN0IGJpdHM6IGFueSA9IE1hdGguZmxvb3IoaW5kZXggLSBsaW5lICogdGhpcy53aWR0aCkgJSA4O1xuICAgICAgaWYgKGJpdHMgPT09IDApIHtcbiAgICAgICAgdGhpcy52cmFtW2xpbmVdW2NvbF0gPSAweDAwO1xuICAgICAgfVxuICAgICAgaWYgKGJyaWdodG5lc3MgPiAweDdmKSB7XG4gICAgICAgIHRoaXMudnJhbVtsaW5lXVtjb2xdIHw9IDB4ODAgPj4gYml0cztcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLndyaXRlVnJhbSgpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IE1hdHJpeExFRF9NQVg3MjE5O1xuIl19

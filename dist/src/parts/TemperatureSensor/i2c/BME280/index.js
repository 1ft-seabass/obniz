"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
class BME280 {
    constructor() {
        this.requiredKeys = [];
        this.keys = [
            "vcore",
            "vio",
            "gnd",
            "csb",
            "sdi",
            "sck",
            "sdo",
            "i2c",
            "address",
        ];
        this.ioKeys = ["vcore", "vio", "gnd", "csb", "sdi", "sdo", "sck"];
        this.configration = {
            sampling: {
                temp: 1,
                hum: 1,
                pres: 1,
            },
            interval: 5,
            iir_strength: 0,
            mode: 3,
            Modes: {
                sleep: 0,
                forced: 1,
                normal: 3,
            },
        };
        this.commands = {};
        this.commands.addresses = {
            config: 0xf5,
            ctrl_meas: 0xf4,
            ctrl_hum: 0xf2,
        };
    }
    static info() {
        return {
            name: "BME280",
            datasheet: "https://ae-bst.resource.bosch.com/media/_tech/media/datasheets/BST-BME280_DS001-12.pdf",
        };
    }
    wired(obniz) {
        this.obniz = obniz;
        if (obniz.isValidIO(this.params.csb)) {
            // selecting I2C mode before powerup
            this.io_csb = obniz.getIO(this.params.csb);
            this.io_csb.drive("3v");
            this.io_csb.output(true);
        }
        this.obniz.setVccGnd(this.params.vio, null, "3v");
        this.obniz.setVccGnd(this.params.vcore, null, "3v");
        this.obniz.setVccGnd(null, this.params.gnd, "5v");
        this.obniz.wait(10);
        this.address = 0x76;
        if (this.params.address === 0x76) {
            this.address = 0x76;
        }
        else if (this.params.address === 0x77) {
            this.address = 0x77;
        }
        else if (this.params.address !== undefined) {
            throw new Error("address must be 0x76 or 0x77");
        }
        if (obniz.isValidIO(this.params.sdo)) {
            this.io_sdo = obniz.getIO(this.params.sdo);
            this.io_sdo.drive("3v");
            this.io_sdo.output(this.address === 0x76 ? false : true);
        }
        this.params.sda = this.params.sda || this.params.sdi;
        this.params.scl = this.params.scl || this.params.sck;
        this.params.clock = this.params.clock || 100 * 1000;
        this.params.mode = "master";
        this.params.pull = "3v";
        this.i2c = obniz.getI2CWithConfig(this.params);
        this.obniz.wait(10);
        this.config();
        this.obniz.wait(10);
    }
    config() {
        return __awaiter(this, void 0, void 0, function* () {
            this.write([
                this.commands.addresses.config,
                (this.configration.interval << 5) |
                    (this.configration.iir_strength << 2) |
                    0,
            ]);
            this.write([
                this.commands.addresses.ctrl_hum,
                this.configration.sampling.hum,
            ]);
            this.write([
                this.commands.addresses.ctrl_meas,
                (this.configration.sampling.temp << 5) |
                    (this.configration.sampling.pres << 2) |
                    this.configration.mode,
            ]);
        });
    }
    setIIRStrength(strengh) {
        return __awaiter(this, void 0, void 0, function* () {
            this.configration.iir_strength = strengh;
            this.config();
        });
    }
    applyCalibration() {
        return __awaiter(this, void 0, void 0, function* () {
            this.i2c.write(this.address, [0x88]);
            const data = yield this.i2c.readWait(this.address, 24);
            this.i2c.write(this.address, [0xa1]);
            let data_next = yield this.i2c.readWait(this.address, 1);
            data.push(...data_next);
            this.i2c.write(this.address, [0xe1]);
            data_next = yield this.i2c.readWait(this.address, 7);
            data.push(...data_next);
            this._calibrated = {
                dig_T1: (data[1] << 8) | data[0],
                dig_T2: this._readSigned16((data[3] << 8) | data[2]),
                dig_T3: this._readSigned16((data[5] << 8) | data[4]),
                dig_P1: (data[7] << 8) | data[6],
                dig_P2: this._readSigned16((data[9] << 8) | data[8]),
                dig_P3: this._readSigned16((data[11] << 8) | data[10]),
                dig_P4: this._readSigned16((data[13] << 8) | data[12]),
                dig_P5: this._readSigned16((data[15] << 8) | data[14]),
                dig_P6: this._readSigned16((data[17] << 8) | data[16]),
                dig_P7: this._readSigned16((data[19] << 8) | data[18]),
                dig_P8: this._readSigned16((data[21] << 8) | data[20]),
                dig_P9: this._readSigned16((data[23] << 8) | data[22]),
                dig_H1: this._readSigned8(data[24]),
                dig_H2: this._readSigned16((data[26] << 8) | data[25]),
                dig_H3: this._readSigned8(data[27]),
                dig_H4: this._readSigned16((data[28] << 4) | (0x0f & data[29])),
                dig_H5: this._readSigned16((data[30] << 4) | ((data[29] >> 4) & 0x0f)),
                dig_H6: this._readSigned8(data[31]),
            };
            this._t_fine = 0;
        });
    }
    _readSigned16(value) {
        if (value >= 0x8000) {
            value = value - 0x10000;
        }
        return value;
    }
    _readSigned8(value) {
        if (value >= 0x80) {
            value = value - 0x100;
        }
        return value;
    }
    write(data) {
        this.obniz.i2c0.write(this.address, data);
    }
    getData() {
        return __awaiter(this, void 0, void 0, function* () {
            this.i2c.write(this.address, [0xf7]);
            return yield this.i2c.readWait(this.address, 8);
        });
    }
    getAllWait() {
        return __awaiter(this, void 0, void 0, function* () {
            const data = yield this.getData();
            const press_raw = (data[0] << 12) | (data[1] << 4) | (data[2] >> 4);
            const temp_raw = (data[3] << 12) | (data[4] << 4) | (data[5] >> 4);
            const hum_raw = (data[6] << 8) | data[7];
            const temperature = this.calibration_T(temp_raw) / 100.0;
            const pressure = this.calibration_P(press_raw) / 100.0;
            const humidity = this.calibration_H(hum_raw);
            return { temperature, humidity, pressure };
        });
    }
    calibration_T(adc_T) {
        let var1;
        let var2;
        let T;
        var1 =
            (((adc_T >> 3) - (this._calibrated.dig_T1 << 1)) *
                this._calibrated.dig_T2) >>
                11;
        var2 =
            (((((adc_T >> 4) - this._calibrated.dig_T1) *
                ((adc_T >> 4) - this._calibrated.dig_T1)) >>
                12) *
                this._calibrated.dig_T3) >>
                14;
        this._t_fine = var1 + var2;
        T = (this._t_fine * 5 + 128) >> 8;
        return T;
    }
    calibration_P(adc_P) {
        let pvar1 = this._t_fine / 2 - 64000;
        let pvar2 = (pvar1 * pvar1 * this._calibrated.dig_P6) / 32768;
        pvar2 = pvar2 + pvar1 * this._calibrated.dig_P5 * 2;
        pvar2 = pvar2 / 4 + this._calibrated.dig_P4 * 65536;
        pvar1 =
            ((this._calibrated.dig_P3 * pvar1 * pvar1) / 524288 +
                this._calibrated.dig_P2 * pvar1) /
                524288;
        pvar1 = (1 + pvar1 / 32768) * this._calibrated.dig_P1;
        if (pvar1 !== 0) {
            let p = 1048576 - adc_P;
            p = ((p - pvar2 / 4096) * 6250) / pvar1;
            pvar1 = (this._calibrated.dig_P9 * p * p) / 2147483648;
            pvar2 = (p * this._calibrated.dig_P8) / 32768;
            p = p + (pvar1 + pvar2 + this._calibrated.dig_P7) / 16;
            return p;
        }
        return 0;
    }
    calibration_H(adc_H) {
        let h = this._t_fine - 76800;
        h =
            (adc_H -
                (this._calibrated.dig_H4 * 64 +
                    (this._calibrated.dig_H5 / 16384) * h)) *
                ((this._calibrated.dig_H2 / 65536) *
                    (1 +
                        (this._calibrated.dig_H6 / 67108864) *
                            h *
                            (1 + (this._calibrated.dig_H3 / 67108864) * h)));
        h = h * (1 - (this._calibrated.dig_H1 * h) / 524288);
        return h;
    }
    getTempWait() {
        return __awaiter(this, void 0, void 0, function* () {
            return (yield this.getAllWait()).temperature;
        });
    }
    getHumdWait() {
        return __awaiter(this, void 0, void 0, function* () {
            return (yield this.getAllWait()).humidity;
        });
    }
    getPressureWait() {
        return __awaiter(this, void 0, void 0, function* () {
            return (yield this.getAllWait()).pressure;
        });
    }
    getAltitudeWait() {
        return __awaiter(this, void 0, void 0, function* () {
            const pressure = yield this.getPressureWait();
            return this.calcAltitude(pressure);
        });
    }
    calcAltitude(pressure, seaLevel = 1013.25) {
        return ((1.0 - Math.pow(pressure / seaLevel, 1 / 5.2553)) * 145366.45 * 0.3048);
    }
}
exports.default = BME280;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXJ0cy9UZW1wZXJhdHVyZVNlbnNvci9pMmMvQk1FMjgwL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUEsTUFBTSxNQUFNO0lBd0JWO1FBQ0UsSUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLElBQUksR0FBRztZQUNWLE9BQU87WUFDUCxLQUFLO1lBQ0wsS0FBSztZQUNMLEtBQUs7WUFDTCxLQUFLO1lBQ0wsS0FBSztZQUNMLEtBQUs7WUFDTCxLQUFLO1lBQ0wsU0FBUztTQUNWLENBQUM7UUFFRixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFbEUsSUFBSSxDQUFDLFlBQVksR0FBRztZQUNsQixRQUFRLEVBQUU7Z0JBQ1IsSUFBSSxFQUFFLENBQUM7Z0JBQ1AsR0FBRyxFQUFFLENBQUM7Z0JBQ04sSUFBSSxFQUFFLENBQUM7YUFDUjtZQUNELFFBQVEsRUFBRSxDQUFDO1lBQ1gsWUFBWSxFQUFFLENBQUM7WUFDZixJQUFJLEVBQUUsQ0FBQztZQUVQLEtBQUssRUFBRTtnQkFDTCxLQUFLLEVBQUUsQ0FBQztnQkFDUixNQUFNLEVBQUUsQ0FBQztnQkFDVCxNQUFNLEVBQUUsQ0FBQzthQUNWO1NBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBRW5CLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxHQUFHO1lBQ3hCLE1BQU0sRUFBRSxJQUFJO1lBQ1osU0FBUyxFQUFFLElBQUk7WUFDZixRQUFRLEVBQUUsSUFBSTtTQUNmLENBQUM7SUFDSixDQUFDO0lBOURNLE1BQU0sQ0FBQyxJQUFJO1FBQ2hCLE9BQU87WUFDTCxJQUFJLEVBQUUsUUFBUTtZQUNkLFNBQVMsRUFDUCx3RkFBd0Y7U0FDM0YsQ0FBQztJQUNKLENBQUM7SUEwRE0sS0FBSyxDQUFDLEtBQVU7UUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFFbkIsSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDcEMsb0NBQW9DO1lBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzFCO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFcEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sS0FBSyxJQUFJLEVBQUU7WUFDaEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7U0FDckI7YUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxLQUFLLElBQUksRUFBRTtZQUN2QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztTQUNyQjthQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEtBQUssU0FBUyxFQUFFO1lBQzVDLE1BQU0sSUFBSSxLQUFLLENBQUMsOEJBQThCLENBQUMsQ0FBQztTQUNqRDtRQUVELElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzFEO1FBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFDckQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFDckQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQztRQUNwRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUvQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVwQixJQUFJLENBQUMs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aEMsTUFBTSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNwRCxNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3RELE1BQU0sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN0RCxNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3RELE1BQU0sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN0RCxNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3RELE1BQU0sRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDbkMsTUFBTSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN0RCxNQUFNLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ25DLE1BQU0sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUMvRCxNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO2dCQUN0RSxNQUFNLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDcEMsQ0FBQztZQUNGLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLENBQUM7S0FBQTtJQUVNLGFBQWEsQ0FBQyxLQUFVO1FBQzdCLElBQUksS0FBSyxJQUFJLE1BQU0sRUFBRTtZQUNuQixLQUFLLEdBQUcsS0FBSyxHQUFHLE9BQU8sQ0FBQztTQUN6QjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVNLFlBQVksQ0FBQyxLQUFVO1FBQzVCLElBQUksS0FBSyxJQUFJLElBQUksRUFBRTtZQUNqQixLQUFLLEdBQUcsS0FBSyxHQUFHLEtBQUssQ0FBQztTQUN2QjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFTO1FBQ3BCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFWSxPQUFPOztZQUNsQixJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNyQyxPQUFPLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNsRCxDQUFDO0tBQUE7SUFFWSxVQUFVOztZQUNyQixNQUFNLElBQUksR0FBUSxNQUFNLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUV2QyxNQUFNLFNBQVMsR0FBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUN6RSxNQUFNLFFBQVEsR0FBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUN4RSxNQUFNLE9BQU8sR0FBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFOUMsTUFBTSxXQUFXLEdBQVEsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDOUQsTUFBTSxRQUFRLEdBQVEsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDNUQsTUFBTSxRQUFRLEdBQVEsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUVsRCxPQUFPLEVBQUMsV0FB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LFFBQWEsRUFBRSxXQUFnQixPQUFPO1FBQ3hELE9BQU8sQ0FDTCxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxRQUFRLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLEdBQUcsU0FBUyxHQUFHLE1BQU0sQ0FDdkUsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQUVELGtCQUFlLE1BQU0sQ0FBQyIsImZpbGUiOiJzcmMvcGFydHMvVGVtcGVyYXR1cmVTZW5zb3IvaTJjL0JNRTI4MC9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIEJNRTI4MCB7XG5cbiAgcHVibGljIHN0YXRpYyBpbmZvKCkge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiBcIkJNRTI4MFwiLFxuICAgICAgZGF0YXNoZWV0OlxuICAgICAgICBcImh0dHBzOi8vYWUtYnN0LnJlc291cmNlLmJvc2NoLmNvbS9tZWRpYS9fdGVjaC9tZWRpYS9kYXRhc2hlZXRzL0JTVC1CTUUyODBfRFMwMDEtMTIucGRmXCIsXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyByZXF1aXJlZEtleXM6IGFueTtcbiAgcHVibGljIGtleXM6IGFueTtcbiAgcHVibGljIGlvS2V5czogYW55O1xuICBwdWJsaWMgY29uZmlncmF0aW9uOiBhbnk7XG4gIHB1YmxpYyBjb21tYW5kczogYW55O1xuICBwdWJsaWMgb2JuaXo6IGFueTtcbiAgcHVibGljIHBhcmFtczogYW55O1xuICBwdWJsaWMgaW9fY3NiOiBhbnk7XG4gIHB1YmxpYyBhZGRyZXNzOiBhbnk7XG4gIHB1YmxpYyBpb19zZG86IGFueTtcbiAgcHVibGljIGkyYzogYW55O1xuICBwdWJsaWMgX2NhbGlicmF0ZWQ6IGFueTtcbiAgcHVibGljIF90X2ZpbmU6IGFueTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnJlcXVpcmVkS2V5cyA9IFtdO1xuICAgIHRoaXMua2V5cyA9IFtcbiAgICAgIFwidmNvcmVcIixcbiAgICAgIFwidmlvXCIsXG4gICAgICBcImduZFwiLFxuICAgICAgXCJjc2JcIixcbiAgICAgIFwic2RpXCIsXG4gICAgICBcInNja1wiLFxuICAgICAgXCJzZG9cIixcbiAgICAgIFwiaTJjXCIsXG4gICAgICBcImFkZHJlc3NcIixcbiAgICBdO1xuXG4gICAgdGhpcy5pb0tleXMgPSBbXCJ2Y29yZVwiLCBcInZpb1wiLCBcImduZFwiLCBcImNzYlwiLCBcInNkaVwiLCBcInNkb1wiLCBcInNja1wiXTtcblxuICAgIHRoaXMuY29uZmlncmF0aW9uID0ge1xuICAgICAgc2FtcGxpbmc6IHtcbiAgICAgICAgdGVtcDogMSwgLy8gMCBuZXZlci4gMGIwMDEgdG8gMGIxMDFcbiAgICAgICAgaHVtOiAxLFxuICAgICAgICBwcmVzOiAxLFxuICAgICAgfSxcbiAgICAgIGludGVydmFsOiA1LCAvLyAwYjAwMCB0byAwYjExMVxuICAgICAgaWlyX3N0cmVuZ3RoOiAwLCAvLyAwMDAgdG8gMTAwICgwPWRpc2FibGUpXG4gICAgICBtb2RlOiAzLFxuXG4gICAgICBNb2Rlczoge1xuICAgICAgICBzbGVlcDogMCxcbiAgICAgICAgZm9yY2VkOiAxLCAvLyBvciAyXG4gICAgICAgIG5vcm1hbDogMyxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHRoaXMuY29tbWFuZHMgPSB7fTtcblxuICAgIHRoaXMuY29tbWFuZHMuYWRkcmVzc2VzID0ge1xuICAgICAgY29uZmlnOiAweGY1LFxuICAgICAgY3RybF9tZWFzOiAweGY0LFxuICAgICAgY3RybF9odW06IDB4ZjIsXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyB3aXJlZChvYm5pejogYW55KSB7XG4gICAgdGhpcy5vYm5peiA9IG9ibml6O1xuXG4gICAgaWYgKG9ibml6LmlzVmFsaWRJTyh0aGlzLnBhcmFtcy5jc2IpKSB7XG4gICAgICAvLyBzZWxlY3RpbmcgSTJDIG1vZGUgYmVmb3JlIHBvd2VydXBcbiAgICAgIHRoaXMuaW9fY3NiID0gb2JuaXouZ2V0SU8odGhpcy5wYXJhbXMuY3NiKTtcbiAgICAgIHRoaXMuaW9fY3NiLmRyaXZlKFwiM3ZcIik7XG4gICAgICB0aGlzLmlvX2NzYi5vdXRwdXQodHJ1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy5vYm5pei5zZXRWY2NHbmQodGhpcy5wYXJhbXMudmlvLCBudWxsLCBcIjN2XCIpO1xuICAgIHRoaXMub2JuaXouc2V0VmNjR25kKHRoaXMucGFyYW1zLnZjb3JlLCBudWxsLCBcIjN2XCIpO1xuICAgIHRoaXMub2JuaXouc2V0VmNjR25kKG51bGwsIHRoaXMucGFyYW1zLmduZCwgXCI1dlwiKTtcbiAgICB0aGlzLm9ibml6LndhaXQoMTApO1xuXG4gICAgdGhpcy5hZGRyZXNzID0gMHg3NjtcbiAgICBpZiAodGhpcy5wYXJhbXMuYWRkcmVzcyA9PT0gMHg3Nikge1xuICAgICAgdGhpcy5hZGRyZXNzID0gMHg3NjtcbiAgICB9IGVsc2UgaWYgKHRoaXMucGFyYW1zLmFkZHJlc3MgPT09IDB4NzcpIHtcbiAgICAgIHRoaXMuYWRkcmVzcyA9IDB4Nzc7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBhcmFtcy5hZGRyZXNzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcImFkZHJlc3MgbXVzdCBiZSAweDc2IG9yIDB4NzdcIik7XG4gICAgfVxuXG4gICAgaWYgKG9ibml6LmlzVmFsaWRJTyh0aGlzLnBhcmFtcy5zZG8pKSB7XG4gICAgICB0aGlzLmlvX3NkbyA9IG9ibml6LmdldElPKHRoaXMucGFyYW1zLnNkbyk7XG4gICAgICB0aGlzLmlvX3Nkby5kcml2ZShcIjN2XCIpO1xuICAgICAgdGhpcy5pb19zZG8ub3V0cHV0KHRoaXMuYWRkcmVzcyA9PT0gMHg3NiA/IGZhbHNlIDogdHJ1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy5wYXJhbXMuc2RhID0gdGhpcy5wYXJhbXMuc2RhIHx8IHRoaXMucGFyYW1zLnNkaTtcbiAgICB0aGlzLnBhcmFtcy5zY2wgPSB0aGlzLnBhcmFtcy5zY2wgfHwgdGhpcy5wYXJhbXMuc2NrO1xuICAgIHRoaXMucGFyYW1zLmNsb2NrID0gdGhpcy5wYXJhbXMuY2xvY2sgfHwgMTAwICogMTAwMDtcbiAgICB0aGlzLnBhcmFtcy5tb2RlID0gXCJtYXN0ZXJcIjtcbiAgICB0aGlzLnBhcmFtcy5wdWxsID0gXCIzdlwiO1xuICAgIHRoaXMuaTJjID0gb2JuaXouZ2V0STJDV2l0aENvbmZpZyh0aGlzLnBhcmFtcyk7XG5cbiAgICB0aGlzLm9ibml6LndhaXQoMTApO1xuXG4gICAgdGhpcy5jb25maWcoKTtcblxuICAgIHRoaXMub2JuaXoud2FpdCgxMCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY29uZmlnKCkge1xuICAgIHRoaXMud3JpdGUoW1xuICAgICAgdGhpcy5jb21tYW5kcy5hZGRyZXNzZXMuY29uZmlnLFxuICAgICAgKHRoaXMuY29uZmlncmF0aW9uLmludGVydmFsIDw8IDUpIHxcbiAgICAgICh0aGlzLmNvbmZpZ3JhdGlvbi5paXJfc3RyZW5ndGggPDwgMikgfFxuICAgICAgMCxcbiAgICBdKTtcbiAgICB0aGlzLndyaXRlKFtcbiAgICAgIHRoaXMuY29tbWFuZHMuYWRkcmVzc2VzLmN0cmxfaHVtLFxuICAgICAgdGhpcy5jb25maWdyYXRpb24uc2FtcGxpbmcuaHVtLFxuICAgIF0pO1xuICAgIHRoaXMud3JpdGUoW1xuICAgICAgdGhpcy5jb21tYW5kcy5hZGRyZXNzZXMuY3RybF9tZWFzLFxuICAgICAgKHRoaXMuY29uZmlncmF0aW9uLnNhbXBsaW5nLnRlbXAgPDwgNSkgfFxuICAgICAgKHRoaXMuY29uZmlncmF0aW9uLnNhbXBsaW5nLnByZXMgPDwgMikgfFxuICAgICAgdGhpcy5jb25maWdyYXRpb24ubW9kZSxcbiAgICBdKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZXRJSVJTdHJlbmd0aChzdHJlbmdoOiBhbnkpIHtcbiAgICB0aGlzLmNvbmZpZ3JhdGlvbi5paXJfc3RyZW5ndGggPSBzdHJlbmdoO1xuICAgIHRoaXMuY29uZmlnKCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYXBwbHlDYWxpYnJhdGlvbigpIHtcbiAgICB0aGlzLmkyYy53cml0ZSh0aGlzLmFkZHJlc3MsIFsweDg4XSk7XG4gICAgY29uc3QgZGF0YTogYW55ID0gYXdhaXQgdGhpcy5pMmMucmVhZFdhaXQodGhpcy5hZGRyZXNzLCAyNCk7XG4gICAgdGhpcy5pMmMud3JpdGUodGhpcy5hZGRyZXNzLCBbMHhhMV0pO1xuICAgIGxldCBkYXRhX25leHQ6IGFueSA9IGF3YWl0IHRoaXMuaTJjLnJlYWRXYWl0KHRoaXMuYWRkcmVzcywgMSk7XG4gICAgZGF0YS5wdXNoKC4uLmRhdGFfbmV4dCk7XG4gICAgdGhpcy5pMmMud3JpdGUodGhpcy5hZGRyZXNzLCBbMHhlMV0pO1xuICAgIGRhdGFfbmV4dCA9IGF3YWl0IHRoaXMuaTJjLnJlYWRXYWl0KHRoaXMuYWRkcmVzcywgNyk7XG4gICAgZGF0YS5wdXNoKC4uLmRhdGFfbmV4dCk7XG4gICAgdGhpcy5fY2FsaWJyYXRlZCA9IHtcbiAgICAgIGRpZ19UMTogKGRhdGFbMV0gPDwgOCkgfCBkYXRhWzBdLFxuICAgICAgZGlnX1QyOiB0aGlzLl9yZWFkU2lnbmVkMTYoKGRhdGFbM10gPDwgOCkgfCBkYXRhWzJdKSxcbiAgICAgIGRpZ19UMzogdGhpcy5fcmVhZFNpZ25lZDE2KChkYXRhWzVdIDw8IDgpIHwgZGF0YVs0XSksXG4gICAgICBkaWdfUDE6IChkYXRhWzddIDw8IDgpIHwgZGF0YVs2XSxcbiAgICAgIGRpZ19QMjogdGhpcy5fcmVhZFNpZ25lZDE2KChkYXRhWzldIDw8IDgpIHwgZGF0YVs4XSksXG4gICAgICBkaWdfUDM6IHRoaXMuX3JlYWRTaWduZWQxNigoZGF0YVsxMV0gPDwgOCkgfCBkYXRhWzEwXSksXG4gICAgICBkaWdfUDQ6IHRoaXMuX3JlYWRTaWduZWQxNigoZGF0YVsxM10gPDwgOCkgfCBkYXRhWzEyXSksXG4gICAgICBkaWdfUDU6IHRoaXMuX3JlYWRTaWduZWQxNigoZGF0YVsxNV0gPDwgOCkgfCBkYXRhWzE0XSksXG4gICAgICBkaWdfUDY6IHRoaXMuX3JlYWRTaWduZWQxNigoZGF0YVsxN10gPDwgOCkgfCBkYXRhWzE2XSksXG4gICAgICBkaWdfUDc6IHRoaXMuX3JlYWRTaWduZWQxNigoZGF0YVsxOV0gPDwgOCkgfCBkYXRhWzE4XSksXG4gICAgICBkaWdfUDg6IHRoaXMuX3JlYWRTaWduZWQxNigoZGF0YVsyMV0gPDwgOCkgfCBkYXRhWzIwXSksXG4gICAgICBkaWdfUDk6IHRoaXMuX3JlYWRTaWduZWQxNigoZGF0YVsyM10gPDwgOCkgfCBkYXRhWzIyXSksXG4gICAgICBkaWdfSDE6IHRoaXMuX3JlYWRTaWduZWQ4KGRhdGFbMjRdKSxcbiAgICAgIGRpZ19IMjogdGhpcy5fcmVhZFNpZ25lZDE2KChkYXRhWzI2XSA8PCA4KSB8IGRhdGFbMjVdKSxcbiAgICAgIGRpZ19IMzogdGhpcy5fcmVhZFNpZ25lZDgoZGF0YVsyN10pLFxuICAgICAgZGlnX0g0OiB0aGlzLl9yZWFkU2lnbmVkMTYoKGRhdGFbMjhdIDw8IDQpIHwgKDB4MGYgJiBkYXRhWzI5XSkpLFxuICAgICAgZGlnX0g1OiB0aGlzLl9yZWFkU2lnbmVkMTYoKGRhdGFbMzBdIDw8IDQpIHwgKChkYXRhWzI5XSA+PiA0KSAmIDB4MGYpKSxcbiAgICAgIGRpZ19INjogdGhpcy5fcmVhZFNpZ25lZDgoZGF0YVszMV0pLFxuICAgIH07XG4gICAgdGhpcy5fdF9maW5lID0gMDtcbiAgfVxuXG4gIHB1YmxpYyBfcmVhZFNpZ25lZDE2KHZhbHVlOiBhbnkpIHtcbiAgICBpZiAodmFsdWUgPj0gMHg4MDAwKSB7XG4gICAgICB2YWx1ZSA9IHZhbHVlIC0gMHgxMDAwMDtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgcHVibGljIF9yZWFkU2lnbmVkOCh2YWx1ZTogYW55KSB7XG4gICAgaWYgKHZhbHVlID49IDB4ODApIHtcbiAgICAgIHZhbHVlID0gdmFsdWUgLSAweDEwMDtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgcHVibGljIHdyaXRlKGRhdGE6IGFueSkge1xuICAgIHRoaXMub2JuaXouaTJjMC53cml0ZSh0aGlzLmFkZHJlc3MsIGRhdGEpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldERhdGEoKSB7XG4gICAgdGhpcy5pMmMud3JpdGUodGhpcy5hZGRyZXNzLCBbMHhmN10pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmkyYy5yZWFkV2FpdCh0aGlzLmFkZHJlc3MsIDgpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldEFsbFdhaXQoKSB7XG4gICAgY29uc3QgZGF0YTogYW55ID0gYXdhaXQgdGhpcy5nZXREYXRhKCk7XG5cbiAgICBjb25zdCBwcmVzc19yYXc6IGFueSA9IChkYXRhWzBdIDw8IDEyKSB8IChkYXRhWzFdIDw8IDQpIHwgKGRhdGFbMl0gPj4gNCk7XG4gICAgY29uc3QgdGVtcF9yYXc6IGFueSA9IChkYXRhWzNdIDw8IDEyKSB8IChkYXRhWzRdIDw8IDQpIHwgKGRhdGFbNV0gPj4gNCk7XG4gICAgY29uc3QgaHVtX3JhdzogYW55ID0gKGRhdGFbNl0gPDwgOCkgfCBkYXRhWzddO1xuXG4gICAgY29uc3QgdGVtcGVyYXR1cmU6IGFueSA9IHRoaXMuY2FsaWJyYXRpb25fVCh0ZW1wX3JhdykgLyAxMDAuMDtcbiAgICBjb25zdCBwcmVzc3VyZTogYW55ID0gdGhpcy5jYWxpYnJhdGlvbl9QKHByZXNzX3JhdykgLyAxMDAuMDtcbiAgICBjb25zdCBodW1pZGl0eTogYW55ID0gdGhpcy5jYWxpYnJhdGlvbl9IKGh1bV9yYXcpO1xuXG4gICAgcmV0dXJuIHt0ZW1wZXJhdHVyZSwgaHVtaWRpdHksIHByZXNzdXJlfTtcbiAgfVxuXG4gIHB1YmxpYyBjYWxpYnJhdGlvbl9UKGFkY19UOiBhbnkpIHtcbiAgICBsZXQgdmFyMTogYW55OyBsZXQgdmFyMjogYW55OyBsZXQgVDogYW55O1xuICAgIHZhcjEgPVxuICAgICAgKCgoYWRjX1QgPj4gMykgLSAodGhpcy5fY2FsaWJyYXRlZC5kaWdfVDEgPDwgMSkpICpcbiAgICAgICAgdGhpcy5fY2FsaWJyYXRlZC5kaWdfVDIpID4+XG4gICAgICAxMTtcbiAgICB2YXIyID1cbiAgICAgICgoKCgoYWRjX1QgPj4gNCkgLSB0aGlzLl9jYWxpYnJhdGVkLmRpZ19UMSkgKlxuICAgICAgICAoKGFkY19UID4+IDQpIC0gdGhpcy5fY2FsaWJyYXRlZC5kaWdfVDEpKSA+PlxuICAgICAgICAxMikgKlxuICAgICAgICB0aGlzLl9jYWxpYnJhdGVkLmRpZ19UMykgPj5cbiAgICAgIDE0O1xuXG4gICAgdGhpcy5fdF9maW5lID0gdmFyMSArIHZhcjI7XG4gICAgVCA9ICh0aGlzLl90X2ZpbmUgKiA1ICsgMTI4KSA+PiA4O1xuICAgIHJldHVybiBUO1xuICB9XG5cbiAgcHVibGljIGNhbGlicmF0aW9uX1AoYWRjX1A6IGFueSkge1xuICAgIGxldCBwdmFyMTogYW55ID0gdGhpcy5fdF9maW5lIC8gMiAtIDY0MDAwO1xuICAgIGxldCBwdmFyMjogYW55ID0gKHB2YXIxICogcHZhcjEgKiB0aGlzLl9jYWxpYnJhdGVkLmRpZ19QNikgLyAzMjc2ODtcbiAgICBwdmFyMiA9IHB2YXIyICsgcHZhcjEgKiB0aGlzLl9jYWxpYnJhdGVkLmRpZ19QNSAqIDI7XG4gICAgcHZhcjIgPSBwdmFyMiAvIDQgKyB0aGlzLl9jYWxpYnJhdGVkLmRpZ19QNCAqIDY1NTM2O1xuICAgIHB2YXIxID1cbiAgICAgICgodGhpcy5fY2FsaWJyYXRlZC5kaWdfUDMgKiBwdmFyMSAqIHB2YXIxKSAvIDUyNDI4OCArXG4gICAgICAgIHRoaXMuX2NhbGlicmF0ZWQuZGlnX1AyICogcHZhcjEpIC9cbiAgICAgIDUyNDI4ODtcbiAgICBwdmFyMSA9ICgxICsgcHZhcjEgLyAzMjc2OCkgKiB0aGlzLl9jYWxpYnJhdGVkLmRpZ19QMTtcblxuICAgIGlmIChwdmFyMSAhPT0gMCkge1xuICAgICAgbGV0IHA6IGFueSA9IDEwNDg1NzYgLSBhZGNfUDtcbiAgICAgIHAgPSAoKHAgLSBwdmFyMiAvIDQwOTYpICogNjI1MCkgLyBwdmFyMTtcbiAgICAgIHB2YXIxID0gKHRoaXMuX2NhbGlicmF0ZWQuZGlnX1A5ICogcCAqIHApIC8gMjE0NzQ4MzY0ODtcbiAgICAgIHB2YXIyID0gKHAgKiB0aGlzLl9jYWxpYnJhdGVkLmRpZ19QOCkgLyAzMjc2ODtcbiAgICAgIHAgPSBwICsgKHB2YXIxICsgcHZhcjIgKyB0aGlzLl9jYWxpYnJhdGVkLmRpZ19QNykgLyAxNjtcbiAgICAgIHJldHVybiBwO1xuICAgIH1cbiAgICByZXR1cm4gMDtcbiAgfVxuXG4gIHB1YmxpYyBjYWxpYnJhdGlvbl9IKGFkY19IOiBhbnkpIHtcbiAgICBsZXQgaDogYW55ID0gdGhpcy5fdF9maW5lIC0gNzY4MDA7XG4gICAgaCA9XG4gICAgICAoYWRjX0ggLVxuICAgICAgICAodGhpcy5fY2FsaWJyYXRlZC5kaWdfSDQgKiA2NCArXG4gICAgICAgICAgKHRoaXMuX2NhbGlicmF0ZWQuZGlnX0g1IC8gMTYzODQpICogaCkpICpcbiAgICAgICgodGhpcy5fY2FsaWJyYXRlZC5kaWdfSDIgLyA2NTUzNikgKlxuICAgICAgICAoMSArXG4gICAgICAgICAgKHRoaXMuX2NhbGlicmF0ZWQuZGlnX0g2IC8gNjcxMDg4NjQpICpcbiAgICAgICAgICBoICpcbiAgICAgICAgICAoMSArICh0aGlzLl9jYWxpYnJhdGVkLmRpZ19IMyAvIDY3MTA4ODY0KSAqIGgpKSk7XG4gICAgaCA9IGggKiAoMSAtICh0aGlzLl9jYWxpYnJhdGVkLmRpZ19IMSAqIGgpIC8gNTI0Mjg4KTtcbiAgICByZXR1cm4gaDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRUZW1wV2FpdCgpIHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0QWxsV2FpdCgpKS50ZW1wZXJhdHVyZTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRIdW1kV2FpdCgpIHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0QWxsV2FpdCgpKS5odW1pZGl0eTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRQcmVzc3VyZVdhaXQoKSB7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldEFsbFdhaXQoKSkucHJlc3N1cmU7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0QWx0aXR1ZGVXYWl0KCkge1xuICAgIGNvbnN0IHByZXNzdXJlOiBhbnkgPSBhd2FpdCB0aGlzLmdldFByZXNzdXJlV2FpdCgpO1xuICAgIHJldHVybiB0aGlzLmNhbGNBbHRpdHVkZShwcmVzc3VyZSk7XG4gIH1cblxuICBwdWJsaWMgY2FsY0FsdGl0dWRlKHByZXNzdXJlOiBhbnksIHNlYUxldmVsOiBhbnkgPSAxMDEzLjI1KSB7XG4gICAgcmV0dXJuIChcbiAgICAgICgxLjAgLSBNYXRoLnBvdyhwcmVzc3VyZSAvIHNlYUxldmVsLCAxIC8gNS4yNTUzKSkgKiAxNDUzNjYuNDUgKiAwLjMwNDhcbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEJNRTI4MDtcbiJdfQ==

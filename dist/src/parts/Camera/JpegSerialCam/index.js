"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
class JpegSerialCam {
    constructor() {
        this.keys = ["vcc", "cam_tx", "cam_rx", "gnd"];
        this.requiredKeys = ["cam_tx", "cam_rx"];
        this.ioKeys = this.keys;
        this.displayName = "Jcam";
        this.displayIoNames = { cam_tx: "camTx", cam_rx: "camRx" };
    }
    static info() {
        return {
            name: "JpegSerialCam",
        };
    }
    wired(obniz) {
        this.obniz = obniz;
        this.obniz.setVccGnd(this.params.vcc, this.params.gnd, "5v");
        this.my_tx = this.params.cam_rx;
        this.my_rx = this.params.cam_tx;
        this.obniz.getIO(this.my_tx).drive("3v");
        this.uart = this.obniz.getFreeUart();
    }
    _drainUntil(uart, search, recv) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!recv) {
                recv = [];
            }
            while (true) {
                const readed = uart.readBytes();
                recv = recv.concat(readed);
                const tail = this._seekTail(search, recv);
                if (tail >= 0) {
                    recv.splice(0, tail);
                    return recv;
                }
                yield this.obniz.wait(10);
            }
        });
    }
    _seekTail(search, src) {
        let f = 0;
        for (let i = 0; i < src.length; i++) {
            if (src[i] === search[f]) {
                f++;
                if (f === search.length) {
                    return i + 1;
                }
            }
            else {
                f = 0;
            }
        }
        return -1;
    }
    arrayToBase64(array) {
        return Buffer.from(array).toString("base64");
    }
    startWait(obj) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!obj) {
                obj = {};
            }
            this.uart.start({
                tx: this.my_tx,
                rx: this.my_rx,
                baud: obj.baud || 38400,
            });
            this.obniz.display.setPinName(this.my_tx, "JpegSerialCam", "camRx");
            this.obniz.display.setPinName(this.my_rx, "JpegSerialCam", "camTx");
            yield this.obniz.wait(2500);
        });
    }
    resetwait() {
        return __awaiter(this, void 0, void 0, function* () {
            this.uart.send([0x56, 0x00, 0x26, 0x00]);
            yield this._drainUntil(this.uart, [0x76, 0x00, 0x26, 0x00]);
            yield this.obniz.wait(2500);
        });
    }
    setSizeWait(resolution) {
        return __awaiter(this, void 0, void 0, function* () {
            let val;
            if (resolution === "640x480") {
                val = 0x00;
            }
            else if (resolution === "320x240") {
                val = 0x11;
            }
            else if (resolution === "160x120") {
                val = 0x22;
            }
            else {
                throw new Error("unsupported size");
            }
            this.uart.send([0x56, 0x00, 0x31, 0x05, 0x04, 0x01, 0x00, 0x19, val]);
            yield this._drainUntil(this.uart, [0x76, 0x00, 0x31, 0x00]);
            yield this.resetwait();
        });
    }
    setCompressibilityWait(compress) {
        return __awaiter(this, void 0, void 0, function* () {
            const val = Math.floor((compress / 100) * 0xff);
            this.uart.send([0x56, 0x00, 0x31, 0x05, 0x01, 0x01, 0x12, 0x04, val]);
            yield this._drainUntil(this.uart, [0x76, 0x00, 0x31, 0x00]);
            yield this.resetwait();
        });
    }
    setBaudWait(baud) {
        return __awaiter(this, void 0, void 0, function* () {
            let val;
            switch (baud) {
                case 9600:
                    val = [0xae, 0xc8];
                    break;
                case 19200:
                    val = [0x56, 0xe4];
                    break;
                case 38400:
                    val = [0x2a, 0xf2];
                    break;
                case 57600:
                    val = [0x1c, 0x4c];
                    break;
                case 115200:
                    val = [0x0d, 0xa6];
                    break;
                default:
                    throw new Error("invalid baud rate");
            }
            this.uart.send([
                0x56,
                0x00,
                0x31,
                0x06,
                0x04,
                0x02,
                0x00,
                0x08,
                val[0],
                val[1],
            ]);
            yield this._drainUntil(this.uart, [0x76, 0x00, 0x31, 0x00]);
            // await this.obniz.wait(1000);
            yield this.startWait({
                baud,
            });
        });
    }
    takeWait() {
        return __awaiter(this, void 0, void 0, function* () {
            const uart = this.uart;
            // console.log("stop a photo")
            uart.send([0x56, 0x00, 0x36, 0x01, 0x02]);
            yield this._drainUntil(uart, [0x76, 0x00, 0x36, 0x00, 0x00]);
            // console.log("take a photo")
            uart.send([0x56, 0x00, 0x36, 0x01, 0x00]);
            yield this._drainUntil(uart, [0x76, 0x00, 0x36, 0x00, 0x00]);
            // console.log("read length")
            uart.send([0x56, 0x00, 0x34, 0x01, 0x00]); // read length of image data
            let recv = yield this._drainUntil(uart, [
                0x76,
                0x00,
                0x34,
                0x00,
                0x04,
                0x00,
                0x00,
            ]); // ack
            let XX;
            let YY;
            while (true) {
                const readed = uart.readBytes();
                // console.log(recv);
                recv = recv.concat(readed);
                if (recv.length >= 2) {
                    XX = recv[0];
                    YY = recv[1];
                    break;
                }
                yield this.obniz.wait(1000);
            }
            const databytes = XX * 256 + YY;
            // console.log("image: " + databytes + " Bytes");
            // const high = (databytes >> 8) & 0xff;
            // const low = databytes & 0xff;
            // console.log("start reading image")
            uart.send([
                0x56,
                0x00,
                0x32,
                0x0c,
                0x00,
                0x0a,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                0x00,
                XX,
                YY,
                0x00,
                0xff,
            ]);
            recv = yield this._drainUntil(uart, [0x76, 0x00, 0x32, 0x00, 0x00]);
            // console.log("reading...");
            while (true) {
                const readed = uart.readBytes();
                recv = recv.concat(readed);
                // console.log(readed.length);
                if (recv.length >= databytes) {
                    break;
                }
                yield this.obniz.wait(10);
            }
            // console.log("done");
            recv = recv.splice(0, databytes); // remove tail
            recv = recv.concat([0xff, 0xd9]);
            return recv;
        });
    }
}
exports.default = JpegSerialCam;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXJ0cy9DYW1lcmEvSnBlZ1NlcmlhbENhbS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLE1BQU0sYUFBYTtJQW1CakI7UUFDRSxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUV6QyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUM7UUFDMUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBQyxDQUFDO0lBQzNELENBQUM7SUF4Qk0sTUFBTSxDQUFDLElBQUk7UUFDaEIsT0FBTztZQUNMLElBQUksRUFBRSxlQUFlO1NBQ3RCLENBQUM7SUFDSixDQUFDO0lBc0JNLEtBQUssQ0FBQyxLQUFVO1FBQ3JCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDaEMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUVoQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXpDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFD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QUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUMzQjtZQUNELHVCQUF1QjtZQUN2QixJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxjQUFjO1lBQ2hELElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDakMsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO0tBQUE7Q0FDRjtBQUVELGtCQUFlLGFBQWEsQ0FBQyIsImZpbGUiOiJzcmMvcGFydHMvQ2FtZXJhL0pwZWdTZXJpYWxDYW0vaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJjbGFzcyBKcGVnU2VyaWFsQ2FtIHtcblxuICBwdWJsaWMgc3RhdGljIGluZm8oKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IFwiSnBlZ1NlcmlhbENhbVwiLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMga2V5czogYW55O1xuICBwdWJsaWMgcmVxdWlyZWRLZXlzOiBhbnk7XG4gIHB1YmxpYyBpb0tleXM6IGFueTtcbiAgcHVibGljIGRpc3BsYXlOYW1lOiBhbnk7XG4gIHB1YmxpYyBkaXNwbGF5SW9OYW1lczogYW55O1xuICBwdWJsaWMgb2JuaXo6IGFueTtcbiAgcHVibGljIHBhcmFtczogYW55O1xuICBwdWJsaWMgbXlfdHg6IGFueTtcbiAgcHVibGljIG15X3J4OiBhbnk7XG4gIHB1YmxpYyB1YXJ0OiBhbnk7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5rZXlzID0gW1widmNjXCIsIFwiY2FtX3R4XCIsIFwiY2FtX3J4XCIsIFwiZ25kXCJdO1xuICAgIHRoaXMucmVxdWlyZWRLZXlzID0gW1wiY2FtX3R4XCIsIFwiY2FtX3J4XCJdO1xuXG4gICAgdGhpcy5pb0tleXMgPSB0aGlzLmtleXM7XG4gICAgdGhpcy5kaXNwbGF5TmFtZSA9IFwiSmNhbVwiO1xuICAgIHRoaXMuZGlzcGxheUlvTmFtZXMgPSB7Y2FtX3R4OiBcImNhbVR4XCIsIGNhbV9yeDogXCJjYW1SeFwifTtcbiAgfVxuXG4gIHB1YmxpYyB3aXJlZChvYm5pejogYW55KSB7XG4gICAgdGhpcy5vYm5peiA9IG9ibml6O1xuICAgIHRoaXMub2JuaXouc2V0VmNjR25kKHRoaXMucGFyYW1zLnZjYywgdGhpcy5wYXJhbXMuZ25kLCBcIjV2XCIpO1xuICAgIHRoaXMubXlfdHggPSB0aGlzLnBhcmFtcy5jYW1fcng7XG4gICAgdGhpcy5teV9yeCA9IHRoaXMucGFyYW1zLmNhbV90eDtcblxuICAgIHRoaXMub2JuaXouZ2V0SU8odGhpcy5teV90eCkuZHJpdmUoXCIzdlwiKTtcblxuICAgIHRoaXMudWFydCA9IHRoaXMub2JuaXouZ2V0RnJlZVVhcnQoKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBfZHJhaW5VbnRpbCh1YXJ0OiBhbnksIHNlYXJjaDogYW55LCByZWN2PzogYW55KSB7XG4gICAgaWYgKCFyZWN2KSB7XG4gICAgICByZWN2ID0gW107XG4gICAgfVxuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICBjb25zdCByZWFkZWQ6IGFueSA9IHVhcnQucmVhZEJ5dGVzKCk7XG4gICAgICByZWN2ID0gcmVjdi5jb25jYXQocmVhZGVkKTtcbiAgICAgIGNvbnN0IHRhaWw6IGFueSA9IHRoaXMuX3NlZWtUYWlsKHNlYXJjaCwgcmVjdik7XG4gICAgICBpZiAodGFpbCA+PSAwKSB7XG4gICAgICAgIHJlY3Yuc3BsaWNlKDAsIHRhaWwpO1xuICAgICAgICByZXR1cm4gcmVjdjtcbiAgICAgIH1cbiAgICAgIGF3YWl0IHRoaXMub2JuaXoud2FpdCgxMCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIF9zZWVrVGFpbChzZWFyY2g6IGFueSwgc3JjOiBhbnkpIHtcbiAgICBsZXQgZjogYW55ID0gMDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNyYy5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKHNyY1tpXSA9PT0gc2VhcmNoW2ZdKSB7XG4gICAgICAgIGYrKztcbiAgICAgICAgaWYgKGYgPT09IHNlYXJjaC5sZW5ndGgpIHtcbiAgICAgICAgICByZXR1cm4gaSArIDE7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGYgPSAwO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gLTE7XG4gIH1cblxuICBwdWJsaWMgYXJyYXlUb0Jhc2U2NChhcnJheTogYW55KSB7XG4gICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGFycmF5KS50b1N0cmluZyhcImJhc2U2NFwiKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzdGFydFdhaXQob2JqOiBhbnkpIHtcbiAgICBpZiAoIW9iaikge1xuICAgICAgb2JqID0ge307XG4gICAgfVxuICAgIHRoaXMudWFydC5zdGFydCh7XG4gICAgICB0eDogdGhpcy5teV90eCxcbiAgICAgIHJ4OiB0aGlzLm15X3J4LFxuICAgICAgYmF1ZDogb2JqLmJhdWQgfHwgMzg0MDAsXG4gICAgfSk7XG4gICAgdGhpcy5vYm5pei5kaXNwbGF5LnNldFBpbk5hbWUodGhpcy5teV90eCwgXCJKcGVnU2VyaWFsQ2FtXCIsIFwiY2FtUnhcIik7XG4gICAgdGhpcy5vYm5pei5kaXNwbGF5LnNldFBpbk5hbWUodGhpcy5teV9yeCwgXCJKcGVnU2VyaWFsQ2FtXCIsIFwiY2FtVHhcIik7XG4gICAgYXdhaXQgdGhpcy5vYm5pei53YWl0KDI1MDApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlc2V0d2FpdCgpIHtcbiAgICB0aGlzLnVhcnQuc2VuZChbMHg1NiwgMHgwMCwgMHgyNiwgMHgwMF0pO1xuICAgIGF3YWl0IHRoaXMuX2RyYWluVW50aWwodGhpcy51YXJ0LCBbMHg3NiwgMHgwMCwgMHgyNiwgMHgwMF0pO1xuICAgIGF3YWl0IHRoaXMub2JuaXoud2FpdCgyNTAwKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZXRTaXplV2FpdChyZXNvbHV0aW9uOiBhbnkpIHtcbiAgICBsZXQgdmFsOiBhbnk7XG4gICAgaWYgKHJlc29sdXRpb24gPT09IFwiNjQweDQ4MFwiKSB7XG4gICAgICB2YWwgPSAweDAwO1xuICAgIH0gZWxzZSBpZiAocmVzb2x1dGlvbiA9PT0gXCIzMjB4MjQwXCIpIHtcbiAgICAgIHZhbCA9IDB4MTE7XG4gICAgfSBlbHNlIGlmIChyZXNvbHV0aW9uID09PSBcIjE2MHgxMjBcIikge1xuICAgICAgdmFsID0gMHgyMjtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwidW5zdXBwb3J0ZWQgc2l6ZVwiKTtcbiAgICB9XG4gICAgdGhpcy51YXJ0LnNlbmQoWzB4NTYsIDB4MDAsIDB4MzEsIDB4MDUsIDB4MDQsIDB4MDEsIDB4MDAsIDB4MTksIHZhbF0pO1xuICAgIGF3YWl0IHRoaXMuX2RyYWluVW50aWwodGhpcy51YXJ0LCBbMHg3NiwgMHgwMCwgMHgzMSwgMHgwMF0pO1xuICAgIGF3YWl0IHRoaXMucmVzZXR3YWl0KCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2V0Q29tcHJlc3NpYmlsaXR5V2FpdChjb21wcmVzczogYW55KSB7XG4gICAgY29uc3QgdmFsOiBhbnkgPSBNYXRoLmZsb29yKChjb21wcmVzcyAvIDEwMCkgKiAweGZmKTtcbiAgICB0aGlzLnVhcnQuc2VuZChbMHg1NiwgMHgwMCwgMHgzMSwgMHgwNSwgMHgwMSwgMHgwMSwgMHgxMiwgMHgwNCwgdmFsXSk7XG4gICAgYXdhaXQgdGhpcy5fZHJhaW5VbnRpbCh0aGlzLnVhcnQsIFsweDc2LCAweDAwLCAweDMxLCAweDAwXSk7XG4gICAgYXdhaXQgdGhpcy5yZXNldHdhaXQoKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZXRCYXVkV2FpdChiYXVkOiBhbnkpIHtcbiAgICBsZXQgdmFsOiBhbnk7XG4gICAgc3dpdGNoIChiYXVkKSB7XG4gICAgICBjYXNlIDk2MDA6XG4gICAgICAgIHZhbCA9IFsweGFlLCAweGM4XTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDE5MjAwOlxuICAgICAgICB2YWwgPSBbMHg1NiwgMHhlNF07XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAzODQwMDpcbiAgICAgICAgdmFsID0gWzB4MmEsIDB4ZjJdO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgNTc2MDA6XG4gICAgICAgIHZhbCA9IFsweDFjLCAweDRjXTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDExNTIwMDpcbiAgICAgICAgdmFsID0gWzB4MGQsIDB4YTZdO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcImludmFsaWQgYmF1ZCByYXRlXCIpO1xuICAgIH1cbiAgICB0aGlzLnVhcnQuc2VuZChbXG4gICAgICAweDU2LFxuICAgICAgMHgwMCxcbiAgICAgIDB4MzEsXG4gICAgICAweDA2LFxuICAgICAgMHgwNCxcbiAgICAgIDB4MDIsXG4gICAgICAweDAwLFxuICAgICAgMHgwOCxcbiAgICAgIHZhbFswXSxcbiAgICAgIHZhbFsxXSxcbiAgICBdKTtcbiAgICBhd2FpdCB0aGlzLl9kcmFpblVudGlsKHRoaXMudWFydCwgWzB4NzYsIDB4MDAsIDB4MzEsIDB4MDBdKTtcbiAgICAvLyBhd2FpdCB0aGlzLm9ibml6LndhaXQoMTAwMCk7XG4gICAgYXdhaXQgdGhpcy5zdGFydFdhaXQoe1xuICAgICAgYmF1ZCxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB0YWtlV2FpdCgpIHtcbiAgICBjb25zdCB1YXJ0OiBhbnkgPSB0aGlzLnVhcnQ7XG4gICAgLy8gY29uc29sZS5sb2coXCJzdG9wIGEgcGhvdG9cIilcbiAgICB1YXJ0LnNlbmQoWzB4NTYsIDB4MDAsIDB4MzYsIDB4MDEsIDB4MDJdKTtcbiAgICBhd2FpdCB0aGlzLl9kcmFpblVudGlsKHVhcnQsIFsweDc2LCAweDAwLCAweDM2LCAweDAwLCAweDAwXSk7XG5cbiAgICAvLyBjb25zb2xlLmxvZyhcInRha2UgYSBwaG90b1wiKVxuICAgIHVhcnQuc2VuZChbMHg1NiwgMHgwMCwgMHgzNiwgMHgwMSwgMHgwMF0pO1xuICAgIGF3YWl0IHRoaXMuX2RyYWluVW50aWwodWFydCwgWzB4NzYsIDB4MDAsIDB4MzYsIDB4MDAsIDB4MDBdKTtcblxuICAgIC8vIGNvbnNvbGUubG9nKFwicmVhZCBsZW5ndGhcIilcbiAgICB1YXJ0LnNlbmQoWzB4NTYsIDB4MDAsIDB4MzQsIDB4MDEsIDB4MDBdKTsgLy8gcmVhZCBsZW5ndGggb2YgaW1hZ2UgZGF0YVxuICAgIGxldCByZWN2OiBhbnkgPSBhd2FpdCB0aGlzLl9kcmFpblVudGlsKHVhcnQsIFtcbiAgICAgIDB4NzYsXG4gICAgICAweDAwLFxuICAgICAgMHgzNCxcbiAgICAgIDB4MDAsXG4gICAgICAweDA0LFxuICAgICAgMHgwMCxcbiAgICAgIDB4MDAsXG4gICAgXSk7IC8vIGFja1xuICAgIGxldCBYWDogYW55O1xuICAgIGxldCBZWTogYW55O1xuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICBjb25zdCByZWFkZWQ6IGFueSA9IHVhcnQucmVhZEJ5dGVzKCk7XG4gICAgICAvLyBjb25zb2xlLmxvZyhyZWN2KTtcbiAgICAgIHJlY3YgPSByZWN2LmNvbmNhdChyZWFkZWQpO1xuICAgICAgaWYgKHJlY3YubGVuZ3RoID49IDIpIHtcbiAgICAgICAgWFggPSByZWN2WzBdO1xuICAgICAgICBZWSA9IHJlY3ZbMV07XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgYXdhaXQgdGhpcy5vYm5pei53YWl0KDEwMDApO1xuICAgIH1cbiAgICBjb25zdCBkYXRhYnl0ZXM6IGFueSA9IFhYICogMjU2ICsgWVk7XG4gICAgLy8gY29uc29sZS5sb2coXCJpbWFnZTogXCIgKyBkYXRhYnl0ZXMgKyBcIiBCeXRlc1wiKTtcbiAgICAvLyBjb25zdCBoaWdoID0gKGRhdGFieXRlcyA+PiA4KSAmIDB4ZmY7XG4gICAgLy8gY29uc3QgbG93ID0gZGF0YWJ5dGVzICYgMHhmZjtcblxuICAgIC8vIGNvbnNvbGUubG9nKFwic3RhcnQgcmVhZGluZyBpbWFnZVwiKVxuICAgIHVhcnQuc2VuZChbXG4gICAgICAweDU2LFxuICAgICAgMHgwMCxcbiAgICAgIDB4MzIsXG4gICAgICAweDBjLFxuICAgICAgMHgwMCxcbiAgICAgIDB4MGEsXG4gICAgICAweDAwLFxuICAgICAgMHgwMCxcbiAgICAgIDB4MDAsXG4gICAgICAweDAwLFxuICAgICAgMHgwMCxcbiAgICAgIDB4MDAsXG4gICAgICBYWCxcbiAgICAgIFlZLFxuICAgICAgMHgwMCxcbiAgICAgIDB4ZmYsXG4gICAgXSk7XG4gICAgcmVjdiA9IGF3YWl0IHRoaXMuX2RyYWluVW50aWwodWFydCwgWzB4NzYsIDB4MDAsIDB4MzIsIDB4MDAsIDB4MDBdKTtcbiAgICAvLyBjb25zb2xlLmxvZyhcInJlYWRpbmcuLi5cIik7XG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIGNvbnN0IHJlYWRlZDogYW55ID0gdWFydC5yZWFkQnl0ZXMoKTtcbiAgICAgIHJlY3YgPSByZWN2LmNvbmNhdChyZWFkZWQpO1xuICAgICAgLy8gY29uc29sZS5sb2cocmVhZGVkLmxlbmd0aCk7XG4gICAgICBpZiAocmVjdi5sZW5ndGggPj0gZGF0YWJ5dGVzKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgYXdhaXQgdGhpcy5vYm5pei53YWl0KDEwKTtcbiAgICB9XG4gICAgLy8gY29uc29sZS5sb2coXCJkb25lXCIpO1xuICAgIHJlY3YgPSByZWN2LnNwbGljZSgwLCBkYXRhYnl0ZXMpOyAvLyByZW1vdmUgdGFpbFxuICAgIHJlY3YgPSByZWN2LmNvbmNhdChbMHhmZiwgMHhkOV0pO1xuICAgIHJldHVybiByZWN2O1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEpwZWdTZXJpYWxDYW07XG4iXX0=

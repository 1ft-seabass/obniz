"use strict";
const ObnizSystemMethods = require('./ObnizSystemMethods');
module.exports = class ObnizUIs extends ObnizSystemMethods {
    constructor(id, options) {
        super(id, options);
    }
    isValidObnizId(str) {
        if (typeof str != 'string' || str.length < 8) {
            return null;
        }
        str = str.replace('-', '');
        let id = parseInt(str);
        if (isNaN(id)) {
            id = null;
        }
        return id != null;
    }
    wsconnect(desired_server) {
        this.showOffLine();
        if (!this.isValidObnizId(this.id)) {
            if (this.isNode) {
                this.error('invalid obniz id');
            }
            else {
                let filled = _ReadCookie('obniz-last-used') || '';
                this.prompt(filled, function (obnizid) {
                    this.id = obnizid;
                    this.wsconnect(desired_server);
                }.bind(this));
            }
            return;
        }
        super.wsconnect(desired_server);
    }
    showAlertUI(obj) {
        if (this.isNode || !document.getElementById(this.options.debug_dom_id)) {
            return;
        }
        let dom = `
    <div style="background-color:${obj.alert === 'warning' ? '#ffee35' : '#ff7b34'}">${obj.message}</div>`;
        document
            .getElementById(this.options.debug_dom_id)
            .insertAdjacentHTML('beforeend', dom);
    }
    getDebugDoms() {
        if (this.isNode) {
            return;
        }
        let loaderDom = document.querySelector('#loader');
        let debugDom = document.querySelector('#' + this.options.debug_dom_id);
        let statusDom = document.querySelector('#' + this.options.debug_dom_id + ' #online-status');
        if (debugDom && !statusDom) {
            statusDom = document.createElement('div');
            statusDom.id = 'online-status';
            statusDom.style.color = '#FFF';
            statusDom.style.padding = '5px';
            statusDom.style.textAlign = 'center';
            debugDom.insertBefore(statusDom, debugDom.firstChild);
        }
        return { loaderDom: loaderDom, debugDom: debugDom, statusDom: statusDom };
    }
    /* online offline */
    _callOnConnect() {
        this.updateOnlineUI();
        super._callOnConnect();
    }
    close() {
        super.close();
        this.updateOnlineUI();
    }
    _disconnectLocal() {
        super._disconnectLocal();
        this.updateOnlineUI();
    }
    updateOnlineUI() {
        if (this.isNode) {
            return;
        }
        const isConnected = this.socket && this.socket.readyState === 1;
        const isConnectedLocally = this.socket_local && this.socket_local.readyState === 1;
        if (isConnected && isConnectedLocally) {
            this.showOnLine(true);
        }
        else if (isConnected) {
            this.showOnLine(false);
        }
        else {
            this.showOffLine();
        }
    }
    showOnLine(isConnectedLocally) {
        if (this.isNode) {
            return;
        }
        const doms = this.getDebugDoms();
        if (doms.loaderDom) {
            doms.loaderDom.style.display = 'none';
        }
        if (doms.statusDom) {
            doms.statusDom.style.backgroundColor = isConnectedLocally
                ? '#0cd362'
                : '#31965d';
            doms.statusDom.style.color = '#FFF';
            doms.statusDom.innerHTML =
                (this.id ? 'online : ' + this.id : 'online') +
                    (isConnectedLocally ? ' via local_connect' : ' via internet');
        }
    }
    showOffLine() {
        if (this.isNode) {
            return;
        }
        const doms = this.getDebugDoms();
        if (doms.loaderDom) {
            doms.loaderDom.style.display = 'block';
        }
        if (doms.statusDom) {
            doms.statusDom.style.backgroundColor = '#d9534f';
            doms.statusDom.style.color = '#FFF';
            doms.statusDom.innerHTML = this.id ? 'offline : ' + this.id : 'offline';
        }
    }
};
function _ReadCookie(name) {
    let nameEQ = name + '=';
    let ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') {
            c = c.substring(1, c.length);
        }
        if (c.indexOf(nameEQ) === 0) {
            return c.substring(nameEQ.length, c.length);
        }
    }
    return null;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9PYm5pelVJcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUUzRCxNQUFNLENBQUMsT0FBTyxHQUFHLE1BQU0sUUFBUyxTQUFRLGtCQUFrQjtJQUN4RCxZQUFZLEVBQUUsRUFBRSxPQUFPO1FBQ3JCLEtBQUssQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDckIsQ0FBQztJQUVELGNBQWMsQ0FBQyxHQUFHO1FBQ2hCLElBQUksT0FBTyxHQUFHLElBQUksUUFBUSxJQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzVDLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxHQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDM0IsSUFBSSxFQUFFLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1lBQ2IsRUFBRSxHQUFHLElBQUksQ0FBQztTQUNYO1FBQ0QsT0FBTyxFQUFFLElBQUksSUFBSSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxTQUFTLENBQUMsY0FBYztRQUN0QixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFO1lBQ2pDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDZixJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7YUFDaEM7aUJBQU07Z0JBQ0wsSUFBSSxNQUFNLEdBQUcsV0FBVyxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNsRCxJQUFJLENBQUMsTUFBTSxDQUNULE1BQU0sRUFDTixVQUFTLE9BQU87b0JBQ2QsSUFBSSxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUM7b0JBQ2xCLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ2pDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQ2IsQ0FBQzthQUNIO1lBQ0QsT0FBTztTQUNSO1FBQ0QsS0FBSyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsV0FBVyxDQUFDLEdBQUc7UUFDYixJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDdEUsT0FBTztTQUNSO1FBQ0QsSUFBSSxHQUFHLEdBQUc7bUNBRVIsR0FBRyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FDeEMsS0FBSyxHQUFHLENBQUMsT0FBTyxRQUFRLENBQUM7UUFDekIsUUFBUTthQUNMLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQzthQUN6QyxrQkFBa0IsQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVELFlBQVk7UUFDVixJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDZixPQUFPO1NBQ1I7UUFDRCxJQUFJLFNBQVMsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2xELElBQUksUUFBUSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkUsSUFBSSxTQUFTLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FDcEMsR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxHQUFHLGlCQUFpQixDQUNwRCxDQUFDO1FBQ0YsSUFBSSxRQUFRLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDMUIsU0FBUyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDMUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxlQUFlLENBQUM7WUFDL0IsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDO1lBQy9CLFNBQVMsQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztZQUNoQyxTQUFTLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUM7WUFDckMsUUFBUSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQ3ZEO1FBQ0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLENBQUM7SUFDNUUsQ0FBQztJQUVELG9CQUFvQjtJQUVwQixjQUFjO1FBQ1osSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRUQsS0FBSztRQUNILEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNkLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRUQsZ0JBQWdCO1FBQ2QsS0FBSyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDekIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxjQUFjO1FBQ1osSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ2YsT0FBTztTQUNSO1FBRUQsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsS0FBSyxDQUFDLENBQUM7UUFDaEUsTUFBTSxrQkFBa0IsR0FDdEIsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsS0FBSyxDQUFDLENBQUM7UUFDMUQsSUFBSSxXQUFXLElBQUksa0JBQWtCLEVBQUU7WUFDckMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN2QjthQUFNLElBQUksV0FBVyxFQUFFO1lBQ3RCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDeEI7YUFBTTtZQUNMLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNwQjtJQUNILENBQUM7SUFFRCxVQUFVLENBQUMsa0JBQWtCO1FBQzNCLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNmLE9BQU87U0FDUjtRQUNELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNqQyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztTQUN2QztRQUNELElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxlQUFlLEdBQUcsa0JBQWtCO2dCQUN2RCxDQUFDLENBQUMsU0FBUztnQkFDWCxDQUFDLENBQUMsU0FBUyxDQUFDO1lBQ2QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQztZQUNwQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVM7Z0JBQ3RCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztvQkFDNUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1NBQ2pFO0lBQ0gsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDZixPQUFPO1NBQ1I7UUFFRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDakMsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7U0FDeEM7UUFDRCxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQztZQUNqRCxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDO1lBQ3BDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7U0FDekU7SUFDSCxDQUFDO0NBQ0YsQ0FBQztBQUVGLFNBQVMsV0FBVyxDQUFDLElBQUk7SUFDdkIsSUFBSSxNQUFNLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQztJQUN4QixJQUFJLEVBQUUsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNsQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDZCxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQzFCLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDOUI7UUFDRCxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQzNCLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUM3QztLQUNGO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDIiwiZmlsZSI6Im9ibml6L09ibml6VUlzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgT2JuaXpTeXN0ZW1NZXRob2RzID0gcmVxdWlyZSgnLi9PYm5pelN5c3RlbU1ldGhvZHMnKTtcblxubW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBPYm5pelVJcyBleHRlbmRzIE9ibml6U3lzdGVtTWV0aG9kcyB7XG4gIGNvbnN0cnVjdG9yKGlkLCBvcHRpb25zKSB7XG4gICAgc3VwZXIoaWQsIG9wdGlvbnMpO1xuICB9XG5cbiAgaXNWYWxpZE9ibml6SWQoc3RyKSB7XG4gICAgaWYgKHR5cGVvZiBzdHIgIT0gJ3N0cmluZycgfHwgc3RyLmxlbmd0aCA8IDgpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBzdHIgPSBzdHIucmVwbGFjZSgnLScsICcnKTtcbiAgICBsZXQgaWQgPSBwYXJzZUludChzdHIpO1xuICAgIGlmIChpc05hTihpZCkpIHtcbiAgICAgIGlkID0gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIGlkICE9IG51bGw7XG4gIH1cblxuICB3c2Nvbm5lY3QoZGVzaXJlZF9zZXJ2ZXIpIHtcbiAgICB0aGlzLnNob3dPZmZMaW5lKCk7XG4gICAgaWYgKCF0aGlzLmlzVmFsaWRPYm5peklkKHRoaXMuaWQpKSB7XG4gICAgICBpZiAodGhpcy5pc05vZGUpIHtcbiAgICAgICAgdGhpcy5lcnJvcignaW52YWxpZCBvYm5peiBpZCcpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IGZpbGxlZCA9IF9SZWFkQ29va2llKCdvYm5pei1sYXN0LXVzZWQnKSB8fCAnJztcbiAgICAgICAgdGhpcy5wcm9tcHQoXG4gICAgICAgICAgZmlsbGVkLFxuICAgICAgICAgIGZ1bmN0aW9uKG9ibml6aWQpIHtcbiAgICAgICAgICAgIHRoaXMuaWQgPSBvYm5pemlkO1xuICAgICAgICAgICAgdGhpcy53c2Nvbm5lY3QoZGVzaXJlZF9zZXJ2ZXIpO1xuICAgICAgICAgIH0uYmluZCh0aGlzKVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBzdXBlci53c2Nvbm5lY3QoZGVzaXJlZF9zZXJ2ZXIpO1xuICB9XG5cbiAgc2hvd0FsZXJ0VUkob2JqKSB7XG4gICAgaWYgKHRoaXMuaXNOb2RlIHx8ICFkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLm9wdGlvbnMuZGVidWdfZG9tX2lkKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgZG9tID0gYFxuICAgIDxkaXYgc3R5bGU9XCJiYWNrZ3JvdW5kLWNvbG9yOiR7XG4gICAgICBvYmouYWxlcnQgPT09ICd3YXJuaW5nJyA/ICcjZmZlZTM1JyA6ICcjZmY3YjM0J1xuICAgIH1cIj4ke29iai5tZXNzYWdlfTwvZGl2PmA7XG4gICAgZG9jdW1lbnRcbiAgICAgIC5nZXRFbGVtZW50QnlJZCh0aGlzLm9wdGlvbnMuZGVidWdfZG9tX2lkKVxuICAgICAgLmluc2VydEFkamFjZW50SFRNTCgnYmVmb3JlZW5kJywgZG9tKTtcbiAgfVxuXG4gIGdldERlYnVnRG9tcygpIHtcbiAgICBpZiAodGhpcy5pc05vZGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IGxvYWRlckRvbSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNsb2FkZXInKTtcbiAgICBsZXQgZGVidWdEb20gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjJyArIHRoaXMub3B0aW9ucy5kZWJ1Z19kb21faWQpO1xuICAgIGxldCBzdGF0dXNEb20gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFxuICAgICAgJyMnICsgdGhpcy5vcHRpb25zLmRlYnVnX2RvbV9pZCArICcgI29ubGluZS1zdGF0dXMnXG4gICAgKTtcbiAgICBpZiAoZGVidWdEb20gJiYgIXN0YXR1c0RvbSkge1xuICAgICAgc3RhdHVzRG9tID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICBzdGF0dXNEb20uaWQgPSAnb25saW5lLXN0YXR1cyc7XG4gICAgICBzdGF0dXNEb20uc3R5bGUuY29sb3IgPSAnI0ZGRic7XG4gICAgICBzdGF0dXNEb20uc3R5bGUucGFkZGluZyA9ICc1cHgnO1xuICAgICAgc3RhdHVzRG9tLnN0eWxlLnRleHRBbGlnbiA9ICdjZW50ZXInO1xuICAgICAgZGVidWdEb20uaW5zZXJ0QmVmb3JlKHN0YXR1c0RvbSwgZGVidWdEb20uZmlyc3RDaGlsZCk7XG4gICAgfVxuICAgIHJldHVybiB7IGxvYWRlckRvbTogbG9hZGVyRG9tLCBkZWJ1Z0RvbTogZGVidWdEb20sIHN0YXR1c0RvbTogc3RhdHVzRG9tIH07XG4gIH1cblxuICAvKiBvbmxpbmUgb2ZmbGluZSAqL1xuXG4gIF9jYWxsT25Db25uZWN0KCkge1xuICAgIHRoaXMudXBkYXRlT25saW5lVUkoKTtcbiAgICBzdXBlci5fY2FsbE9uQ29ubmVjdCgpO1xuICB9XG5cbiAgY2xvc2UoKSB7XG4gICAgc3VwZXIuY2xvc2UoKTtcbiAgICB0aGlzLnVwZGF0ZU9ubGluZVVJKCk7XG4gIH1cblxuICBfZGlzY29ubmVjdExvY2FsKCkge1xuICAgIHN1cGVyLl9kaXNjb25uZWN0TG9jYWwoKTtcbiAgICB0aGlzLnVwZGF0ZU9ubGluZVVJKCk7XG4gIH1cblxuICB1cGRhdGVPbmxpbmVVSSgpIHtcbiAgICBpZiAodGhpcy5pc05vZGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBpc0Nvbm5lY3RlZCA9IHRoaXMuc29ja2V0ICYmIHRoaXMuc29ja2V0LnJlYWR5U3RhdGUgPT09IDE7XG4gICAgY29uc3QgaXNDb25uZWN0ZWRMb2NhbGx5ID1cbiAgICAgIHRoaXMuc29ja2V0X2xvY2FsICYmIHRoaXMuc29ja2V0X2xvY2FsLnJlYWR5U3RhdGUgPT09IDE7XG4gICAgaWYgKGlzQ29ubmVjdGVkICYmIGlzQ29ubmVjdGVkTG9jYWxseSkge1xuICAgICAgdGhpcy5zaG93T25MaW5lKHRydWUpO1xuICAgIH0gZWxzZSBpZiAoaXNDb25uZWN0ZWQpIHtcbiAgICAgIHRoaXMuc2hvd09uTGluZShmYWxzZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2hvd09mZkxpbmUoKTtcbiAgICB9XG4gIH1cblxuICBzaG93T25MaW5lKGlzQ29ubmVjdGVkTG9jYWxseSkge1xuICAgIGlmICh0aGlzLmlzTm9kZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBkb21zID0gdGhpcy5nZXREZWJ1Z0RvbXMoKTtcbiAgICBpZiAoZG9tcy5sb2FkZXJEb20pIHtcbiAgICAgIGRvbXMubG9hZGVyRG9tLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgfVxuICAgIGlmIChkb21zLnN0YXR1c0RvbSkge1xuICAgICAgZG9tcy5zdGF0dXNEb20uc3R5bGUuYmFja2dyb3VuZENvbG9yID0gaXNDb25uZWN0ZWRMb2NhbGx5XG4gICAgICAgID8gJyMwY2QzNjInXG4gICAgICAgIDogJyMzMTk2NWQnO1xuICAgICAgZG9tcy5zdGF0dXNEb20uc3R5bGUuY29sb3IgPSAnI0ZGRic7XG4gICAgICBkb21zLnN0YXR1c0RvbS5pbm5lckhUTUwgPVxuICAgICAgICAodGhpcy5pZCA/ICdvbmxpbmUgOiAnICsgdGhpcy5pZCA6ICdvbmxpbmUnKSArXG4gICAgICAgIChpc0Nvbm5lY3RlZExvY2FsbHkgPyAnIHZpYSBsb2NhbF9jb25uZWN0JyA6ICcgdmlhIGludGVybmV0Jyk7XG4gICAgfVxuICB9XG5cbiAgc2hvd09mZkxpbmUoKSB7XG4gICAgaWYgKHRoaXMuaXNOb2RlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZG9tcyA9IHRoaXMuZ2V0RGVidWdEb21zKCk7XG4gICAgaWYgKGRvbXMubG9hZGVyRG9tKSB7XG4gICAgICBkb21zLmxvYWRlckRvbS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICB9XG4gICAgaWYgKGRvbXMuc3RhdHVzRG9tKSB7XG4gICAgICBkb21zLnN0YXR1c0RvbS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAnI2Q5NTM0Zic7XG4gICAgICBkb21zLnN0YXR1c0RvbS5zdHlsZS5jb2xvciA9ICcjRkZGJztcbiAgICAgIGRvbXMuc3RhdHVzRG9tLmlubmVySFRNTCA9IHRoaXMuaWQgPyAnb2ZmbGluZSA6ICcgKyB0aGlzLmlkIDogJ29mZmxpbmUnO1xuICAgIH1cbiAgfVxufTtcblxuZnVuY3Rpb24gX1JlYWRDb29raWUobmFtZSkge1xuICBsZXQgbmFtZUVRID0gbmFtZSArICc9JztcbiAgbGV0IGNhID0gZG9jdW1lbnQuY29va2llLnNwbGl0KCc7Jyk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgY2EubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgYyA9IGNhW2ldO1xuICAgIHdoaWxlIChjLmNoYXJBdCgwKSA9PT0gJyAnKSB7XG4gICAgICBjID0gYy5zdWJzdHJpbmcoMSwgYy5sZW5ndGgpO1xuICAgIH1cbiAgICBpZiAoYy5pbmRleE9mKG5hbWVFUSkgPT09IDApIHtcbiAgICAgIHJldHVybiBjLnN1YnN0cmluZyhuYW1lRVEubGVuZ3RoLCBjLmxlbmd0aCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBudWxsO1xufVxuIl19

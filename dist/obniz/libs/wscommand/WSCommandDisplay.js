"use strict";
const WSCommand = require('./WSCommand.js').default;
const qrcode = require('../utils/qr');
class WSCommandDisplay extends WSCommand {
    constructor() {
        super();
        this.module = 8;
        this._CommandClear = 0;
        this._CommandPrint = 1;
        this._CommandDrawCampusVerticalBytes = 2;
        this._CommandDrawCampusHorizonalBytes = 3;
        this._CommandDrawIOState = 4;
        this._CommandSetPinName = 5;
    }
    // Commands
    clear(params) {
        this.sendCommand(this._CommandClear, null);
    }
    print(buf) {
        this.sendCommand(this._CommandPrint, buf);
    }
    printText(text) {
        let result;
        const buf = Buffer.from(text, 'utf8');
        result = new Uint8Array(buf);
        this.print(result);
    }
    text(params) {
        this.printText(params.text);
    }
    raw(params) {
        this.drawHorizonally(new Uint8Array(params.raw));
    }
    qr(params) {
        const text = params.qr.text;
        const correctionLevel = params.qr.correction || 'M';
        const typeNumber = 0; // auto detect type.
        const qr = qrcode(typeNumber, correctionLevel);
        qr.addData(text);
        qr.make();
        let size = qr.getModuleCount();
        if (size) {
            size *= 2;
            const modules = qr.getModules();
            let vram = new Uint8Array(1024);
            vram.fill(0);
            for (let row = 0; row < 2; row++) {
                for (let col = 0; col < size + 4; col++) {
                    vram[parseInt(row * 16 + col / 8)] |= 0x80 >> col % 8;
                    vram[parseInt((row + size + 2) * 16 + col / 8)] |= 0x80 >> col % 8;
                }
            }
            for (let row = 2; row < size + 2; row++) {
                for (let col = 0; col < 2; col++) {
                    vram[parseInt(row * 16 + col / 8)] |= 0x80 >> col % 8;
                }
                for (let col = size + 2; col < size + 4; col++) {
                    vram[parseInt(row * 16 + col / 8)] |= 0x80 >> col % 8;
                }
            }
            for (let row = 0; row < size; row++) {
                for (let col = 0; col < size; col++) {
                    if (!modules[parseInt(row / 2)][parseInt(col / 2)]) {
                        vram[parseInt((row + 2) * 16 + (col + 2) / 8)] |=
                            0x80 >> (col + 2) % 8;
                    }
                }
            }
            this.drawHorizonally(vram);
        }
    }
    pinName(params) {
        for (let i = 0; i < 40; i++) {
            if (typeof params.pin_assign[i] === 'object') {
                this.setPinName(i, params.pin_assign[i].module_name || '?', params.pin_assign[i].pin_name || '?');
            }
        }
    }
    drawVertically(buf) {
        this.sendCommand(this._CommandDrawCampusVerticalBytes, buf);
    }
    drawHorizonally(buf) {
        this.sendCommand(this._CommandDrawCampusHorizonalBytes, buf);
    }
    drawIOState(val) {
        let buf = new Uint8Array([!val]);
        this.sendCommand(this._CommandDrawIOState, buf);
    }
    setPinName(no, moduleName, pinName) {
        let str = moduleName.slice(0, 4) + ' ' + pinName;
        str = str.slice(0, 9);
        let buf = new Uint8Array(1);
        buf[0] = no;
        let stringarray = new Uint8Array(Buffer(str, 'utf8'));
        let combined = new Uint8Array(buf.length + stringarray.length);
        combined.set(buf, 0);
        combined.set(stringarray, 1);
        this.sendCommand(this._CommandSetPinName, combined);
    }
    parseFromJson(json) {
        let module = json.display;
        if (module === undefined) {
            return;
        }
        let schemaData = [
            { uri: '/request/display/clear', onValid: this.clear },
            { uri: '/request/display/text', onValid: this.text },
            { uri: '/request/display/raw', onValid: this.raw },
            { uri: '/request/display/pin_assign', onValid: this.pinName },
            { uri: '/request/display/qr', onValid: this.qr },
        ];
        let res = this.validateCommandSchema(schemaData, module, 'display');
        if (res.valid === 0) {
            if (res.invalidButLike.length > 0) {
                throw new Error(res.invalidButLike[0].message);
            }
            else {
                throw new this.WSCommandNotFoundError(`[display]unknown command`);
            }
        }
    }
}
module.exports = WSCommandDisplay;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmREaXNwbGF5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFDcEQsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBRXRDLE1BQU0sZ0JBQWlCLFNBQVEsU0FBUztJQUN0QztRQUNFLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFFaEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUM7UUFDdkIsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUM7UUFDdkIsSUFBSSxDQUFDLCtCQUErQixHQUFHLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsZ0NBQWdDLEdBQUcsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxDQUFDLENBQUM7UUFDN0IsSUFBSSxDQUFDLGtCQUFrQixHQUFHLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRUQsV0FBVztJQUVYLEtBQUssQ0FBQyxNQUFNO1FBQ1YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxLQUFLLENBQUMsR0FBRztRQUNQLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQsU0FBUyxDQUFDLElBQUk7UUFDWixJQUFJLE1BQU0sQ0FBQztRQUNYLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sR0FBRyxJQUFJLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3JCLENBQUM7SUFFRCxJQUFJLENBQUMsTUFBTTtRQUNULElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxHQUFHLENBQUMsTUFBTTtRQUNSLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxVQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVELEVBQUUsQ0FBQyxNQUFNO1FBQ1AsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUM7UUFDNUIsTUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLEVBQUUsQ0FBQyxVQUFVLElBQUksR0FBRyxDQUFDO1FBRXBELE1BQU0sVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDLG9CQUFvQjtRQUMxQyxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsVUFBVSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQy9DLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakIsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1YsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQy9CLElBQUksSUFBSSxFQUFFO1lBQ1IsSUFBSSxJQUFJLENBQUMsQ0FBQztZQUNWLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNoQyxJQUFJLElBQUksR0FBRyxJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNoQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRWIsS0FBSyxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRTtnQkFDaEMsS0FBSyxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUUsR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUU7b0JBQ3ZDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxHQUFHLEVBQUUsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztvQkFDdEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO2lCQUNwRTthQUNGO1lBQ0QsS0FBSyxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUUsR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUU7Z0JBQ3ZDLEtBQUssSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUU7b0JBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxHQUFHLEVBQUUsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztpQkFDdkQ7Z0JBQ0QsS0FBSyxJQUFJLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxFQUFFO29CQUM5QyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsR0FBRyxFQUFFLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7aUJBQ3ZEO2FBQ0Y7WUFFRCxLQUFLLElBQUksR0FBRyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsSUFBSSxFQUFFLEdBQUcsRUFBRSxFQUFFO2dCQUNuQyxLQUFLLElBQUksR0FBRyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsSUFBSSxFQUFFLEdBQUcsRUFBRSxFQUFFO29CQUNuQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUU7d0JBQ2xELElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDOzRCQUM1QyxJQUFJLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO3FCQUN6QjtpQkFDRjthQUNGO1lBQ0QsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM1QjtJQUNILENBQUM7SUFFRCxPQUFPLENBQUMsTUFBTTtRQUNaLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDM0IsSUFBSSxPQUFPLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEtBQUssUUFBUSxFQUFFO2dCQUM1QyxJQUFJLENBQUMsVUFBVSxDQUNiLENBQUMsRUFDRCxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsSUFBSSxHQUFHLEVBQ3ZDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FDckMsQ0FBQzthQUNIO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsY0FBYyxDQUFDLEdBQUc7UUFDaEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsK0JBQStCLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUVELGVBQWUsQ0FBQyxHQUFHO1FBQ2pCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGdDQUFnQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFFRCxXQUFXLENBQUMsR0FBRztRQUNiLElBQUksR0FBRyxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRCxVQUFVLENBQUMsRUFBRSxFQUFFLFVBQVUsRUFBRSxPQUFPO1FBQ2hDLElBQUksR0FBRyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxPQUFPLENBQUM7UUFDakQsR0FBRyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRXRCLElBQUksR0FBRyxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzVCLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFWixJQUFJLFdBQVcsR0FBRyxJQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDdEQsSUFBSSxRQUFRLEdBQUcsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDL0QsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckIsUUFBUSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFN0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVELGFBQWEsQ0FBQyxJQUFJO1FBQ2hCLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDMUIsSUFBSSxNQUFNLEtBQUssU0FBUyxFQUFFO1lBQ3hCLE9BQU87U0FDUjtRQUVELElBQUksVUFBVSxHQUFHO1lBQ2YsRUFBRSxHQUFHLEVBQUUsd0JBQXdCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDdEQsRUFBRSxHQUFHLEVBQUUsdUJBQXVCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDcEQsRUFBRSxHQUFHLEVBQUUsc0JBQXNCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDbEQsRUFBRSxHQUFHLEVBQUUsNkJBQTZCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDN0QsRUFBRSxHQUFHLEVBQUUscUJBQXFCLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDakQsQ0FBQztRQUNGLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRXBFLElBQUksR0FBRyxDQUFDLEtBQUssS0FBSyxDQUFDLEVBQUU7WUFDbkIsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ2pDLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUNoRDtpQkFBTTtnQkFDTCxNQUFNLElBQUksSUFBSSxDQUFDLHNCQUFzQixDQUFDLDBCQUEwQixDQUFDLENBQUM7YUFDbkU7U0FDRjtJQUNILENBQUM7Q0FDRjtBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsZ0JBQWdCLENBQUMiLCJmaWxlIjoib2JuaXovbGlicy93c2NvbW1hbmQvV1NDb21tYW5kRGlzcGxheS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFdTQ29tbWFuZCA9IHJlcXVpcmUoJy4vV1NDb21tYW5kLmpzJykuZGVmYXVsdDtcbmNvbnN0IHFyY29kZSA9IHJlcXVpcmUoJy4uL3V0aWxzL3FyJyk7XG5cbmNsYXNzIFdTQ29tbWFuZERpc3BsYXkgZXh0ZW5kcyBXU0NvbW1hbmQge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMubW9kdWxlID0gODtcblxuICAgIHRoaXMuX0NvbW1hbmRDbGVhciA9IDA7XG4gICAgdGhpcy5fQ29tbWFuZFByaW50ID0gMTtcbiAgICB0aGlzLl9Db21tYW5kRHJhd0NhbXB1c1ZlcnRpY2FsQnl0ZXMgPSAyO1xuICAgIHRoaXMuX0NvbW1hbmREcmF3Q2FtcHVzSG9yaXpvbmFsQnl0ZXMgPSAzO1xuICAgIHRoaXMuX0NvbW1hbmREcmF3SU9TdGF0ZSA9IDQ7XG4gICAgdGhpcy5fQ29tbWFuZFNldFBpbk5hbWUgPSA1O1xuICB9XG5cbiAgLy8gQ29tbWFuZHNcblxuICBjbGVhcihwYXJhbXMpIHtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRDbGVhciwgbnVsbCk7XG4gIH1cblxuICBwcmludChidWYpIHtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRQcmludCwgYnVmKTtcbiAgfVxuXG4gIHByaW50VGV4dCh0ZXh0KSB7XG4gICAgbGV0IHJlc3VsdDtcbiAgICBjb25zdCBidWYgPSBCdWZmZXIuZnJvbSh0ZXh0LCAndXRmOCcpO1xuICAgIHJlc3VsdCA9IG5ldyBVaW50OEFycmF5KGJ1Zik7XG4gICAgdGhpcy5wcmludChyZXN1bHQpO1xuICB9XG5cbiAgdGV4dChwYXJhbXMpIHtcbiAgICB0aGlzLnByaW50VGV4dChwYXJhbXMudGV4dCk7XG4gIH1cblxuICByYXcocGFyYW1zKSB7XG4gICAgdGhpcy5kcmF3SG9yaXpvbmFsbHkobmV3IFVpbnQ4QXJyYXkocGFyYW1zLnJhdykpO1xuICB9XG5cbiAgcXIocGFyYW1zKSB7XG4gICAgY29uc3QgdGV4dCA9IHBhcmFtcy5xci50ZXh0O1xuICAgIGNvbnN0IGNvcnJlY3Rpb25MZXZlbCA9IHBhcmFtcy5xci5jb3JyZWN0aW9uIHx8ICdNJztcblxuICAgIGNvbnN0IHR5cGVOdW1iZXIgPSAwOyAvLyBhdXRvIGRldGVjdCB0eXBlLlxuICAgIGNvbnN0IHFyID0gcXJjb2RlKHR5cGVOdW1iZXIsIGNvcnJlY3Rpb25MZXZlbCk7XG4gICAgcXIuYWRkRGF0YSh0ZXh0KTtcbiAgICBxci5tYWtlKCk7XG4gICAgbGV0IHNpemUgPSBxci5nZXRNb2R1bGVDb3VudCgpO1xuICAgIGlmIChzaXplKSB7XG4gICAgICBzaXplICo9IDI7XG4gICAgICBjb25zdCBtb2R1bGVzID0gcXIuZ2V0TW9kdWxlcygpO1xuICAgICAgbGV0IHZyYW0gPSBuZXcgVWludDhBcnJheSgxMDI0KTtcbiAgICAgIHZyYW0uZmlsbCgwKTtcblxuICAgICAgZm9yIChsZXQgcm93ID0gMDsgcm93IDwgMjsgcm93KyspIHtcbiAgICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgc2l6ZSArIDQ7IGNvbCsrKSB7XG4gICAgICAgICAgdnJhbVtwYXJzZUludChyb3cgKiAxNiArIGNvbCAvIDgpXSB8PSAweDgwID4+IGNvbCAlIDg7XG4gICAgICAgICAgdnJhbVtwYXJzZUludCgocm93ICsgc2l6ZSArIDIpICogMTYgKyBjb2wgLyA4KV0gfD0gMHg4MCA+PiBjb2wgJSA4O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBmb3IgKGxldCByb3cgPSAyOyByb3cgPCBzaXplICsgMjsgcm93KyspIHtcbiAgICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgMjsgY29sKyspIHtcbiAgICAgICAgICB2cmFtW3BhcnNlSW50KHJvdyAqIDE2ICsgY29sIC8gOCldIHw9IDB4ODAgPj4gY29sICUgODtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGxldCBjb2wgPSBzaXplICsgMjsgY29sIDwgc2l6ZSArIDQ7IGNvbCsrKSB7XG4gICAgICAgICAgdnJhbVtwYXJzZUludChyb3cgKiAxNiArIGNvbCAvIDgpXSB8PSAweDgwID4+IGNvbCAlIDg7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgZm9yIChsZXQgcm93ID0gMDsgcm93IDwgc2l6ZTsgcm93KyspIHtcbiAgICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgc2l6ZTsgY29sKyspIHtcbiAgICAgICAgICBpZiAoIW1vZHVsZXNbcGFyc2VJbnQocm93IC8gMildW3BhcnNlSW50KGNvbCAvIDIpXSkge1xuICAgICAgICAgICAgdnJhbVtwYXJzZUludCgocm93ICsgMikgKiAxNiArIChjb2wgKyAyKSAvIDgpXSB8PVxuICAgICAgICAgICAgICAweDgwID4+IChjb2wgKyAyKSAlIDg7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLmRyYXdIb3Jpem9uYWxseSh2cmFtKTtcbiAgICB9XG4gIH1cblxuICBwaW5OYW1lKHBhcmFtcykge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDA7IGkrKykge1xuICAgICAgaWYgKHR5cGVvZiBwYXJhbXMucGluX2Fzc2lnbltpXSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgdGhpcy5zZXRQaW5OYW1lKFxuICAgICAgICAgIGksXG4gICAgICAgICAgcGFyYW1zLnBpbl9hc3NpZ25baV0ubW9kdWxlX25hbWUgfHwgJz8nLFxuICAgICAgICAgIHBhcmFtcy5waW5fYXNzaWduW2ldLnBpbl9uYW1lIHx8ICc/J1xuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGRyYXdWZXJ0aWNhbGx5KGJ1Zikge1xuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZERyYXdDYW1wdXNWZXJ0aWNhbEJ5dGVzLCBidWYpO1xuICB9XG5cbiAgZHJhd0hvcml6b25hbGx5KGJ1Zikge1xuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZERyYXdDYW1wdXNIb3Jpem9uYWxCeXRlcywgYnVmKTtcbiAgfVxuXG4gIGRyYXdJT1N0YXRlKHZhbCkge1xuICAgIGxldCBidWYgPSBuZXcgVWludDhBcnJheShbIXZhbF0pO1xuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZERyYXdJT1N0YXRlLCBidWYpO1xuICB9XG5cbiAgc2V0UGluTmFtZShubywgbW9kdWxlTmFtZSwgcGluTmFtZSkge1xuICAgIGxldCBzdHIgPSBtb2R1bGVOYW1lLnNsaWNlKDAsIDQpICsgJyAnICsgcGluTmFtZTtcbiAgICBzdHIgPSBzdHIuc2xpY2UoMCwgOSk7XG5cbiAgICBsZXQgYnVmID0gbmV3IFVpbnQ4QXJyYXkoMSk7XG4gICAgYnVmWzBdID0gbm87XG5cbiAgICBsZXQgc3RyaW5nYXJyYXkgPSBuZXcgVWludDhBcnJheShCdWZmZXIoc3RyLCAndXRmOCcpKTtcbiAgICBsZXQgY29tYmluZWQgPSBuZXcgVWludDhBcnJheShidWYubGVuZ3RoICsgc3RyaW5nYXJyYXkubGVuZ3RoKTtcbiAgICBjb21iaW5lZC5zZXQoYnVmLCAwKTtcbiAgICBjb21iaW5lZC5zZXQoc3RyaW5nYXJyYXksIDEpO1xuXG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kU2V0UGluTmFtZSwgY29tYmluZWQpO1xuICB9XG5cbiAgcGFyc2VGcm9tSnNvbihqc29uKSB7XG4gICAgbGV0IG1vZHVsZSA9IGpzb24uZGlzcGxheTtcbiAgICBpZiAobW9kdWxlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgc2NoZW1hRGF0YSA9IFtcbiAgICAgIHsgdXJpOiAnL3JlcXVlc3QvZGlzcGxheS9jbGVhcicsIG9uVmFsaWQ6IHRoaXMuY2xlYXIgfSxcbiAgICAgIHsgdXJpOiAnL3JlcXVlc3QvZGlzcGxheS90ZXh0Jywgb25WYWxpZDogdGhpcy50ZXh0IH0sXG4gICAgICB7IHVyaTogJy9yZXF1ZXN0L2Rpc3BsYXkvcmF3Jywgb25WYWxpZDogdGhpcy5yYXcgfSxcbiAgICAgIHsgdXJpOiAnL3JlcXVlc3QvZGlzcGxheS9waW5fYXNzaWduJywgb25WYWxpZDogdGhpcy5waW5OYW1lIH0sXG4gICAgICB7IHVyaTogJy9yZXF1ZXN0L2Rpc3BsYXkvcXInLCBvblZhbGlkOiB0aGlzLnFyIH0sXG4gICAgXTtcbiAgICBsZXQgcmVzID0gdGhpcy52YWxpZGF0ZUNvbW1hbmRTY2hlbWEoc2NoZW1hRGF0YSwgbW9kdWxlLCAnZGlzcGxheScpO1xuXG4gICAgaWYgKHJlcy52YWxpZCA9PT0gMCkge1xuICAgICAgaWYgKHJlcy5pbnZhbGlkQnV0TGlrZS5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihyZXMuaW52YWxpZEJ1dExpa2VbMF0ubWVzc2FnZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgdGhpcy5XU0NvbW1hbmROb3RGb3VuZEVycm9yKGBbZGlzcGxheV11bmtub3duIGNvbW1hbmRgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBXU0NvbW1hbmREaXNwbGF5O1xuIl19

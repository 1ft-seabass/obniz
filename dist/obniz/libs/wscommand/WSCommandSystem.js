"use strict";
const WSCommand = require('./WSCommand.js').default;
class WSCommandSystem extends WSCommand {
    constructor() {
        super();
        this.module = 0;
        this._CommandReboot = 0;
        this._CommandReset = 2;
        this._CommandSelfCheck = 3;
        this._CommandWait = 4;
        this._CommandResetOnDisconnect = 5;
        this._CommandPingPong = 8;
        this._CommandVCC = 9;
        this._CommandSleepSeconds = 10;
        this._CommandSleepMinute = 11;
        this._CommandSleepIoTrigger = 12;
    }
    // Commands
    reboot(params) {
        this.sendCommand(this._CommandReboot, null);
    }
    reset(params) {
        this.sendCommand(this._CommandReset, null);
    }
    selfCheck(params) {
        this.sendCommand(this._CommandSelfCheck, null);
    }
    wait(params) {
        let msec = params.wait;
        let buf = new Uint8Array([msec >> 8, msec]);
        this.sendCommand(this._CommandWait, buf);
    }
    keepWorkingAtOffline(params) {
        this.resetOnDisconnect(!params.keep_working_at_offline);
    }
    ping(params) {
        let unixtime = new Date().getTime();
        let buf = new Uint8Array(params.ping.key.length + 8);
        let upper = Math.floor(unixtime / Math.pow(2, 32));
        let lower = unixtime - upper * Math.pow(2, 32);
        buf[0] = upper >> (8 * 3);
        buf[1] = upper >> (8 * 2);
        buf[2] = upper >> (8 * 1);
        buf[3] = upper >> (8 * 0);
        buf[4] = lower >> (8 * 3);
        buf[5] = lower >> (8 * 2);
        buf[6] = lower >> (8 * 1);
        buf[7] = lower >> (8 * 0);
        for (let i = 0; i < params.ping.key.length; i++) {
            buf[8 + i] = params.ping.key[i];
        }
        this.sendCommand(this._CommandPingPong, buf);
    }
    resetOnDisconnect(mustReset) {
        let buf = new Uint8Array([mustReset ? 1 : 0]);
        this.sendCommand(this._CommandResetOnDisconnect, buf);
    }
    parseFromJson(json) {
        let module = json.system;
        if (module === undefined) {
            return;
        }
        let schemaData = [
            { uri: '/request/system/reboot', onValid: this.reboot },
            { uri: '/request/system/reset', onValid: this.reset },
            { uri: '/request/system/wait', onValid: this.wait },
            { uri: '/request/system/selfCheck', onValid: this.selfCheck },
            {
                uri: '/request/system/keepWorkingAtOffline',
                onValid: this.keepWorkingAtOffline,
            },
            { uri: '/request/system/ping', onValid: this.ping },
            { uri: '/request/system/sleepSeconds', onValid: this.sleepSeconds },
            { uri: '/request/system/sleepMinute', onValid: this.sleepMinute },
            { uri: '/request/system/sleepIoTrigger', onValid: this.sleepIoTrigger },
        ];
        let res = this.validateCommandSchema(schemaData, module, 'system');
        if (res.valid === 0) {
            if (res.invalidButLike.length > 0) {
                throw new Error(res.invalidButLike[0].message);
            }
            else {
                throw new this.WSCommandNotFoundError(`[system]unknown command`);
            }
        }
    }
    pong(objToSend, payload) {
        objToSend.system = objToSend.system || {};
        const pongServerTime = new Date().getTime();
        if (payload.length >= 16) {
            payload = Buffer.from(payload);
            let obnizTime = payload.readUIntBE(0, 4) * Math.pow(2, 32) + payload.readUIntBE(4, 4);
            let pingServerTime = payload.readUIntBE(8, 4) * Math.pow(2, 32) + payload.readUIntBE(12, 4);
            let key = [];
            for (let i = 16; i < payload.length; i++) {
                key.push(payload[i]);
            }
            objToSend.system.pong = {
                key,
                obnizTime,
                pingServerTime,
                pongServerTime,
            };
        }
        else {
            objToSend.system.pong = {
                pongServerTime,
            };
        }
    }
    notifyFromBinary(objToSend, func, payload) {
        switch (func) {
            case this._CommandVCC:
                if (payload.byteLength === 3) {
                    let value = (payload[1] << 8) + payload[2];
                    value = value / 100.0;
                    this.envelopWarning(objToSend, 'debug', {
                        message: `Low Voltage ${value}v. connect obniz to more powerful USB.`,
                    });
                }
                break;
            case this._CommandPingPong:
                this.pong(objToSend, payload);
                break;
            default:
                super.notifyFromBinary(objToSend, func, payload);
                break;
        }
    }
    sleepSeconds(params) {
        let sec = params.sleep_seconds;
        let buf = new Uint8Array([sec >> 8, sec]);
        this.sendCommand(this._CommandSleepSeconds, buf);
    }
    sleepMinute(params) {
        let minute = params.sleep_minute;
        let buf = new Uint8Array([minute >> 8, minute]);
        this.sendCommand(this._CommandSleepMinute, buf);
    }
    sleepIoTrigger(params) {
        let trigger = params.sleep_io_trigger;
        if (trigger === true) {
            trigger = 1;
        }
        else {
            trigger = 0;
        }
        let buf = new Uint8Array([trigger]);
        this.sendCommand(this._CommandSleepIoTrigger, buf);
    }
}
module.exports = WSCommandSystem;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmRTeXN0ZW0uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUVwRCxNQUFNLGVBQWdCLFNBQVEsU0FBUztJQUNyQztRQUNFLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFFaEIsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUM7UUFFeEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUM7UUFDdkIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLENBQUMsQ0FBQztRQUMzQixJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMseUJBQXlCLEdBQUcsQ0FBQyxDQUFDO1FBRW5DLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7UUFDMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsbUJBQW1CLEdBQUcsRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxFQUFFLENBQUM7SUFDbkMsQ0FBQztJQUVELFdBQVc7SUFFWCxNQUFNLENBQUMsTUFBTTtRQUNYLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQU07UUFDVixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVELFNBQVMsQ0FBQyxNQUFNO1FBQ2QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLENBQUM7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LFVBQVUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQsY0FBYyxDQUFDLE1BQU07UUFDbkIsSUFBSSxPQUFPLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1FBQ3RDLElBQUksT0FBTyxLQUFLLElBQUksRUFBRTtZQUNwQixPQUFPLEdBQUcsQ0FBQyxDQUFDO1NBQ2I7YUFBTTtZQUNMLE9BQU8sR0FBRyxDQUFDLENBQUM7U0FDYjtRQUNELElBQUksR0FBRyxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNyRCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLGVBQWUsQ0FBQyIsImZpbGUiOiJvYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmRTeXN0ZW0uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBXU0NvbW1hbmQgPSByZXF1aXJlKCcuL1dTQ29tbWFuZC5qcycpLmRlZmF1bHQ7XG5cbmNsYXNzIFdTQ29tbWFuZFN5c3RlbSBleHRlbmRzIFdTQ29tbWFuZCB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5tb2R1bGUgPSAwO1xuXG4gICAgdGhpcy5fQ29tbWFuZFJlYm9vdCA9IDA7XG5cbiAgICB0aGlzLl9Db21tYW5kUmVzZXQgPSAyO1xuICAgIHRoaXMuX0NvbW1hbmRTZWxmQ2hlY2sgPSAzO1xuICAgIHRoaXMuX0NvbW1hbmRXYWl0ID0gNDtcbiAgICB0aGlzLl9Db21tYW5kUmVzZXRPbkRpc2Nvbm5lY3QgPSA1O1xuXG4gICAgdGhpcy5fQ29tbWFuZFBpbmdQb25nID0gODtcbiAgICB0aGlzLl9Db21tYW5kVkNDID0gOTtcbiAgICB0aGlzLl9Db21tYW5kU2xlZXBTZWNvbmRzID0gMTA7XG4gICAgdGhpcy5fQ29tbWFuZFNsZWVwTWludXRlID0gMTE7XG4gICAgdGhpcy5fQ29tbWFuZFNsZWVwSW9UcmlnZ2VyID0gMTI7XG4gIH1cblxuICAvLyBDb21tYW5kc1xuXG4gIHJlYm9vdChwYXJhbXMpIHtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRSZWJvb3QsIG51bGwpO1xuICB9XG5cbiAgcmVzZXQocGFyYW1zKSB7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kUmVzZXQsIG51bGwpO1xuICB9XG5cbiAgc2VsZkNoZWNrKHBhcmFtcykge1xuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZFNlbGZDaGVjaywgbnVsbCk7XG4gIH1cblxuICB3YWl0KHBhcmFtcykge1xuICAgIGxldCBtc2VjID0gcGFyYW1zLndhaXQ7XG4gICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KFttc2VjID4+IDgsIG1zZWNdKTtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRXYWl0LCBidWYpO1xuICB9XG5cbiAga2VlcFdvcmtpbmdBdE9mZmxpbmUocGFyYW1zKSB7XG4gICAgdGhpcy5yZXNldE9uRGlzY29ubmVjdCghcGFyYW1zLmtlZXBfd29ya2luZ19hdF9vZmZsaW5lKTtcbiAgfVxuXG4gIHBpbmcocGFyYW1zKSB7XG4gICAgbGV0IHVuaXh0aW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KHBhcmFtcy5waW5nLmtleS5sZW5ndGggKyA4KTtcbiAgICBsZXQgdXBwZXIgPSBNYXRoLmZsb29yKHVuaXh0aW1lIC8gTWF0aC5wb3coMiwgMzIpKTtcbiAgICBsZXQgbG93ZXIgPSB1bml4dGltZSAtIHVwcGVyICogTWF0aC5wb3coMiwgMzIpO1xuICAgIGJ1ZlswXSA9IHVwcGVyID4+ICg4ICogMyk7XG4gICAgYnVmWzFdID0gdXBwZXIgPj4gKDggKiAyKTtcbiAgICBidWZbMl0gPSB1cHBlciA+PiAoOCAqIDEpO1xuICAgIGJ1ZlszXSA9IHVwcGVyID4+ICg4ICogMCk7XG4gICAgYnVmWzRdID0gbG93ZXIgPj4gKDggKiAzKTtcbiAgICBidWZbNV0gPSBsb3dlciA+PiAoOCAqIDIpO1xuICAgIGJ1Zls2XSA9IGxvd2VyID4+ICg4ICogMSk7XG4gICAgYnVmWzddID0gbG93ZXIgPj4gKDggKiAwKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcmFtcy5waW5nLmtleS5sZW5ndGg7IGkrKykge1xuICAgICAgYnVmWzggKyBpXSA9IHBhcmFtcy5waW5nLmtleVtpXTtcbiAgICB9XG5cbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRQaW5nUG9uZywgYnVmKTtcbiAgfVxuXG4gIHJlc2V0T25EaXNjb25uZWN0KG11c3RSZXNldCkge1xuICAgIGxldCBidWYgPSBuZXcgVWludDhBcnJheShbbXVzdFJlc2V0ID8gMSA6IDBdKTtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRSZXNldE9uRGlzY29ubmVjdCwgYnVmKTtcbiAgfVxuXG4gIHBhcnNlRnJvbUpzb24oanNvbikge1xuICAgIGxldCBtb2R1bGUgPSBqc29uLnN5c3RlbTtcbiAgICBpZiAobW9kdWxlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgc2NoZW1hRGF0YSA9IFtcbiAgICAgIHsgdXJpOiAnL3JlcXVlc3Qvc3lzdGVtL3JlYm9vdCcsIG9uVmFsaWQ6IHRoaXMucmVib290IH0sXG4gICAgICB7IHVyaTogJy9yZXF1ZXN0L3N5c3RlbS9yZXNldCcsIG9uVmFsaWQ6IHRoaXMucmVzZXQgfSxcbiAgICAgIHsgdXJpOiAnL3JlcXVlc3Qvc3lzdGVtL3dhaXQnLCBvblZhbGlkOiB0aGlzLndhaXQgfSxcbiAgICAgIHsgdXJpOiAnL3JlcXVlc3Qvc3lzdGVtL3NlbGZDaGVjaycsIG9uVmFsaWQ6IHRoaXMuc2VsZkNoZWNrIH0sXG4gICAgICB7XG4gICAgICAgIHVyaTogJy9yZXF1ZXN0L3N5c3RlbS9rZWVwV29ya2luZ0F0T2ZmbGluZScsXG4gICAgICAgIG9uVmFsaWQ6IHRoaXMua2VlcFdvcmtpbmdBdE9mZmxpbmUsXG4gICAgICB9LFxuICAgICAgeyB1cmk6ICcvcmVxdWVzdC9zeXN0ZW0vcGluZycsIG9uVmFsaWQ6IHRoaXMucGluZyB9LFxuICAgICAgeyB1cmk6ICcvcmVxdWVzdC9zeXN0ZW0vc2xlZXBTZWNvbmRzJywgb25WYWxpZDogdGhpcy5zbGVlcFNlY29uZHMgfSxcbiAgICAgIHsgdXJpOiAnL3JlcXVlc3Qvc3lzdGVtL3NsZWVwTWludXRlJywgb25WYWxpZDogdGhpcy5zbGVlcE1pbnV0ZSB9LFxuICAgICAgeyB1cmk6ICcvcmVxdWVzdC9zeXN0ZW0vc2xlZXBJb1RyaWdnZXInLCBvblZhbGlkOiB0aGlzLnNsZWVwSW9UcmlnZ2VyIH0sXG4gICAgXTtcbiAgICBsZXQgcmVzID0gdGhpcy52YWxpZGF0ZUNvbW1hbmRTY2hlbWEoc2NoZW1hRGF0YSwgbW9kdWxlLCAnc3lzdGVtJyk7XG5cbiAgICBpZiAocmVzLnZhbGlkID09PSAwKSB7XG4gICAgICBpZiAocmVzLmludmFsaWRCdXRMaWtlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlcy5pbnZhbGlkQnV0TGlrZVswXS5tZXNzYWdlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyB0aGlzLldTQ29tbWFuZE5vdEZvdW5kRXJyb3IoYFtzeXN0ZW1ddW5rbm93biBjb21tYW5kYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcG9uZyhvYmpUb1NlbmQsIHBheWxvYWQpIHtcbiAgICBvYmpUb1NlbmQuc3lzdGVtID0gb2JqVG9TZW5kLnN5c3RlbSB8fCB7fTtcbiAgICBjb25zdCBwb25nU2VydmVyVGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXG4gICAgaWYgKHBheWxvYWQubGVuZ3RoID49IDE2KSB7XG4gICAgICBwYXlsb2FkID0gQnVmZmVyLmZyb20ocGF5bG9hZCk7XG4gICAgICBsZXQgb2JuaXpUaW1lID1cbiAgICAgICAgcGF5bG9hZC5yZWFkVUludEJFKDAsIDQpICogTWF0aC5wb3coMiwgMzIpICsgcGF5bG9hZC5yZWFkVUludEJFKDQsIDQpO1xuICAgICAgbGV0IHBpbmdTZXJ2ZXJUaW1lID1cbiAgICAgICAgcGF5bG9hZC5yZWFkVUludEJFKDgsIDQpICogTWF0aC5wb3coMiwgMzIpICsgcGF5bG9hZC5yZWFkVUludEJFKDEyLCA0KTtcbiAgICAgIGxldCBrZXkgPSBbXTtcbiAgICAgIGZvciAobGV0IGkgPSAxNjsgaSA8IHBheWxvYWQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAga2V5LnB1c2gocGF5bG9hZFtpXSk7XG4gICAgICB9XG4gICAgICBvYmpUb1NlbmQuc3lzdGVtLnBvbmcgPSB7XG4gICAgICAgIGtleSxcbiAgICAgICAgb2JuaXpUaW1lLFxuICAgICAgICBwaW5nU2VydmVyVGltZSxcbiAgICAgICAgcG9uZ1NlcnZlclRpbWUsXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBvYmpUb1NlbmQuc3lzdGVtLnBvbmcgPSB7XG4gICAgICAgIHBvbmdTZXJ2ZXJUaW1lLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBub3RpZnlGcm9tQmluYXJ5KG9ialRvU2VuZCwgZnVuYywgcGF5bG9hZCkge1xuICAgIHN3aXRjaCAoZnVuYykge1xuICAgICAgY2FzZSB0aGlzLl9Db21tYW5kVkNDOlxuICAgICAgICBpZiAocGF5bG9hZC5ieXRlTGVuZ3RoID09PSAzKSB7XG4gICAgICAgICAgbGV0IHZhbHVlID0gKHBheWxvYWRbMV0gPDwgOCkgKyBwYXlsb2FkWzJdO1xuICAgICAgICAgIHZhbHVlID0gdmFsdWUgLyAxMDAuMDtcbiAgICAgICAgICB0aGlzLmVudmVsb3BXYXJuaW5nKG9ialRvU2VuZCwgJ2RlYnVnJywge1xuICAgICAgICAgICAgbWVzc2FnZTogYExvdyBWb2x0YWdlICR7dmFsdWV9di4gY29ubmVjdCBvYm5peiB0byBtb3JlIHBvd2VyZnVsIFVTQi5gLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIHRoaXMuX0NvbW1hbmRQaW5nUG9uZzpcbiAgICAgICAgdGhpcy5wb25nKG9ialRvU2VuZCwgcGF5bG9hZCk7XG5cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHN1cGVyLm5vdGlmeUZyb21CaW5hcnkob2JqVG9TZW5kLCBmdW5jLCBwYXlsb2FkKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgc2xlZXBTZWNvbmRzKHBhcmFtcykge1xuICAgIGxldCBzZWMgPSBwYXJhbXMuc2xlZXBfc2Vjb25kcztcbiAgICBsZXQgYnVmID0gbmV3IFVpbnQ4QXJyYXkoW3NlYyA+PiA4LCBzZWNdKTtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRTbGVlcFNlY29uZHMsIGJ1Zik7XG4gIH1cblxuICBzbGVlcE1pbnV0ZShwYXJhbXMpIHtcbiAgICBsZXQgbWludXRlID0gcGFyYW1zLnNsZWVwX21pbnV0ZTtcbiAgICBsZXQgYnVmID0gbmV3IFVpbnQ4QXJyYXkoW21pbnV0ZSA+PiA4LCBtaW51dGVdKTtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRTbGVlcE1pbnV0ZSwgYnVmKTtcbiAgfVxuXG4gIHNsZWVwSW9UcmlnZ2VyKHBhcmFtcykge1xuICAgIGxldCB0cmlnZ2VyID0gcGFyYW1zLnNsZWVwX2lvX3RyaWdnZXI7XG4gICAgaWYgKHRyaWdnZXIgPT09IHRydWUpIHtcbiAgICAgIHRyaWdnZXIgPSAxO1xuICAgIH0gZWxzZSB7XG4gICAgICB0cmlnZ2VyID0gMDtcbiAgICB9XG4gICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KFt0cmlnZ2VyXSk7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kU2xlZXBJb1RyaWdnZXIsIGJ1Zik7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBXU0NvbW1hbmRTeXN0ZW07XG4iXX0=

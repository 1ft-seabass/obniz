"use strict";
class JsonBinaryConverter {
    static convertFromBinaryToJson(schema, binary) {
        let types = {
            hex: this.hexFromBinary.bind(this),
            uuid: this.uuidFromBinary.bind(this),
            number: this.numberFromBinary.bind(this),
            'signed number': this.signedNumberFromBinary.bind(this),
            int: this.numberFromBinary.bind(this),
            char: this.numberFromBinary.bind(this),
            enum: this.enumFromBinary.bind(this),
            dataArray: this.dataArrayFromBinary.bind(this),
        };
        let json = {};
        let count = 0;
        for (let i = 0; i < schema.length; i++) {
            let data = binary.slice(count, schema[i].length ? count + schema[i].length : undefined);
            json[schema[i].name] = types[schema[i].type](data, schema[i]);
            if (schema[i].length) {
                count += schema[i].length;
            }
            else {
                break;
            }
        }
        return json;
    }
    static hexFromBinary(data, schema) {
        let str = '';
        for (let i = 0; i < data.length; i++) {
            if (schema.endianness && schema.endianness === 'little') {
                str = ('00' + data[i].toString(16)).slice(-2) + str;
            }
            else {
                str = str + ('00' + data[i].toString(16)).slice(-2);
            }
        }
        return str;
    }
    static uuidFromBinary(data) {
        let len = data[0] * 16 + data[1];
        if (len === 0) {
            return null;
        }
        let uuidData = data.slice(2);
        let str = '';
        for (let i = 0; i < len; i++) {
            str = ('00' + uuidData[i].toString(16)).slice(-2) + str;
        }
        return str;
    }
    static signedNumberFromBinary(data) {
        //big adian
        let val = data[0] & 0x7f;
        for (let i = 1; i < data.length; i++) {
            val = val * 256 + data[i];
        }
        if ((data[0] & 0x80) !== 0) {
            val = val - Math.pow(2, data.length * 8 - 1);
        }
        return val;
    }
    static numberFromBinary(data) {
        //big adian
        let val = 0;
        for (let i = 0; i < data.length; i++) {
            val = val * 256 + data[i];
        }
        return val;
    }
    static keyForVal(enumvals, val) {
        return Object.keys(enumvals).filter(function (k) {
            return enumvals[k] === val;
        })[0];
    }
    static enumFromBinary(data, schema) {
        let enumVals = schema.enum;
        let val = this.numberFromBinary(data);
        if (schema.flags === true) {
            let temp = [];
            for (let key of Object.keys(enumVals)) {
                let flag = enumVals[key] & val;
                if (flag) {
                    temp.push(key);
                }
            }
            val = temp;
        }
        else {
            let tmp = this.keyForVal(enumVals, val);
            if (tmp) {
                val = tmp;
            }
        }
        return val;
    }
    static dataArrayFromBinary(data) {
        let arr = new Array(data.length);
        for (let i = 0; i < data.length; i++) {
            arr[i] = data[i];
        }
        return arr;
    }
    static createSendBuffer(schema, data) {
        let array = [];
        for (let i = 0; i < schema.length; i++) {
            let schemaRow = schema[i];
            let row = undefined;
            if (Array.isArray(schemaRow)) {
                for (let key in schemaRow) {
                    let customSchemaRow = Object.assign({}, schemaRow[key], {
                        required: true,
                    });
                    row = this.analyzeSchema(data, customSchemaRow);
                    if (row) {
                        break;
                    }
                }
            }
            else {
                row = this.analyzeSchema(data, schemaRow);
            }
            Array.prototype.push.apply(array, row);
        }
        return new Uint8Array(array);
    }
    static analyzeSchema(allData, schemaRow) {
        let types = {
            hex: this.hexToBinary.bind(this),
            uuid: this.uuidToBinary.bind(this),
            int: this.intToBinary.bind(this),
            char: this.charToBinary.bind(this),
            dataArray: this.dataArrayToBinary.bind(this),
            enum: this.enumToBinary.bind(this),
            string: this.stringToBinary.bind(this),
            text: this.stringToBinary.bind(this),
            flag: this.flagToBinary.bind(this),
        };
        let val = undefined;
        if (schemaRow.path) {
            val = this.getProperty(allData, schemaRow.path);
        }
        if (val === undefined && schemaRow.required) {
            return null;
        }
        if (val === undefined && schemaRow.default) {
            val = schemaRow.default;
        }
        let row = types[schemaRow.type](val, schemaRow);
        if (schemaRow.length && row.length !== schemaRow.length) {
            console.log('JSON->BINARY SCHEMA ERROR: (', val, ')', schemaRow);
        }
        return row;
    }
    static getProperty(object, path) {
        if (path === '' || path === undefined) {
            return object;
        }
        if (typeof path === 'string') {
            path = path.split('.');
        }
        if (!Array.isArray(path)) {
            path = [path];
        }
        let index = 0, length = path.length;
        while (index < length) {
            object = object[path[index++]];
            if (object === undefined) {
                return undefined;
            }
        }
        return index && index === length ? object : undefined;
    }
    static hexToBinary(data, schema) {
        let array = [];
        let hex = data.toLowerCase().replace(/[^0-9abcdef]/g, '');
        for (let i = 0; i < hex.length / 2; i++) {
            array[i] = parseInt(hex[i * 2] + hex[i * 2 + 1], 16);
        }
        if (schema && schema.endianness && schema.endianness === 'little') {
            array.reverse();
        }
        return array;
    }
    static intToBinary(data) {
        let array = [];
        array[0] = (data >> (8 * 3)) & 0xff;
        array[1] = (data >> (8 * 2)) & 0xff;
        array[2] = (data >> (8 * 1)) & 0xff;
        array[3] = (data >> (8 * 0)) & 0xff;
        return array;
    }
    static charToBinary(data) {
        let array = [];
        array[0] = data & 0xff;
        return array;
    }
    static dataArrayToBinary(data) {
        if (!Array.isArray(data)) {
            data = [data];
        }
        return data;
    }
    static uuidToBinary(data) {
        let uuid = this.hexToBinary(data);
        uuid.reverse(); //big endianness -> little endianness;
        let length = uuid.length;
        let array = [];
        array[0] = (length >> (8 * 1)) & 0xff;
        array[1] = (length >> (8 * 0)) & 0xff;
        Array.prototype.push.apply(array, uuid);
        for (let i = array.length; i < 16 + 2; i++) {
            array[i] = 0;
        }
        return array;
    }
    static enumToBinary(data, schema) {
        let array = [];
        array.push(schema.enum[data]);
        return array;
    }
    static flagToBinary(data, schema) {
        if (!Array.isArray(data)) {
            data = [data];
        }
        let flags = schema.flags;
        let value = 0;
        for (let key in flags) {
            if (data.includes(flags[key])) {
                value += parseInt(key);
            }
        }
        let array = [];
        let length = schema.length || 1;
        for (let i = length - 1; i >= 0; i--) {
            array.push((value >> (i * 8)) & 0xff);
        }
        return array;
    }
    static stringToBinary(data) {
        return new Uint8Array(Buffer(data, 'utf8'));
    }
}
module.exports = JsonBinaryConverter;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9qc29uQmluYXJ5Q29udmVydGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxNQUFNLG1CQUFtQjtJQUN2QixNQUFNLENBQUMsdUJBQXVCLENBQUMsTUFBTSxFQUFFLE1BQU07UUFDM0MsSUFBSSxLQUFLLEdBQUc7WUFDVixHQUFHLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ2xDLElBQUksRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDcEMsTUFBTSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ3hDLGVBQWUsRUFBRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztZQUN2RCxHQUFHLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDckMsSUFBSSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ3RDLElBQUksRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDcEMsU0FBUyxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQy9DLENBQUM7UUFDRixJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDZCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN0QyxJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsS0FBSyxDQUNyQixLQUFLLEVBQ0wsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLE1B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UUFDaEMsS0FBSyxJQUFJLENBQUMsR0FBRyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDcEMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1NBQ3ZDO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJO1FBQ3hCLE9BQU8sSUFBSSxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQzlDLENBQUM7Q0FDRjtBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsbUJBQW1CLENBQUMiLCJmaWxlIjoib2JuaXovbGlicy93c2NvbW1hbmQvanNvbkJpbmFyeUNvbnZlcnRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIEpzb25CaW5hcnlDb252ZXJ0ZXIge1xuICBzdGF0aWMgY29udmVydEZyb21CaW5hcnlUb0pzb24oc2NoZW1hLCBiaW5hcnkpIHtcbiAgICBsZXQgdHlwZXMgPSB7XG4gICAgICBoZXg6IHRoaXMuaGV4RnJvbUJpbmFyeS5iaW5kKHRoaXMpLFxuICAgICAgdXVpZDogdGhpcy51dWlkRnJvbUJpbmFyeS5iaW5kKHRoaXMpLFxuICAgICAgbnVtYmVyOiB0aGlzLm51bWJlckZyb21CaW5hcnkuYmluZCh0aGlzKSxcbiAgICAgICdzaWduZWQgbnVtYmVyJzogdGhpcy5zaWduZWROdW1iZXJGcm9tQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICBpbnQ6IHRoaXMubnVtYmVyRnJvbUJpbmFyeS5iaW5kKHRoaXMpLFxuICAgICAgY2hhcjogdGhpcy5udW1iZXJGcm9tQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICBlbnVtOiB0aGlzLmVudW1Gcm9tQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICBkYXRhQXJyYXk6IHRoaXMuZGF0YUFycmF5RnJvbUJpbmFyeS5iaW5kKHRoaXMpLFxuICAgIH07XG4gICAgbGV0IGpzb24gPSB7fTtcbiAgICBsZXQgY291bnQgPSAwO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2NoZW1hLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgZGF0YSA9IGJpbmFyeS5zbGljZShcbiAgICAgICAgY291bnQsXG4gICAgICAgIHNjaGVtYVtpXS5sZW5ndGggPyBjb3VudCArIHNjaGVtYVtpXS5sZW5ndGggOiB1bmRlZmluZWRcbiAgICAgICk7XG4gICAgICBqc29uW3NjaGVtYVtpXS5uYW1lXSA9IHR5cGVzW3NjaGVtYVtpXS50eXBlXShkYXRhLCBzY2hlbWFbaV0pO1xuXG4gICAgICBpZiAoc2NoZW1hW2ldLmxlbmd0aCkge1xuICAgICAgICBjb3VudCArPSBzY2hlbWFbaV0ubGVuZ3RoO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBqc29uO1xuICB9XG5cbiAgc3RhdGljIGhleEZyb21CaW5hcnkoZGF0YSwgc2NoZW1hKSB7XG4gICAgbGV0IHN0ciA9ICcnO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKHNjaGVtYS5lbmRpYW5uZXNzICYmIHNjaGVtYS5lbmRpYW5uZXNzID09PSAnbGl0dGxlJykge1xuICAgICAgICBzdHIgPSAoJzAwJyArIGRhdGFbaV0udG9TdHJpbmcoMTYpKS5zbGljZSgtMikgKyBzdHI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzdHIgPSBzdHIgKyAoJzAwJyArIGRhdGFbaV0udG9TdHJpbmcoMTYpKS5zbGljZSgtMik7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzdHI7XG4gIH1cblxuICBzdGF0aWMgdXVpZEZyb21CaW5hcnkoZGF0YSkge1xuICAgIGxldCBsZW4gPSBkYXRhWzBdICogMTYgKyBkYXRhWzFdO1xuICAgIGlmIChsZW4gPT09IDApIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBsZXQgdXVpZERhdGEgPSBkYXRhLnNsaWNlKDIpO1xuICAgIGxldCBzdHIgPSAnJztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBzdHIgPSAoJzAwJyArIHV1aWREYXRhW2ldLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTIpICsgc3RyO1xuICAgIH1cbiAgICByZXR1cm4gc3RyO1xuICB9XG5cbiAgc3RhdGljIHNpZ25lZE51bWJlckZyb21CaW5hcnkoZGF0YSkge1xuICAgIC8vYmlnIGFkaWFuXG4gICAgbGV0IHZhbCA9IGRhdGFbMF0gJiAweDdmO1xuICAgIGZvciAobGV0IGkgPSAxOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgdmFsID0gdmFsICogMjU2ICsgZGF0YVtpXTtcbiAgICB9XG4gICAgaWYgKChkYXRhWzBdICYgMHg4MCkgIT09IDApIHtcbiAgICAgIHZhbCA9IHZhbCAtIE1hdGgucG93KDIsIGRhdGEubGVuZ3RoICogOCAtIDEpO1xuICAgIH1cbiAgICByZXR1cm4gdmFsO1xuICB9XG5cbiAgc3RhdGljIG51bWJlckZyb21CaW5hcnkoZGF0YSkge1xuICAgIC8vYmlnIGFkaWFuXG4gICAgbGV0IHZhbCA9IDA7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICB2YWwgPSB2YWwgKiAyNTYgKyBkYXRhW2ldO1xuICAgIH1cbiAgICByZXR1cm4gdmFsO1xuICB9XG5cbiAgc3RhdGljIGtleUZvclZhbChlbnVtdmFscywgdmFsKSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKGVudW12YWxzKS5maWx0ZXIoZnVuY3Rpb24oaykge1xuICAgICAgcmV0dXJuIGVudW12YWxzW2tdID09PSB2YWw7XG4gICAgfSlbMF07XG4gIH1cblxuICBzdGF0aWMgZW51bUZyb21CaW5hcnkoZGF0YSwgc2NoZW1hKSB7XG4gICAgbGV0IGVudW1WYWxzID0gc2NoZW1hLmVudW07XG4gICAgbGV0IHZhbCA9IHRoaXMubnVtYmVyRnJvbUJpbmFyeShkYXRhKTtcblxuICAgIGlmIChzY2hlbWEuZmxhZ3MgPT09IHRydWUpIHtcbiAgICAgIGxldCB0ZW1wID0gW107XG4gICAgICBmb3IgKGxldCBrZXkgb2YgT2JqZWN0LmtleXMoZW51bVZhbHMpKSB7XG4gICAgICAgIGxldCBmbGFnID0gZW51bVZhbHNba2V5XSAmIHZhbDtcbiAgICAgICAgaWYgKGZsYWcpIHtcbiAgICAgICAgICB0ZW1wLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdmFsID0gdGVtcDtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHRtcCA9IHRoaXMua2V5Rm9yVmFsKGVudW1WYWxzLCB2YWwpO1xuICAgICAgaWYgKHRtcCkge1xuICAgICAgICB2YWwgPSB0bXA7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB2YWw7XG4gIH1cblxuICBzdGF0aWMgZGF0YUFycmF5RnJvbUJpbmFyeShkYXRhKSB7XG4gICAgbGV0IGFyciA9IG5ldyBBcnJheShkYXRhLmxlbmd0aCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBhcnJbaV0gPSBkYXRhW2ldO1xuICAgIH1cbiAgICByZXR1cm4gYXJyO1xuICB9XG5cbiAgc3RhdGljIGNyZWF0ZVNlbmRCdWZmZXIoc2NoZW1hLCBkYXRhKSB7XG4gICAgbGV0IGFycmF5ID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY2hlbWEubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBzY2hlbWFSb3cgPSBzY2hlbWFbaV07XG5cbiAgICAgIGxldCByb3cgPSB1bmRlZmluZWQ7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShzY2hlbWFSb3cpKSB7XG4gICAgICAgIGZvciAobGV0IGtleSBpbiBzY2hlbWFSb3cpIHtcbiAgICAgICAgICBsZXQgY3VzdG9tU2NoZW1hUm93ID0gT2JqZWN0LmFzc2lnbih7fSwgc2NoZW1hUm93W2tleV0sIHtcbiAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJvdyA9IHRoaXMuYW5hbHl6ZVNjaGVtYShkYXRhLCBjdXN0b21TY2hlbWFSb3cpO1xuICAgICAgICAgIGlmIChyb3cpIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcm93ID0gdGhpcy5hbmFseXplU2NoZW1hKGRhdGEsIHNjaGVtYVJvdyk7XG4gICAgICB9XG5cbiAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KGFycmF5LCByb3cpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYXJyYXkpO1xuICB9XG5cbiAgc3RhdGljIGFuYWx5emVTY2hlbWEoYWxsRGF0YSwgc2NoZW1hUm93KSB7XG4gICAgbGV0IHR5cGVzID0ge1xuICAgICAgaGV4OiB0aGlzLmhleFRvQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICB1dWlkOiB0aGlzLnV1aWRUb0JpbmFyeS5iaW5kKHRoaXMpLFxuICAgICAgaW50OiB0aGlzLmludFRvQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICBjaGFyOiB0aGlzLmNoYXJUb0JpbmFyeS5iaW5kKHRoaXMpLFxuICAgICAgZGF0YUFycmF5OiB0aGlzLmRhdGFBcnJheVRvQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICBlbnVtOiB0aGlzLmVudW1Ub0JpbmFyeS5iaW5kKHRoaXMpLFxuICAgICAgc3RyaW5nOiB0aGlzLnN0cmluZ1RvQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICB0ZXh0OiB0aGlzLnN0cmluZ1RvQmluYXJ5LmJpbmQodGhpcyksXG4gICAgICBmbGFnOiB0aGlzLmZsYWdUb0JpbmFyeS5iaW5kKHRoaXMpLFxuICAgIH07XG5cbiAgICBsZXQgdmFsID0gdW5kZWZpbmVkO1xuICAgIGlmIChzY2hlbWFSb3cucGF0aCkge1xuICAgICAgdmFsID0gdGhpcy5nZXRQcm9wZXJ0eShhbGxEYXRhLCBzY2hlbWFSb3cucGF0aCk7XG4gICAgfVxuICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCAmJiBzY2hlbWFSb3cucmVxdWlyZWQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBpZiAodmFsID09PSB1bmRlZmluZWQgJiYgc2NoZW1hUm93LmRlZmF1bHQpIHtcbiAgICAgIHZhbCA9IHNjaGVtYVJvdy5kZWZhdWx0O1xuICAgIH1cblxuICAgIGxldCByb3cgPSB0eXBlc1tzY2hlbWFSb3cudHlwZV0odmFsLCBzY2hlbWFSb3cpO1xuXG4gICAgaWYgKHNjaGVtYVJvdy5sZW5ndGggJiYgcm93Lmxlbmd0aCAhPT0gc2NoZW1hUm93Lmxlbmd0aCkge1xuICAgICAgY29uc29sZS5sb2coJ0pTT04tPkJJTkFSWSBTQ0hFTUEgRVJST1I6ICgnLCB2YWwsICcpJywgc2NoZW1hUm93KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcm93O1xuICB9XG5cbiAgc3RhdGljIGdldFByb3BlcnR5KG9iamVjdCwgcGF0aCkge1xuICAgIGlmIChwYXRoID09PSAnJyB8fCBwYXRoID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBvYmplY3Q7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgcGF0aCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHBhdGggPSBwYXRoLnNwbGl0KCcuJyk7XG4gICAgfVxuICAgIGlmICghQXJyYXkuaXNBcnJheShwYXRoKSkge1xuICAgICAgcGF0aCA9IFtwYXRoXTtcbiAgICB9XG5cbiAgICBsZXQgaW5kZXggPSAwLFxuICAgICAgbGVuZ3RoID0gcGF0aC5sZW5ndGg7XG5cbiAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIHtcbiAgICAgIG9iamVjdCA9IG9iamVjdFtwYXRoW2luZGV4KytdXTtcbiAgICAgIGlmIChvYmplY3QgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaW5kZXggJiYgaW5kZXggPT09IGxlbmd0aCA/IG9iamVjdCA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHN0YXRpYyBoZXhUb0JpbmFyeShkYXRhLCBzY2hlbWEpIHtcbiAgICBsZXQgYXJyYXkgPSBbXTtcbiAgICBsZXQgaGV4ID0gZGF0YS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1teMC05YWJjZGVmXS9nLCAnJyk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoZXgubGVuZ3RoIC8gMjsgaSsrKSB7XG4gICAgICBhcnJheVtpXSA9IHBhcnNlSW50KGhleFtpICogMl0gKyBoZXhbaSAqIDIgKyAxXSwgMTYpO1xuICAgIH1cbiAgICBpZiAoc2NoZW1hICYmIHNjaGVtYS5lbmRpYW5uZXNzICYmIHNjaGVtYS5lbmRpYW5uZXNzID09PSAnbGl0dGxlJykge1xuICAgICAgYXJyYXkucmV2ZXJzZSgpO1xuICAgIH1cbiAgICByZXR1cm4gYXJyYXk7XG4gIH1cblxuICBzdGF0aWMgaW50VG9CaW5hcnkoZGF0YSkge1xuICAgIGxldCBhcnJheSA9IFtdO1xuICAgIGFycmF5WzBdID0gKGRhdGEgPj4gKDggKiAzKSkgJiAweGZmO1xuICAgIGFycmF5WzFdID0gKGRhdGEgPj4gKDggKiAyKSkgJiAweGZmO1xuICAgIGFycmF5WzJdID0gKGRhdGEgPj4gKDggKiAxKSkgJiAweGZmO1xuICAgIGFycmF5WzNdID0gKGRhdGEgPj4gKDggKiAwKSkgJiAweGZmO1xuICAgIHJldHVybiBhcnJheTtcbiAgfVxuXG4gIHN0YXRpYyBjaGFyVG9CaW5hcnkoZGF0YSkge1xuICAgIGxldCBhcnJheSA9IFtdO1xuICAgIGFycmF5WzBdID0gZGF0YSAmIDB4ZmY7XG4gICAgcmV0dXJuIGFycmF5O1xuICB9XG5cbiAgc3RhdGljIGRhdGFBcnJheVRvQmluYXJ5KGRhdGEpIHtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgIGRhdGEgPSBbZGF0YV07XG4gICAgfVxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgc3RhdGljIHV1aWRUb0JpbmFyeShkYXRhKSB7XG4gICAgbGV0IHV1aWQgPSB0aGlzLmhleFRvQmluYXJ5KGRhdGEpO1xuICAgIHV1aWQucmV2ZXJzZSgpOyAvL2JpZyBlbmRpYW5uZXNzIC0+IGxpdHRsZSBlbmRpYW5uZXNzO1xuICAgIGxldCBsZW5ndGggPSB1dWlkLmxlbmd0aDtcblxuICAgIGxldCBhcnJheSA9IFtdO1xuXG4gICAgYXJyYXlbMF0gPSAobGVuZ3RoID4+ICg4ICogMSkpICYgMHhmZjtcbiAgICBhcnJheVsxXSA9IChsZW5ndGggPj4gKDggKiAwKSkgJiAweGZmO1xuXG4gICAgQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkoYXJyYXksIHV1aWQpO1xuICAgIGZvciAobGV0IGkgPSBhcnJheS5sZW5ndGg7IGkgPCAxNiArIDI7IGkrKykge1xuICAgICAgYXJyYXlbaV0gPSAwO1xuICAgIH1cblxuICAgIHJldHVybiBhcnJheTtcbiAgfVxuXG4gIHN0YXRpYyBlbnVtVG9CaW5hcnkoZGF0YSwgc2NoZW1hKSB7XG4gICAgbGV0IGFycmF5ID0gW107XG4gICAgYXJyYXkucHVzaChzY2hlbWEuZW51bVtkYXRhXSk7XG4gICAgcmV0dXJuIGFycmF5O1xuICB9XG5cbiAgc3RhdGljIGZsYWdUb0JpbmFyeShkYXRhLCBzY2hlbWEpIHtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgIGRhdGEgPSBbZGF0YV07XG4gICAgfVxuICAgIGxldCBmbGFncyA9IHNjaGVtYS5mbGFncztcbiAgICBsZXQgdmFsdWUgPSAwO1xuICAgIGZvciAobGV0IGtleSBpbiBmbGFncykge1xuICAgICAgaWYgKGRhdGEuaW5jbHVkZXMoZmxhZ3Nba2V5XSkpIHtcbiAgICAgICAgdmFsdWUgKz0gcGFyc2VJbnQoa2V5KTtcbiAgICAgIH1cbiAgICB9XG4gICAgbGV0IGFycmF5ID0gW107XG4gICAgbGV0IGxlbmd0aCA9IHNjaGVtYS5sZW5ndGggfHwgMTtcbiAgICBmb3IgKGxldCBpID0gbGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIGFycmF5LnB1c2goKHZhbHVlID4+IChpICogOCkpICYgMHhmZik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFycmF5O1xuICB9XG5cbiAgc3RhdGljIHN0cmluZ1RvQmluYXJ5KGRhdGEpIHtcbiAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoQnVmZmVyKGRhdGEsICd1dGY4JykpO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gSnNvbkJpbmFyeUNvbnZlcnRlcjtcbiJdfQ==

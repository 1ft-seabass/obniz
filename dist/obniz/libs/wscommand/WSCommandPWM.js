"use strict";
const WSCommand = require('./WSCommand.js').default;
class WSCommandPWM extends WSCommand {
    constructor() {
        super();
        this.module = 3;
        this.ModuleNum = 6;
        this.resetInternalStatus();
        this._CommandInit = 0;
        this._CommandDeinit = 1;
        this._CommandSetFreq = 2;
        this._CommandSetDuty = 3;
        this._CommandAMModulate = 4;
    }
    resetInternalStatus() {
        this.pwms = [];
        for (let i = 0; i < this.ModuleNum; i++) {
            this.pwms.push({});
        }
    }
    // Commands
    init(params, module) {
        let buf = new Uint8Array(2);
        buf[0] = module;
        buf[1] = params.io;
        this.pwms[module].io = params.io;
        this.sendCommand(this._CommandInit, buf);
    }
    deinit(params, module) {
        let buf = new Uint8Array(1);
        buf[0] = module;
        this.pwms[module] = {};
        this.sendCommand(this._CommandDeinit, buf);
    }
    freq(params, module) {
        let buf = new Uint8Array(5);
        buf[0] = module;
        buf[1] = params.freq >> (8 * 3);
        buf[2] = params.freq >> (8 * 2);
        buf[3] = params.freq >> (8 * 1);
        buf[4] = params.freq;
        this.pwms[module].freq = params.freq;
        this.sendCommand(this._CommandSetFreq, buf);
    }
    pulse(params, module) {
        let buf = new Uint8Array(5);
        let pulseUSec = params.pulse * 1000;
        buf[0] = module;
        buf[1] = pulseUSec >> (8 * 3);
        buf[2] = pulseUSec >> (8 * 2);
        buf[3] = pulseUSec >> (8 * 1);
        buf[4] = pulseUSec;
        this.pwms[module].pulseUSec = pulseUSec;
        this.sendCommand(this._CommandSetDuty, buf);
    }
    amModulate(params, module) {
        const bitLength = params.modulate.data.length;
        const byteLength = parseInt((bitLength + 7) / 8);
        let buf = new Uint8Array(5 + byteLength);
        let symbol_length_usec = params.modulate.symbol_length * 1000;
        buf[0] = module;
        buf[1] = symbol_length_usec >> (8 * 3);
        buf[2] = symbol_length_usec >> (8 * 2);
        buf[3] = symbol_length_usec >> (8 * 1);
        buf[4] = symbol_length_usec;
        let bitIndex = 0;
        for (let byte = 0; byte < byteLength; byte++) {
            buf[5 + byte] = 0;
            for (let bit = 0; bit < 8; bit++) {
                if (params.modulate.data[bitIndex++]) {
                    buf[5 + byte] |= 0x80 >>> bit;
                }
            }
        }
        this.sendCommand(this._CommandAMModulate, buf);
    }
    parseFromJson(json) {
        for (let i = 0; i < this.ModuleNum; i++) {
            let module = json['pwm' + i];
            if (module === undefined) {
                continue;
            }
            let schemaData = [
                { uri: '/request/pwm/init', onValid: this.init },
                { uri: '/request/pwm/freq', onValid: this.freq },
                { uri: '/request/pwm/pulse', onValid: this.pulse },
                { uri: '/request/pwm/modulate', onValid: this.amModulate },
                { uri: '/request/pwm/deinit', onValid: this.deinit },
            ];
            let res = this.validateCommandSchema(schemaData, module, 'pwm' + i, i);
            if (res.valid === 0) {
                if (res.invalidButLike.length > 0) {
                    throw new Error(res.invalidButLike[0].message);
                }
                else {
                    throw new this.WSCommandNotFoundError(`[pwm${i}]unknown command`);
                }
            }
        }
    }
}
module.exports = WSCommandPWM;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmRQV00uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUVwRCxNQUFNLFlBQWEsU0FBUSxTQUFTO0lBQ2xDO1FBQ0UsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQztRQUNuQixJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUUzQixJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQztRQUN4QixJQUFJLENBQUMsZUFBZSxHQUFHLENBQUMsQ0FBQztRQUN6QixJQUFJLENBQUMsZUFBZSxHQUFHLENBQUMsQ0FBQztRQUN6QixJQUFJLENBQUMsa0JBQWtCLEdBQUcsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxtQkFBbUI7UUFDakIsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN2QyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNwQjtJQUNILENBQUM7SUFFRCxXQUFXO0lBRVgsSUFBSSxDQUFDLE1BQU0sRUFBRSxNQUFNO1FBQ2pCLElBQUksR0FBRyxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzVCLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDaEIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLElBQUks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LEVBQUU7Z0JBQ3hCLFNBQVM7YUFDVjtZQUVELElBQUksVUFBVSxHQUFHO2dCQUNmLEVBQUUsR0FBRyxFQUFFLG1CQUFtQixFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUNoRCxFQUFFLEdBQUcsRUFBRSxtQkFBbUIsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDaEQsRUFBRSxHQUFHLEVBQUUsb0JBQW9CLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUU7Z0JBQ2xELEVBQUUsR0FBRyxFQUFFLHVCQUF1QixFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUMxRCxFQUFFLEdBQUcsRUFBRSxxQkFBcUIsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRTthQUNyRCxDQUFDO1lBQ0YsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsS0FBSyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUV2RSxJQUFJLEdBQUcsQ0FBQyxLQUFLLEtBQUssQ0FBQyxFQUFFO2dCQUNuQixJQUFJLEdBQUcsQ0FBQyxjQUFjLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDakMsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2lCQUNoRDtxQkFBTTtvQkFDTCxNQUFNLElBQUksSUFBSSxDQUFDLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO2lCQUNuRTthQUNGO1NBQ0Y7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLFlBQVksQ0FBQyIsImZpbGUiOiJvYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmRQV00uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBXU0NvbW1hbmQgPSByZXF1aXJlKCcuL1dTQ29tbWFuZC5qcycpLmRlZmF1bHQ7XG5cbmNsYXNzIFdTQ29tbWFuZFBXTSBleHRlbmRzIFdTQ29tbWFuZCB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5tb2R1bGUgPSAzO1xuICAgIHRoaXMuTW9kdWxlTnVtID0gNjtcbiAgICB0aGlzLnJlc2V0SW50ZXJuYWxTdGF0dXMoKTtcblxuICAgIHRoaXMuX0NvbW1hbmRJbml0ID0gMDtcbiAgICB0aGlzLl9Db21tYW5kRGVpbml0ID0gMTtcbiAgICB0aGlzLl9Db21tYW5kU2V0RnJlcSA9IDI7XG4gICAgdGhpcy5fQ29tbWFuZFNldER1dHkgPSAzO1xuICAgIHRoaXMuX0NvbW1hbmRBTU1vZHVsYXRlID0gNDtcbiAgfVxuXG4gIHJlc2V0SW50ZXJuYWxTdGF0dXMoKSB7XG4gICAgdGhpcy5wd21zID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLk1vZHVsZU51bTsgaSsrKSB7XG4gICAgICB0aGlzLnB3bXMucHVzaCh7fSk7XG4gICAgfVxuICB9XG5cbiAgLy8gQ29tbWFuZHNcblxuICBpbml0KHBhcmFtcywgbW9kdWxlKSB7XG4gICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KDIpO1xuICAgIGJ1ZlswXSA9IG1vZHVsZTtcbiAgICBidWZbMV0gPSBwYXJhbXMuaW87XG4gICAgdGhpcy5wd21zW21vZHVsZV0uaW8gPSBwYXJhbXMuaW87XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kSW5pdCwgYnVmKTtcbiAgfVxuXG4gIGRlaW5pdChwYXJhbXMsIG1vZHVsZSkge1xuICAgIGxldCBidWYgPSBuZXcgVWludDhBcnJheSgxKTtcbiAgICBidWZbMF0gPSBtb2R1bGU7XG4gICAgdGhpcy5wd21zW21vZHVsZV0gPSB7fTtcbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmREZWluaXQsIGJ1Zik7XG4gIH1cblxuICBmcmVxKHBhcmFtcywgbW9kdWxlKSB7XG4gICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KDUpO1xuICAgIGJ1ZlswXSA9IG1vZHVsZTtcbiAgICBidWZbMV0gPSBwYXJhbXMuZnJlcSA+PiAoOCAqIDMpO1xuICAgIGJ1ZlsyXSA9IHBhcmFtcy5mcmVxID4+ICg4ICogMik7XG4gICAgYnVmWzNdID0gcGFyYW1zLmZyZXEgPj4gKDggKiAxKTtcbiAgICBidWZbNF0gPSBwYXJhbXMuZnJlcTtcbiAgICB0aGlzLnB3bXNbbW9kdWxlXS5mcmVxID0gcGFyYW1zLmZyZXE7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kU2V0RnJlcSwgYnVmKTtcbiAgfVxuXG4gIHB1bHNlKHBhcmFtcywgbW9kdWxlKSB7XG4gICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KDUpO1xuICAgIGxldCBwdWxzZVVTZWMgPSBwYXJhbXMucHVsc2UgKiAxMDAwO1xuICAgIGJ1ZlswXSA9IG1vZHVsZTtcbiAgICBidWZbMV0gPSBwdWxzZVVTZWMgPj4gKDggKiAzKTtcbiAgICBidWZbMl0gPSBwdWxzZVVTZWMgPj4gKDggKiAyKTtcbiAgICBidWZbM10gPSBwdWxzZVVTZWMgPj4gKDggKiAxKTtcbiAgICBidWZbNF0gPSBwdWxzZVVTZWM7XG4gICAgdGhpcy5wd21zW21vZHVsZV0ucHVsc2VVU2VjID0gcHVsc2VVU2VjO1xuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZFNldER1dHksIGJ1Zik7XG4gIH1cblxuICBhbU1vZHVsYXRlKHBhcmFtcywgbW9kdWxlKSB7XG4gICAgY29uc3QgYml0TGVuZ3RoID0gcGFyYW1zLm1vZHVsYXRlLmRhdGEubGVuZ3RoO1xuICAgIGNvbnN0IGJ5dGVMZW5ndGggPSBwYXJzZUludCgoYml0TGVuZ3RoICsgNykgLyA4KTtcbiAgICBsZXQgYnVmID0gbmV3IFVpbnQ4QXJyYXkoNSArIGJ5dGVMZW5ndGgpO1xuICAgIGxldCBzeW1ib2xfbGVuZ3RoX3VzZWMgPSBwYXJhbXMubW9kdWxhdGUuc3ltYm9sX2xlbmd0aCAqIDEwMDA7XG4gICAgYnVmWzBdID0gbW9kdWxlO1xuICAgIGJ1ZlsxXSA9IHN5bWJvbF9sZW5ndGhfdXNlYyA+PiAoOCAqIDMpO1xuICAgIGJ1ZlsyXSA9IHN5bWJvbF9sZW5ndGhfdXNlYyA+PiAoOCAqIDIpO1xuICAgIGJ1ZlszXSA9IHN5bWJvbF9sZW5ndGhfdXNlYyA+PiAoOCAqIDEpO1xuICAgIGJ1Zls0XSA9IHN5bWJvbF9sZW5ndGhfdXNlYztcbiAgICBsZXQgYml0SW5kZXggPSAwO1xuICAgIGZvciAobGV0IGJ5dGUgPSAwOyBieXRlIDwgYnl0ZUxlbmd0aDsgYnl0ZSsrKSB7XG4gICAgICBidWZbNSArIGJ5dGVdID0gMDtcbiAgICAgIGZvciAobGV0IGJpdCA9IDA7IGJpdCA8IDg7IGJpdCsrKSB7XG4gICAgICAgIGlmIChwYXJhbXMubW9kdWxhdGUuZGF0YVtiaXRJbmRleCsrXSkge1xuICAgICAgICAgIGJ1Zls1ICsgYnl0ZV0gfD0gMHg4MCA+Pj4gYml0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZEFNTW9kdWxhdGUsIGJ1Zik7XG4gIH1cblxuICBwYXJzZUZyb21Kc29uKGpzb24pIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuTW9kdWxlTnVtOyBpKyspIHtcbiAgICAgIGxldCBtb2R1bGUgPSBqc29uWydwd20nICsgaV07XG4gICAgICBpZiAobW9kdWxlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGxldCBzY2hlbWFEYXRhID0gW1xuICAgICAgICB7IHVyaTogJy9yZXF1ZXN0L3B3bS9pbml0Jywgb25WYWxpZDogdGhpcy5pbml0IH0sXG4gICAgICAgIHsgdXJpOiAnL3JlcXVlc3QvcHdtL2ZyZXEnLCBvblZhbGlkOiB0aGlzLmZyZXEgfSxcbiAgICAgICAgeyB1cmk6ICcvcmVxdWVzdC9wd20vcHVsc2UnLCBvblZhbGlkOiB0aGlzLnB1bHNlIH0sXG4gICAgICAgIHsgdXJpOiAnL3JlcXVlc3QvcHdtL21vZHVsYXRlJywgb25WYWxpZDogdGhpcy5hbU1vZHVsYXRlIH0sXG4gICAgICAgIHsgdXJpOiAnL3JlcXVlc3QvcHdtL2RlaW5pdCcsIG9uVmFsaWQ6IHRoaXMuZGVpbml0IH0sXG4gICAgICBdO1xuICAgICAgbGV0IHJlcyA9IHRoaXMudmFsaWRhdGVDb21tYW5kU2NoZW1hKHNjaGVtYURhdGEsIG1vZHVsZSwgJ3B3bScgKyBpLCBpKTtcblxuICAgICAgaWYgKHJlcy52YWxpZCA9PT0gMCkge1xuICAgICAgICBpZiAocmVzLmludmFsaWRCdXRMaWtlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVzLmludmFsaWRCdXRMaWtlWzBdLm1lc3NhZ2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyB0aGlzLldTQ29tbWFuZE5vdEZvdW5kRXJyb3IoYFtwd20ke2l9XXVua25vd24gY29tbWFuZGApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gV1NDb21tYW5kUFdNO1xuIl19

"use strict";
const WSCommand = require('./WSCommand.js').default;
class WSCommandI2C extends WSCommand {
    constructor() {
        super();
        this.module = 6;
        this._CommandInit = 0;
        this._CommandDeinit = 1;
        this._CommandWrite = 2;
        this._CommandRead = 3;
        this._CommandSlvWritten = 4;
    }
    // Commands
    initMaster(params, module) {
        let mode = 0;
        let sda = parseInt(params.sda);
        let scl = parseInt(params.scl);
        let clock = parseInt(params.clock);
        let buf = new Uint8Array(8);
        buf[0] = module;
        buf[1] = mode;
        buf[2] = sda;
        buf[3] = scl;
        buf[4] = clock >> (3 * 8);
        buf[5] = clock >> (2 * 8);
        buf[6] = clock >> (1 * 8);
        buf[7] = clock;
        this.sendCommand(this._CommandInit, buf);
    }
    initSlave(params, module) {
        let mode = 1;
        let sda = parseInt(params.sda);
        let scl = parseInt(params.scl);
        let clock = 0;
        let addressLength = params.slave_address_length;
        let address = params.slave_address;
        if (address > 0x7f) {
            addressLength = 10;
        }
        let buf = new Uint8Array(11);
        buf[0] = module;
        buf[1] = mode;
        buf[2] = sda;
        buf[3] = scl;
        buf[4] = clock >> (3 * 8);
        buf[5] = clock >> (2 * 8);
        buf[6] = clock >> (1 * 8);
        buf[7] = clock;
        buf[8] = addressLength;
        buf[9] = address >> 8;
        buf[10] = address;
        this.sendCommand(this._CommandInit, buf);
    }
    deinit(params, module) {
        let buf = new Uint8Array([module]);
        this.sendCommand(this._CommandDeinit, buf);
    }
    write(params, module) {
        let address = parseInt(params.address);
        if (params.address_bits === 10 || address > 0x7f) {
            address = address | 0x8000; // mark 10bit mode
        }
        let buf = new Uint8Array(3 + params.data.length);
        buf[0] = module;
        buf[1] = address >> 8;
        buf[2] = address;
        buf.set(params.data, 3);
        this.sendCommand(this._CommandWrite, buf);
    }
    read(params, module) {
        let address = parseInt(params.address);
        if (params.address_bits === 10 || address > 0x7f) {
            address = address | 0x8000; // mark 10bit mode
        }
        let read_length = params.read;
        let buf = new Uint8Array(7);
        buf[0] = module;
        buf[1] = address >> 8;
        buf[2] = address;
        buf[3] = read_length >> (3 * 8);
        buf[4] = read_length >> (2 * 8);
        buf[5] = read_length >> (1 * 8);
        buf[6] = read_length;
        this.sendCommand(this._CommandRead, buf);
    }
    parseFromJson(json) {
        // 0
        for (let i = 0; i < 1; i++) {
            let module = json['i2c' + i];
            if (module === undefined) {
                continue;
            }
            let schemaData = [
                { uri: '/request/i2c/init_master', onValid: this.initMaster },
                { uri: '/request/i2c/init_slave', onValid: this.initSlave },
                { uri: '/request/i2c/write', onValid: this.write },
                { uri: '/request/i2c/read', onValid: this.read },
                { uri: '/request/i2c/deinit', onValid: this.deinit },
            ];
            let res = this.validateCommandSchema(schemaData, module, 'i2c' + i, i);
            if (res.valid === 0) {
                if (res.invalidButLike.length > 0) {
                    throw new Error(res.invalidButLike[0].message);
                }
                else {
                    throw new this.WSCommandNotFoundError(`[i2c${i}]unknown command`);
                }
            }
        }
    }
    notifyFromBinary(objToSend, func, payload) {
        if (func === this._CommandRead && payload.byteLength > 3) {
            let module_index = payload[0];
            let address = (payload[1] << 8) + payload[2];
            let arr = new Array(payload.byteLength - 3);
            for (let i = 0; i < arr.length; i++) {
                arr[i] = payload[i + 3];
            }
            objToSend['i2c' + module_index] = {
                mode: 'master',
                address: address,
                data: arr,
            };
        }
        else if (func === this._CommandSlvWritten && payload.byteLength > 4) {
            let module_index = payload[0];
            // let address_bit_length = payload[1];
            let address = (payload[2] << 8) + payload[3];
            let arr = new Array(payload.byteLength - 4);
            for (let i = 0; i < arr.length; i++) {
                arr[i] = payload[i + 4];
            }
            objToSend['i2c' + module_index] = {
                mode: 'slave',
                is_fragmented: true,
                address: address,
                data: arr,
            };
        }
        else if (func === this.COMMAND_FUNC_ID_ERROR && payload.byteLength > 2) {
            // const _esperr = payload[0];
            const err = payload[1];
            const ref_func_id = payload[2];
            if (ref_func_id === this._CommandWrite ||
                ref_func_id === this._CommandRead) {
                let reason = '' +
                    (ref_func_id === this._CommandWrite ? 'writing' : 'reading') +
                    ' error. ';
                if (err === 7) {
                    // in fact. it is 0x107. but truncated
                    reason += 'Communication Timeout. Maybe, target is not connected.';
                }
                else if (err === 255) {
                    reason += 'Communication Failed. Maybe, target is not connected.';
                }
                this.envelopError(objToSend, `i2c0`, { message: reason });
            }
            else {
                super.notifyFromBinary(objToSend, func, payload);
            }
        }
        else {
            super.notifyFromBinary(objToSend, func, payload);
        }
    }
}
module.exports = WSCommandI2C;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmRJMkMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUVwRCxNQUFNLFlBQWEsU0FBUSxTQUFTO0lBQ2xDO1FBQ0UsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUVoQixJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQztRQUN4QixJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsa0JBQWtCLEdBQUcsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxXQUFXO0lBRVgsVUFBVSxDQUFDLE1BQU0sRUFBRSxNQUFNO1FBQ3ZCLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztRQUNiLElBQUksR0FBRyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IsSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQixJQUFJLEtBQUssR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRW5DLElBQUksR0FBRyxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzVCLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDaEIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNkLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7UUFDYixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQ2IsR0FBRyxDQUFDLENB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dURBQXVELENBQUM7aUJBQ25FO2dCQUNELElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLE1BQU0sRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO2FBQzNEO2lCQUFNO2dCQUNMLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2FBQ2xEO1NBQ0Y7YUFBTTtZQUNMLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ2xEO0lBQ0gsQ0FBQztDQUNGO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxZQUFZLENBQUMiLCJmaWxlIjoib2JuaXovbGlicy93c2NvbW1hbmQvV1NDb21tYW5kSTJDLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgV1NDb21tYW5kID0gcmVxdWlyZSgnLi9XU0NvbW1hbmQuanMnKS5kZWZhdWx0O1xuXG5jbGFzcyBXU0NvbW1hbmRJMkMgZXh0ZW5kcyBXU0NvbW1hbmQge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMubW9kdWxlID0gNjtcblxuICAgIHRoaXMuX0NvbW1hbmRJbml0ID0gMDtcbiAgICB0aGlzLl9Db21tYW5kRGVpbml0ID0gMTtcbiAgICB0aGlzLl9Db21tYW5kV3JpdGUgPSAyO1xuICAgIHRoaXMuX0NvbW1hbmRSZWFkID0gMztcbiAgICB0aGlzLl9Db21tYW5kU2x2V3JpdHRlbiA9IDQ7XG4gIH1cblxuICAvLyBDb21tYW5kc1xuXG4gIGluaXRNYXN0ZXIocGFyYW1zLCBtb2R1bGUpIHtcbiAgICBsZXQgbW9kZSA9IDA7XG4gICAgbGV0IHNkYSA9IHBhcnNlSW50KHBhcmFtcy5zZGEpO1xuICAgIGxldCBzY2wgPSBwYXJzZUludChwYXJhbXMuc2NsKTtcbiAgICBsZXQgY2xvY2sgPSBwYXJzZUludChwYXJhbXMuY2xvY2spO1xuXG4gICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KDgpO1xuICAgIGJ1ZlswXSA9IG1vZHVsZTtcbiAgICBidWZbMV0gPSBtb2RlO1xuICAgIGJ1ZlsyXSA9IHNkYTtcbiAgICBidWZbM10gPSBzY2w7XG4gICAgYnVmWzRdID0gY2xvY2sgPj4gKDMgKiA4KTtcbiAgICBidWZbNV0gPSBjbG9jayA+PiAoMiAqIDgpO1xuICAgIGJ1Zls2XSA9IGNsb2NrID4+ICgxICogOCk7XG4gICAgYnVmWzddID0gY2xvY2s7XG5cbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRJbml0LCBidWYpO1xuICB9XG5cbiAgaW5pdFNsYXZlKHBhcmFtcywgbW9kdWxlKSB7XG4gICAgbGV0IG1vZGUgPSAxO1xuICAgIGxldCBzZGEgPSBwYXJzZUludChwYXJhbXMuc2RhKTtcbiAgICBsZXQgc2NsID0gcGFyc2VJbnQocGFyYW1zLnNjbCk7XG4gICAgbGV0IGNsb2NrID0gMDtcblxuICAgIGxldCBhZGRyZXNzTGVuZ3RoID0gcGFyYW1zLnNsYXZlX2FkZHJlc3NfbGVuZ3RoO1xuICAgIGxldCBhZGRyZXNzID0gcGFyYW1zLnNsYXZlX2FkZHJlc3M7XG4gICAgaWYgKGFkZHJlc3MgPiAweDdmKSB7XG4gICAgICBhZGRyZXNzTGVuZ3RoID0gMTA7XG4gICAgfVxuXG4gICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KDExKTtcbiAgICBidWZbMF0gPSBtb2R1bGU7XG4gICAgYnVmWzFdID0gbW9kZTtcbiAgICBidWZbMl0gPSBzZGE7XG4gICAgYnVmWzNdID0gc2NsO1xuICAgIGJ1Zls0XSA9IGNsb2NrID4+ICgzICogOCk7XG4gICAgYnVmWzVdID0gY2xvY2sgPj4gKDIgKiA4KTtcbiAgICBidWZbNl0gPSBjbG9jayA+PiAoMSAqIDgpO1xuICAgIGJ1Zls3XSA9IGNsb2NrO1xuICAgIGJ1Zls4XSA9IGFkZHJlc3NMZW5ndGg7XG4gICAgYnVmWzldID0gYWRkcmVzcyA+PiA4O1xuICAgIGJ1ZlsxMF0gPSBhZGRyZXNzO1xuXG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kSW5pdCwgYnVmKTtcbiAgfVxuXG4gIGRlaW5pdChwYXJhbXMsIG1vZHVsZSkge1xuICAgIGxldCBidWYgPSBuZXcgVWludDhBcnJheShbbW9kdWxlXSk7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kRGVpbml0LCBidWYpO1xuICB9XG5cbiAgd3JpdGUocGFyYW1zLCBtb2R1bGUpIHtcbiAgICBsZXQgYWRkcmVzcyA9IHBhcnNlSW50KHBhcmFtcy5hZGRyZXNzKTtcblxuICAgIGlmIChwYXJhbXMuYWRkcmVzc19iaXRzID09PSAxMCB8fCBhZGRyZXNzID4gMHg3Zikge1xuICAgICAgYWRkcmVzcyA9IGFkZHJlc3MgfCAweDgwMDA7IC8vIG1hcmsgMTBiaXQgbW9kZVxuICAgIH1cbiAgICBsZXQgYnVmID0gbmV3IFVpbnQ4QXJyYXkoMyArIHBhcmFtcy5kYXRhLmxlbmd0aCk7XG4gICAgYnVmWzBdID0gbW9kdWxlO1xuICAgIGJ1ZlsxXSA9IGFkZHJlc3MgPj4gODtcbiAgICBidWZbMl0gPSBhZGRyZXNzO1xuICAgIGJ1Zi5zZXQocGFyYW1zLmRhdGEsIDMpO1xuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZFdyaXRlLCBidWYpO1xuICB9XG5cbiAgcmVhZChwYXJhbXMsIG1vZHVsZSkge1xuICAgIGxldCBhZGRyZXNzID0gcGFyc2VJbnQocGFyYW1zLmFkZHJlc3MpO1xuXG4gICAgaWYgKHBhcmFtcy5hZGRyZXNzX2JpdHMgPT09IDEwIHx8IGFkZHJlc3MgPiAweDdmKSB7XG4gICAgICBhZGRyZXNzID0gYWRkcmVzcyB8IDB4ODAwMDsgLy8gbWFyayAxMGJpdCBtb2RlXG4gICAgfVxuICAgIGxldCByZWFkX2xlbmd0aCA9IHBhcmFtcy5yZWFkO1xuICAgIGxldCBidWYgPSBuZXcgVWludDhBcnJheSg3KTtcbiAgICBidWZbMF0gPSBtb2R1bGU7XG4gICAgYnVmWzFdID0gYWRkcmVzcyA+PiA4O1xuICAgIGJ1ZlsyXSA9IGFkZHJlc3M7XG4gICAgYnVmWzNdID0gcmVhZF9sZW5ndGggPj4gKDMgKiA4KTtcbiAgICBidWZbNF0gPSByZWFkX2xlbmd0aCA+PiAoMiAqIDgpO1xuICAgIGJ1Zls1XSA9IHJlYWRfbGVuZ3RoID4+ICgxICogOCk7XG4gICAgYnVmWzZdID0gcmVhZF9sZW5ndGg7XG4gICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kUmVhZCwgYnVmKTtcbiAgfVxuXG4gIHBhcnNlRnJvbUpzb24oanNvbikge1xuICAgIC8vIDBcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE7IGkrKykge1xuICAgICAgbGV0IG1vZHVsZSA9IGpzb25bJ2kyYycgKyBpXTtcbiAgICAgIGlmIChtb2R1bGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgbGV0IHNjaGVtYURhdGEgPSBbXG4gICAgICAgIHsgdXJpOiAnL3JlcXVlc3QvaTJjL2luaXRfbWFzdGVyJywgb25WYWxpZDogdGhpcy5pbml0TWFzdGVyIH0sXG4gICAgICAgIHsgdXJpOiAnL3JlcXVlc3QvaTJjL2luaXRfc2xhdmUnLCBvblZhbGlkOiB0aGlzLmluaXRTbGF2ZSB9LFxuICAgICAgICB7IHVyaTogJy9yZXF1ZXN0L2kyYy93cml0ZScsIG9uVmFsaWQ6IHRoaXMud3JpdGUgfSxcbiAgICAgICAgeyB1cmk6ICcvcmVxdWVzdC9pMmMvcmVhZCcsIG9uVmFsaWQ6IHRoaXMucmVhZCB9LFxuICAgICAgICB7IHVyaTogJy9yZXF1ZXN0L2kyYy9kZWluaXQnLCBvblZhbGlkOiB0aGlzLmRlaW5pdCB9LFxuICAgICAgXTtcbiAgICAgIGxldCByZXMgPSB0aGlzLnZhbGlkYXRlQ29tbWFuZFNjaGVtYShzY2hlbWFEYXRhLCBtb2R1bGUsICdpMmMnICsgaSwgaSk7XG5cbiAgICAgIGlmIChyZXMudmFsaWQgPT09IDApIHtcbiAgICAgICAgaWYgKHJlcy5pbnZhbGlkQnV0TGlrZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlcy5pbnZhbGlkQnV0TGlrZVswXS5tZXNzYWdlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgdGhpcy5XU0NvbW1hbmROb3RGb3VuZEVycm9yKGBbaTJjJHtpfV11bmtub3duIGNvbW1hbmRgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5vdGlmeUZyb21CaW5hcnkob2JqVG9TZW5kLCBmdW5jLCBwYXlsb2FkKSB7XG4gICAgaWYgKGZ1bmMgPT09IHRoaXMuX0NvbW1hbmRSZWFkICYmIHBheWxvYWQuYnl0ZUxlbmd0aCA+IDMpIHtcbiAgICAgIGxldCBtb2R1bGVfaW5kZXggPSBwYXlsb2FkWzBdO1xuICAgICAgbGV0IGFkZHJlc3MgPSAocGF5bG9hZFsxXSA8PCA4KSArIHBheWxvYWRbMl07XG5cbiAgICAgIGxldCBhcnIgPSBuZXcgQXJyYXkocGF5bG9hZC5ieXRlTGVuZ3RoIC0gMyk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykge1xuICAgICAgICBhcnJbaV0gPSBwYXlsb2FkW2kgKyAzXTtcbiAgICAgIH1cblxuICAgICAgb2JqVG9TZW5kWydpMmMnICsgbW9kdWxlX2luZGV4XSA9IHtcbiAgICAgICAgbW9kZTogJ21hc3RlcicsXG4gICAgICAgIGFkZHJlc3M6IGFkZHJlc3MsXG4gICAgICAgIGRhdGE6IGFycixcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmIChmdW5jID09PSB0aGlzLl9Db21tYW5kU2x2V3JpdHRlbiAmJiBwYXlsb2FkLmJ5dGVMZW5ndGggPiA0KSB7XG4gICAgICBsZXQgbW9kdWxlX2luZGV4ID0gcGF5bG9hZFswXTtcbiAgICAgIC8vIGxldCBhZGRyZXNzX2JpdF9sZW5ndGggPSBwYXlsb2FkWzFdO1xuICAgICAgbGV0IGFkZHJlc3MgPSAocGF5bG9hZFsyXSA8PCA4KSArIHBheWxvYWRbM107XG5cbiAgICAgIGxldCBhcnIgPSBuZXcgQXJyYXkocGF5bG9hZC5ieXRlTGVuZ3RoIC0gNCk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykge1xuICAgICAgICBhcnJbaV0gPSBwYXlsb2FkW2kgKyA0XTtcbiAgICAgIH1cblxuICAgICAgb2JqVG9TZW5kWydpMmMnICsgbW9kdWxlX2luZGV4XSA9IHtcbiAgICAgICAgbW9kZTogJ3NsYXZlJyxcbiAgICAgICAgaXNfZnJhZ21lbnRlZDogdHJ1ZSxcbiAgICAgICAgYWRkcmVzczogYWRkcmVzcyxcbiAgICAgICAgZGF0YTogYXJyLFxuICAgICAgfTtcbiAgICB9IGVsc2UgaWYgKGZ1bmMgPT09IHRoaXMuQ09NTUFORF9GVU5DX0lEX0VSUk9SICYmIHBheWxvYWQuYnl0ZUxlbmd0aCA+IDIpIHtcbiAgICAgIC8vIGNvbnN0IF9lc3BlcnIgPSBwYXlsb2FkWzBdO1xuICAgICAgY29uc3QgZXJyID0gcGF5bG9hZFsxXTtcbiAgICAgIGNvbnN0IHJlZl9mdW5jX2lkID0gcGF5bG9hZFsyXTtcblxuICAgICAgaWYgKFxuICAgICAgICByZWZfZnVuY19pZCA9PT0gdGhpcy5fQ29tbWFuZFdyaXRlIHx8XG4gICAgICAgIHJlZl9mdW5jX2lkID09PSB0aGlzLl9Db21tYW5kUmVhZFxuICAgICAgKSB7XG4gICAgICAgIGxldCByZWFzb24gPVxuICAgICAgICAgICcnICtcbiAgICAgICAgICAocmVmX2Z1bmNfaWQgPT09IHRoaXMuX0NvbW1hbmRXcml0ZSA/ICd3cml0aW5nJyA6ICdyZWFkaW5nJykgK1xuICAgICAgICAgICcgZXJyb3IuICc7XG4gICAgICAgIGlmIChlcnIgPT09IDcpIHtcbiAgICAgICAgICAvLyBpbiBmYWN0LiBpdCBpcyAweDEwNy4gYnV0IHRydW5jYXRlZFxuICAgICAgICAgIHJlYXNvbiArPSAnQ29tbXVuaWNhdGlvbiBUaW1lb3V0LiBNYXliZSwgdGFyZ2V0IGlzIG5vdCBjb25uZWN0ZWQuJztcbiAgICAgICAgfSBlbHNlIGlmIChlcnIgPT09IDI1NSkge1xuICAgICAgICAgIHJlYXNvbiArPSAnQ29tbXVuaWNhdGlvbiBGYWlsZWQuIE1heWJlLCB0YXJnZXQgaXMgbm90IGNvbm5lY3RlZC4nO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZW52ZWxvcEVycm9yKG9ialRvU2VuZCwgYGkyYzBgLCB7IG1lc3NhZ2U6IHJlYXNvbiB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN1cGVyLm5vdGlmeUZyb21CaW5hcnkob2JqVG9TZW5kLCBmdW5jLCBwYXlsb2FkKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgc3VwZXIubm90aWZ5RnJvbUJpbmFyeShvYmpUb1NlbmQsIGZ1bmMsIHBheWxvYWQpO1xuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFdTQ29tbWFuZEkyQztcbiJdfQ==

"use strict";
const WSCommand = require('./WSCommand.js').default;
class WSCommandSPI extends WSCommand {
    constructor() {
        super();
        this.module = 5;
        this._CommandInit = 0;
        this._CommandDeinit = 1;
        this._CommandWriteRead = 2;
        this._CommandWrite = 3;
    }
    // Commands
    initMaster(params, module) {
        let mode = 0; //master mode
        let clk = params.clk;
        let mosi = params.mosi;
        let miso = params.miso;
        let cs = params.cs;
        let clock = params.clock;
        if (clk === null && mosi === null && miso === null) {
            throw new Error('spi: master mode require one of clk/mosi/miso');
        }
        if (clk === null) {
            clk = this.ioNotUsed;
        }
        if (mosi === null) {
            mosi = this.ioNotUsed;
        }
        if (miso === null) {
            miso = this.ioNotUsed;
        }
        if (cs === null) {
            cs = this.ioNotUsed;
        }
        let buf = new Uint8Array(11);
        buf[0] = module;
        buf[1] = mode;
        buf[2] = clk;
        buf[3] = mosi;
        buf[4] = miso;
        buf[5] = this.ioNotUsed; //wp
        buf[6] = this.ioNotUsed; // hd
        buf[7] = clock >> (3 * 8);
        buf[8] = clock >> (2 * 8);
        buf[9] = clock >> (1 * 8);
        buf[10] = clock;
        buf[11] = cs;
        this.sendCommand(this._CommandInit, buf);
    }
    deinit(params, module) {
        let buf = new Uint8Array([module]);
        this.sendCommand(this._CommandDeinit, buf);
    }
    write(params, module) {
        let buf = new Uint8Array(1 + params.data.length);
        buf[0] = module;
        buf.set(params.data, 1);
        if (params.read) {
            this.sendCommand(this._CommandWriteRead, buf);
        }
        else {
            this.sendCommand(this._CommandWrite, buf);
        }
    }
    parseFromJson(json) {
        for (let i = 0; i < 2; i++) {
            let module = json['spi' + i];
            if (module === undefined) {
                continue;
            }
            let schemaData = [
                { uri: '/request/spi/init_master', onValid: this.initMaster },
                { uri: '/request/spi/write', onValid: this.write },
                { uri: '/request/spi/deinit', onValid: this.deinit },
            ];
            let res = this.validateCommandSchema(schemaData, module, 'spi' + i, i);
            if (res.valid === 0) {
                if (res.invalidButLike.length > 0) {
                    throw new Error(res.invalidButLike[0].message);
                }
                else {
                    throw new this.WSCommandNotFoundError(`[spi${i}]unknown command`);
                }
            }
        }
    }
    notifyFromBinary(objToSend, func, payload) {
        if (func === this._CommandWriteRead && payload.byteLength > 1) {
            let module_index = payload[0];
            // var received = payload.slice(1);
            let arr = new Array(payload.byteLength - 1);
            for (let i = 0; i < arr.length; i++) {
                arr[i] = payload[i + 1];
            }
            objToSend['spi' + module_index] = {
                data: arr,
            };
        }
        else {
            super.notifyFromBinary(objToSend, func, payload);
        }
    }
}
module.exports = WSCommandSPI;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmRTUEkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUVwRCxNQUFNLFlBQWEsU0FBUSxTQUFTO0lBQ2xDO1FBQ0UsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUVoQixJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQztRQUN4QixJQUFJLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDO1FBQzNCLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxXQUFXO0lBRVgsVUFBVSxDQUFDLE1BQU0sRUFBRSxNQUFNO1FBQ3ZCLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLGFBQWE7UUFFM0IsSUFBSSxHQUFHLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUNyQixJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ3ZCLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDdkIsSUFBSSxFQUFFLEdBQUcsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUVuQixJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDO1FBRXpCLElBQUksR0FBRyxLQUFLLElBQUksSUFBSSxJQUFJLEtBQUssSUFBSSxJQUFJLElBQUksS0FBSyxJQUFJLEVBQUU7WUFDbEQsTUFBTSxJQUFJLEtBQUssQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO1NBQ2xFO1FBRUQsSUFBSSxHQUFHLEtBQUssSUFBSSxFQUFFO1lBQ2hCLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1NBQ3RCO1FBQ0QsSUFBSSxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQ2pCLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1NBQ3ZCO1FBQ0QsSUFBSSxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQ2pCLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1NBQ3ZCO1FBQ0QsSUFBSSxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ2YsRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7U0FDckI7UUFFRCxJQUFJLEdBQUcsR0FBRyxJQUFJLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM3QixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDO1FBQ2hCLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDZCxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQ2IsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNkLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDZCxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUk7UUFDN0IsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLO1FBQzlCLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDMUIsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUMxQixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzFCLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDaEIsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUViLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksRUFB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WSxDQUFDLEdBQUc7Z0JBQ2hDLElBQUksRUFBRSxHQUFHO2FBQ1YsQ0FBQztTQUNIO2FBQU07WUFDTCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztTQUNsRDtJQUNILENBQUM7Q0FDRjtBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsWUFBWSxDQUFDIiwiZmlsZSI6Im9ibml6L2xpYnMvd3Njb21tYW5kL1dTQ29tbWFuZFNQSS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFdTQ29tbWFuZCA9IHJlcXVpcmUoJy4vV1NDb21tYW5kLmpzJykuZGVmYXVsdDtcblxuY2xhc3MgV1NDb21tYW5kU1BJIGV4dGVuZHMgV1NDb21tYW5kIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLm1vZHVsZSA9IDU7XG5cbiAgICB0aGlzLl9Db21tYW5kSW5pdCA9IDA7XG4gICAgdGhpcy5fQ29tbWFuZERlaW5pdCA9IDE7XG4gICAgdGhpcy5fQ29tbWFuZFdyaXRlUmVhZCA9IDI7XG4gICAgdGhpcy5fQ29tbWFuZFdyaXRlID0gMztcbiAgfVxuXG4gIC8vIENvbW1hbmRzXG5cbiAgaW5pdE1hc3RlcihwYXJhbXMsIG1vZHVsZSkge1xuICAgIGxldCBtb2RlID0gMDsgLy9tYXN0ZXIgbW9kZVxuXG4gICAgbGV0IGNsayA9IHBhcmFtcy5jbGs7XG4gICAgbGV0IG1vc2kgPSBwYXJhbXMubW9zaTtcbiAgICBsZXQgbWlzbyA9IHBhcmFtcy5taXNvO1xuICAgIGxldCBjcyA9IHBhcmFtcy5jcztcblxuICAgIGxldCBjbG9jayA9IHBhcmFtcy5jbG9jaztcblxuICAgIGlmIChjbGsgPT09IG51bGwgJiYgbW9zaSA9PT0gbnVsbCAmJiBtaXNvID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NwaTogbWFzdGVyIG1vZGUgcmVxdWlyZSBvbmUgb2YgY2xrL21vc2kvbWlzbycpO1xuICAgIH1cblxuICAgIGlmIChjbGsgPT09IG51bGwpIHtcbiAgICAgIGNsayA9IHRoaXMuaW9Ob3RVc2VkO1xuICAgIH1cbiAgICBpZiAobW9zaSA9PT0gbnVsbCkge1xuICAgICAgbW9zaSA9IHRoaXMuaW9Ob3RVc2VkO1xuICAgIH1cbiAgICBpZiAobWlzbyA9PT0gbnVsbCkge1xuICAgICAgbWlzbyA9IHRoaXMuaW9Ob3RVc2VkO1xuICAgIH1cbiAgICBpZiAoY3MgPT09IG51bGwpIHtcbiAgICAgIGNzID0gdGhpcy5pb05vdFVzZWQ7XG4gICAgfVxuXG4gICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KDExKTtcbiAgICBidWZbMF0gPSBtb2R1bGU7XG4gICAgYnVmWzFdID0gbW9kZTtcbiAgICBidWZbMl0gPSBjbGs7XG4gICAgYnVmWzNdID0gbW9zaTtcbiAgICBidWZbNF0gPSBtaXNvO1xuICAgIGJ1Zls1XSA9IHRoaXMuaW9Ob3RVc2VkOyAvL3dwXG4gICAgYnVmWzZdID0gdGhpcy5pb05vdFVzZWQ7IC8vIGhkXG4gICAgYnVmWzddID0gY2xvY2sgPj4gKDMgKiA4KTtcbiAgICBidWZbOF0gPSBjbG9jayA+PiAoMiAqIDgpO1xuICAgIGJ1Zls5XSA9IGNsb2NrID4+ICgxICogOCk7XG4gICAgYnVmWzEwXSA9IGNsb2NrO1xuICAgIGJ1ZlsxMV0gPSBjcztcblxuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZEluaXQsIGJ1Zik7XG4gIH1cblxuICBkZWluaXQocGFyYW1zLCBtb2R1bGUpIHtcbiAgICBsZXQgYnVmID0gbmV3IFVpbnQ4QXJyYXkoW21vZHVsZV0pO1xuICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZERlaW5pdCwgYnVmKTtcbiAgfVxuXG4gIHdyaXRlKHBhcmFtcywgbW9kdWxlKSB7XG4gICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KDEgKyBwYXJhbXMuZGF0YS5sZW5ndGgpO1xuICAgIGJ1ZlswXSA9IG1vZHVsZTtcbiAgICBidWYuc2V0KHBhcmFtcy5kYXRhLCAxKTtcbiAgICBpZiAocGFyYW1zLnJlYWQpIHtcbiAgICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZFdyaXRlUmVhZCwgYnVmKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kV3JpdGUsIGJ1Zik7XG4gICAgfVxuICB9XG5cbiAgcGFyc2VGcm9tSnNvbihqc29uKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyOyBpKyspIHtcbiAgICAgIGxldCBtb2R1bGUgPSBqc29uWydzcGknICsgaV07XG4gICAgICBpZiAobW9kdWxlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGxldCBzY2hlbWFEYXRhID0gW1xuICAgICAgICB7IHVyaTogJy9yZXF1ZXN0L3NwaS9pbml0X21hc3RlcicsIG9uVmFsaWQ6IHRoaXMuaW5pdE1hc3RlciB9LFxuICAgICAgICB7IHVyaTogJy9yZXF1ZXN0L3NwaS93cml0ZScsIG9uVmFsaWQ6IHRoaXMud3JpdGUgfSxcbiAgICAgICAgeyB1cmk6ICcvcmVxdWVzdC9zcGkvZGVpbml0Jywgb25WYWxpZDogdGhpcy5kZWluaXQgfSxcbiAgICAgIF07XG4gICAgICBsZXQgcmVzID0gdGhpcy52YWxpZGF0ZUNvbW1hbmRTY2hlbWEoc2NoZW1hRGF0YSwgbW9kdWxlLCAnc3BpJyArIGksIGkpO1xuXG4gICAgICBpZiAocmVzLnZhbGlkID09PSAwKSB7XG4gICAgICAgIGlmIChyZXMuaW52YWxpZEJ1dExpa2UubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihyZXMuaW52YWxpZEJ1dExpa2VbMF0ubWVzc2FnZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IHRoaXMuV1NDb21tYW5kTm90Rm91bmRFcnJvcihgW3NwaSR7aX1ddW5rbm93biBjb21tYW5kYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBub3RpZnlGcm9tQmluYXJ5KG9ialRvU2VuZCwgZnVuYywgcGF5bG9hZCkge1xuICAgIGlmIChmdW5jID09PSB0aGlzLl9Db21tYW5kV3JpdGVSZWFkICYmIHBheWxvYWQuYnl0ZUxlbmd0aCA+IDEpIHtcbiAgICAgIGxldCBtb2R1bGVfaW5kZXggPSBwYXlsb2FkWzBdO1xuICAgICAgLy8gdmFyIHJlY2VpdmVkID0gcGF5bG9hZC5zbGljZSgxKTtcblxuICAgICAgbGV0IGFyciA9IG5ldyBBcnJheShwYXlsb2FkLmJ5dGVMZW5ndGggLSAxKTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGFycltpXSA9IHBheWxvYWRbaSArIDFdO1xuICAgICAgfVxuICAgICAgb2JqVG9TZW5kWydzcGknICsgbW9kdWxlX2luZGV4XSA9IHtcbiAgICAgICAgZGF0YTogYXJyLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3VwZXIubm90aWZ5RnJvbUJpbmFyeShvYmpUb1NlbmQsIGZ1bmMsIHBheWxvYWQpO1xuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFdTQ29tbWFuZFNQSTtcbiJdfQ==

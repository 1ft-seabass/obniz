"use strict";
const WSCommand = require('./WSCommand.js').default;
const ObnizUtil = require('../utils/util');
const semver = require('semver');
module.exports = class WSCommandDirective extends WSCommand {
    constructor() {
        super();
        this.module = 1;
        this._CommandRegistrate = 0;
        this._CommandPause = 1;
        this._CommandResume = 2;
        this._CommandNotify = 3;
        const CommandIO = require('./WSCommandIO');
        const CommandPWM = require('./WSCommandPWM');
        this.availableCommands = [new CommandIO(), new CommandPWM()];
    }
    // Commands
    init(params, originalParams) {
        const nameArray = ObnizUtil.string2dataArray(params.animation.name);
        let frame, offset = 0;
        if (semver.lt(this._hw.firmware, '2.0.0')) {
            // < 2.0.0
            frame = new Uint8Array(1 + nameArray.length + 1);
            // name //
            frame[offset++] = nameArray.length + 1;
            frame.set(nameArray, offset);
            offset += nameArray.length;
            frame[offset++] = 0; // null string
            if (params.animation.status === 'registrate' ||
                typeof params.animation.repeat === 'number') {
                throw new Error('you need to update your firmware >= 2.0.0');
            }
        }
        else {
            frame = new Uint8Array(1 + nameArray.length + 1 + 1 + 4);
            // name //
            frame[offset++] = nameArray.length + 1;
            frame.set(nameArray, offset);
            offset += nameArray.length;
            frame[offset++] = 0; // null string
            // type and count //
            let type = 0, repeat_count = 0;
            if (params.animation.status === 'loop') {
                type = 1; // auto start
            }
            if (typeof params.animation.repeat === 'number') {
                repeat_count = params.animation.repeat;
                type += 2;
            }
            frame[offset++] = type;
            frame[offset++] = repeat_count >> (8 * 3);
            frame[offset++] = repeat_count >> (8 * 2);
            frame[offset++] = repeat_count >> (8 * 1);
            frame[offset++] = repeat_count;
        }
        const commandJsonArray = params.animation.states;
        for (let i = 0; i < commandJsonArray.length; i++) {
            const obj = commandJsonArray[i];
            const duration = parseInt(obj.duration * 1000);
            const state = obj.state;
            // Dry run commands
            let parsedCommands = JSON.parse(JSON.stringify(state));
            if (!Array.isArray(parsedCommands)) {
                parsedCommands = [parsedCommands];
            }
            let compressed = null;
            for (let commandIndex = 0; commandIndex < parsedCommands.length; commandIndex++) {
                const frame = WSCommand.compress(this.availableCommands, parsedCommands[commandIndex]);
                if (!frame) {
                    throw new Error('[io.animation.states.state]only io or pwm commands. Pleave provide state at least one of them.');
                }
                if (compressed) {
                    let combined = new Uint8Array(compressed.length + frame.length);
                    combined.set(compressed, 0);
                    combined.set(frame, compressed.length);
                    compressed = combined;
                }
                else {
                    compressed = frame;
                }
            }
            if (!compressed) {
                throw new Error('[io.animation.states.state]only io or pwm commands. Pleave provide state at least one of them.');
            }
            const length = compressed.byteLength;
            let commandHeader = new Uint8Array(8);
            commandHeader[0] = length >> (8 * 3);
            commandHeader[1] = length >> (8 * 2);
            commandHeader[2] = length >> (8 * 1);
            commandHeader[3] = length;
            commandHeader[4] = duration >> (8 * 3);
            commandHeader[5] = duration >> (8 * 2);
            commandHeader[6] = duration >> (8 * 1);
            commandHeader[7] = duration;
            const combined = new Uint8Array(frame.byteLength + commandHeader.byteLength + compressed.byteLength);
            combined.set(frame, 0);
            combined.set(commandHeader, frame.byteLength);
            combined.set(compressed, frame.byteLength + commandHeader.byteLength);
            frame = combined;
        }
        if (frame.byteLength > 1000) {
            // 1kbyte over
            throw new Error('[io.animation]Too big animation datas');
        }
        this.sendCommand(this._CommandRegistrate, frame);
    }
    changeState(params) {
        if (params.animation.status === 'resume') {
            const nameArray = ObnizUtil.string2dataArray(params.animation.name);
            let frame = new Uint8Array(nameArray.length + 2);
            frame[0] = nameArray.length + 1;
            frame.set(nameArray, 1);
            frame[frame.byteLength - 1] = 0;
            this.sendCommand(this._CommandResume, frame);
        }
        else if (params.animation.status === 'pause') {
            const nameArray = ObnizUtil.string2dataArray(params.animation.name);
            let frame = new Uint8Array(nameArray.length + 2);
            frame[0] = nameArray.length + 1;
            frame.set(nameArray, 1);
            frame[frame.byteLength - 1] = 0;
            this.sendCommand(this._CommandPause, frame);
        }
    }
    parseFromJson(json) {
        let parentCommandNotFound = false;
        try {
            super.parseFromJson(json);
        }
        catch (err) {
            if (err instanceof this.WSCommandNotFoundError) {
                parentCommandNotFound = true;
            }
            else {
                throw err;
            }
        }
        const module = json.io;
        if (module === undefined) {
            return;
        }
        const schemaData = [
            { uri: '/request/ioAnimation/init', onValid: this.init },
            { uri: '/request/ioAnimation/changeState', onValid: this.changeState },
        ];
        const res = this.validateCommandSchema(schemaData, module, 'io', module);
        if (res.valid === 0 && parentCommandNotFound) {
            if (res.invalidButLike.length > 0) {
                throw new Error(res.invalidButLike[0].message);
            }
            else {
                let WSCommandNotFoundError = this.WSCommandNotFoundError;
                throw new WSCommandNotFoundError(`[io.animation]unknown command`);
            }
        }
    }
    notifyFromBinary(objToSend, func, payload) {
        if (func === this._CommandNotify) {
            const name = ObnizUtil.dataArray2string(payload.slice(2, payload.byteLength - 1)); // remove null string
            objToSend.io = {
                animation: {
                    name,
                    status: 'finish',
                },
            };
        }
        else {
            super.notifyFromBinary(objToSend, func, payload);
        }
    }
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL3dzY29tbWFuZC9XU0NvbW1hbmREaXJlY3RpdmUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUNwRCxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDM0MsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRWpDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsTUFBTSxrQkFBbUIsU0FBUSxTQUFTO0lBQ3pEO1FBQ0UsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUVoQixJQUFJLENBQUMsa0JBQWtCLEdBQUcsQ0FBQyxDQUFDO1FBQzVCLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQyxDQUFDO1FBRXhCLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUMzQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUU3QyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxJQUFJLFNBQVMsRUFBRSxFQUFFLElBQUksVUFBVSxFQUFFLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBRUQsV0FBVztJQUVYLElBQUksQ0FBQyxNQUFNLEVBQUUsY0FBYztRQUN6QixNQUFNLFNBQVMsR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwRSxJQUFJLEtBQUssRUFDUCxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsSUFBSSxNQUFNLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxFQUFFO1lBQ3pDLFVBQVU7WUFDVixLQUFLLEdBQUcsSUFBSSxVQUFVLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDakQsVUFBVTtZQUNWLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZDLEtBQUssQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQzdCLE1BQU0sSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFDO1lBQzNCLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLGNBQWM7WUFDbkMsSUFDRSxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sS0FBSyxZQUFZO2dCQUN4QyxPQUFPLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxLQUFLLFFBQVEsRUFDM0M7Z0JBQ0EsTUFBTSxJQUFJLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO2FBQzlEO1NBQ0Y7YUFBTTtZQUNMLEtBQUssR0FBRyxJQUFJLFVBQVUsQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3pELFVBQVU7WUFDVixLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztZQUN2QyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUM3QixNQUFNLElBQUksU0FBUyxDQUFDLE1BQU0sQ0FBQztZQUMzQixLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxjQUFjO1lBQ25DLG9CQUFvQjtZQUNwQixJQUFJLElBQUksR0FBRyxDQUFDLEVBQ1YsWUFBWSxHQUFHLENBQUMsQ0FBQztZQUNuQixJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxLQUFLLE1BQU0sRUFBRTtnQkFDdEMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLGFBQWE7YUFDeEI7WUFDRCxJQUFJLE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEtBQUssUUFBUSxFQUFFO2dCQUMvQyxZQUFZLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7Z0JBQ3ZDLElBQUksSUFBSSxDQUFDLENBQUM7YUFDWDtZQUNELEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztZQUN2QixLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxZQUFZLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDMUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsWUFBWSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLFlBQVksSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxZQUFZLENBQUM7U0FDaEM7UUFFRCxNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDO1FBRWpELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDaEQsTUFBTSxHQUFHLEdBQUcsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEMsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLENBQUM7WUFDL0MsTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQztZQUV4QixtQkFBbUI7WUFDbkIsSUFBSSxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDdkQsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEVBQUU7Z0JBQ2xDLGNBQWMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO2FBQ25DO1lBQ0QsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBQ3RCLEtBQ0UsSUFBSSxZQUFZLEdBQUcsQ0FBQyxFQUNwQixZQUFZLEdBQUcsY0FBYyxDQUFDLE1BQU0sRUFDcEMsWUFBWSxFQUFFLEVBQ2Q7Z0JBQ0EsTUFBTSxLQUFLLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FDOUIsSUFBSSxDQUFDLGlCQUFpQixFQUN0QixjQUFjLENBQUMsWUFBWSxDQUFDLENBQzdCLENBQUM7Z0JBQ0YsSUFBSSxDQUFDLEtBQUssRUFBRTtvQkFDVixNQUFNLElBQUksS0FBSyxDQUNiLGdHQUFnRyxDQUNqRyxDQUFDO2lCQUNIO2dCQUNELElBQUksVUFBVSxFQUFFO29CQUNkLElBQUksUUFBUSxHQUFHLElBQUksVUFBVSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNoRSxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDNUIsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUN2QyxVQUFVLEdBQUcsUUFBUSxDQUFDO2lCQUN2QjtxQkFBTTtvQkFDTCxVQUFVLEdBQUcsS0FBSyxDQUFDO2lCQUNwQjthQUNGO1lBQ0QsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDZixNQUFNLElBQUksS0FBSyxDQUNiLGdHQUFnRyxDQUNqRyxDQUFDO2FBQ0g7WUFDRCxNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsVUFBVSxDQUFDO1lBRXJDLElBQUksYUFBYSxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLGFBQWEsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDckMsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNyQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLGFBQWEsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7WUFDMUIsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN2QyxhQUFhLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3ZDLGFBQWEsQ0FBQyxDQUFDLENBQUMsR0FBRyxRQUFRLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDdkMsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQztZQUU1QixNQUFNLFFBQVEsR0FBRyxJQUFJLFVBQVUsQ0FDN0IsS0FBSyxDQUFDLFVBQVUsR0FBRyxhQUFhLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQ3BFLENBQUM7WUFDRixRQUFRLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN2QixRQUFRLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDOUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLFVBQVUsR0FBRyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7WUFFdEUsS0FBSyxHQUFHLFFBQVEsQ0FBQztTQUNsQjtRQUVELElBQUksS0FBSyxDQUFDLFVBQVUsR0FBRyxJQUFJLEVBQUU7WUFDM0IsY0FBYztZQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLENBQUMsQ0FBQztTQUMxRDtRQUVELElBQUksQ0FBQyxXQUFXLENBQUMsSUFB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K0IsQ0FBQyxDQUFDO2FBQ25FO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxPQUFPO1FBQ3ZDLElBQUksSUFBSSxLQUFLLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDaEMsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLGdCQUFnQixDQUNyQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUN6QyxDQUFDLENBQUMscUJBQXFCO1lBRXhCLFNBQVMsQ0FBQyxFQUFFLEdBQUc7Z0JBQ2IsU0FBUyxFQUFFO29CQUNULElBQUk7b0JBQ0osTUFBTSxFQUFFLFFBQVE7aUJBQ2pCO2FBQ0YsQ0FBQztTQUNIO2FBQU07WUFDTCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztTQUNsRDtJQUNILENBQUM7Q0FDRixDQUFDIiwiZmlsZSI6Im9ibml6L2xpYnMvd3Njb21tYW5kL1dTQ29tbWFuZERpcmVjdGl2ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFdTQ29tbWFuZCA9IHJlcXVpcmUoJy4vV1NDb21tYW5kLmpzJykuZGVmYXVsdDtcbmNvbnN0IE9ibml6VXRpbCA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWwnKTtcbmNvbnN0IHNlbXZlciA9IHJlcXVpcmUoJ3NlbXZlcicpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGNsYXNzIFdTQ29tbWFuZERpcmVjdGl2ZSBleHRlbmRzIFdTQ29tbWFuZCB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5tb2R1bGUgPSAxO1xuXG4gICAgdGhpcy5fQ29tbWFuZFJlZ2lzdHJhdGUgPSAwO1xuICAgIHRoaXMuX0NvbW1hbmRQYXVzZSA9IDE7XG4gICAgdGhpcy5fQ29tbWFuZFJlc3VtZSA9IDI7XG4gICAgdGhpcy5fQ29tbWFuZE5vdGlmeSA9IDM7XG5cbiAgICBjb25zdCBDb21tYW5kSU8gPSByZXF1aXJlKCcuL1dTQ29tbWFuZElPJyk7XG4gICAgY29uc3QgQ29tbWFuZFBXTSA9IHJlcXVpcmUoJy4vV1NDb21tYW5kUFdNJyk7XG5cbiAgICB0aGlzLmF2YWlsYWJsZUNvbW1hbmRzID0gW25ldyBDb21tYW5kSU8oKSwgbmV3IENvbW1hbmRQV00oKV07XG4gIH1cblxuICAvLyBDb21tYW5kc1xuXG4gIGluaXQocGFyYW1zLCBvcmlnaW5hbFBhcmFtcykge1xuICAgIGNvbnN0IG5hbWVBcnJheSA9IE9ibml6VXRpbC5zdHJpbmcyZGF0YUFycmF5KHBhcmFtcy5hbmltYXRpb24ubmFtZSk7XG4gICAgbGV0IGZyYW1lLFxuICAgICAgb2Zmc2V0ID0gMDtcbiAgICBpZiAoc2VtdmVyLmx0KHRoaXMuX2h3LmZpcm13YXJlLCAnMi4wLjAnKSkge1xuICAgICAgLy8gPCAyLjAuMFxuICAgICAgZnJhbWUgPSBuZXcgVWludDhBcnJheSgxICsgbmFtZUFycmF5Lmxlbmd0aCArIDEpO1xuICAgICAgLy8gbmFtZSAvL1xuICAgICAgZnJhbWVbb2Zmc2V0KytdID0gbmFtZUFycmF5Lmxlbmd0aCArIDE7XG4gICAgICBmcmFtZS5zZXQobmFtZUFycmF5LCBvZmZzZXQpO1xuICAgICAgb2Zmc2V0ICs9IG5hbWVBcnJheS5sZW5ndGg7XG4gICAgICBmcmFtZVtvZmZzZXQrK10gPSAwOyAvLyBudWxsIHN0cmluZ1xuICAgICAgaWYgKFxuICAgICAgICBwYXJhbXMuYW5pbWF0aW9uLnN0YXR1cyA9PT0gJ3JlZ2lzdHJhdGUnIHx8XG4gICAgICAgIHR5cGVvZiBwYXJhbXMuYW5pbWF0aW9uLnJlcGVhdCA9PT0gJ251bWJlcidcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3lvdSBuZWVkIHRvIHVwZGF0ZSB5b3VyIGZpcm13YXJlID49IDIuMC4wJyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGZyYW1lID0gbmV3IFVpbnQ4QXJyYXkoMSArIG5hbWVBcnJheS5sZW5ndGggKyAxICsgMSArIDQpO1xuICAgICAgLy8gbmFtZSAvL1xuICAgICAgZnJhbWVbb2Zmc2V0KytdID0gbmFtZUFycmF5Lmxlbmd0aCArIDE7XG4gICAgICBmcmFtZS5zZXQobmFtZUFycmF5LCBvZmZzZXQpO1xuICAgICAgb2Zmc2V0ICs9IG5hbWVBcnJheS5sZW5ndGg7XG4gICAgICBmcmFtZVtvZmZzZXQrK10gPSAwOyAvLyBudWxsIHN0cmluZ1xuICAgICAgLy8gdHlwZSBhbmQgY291bnQgLy9cbiAgICAgIGxldCB0eXBlID0gMCxcbiAgICAgICAgcmVwZWF0X2NvdW50ID0gMDtcbiAgICAgIGlmIChwYXJhbXMuYW5pbWF0aW9uLnN0YXR1cyA9PT0gJ2xvb3AnKSB7XG4gICAgICAgIHR5cGUgPSAxOyAvLyBhdXRvIHN0YXJ0XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIHBhcmFtcy5hbmltYXRpb24ucmVwZWF0ID09PSAnbnVtYmVyJykge1xuICAgICAgICByZXBlYXRfY291bnQgPSBwYXJhbXMuYW5pbWF0aW9uLnJlcGVhdDtcbiAgICAgICAgdHlwZSArPSAyO1xuICAgICAgfVxuICAgICAgZnJhbWVbb2Zmc2V0KytdID0gdHlwZTtcbiAgICAgIGZyYW1lW29mZnNldCsrXSA9IHJlcGVhdF9jb3VudCA+PiAoOCAqIDMpO1xuICAgICAgZnJhbWVbb2Zmc2V0KytdID0gcmVwZWF0X2NvdW50ID4+ICg4ICogMik7XG4gICAgICBmcmFtZVtvZmZzZXQrK10gPSByZXBlYXRfY291bnQgPj4gKDggKiAxKTtcbiAgICAgIGZyYW1lW29mZnNldCsrXSA9IHJlcGVhdF9jb3VudDtcbiAgICB9XG5cbiAgICBjb25zdCBjb21tYW5kSnNvbkFycmF5ID0gcGFyYW1zLmFuaW1hdGlvbi5zdGF0ZXM7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbW1hbmRKc29uQXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IG9iaiA9IGNvbW1hbmRKc29uQXJyYXlbaV07XG4gICAgICBjb25zdCBkdXJhdGlvbiA9IHBhcnNlSW50KG9iai5kdXJhdGlvbiAqIDEwMDApO1xuICAgICAgY29uc3Qgc3RhdGUgPSBvYmouc3RhdGU7XG5cbiAgICAgIC8vIERyeSBydW4gY29tbWFuZHNcbiAgICAgIGxldCBwYXJzZWRDb21tYW5kcyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoc3RhdGUpKTtcbiAgICAgIGlmICghQXJyYXkuaXNBcnJheShwYXJzZWRDb21tYW5kcykpIHtcbiAgICAgICAgcGFyc2VkQ29tbWFuZHMgPSBbcGFyc2VkQ29tbWFuZHNdO1xuICAgICAgfVxuICAgICAgbGV0IGNvbXByZXNzZWQgPSBudWxsO1xuICAgICAgZm9yIChcbiAgICAgICAgbGV0IGNvbW1hbmRJbmRleCA9IDA7XG4gICAgICAgIGNvbW1hbmRJbmRleCA8IHBhcnNlZENvbW1hbmRzLmxlbmd0aDtcbiAgICAgICAgY29tbWFuZEluZGV4KytcbiAgICAgICkge1xuICAgICAgICBjb25zdCBmcmFtZSA9IFdTQ29tbWFuZC5jb21wcmVzcyhcbiAgICAgICAgICB0aGlzLmF2YWlsYWJsZUNvbW1hbmRzLFxuICAgICAgICAgIHBhcnNlZENvbW1hbmRzW2NvbW1hbmRJbmRleF1cbiAgICAgICAgKTtcbiAgICAgICAgaWYgKCFmcmFtZSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICdbaW8uYW5pbWF0aW9uLnN0YXRlcy5zdGF0ZV1vbmx5IGlvIG9yIHB3bSBjb21tYW5kcy4gUGxlYXZlIHByb3ZpZGUgc3RhdGUgYXQgbGVhc3Qgb25lIG9mIHRoZW0uJ1xuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvbXByZXNzZWQpIHtcbiAgICAgICAgICBsZXQgY29tYmluZWQgPSBuZXcgVWludDhBcnJheShjb21wcmVzc2VkLmxlbmd0aCArIGZyYW1lLmxlbmd0aCk7XG4gICAgICAgICAgY29tYmluZWQuc2V0KGNvbXByZXNzZWQsIDApO1xuICAgICAgICAgIGNvbWJpbmVkLnNldChmcmFtZSwgY29tcHJlc3NlZC5sZW5ndGgpO1xuICAgICAgICAgIGNvbXByZXNzZWQgPSBjb21iaW5lZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb21wcmVzc2VkID0gZnJhbWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghY29tcHJlc3NlZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ1tpby5hbmltYXRpb24uc3RhdGVzLnN0YXRlXW9ubHkgaW8gb3IgcHdtIGNvbW1hbmRzLiBQbGVhdmUgcHJvdmlkZSBzdGF0ZSBhdCBsZWFzdCBvbmUgb2YgdGhlbS4nXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBjb25zdCBsZW5ndGggPSBjb21wcmVzc2VkLmJ5dGVMZW5ndGg7XG5cbiAgICAgIGxldCBjb21tYW5kSGVhZGVyID0gbmV3IFVpbnQ4QXJyYXkoOCk7XG4gICAgICBjb21tYW5kSGVhZGVyWzBdID0gbGVuZ3RoID4+ICg4ICogMyk7XG4gICAgICBjb21tYW5kSGVhZGVyWzFdID0gbGVuZ3RoID4+ICg4ICogMik7XG4gICAgICBjb21tYW5kSGVhZGVyWzJdID0gbGVuZ3RoID4+ICg4ICogMSk7XG4gICAgICBjb21tYW5kSGVhZGVyWzNdID0gbGVuZ3RoO1xuICAgICAgY29tbWFuZEhlYWRlcls0XSA9IGR1cmF0aW9uID4+ICg4ICogMyk7XG4gICAgICBjb21tYW5kSGVhZGVyWzVdID0gZHVyYXRpb24gPj4gKDggKiAyKTtcbiAgICAgIGNvbW1hbmRIZWFkZXJbNl0gPSBkdXJhdGlvbiA+PiAoOCAqIDEpO1xuICAgICAgY29tbWFuZEhlYWRlcls3XSA9IGR1cmF0aW9uO1xuXG4gICAgICBjb25zdCBjb21iaW5lZCA9IG5ldyBVaW50OEFycmF5KFxuICAgICAgICBmcmFtZS5ieXRlTGVuZ3RoICsgY29tbWFuZEhlYWRlci5ieXRlTGVuZ3RoICsgY29tcHJlc3NlZC5ieXRlTGVuZ3RoXG4gICAgICApO1xuICAgICAgY29tYmluZWQuc2V0KGZyYW1lLCAwKTtcbiAgICAgIGNvbWJpbmVkLnNldChjb21tYW5kSGVhZGVyLCBmcmFtZS5ieXRlTGVuZ3RoKTtcbiAgICAgIGNvbWJpbmVkLnNldChjb21wcmVzc2VkLCBmcmFtZS5ieXRlTGVuZ3RoICsgY29tbWFuZEhlYWRlci5ieXRlTGVuZ3RoKTtcblxuICAgICAgZnJhbWUgPSBjb21iaW5lZDtcbiAgICB9XG5cbiAgICBpZiAoZnJhbWUuYnl0ZUxlbmd0aCA+IDEwMDApIHtcbiAgICAgIC8vIDFrYnl0ZSBvdmVyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tpby5hbmltYXRpb25dVG9vIGJpZyBhbmltYXRpb24gZGF0YXMnKTtcbiAgICB9XG5cbiAgICB0aGlzLnNlbmRDb21tYW5kKHRoaXMuX0NvbW1hbmRSZWdpc3RyYXRlLCBmcmFtZSk7XG4gIH1cblxuICBjaGFuZ2VTdGF0ZShwYXJhbXMpIHtcbiAgICBpZiAocGFyYW1zLmFuaW1hdGlvbi5zdGF0dXMgPT09ICdyZXN1bWUnKSB7XG4gICAgICBjb25zdCBuYW1lQXJyYXkgPSBPYm5pelV0aWwuc3RyaW5nMmRhdGFBcnJheShwYXJhbXMuYW5pbWF0aW9uLm5hbWUpO1xuICAgICAgbGV0IGZyYW1lID0gbmV3IFVpbnQ4QXJyYXkobmFtZUFycmF5Lmxlbmd0aCArIDIpO1xuICAgICAgZnJhbWVbMF0gPSBuYW1lQXJyYXkubGVuZ3RoICsgMTtcbiAgICAgIGZyYW1lLnNldChuYW1lQXJyYXksIDEpO1xuICAgICAgZnJhbWVbZnJhbWUuYnl0ZUxlbmd0aCAtIDFdID0gMDtcbiAgICAgIHRoaXMuc2VuZENvbW1hbmQodGhpcy5fQ29tbWFuZFJlc3VtZSwgZnJhbWUpO1xuICAgIH0gZWxzZSBpZiAocGFyYW1zLmFuaW1hdGlvbi5zdGF0dXMgPT09ICdwYXVzZScpIHtcbiAgICAgIGNvbnN0IG5hbWVBcnJheSA9IE9ibml6VXRpbC5zdHJpbmcyZGF0YUFycmF5KHBhcmFtcy5hbmltYXRpb24ubmFtZSk7XG4gICAgICBsZXQgZnJhbWUgPSBuZXcgVWludDhBcnJheShuYW1lQXJyYXkubGVuZ3RoICsgMik7XG4gICAgICBmcmFtZVswXSA9IG5hbWVBcnJheS5sZW5ndGggKyAxO1xuICAgICAgZnJhbWUuc2V0KG5hbWVBcnJheSwgMSk7XG4gICAgICBmcmFtZVtmcmFtZS5ieXRlTGVuZ3RoIC0gMV0gPSAwO1xuICAgICAgdGhpcy5zZW5kQ29tbWFuZCh0aGlzLl9Db21tYW5kUGF1c2UsIGZyYW1lKTtcbiAgICB9XG4gIH1cblxuICBwYXJzZUZyb21Kc29uKGpzb24pIHtcbiAgICBsZXQgcGFyZW50Q29tbWFuZE5vdEZvdW5kID0gZmFsc2U7XG4gICAgdHJ5IHtcbiAgICAgIHN1cGVyLnBhcnNlRnJvbUpzb24oanNvbik7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgdGhpcy5XU0NvbW1hbmROb3RGb3VuZEVycm9yKSB7XG4gICAgICAgIHBhcmVudENvbW1hbmROb3RGb3VuZCA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgbW9kdWxlID0ganNvbi5pbztcbiAgICBpZiAobW9kdWxlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBzY2hlbWFEYXRhID0gW1xuICAgICAgeyB1cmk6ICcvcmVxdWVzdC9pb0FuaW1hdGlvbi9pbml0Jywgb25WYWxpZDogdGhpcy5pbml0IH0sXG4gICAgICB7IHVyaTogJy9yZXF1ZXN0L2lvQW5pbWF0aW9uL2NoYW5nZVN0YXRlJywgb25WYWxpZDogdGhpcy5jaGFuZ2VTdGF0ZSB9LFxuICAgIF07XG4gICAgY29uc3QgcmVzID0gdGhpcy52YWxpZGF0ZUNvbW1hbmRTY2hlbWEoc2NoZW1hRGF0YSwgbW9kdWxlLCAnaW8nLCBtb2R1bGUpO1xuXG4gICAgaWYgKHJlcy52YWxpZCA9PT0gMCAmJiBwYXJlbnRDb21tYW5kTm90Rm91bmQpIHtcbiAgICAgIGlmIChyZXMuaW52YWxpZEJ1dExpa2UubGVuZ3RoID4gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVzLmludmFsaWRCdXRMaWtlWzBdLm1lc3NhZ2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IFdTQ29tbWFuZE5vdEZvdW5kRXJyb3IgPSB0aGlzLldTQ29tbWFuZE5vdEZvdW5kRXJyb3I7XG4gICAgICAgIHRocm93IG5ldyBXU0NvbW1hbmROb3RGb3VuZEVycm9yKGBbaW8uYW5pbWF0aW9uXXVua25vd24gY29tbWFuZGApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5vdGlmeUZyb21CaW5hcnkob2JqVG9TZW5kLCBmdW5jLCBwYXlsb2FkKSB7XG4gICAgaWYgKGZ1bmMgPT09IHRoaXMuX0NvbW1hbmROb3RpZnkpIHtcbiAgICAgIGNvbnN0IG5hbWUgPSBPYm5pelV0aWwuZGF0YUFycmF5MnN0cmluZyhcbiAgICAgICAgcGF5bG9hZC5zbGljZSgyLCBwYXlsb2FkLmJ5dGVMZW5ndGggLSAxKVxuICAgICAgKTsgLy8gcmVtb3ZlIG51bGwgc3RyaW5nXG5cbiAgICAgIG9ialRvU2VuZC5pbyA9IHtcbiAgICAgICAgYW5pbWF0aW9uOiB7XG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgICBzdGF0dXM6ICdmaW5pc2gnLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3VwZXIubm90aWZ5RnJvbUJpbmFyeShvYmpUb1NlbmQsIGZ1bmMsIHBheWxvYWQpO1xuICAgIH1cbiAgfVxufTtcbiJdfQ==

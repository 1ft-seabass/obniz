"use strict";
const ObnizUtil = require('../utils/util');
const semver = require('semver');
class PeripheralSPI {
    constructor(Obniz, id) {
        this.Obniz = Obniz;
        this.id = id;
        this._reset();
    }
    _reset() {
        this.observers = [];
        this.used = false;
    }
    addObserver(callback) {
        if (callback) {
            this.observers.push(callback);
        }
    }
    start(params) {
        let err = ObnizUtil._requiredKeys(params, ['mode', 'frequency']);
        if (err) {
            throw new Error("spi start param '" + err + "' required, but not found ");
        }
        this.params = ObnizUtil._keyFilter(params, [
            'mode',
            'clk',
            'mosi',
            'miso',
            'frequency',
            'drive',
            'pull',
            'gnd',
        ]);
        let obj = {};
        let ioKeys = ['clk', 'mosi', 'miso', 'gnd'];
        for (let key of ioKeys) {
            if (this.params[key] && !this.Obniz.isValidIO(this.params[key])) {
                throw new Error("spi start param '" + key + "' are to be valid io no");
            }
        }
        obj['spi' + this.id] = {
            mode: this.params.mode,
            clock: this.params.frequency,
        };
        if (this.params.clk !== undefined) {
            obj['spi' + this.id].clk = this.params.clk;
        }
        if (this.params.mosi !== undefined) {
            obj['spi' + this.id].mosi = this.params.mosi;
        }
        if (this.params.miso !== undefined) {
            obj['spi' + this.id].miso = this.params.miso;
        }
        if (this.params.drive) {
            if (this.params.clk !== undefined) {
                this.Obniz.getIO(this.params.clk).drive(this.params.drive);
            }
            if (this.params.mosi !== undefined) {
                this.Obniz.getIO(this.params.mosi).drive(this.params.drive);
            }
            if (this.params.miso !== undefined) {
                this.Obniz.getIO(this.params.miso).drive(this.params.drive);
            }
        }
        else {
            if (this.params.clk !== undefined) {
                this.Obniz.getIO(this.params.clk).drive('5v');
            }
            if (this.params.mosi !== undefined) {
                this.Obniz.getIO(this.params.mosi).drive('5v');
            }
            if (this.params.miso !== undefined) {
                this.Obniz.getIO(this.params.miso).drive('5v');
            }
        }
        if (this.params.pull) {
            if (this.params.clk !== undefined) {
                this.Obniz.getIO(this.params.clk).pull(this.params.pull);
            }
            if (this.params.mosi !== undefined) {
                this.Obniz.getIO(this.params.mosi).pull(this.params.pull);
            }
            if (this.params.miso !== undefined) {
                this.Obniz.getIO(this.params.miso).pull(this.params.pull);
            }
        }
        else {
            if (this.params.clk !== undefined) {
                this.Obniz.getIO(this.params.clk).pull(null);
            }
            if (this.params.mosi !== undefined) {
                this.Obniz.getIO(this.params.mosi).pull(null);
            }
            if (this.params.miso !== undefined) {
                this.Obniz.getIO(this.params.miso).pull(null);
            }
        }
        if (this.params.gnd !== undefined) {
            this.Obniz.getIO(this.params.gnd).output(false);
            let ioNames = {};
            ioNames[this.params.gnd] = 'gnd';
            this.Obniz.display.setPinNames('spi' + this.id, ioNames);
        }
        this.used = true;
        this.Obniz.send(obj);
    }
    writeWait(data) {
        if (!this.used) {
            throw new Error(`spi${this.id} is not started`);
        }
        if (semver.lte(this.Obniz.firmware_ver, '1.0.2') && data.length > 32) {
            throw new Error(`with your obniz ${this.Obniz.firmware_ver}. spi max length=32byte but yours ${data.length}. Please update obniz firmware`);
        }
        let self = this;
        return new Promise(function (resolve, reject) {
            self.addObserver(resolve);
            let obj = {};
            obj['spi' + self.id] = {
                data: data,
                read: true,
            };
            self.Obniz.send(obj);
        });
    }
    write(data) {
        if (!this.used) {
            throw new Error(`spi${this.id} is not started`);
        }
        if (semver.lte(this.Obniz.firmware_ver, '1.0.2') && data.length > 32) {
            throw new Error(`with your obniz ${this.Obniz.firmware_ver}. spi max length=32byte but yours ${data.length}. Please update obniz firmware`);
        }
        let self = this;
        let obj = {};
        obj['spi' + self.id] = {
            data: data,
            read: false,
        };
        self.Obniz.send(obj);
    }
    notified(obj) {
        // TODO: we should compare byte length from sent
        let callback = this.observers.shift();
        if (callback) {
            callback(obj.data);
        }
    }
    isUsed() {
        return this.used;
    }
    end(reuse) {
        let self = this;
        let obj = {};
        obj['spi' + self.id] = null;
        this.params = null;
        self.Obniz.send(obj);
        if (!reuse) {
            this.used = false;
        }
    }
}
module.exports = PeripheralSPI;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2lvX3BlcmlwaGVyYWxzL3NwaS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQzNDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUVqQyxNQUFNLGFBQWE7SUFDakIsWUFBWSxLQUFLLEVBQUUsRUFBRTtRQUNuQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBRUQsTUFBTTtRQUNKLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDO0lBQ3BCLENBQUM7SUFFRCxXQUFXLENBQUMsUUFBUTtRQUNsQixJQUFJLFFBQVEsRUFBRTtZQUNaLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQy9CO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxNQUFNO1FBQ1YsSUFBSSxHQUFHLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQztRQUNqRSxJQUFJLEdBQUcsRUFBRTtZQUNQLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLEdBQUcsR0FBRyxHQUFHLDRCQUE0QixDQUFDLENBQUM7U0FDM0U7UUFDRCxJQUFJLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFO1lBQ3pDLE1BQU07WUFDTixLQUFLO1lBQ0wsTUFBTTtZQUNOLE1BQU07WUFDTixXQUFXO1lBQ1gsT0FBTztZQUNQLE1BQU07WUFDTixLQUFLO1NBQ04sQ0FBQyxDQUFDO1FBQ0gsSUFBSSxHQUFHLEdB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RztZQUNyQixJQUFJLEVBQUUsSUFBSTtZQUNWLElBQUksRUFBRSxLQUFLO1NBQ1osQ0FBQztRQUNGLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxRQUFRLENBQUMsR0FBRztRQUNWLGdEQUFnRDtRQUNoRCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3RDLElBQUksUUFBUSxFQUFFO1lBQ1osUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNwQjtJQUNILENBQUM7SUFFRCxNQUFNO1FBQ0osT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFFRCxHQUFHLENBQUMsS0FBSztRQUNQLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztRQUNoQixJQUFJLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDYixHQUFHLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNWLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDO1NBQ25CO0lBQ0gsQ0FBQztDQUNGO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUMiLCJmaWxlIjoib2JuaXovbGlicy9pb19wZXJpcGhlcmFscy9zcGkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBPYm5pelV0aWwgPSByZXF1aXJlKCcuLi91dGlscy91dGlsJyk7XG5jb25zdCBzZW12ZXIgPSByZXF1aXJlKCdzZW12ZXInKTtcblxuY2xhc3MgUGVyaXBoZXJhbFNQSSB7XG4gIGNvbnN0cnVjdG9yKE9ibml6LCBpZCkge1xuICAgIHRoaXMuT2JuaXogPSBPYm5pejtcbiAgICB0aGlzLmlkID0gaWQ7XG4gICAgdGhpcy5fcmVzZXQoKTtcbiAgfVxuXG4gIF9yZXNldCgpIHtcbiAgICB0aGlzLm9ic2VydmVycyA9IFtdO1xuICAgIHRoaXMudXNlZCA9IGZhbHNlO1xuICB9XG5cbiAgYWRkT2JzZXJ2ZXIoY2FsbGJhY2spIHtcbiAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgIHRoaXMub2JzZXJ2ZXJzLnB1c2goY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIHN0YXJ0KHBhcmFtcykge1xuICAgIGxldCBlcnIgPSBPYm5pelV0aWwuX3JlcXVpcmVkS2V5cyhwYXJhbXMsIFsnbW9kZScsICdmcmVxdWVuY3knXSk7XG4gICAgaWYgKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwic3BpIHN0YXJ0IHBhcmFtICdcIiArIGVyciArIFwiJyByZXF1aXJlZCwgYnV0IG5vdCBmb3VuZCBcIik7XG4gICAgfVxuICAgIHRoaXMucGFyYW1zID0gT2JuaXpVdGlsLl9rZXlGaWx0ZXIocGFyYW1zLCBbXG4gICAgICAnbW9kZScsXG4gICAgICAnY2xrJyxcbiAgICAgICdtb3NpJyxcbiAgICAgICdtaXNvJyxcbiAgICAgICdmcmVxdWVuY3knLFxuICAgICAgJ2RyaXZlJyxcbiAgICAgICdwdWxsJyxcbiAgICAgICdnbmQnLFxuICAgIF0pO1xuICAgIGxldCBvYmogPSB7fTtcblxuICAgIGxldCBpb0tleXMgPSBbJ2NsaycsICdtb3NpJywgJ21pc28nLCAnZ25kJ107XG4gICAgZm9yIChsZXQga2V5IG9mIGlvS2V5cykge1xuICAgICAgaWYgKHRoaXMucGFyYW1zW2tleV0gJiYgIXRoaXMuT2JuaXouaXNWYWxpZElPKHRoaXMucGFyYW1zW2tleV0pKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcInNwaSBzdGFydCBwYXJhbSAnXCIgKyBrZXkgKyBcIicgYXJlIHRvIGJlIHZhbGlkIGlvIG5vXCIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIG9ialsnc3BpJyArIHRoaXMuaWRdID0ge1xuICAgICAgbW9kZTogdGhpcy5wYXJhbXMubW9kZSxcbiAgICAgIGNsb2NrOiB0aGlzLnBhcmFtcy5mcmVxdWVuY3ksIC8vbmFtZSBkaWZmZXJlbnRcbiAgICB9O1xuICAgIGlmICh0aGlzLnBhcmFtcy5jbGsgIT09IHVuZGVmaW5lZCkge1xuICAgICAgb2JqWydzcGknICsgdGhpcy5pZF0uY2xrID0gdGhpcy5wYXJhbXMuY2xrO1xuICAgIH1cbiAgICBpZiAodGhpcy5wYXJhbXMubW9zaSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBvYmpbJ3NwaScgKyB0aGlzLmlkXS5tb3NpID0gdGhpcy5wYXJhbXMubW9zaTtcbiAgICB9XG4gICAgaWYgKHRoaXMucGFyYW1zLm1pc28gIT09IHVuZGVmaW5lZCkge1xuICAgICAgb2JqWydzcGknICsgdGhpcy5pZF0ubWlzbyA9IHRoaXMucGFyYW1zLm1pc287XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucGFyYW1zLmRyaXZlKSB7XG4gICAgICBpZiAodGhpcy5wYXJhbXMuY2xrICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5jbGspLmRyaXZlKHRoaXMucGFyYW1zLmRyaXZlKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnBhcmFtcy5tb3NpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5tb3NpKS5kcml2ZSh0aGlzLnBhcmFtcy5kcml2ZSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5wYXJhbXMubWlzbyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMuT2JuaXouZ2V0SU8odGhpcy5wYXJhbXMubWlzbykuZHJpdmUodGhpcy5wYXJhbXMuZHJpdmUpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5wYXJhbXMuY2xrICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5jbGspLmRyaXZlKCc1dicpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMucGFyYW1zLm1vc2kgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLk9ibml6LmdldElPKHRoaXMucGFyYW1zLm1vc2kpLmRyaXZlKCc1dicpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMucGFyYW1zLm1pc28gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLk9ibml6LmdldElPKHRoaXMucGFyYW1zLm1pc28pLmRyaXZlKCc1dicpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLnBhcmFtcy5wdWxsKSB7XG4gICAgICBpZiAodGhpcy5wYXJhbXMuY2xrICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5jbGspLnB1bGwodGhpcy5wYXJhbXMucHVsbCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5wYXJhbXMubW9zaSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMuT2JuaXouZ2V0SU8odGhpcy5wYXJhbXMubW9zaSkucHVsbCh0aGlzLnBhcmFtcy5wdWxsKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnBhcmFtcy5taXNvICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5taXNvKS5wdWxsKHRoaXMucGFyYW1zLnB1bGwpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5wYXJhbXMuY2xrICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5jbGspLnB1bGwobnVsbCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5wYXJhbXMubW9zaSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMuT2JuaXouZ2V0SU8odGhpcy5wYXJhbXMubW9zaSkucHVsbChudWxsKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnBhcmFtcy5taXNvICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5taXNvKS5wdWxsKG51bGwpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLnBhcmFtcy5nbmQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5nbmQpLm91dHB1dChmYWxzZSk7XG4gICAgICBsZXQgaW9OYW1lcyA9IHt9O1xuICAgICAgaW9OYW1lc1t0aGlzLnBhcmFtcy5nbmRdID0gJ2duZCc7XG4gICAgICB0aGlzLk9ibml6LmRpc3BsYXkuc2V0UGluTmFtZXMoJ3NwaScgKyB0aGlzLmlkLCBpb05hbWVzKTtcbiAgICB9XG4gICAgdGhpcy51c2VkID0gdHJ1ZTtcbiAgICB0aGlzLk9ibml6LnNlbmQob2JqKTtcbiAgfVxuXG4gIHdyaXRlV2FpdChkYXRhKSB7XG4gICAgaWYgKCF0aGlzLnVzZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgc3BpJHt0aGlzLmlkfSBpcyBub3Qgc3RhcnRlZGApO1xuICAgIH1cbiAgICBpZiAoc2VtdmVyLmx0ZSh0aGlzLk9ibml6LmZpcm13YXJlX3ZlciwgJzEuMC4yJykgJiYgZGF0YS5sZW5ndGggPiAzMikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgd2l0aCB5b3VyIG9ibml6ICR7XG4gICAgICAgICAgdGhpcy5PYm5pei5maXJtd2FyZV92ZXJcbiAgICAgICAgfS4gc3BpIG1heCBsZW5ndGg9MzJieXRlIGJ1dCB5b3VycyAke1xuICAgICAgICAgIGRhdGEubGVuZ3RoXG4gICAgICAgIH0uIFBsZWFzZSB1cGRhdGUgb2JuaXogZmlybXdhcmVgXG4gICAgICApO1xuICAgIH1cblxuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICBzZWxmLmFkZE9ic2VydmVyKHJlc29sdmUpO1xuICAgICAgbGV0IG9iaiA9IHt9O1xuICAgICAgb2JqWydzcGknICsgc2VsZi5pZF0gPSB7XG4gICAgICAgIGRhdGE6IGRhdGEsXG4gICAgICAgIHJlYWQ6IHRydWUsXG4gICAgICB9O1xuICAgICAgc2VsZi5PYm5pei5zZW5kKG9iaik7XG4gICAgfSk7XG4gIH1cblxuICB3cml0ZShkYXRhKSB7XG4gICAgaWYgKCF0aGlzLnVzZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgc3BpJHt0aGlzLmlkfSBpcyBub3Qgc3RhcnRlZGApO1xuICAgIH1cbiAgICBpZiAoc2VtdmVyLmx0ZSh0aGlzLk9ibml6LmZpcm13YXJlX3ZlciwgJzEuMC4yJykgJiYgZGF0YS5sZW5ndGggPiAzMikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgd2l0aCB5b3VyIG9ibml6ICR7XG4gICAgICAgICAgdGhpcy5PYm5pei5maXJtd2FyZV92ZXJcbiAgICAgICAgfS4gc3BpIG1heCBsZW5ndGg9MzJieXRlIGJ1dCB5b3VycyAke1xuICAgICAgICAgIGRhdGEubGVuZ3RoXG4gICAgICAgIH0uIFBsZWFzZSB1cGRhdGUgb2JuaXogZmlybXdhcmVgXG4gICAgICApO1xuICAgIH1cblxuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBsZXQgb2JqID0ge307XG4gICAgb2JqWydzcGknICsgc2VsZi5pZF0gPSB7XG4gICAgICBkYXRhOiBkYXRhLFxuICAgICAgcmVhZDogZmFsc2UsXG4gICAgfTtcbiAgICBzZWxmLk9ibml6LnNlbmQob2JqKTtcbiAgfVxuXG4gIG5vdGlmaWVkKG9iaikge1xuICAgIC8vIFRPRE86IHdlIHNob3VsZCBjb21wYXJlIGJ5dGUgbGVuZ3RoIGZyb20gc2VudFxuICAgIGxldCBjYWxsYmFjayA9IHRoaXMub2JzZXJ2ZXJzLnNoaWZ0KCk7XG4gICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICBjYWxsYmFjayhvYmouZGF0YSk7XG4gICAgfVxuICB9XG5cbiAgaXNVc2VkKCkge1xuICAgIHJldHVybiB0aGlzLnVzZWQ7XG4gIH1cblxuICBlbmQocmV1c2UpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgbGV0IG9iaiA9IHt9O1xuICAgIG9ialsnc3BpJyArIHNlbGYuaWRdID0gbnVsbDtcbiAgICB0aGlzLnBhcmFtcyA9IG51bGw7XG4gICAgc2VsZi5PYm5pei5zZW5kKG9iaik7XG4gICAgaWYgKCFyZXVzZSkge1xuICAgICAgdGhpcy51c2VkID0gZmFsc2U7XG4gICAgfVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gUGVyaXBoZXJhbFNQSTtcbiJdfQ==

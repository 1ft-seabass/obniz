"use strict";
const ObnizUtil = require('../utils/util');
const isNode = typeof window === 'undefined';
class PeripheralUART {
    constructor(Obniz, id) {
        this.Obniz = Obniz;
        this.id = id;
        this._reset();
    }
    _reset() {
        this.received = new Uint8Array([]);
        this.used = false;
    }
    start(params) {
        let err = ObnizUtil._requiredKeys(params, ['tx', 'rx']);
        if (err) {
            throw new Error("uart start param '" + err + "' required, but not found ");
        }
        this.params = ObnizUtil._keyFilter(params, [
            'tx',
            'rx',
            'baud',
            'stop',
            'bits',
            'parity',
            'flowcontrol',
            'rts',
            'cts',
            'drive',
            'pull',
            'gnd',
        ]);
        let ioKeys = ['rx', 'tx', 'rts', 'cts', 'gnd'];
        for (let key of ioKeys) {
            if (this.params[key] && !this.Obniz.isValidIO(this.params[key])) {
                throw new Error("uart start param '" + key + "' are to be valid io no");
            }
        }
        if (this.params.hasOwnProperty('drive')) {
            this.Obniz.getIO(this.params.rx).drive(this.params.drive);
            this.Obniz.getIO(this.params.tx).drive(this.params.drive);
        }
        else {
            this.Obniz.getIO(this.params.rx).drive('5v');
            this.Obniz.getIO(this.params.tx).drive('5v');
        }
        if (this.params.hasOwnProperty('pull')) {
            this.Obniz.getIO(this.params.rx).pull(this.params.pull);
            this.Obniz.getIO(this.params.tx).pull(this.params.pull);
        }
        else {
            this.Obniz.getIO(this.params.rx).pull(null);
            this.Obniz.getIO(this.params.tx).pull(null);
        }
        if (this.params.hasOwnProperty('gnd')) {
            this.Obniz.getIO(this.params.gnd).output(false);
            let ioNames = {};
            ioNames[this.params.gnd] = 'gnd';
            this.Obniz.display.setPinNames('uart' + this.id, ioNames);
        }
        let obj = {};
        let sendParams = ObnizUtil._keyFilter(this.params, [
            'tx',
            'rx',
            'baud',
            'stop',
            'bits',
            'parity',
            'flowcontrol',
            'rts',
            'cts',
        ]);
        obj['uart' + this.id] = sendParams;
        this.Obniz.send(obj);
        this.received = [];
        this.used = true;
    }
    send(data) {
        if (!this.used) {
            throw new Error(`uart${this.id} is not started`);
        }
        let send_data = null;
        if (data === undefined) {
            return;
        }
        if (typeof data === 'number') {
            data = [data];
        }
        if (isNode && data instanceof Buffer) {
            send_data = [...data];
        }
        else if (data.constructor === Array) {
            send_data = data;
        }
        else if (typeof data === 'string') {
            const buf = Buffer.from(data);
            send_data = [...buf];
        }
        let obj = {};
        obj['uart' + this.id] = {};
        obj['uart' + this.id].data = send_data;
        //  console.log(obj);
        this.Obniz.send(obj);
    }
    isDataExists() {
        return this.received && this.received.length > 0;
    }
    readBytes() {
        let results = [];
        if (this.isDataExists()) {
            for (let i = 0; i < this.received.length; i++) {
                results.push(this.received[i]);
            }
        }
        this.received = [];
        return results;
    }
    readByte() {
        let results = [];
        if (this.isDataExists()) {
            return results.unshift();
        }
        return null;
    }
    readText() {
        let string = null;
        if (this.isDataExists()) {
            let data = this.readBytes();
            string = this.tryConvertString(data);
        }
        this.received = [];
        return string;
    }
    tryConvertString(data) {
        return ObnizUtil.dataArray2string(data);
    }
    notified(obj) {
        if (this.onreceive) {
            let string = this.tryConvertString(obj.data);
            this.onreceive(obj.data, string);
        }
        else {
            if (!this.received) {
                this.received = [];
            }
            this.received.push.apply(this.received, obj.data);
        }
    }
    isUsed() {
        return this.used;
    }
    end() {
        let obj = {};
        obj['uart' + this.id] = null;
        this.params = null;
        this.Obniz.send(obj);
        this.used = false;
    }
}
module.exports = PeripheralUART;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2lvX3BlcmlwaGVyYWxzL3VhcnQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUMzQyxNQUFNLE1BQU0sR0FBRyxPQUFPLE1BQU0sS0FBSyxXQUFXLENBQUM7QUFFN0MsTUFBTSxjQUFjO0lBQ2xCLFlBQVksS0FBSyxFQUFFLEVBQUU7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFDYixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVELE1BQU07UUFDSixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ25DLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDO0lBQ3BCLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTTtRQUNWLElBQUksR0FBRyxHQUFHLFNBQVMsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDeEQsSUFBSSxHQUFHLEVBQUU7WUFDUCxNQUFNLElBQUksS0FBSyxDQUNiLG9CQUFvQixHQUFHLEdBQUcsR0FBRyw0QkFBNEIsQ0FDMUQsQ0FBQztTQUNIO1FBQ0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRTtZQUN6QyxJQUFJO1lBQ0osSUFBSTtZQUNKLE1BQU07WUFDTixNQUFNO1lBQ04sTUFBTTtZQUNOLFFBQVE7WUFDUixhQUFhO1lBQ2IsS0FBSztZQUNMLEtBQUs7WUFDTCxPQUFPO1lBQ1AsTUFBTTtZQUNOLEtBQUs7U0FDTixDQUFDLENBQUM7UUFFSCxJQUFJLE1BQU0sR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFB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O1FBQ25CLE9BQU8sU0FBUyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFRCxRQUFRLENBQUMsR0FBRztRQUNWLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNsQixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztTQUNsQzthQUFNO1lBQ0wsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ2xCLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO2FBQ3BCO1lBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ25EO0lBQ0gsQ0FBQztJQUVELE1BQU07UUFDSixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDbkIsQ0FBQztJQUVELEdBQUc7UUFDRCxJQUFJLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDYixHQUFHLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDN0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7SUFDcEIsQ0FBQztDQUNGO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxjQUFjLENBQUMiLCJmaWxlIjoib2JuaXovbGlicy9pb19wZXJpcGhlcmFscy91YXJ0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgT2JuaXpVdGlsID0gcmVxdWlyZSgnLi4vdXRpbHMvdXRpbCcpO1xuY29uc3QgaXNOb2RlID0gdHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCc7XG5cbmNsYXNzIFBlcmlwaGVyYWxVQVJUIHtcbiAgY29uc3RydWN0b3IoT2JuaXosIGlkKSB7XG4gICAgdGhpcy5PYm5peiA9IE9ibml6O1xuICAgIHRoaXMuaWQgPSBpZDtcbiAgICB0aGlzLl9yZXNldCgpO1xuICB9XG5cbiAgX3Jlc2V0KCkge1xuICAgIHRoaXMucmVjZWl2ZWQgPSBuZXcgVWludDhBcnJheShbXSk7XG4gICAgdGhpcy51c2VkID0gZmFsc2U7XG4gIH1cblxuICBzdGFydChwYXJhbXMpIHtcbiAgICBsZXQgZXJyID0gT2JuaXpVdGlsLl9yZXF1aXJlZEtleXMocGFyYW1zLCBbJ3R4JywgJ3J4J10pO1xuICAgIGlmIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJ1YXJ0IHN0YXJ0IHBhcmFtICdcIiArIGVyciArIFwiJyByZXF1aXJlZCwgYnV0IG5vdCBmb3VuZCBcIlxuICAgICAgKTtcbiAgICB9XG4gICAgdGhpcy5wYXJhbXMgPSBPYm5pelV0aWwuX2tleUZpbHRlcihwYXJhbXMsIFtcbiAgICAgICd0eCcsXG4gICAgICAncngnLFxuICAgICAgJ2JhdWQnLFxuICAgICAgJ3N0b3AnLFxuICAgICAgJ2JpdHMnLFxuICAgICAgJ3Bhcml0eScsXG4gICAgICAnZmxvd2NvbnRyb2wnLFxuICAgICAgJ3J0cycsXG4gICAgICAnY3RzJyxcbiAgICAgICdkcml2ZScsXG4gICAgICAncHVsbCcsXG4gICAgICAnZ25kJyxcbiAgICBdKTtcblxuICAgIGxldCBpb0tleXMgPSBbJ3J4JywgJ3R4JywgJ3J0cycsICdjdHMnLCAnZ25kJ107XG4gICAgZm9yIChsZXQga2V5IG9mIGlvS2V5cykge1xuICAgICAgaWYgKHRoaXMucGFyYW1zW2tleV0gJiYgIXRoaXMuT2JuaXouaXNWYWxpZElPKHRoaXMucGFyYW1zW2tleV0pKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcInVhcnQgc3RhcnQgcGFyYW0gJ1wiICsga2V5ICsgXCInIGFyZSB0byBiZSB2YWxpZCBpbyBub1wiKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5wYXJhbXMuaGFzT3duUHJvcGVydHkoJ2RyaXZlJykpIHtcbiAgICAgIHRoaXMuT2JuaXouZ2V0SU8odGhpcy5wYXJhbXMucngpLmRyaXZlKHRoaXMucGFyYW1zLmRyaXZlKTtcbiAgICAgIHRoaXMuT2JuaXouZ2V0SU8odGhpcy5wYXJhbXMudHgpLmRyaXZlKHRoaXMucGFyYW1zLmRyaXZlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5yeCkuZHJpdmUoJzV2Jyk7XG4gICAgICB0aGlzLk9ibml6LmdldElPKHRoaXMucGFyYW1zLnR4KS5kcml2ZSgnNXYnKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wYXJhbXMuaGFzT3duUHJvcGVydHkoJ3B1bGwnKSkge1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5yeCkucHVsbCh0aGlzLnBhcmFtcy5wdWxsKTtcbiAgICAgIHRoaXMuT2JuaXouZ2V0SU8odGhpcy5wYXJhbXMudHgpLnB1bGwodGhpcy5wYXJhbXMucHVsbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuT2JuaXouZ2V0SU8odGhpcy5wYXJhbXMucngpLnB1bGwobnVsbCk7XG4gICAgICB0aGlzLk9ibml6LmdldElPKHRoaXMucGFyYW1zLnR4KS5wdWxsKG51bGwpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnBhcmFtcy5oYXNPd25Qcm9wZXJ0eSgnZ25kJykpIHtcbiAgICAgIHRoaXMuT2JuaXouZ2V0SU8odGhpcy5wYXJhbXMuZ25kKS5vdXRwdXQoZmFsc2UpO1xuICAgICAgbGV0IGlvTmFtZXMgPSB7fTtcbiAgICAgIGlvTmFtZXNbdGhpcy5wYXJhbXMuZ25kXSA9ICdnbmQnO1xuICAgICAgdGhpcy5PYm5pei5kaXNwbGF5LnNldFBpbk5hbWVzKCd1YXJ0JyArIHRoaXMuaWQsIGlvTmFtZXMpO1xuICAgIH1cblxuICAgIGxldCBvYmogPSB7fTtcbiAgICBsZXQgc2VuZFBhcmFtcyA9IE9ibml6VXRpbC5fa2V5RmlsdGVyKHRoaXMucGFyYW1zLCBbXG4gICAgICAndHgnLFxuICAgICAgJ3J4JyxcbiAgICAgICdiYXVkJyxcbiAgICAgICdzdG9wJyxcbiAgICAgICdiaXRzJyxcbiAgICAgICdwYXJpdHknLFxuICAgICAgJ2Zsb3djb250cm9sJyxcbiAgICAgICdydHMnLFxuICAgICAgJ2N0cycsXG4gICAgXSk7XG4gICAgb2JqWyd1YXJ0JyArIHRoaXMuaWRdID0gc2VuZFBhcmFtcztcbiAgICB0aGlzLk9ibml6LnNlbmQob2JqKTtcbiAgICB0aGlzLnJlY2VpdmVkID0gW107XG4gICAgdGhpcy51c2VkID0gdHJ1ZTtcbiAgfVxuXG4gIHNlbmQoZGF0YSkge1xuICAgIGlmICghdGhpcy51c2VkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHVhcnQke3RoaXMuaWR9IGlzIG5vdCBzdGFydGVkYCk7XG4gICAgfVxuICAgIGxldCBzZW5kX2RhdGEgPSBudWxsO1xuICAgIGlmIChkYXRhID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBkYXRhID09PSAnbnVtYmVyJykge1xuICAgICAgZGF0YSA9IFtkYXRhXTtcbiAgICB9XG4gICAgaWYgKGlzTm9kZSAmJiBkYXRhIGluc3RhbmNlb2YgQnVmZmVyKSB7XG4gICAgICBzZW5kX2RhdGEgPSBbLi4uZGF0YV07XG4gICAgfSBlbHNlIGlmIChkYXRhLmNvbnN0cnVjdG9yID09PSBBcnJheSkge1xuICAgICAgc2VuZF9kYXRhID0gZGF0YTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykge1xuICAgICAgY29uc3QgYnVmID0gQnVmZmVyLmZyb20oZGF0YSk7XG4gICAgICBzZW5kX2RhdGEgPSBbLi4uYnVmXTtcbiAgICB9XG4gICAgbGV0IG9iaiA9IHt9O1xuICAgIG9ialsndWFydCcgKyB0aGlzLmlkXSA9IHt9O1xuICAgIG9ialsndWFydCcgKyB0aGlzLmlkXS5kYXRhID0gc2VuZF9kYXRhO1xuICAgIC8vICBjb25zb2xlLmxvZyhvYmopO1xuICAgIHRoaXMuT2JuaXouc2VuZChvYmopO1xuICB9XG5cbiAgaXNEYXRhRXhpc3RzKCkge1xuICAgIHJldHVybiB0aGlzLnJlY2VpdmVkICYmIHRoaXMucmVjZWl2ZWQubGVuZ3RoID4gMDtcbiAgfVxuXG4gIHJlYWRCeXRlcygpIHtcbiAgICBsZXQgcmVzdWx0cyA9IFtdO1xuICAgIGlmICh0aGlzLmlzRGF0YUV4aXN0cygpKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucmVjZWl2ZWQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcmVzdWx0cy5wdXNoKHRoaXMucmVjZWl2ZWRbaV0pO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnJlY2VpdmVkID0gW107XG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH1cblxuICByZWFkQnl0ZSgpIHtcbiAgICBsZXQgcmVzdWx0cyA9IFtdO1xuICAgIGlmICh0aGlzLmlzRGF0YUV4aXN0cygpKSB7XG4gICAgICByZXR1cm4gcmVzdWx0cy51bnNoaWZ0KCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcmVhZFRleHQoKSB7XG4gICAgbGV0IHN0cmluZyA9IG51bGw7XG4gICAgaWYgKHRoaXMuaXNEYXRhRXhpc3RzKCkpIHtcbiAgICAgIGxldCBkYXRhID0gdGhpcy5yZWFkQnl0ZXMoKTtcbiAgICAgIHN0cmluZyA9IHRoaXMudHJ5Q29udmVydFN0cmluZyhkYXRhKTtcbiAgICB9XG4gICAgdGhpcy5yZWNlaXZlZCA9IFtdO1xuICAgIHJldHVybiBzdHJpbmc7XG4gIH1cblxuICB0cnlDb252ZXJ0U3RyaW5nKGRhdGEpIHtcbiAgICByZXR1cm4gT2JuaXpVdGlsLmRhdGFBcnJheTJzdHJpbmcoZGF0YSk7XG4gIH1cblxuICBub3RpZmllZChvYmopIHtcbiAgICBpZiAodGhpcy5vbnJlY2VpdmUpIHtcbiAgICAgIGxldCBzdHJpbmcgPSB0aGlzLnRyeUNvbnZlcnRTdHJpbmcob2JqLmRhdGEpO1xuICAgICAgdGhpcy5vbnJlY2VpdmUob2JqLmRhdGEsIHN0cmluZyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghdGhpcy5yZWNlaXZlZCkge1xuICAgICAgICB0aGlzLnJlY2VpdmVkID0gW107XG4gICAgICB9XG5cbiAgICAgIHRoaXMucmVjZWl2ZWQucHVzaC5hcHBseSh0aGlzLnJlY2VpdmVkLCBvYmouZGF0YSk7XG4gICAgfVxuICB9XG5cbiAgaXNVc2VkKCkge1xuICAgIHJldHVybiB0aGlzLnVzZWQ7XG4gIH1cblxuICBlbmQoKSB7XG4gICAgbGV0IG9iaiA9IHt9O1xuICAgIG9ialsndWFydCcgKyB0aGlzLmlkXSA9IG51bGw7XG4gICAgdGhpcy5wYXJhbXMgPSBudWxsO1xuICAgIHRoaXMuT2JuaXouc2VuZChvYmopO1xuICAgIHRoaXMudXNlZCA9IGZhbHNlO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gUGVyaXBoZXJhbFVBUlQ7XG4iXX0=

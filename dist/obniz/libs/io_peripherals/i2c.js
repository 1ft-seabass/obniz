"use strict";
const ObnizUtil = require('../utils/util');
class PeripheralI2C {
    constructor(Obniz, id) {
        this.Obniz = Obniz;
        this.id = id;
        this._reset();
        this.onerror = undefined;
    }
    _reset() {
        this.observers = [];
        this.state = {};
        this.used = false;
        this.onwritten = undefined;
    }
    addObserver(callback) {
        if (callback) {
            this.observers.push(callback);
        }
    }
    start(arg) {
        let err = ObnizUtil._requiredKeys(arg, ['mode', 'sda', 'scl']);
        if (err) {
            throw new Error("I2C start param '" + err + "' required, but not found ");
        }
        this.state = ObnizUtil._keyFilter(arg, [
            'mode',
            'sda',
            'scl',
            'pull',
            'gnd',
        ]);
        let ioKeys = ['sda', 'scl', 'gnd'];
        for (let key of ioKeys) {
            if (this.state[key] && !this.Obniz.isValidIO(this.state[key])) {
                throw new Error("i2c start param '" + key + "' are to be valid io no");
            }
        }
        let mode = this.state.mode;
        let clock = typeof arg.clock === 'number' ? parseInt(arg.clock) : null;
        let slave_address = typeof arg.slave_address === 'number'
            ? parseInt(arg.slave_address)
            : null;
        let slave_address_length = typeof arg.slave_address_length === 'number'
            ? parseInt(arg.slave_address_length)
            : null;
        if (mode !== 'master' && mode !== 'slave') {
            throw new Error('i2c: invalid mode ' + mode);
        }
        if (mode === 'master') {
            if (clock === null) {
                throw new Error('i2c: please specify clock when master mode');
            }
            if (clock <= 0 || clock > 1 * 1000 * 1000) {
                throw new Error('i2c: invalid clock ' + clock);
            }
            if (arg.pull === '5v' && clock > 400 * 1000) {
                throw new Error('i2c: please use under 400khz when internal 5v internal pull-up');
            }
            if (arg.pull === '3v' && clock > 100 * 1000) {
                throw new Error('i2c: please use under 100khz when internal 3v internal pull-up');
            }
        }
        else {
            if (slave_address === null) {
                throw new Error('i2c: please specify slave_address');
            }
            if (slave_address < 0 || slave_address > 0x7f) {
                throw new Error('i2c: invalid slave_address');
            }
            if (slave_address < 0 || slave_address > 0x7f) {
                throw new Error('i2c: invalid slave_address');
            }
            if (slave_address_length !== null && slave_address_length !== 7) {
                throw new Error('i2c: invalid slave_address_length. please specify 7');
            }
        }
        this.Obniz.getIO(this.state.sda).drive('open-drain');
        this.Obniz.getIO(this.state.scl).drive('open-drain');
        if (this.state.pull) {
            this.Obniz.getIO(this.state.sda).pull(this.state.pull);
            this.Obniz.getIO(this.state.scl).pull(this.state.pull);
        }
        else {
            this.Obniz.getIO(this.state.sda).pull(null);
            this.Obniz.getIO(this.state.scl).pull(null);
        }
        if (this.state.gnd !== undefined) {
            this.Obniz.getIO(this.state.gnd).output(false);
            let ioNames = {};
            ioNames[this.state.gnd] = 'gnd';
            this.Obniz.display.setPinNames('i2c' + this.id, ioNames);
        }
        let startObj = ObnizUtil._keyFilter(this.state, ['mode', 'sda', 'scl']);
        if (mode === 'master') {
            startObj.clock = clock;
        }
        else {
            startObj.slave_address = slave_address;
            if (slave_address_length) {
                startObj.slave_address_length = slave_address_length;
            }
        }
        let obj = {};
        obj['i2c' + this.id] = startObj;
        this.used = true;
        this.Obniz.send(obj);
    }
    write(address, data) {
        if (!this.used) {
            throw new Error(`i2c${this.id} is not started`);
        }
        address = parseInt(address);
        if (isNaN(address)) {
            throw new Error('i2c: please specify address');
        }
        if (address < 0 || address > 0x7f) {
            throw new Error('i2c: invalid address');
        }
        if (!data) {
            throw new Error('i2c: please provide data');
        }
        if (data.length > 1024) {
            throw new Error('i2c: data should be under 1024 bytes');
        }
        let obj = {};
        obj['i2c' + this.id] = {
            address,
            data,
        };
        this.Obniz.send(obj);
    }
    readWait(address, length) {
        if (!this.used) {
            throw new Error(`i2c${this.id} is not started`);
        }
        address = parseInt(address);
        if (isNaN(address)) {
            throw new Error('i2c: please specify address');
        }
        if (address < 0 || address > 0x7f) {
            throw new Error('i2c: invalid address');
        }
        length = parseInt(length);
        if (isNaN(length) || length < 0) {
            throw new Error('i2c: invalid length to read');
        }
        if (length > 1024) {
            throw new Error('i2c: data length should be under 1024 bytes');
        }
        let self = this;
        return new Promise(function (resolve, reject) {
            self.addObserver(resolve);
            let obj = {};
            obj['i2c' + self.id] = {
                address,
                read: length,
            };
            self.Obniz.send(obj);
        });
    }
    notified(obj) {
        if (obj && typeof obj === 'object') {
            if (obj.data) {
                if (obj.mode === 'slave' && typeof this.onwritten === 'function') {
                    this.onwritten(obj.data, obj.address);
                }
                else {
                    // TODO: we should compare byte length from sent
                    let callback = this.observers.shift();
                    if (callback) {
                        callback(obj.data);
                    }
                }
            }
            if (obj.warning) {
                this.Obniz.warning({
                    alert: 'warning',
                    message: `i2c${this.id}: ${obj.warning.message}`,
                });
            }
            if (obj.error) {
                const message = `i2c${this.id}: ${obj.error.message}`;
                if (typeof this.onerror === 'function') {
                    this.onerror(new Error(message));
                }
                else {
                    this.Obniz.error({
                        alert: 'error',
                        message: message,
                    });
                }
            }
        }
    }
    isUsed() {
        return this.used;
    }
    end() {
        this.state = {};
        let obj = {};
        obj['i2c' + this.id] = null;
        this.Obniz.send(obj);
        this.used = false;
    }
}
module.exports = PeripheralI2C;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2lvX3BlcmlwaGVyYWxzL2kyYy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBRTNDLE1BQU0sYUFBYTtJQUNqQixZQUFZLEtBQUssRUFBRSxFQUFFO1FBQ25CLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2QsSUFBSSxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUM7SUFDM0IsQ0FBQztJQUVELE1BQU07UUFDSixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztRQUNsQixJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztJQUM3QixDQUFDO0lBRUQsV0FBVyxDQUFDLFFBQVE7UUFDbEIsSUFBSSxRQUFRLEVBQUU7WUFDWixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUMvQjtJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsR0FBRztRQUNQLElBQUksR0FBRyxHQUFHLFNBQVMsQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQy9ELElBQUksR0FBRyxFQUFFO1lBQ1AsTUFBTSxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsR0FBRyxHQUFHLEdBQUcsNEJBQTRCLENBQUMsQ0FBQztTQUMzRTtRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDckMsTUFBTTtZQUNOLEtBQUs7WUFDTCxLQUFLO1lBQ0wsTUFBTTtZ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QUNKO1lBQ0QsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFO2dCQUNiLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLEVBQUUsS0FBSyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUN0RCxJQUFJLE9BQU8sSUFBSSxDQUFDLE9BQU8sS0FBSyxVQUFVLEVBQUU7b0JBQ3RDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztpQkFDbEM7cUJBQU07b0JBQ0wsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7d0JBQ2YsS0FBSyxFQUFFLE9BQU87d0JBQ2QsT0FBTyxFQUFFLE9BQU87cUJBQ2pCLENBQUMsQ0FBQztpQkFDSjthQUNGO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsTUFBTTtRQUNKLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDO0lBRUQsR0FBRztRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztRQUNiLEdBQUcsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUM1QixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztJQUNwQixDQUFDO0NBQ0Y7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLGFBQWEsQ0FBQyIsImZpbGUiOiJvYm5pei9saWJzL2lvX3BlcmlwaGVyYWxzL2kyYy5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IE9ibml6VXRpbCA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWwnKTtcblxuY2xhc3MgUGVyaXBoZXJhbEkyQyB7XG4gIGNvbnN0cnVjdG9yKE9ibml6LCBpZCkge1xuICAgIHRoaXMuT2JuaXogPSBPYm5pejtcbiAgICB0aGlzLmlkID0gaWQ7XG4gICAgdGhpcy5fcmVzZXQoKTtcbiAgICB0aGlzLm9uZXJyb3IgPSB1bmRlZmluZWQ7XG4gIH1cblxuICBfcmVzZXQoKSB7XG4gICAgdGhpcy5vYnNlcnZlcnMgPSBbXTtcbiAgICB0aGlzLnN0YXRlID0ge307XG4gICAgdGhpcy51c2VkID0gZmFsc2U7XG4gICAgdGhpcy5vbndyaXR0ZW4gPSB1bmRlZmluZWQ7XG4gIH1cblxuICBhZGRPYnNlcnZlcihjYWxsYmFjaykge1xuICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgdGhpcy5vYnNlcnZlcnMucHVzaChjYWxsYmFjayk7XG4gICAgfVxuICB9XG5cbiAgc3RhcnQoYXJnKSB7XG4gICAgbGV0IGVyciA9IE9ibml6VXRpbC5fcmVxdWlyZWRLZXlzKGFyZywgWydtb2RlJywgJ3NkYScsICdzY2wnXSk7XG4gICAgaWYgKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSTJDIHN0YXJ0IHBhcmFtICdcIiArIGVyciArIFwiJyByZXF1aXJlZCwgYnV0IG5vdCBmb3VuZCBcIik7XG4gICAgfVxuICAgIHRoaXMuc3RhdGUgPSBPYm5pelV0aWwuX2tleUZpbHRlcihhcmcsIFtcbiAgICAgICdtb2RlJyxcbiAgICAgICdzZGEnLFxuICAgICAgJ3NjbCcsXG4gICAgICAncHVsbCcsXG4gICAgICAnZ25kJyxcbiAgICBdKTtcblxuICAgIGxldCBpb0tleXMgPSBbJ3NkYScsICdzY2wnLCAnZ25kJ107XG4gICAgZm9yIChsZXQga2V5IG9mIGlvS2V5cykge1xuICAgICAgaWYgKHRoaXMuc3RhdGVba2V5XSAmJiAhdGhpcy5PYm5pei5pc1ZhbGlkSU8odGhpcy5zdGF0ZVtrZXldKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpMmMgc3RhcnQgcGFyYW0gJ1wiICsga2V5ICsgXCInIGFyZSB0byBiZSB2YWxpZCBpbyBub1wiKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgbW9kZSA9IHRoaXMuc3RhdGUubW9kZTtcbiAgICBsZXQgY2xvY2sgPSB0eXBlb2YgYXJnLmNsb2NrID09PSAnbnVtYmVyJyA/IHBhcnNlSW50KGFyZy5jbG9jaykgOiBudWxsO1xuICAgIGxldCBzbGF2ZV9hZGRyZXNzID1cbiAgICAgIHR5cGVvZiBhcmcuc2xhdmVfYWRkcmVzcyA9PT0gJ251bWJlcidcbiAgICAgICAgPyBwYXJzZUludChhcmcuc2xhdmVfYWRkcmVzcylcbiAgICAgICAgOiBudWxsO1xuICAgIGxldCBzbGF2ZV9hZGRyZXNzX2xlbmd0aCA9XG4gICAgICB0eXBlb2YgYXJnLnNsYXZlX2FkZHJlc3NfbGVuZ3RoID09PSAnbnVtYmVyJ1xuICAgICAgICA/IHBhcnNlSW50KGFyZy5zbGF2ZV9hZGRyZXNzX2xlbmd0aClcbiAgICAgICAgOiBudWxsO1xuXG4gICAgaWYgKG1vZGUgIT09ICdtYXN0ZXInICYmIG1vZGUgIT09ICdzbGF2ZScpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignaTJjOiBpbnZhbGlkIG1vZGUgJyArIG1vZGUpO1xuICAgIH1cbiAgICBpZiAobW9kZSA9PT0gJ21hc3RlcicpIHtcbiAgICAgIGlmIChjbG9jayA9PT0gbnVsbCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2kyYzogcGxlYXNlIHNwZWNpZnkgY2xvY2sgd2hlbiBtYXN0ZXIgbW9kZScpO1xuICAgICAgfVxuICAgICAgaWYgKGNsb2NrIDw9IDAgfHwgY2xvY2sgPiAxICogMTAwMCAqIDEwMDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpMmM6IGludmFsaWQgY2xvY2sgJyArIGNsb2NrKTtcbiAgICAgIH1cbiAgICAgIGlmIChhcmcucHVsbCA9PT0gJzV2JyAmJiBjbG9jayA+IDQwMCAqIDEwMDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdpMmM6IHBsZWFzZSB1c2UgdW5kZXIgNDAwa2h6IHdoZW4gaW50ZXJuYWwgNXYgaW50ZXJuYWwgcHVsbC11cCdcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChhcmcucHVsbCA9PT0gJzN2JyAmJiBjbG9jayA+IDEwMCAqIDEwMDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdpMmM6IHBsZWFzZSB1c2UgdW5kZXIgMTAwa2h6IHdoZW4gaW50ZXJuYWwgM3YgaW50ZXJuYWwgcHVsbC11cCdcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHNsYXZlX2FkZHJlc3MgPT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpMmM6IHBsZWFzZSBzcGVjaWZ5IHNsYXZlX2FkZHJlc3MnKTtcbiAgICAgIH1cbiAgICAgIGlmIChzbGF2ZV9hZGRyZXNzIDwgMCB8fCBzbGF2ZV9hZGRyZXNzID4gMHg3Zikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2kyYzogaW52YWxpZCBzbGF2ZV9hZGRyZXNzJyk7XG4gICAgICB9XG4gICAgICBpZiAoc2xhdmVfYWRkcmVzcyA8IDAgfHwgc2xhdmVfYWRkcmVzcyA+IDB4N2YpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpMmM6IGludmFsaWQgc2xhdmVfYWRkcmVzcycpO1xuICAgICAgfVxuICAgICAgaWYgKHNsYXZlX2FkZHJlc3NfbGVuZ3RoICE9PSBudWxsICYmIHNsYXZlX2FkZHJlc3NfbGVuZ3RoICE9PSA3KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignaTJjOiBpbnZhbGlkIHNsYXZlX2FkZHJlc3NfbGVuZ3RoLiBwbGVhc2Ugc3BlY2lmeSA3Jyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnN0YXRlLnNkYSkuZHJpdmUoJ29wZW4tZHJhaW4nKTtcbiAgICB0aGlzLk9ibml6LmdldElPKHRoaXMuc3RhdGUuc2NsKS5kcml2ZSgnb3Blbi1kcmFpbicpO1xuXG4gICAgaWYgKHRoaXMuc3RhdGUucHVsbCkge1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnN0YXRlLnNkYSkucHVsbCh0aGlzLnN0YXRlLnB1bGwpO1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnN0YXRlLnNjbCkucHVsbCh0aGlzLnN0YXRlLnB1bGwpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLk9ibml6LmdldElPKHRoaXMuc3RhdGUuc2RhKS5wdWxsKG51bGwpO1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnN0YXRlLnNjbCkucHVsbChudWxsKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zdGF0ZS5nbmQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5PYm5pei5nZXRJTyh0aGlzLnN0YXRlLmduZCkub3V0cHV0KGZhbHNlKTtcbiAgICAgIGxldCBpb05hbWVzID0ge307XG4gICAgICBpb05hbWVzW3RoaXMuc3RhdGUuZ25kXSA9ICdnbmQnO1xuICAgICAgdGhpcy5PYm5pei5kaXNwbGF5LnNldFBpbk5hbWVzKCdpMmMnICsgdGhpcy5pZCwgaW9OYW1lcyk7XG4gICAgfVxuXG4gICAgbGV0IHN0YXJ0T2JqID0gT2JuaXpVdGlsLl9rZXlGaWx0ZXIodGhpcy5zdGF0ZSwgWydtb2RlJywgJ3NkYScsICdzY2wnXSk7XG4gICAgaWYgKG1vZGUgPT09ICdtYXN0ZXInKSB7XG4gICAgICBzdGFydE9iai5jbG9jayA9IGNsb2NrO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdGFydE9iai5zbGF2ZV9hZGRyZXNzID0gc2xhdmVfYWRkcmVzcztcbiAgICAgIGlmIChzbGF2ZV9hZGRyZXNzX2xlbmd0aCkge1xuICAgICAgICBzdGFydE9iai5zbGF2ZV9hZGRyZXNzX2xlbmd0aCA9IHNsYXZlX2FkZHJlc3NfbGVuZ3RoO1xuICAgICAgfVxuICAgIH1cblxuICAgIGxldCBvYmogPSB7fTtcbiAgICBvYmpbJ2kyYycgKyB0aGlzLmlkXSA9IHN0YXJ0T2JqO1xuICAgIHRoaXMudXNlZCA9IHRydWU7XG4gICAgdGhpcy5PYm5pei5zZW5kKG9iaik7XG4gIH1cblxuICB3cml0ZShhZGRyZXNzLCBkYXRhKSB7XG4gICAgaWYgKCF0aGlzLnVzZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgaTJjJHt0aGlzLmlkfSBpcyBub3Qgc3RhcnRlZGApO1xuICAgIH1cbiAgICBhZGRyZXNzID0gcGFyc2VJbnQoYWRkcmVzcyk7XG4gICAgaWYgKGlzTmFOKGFkZHJlc3MpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2kyYzogcGxlYXNlIHNwZWNpZnkgYWRkcmVzcycpO1xuICAgIH1cbiAgICBpZiAoYWRkcmVzcyA8IDAgfHwgYWRkcmVzcyA+IDB4N2YpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignaTJjOiBpbnZhbGlkIGFkZHJlc3MnKTtcbiAgICB9XG4gICAgaWYgKCFkYXRhKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2kyYzogcGxlYXNlIHByb3ZpZGUgZGF0YScpO1xuICAgIH1cbiAgICBpZiAoZGF0YS5sZW5ndGggPiAxMDI0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2kyYzogZGF0YSBzaG91bGQgYmUgdW5kZXIgMTAyNCBieXRlcycpO1xuICAgIH1cbiAgICBsZXQgb2JqID0ge307XG4gICAgb2JqWydpMmMnICsgdGhpcy5pZF0gPSB7XG4gICAgICBhZGRyZXNzLFxuICAgICAgZGF0YSxcbiAgICB9O1xuICAgIHRoaXMuT2JuaXouc2VuZChvYmopO1xuICB9XG5cbiAgcmVhZFdhaXQoYWRkcmVzcywgbGVuZ3RoKSB7XG4gICAgaWYgKCF0aGlzLnVzZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgaTJjJHt0aGlzLmlkfSBpcyBub3Qgc3RhcnRlZGApO1xuICAgIH1cbiAgICBhZGRyZXNzID0gcGFyc2VJbnQoYWRkcmVzcyk7XG4gICAgaWYgKGlzTmFOKGFkZHJlc3MpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2kyYzogcGxlYXNlIHNwZWNpZnkgYWRkcmVzcycpO1xuICAgIH1cbiAgICBpZiAoYWRkcmVzcyA8IDAgfHwgYWRkcmVzcyA+IDB4N2YpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignaTJjOiBpbnZhbGlkIGFkZHJlc3MnKTtcbiAgICB9XG4gICAgbGVuZ3RoID0gcGFyc2VJbnQobGVuZ3RoKTtcbiAgICBpZiAoaXNOYU4obGVuZ3RoKSB8fCBsZW5ndGggPCAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2kyYzogaW52YWxpZCBsZW5ndGggdG8gcmVhZCcpO1xuICAgIH1cbiAgICBpZiAobGVuZ3RoID4gMTAyNCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdpMmM6IGRhdGEgbGVuZ3RoIHNob3VsZCBiZSB1bmRlciAxMDI0IGJ5dGVzJyk7XG4gICAgfVxuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICBzZWxmLmFkZE9ic2VydmVyKHJlc29sdmUpO1xuICAgICAgbGV0IG9iaiA9IHt9O1xuICAgICAgb2JqWydpMmMnICsgc2VsZi5pZF0gPSB7XG4gICAgICAgIGFkZHJlc3MsXG4gICAgICAgIHJlYWQ6IGxlbmd0aCxcbiAgICAgIH07XG4gICAgICBzZWxmLk9ibml6LnNlbmQob2JqKTtcbiAgICB9KTtcbiAgfVxuXG4gIG5vdGlmaWVkKG9iaikge1xuICAgIGlmIChvYmogJiYgdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGlmIChvYmouZGF0YSkge1xuICAgICAgICBpZiAob2JqLm1vZGUgPT09ICdzbGF2ZScgJiYgdHlwZW9mIHRoaXMub253cml0dGVuID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgdGhpcy5vbndyaXR0ZW4ob2JqLmRhdGEsIG9iai5hZGRyZXNzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBUT0RPOiB3ZSBzaG91bGQgY29tcGFyZSBieXRlIGxlbmd0aCBmcm9tIHNlbnRcbiAgICAgICAgICBsZXQgY2FsbGJhY2sgPSB0aGlzLm9ic2VydmVycy5zaGlmdCgpO1xuICAgICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgY2FsbGJhY2sob2JqLmRhdGEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKG9iai53YXJuaW5nKSB7XG4gICAgICAgIHRoaXMuT2JuaXoud2FybmluZyh7XG4gICAgICAgICAgYWxlcnQ6ICd3YXJuaW5nJyxcbiAgICAgICAgICBtZXNzYWdlOiBgaTJjJHt0aGlzLmlkfTogJHtvYmoud2FybmluZy5tZXNzYWdlfWAsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgaWYgKG9iai5lcnJvcikge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gYGkyYyR7dGhpcy5pZH06ICR7b2JqLmVycm9yLm1lc3NhZ2V9YDtcbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLm9uZXJyb3IgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICB0aGlzLm9uZXJyb3IobmV3IEVycm9yKG1lc3NhZ2UpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLk9ibml6LmVycm9yKHtcbiAgICAgICAgICAgIGFsZXJ0OiAnZXJyb3InLFxuICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlzVXNlZCgpIHtcbiAgICByZXR1cm4gdGhpcy51c2VkO1xuICB9XG5cbiAgZW5kKCkge1xuICAgIHRoaXMuc3RhdGUgPSB7fTtcbiAgICBsZXQgb2JqID0ge307XG4gICAgb2JqWydpMmMnICsgdGhpcy5pZF0gPSBudWxsO1xuICAgIHRoaXMuT2JuaXouc2VuZChvYmopO1xuICAgIHRoaXMudXNlZCA9IGZhbHNlO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gUGVyaXBoZXJhbEkyQztcbiJdfQ==

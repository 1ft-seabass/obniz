"use strict";
class Display {
    constructor(Obniz) {
        this.Obniz = Obniz;
        this.width = 128;
        this.height = 64;
        this._canvas = null;
        this._reset();
    }
    _reset() {
        this._pos = { x: 0, y: 0 };
        this.autoFlush = true;
    }
    warnCanvasAvailability() {
        if (this.Obniz.isNode) {
            throw new Error('obniz.js require node-canvas to draw rich contents. see more detail on docs');
        }
        else {
            throw new Error('obniz.js cant create canvas element to body');
        }
    }
    _preparedCanvas() {
        if (this._canvas) {
            return this._canvas;
        }
        if (this.Obniz.isNode) {
            try {
                const { createCanvas } = require('canvas');
                this._canvas = createCanvas(this.width, this.height);
            }
            catch (e) {
                // this.warnCanvasAvailability();
                return null;
            }
        }
        else {
            const identifier = 'obnizcanvas-' + this.Obniz.id;
            let canvas = document.getElementById(identifier);
            if (!canvas) {
                canvas = document.createElement('canvas');
                canvas.setAttribute('id', identifier);
                canvas.style.visibility = 'hidden';
                canvas.width = this.width;
                canvas.height = this.height;
                canvas.style['-webkit-font-smoothing'] = 'none';
                let body = document.getElementsByTagName('body')[0];
                body.appendChild(canvas);
            }
            this._canvas = canvas;
        }
        const ctx = this._canvas.getContext('2d');
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, this.width, this.height);
        ctx.fillStyle = '#FFF';
        ctx.strokeStyle = '#FFF';
        this._pos.x = 0;
        this._pos.y = 0;
        this.fontSize = 16;
        ctx.font = `${this.fontSize}px Arial`;
        return this._canvas;
    }
    _ctx() {
        const canvas = this._preparedCanvas();
        if (canvas) {
            return canvas.getContext('2d');
        }
    }
    font(font, size) {
        const ctx = this._ctx();
        if (typeof size !== 'number') {
            size = 16;
        }
        if (typeof font !== 'string') {
            font = 'Arial';
        }
        this.fontSize = size;
        ctx.font = '' + +' ' + size + 'px ' + font;
    }
    clear() {
        const ctx = this._ctx();
        this._pos.x = 0;
        this._pos.y = 0;
        if (ctx) {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, this.width, this.height);
            ctx.fillStyle = '#FFF';
            ctx.strokeStyle = '#FFF';
            this.draw(ctx);
        }
        else {
            let obj = {};
            obj.display = {
                clear: true,
            };
            this.Obniz.send(obj);
        }
    }
    pos(x, y) {
        this._ctx(); //crete first
        if (typeof x == 'number') {
            this._pos.x = x;
        }
        if (typeof y == 'number') {
            this._pos.y = y;
        }
        return this._pos;
    }
    print(text) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.fillText(text, this._pos.x, this._pos.y + this.fontSize);
            this.draw(ctx);
            this._pos.y += this.fontSize;
        }
        else {
            let obj = {};
            obj.display = {
                text: '' + text,
            };
            this.Obniz.send(obj);
        }
    }
    line(x_0, y_0, x_1, y_1) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.beginPath();
            ctx.moveTo(x_0, y_0);
            ctx.lineTo(x_1, y_1);
            ctx.stroke();
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    rect(x, y, width, height, mustFill) {
        const ctx = this._ctx();
        if (ctx) {
            if (mustFill) {
                ctx.fillRect(x, y, width, height);
            }
            else {
                ctx.strokeRect(x, y, width, height);
            }
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    circle(x, y, r, mustFill) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            if (mustFill) {
                ctx.fill();
            }
            else {
                ctx.stroke();
            }
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    qr(text, correction) {
        let obj = {};
        obj.display = {
            qr: {
                text,
            },
        };
        if (correction) {
            obj.display.qr.correction = correction;
        }
        this.Obniz.send(obj);
    }
    raw(data) {
        let obj = {};
        obj.display = {
            raw: data,
        };
        this.Obniz.send(obj);
    }
    setPinName(io, moduleName, funcName) {
        let obj = {};
        obj.display = {};
        obj.display.pin_assign = {};
        obj.display.pin_assign[io] = {
            module_name: moduleName,
            pin_name: funcName,
        };
        this.Obniz.send(obj);
    }
    setPinNames(moduleName, data) {
        let obj = {};
        obj.display = {};
        obj.display.pin_assign = {};
        let noAssignee = true;
        for (let key in data) {
            noAssignee = false;
            obj.display.pin_assign[key] = {
                module_name: moduleName,
                pin_name: data[key],
            };
        }
        if (!noAssignee) {
            this.Obniz.send(obj);
        }
    }
    _draw(ctx) {
        const stride = this.width / 8;
        let vram = new Array(stride * 64);
        const imageData = ctx.getImageData(0, 0, this.width, this.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            let brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];
            let index = parseInt(i / 4);
            let line = parseInt(index / this.width);
            let col = parseInt((index - line * this.width) / 8);
            let bits = parseInt(index - line * this.width) % 8;
            if (bits == 0) {
                vram[line * stride + col] = 0x00;
            }
            if (brightness > 0x7f) {
                vram[line * stride + col] |= 0x80 >> bits;
            }
        }
        this.raw(vram);
    }
    draw(ctx) {
        if (this.autoFlush) {
            this._draw(ctx);
        }
    }
    drawing(autoFlush) {
        this.autoFlush = autoFlush == true;
        const ctx = this._ctx();
        if (ctx) {
            this.draw(ctx);
        }
    }
}
module.exports = Display;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9kaXNwbGF5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxNQUFNLE9BQU87SUFDWCxZQUFZLEtBQUs7UUFDZixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQztRQUNqQixJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUVqQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUNwQixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVELE1BQU07UUFDSixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFDeEIsQ0FBQztJQUVELHNCQUFzQjtRQUNwQixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQ2IsNkVBQTZFLENBQzlFLENBQUM7U0FDSDthQUFNO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO1NBQ2hFO0lBQ0gsQ0FBQztJQUVELGVBQWU7UUFDYixJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDaEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO1NBQ3JCO1FBQ0QsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRTtZQUNyQixJQUFJO2dCQUNGLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzNDLElBQUksQ0FBQyxPQUFPLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3REO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1YsaUNB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LEdBQUcsSUFBSSxFQUFFO2dCQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDO2FBQzNDO1NBQ0Y7UUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxJQUFJLENBQUMsR0FBRztRQUNOLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNsQixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2pCO0lBQ0gsQ0FBQztJQUVELE9BQU8sQ0FBQyxTQUFTO1FBQ2YsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLElBQUksSUFBSSxDQUFDO1FBQ25DLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN4QixJQUFJLEdBQUcsRUFBRTtZQUNQLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDaEI7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyIsImZpbGUiOiJvYm5pei9saWJzL2VtYmVkcy9kaXNwbGF5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY2xhc3MgRGlzcGxheSB7XG4gIGNvbnN0cnVjdG9yKE9ibml6KSB7XG4gICAgdGhpcy5PYm5peiA9IE9ibml6O1xuICAgIHRoaXMud2lkdGggPSAxMjg7XG4gICAgdGhpcy5oZWlnaHQgPSA2NDtcblxuICAgIHRoaXMuX2NhbnZhcyA9IG51bGw7XG4gICAgdGhpcy5fcmVzZXQoKTtcbiAgfVxuXG4gIF9yZXNldCgpIHtcbiAgICB0aGlzLl9wb3MgPSB7IHg6IDAsIHk6IDAgfTtcbiAgICB0aGlzLmF1dG9GbHVzaCA9IHRydWU7XG4gIH1cblxuICB3YXJuQ2FudmFzQXZhaWxhYmlsaXR5KCkge1xuICAgIGlmICh0aGlzLk9ibml6LmlzTm9kZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnb2JuaXouanMgcmVxdWlyZSBub2RlLWNhbnZhcyB0byBkcmF3IHJpY2ggY29udGVudHMuIHNlZSBtb3JlIGRldGFpbCBvbiBkb2NzJ1xuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdvYm5pei5qcyBjYW50IGNyZWF0ZSBjYW52YXMgZWxlbWVudCB0byBib2R5Jyk7XG4gICAgfVxuICB9XG5cbiAgX3ByZXBhcmVkQ2FudmFzKCkge1xuICAgIGlmICh0aGlzLl9jYW52YXMpIHtcbiAgICAgIHJldHVybiB0aGlzLl9jYW52YXM7XG4gICAgfVxuICAgIGlmICh0aGlzLk9ibml6LmlzTm9kZSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyBjcmVhdGVDYW52YXMgfSA9IHJlcXVpcmUoJ2NhbnZhcycpO1xuICAgICAgICB0aGlzLl9jYW52YXMgPSBjcmVhdGVDYW52YXModGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvLyB0aGlzLndhcm5DYW52YXNBdmFpbGFiaWxpdHkoKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGlkZW50aWZpZXIgPSAnb2JuaXpjYW52YXMtJyArIHRoaXMuT2JuaXouaWQ7XG4gICAgICBsZXQgY2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWRlbnRpZmllcik7XG4gICAgICBpZiAoIWNhbnZhcykge1xuICAgICAgICBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgICAgY2FudmFzLnNldEF0dHJpYnV0ZSgnaWQnLCBpZGVudGlmaWVyKTtcbiAgICAgICAgY2FudmFzLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJztcbiAgICAgICAgY2FudmFzLndpZHRoID0gdGhpcy53aWR0aDtcbiAgICAgICAgY2FudmFzLmhlaWdodCA9IHRoaXMuaGVpZ2h0O1xuICAgICAgICBjYW52YXMuc3R5bGVbJy13ZWJraXQtZm9udC1zbW9vdGhpbmcnXSA9ICdub25lJztcbiAgICAgICAgbGV0IGJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdO1xuICAgICAgICBib2R5LmFwcGVuZENoaWxkKGNhbnZhcyk7XG4gICAgICB9XG4gICAgICB0aGlzLl9jYW52YXMgPSBjYW52YXM7XG4gICAgfVxuICAgIGNvbnN0IGN0eCA9IHRoaXMuX2NhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwMCc7XG4gICAgY3R4LmZpbGxSZWN0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTtcbiAgICBjdHguZmlsbFN0eWxlID0gJyNGRkYnO1xuICAgIGN0eC5zdHJva2VTdHlsZSA9ICcjRkZGJztcbiAgICB0aGlzLl9wb3MueCA9IDA7XG4gICAgdGhpcy5fcG9zLnkgPSAwO1xuICAgIHRoaXMuZm9udFNpemUgPSAxNjtcbiAgICBjdHguZm9udCA9IGAke3RoaXMuZm9udFNpemV9cHggQXJpYWxgO1xuICAgIHJldHVybiB0aGlzLl9jYW52YXM7XG4gIH1cblxuICBfY3R4KCkge1xuICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuX3ByZXBhcmVkQ2FudmFzKCk7XG4gICAgaWYgKGNhbnZhcykge1xuICAgICAgcmV0dXJuIGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuICAgIH1cbiAgfVxuXG4gIGZvbnQoZm9udCwgc2l6ZSkge1xuICAgIGNvbnN0IGN0eCA9IHRoaXMuX2N0eCgpO1xuICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicpIHtcbiAgICAgIHNpemUgPSAxNjtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBmb250ICE9PSAnc3RyaW5nJykge1xuICAgICAgZm9udCA9ICdBcmlhbCc7XG4gICAgfVxuICAgIHRoaXMuZm9udFNpemUgPSBzaXplO1xuICAgIGN0eC5mb250ID0gJycgKyArJyAnICsgc2l6ZSArICdweCAnICsgZm9udDtcbiAgfVxuXG4gIGNsZWFyKCkge1xuICAgIGNvbnN0IGN0eCA9IHRoaXMuX2N0eCgpO1xuICAgIHRoaXMuX3Bvcy54ID0gMDtcbiAgICB0aGlzLl9wb3MueSA9IDA7XG4gICAgaWYgKGN0eCkge1xuICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDAwJztcbiAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7XG4gICAgICBjdHguZmlsbFN0eWxlID0gJyNGRkYnO1xuICAgICAgY3R4LnN0cm9rZVN0eWxlID0gJyNGRkYnO1xuICAgICAgdGhpcy5kcmF3KGN0eCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBvYmogPSB7fTtcbiAgICAgIG9iai5kaXNwbGF5ID0ge1xuICAgICAgICBjbGVhcjogdHJ1ZSxcbiAgICAgIH07XG4gICAgICB0aGlzLk9ibml6LnNlbmQob2JqKTtcbiAgICB9XG4gIH1cblxuICBwb3MoeCwgeSkge1xuICAgIHRoaXMuX2N0eCgpOyAvL2NyZXRlIGZpcnN0XG4gICAgaWYgKHR5cGVvZiB4ID09ICdudW1iZXInKSB7XG4gICAgICB0aGlzLl9wb3MueCA9IHg7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgeSA9PSAnbnVtYmVyJykge1xuICAgICAgdGhpcy5fcG9zLnkgPSB5O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fcG9zO1xuICB9XG5cbiAgcHJpbnQodGV4dCkge1xuICAgIGNvbnN0IGN0eCA9IHRoaXMuX2N0eCgpO1xuICAgIGlmIChjdHgpIHtcbiAgICAgIGN0eC5maWxsVGV4dCh0ZXh0LCB0aGlzLl9wb3MueCwgdGhpcy5fcG9zLnkgKyB0aGlzLmZvbnRTaXplKTtcbiAgICAgIHRoaXMuZHJhdyhjdHgpO1xuICAgICAgdGhpcy5fcG9zLnkgKz0gdGhpcy5mb250U2l6ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IG9iaiA9IHt9O1xuICAgICAgb2JqLmRpc3BsYXkgPSB7XG4gICAgICAgIHRleHQ6ICcnICsgdGV4dCxcbiAgICAgIH07XG4gICAgICB0aGlzLk9ibml6LnNlbmQob2JqKTtcbiAgICB9XG4gIH1cblxuICBsaW5lKHhfMCwgeV8wLCB4XzEsIHlfMSkge1xuICAgIGNvbnN0IGN0eCA9IHRoaXMuX2N0eCgpO1xuICAgIGlmIChjdHgpIHtcbiAgICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICAgIGN0eC5tb3ZlVG8oeF8wLCB5XzApO1xuICAgICAgY3R4LmxpbmVUbyh4XzEsIHlfMSk7XG4gICAgICBjdHguc3Ryb2tlKCk7XG4gICAgICB0aGlzLmRyYXcoY3R4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy53YXJuQ2FudmFzQXZhaWxhYmlsaXR5KCk7XG4gICAgfVxuICB9XG5cbiAgcmVjdCh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBtdXN0RmlsbCkge1xuICAgIGNvbnN0IGN0eCA9IHRoaXMuX2N0eCgpO1xuICAgIGlmIChjdHgpIHtcbiAgICAgIGlmIChtdXN0RmlsbCkge1xuICAgICAgICBjdHguZmlsbFJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjdHguc3Ryb2tlUmVjdCh4LCB5LCB3aWR0aCwgaGVpZ2h0KTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZHJhdyhjdHgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndhcm5DYW52YXNBdmFpbGFiaWxpdHkoKTtcbiAgICB9XG4gIH1cblxuICBjaXJjbGUoeCwgeSwgciwgbXVzdEZpbGwpIHtcbiAgICBjb25zdCBjdHggPSB0aGlzLl9jdHgoKTtcbiAgICBpZiAoY3R4KSB7XG4gICAgICBjdHguYmVnaW5QYXRoKCk7XG4gICAgICBjdHguYXJjKHgsIHksIHIsIDAsIE1hdGguUEkgKiAyKTtcbiAgICAgIGlmIChtdXN0RmlsbCkge1xuICAgICAgICBjdHguZmlsbCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY3R4LnN0cm9rZSgpO1xuICAgICAgfVxuICAgICAgdGhpcy5kcmF3KGN0eCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMud2FybkNhbnZhc0F2YWlsYWJpbGl0eSgpO1xuICAgIH1cbiAgfVxuXG4gIHFyKHRleHQsIGNvcnJlY3Rpb24pIHtcbiAgICBsZXQgb2JqID0ge307XG4gICAgb2JqLmRpc3BsYXkgPSB7XG4gICAgICBxcjoge1xuICAgICAgICB0ZXh0LFxuICAgICAgfSxcbiAgICB9O1xuICAgIGlmIChjb3JyZWN0aW9uKSB7XG4gICAgICBvYmouZGlzcGxheS5xci5jb3JyZWN0aW9uID0gY29ycmVjdGlvbjtcbiAgICB9XG4gICAgdGhpcy5PYm5pei5zZW5kKG9iaik7XG4gIH1cblxuICByYXcoZGF0YSkge1xuICAgIGxldCBvYmogPSB7fTtcbiAgICBvYmouZGlzcGxheSA9IHtcbiAgICAgIHJhdzogZGF0YSxcbiAgICB9O1xuICAgIHRoaXMuT2JuaXouc2VuZChvYmopO1xuICB9XG5cbiAgc2V0UGluTmFtZShpbywgbW9kdWxlTmFtZSwgZnVuY05hbWUpIHtcbiAgICBsZXQgb2JqID0ge307XG4gICAgb2JqLmRpc3BsYXkgPSB7fTtcbiAgICBvYmouZGlzcGxheS5waW5fYXNzaWduID0ge307XG4gICAgb2JqLmRpc3BsYXkucGluX2Fzc2lnbltpb10gPSB7XG4gICAgICBtb2R1bGVfbmFtZTogbW9kdWxlTmFtZSxcbiAgICAgIHBpbl9uYW1lOiBmdW5jTmFtZSxcbiAgICB9O1xuXG4gICAgdGhpcy5PYm5pei5zZW5kKG9iaik7XG4gIH1cblxuICBzZXRQaW5OYW1lcyhtb2R1bGVOYW1lLCBkYXRhKSB7XG4gICAgbGV0IG9iaiA9IHt9O1xuICAgIG9iai5kaXNwbGF5ID0ge307XG4gICAgb2JqLmRpc3BsYXkucGluX2Fzc2lnbiA9IHt9O1xuICAgIGxldCBub0Fzc2lnbmVlID0gdHJ1ZTtcbiAgICBmb3IgKGxldCBrZXkgaW4gZGF0YSkge1xuICAgICAgbm9Bc3NpZ25lZSA9IGZhbHNlO1xuICAgICAgb2JqLmRpc3BsYXkucGluX2Fzc2lnbltrZXldID0ge1xuICAgICAgICBtb2R1bGVfbmFtZTogbW9kdWxlTmFtZSxcbiAgICAgICAgcGluX25hbWU6IGRhdGFba2V5XSxcbiAgICAgIH07XG4gICAgfVxuICAgIGlmICghbm9Bc3NpZ25lZSkge1xuICAgICAgdGhpcy5PYm5pei5zZW5kKG9iaik7XG4gICAgfVxuICB9XG5cbiAgX2RyYXcoY3R4KSB7XG4gICAgY29uc3Qgc3RyaWRlID0gdGhpcy53aWR0aCAvIDg7XG4gICAgbGV0IHZyYW0gPSBuZXcgQXJyYXkoc3RyaWRlICogNjQpO1xuICAgIGNvbnN0IGltYWdlRGF0YSA9IGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpO1xuICAgIGNvbnN0IGRhdGEgPSBpbWFnZURhdGEuZGF0YTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgKz0gNCkge1xuICAgICAgbGV0IGJyaWdodG5lc3MgPSAwLjM0ICogZGF0YVtpXSArIDAuNSAqIGRhdGFbaSArIDFdICsgMC4xNiAqIGRhdGFbaSArIDJdO1xuICAgICAgbGV0IGluZGV4ID0gcGFyc2VJbnQoaSAvIDQpO1xuICAgICAgbGV0IGxpbmUgPSBwYXJzZUludChpbmRleCAvIHRoaXMud2lkdGgpO1xuICAgICAgbGV0IGNvbCA9IHBhcnNlSW50KChpbmRleCAtIGxpbmUgKiB0aGlzLndpZHRoKSAvIDgpO1xuICAgICAgbGV0IGJpdHMgPSBwYXJzZUludChpbmRleCAtIGxpbmUgKiB0aGlzLndpZHRoKSAlIDg7XG4gICAgICBpZiAoYml0cyA9PSAwKSB7XG4gICAgICAgIHZyYW1bbGluZSAqIHN0cmlkZSArIGNvbF0gPSAweDAwO1xuICAgICAgfVxuICAgICAgaWYgKGJyaWdodG5lc3MgPiAweDdmKSB7XG4gICAgICAgIHZyYW1bbGluZSAqIHN0cmlkZSArIGNvbF0gfD0gMHg4MCA+PiBiaXRzO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnJhdyh2cmFtKTtcbiAgfVxuXG4gIGRyYXcoY3R4KSB7XG4gICAgaWYgKHRoaXMuYXV0b0ZsdXNoKSB7XG4gICAgICB0aGlzLl9kcmF3KGN0eCk7XG4gICAgfVxuICB9XG5cbiAgZHJhd2luZyhhdXRvRmx1c2gpIHtcbiAgICB0aGlzLmF1dG9GbHVzaCA9IGF1dG9GbHVzaCA9PSB0cnVlO1xuICAgIGNvbnN0IGN0eCA9IHRoaXMuX2N0eCgpO1xuICAgIGlmIChjdHgpIHtcbiAgICAgIHRoaXMuZHJhdyhjdHgpO1xuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IERpc3BsYXk7XG4iXX0=

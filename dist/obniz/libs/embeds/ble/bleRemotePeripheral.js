"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const BleRemoteService = require('./bleRemoteService');
const emitter = require('eventemitter3');
const BleHelper = require('./bleHelper');
class BleRemotePeripheral {
    constructor(Obniz, address) {
        this.Obniz = Obniz;
        this.address = address;
        this.connected = false;
        this.device_type = null;
        this.address_type = null;
        this.ble_event_type = null;
        this.rssi = null;
        this.adv_data = null;
        this.scan_resp = null;
        this.keys = [
            'device_type',
            'address_type',
            'ble_event_type',
            'rssi',
            'adv_data',
            'scan_resp',
        ];
        this._services = [];
        this.emitter = new emitter();
    }
    get services() {
        return this._services;
    }
    /**
     *
     * @return {String} json value
     */
    toString() {
        return JSON.stringify({
            address: this.address,
            addressType: this.address_type,
            advertisement: this.adv_data,
            scanResponse: this.scan_resp,
            rssi: this.rssi,
        });
    }
    setParams(dic) {
        this.advertise_data_rows = null;
        for (let key in dic) {
            if (dic.hasOwnProperty(key) && this.keys.includes(key)) {
                this[key] = dic[key];
            }
        }
        this.analyseAdvertisement();
    }
    analyseAdvertisement() {
        if (!this.advertise_data_rows) {
            this.advertise_data_rows = [];
            if (this.adv_data) {
                for (let i = 0; i < this.adv_data.length; i++) {
                    let length = this.adv_data[i];
                    let arr = new Array(length);
                    for (let j = 0; j < length; j++) {
                        arr[j] = this.adv_data[i + j + 1];
                    }
                    this.advertise_data_rows.push(arr);
                    i = i + length;
                }
            }
            if (this.scan_resp) {
                for (let i = 0; i < this.scan_resp.length; i++) {
                    let length = this.scan_resp[i];
                    let arr = new Array(length);
                    for (let j = 0; j < length; j++) {
                        arr[j] = this.scan_resp[i + j + 1];
                    }
                    this.advertise_data_rows.push(arr);
                    i = i + length;
                }
            }
            this.setLocalName();
            this.setIBeacon();
        }
    }
    searchTypeVal(type) {
        this.analyseAdvertisement();
        for (let i = 0; i < this.advertise_data_rows.length; i++) {
            if (this.advertise_data_rows[i][0] === type) {
                let results = [].concat(this.advertise_data_rows[i]);
                results.shift();
                return results;
            }
        }
        return undefined;
    }
    setLocalName() {
        let data = this.searchTypeVal(0x09);
        if (!data) {
            data = this.searchTypeVal(0x08);
        }
        if (!data) {
            this.localName = null;
        }
        else {
            this.localName = String.fromCharCode.apply(null, data);
        }
    }
    setIBeacon() {
        let data = this.searchTypeVal(0xff);
        if (!data ||
            data[0] !== 0x4c ||
            data[1] !== 0x00 ||
            data[2] !== 0x02 ||
            data[3] !== 0x15 ||
            data.length !== 25) {
            this.iBeacon = null;
            return;
        }
        let uuidData = data.slice(4, 20);
        let uuid = '';
        for (let i = 0; i < uuidData.length; i++) {
            uuid = uuid + ('00' + uuidData[i].toString(16)).slice(-2);
            if (i === 4 - 1 ||
                i === 4 + 2 - 1 ||
                i === 4 + 2 * 2 - 1 ||
                i === 4 + 2 * 3 - 1) {
                uuid += '-';
            }
        }
        let major = (data[20] << 8) + data[21];
        let minor = (data[22] << 8) + data[23];
        let power = data[24];
        this.iBeacon = {
            uuid: uuid,
            major: major,
            minor: minor,
            power: power,
            rssi: this.rssi,
        };
    }
    _addServiceUuids(results, data, bit) {
        if (!data) {
            return;
        }
        let uuidLength = bit / 4;
        for (let i = 0; i < data.length; i = i + uuidLength) {
            let one = data.slice(i, i + uuidLength);
            results.push(this.Obniz.ble.constructor._dataArray2uuidHex(one, true));
        }
    }
    advertisementServiceUuids() {
        let results = [];
        this._addServiceUuids(results, this.searchTypeVal(0x02), 16);
        this._addServiceUuids(results, this.searchTypeVal(0x03), 16);
        this._addServiceUuids(results, this.searchTypeVal(0x04), 32);
        this._addServiceUuids(results, this.searchTypeVal(0x05), 32);
        this._addServiceUuids(results, this.searchTypeVal(0x06), 64);
        this._addServiceUuids(results, this.searchTypeVal(0x07), 64);
        return results;
    }
    connect() {
        this.Obniz.ble.scan.end();
        let obj = {
            ble: {
                connect: {
                    address: this.address,
                },
            },
        };
        this.Obniz.send(obj);
    }
    connectWait() {
        return new Promise((resolve, reject) => {
            this.emitter.once('statusupdate', params => {
                if (params.status === 'connected') {
                    resolve(true);
                }
                else {
                    reject(new Error('connection not established'));
                }
            });
            this.connect();
        });
    }
    disconnect() {
        let obj = {
            ble: {
                disconnect: {
                    address: this.address,
                },
            },
        };
        this.Obniz.send(obj);
    }
    disconnectWait() {
        return new Promise((resolve, reject) => {
            this.emitter.once('statusupdate', params => {
                if (params.status === 'disconnected') {
                    resolve(true);
                }
                else {
                    reject(new Error('disconnectWait failed'));
                }
            });
            this.disconnect();
        });
    }
    getService(uuid) {
        uuid = BleHelper.uuidFilter(uuid);
        for (let key in this._services) {
            if (this._services[key].uuid === uuid) {
                return this._services[key];
            }
        }
        return undefined;
    }
    findService(param) {
        let serviceUuid = BleHelper.uuidFilter(param.service_uuid);
        return this.getService(serviceUuid);
    }
    findCharacteristic(param) {
        let serviceUuid = BleHelper.uuidFilter(param.service_uuid);
        let characteristicUuid = BleHelper.uuidFilter(param.characteristic_uuid);
        let s = this.getService(serviceUuid);
        if (s) {
            return s.getCharacteristic(characteristicUuid);
        }
        return null;
    }
    findDescriptor(param) {
        let descriptorUuid = BleHelper.uuidFilter(param.descriptor_uuid);
        let c = this.findCharacteristic(param);
        if (c) {
            return c.getDescriptor(descriptorUuid);
        }
        return null;
    }
    discoverAllServices() {
        let obj = {
            ble: {
                get_services: {
                    address: this.address,
                },
            },
        };
        this.Obniz.send(obj);
    }
    discoverAllServicesWait() {
        return new Promise(resolve => {
            this.emitter.once('discoverfinished', () => {
                let children = this._services.filter(elm => {
                    return elm.discoverdOnRemote;
                });
                resolve(children);
            });
            this.discoverAllServices();
        });
    }
    discoverAllHandlesWait() {
        return __awaiter(this, void 0, void 0, function* () {
            let ArrayFlat = function (array, depth) {
                let flattend = [];
                (function flat(array, depth) {
                    for (let el of array) {
                        if (Array.isArray(el) && depth > 0) {
                            flat(el, depth - 1);
                        }
                        else {
                            flattend.push(el);
                        }
                    }
                })(array, Math.floor(depth) || 1);
                return flattend;
            };
            let services = yield this.discoverAllServicesWait();
            let charsNest = yield Promise.all(services.map(s => s.discoverAllCharacteristicsWait()));
            let chars = ArrayFlat(charsNest);
            let descriptorsNest = yield Promise.all(chars.map(c => c.discoverAllDescriptorsWait()));
            // eslint-disable-next-line no-unused-vars
            let descriptors = ArrayFlat(descriptorsNest);
        });
    }
    onconnect() { }
    ondisconnect() { }
    ondiscoverservice() { }
    ondiscoverservicefinished() { }
    ondiscover() { }
    ondiscoverfinished() { }
    notifyFromServer(notifyName, params) {
        return __awaiter(this, void 0, void 0, function* () {
            this.emitter.emit(notifyName, params);
            switch (notifyName) {
                case 'statusupdate': {
                    if (params.status === 'connected') {
                        this.connected = true;
                        yield this.discoverAllHandlesWait();
                        this.onconnect();
                    }
                    if (params.status === 'disconnected') {
                        this.connected = false;
                        this.ondisconnect();
                    }
                    break;
                }
                case 'discover': {
                    let uuid = params.service_uuid;
                    let child = this.getService(uuid);
                    if (!child) {
                        let newService = new BleRemoteService({ uuid });
                        newService.parent = this;
                        this._services.push(newService);
                        child = newService;
                    }
                    child.discoverdOnRemote = true;
                    this.ondiscoverservice(child);
                    break;
                }
                case 'discoverfinished': {
                    let children = this._services.filter(elm => {
                        return elm.discoverdOnRemote;
                    });
                    this.ondiscoverservicefinished(children);
                    break;
                }
            }
        });
    }
    onerror() { }
}
module.exports = BleRemotePeripheral;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGUvYmxlUmVtb3RlUGVyaXBoZXJhbC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUN2RCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBRXpDLE1BQU0sbUJBQW1CO0lBQ3ZCLFlBQVksS0FBSyxFQUFFLE9BQU87UUFDeEIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFFdkIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDekIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFDM0IsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFFdEIsSUFBSSxDQUFDLElBQUksR0FBRztZQUNWLGFBQWE7WUFDYixjQUFjO1lBQ2QsZ0JBQWdCO1lBQ2hCLE1BQU07WUFDTixVQUFVO1lBQ1YsV0FBVztTQUNaLENBQUM7UUFFRixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVELElBQUksUUFBUTtRQUNWLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUN4QixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsUUFBUTtRQUNOLE9BQU8s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d0JBQ2hDLEtBQUssR0FBRyxVQUFVLENBQUM7cUJBQ3BCO29CQUNELEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7b0JBQy9CLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDOUIsTUFBTTtpQkFDUDtnQkFDRCxLQUFLLGtCQUFrQixDQUFDLENBQUM7b0JBQ3ZCLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFO3dCQUN6QyxPQUFPLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQztvQkFDL0IsQ0FBQyxDQUFDLENBQUM7b0JBQ0gsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFFBQVEsQ0FBQyxDQUFDO29CQUN6QyxNQUFNO2lCQUNQO2FBQ0Y7UUFDSCxDQUFDO0tBQUE7SUFFRCxPQUFPLEtBQUksQ0FBQztDQUNiO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxtQkFBbUIsQ0FBQyIsImZpbGUiOiJvYm5pei9saWJzL2VtYmVkcy9ibGUvYmxlUmVtb3RlUGVyaXBoZXJhbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEJsZVJlbW90ZVNlcnZpY2UgPSByZXF1aXJlKCcuL2JsZVJlbW90ZVNlcnZpY2UnKTtcbmNvbnN0IGVtaXR0ZXIgPSByZXF1aXJlKCdldmVudGVtaXR0ZXIzJyk7XG5jb25zdCBCbGVIZWxwZXIgPSByZXF1aXJlKCcuL2JsZUhlbHBlcicpO1xuXG5jbGFzcyBCbGVSZW1vdGVQZXJpcGhlcmFsIHtcbiAgY29uc3RydWN0b3IoT2JuaXosIGFkZHJlc3MpIHtcbiAgICB0aGlzLk9ibml6ID0gT2JuaXo7XG4gICAgdGhpcy5hZGRyZXNzID0gYWRkcmVzcztcbiAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuXG4gICAgdGhpcy5kZXZpY2VfdHlwZSA9IG51bGw7XG4gICAgdGhpcy5hZGRyZXNzX3R5cGUgPSBudWxsO1xuICAgIHRoaXMuYmxlX2V2ZW50X3R5cGUgPSBudWxsO1xuICAgIHRoaXMucnNzaSA9IG51bGw7XG4gICAgdGhpcy5hZHZfZGF0YSA9IG51bGw7XG4gICAgdGhpcy5zY2FuX3Jlc3AgPSBudWxsO1xuXG4gICAgdGhpcy5rZXlzID0gW1xuICAgICAgJ2RldmljZV90eXBlJyxcbiAgICAgICdhZGRyZXNzX3R5cGUnLFxuICAgICAgJ2JsZV9ldmVudF90eXBlJyxcbiAgICAgICdyc3NpJyxcbiAgICAgICdhZHZfZGF0YScsXG4gICAgICAnc2Nhbl9yZXNwJyxcbiAgICBdO1xuXG4gICAgdGhpcy5fc2VydmljZXMgPSBbXTtcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgZW1pdHRlcigpO1xuICB9XG5cbiAgZ2V0IHNlcnZpY2VzKCkge1xuICAgIHJldHVybiB0aGlzLl9zZXJ2aWNlcztcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBAcmV0dXJuIHtTdHJpbmd9IGpzb24gdmFsdWVcbiAgICovXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBhZGRyZXNzOiB0aGlzLmFkZHJlc3MsXG4gICAgICBhZGRyZXNzVHlwZTogdGhpcy5hZGRyZXNzX3R5cGUsXG4gICAgICBhZHZlcnRpc2VtZW50OiB0aGlzLmFkdl9kYXRhLFxuICAgICAgc2NhblJlc3BvbnNlOiB0aGlzLnNjYW5fcmVzcCxcbiAgICAgIHJzc2k6IHRoaXMucnNzaSxcbiAgICB9KTtcbiAgfVxuXG4gIHNldFBhcmFtcyhkaWMpIHtcbiAgICB0aGlzLmFkdmVydGlzZV9kYXRhX3Jvd3MgPSBudWxsO1xuICAgIGZvciAobGV0IGtleSBpbiBkaWMpIHtcbiAgICAgIGlmIChkaWMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiB0aGlzLmtleXMuaW5jbHVkZXMoa2V5KSkge1xuICAgICAgICB0aGlzW2tleV0gPSBkaWNba2V5XTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5hbmFseXNlQWR2ZXJ0aXNlbWVudCgpO1xuICB9XG5cbiAgYW5hbHlzZUFkdmVydGlzZW1lbnQoKSB7XG4gICAgaWYgKCF0aGlzLmFkdmVydGlzZV9kYXRhX3Jvd3MpIHtcbiAgICAgIHRoaXMuYWR2ZXJ0aXNlX2RhdGFfcm93cyA9IFtdO1xuICAgICAgaWYgKHRoaXMuYWR2X2RhdGEpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmFkdl9kYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgbGV0IGxlbmd0aCA9IHRoaXMuYWR2X2RhdGFbaV07XG4gICAgICAgICAgbGV0IGFyciA9IG5ldyBBcnJheShsZW5ndGgpO1xuICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgIGFycltqXSA9IHRoaXMuYWR2X2RhdGFbaSArIGogKyAxXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5hZHZlcnRpc2VfZGF0YV9yb3dzLnB1c2goYXJyKTtcbiAgICAgICAgICBpID0gaSArIGxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHRoaXMuc2Nhbl9yZXNwKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zY2FuX3Jlc3AubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBsZXQgbGVuZ3RoID0gdGhpcy5zY2FuX3Jlc3BbaV07XG4gICAgICAgICAgbGV0IGFyciA9IG5ldyBBcnJheShsZW5ndGgpO1xuICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgIGFycltqXSA9IHRoaXMuc2Nhbl9yZXNwW2kgKyBqICsgMV07XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuYWR2ZXJ0aXNlX2RhdGFfcm93cy5wdXNoKGFycik7XG4gICAgICAgICAgaSA9IGkgKyBsZW5ndGg7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMuc2V0TG9jYWxOYW1lKCk7XG4gICAgICB0aGlzLnNldElCZWFjb24oKTtcbiAgICB9XG4gIH1cblxuICBzZWFyY2hUeXBlVmFsKHR5cGUpIHtcbiAgICB0aGlzLmFuYWx5c2VBZHZlcnRpc2VtZW50KCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmFkdmVydGlzZV9kYXRhX3Jvd3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmICh0aGlzLmFkdmVydGlzZV9kYXRhX3Jvd3NbaV1bMF0gPT09IHR5cGUpIHtcbiAgICAgICAgbGV0IHJlc3VsdHMgPSBbXS5jb25jYXQodGhpcy5hZHZlcnRpc2VfZGF0YV9yb3dzW2ldKTtcbiAgICAgICAgcmVzdWx0cy5zaGlmdCgpO1xuICAgICAgICByZXR1cm4gcmVzdWx0cztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIHNldExvY2FsTmFtZSgpIHtcbiAgICBsZXQgZGF0YSA9IHRoaXMuc2VhcmNoVHlwZVZhbCgweDA5KTtcbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgIGRhdGEgPSB0aGlzLnNlYXJjaFR5cGVWYWwoMHgwOCk7XG4gICAgfVxuICAgIGlmICghZGF0YSkge1xuICAgICAgdGhpcy5sb2NhbE5hbWUgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvY2FsTmFtZSA9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgZGF0YSk7XG4gICAgfVxuICB9XG5cbiAgc2V0SUJlYWNvbigpIHtcbiAgICBsZXQgZGF0YSA9IHRoaXMuc2VhcmNoVHlwZVZhbCgweGZmKTtcbiAgICBpZiAoXG4gICAgICAhZGF0YSB8fFxuICAgICAgZGF0YVswXSAhPT0gMHg0YyB8fFxuICAgICAgZGF0YVsxXSAhPT0gMHgwMCB8fFxuICAgICAgZGF0YVsyXSAhPT0gMHgwMiB8fFxuICAgICAgZGF0YVszXSAhPT0gMHgxNSB8fFxuICAgICAgZGF0YS5sZW5ndGggIT09IDI1XG4gICAgKSB7XG4gICAgICB0aGlzLmlCZWFjb24gPSBudWxsO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgdXVpZERhdGEgPSBkYXRhLnNsaWNlKDQsIDIwKTtcbiAgICBsZXQgdXVpZCA9ICcnO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdXVpZERhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIHV1aWQgPSB1dWlkICsgKCcwMCcgKyB1dWlkRGF0YVtpXS50b1N0cmluZygxNikpLnNsaWNlKC0yKTtcbiAgICAgIGlmIChcbiAgICAgICAgaSA9PT0gNCAtIDEgfHxcbiAgICAgICAgaSA9PT0gNCArIDIgLSAxIHx8XG4gICAgICAgIGkgPT09IDQgKyAyICogMiAtIDEgfHxcbiAgICAgICAgaSA9PT0gNCArIDIgKiAzIC0gMVxuICAgICAgKSB7XG4gICAgICAgIHV1aWQgKz0gJy0nO1xuICAgICAgfVxuICAgIH1cblxuICAgIGxldCBtYWpvciA9IChkYXRhWzIwXSA8PCA4KSArIGRhdGFbMjFdO1xuICAgIGxldCBtaW5vciA9IChkYXRhWzIyXSA8PCA4KSArIGRhdGFbMjNdO1xuICAgIGxldCBwb3dlciA9IGRhdGFbMjRdO1xuXG4gICAgdGhpcy5pQmVhY29uID0ge1xuICAgICAgdXVpZDogdXVpZCxcbiAgICAgIG1ham9yOiBtYWpvcixcbiAgICAgIG1pbm9yOiBtaW5vcixcbiAgICAgIHBvd2VyOiBwb3dlcixcbiAgICAgIHJzc2k6IHRoaXMucnNzaSxcbiAgICB9O1xuICB9XG5cbiAgX2FkZFNlcnZpY2VVdWlkcyhyZXN1bHRzLCBkYXRhLCBiaXQpIHtcbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IHV1aWRMZW5ndGggPSBiaXQgLyA0O1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgPSBpICsgdXVpZExlbmd0aCkge1xuICAgICAgbGV0IG9uZSA9IGRhdGEuc2xpY2UoaSwgaSArIHV1aWRMZW5ndGgpO1xuICAgICAgcmVzdWx0cy5wdXNoKHRoaXMuT2JuaXouYmxlLmNvbnN0cnVjdG9yLl9kYXRhQXJyYXkydXVpZEhleChvbmUsIHRydWUpKTtcbiAgICB9XG4gIH1cblxuICBhZHZlcnRpc2VtZW50U2VydmljZVV1aWRzKCkge1xuICAgIGxldCByZXN1bHRzID0gW107XG4gICAgdGhpcy5fYWRkU2VydmljZVV1aWRzKHJlc3VsdHMsIHRoaXMuc2VhcmNoVHlwZVZhbCgweDAyKSwgMTYpO1xuICAgIHRoaXMuX2FkZFNlcnZpY2VVdWlkcyhyZXN1bHRzLCB0aGlzLnNlYXJjaFR5cGVWYWwoMHgwMyksIDE2KTtcbiAgICB0aGlzLl9hZGRTZXJ2aWNlVXVpZHMocmVzdWx0cywgdGhpcy5zZWFyY2hUeXBlVmFsKDB4MDQpLCAzMik7XG4gICAgdGhpcy5fYWRkU2VydmljZVV1aWRzKHJlc3VsdHMsIHRoaXMuc2VhcmNoVHlwZVZhbCgweDA1KSwgMzIpO1xuICAgIHRoaXMuX2FkZFNlcnZpY2VVdWlkcyhyZXN1bHRzLCB0aGlzLnNlYXJjaFR5cGVWYWwoMHgwNiksIDY0KTtcbiAgICB0aGlzLl9hZGRTZXJ2aWNlVXVpZHMocmVzdWx0cywgdGhpcy5zZWFyY2hUeXBlVmFsKDB4MDcpLCA2NCk7XG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH1cblxuICBjb25uZWN0KCkge1xuICAgIHRoaXMuT2JuaXouYmxlLnNjYW4uZW5kKCk7XG4gICAgbGV0IG9iaiA9IHtcbiAgICAgIGJsZToge1xuICAgICAgICBjb25uZWN0OiB7XG4gICAgICAgICAgYWRkcmVzczogdGhpcy5hZGRyZXNzLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9O1xuICAgIHRoaXMuT2JuaXouc2VuZChvYmopO1xuICB9XG5cbiAgY29ubmVjdFdhaXQoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuZW1pdHRlci5vbmNlKCdzdGF0dXN1cGRhdGUnLCBwYXJhbXMgPT4ge1xuICAgICAgICBpZiAocGFyYW1zLnN0YXR1cyA9PT0gJ2Nvbm5lY3RlZCcpIHtcbiAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ2Nvbm5lY3Rpb24gbm90IGVzdGFibGlzaGVkJykpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMuY29ubmVjdCgpO1xuICAgIH0pO1xuICB9XG5cbiAgZGlzY29ubmVjdCgpIHtcbiAgICBsZXQgb2JqID0ge1xuICAgICAgYmxlOiB7XG4gICAgICAgIGRpc2Nvbm5lY3Q6IHtcbiAgICAgICAgICBhZGRyZXNzOiB0aGlzLmFkZHJlc3MsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH07XG4gICAgdGhpcy5PYm5pei5zZW5kKG9iaik7XG4gIH1cblxuICBkaXNjb25uZWN0V2FpdCgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5lbWl0dGVyLm9uY2UoJ3N0YXR1c3VwZGF0ZScsIHBhcmFtcyA9PiB7XG4gICAgICAgIGlmIChwYXJhbXMuc3RhdHVzID09PSAnZGlzY29ubmVjdGVkJykge1xuICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignZGlzY29ubmVjdFdhaXQgZmFpbGVkJykpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMuZGlzY29ubmVjdCgpO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0U2VydmljZSh1dWlkKSB7XG4gICAgdXVpZCA9IEJsZUhlbHBlci51dWlkRmlsdGVyKHV1aWQpO1xuICAgIGZvciAobGV0IGtleSBpbiB0aGlzLl9zZXJ2aWNlcykge1xuICAgICAgaWYgKHRoaXMuX3NlcnZpY2VzW2tleV0udXVpZCA9PT0gdXVpZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2VydmljZXNba2V5XTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGZpbmRTZXJ2aWNlKHBhcmFtKSB7XG4gICAgbGV0IHNlcnZpY2VVdWlkID0gQmxlSGVscGVyLnV1aWRGaWx0ZXIocGFyYW0uc2VydmljZV91dWlkKTtcbiAgICByZXR1cm4gdGhpcy5nZXRTZXJ2aWNlKHNlcnZpY2VVdWlkKTtcbiAgfVxuXG4gIGZpbmRDaGFyYWN0ZXJpc3RpYyhwYXJhbSkge1xuICAgIGxldCBzZXJ2aWNlVXVpZCA9IEJsZUhlbHBlci51dWlkRmlsdGVyKHBhcmFtLnNlcnZpY2VfdXVpZCk7XG4gICAgbGV0IGNoYXJhY3RlcmlzdGljVXVpZCA9IEJsZUhlbHBlci51dWlkRmlsdGVyKHBhcmFtLmNoYXJhY3RlcmlzdGljX3V1aWQpO1xuICAgIGxldCBzID0gdGhpcy5nZXRTZXJ2aWNlKHNlcnZpY2VVdWlkKTtcbiAgICBpZiAocykge1xuICAgICAgcmV0dXJuIHMuZ2V0Q2hhcmFjdGVyaXN0aWMoY2hhcmFjdGVyaXN0aWNVdWlkKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBmaW5kRGVzY3JpcHRvcihwYXJhbSkge1xuICAgIGxldCBkZXNjcmlwdG9yVXVpZCA9IEJsZUhlbHBlci51dWlkRmlsdGVyKHBhcmFtLmRlc2NyaXB0b3JfdXVpZCk7XG4gICAgbGV0IGMgPSB0aGlzLmZpbmRDaGFyYWN0ZXJpc3RpYyhwYXJhbSk7XG4gICAgaWYgKGMpIHtcbiAgICAgIHJldHVybiBjLmdldERlc2NyaXB0b3IoZGVzY3JpcHRvclV1aWQpO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGRpc2NvdmVyQWxsU2VydmljZXMoKSB7XG4gICAgbGV0IG9iaiA9IHtcbiAgICAgIGJsZToge1xuICAgICAgICBnZXRfc2VydmljZXM6IHtcbiAgICAgICAgICBhZGRyZXNzOiB0aGlzLmFkZHJlc3MsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH07XG4gICAgdGhpcy5PYm5pei5zZW5kKG9iaik7XG4gIH1cblxuICBkaXNjb3ZlckFsbFNlcnZpY2VzV2FpdCgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICB0aGlzLmVtaXR0ZXIub25jZSgnZGlzY292ZXJmaW5pc2hlZCcsICgpID0+IHtcbiAgICAgICAgbGV0IGNoaWxkcmVuID0gdGhpcy5fc2VydmljZXMuZmlsdGVyKGVsbSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGVsbS5kaXNjb3ZlcmRPblJlbW90ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJlc29sdmUoY2hpbGRyZW4pO1xuICAgICAgfSk7XG4gICAgICB0aGlzLmRpc2NvdmVyQWxsU2VydmljZXMoKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGRpc2NvdmVyQWxsSGFuZGxlc1dhaXQoKSB7XG4gICAgbGV0IEFycmF5RmxhdCA9IGZ1bmN0aW9uKGFycmF5LCBkZXB0aCkge1xuICAgICAgbGV0IGZsYXR0ZW5kID0gW107XG4gICAgICAoZnVuY3Rpb24gZmxhdChhcnJheSwgZGVwdGgpIHtcbiAgICAgICAgZm9yIChsZXQgZWwgb2YgYXJyYXkpIHtcbiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShlbCkgJiYgZGVwdGggPiAwKSB7XG4gICAgICAgICAgICBmbGF0KGVsLCBkZXB0aCAtIDEpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmbGF0dGVuZC5wdXNoKGVsKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pKGFycmF5LCBNYXRoLmZsb29yKGRlcHRoKSB8fCAxKTtcbiAgICAgIHJldHVybiBmbGF0dGVuZDtcbiAgICB9O1xuXG4gICAgbGV0IHNlcnZpY2VzID0gYXdhaXQgdGhpcy5kaXNjb3ZlckFsbFNlcnZpY2VzV2FpdCgpO1xuICAgIGxldCBjaGFyc05lc3QgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIHNlcnZpY2VzLm1hcChzID0+IHMuZGlzY292ZXJBbGxDaGFyYWN0ZXJpc3RpY3NXYWl0KCkpXG4gICAgKTtcbiAgICBsZXQgY2hhcnMgPSBBcnJheUZsYXQoY2hhcnNOZXN0KTtcbiAgICBsZXQgZGVzY3JpcHRvcnNOZXN0ID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBjaGFycy5tYXAoYyA9PiBjLmRpc2NvdmVyQWxsRGVzY3JpcHRvcnNXYWl0KCkpXG4gICAgKTtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnNcbiAgICBsZXQgZGVzY3JpcHRvcnMgPSBBcnJheUZsYXQoZGVzY3JpcHRvcnNOZXN0KTtcbiAgfVxuXG4gIG9uY29ubmVjdCgpIHt9XG5cbiAgb25kaXNjb25uZWN0KCkge31cblxuICBvbmRpc2NvdmVyc2VydmljZSgpIHt9XG5cbiAgb25kaXNjb3ZlcnNlcnZpY2VmaW5pc2hlZCgpIHt9XG5cbiAgb25kaXNjb3ZlcigpIHt9XG5cbiAgb25kaXNjb3ZlcmZpbmlzaGVkKCkge31cblxuICBhc3luYyBub3RpZnlGcm9tU2VydmVyKG5vdGlmeU5hbWUsIHBhcmFtcykge1xuICAgIHRoaXMuZW1pdHRlci5lbWl0KG5vdGlmeU5hbWUsIHBhcmFtcyk7XG4gICAgc3dpdGNoIChub3RpZnlOYW1lKSB7XG4gICAgICBjYXNlICdzdGF0dXN1cGRhdGUnOiB7XG4gICAgICAgIGlmIChwYXJhbXMuc3RhdHVzID09PSAnY29ubmVjdGVkJykge1xuICAgICAgICAgIHRoaXMuY29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICBhd2FpdCB0aGlzLmRpc2NvdmVyQWxsSGFuZGxlc1dhaXQoKTtcblxuICAgICAgICAgIHRoaXMub25jb25uZWN0KCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBhcmFtcy5zdGF0dXMgPT09ICdkaXNjb25uZWN0ZWQnKSB7XG4gICAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICB0aGlzLm9uZGlzY29ubmVjdCgpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSAnZGlzY292ZXInOiB7XG4gICAgICAgIGxldCB1dWlkID0gcGFyYW1zLnNlcnZpY2VfdXVpZDtcbiAgICAgICAgbGV0IGNoaWxkID0gdGhpcy5nZXRTZXJ2aWNlKHV1aWQpO1xuICAgICAgICBpZiAoIWNoaWxkKSB7XG4gICAgICAgICAgbGV0IG5ld1NlcnZpY2UgPSBuZXcgQmxlUmVtb3RlU2VydmljZSh7IHV1aWQgfSk7XG4gICAgICAgICAgbmV3U2VydmljZS5wYXJlbnQgPSB0aGlzO1xuICAgICAgICAgIHRoaXMuX3NlcnZpY2VzLnB1c2gobmV3U2VydmljZSk7XG4gICAgICAgICAgY2hpbGQgPSBuZXdTZXJ2aWNlO1xuICAgICAgICB9XG4gICAgICAgIGNoaWxkLmRpc2NvdmVyZE9uUmVtb3RlID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5vbmRpc2NvdmVyc2VydmljZShjaGlsZCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSAnZGlzY292ZXJmaW5pc2hlZCc6IHtcbiAgICAgICAgbGV0IGNoaWxkcmVuID0gdGhpcy5fc2VydmljZXMuZmlsdGVyKGVsbSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGVsbS5kaXNjb3ZlcmRPblJlbW90ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMub25kaXNjb3ZlcnNlcnZpY2VmaW5pc2hlZChjaGlsZHJlbik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG9uZXJyb3IoKSB7fVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEJsZVJlbW90ZVBlcmlwaGVyYWw7XG4iXX0=

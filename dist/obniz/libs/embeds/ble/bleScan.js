"use strict";
const emitter = require('eventemitter3');
const BleHelper = require('./bleHelper');
class BleScan {
    constructor(Obniz) {
        this.scanTarget = null;
        this.Obniz = Obniz;
        this.emitter = new emitter();
        this.scanedPeripherals = [];
    }
    start(target, settings) {
        let obj = {};
        obj.ble = {};
        obj.ble.scan = {
            //    "targetUuid" : settings && settings.targetUuid ? settings.targetUuid : null,
            //    "interval" : settings && settings.interval ? settings.interval : 30,
            duration: settings && settings.duration ? settings.duration : 30,
        };
        if (settings && settings.duplicate) {
            throw new Error(`duplicate property can only be used with obnizOS3 or later`);
        }
        this.scanTarget = target;
        if (this.scanTarget &&
            this.scanTarget.uuids &&
            Array.isArray(this.scanTarget.uuids)) {
            this.scanTarget.uuids = this.scanTarget.uuids.map(elm => {
                return BleHelper.uuidFilter(elm);
            });
        }
        this.scanedPeripherals = [];
        this.Obniz.send(obj);
    }
    startOneWait(target, settings) {
        let state = 0;
        return new Promise(resolve => {
            this.emitter.once('onfind', param => {
                if (state === 0) {
                    state = 1;
                    this.end();
                    resolve(param);
                }
            });
            this.emitter.once('onfinish', () => {
                if (state === 0) {
                    state = 1;
                    resolve(null);
                }
            });
            this.start(target, settings);
        });
    }
    startAllWait(target, settings) {
        return new Promise(resolve => {
            this.emitter.once('onfinish', () => {
                resolve(this.scanedPeripherals);
            });
            this.start(target, settings);
        });
    }
    end() {
        let obj = {};
        obj.ble = {};
        obj.ble.scan = null;
        this.Obniz.send(obj);
    }
    isTarget(peripheral) {
        if (this.scanTarget &&
            this.scanTarget.localName &&
            peripheral.localName !== this.scanTarget.localName) {
            return false;
        }
        if (this.scanTarget && this.scanTarget.uuids) {
            let uuids = peripheral.advertisementServiceUuids().map(e => {
                return BleHelper.uuidFilter(e);
            });
            for (let uuid of this.scanTarget.uuids) {
                if (!uuids.includes(uuid)) {
                    return false;
                }
            }
        }
        return true;
    }
    onfinish() { } //dummy
    onfind() { } //dummy
    notifyFromServer(notifyName, params) {
        switch (notifyName) {
            case 'onfind': {
                if (this.isTarget(params)) {
                    this.scanedPeripherals.push(params);
                    this.emitter.emit(notifyName, params);
                    this.onfind(params);
                }
                break;
            }
            case 'onfinish': {
                this.emitter.emit(notifyName, this.scanedPeripherals);
                this.onfinish(this.scanedPeripherals);
                break;
            }
        }
    }
}
module.exports = BleScan;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGUvYmxlU2Nhbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUV6QyxNQUFNLE9BQU87SUFDWCxZQUFZLEtBQUs7UUFDZixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFFN0IsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQU0sRUFBRSxRQUFRO1FBQ3BCLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztRQUNiLEdBQUcsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUc7WUFDYixrRkFBa0Y7WUFDbEYsMEVBQTBFO1lBQzFFLFFBQVEsRUFBRSxRQUFRLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRTtTQUNqRSxDQUFDO1FBQ0YsSUFBSSxRQUFRLElBQUksUUFBUSxDQUFDLFNBQVMsRUFBRTtZQUNsQyxNQUFNLElBQUksS0FBSyxDQUNiLDREQUE0RCxDQUM3RCxDQUFDO1NBQ0g7UUFFRCxJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQztRQUN6QixJQUNFLElBQUksQ0FBQyxVQUFVO1lBQ2YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLO1lBQ3JCLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFDcEM7WUFDQSxJQUFJLENBQUMsVUFBVSxD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S0FBSSxDQUFDLENBQUMsT0FBTztJQUNyQixNQUFNLEtBQUksQ0FBQyxDQUFDLE9BQU87SUFFbkIsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLE1BQU07UUFDakMsUUFBUSxVQUFVLEVBQUU7WUFDbEIsS0FBSyxRQUFRLENBQUMsQ0FBQztnQkFDYixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUU7b0JBQ3pCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ3BDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztvQkFDdEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDckI7Z0JBQ0QsTUFBTTthQUNQO1lBQ0QsS0FBSyxVQUFVLENBQUMsQ0FBQztnQkFDZixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7Z0JBQ3RELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7Z0JBQ3RDLE1BQU07YUFDUDtTQUNGO0lBQ0gsQ0FBQztDQUNGO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMiLCJmaWxlIjoib2JuaXovbGlicy9lbWJlZHMvYmxlL2JsZVNjYW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBlbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRlbWl0dGVyMycpO1xuY29uc3QgQmxlSGVscGVyID0gcmVxdWlyZSgnLi9ibGVIZWxwZXInKTtcblxuY2xhc3MgQmxlU2NhbiB7XG4gIGNvbnN0cnVjdG9yKE9ibml6KSB7XG4gICAgdGhpcy5zY2FuVGFyZ2V0ID0gbnVsbDtcbiAgICB0aGlzLk9ibml6ID0gT2JuaXo7XG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IGVtaXR0ZXIoKTtcblxuICAgIHRoaXMuc2NhbmVkUGVyaXBoZXJhbHMgPSBbXTtcbiAgfVxuXG4gIHN0YXJ0KHRhcmdldCwgc2V0dGluZ3MpIHtcbiAgICBsZXQgb2JqID0ge307XG4gICAgb2JqLmJsZSA9IHt9O1xuICAgIG9iai5ibGUuc2NhbiA9IHtcbiAgICAgIC8vICAgIFwidGFyZ2V0VXVpZFwiIDogc2V0dGluZ3MgJiYgc2V0dGluZ3MudGFyZ2V0VXVpZCA/IHNldHRpbmdzLnRhcmdldFV1aWQgOiBudWxsLFxuICAgICAgLy8gICAgXCJpbnRlcnZhbFwiIDogc2V0dGluZ3MgJiYgc2V0dGluZ3MuaW50ZXJ2YWwgPyBzZXR0aW5ncy5pbnRlcnZhbCA6IDMwLFxuICAgICAgZHVyYXRpb246IHNldHRpbmdzICYmIHNldHRpbmdzLmR1cmF0aW9uID8gc2V0dGluZ3MuZHVyYXRpb24gOiAzMCxcbiAgICB9O1xuICAgIGlmIChzZXR0aW5ncyAmJiBzZXR0aW5ncy5kdXBsaWNhdGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYGR1cGxpY2F0ZSBwcm9wZXJ0eSBjYW4gb25seSBiZSB1c2VkIHdpdGggb2JuaXpPUzMgb3IgbGF0ZXJgXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuc2NhblRhcmdldCA9IHRhcmdldDtcbiAgICBpZiAoXG4gICAgICB0aGlzLnNjYW5UYXJnZXQgJiZcbiAgICAgIHRoaXMuc2NhblRhcmdldC51dWlkcyAmJlxuICAgICAgQXJyYXkuaXNBcnJheSh0aGlzLnNjYW5UYXJnZXQudXVpZHMpXG4gICAgKSB7XG4gICAgICB0aGlzLnNjYW5UYXJnZXQudXVpZHMgPSB0aGlzLnNjYW5UYXJnZXQudXVpZHMubWFwKGVsbSA9PiB7XG4gICAgICAgIHJldHVybiBCbGVIZWxwZXIudXVpZEZpbHRlcihlbG0pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHRoaXMuc2NhbmVkUGVyaXBoZXJhbHMgPSBbXTtcbiAgICB0aGlzLk9ibml6LnNlbmQob2JqKTtcbiAgfVxuXG4gIHN0YXJ0T25lV2FpdCh0YXJnZXQsIHNldHRpbmdzKSB7XG4gICAgbGV0IHN0YXRlID0gMDtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIHRoaXMuZW1pdHRlci5vbmNlKCdvbmZpbmQnLCBwYXJhbSA9PiB7XG4gICAgICAgIGlmIChzdGF0ZSA9PT0gMCkge1xuICAgICAgICAgIHN0YXRlID0gMTtcbiAgICAgICAgICB0aGlzLmVuZCgpO1xuICAgICAgICAgIHJlc29sdmUocGFyYW0pO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5lbWl0dGVyLm9uY2UoJ29uZmluaXNoJywgKCkgPT4ge1xuICAgICAgICBpZiAoc3RhdGUgPT09IDApIHtcbiAgICAgICAgICBzdGF0ZSA9IDE7XG4gICAgICAgICAgcmVzb2x2ZShudWxsKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuc3RhcnQodGFyZ2V0LCBzZXR0aW5ncyk7XG4gICAgfSk7XG4gIH1cblxuICBzdGFydEFsbFdhaXQodGFyZ2V0LCBzZXR0aW5ncykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIHRoaXMuZW1pdHRlci5vbmNlKCdvbmZpbmlzaCcsICgpID0+IHtcbiAgICAgICAgcmVzb2x2ZSh0aGlzLnNjYW5lZFBlcmlwaGVyYWxzKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLnN0YXJ0KHRhcmdldCwgc2V0dGluZ3MpO1xuICAgIH0pO1xuICB9XG5cbiAgZW5kKCkge1xuICAgIGxldCBvYmogPSB7fTtcbiAgICBvYmouYmxlID0ge307XG4gICAgb2JqLmJsZS5zY2FuID0gbnVsbDtcbiAgICB0aGlzLk9ibml6LnNlbmQob2JqKTtcbiAgfVxuXG4gIGlzVGFyZ2V0KHBlcmlwaGVyYWwpIHtcbiAgICBpZiAoXG4gICAgICB0aGlzLnNjYW5UYXJnZXQgJiZcbiAgICAgIHRoaXMuc2NhblRhcmdldC5sb2NhbE5hbWUgJiZcbiAgICAgIHBlcmlwaGVyYWwubG9jYWxOYW1lICE9PSB0aGlzLnNjYW5UYXJnZXQubG9jYWxOYW1lXG4gICAgKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmICh0aGlzLnNjYW5UYXJnZXQgJiYgdGhpcy5zY2FuVGFyZ2V0LnV1aWRzKSB7XG4gICAgICBsZXQgdXVpZHMgPSBwZXJpcGhlcmFsLmFkdmVydGlzZW1lbnRTZXJ2aWNlVXVpZHMoKS5tYXAoZSA9PiB7XG4gICAgICAgIHJldHVybiBCbGVIZWxwZXIudXVpZEZpbHRlcihlKTtcbiAgICAgIH0pO1xuICAgICAgZm9yIChsZXQgdXVpZCBvZiB0aGlzLnNjYW5UYXJnZXQudXVpZHMpIHtcbiAgICAgICAgaWYgKCF1dWlkcy5pbmNsdWRlcyh1dWlkKSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIG9uZmluaXNoKCkge30gLy9kdW1teVxuICBvbmZpbmQoKSB7fSAvL2R1bW15XG5cbiAgbm90aWZ5RnJvbVNlcnZlcihub3RpZnlOYW1lLCBwYXJhbXMpIHtcbiAgICBzd2l0Y2ggKG5vdGlmeU5hbWUpIHtcbiAgICAgIGNhc2UgJ29uZmluZCc6IHtcbiAgICAgICAgaWYgKHRoaXMuaXNUYXJnZXQocGFyYW1zKSkge1xuICAgICAgICAgIHRoaXMuc2NhbmVkUGVyaXBoZXJhbHMucHVzaChwYXJhbXMpO1xuICAgICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KG5vdGlmeU5hbWUsIHBhcmFtcyk7XG4gICAgICAgICAgdGhpcy5vbmZpbmQocGFyYW1zKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgJ29uZmluaXNoJzoge1xuICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdChub3RpZnlOYW1lLCB0aGlzLnNjYW5lZFBlcmlwaGVyYWxzKTtcbiAgICAgICAgdGhpcy5vbmZpbmlzaCh0aGlzLnNjYW5lZFBlcmlwaGVyYWxzKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQmxlU2NhbjtcbiJdfQ==

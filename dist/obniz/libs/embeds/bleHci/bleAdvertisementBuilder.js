"use strict";
const BleHelper = require('./bleHelper');
class BleAdvertisementBuilder {
    constructor(Obniz, json) {
        this.Obniz = Obniz;
        this.rows = {};
        if (json) {
            if (json.localName) {
                this.setCompleteLocalName(json.localName);
            }
            if (json.manufacturerData &&
                json.manufacturerData.companyCode &&
                json.manufacturerData.data) {
                this.setManufacturerSpecificData(json.manufacturerData.companyCode, json.manufacturerData.data);
            }
            if (json.serviceUuids) {
                for (let uuid of json.serviceUuids) {
                    this.setUuid(uuid);
                }
            }
        }
        if (typeof this.extendEvalJson === 'function') {
            this.extendEvalJson(json);
        }
    }
    setRow(type, data) {
        this.rows[type] = data;
    }
    getRow(type) {
        return this.rows[type] || [];
    }
    build() {
        let data = [];
        for (let key in this.rows) {
            if (this.rows[key].length === 0) {
                continue;
            }
            data.push(this.rows[key].length + 1);
            data.push(parseInt(key));
            Array.prototype.push.apply(data, this.rows[key]);
        }
        if (data.length > 31) {
            this.Obniz.error('Too large data. Advertise/ScanResponse data are must be less than 32 byte.');
        }
        return data;
    }
    setStringData(type, string) {
        let data = [];
        for (let i = 0; i < string.length; i++) {
            data.push(string.charCodeAt(i));
        }
        this.setRow(type, data);
    }
    setShortenedLocalName(name) {
        this.setStringData(0x08, name);
    }
    setCompleteLocalName(name) {
        this.setStringData(0x09, name);
    }
    setManufacturerSpecificData(companyCode, data) {
        let row = [];
        row.push(companyCode & 0xff);
        row.push((companyCode >> 8) & 0xff);
        Array.prototype.push.apply(row, data);
        this.setRow(0xff, row);
    }
    setUuid(uuid) {
        let uuidData = this.convertUuid(uuid);
        let type = { 16: 0x06, 4: 0x04, 2: 0x02 }[uuidData.length];
        this.setRow(type, uuidData);
    }
    convertUuid(uuid) {
        let uuidNumeric = BleHelper.uuidFilter(uuid);
        if (uuidNumeric.length !== 32 &&
            uuidNumeric.length !== 8 &&
            uuidNumeric.length !== 4) {
            this.Obniz.error('BLE uuid must be 16/32/128 bit . (example: c28f0ad5-a7fd-48be-9fd0-eae9ffd3a8bb for 128bit)');
        }
        let data = [];
        for (let i = uuidNumeric.length; i > 1; i -= 2) {
            data.push(parseInt(uuidNumeric[i - 2] + uuidNumeric[i - 1], 16));
        }
        return data;
    }
    setIbeaconData(uuid, major, minor, txPower) {
        let data = [];
        data.push(0x02, 0x15); // fixed data
        let uuidData = this.convertUuid(uuid);
        Array.prototype.push.apply(data, uuidData);
        data.push((major >> 8) & 0xff);
        data.push((major >> 0) & 0xff);
        data.push((minor >> 8) & 0xff);
        data.push((minor >> 0) & 0xff);
        data.push((txPower >> 0) & 0xff);
        this.setManufacturerSpecificData(0x004c, data);
        return;
    }
    extendEvalJson(json) {
        if (json) {
            if (json.flags) {
                if (json.flags.includes('limited_discoverable_mode')) {
                    this.setLeLimitedDiscoverableModeFlag();
                }
                if (json.flags.includes('general_discoverable_mode')) {
                    this.setLeGeneralDiscoverableModeFlag();
                }
                if (json.flags.includes('br_edr_not_supported')) {
                    this.setBrEdrNotSupportedFlag();
                }
                if (json.flags.includes('le_br_edr_controller')) {
                    this.setLeBrEdrControllerFlag();
                }
                if (json.flags.includes('le_br_edr_host')) {
                    this.setLeBrEdrHostFlag();
                }
            }
        }
    }
    setFlags(flag) {
        let data = this.getRow(0x01);
        data[0] = (data[0] || 0) | flag;
        this.setRow(0x01, data);
    }
    setLeLimitedDiscoverableModeFlag() {
        this.setFlags(0x01);
    }
    setLeGeneralDiscoverableModeFlag() {
        this.setFlags(0x02);
    }
    setBrEdrNotSupportedFlag() {
        this.setFlags(0x04);
    }
    setLeBrEdrControllerFlag() {
        this.setFlags(0x08);
    }
    setLeBrEdrHostFlag() {
        this.setFlags(0x10);
    }
}
module.exports = BleAdvertisementBuilder;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvYmxlQWR2ZXJ0aXNlbWVudEJ1aWxkZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUV6QyxNQUFNLHVCQUF1QjtJQUMzQixZQUFZLEtBQUssRUFBRSxJQUFJO1FBQ3JCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRWYsSUFBSSxJQUFJLEVBQUU7WUFDUixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQ2xCLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDM0M7WUFDRCxJQUNFLElBQUksQ0FBQyxnQkFBZ0I7Z0JBQ3JCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXO2dCQUNqQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUMxQjtnQkFDQSxJQUFJLENBQUMsMkJBQTJCLENBQzlCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQ2pDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQzNCLENBQUM7YUFDSDtZQUNELElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDckIsS0FBSyxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO29CQUNsQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNwQjthQUNGO1NBQ0Y7UUFDRCxJQUFJLE9BQU8sSUFBSSxDQUFDLGNBQWMsS0FBSyxVQUFVLEVBQUU7WUFDN0MsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMzQjtJQUNILENBQUM7SUFFRCxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUk7UUFDZixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUks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RyxJQUFJLENBQUM7UUFDaEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDMUIsQ0FBQztJQUVELGdDQUFnQztRQUM5QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxnQ0FBZ0M7UUFDOUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QixDQUFDO0lBRUQsd0JBQXdCO1FBQ3RCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEIsQ0FBQztJQUVELHdCQUF3QjtRQUN0QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxrQkFBa0I7UUFDaEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QixDQUFDO0NBQ0Y7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLHVCQUF1QixDQUFDIiwiZmlsZSI6Im9ibml6L2xpYnMvZW1iZWRzL2JsZUhjaS9ibGVBZHZlcnRpc2VtZW50QnVpbGRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEJsZUhlbHBlciA9IHJlcXVpcmUoJy4vYmxlSGVscGVyJyk7XG5cbmNsYXNzIEJsZUFkdmVydGlzZW1lbnRCdWlsZGVyIHtcbiAgY29uc3RydWN0b3IoT2JuaXosIGpzb24pIHtcbiAgICB0aGlzLk9ibml6ID0gT2JuaXo7XG4gICAgdGhpcy5yb3dzID0ge307XG5cbiAgICBpZiAoanNvbikge1xuICAgICAgaWYgKGpzb24ubG9jYWxOYW1lKSB7XG4gICAgICAgIHRoaXMuc2V0Q29tcGxldGVMb2NhbE5hbWUoanNvbi5sb2NhbE5hbWUpO1xuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBqc29uLm1hbnVmYWN0dXJlckRhdGEgJiZcbiAgICAgICAganNvbi5tYW51ZmFjdHVyZXJEYXRhLmNvbXBhbnlDb2RlICYmXG4gICAgICAgIGpzb24ubWFudWZhY3R1cmVyRGF0YS5kYXRhXG4gICAgICApIHtcbiAgICAgICAgdGhpcy5zZXRNYW51ZmFjdHVyZXJTcGVjaWZpY0RhdGEoXG4gICAgICAgICAganNvbi5tYW51ZmFjdHVyZXJEYXRhLmNvbXBhbnlDb2RlLFxuICAgICAgICAgIGpzb24ubWFudWZhY3R1cmVyRGF0YS5kYXRhXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoanNvbi5zZXJ2aWNlVXVpZHMpIHtcbiAgICAgICAgZm9yIChsZXQgdXVpZCBvZiBqc29uLnNlcnZpY2VVdWlkcykge1xuICAgICAgICAgIHRoaXMuc2V0VXVpZCh1dWlkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodHlwZW9mIHRoaXMuZXh0ZW5kRXZhbEpzb24gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRoaXMuZXh0ZW5kRXZhbEpzb24oanNvbik7XG4gICAgfVxuICB9XG5cbiAgc2V0Um93KHR5cGUsIGRhdGEpIHtcbiAgICB0aGlzLnJvd3NbdHlwZV0gPSBkYXRhO1xuICB9XG5cbiAgZ2V0Um93KHR5cGUpIHtcbiAgICByZXR1cm4gdGhpcy5yb3dzW3R5cGVdIHx8IFtdO1xuICB9XG5cbiAgYnVpbGQoKSB7XG4gICAgbGV0IGRhdGEgPSBbXTtcbiAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5yb3dzKSB7XG4gICAgICBpZiAodGhpcy5yb3dzW2tleV0ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBkYXRhLnB1c2godGhpcy5yb3dzW2tleV0ubGVuZ3RoICsgMSk7XG4gICAgICBkYXRhLnB1c2gocGFyc2VJbnQoa2V5KSk7XG4gICAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShkYXRhLCB0aGlzLnJvd3Nba2V5XSk7XG4gICAgfVxuICAgIGlmIChkYXRhLmxlbmd0aCA+IDMxKSB7XG4gICAgICB0aGlzLk9ibml6LmVycm9yKFxuICAgICAgICAnVG9vIGxhcmdlIGRhdGEuIEFkdmVydGlzZS9TY2FuUmVzcG9uc2UgZGF0YSBhcmUgbXVzdCBiZSBsZXNzIHRoYW4gMzIgYnl0ZS4nXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgc2V0U3RyaW5nRGF0YSh0eXBlLCBzdHJpbmcpIHtcbiAgICBsZXQgZGF0YSA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHJpbmcubGVuZ3RoOyBpKyspIHtcbiAgICAgIGRhdGEucHVzaChzdHJpbmcuY2hhckNvZGVBdChpKSk7XG4gICAgfVxuXG4gICAgdGhpcy5zZXRSb3codHlwZSwgZGF0YSk7XG4gIH1cblxuICBzZXRTaG9ydGVuZWRMb2NhbE5hbWUobmFtZSkge1xuICAgIHRoaXMuc2V0U3RyaW5nRGF0YSgweDA4LCBuYW1lKTtcbiAgfVxuXG4gIHNldENvbXBsZXRlTG9jYWxOYW1lKG5hbWUpIHtcbiAgICB0aGlzLnNldFN0cmluZ0RhdGEoMHgwOSwgbmFtZSk7XG4gIH1cblxuICBzZXRNYW51ZmFjdHVyZXJTcGVjaWZpY0RhdGEoY29tcGFueUNvZGUsIGRhdGEpIHtcbiAgICBsZXQgcm93ID0gW107XG4gICAgcm93LnB1c2goY29tcGFueUNvZGUgJiAweGZmKTtcbiAgICByb3cucHVzaCgoY29tcGFueUNvZGUgPj4gOCkgJiAweGZmKTtcbiAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShyb3csIGRhdGEpO1xuICAgIHRoaXMuc2V0Um93KDB4ZmYsIHJvdyk7XG4gIH1cblxuICBzZXRVdWlkKHV1aWQpIHtcbiAgICBsZXQgdXVpZERhdGEgPSB0aGlzLmNvbnZlcnRVdWlkKHV1aWQpO1xuICAgIGxldCB0eXBlID0geyAxNjogMHgwNiwgNDogMHgwNCwgMjogMHgwMiB9W3V1aWREYXRhLmxlbmd0aF07XG4gICAgdGhpcy5zZXRSb3codHlwZSwgdXVpZERhdGEpO1xuICB9XG5cbiAgY29udmVydFV1aWQodXVpZCkge1xuICAgIGxldCB1dWlkTnVtZXJpYyA9IEJsZUhlbHBlci51dWlkRmlsdGVyKHV1aWQpO1xuICAgIGlmIChcbiAgICAgIHV1aWROdW1lcmljLmxlbmd0aCAhPT0gMzIgJiZcbiAgICAgIHV1aWROdW1lcmljLmxlbmd0aCAhPT0gOCAmJlxuICAgICAgdXVpZE51bWVyaWMubGVuZ3RoICE9PSA0XG4gICAgKSB7XG4gICAgICB0aGlzLk9ibml6LmVycm9yKFxuICAgICAgICAnQkxFIHV1aWQgbXVzdCBiZSAxNi8zMi8xMjggYml0IC4gKGV4YW1wbGU6IGMyOGYwYWQ1LWE3ZmQtNDhiZS05ZmQwLWVhZTlmZmQzYThiYiBmb3IgMTI4Yml0KSdcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbGV0IGRhdGEgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gdXVpZE51bWVyaWMubGVuZ3RoOyBpID4gMTsgaSAtPSAyKSB7XG4gICAgICBkYXRhLnB1c2gocGFyc2VJbnQodXVpZE51bWVyaWNbaSAtIDJdICsgdXVpZE51bWVyaWNbaSAtIDFdLCAxNikpO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuXG4gIHNldEliZWFjb25EYXRhKHV1aWQsIG1ham9yLCBtaW5vciwgdHhQb3dlcikge1xuICAgIGxldCBkYXRhID0gW107XG4gICAgZGF0YS5wdXNoKDB4MDIsIDB4MTUpOyAvLyBmaXhlZCBkYXRhXG5cbiAgICBsZXQgdXVpZERhdGEgPSB0aGlzLmNvbnZlcnRVdWlkKHV1aWQpO1xuICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KGRhdGEsIHV1aWREYXRhKTtcblxuICAgIGRhdGEucHVzaCgobWFqb3IgPj4gOCkgJiAweGZmKTtcbiAgICBkYXRhLnB1c2goKG1ham9yID4+IDApICYgMHhmZik7XG4gICAgZGF0YS5wdXNoKChtaW5vciA+PiA4KSAmIDB4ZmYpO1xuICAgIGRhdGEucHVzaCgobWlub3IgPj4gMCkgJiAweGZmKTtcbiAgICBkYXRhLnB1c2goKHR4UG93ZXIgPj4gMCkgJiAweGZmKTtcblxuICAgIHRoaXMuc2V0TWFudWZhY3R1cmVyU3BlY2lmaWNEYXRhKDB4MDA0YywgZGF0YSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgZXh0ZW5kRXZhbEpzb24oanNvbikge1xuICAgIGlmIChqc29uKSB7XG4gICAgICBpZiAoanNvbi5mbGFncykge1xuICAgICAgICBpZiAoanNvbi5mbGFncy5pbmNsdWRlcygnbGltaXRlZF9kaXNjb3ZlcmFibGVfbW9kZScpKSB7XG4gICAgICAgICAgdGhpcy5zZXRMZUxpbWl0ZWREaXNjb3ZlcmFibGVNb2RlRmxhZygpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChqc29uLmZsYWdzLmluY2x1ZGVzKCdnZW5lcmFsX2Rpc2NvdmVyYWJsZV9tb2RlJykpIHtcbiAgICAgICAgICB0aGlzLnNldExlR2VuZXJhbERpc2NvdmVyYWJsZU1vZGVGbGFnKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGpzb24uZmxhZ3MuaW5jbHVkZXMoJ2JyX2Vkcl9ub3Rfc3VwcG9ydGVkJykpIHtcbiAgICAgICAgICB0aGlzLnNldEJyRWRyTm90U3VwcG9ydGVkRmxhZygpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChqc29uLmZsYWdzLmluY2x1ZGVzKCdsZV9icl9lZHJfY29udHJvbGxlcicpKSB7XG4gICAgICAgICAgdGhpcy5zZXRMZUJyRWRyQ29udHJvbGxlckZsYWcoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoanNvbi5mbGFncy5pbmNsdWRlcygnbGVfYnJfZWRyX2hvc3QnKSkge1xuICAgICAgICAgIHRoaXMuc2V0TGVCckVkckhvc3RGbGFnKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzZXRGbGFncyhmbGFnKSB7XG4gICAgbGV0IGRhdGEgPSB0aGlzLmdldFJvdygweDAxKTtcbiAgICBkYXRhWzBdID0gKGRhdGFbMF0gfHwgMCkgfCBmbGFnO1xuICAgIHRoaXMuc2V0Um93KDB4MDEsIGRhdGEpO1xuICB9XG5cbiAgc2V0TGVMaW1pdGVkRGlzY292ZXJhYmxlTW9kZUZsYWcoKSB7XG4gICAgdGhpcy5zZXRGbGFncygweDAxKTtcbiAgfVxuXG4gIHNldExlR2VuZXJhbERpc2NvdmVyYWJsZU1vZGVGbGFnKCkge1xuICAgIHRoaXMuc2V0RmxhZ3MoMHgwMik7XG4gIH1cblxuICBzZXRCckVkck5vdFN1cHBvcnRlZEZsYWcoKSB7XG4gICAgdGhpcy5zZXRGbGFncygweDA0KTtcbiAgfVxuXG4gIHNldExlQnJFZHJDb250cm9sbGVyRmxhZygpIHtcbiAgICB0aGlzLnNldEZsYWdzKDB4MDgpO1xuICB9XG5cbiAgc2V0TGVCckVkckhvc3RGbGFnKCkge1xuICAgIHRoaXMuc2V0RmxhZ3MoMHgxMCk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBCbGVBZHZlcnRpc2VtZW50QnVpbGRlcjtcbiJdfQ==

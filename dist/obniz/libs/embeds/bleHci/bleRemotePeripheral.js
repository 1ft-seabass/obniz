"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const BleRemoteService = require('./bleRemoteService');
const emitter = require('eventemitter3');
const BleHelper = require('./bleHelper');
class BleRemotePeripheral {
    constructor(obnizBle, address) {
        this.obnizBle = obnizBle;
        this.address = address;
        this.connected = false;
        this.device_type = null;
        this.address_type = null;
        this.ble_event_type = null;
        this.rssi = null;
        this.adv_data = null;
        this.scan_resp = null;
        this.keys = [
            'device_type',
            'address_type',
            'ble_event_type',
            'rssi',
            'adv_data',
            'scan_resp',
        ];
        this._services = [];
        this.emitter = new emitter();
    }
    /**
     *
     * @return {String} json value
     */
    toString() {
        return JSON.stringify({
            address: this.address,
            addressType: this.address_type,
            advertisement: this.adv_data,
            scanResponse: this.scan_resp,
            rssi: this.rssi,
        });
    }
    setParams(dic) {
        this.advertise_data_rows = null;
        for (let key in dic) {
            if (dic.hasOwnProperty(key) && this.keys.includes(key)) {
                this[key] = dic[key];
            }
        }
        this.analyseAdvertisement();
    }
    analyseAdvertisement() {
        if (!this.advertise_data_rows) {
            this.advertise_data_rows = [];
            if (this.adv_data) {
                for (let i = 0; i < this.adv_data.length; i++) {
                    let length = this.adv_data[i];
                    let arr = new Array(length);
                    for (let j = 0; j < length; j++) {
                        arr[j] = this.adv_data[i + j + 1];
                    }
                    this.advertise_data_rows.push(arr);
                    i = i + length;
                }
            }
            if (this.scan_resp) {
                for (let i = 0; i < this.scan_resp.length; i++) {
                    let length = this.scan_resp[i];
                    let arr = new Array(length);
                    for (let j = 0; j < length; j++) {
                        arr[j] = this.scan_resp[i + j + 1];
                    }
                    this.advertise_data_rows.push(arr);
                    i = i + length;
                }
            }
            this.setLocalName();
            this.setIBeacon();
        }
    }
    searchTypeVal(type) {
        this.analyseAdvertisement();
        for (let i = 0; i < this.advertise_data_rows.length; i++) {
            if (this.advertise_data_rows[i][0] === type) {
                let results = [].concat(this.advertise_data_rows[i]);
                results.shift();
                return results;
            }
        }
        return undefined;
    }
    setLocalName() {
        let data = this.searchTypeVal(0x09);
        if (!data) {
            data = this.searchTypeVal(0x08);
        }
        if (!data) {
            this.localName = null;
        }
        else {
            this.localName = String.fromCharCode.apply(null, data);
        }
    }
    setIBeacon() {
        let data = this.searchTypeVal(0xff);
        if (!data ||
            data[0] !== 0x4c ||
            data[1] !== 0x00 ||
            data[2] !== 0x02 ||
            data[3] !== 0x15 ||
            data.length !== 25) {
            this.iBeacon = null;
            return;
        }
        let uuidData = data.slice(4, 20);
        let uuid = '';
        for (let i = 0; i < uuidData.length; i++) {
            uuid = uuid + ('00' + uuidData[i].toString(16)).slice(-2);
            if (i === 4 - 1 ||
                i === 4 + 2 - 1 ||
                i === 4 + 2 * 2 - 1 ||
                i === 4 + 2 * 3 - 1) {
                uuid += '-';
            }
        }
        let major = (data[20] << 8) + data[21];
        let minor = (data[22] << 8) + data[23];
        let power = data[24];
        this.iBeacon = {
            uuid: uuid,
            major: major,
            minor: minor,
            power: power,
            rssi: this.rssi,
        };
    }
    _addServiceUuids(results, data, bit) {
        if (!data) {
            return;
        }
        let uuidLength = bit / 4;
        for (let i = 0; i < data.length; i = i + uuidLength) {
            let one = data.slice(i, i + uuidLength);
            results.push(this.obnizBle.constructor._dataArray2uuidHex(one, true));
        }
    }
    advertisementServiceUuids() {
        let results = [];
        this._addServiceUuids(results, this.searchTypeVal(0x02), 16);
        this._addServiceUuids(results, this.searchTypeVal(0x03), 16);
        this._addServiceUuids(results, this.searchTypeVal(0x04), 32);
        this._addServiceUuids(results, this.searchTypeVal(0x05), 32);
        this._addServiceUuids(results, this.searchTypeVal(0x06), 64);
        this._addServiceUuids(results, this.searchTypeVal(0x07), 64);
        return results;
    }
    connect() {
        this.obnizBle.scan.end();
        this.obnizBle.centralBindings.connect(this.address);
    }
    connectWait() {
        return new Promise((resolve, reject) => {
            // if (this.connected) {
            //   resolve();
            //   return;
            // }
            this.emitter.once('statusupdate', params => {
                if (params.status === 'connected') {
                    resolve(true); // for compatibility
                }
                else {
                    reject(new Error(`connection to peripheral name=${this.localName} address=${this.address} can't be established`));
                }
            });
            this.connect();
        });
    }
    disconnect() {
        this.obnizBle.centralBindings.disconnect(this.address);
    }
    disconnectWait() {
        return new Promise((resolve, reject) => {
            // if (!this.connected) {
            //   resolve();
            //   return;
            // }
            this.emitter.once('statusupdate', params => {
                if (params.status === 'disconnected') {
                    resolve(true); // for compatibility
                }
                else {
                    reject(new Error(`cutting connection to peripheral name=${this.localName} address=${this.address} was failed`));
                }
            });
            this.disconnect();
        });
    }
    get services() {
        return this._services;
    }
    getService(uuid) {
        uuid = BleHelper.uuidFilter(uuid);
        for (let key in this._services) {
            if (this._services[key].uuid === uuid) {
                return this._services[key];
            }
        }
        return undefined;
    }
    findService(param) {
        let serviceUuid = BleHelper.uuidFilter(param.service_uuid);
        return this.getService(serviceUuid);
    }
    findCharacteristic(param) {
        let serviceUuid = BleHelper.uuidFilter(param.service_uuid);
        let characteristicUuid = BleHelper.uuidFilter(param.characteristic_uuid);
        let s = this.getService(serviceUuid);
        if (s) {
            return s.getCharacteristic(characteristicUuid);
        }
        return null;
    }
    findDescriptor(param) {
        let descriptorUuid = BleHelper.uuidFilter(param.descriptor_uuid);
        let c = this.findCharacteristic(param);
        if (c) {
            return c.getDescriptor(descriptorUuid);
        }
        return null;
    }
    discoverAllServices() {
        this.obnizBle.centralBindings.discoverServices(this.address);
    }
    discoverAllServicesWait() {
        return new Promise(resolve => {
            this.emitter.once('discoverfinished', () => {
                let children = this._services.filter(elm => {
                    return elm.discoverdOnRemote;
                });
                resolve(children);
            });
            this.discoverAllServices();
        });
    }
    discoverAllHandlesWait() {
        return __awaiter(this, void 0, void 0, function* () {
            let ArrayFlat = function (array, depth) {
                let flattend = [];
                (function flat(array, depth) {
                    for (let el of array) {
                        if (Array.isArray(el) && depth > 0) {
                            flat(el, depth - 1);
                        }
                        else {
                            flattend.push(el);
                        }
                    }
                })(array, Math.floor(depth) || 1);
                return flattend;
            };
            let services = yield this.discoverAllServicesWait();
            let charsNest = yield Promise.all(services.map(s => s.discoverAllCharacteristicsWait()));
            let chars = ArrayFlat(charsNest);
            let descriptorsNest = yield Promise.all(chars.map(c => c.discoverAllDescriptorsWait()));
            // eslint-disable-next-line no-unused-vars
            let descriptors = ArrayFlat(descriptorsNest);
        });
    }
    onconnect() { }
    ondisconnect() { }
    ondiscoverservice() { }
    ondiscoverservicefinished() { }
    ondiscover() { }
    ondiscoverfinished() { }
    notifyFromServer(notifyName, params) {
        this.emitter.emit(notifyName, params);
        switch (notifyName) {
            case 'statusupdate': {
                if (params.status === 'connected') {
                    this.connected = true;
                    this.onconnect();
                }
                if (params.status === 'disconnected') {
                    this.connected = false;
                    this.ondisconnect();
                }
                break;
            }
            case 'discover': {
                let uuid = params.service_uuid;
                let child = this.getService(uuid);
                if (!child) {
                    let newService = new BleRemoteService({ uuid });
                    newService.parent = this;
                    this._services.push(newService);
                    child = newService;
                }
                child.discoverdOnRemote = true;
                this.ondiscoverservice(child);
                break;
            }
            case 'discoverfinished': {
                let children = this._services.filter(elm => {
                    return elm.discoverdOnRemote;
                });
                this.ondiscoverservicefinished(children);
                break;
            }
        }
    }
    onerror() { }
}
module.exports = BleRemotePeripheral;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvYmxlUmVtb3RlUGVyaXBoZXJhbC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUN2RCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBRXpDLE1BQU0sbUJBQW1CO0lBQ3ZCLFlBQVksUUFBUSxFQUFFLE9BQU87UUFDM0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFFdkIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDekIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFDM0IsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFFdEIsSUFBSSxDQUFDLElBQUksR0FBRztZQUNWLGFBQWE7WUFDYixjQUFjO1lBQ2QsZ0JBQWdCO1lBQ2hCLE1BQU07WUFDTixVQUFVO1lBQ1YsV0FBVztTQUNaLENBQUM7UUFFRixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVEOzs7T0FHRztJQUNILFFBQVE7UUFDTixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDcEIsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO1lB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Z0JBQzlCLE1BQU07YUFDUDtZQUNELEtBQUssa0JBQWtCLENBQUMsQ0FBQztnQkFDdkIsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQ3pDLE9BQU8sR0FBRyxDQUFDLGlCQUFpQixDQUFDO2dCQUMvQixDQUFDLENBQUMsQ0FBQztnQkFDSCxJQUFJLENBQUMseUJBQXlCLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ3pDLE1BQU07YUFDUDtTQUNGO0lBQ0gsQ0FBQztJQUVELE9BQU8sS0FBSSxDQUFDO0NBQ2I7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLG1CQUFtQixDQUFDIiwiZmlsZSI6Im9ibml6L2xpYnMvZW1iZWRzL2JsZUhjaS9ibGVSZW1vdGVQZXJpcGhlcmFsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgQmxlUmVtb3RlU2VydmljZSA9IHJlcXVpcmUoJy4vYmxlUmVtb3RlU2VydmljZScpO1xuY29uc3QgZW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50ZW1pdHRlcjMnKTtcbmNvbnN0IEJsZUhlbHBlciA9IHJlcXVpcmUoJy4vYmxlSGVscGVyJyk7XG5cbmNsYXNzIEJsZVJlbW90ZVBlcmlwaGVyYWwge1xuICBjb25zdHJ1Y3RvcihvYm5pekJsZSwgYWRkcmVzcykge1xuICAgIHRoaXMub2JuaXpCbGUgPSBvYm5pekJsZTtcbiAgICB0aGlzLmFkZHJlc3MgPSBhZGRyZXNzO1xuICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG5cbiAgICB0aGlzLmRldmljZV90eXBlID0gbnVsbDtcbiAgICB0aGlzLmFkZHJlc3NfdHlwZSA9IG51bGw7XG4gICAgdGhpcy5ibGVfZXZlbnRfdHlwZSA9IG51bGw7XG4gICAgdGhpcy5yc3NpID0gbnVsbDtcbiAgICB0aGlzLmFkdl9kYXRhID0gbnVsbDtcbiAgICB0aGlzLnNjYW5fcmVzcCA9IG51bGw7XG5cbiAgICB0aGlzLmtleXMgPSBbXG4gICAgICAnZGV2aWNlX3R5cGUnLFxuICAgICAgJ2FkZHJlc3NfdHlwZScsXG4gICAgICAnYmxlX2V2ZW50X3R5cGUnLFxuICAgICAgJ3Jzc2knLFxuICAgICAgJ2Fkdl9kYXRhJyxcbiAgICAgICdzY2FuX3Jlc3AnLFxuICAgIF07XG5cbiAgICB0aGlzLl9zZXJ2aWNlcyA9IFtdO1xuICAgIHRoaXMuZW1pdHRlciA9IG5ldyBlbWl0dGVyKCk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHJldHVybiB7U3RyaW5nfSBqc29uIHZhbHVlXG4gICAqL1xuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgYWRkcmVzczogdGhpcy5hZGRyZXNzLFxuICAgICAgYWRkcmVzc1R5cGU6IHRoaXMuYWRkcmVzc190eXBlLFxuICAgICAgYWR2ZXJ0aXNlbWVudDogdGhpcy5hZHZfZGF0YSxcbiAgICAgIHNjYW5SZXNwb25zZTogdGhpcy5zY2FuX3Jlc3AsXG4gICAgICByc3NpOiB0aGlzLnJzc2ksXG4gICAgfSk7XG4gIH1cblxuICBzZXRQYXJhbXMoZGljKSB7XG4gICAgdGhpcy5hZHZlcnRpc2VfZGF0YV9yb3dzID0gbnVsbDtcbiAgICBmb3IgKGxldCBrZXkgaW4gZGljKSB7XG4gICAgICBpZiAoZGljLmhhc093blByb3BlcnR5KGtleSkgJiYgdGhpcy5rZXlzLmluY2x1ZGVzKGtleSkpIHtcbiAgICAgICAgdGhpc1trZXldID0gZGljW2tleV07XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuYW5hbHlzZUFkdmVydGlzZW1lbnQoKTtcbiAgfVxuXG4gIGFuYWx5c2VBZHZlcnRpc2VtZW50KCkge1xuICAgIGlmICghdGhpcy5hZHZlcnRpc2VfZGF0YV9yb3dzKSB7XG4gICAgICB0aGlzLmFkdmVydGlzZV9kYXRhX3Jvd3MgPSBbXTtcbiAgICAgIGlmICh0aGlzLmFkdl9kYXRhKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hZHZfZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGxldCBsZW5ndGggPSB0aGlzLmFkdl9kYXRhW2ldO1xuICAgICAgICAgIGxldCBhcnIgPSBuZXcgQXJyYXkobGVuZ3RoKTtcbiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICBhcnJbal0gPSB0aGlzLmFkdl9kYXRhW2kgKyBqICsgMV07XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuYWR2ZXJ0aXNlX2RhdGFfcm93cy5wdXNoKGFycik7XG4gICAgICAgICAgaSA9IGkgKyBsZW5ndGg7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnNjYW5fcmVzcCkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2Nhbl9yZXNwLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgbGV0IGxlbmd0aCA9IHRoaXMuc2Nhbl9yZXNwW2ldO1xuICAgICAgICAgIGxldCBhcnIgPSBuZXcgQXJyYXkobGVuZ3RoKTtcbiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICBhcnJbal0gPSB0aGlzLnNjYW5fcmVzcFtpICsgaiArIDFdO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLmFkdmVydGlzZV9kYXRhX3Jvd3MucHVzaChhcnIpO1xuICAgICAgICAgIGkgPSBpICsgbGVuZ3RoO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLnNldExvY2FsTmFtZSgpO1xuICAgICAgdGhpcy5zZXRJQmVhY29uKCk7XG4gICAgfVxuICB9XG5cbiAgc2VhcmNoVHlwZVZhbCh0eXBlKSB7XG4gICAgdGhpcy5hbmFseXNlQWR2ZXJ0aXNlbWVudCgpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hZHZlcnRpc2VfZGF0YV9yb3dzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAodGhpcy5hZHZlcnRpc2VfZGF0YV9yb3dzW2ldWzBdID09PSB0eXBlKSB7XG4gICAgICAgIGxldCByZXN1bHRzID0gW10uY29uY2F0KHRoaXMuYWR2ZXJ0aXNlX2RhdGFfcm93c1tpXSk7XG4gICAgICAgIHJlc3VsdHMuc2hpZnQoKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBzZXRMb2NhbE5hbWUoKSB7XG4gICAgbGV0IGRhdGEgPSB0aGlzLnNlYXJjaFR5cGVWYWwoMHgwOSk7XG4gICAgaWYgKCFkYXRhKSB7XG4gICAgICBkYXRhID0gdGhpcy5zZWFyY2hUeXBlVmFsKDB4MDgpO1xuICAgIH1cbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgIHRoaXMubG9jYWxOYW1lID0gbnVsbDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2NhbE5hbWUgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIHNldElCZWFjb24oKSB7XG4gICAgbGV0IGRhdGEgPSB0aGlzLnNlYXJjaFR5cGVWYWwoMHhmZik7XG4gICAgaWYgKFxuICAgICAgIWRhdGEgfHxcbiAgICAgIGRhdGFbMF0gIT09IDB4NGMgfHxcbiAgICAgIGRhdGFbMV0gIT09IDB4MDAgfHxcbiAgICAgIGRhdGFbMl0gIT09IDB4MDIgfHxcbiAgICAgIGRhdGFbM10gIT09IDB4MTUgfHxcbiAgICAgIGRhdGEubGVuZ3RoICE9PSAyNVxuICAgICkge1xuICAgICAgdGhpcy5pQmVhY29uID0gbnVsbDtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IHV1aWREYXRhID0gZGF0YS5zbGljZSg0LCAyMCk7XG4gICAgbGV0IHV1aWQgPSAnJztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHV1aWREYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICB1dWlkID0gdXVpZCArICgnMDAnICsgdXVpZERhdGFbaV0udG9TdHJpbmcoMTYpKS5zbGljZSgtMik7XG4gICAgICBpZiAoXG4gICAgICAgIGkgPT09IDQgLSAxIHx8XG4gICAgICAgIGkgPT09IDQgKyAyIC0gMSB8fFxuICAgICAgICBpID09PSA0ICsgMiAqIDIgLSAxIHx8XG4gICAgICAgIGkgPT09IDQgKyAyICogMyAtIDFcbiAgICAgICkge1xuICAgICAgICB1dWlkICs9ICctJztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgbWFqb3IgPSAoZGF0YVsyMF0gPDwgOCkgKyBkYXRhWzIxXTtcbiAgICBsZXQgbWlub3IgPSAoZGF0YVsyMl0gPDwgOCkgKyBkYXRhWzIzXTtcbiAgICBsZXQgcG93ZXIgPSBkYXRhWzI0XTtcblxuICAgIHRoaXMuaUJlYWNvbiA9IHtcbiAgICAgIHV1aWQ6IHV1aWQsXG4gICAgICBtYWpvcjogbWFqb3IsXG4gICAgICBtaW5vcjogbWlub3IsXG4gICAgICBwb3dlcjogcG93ZXIsXG4gICAgICByc3NpOiB0aGlzLnJzc2ksXG4gICAgfTtcbiAgfVxuXG4gIF9hZGRTZXJ2aWNlVXVpZHMocmVzdWx0cywgZGF0YSwgYml0KSB7XG4gICAgaWYgKCFkYXRhKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCB1dWlkTGVuZ3RoID0gYml0IC8gNDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpID0gaSArIHV1aWRMZW5ndGgpIHtcbiAgICAgIGxldCBvbmUgPSBkYXRhLnNsaWNlKGksIGkgKyB1dWlkTGVuZ3RoKTtcbiAgICAgIHJlc3VsdHMucHVzaCh0aGlzLm9ibml6QmxlLmNvbnN0cnVjdG9yLl9kYXRhQXJyYXkydXVpZEhleChvbmUsIHRydWUpKTtcbiAgICB9XG4gIH1cblxuICBhZHZlcnRpc2VtZW50U2VydmljZVV1aWRzKCkge1xuICAgIGxldCByZXN1bHRzID0gW107XG4gICAgdGhpcy5fYWRkU2VydmljZVV1aWRzKHJlc3VsdHMsIHRoaXMuc2VhcmNoVHlwZVZhbCgweDAyKSwgMTYpO1xuICAgIHRoaXMuX2FkZFNlcnZpY2VVdWlkcyhyZXN1bHRzLCB0aGlzLnNlYXJjaFR5cGVWYWwoMHgwMyksIDE2KTtcbiAgICB0aGlzLl9hZGRTZXJ2aWNlVXVpZHMocmVzdWx0cywgdGhpcy5zZWFyY2hUeXBlVmFsKDB4MDQpLCAzMik7XG4gICAgdGhpcy5fYWRkU2VydmljZVV1aWRzKHJlc3VsdHMsIHRoaXMuc2VhcmNoVHlwZVZhbCgweDA1KSwgMzIpO1xuICAgIHRoaXMuX2FkZFNlcnZpY2VVdWlkcyhyZXN1bHRzLCB0aGlzLnNlYXJjaFR5cGVWYWwoMHgwNiksIDY0KTtcbiAgICB0aGlzLl9hZGRTZXJ2aWNlVXVpZHMocmVzdWx0cywgdGhpcy5zZWFyY2hUeXBlVmFsKDB4MDcpLCA2NCk7XG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH1cblxuICBjb25uZWN0KCkge1xuICAgIHRoaXMub2JuaXpCbGUuc2Nhbi5lbmQoKTtcbiAgICB0aGlzLm9ibml6QmxlLmNlbnRyYWxCaW5kaW5ncy5jb25uZWN0KHRoaXMuYWRkcmVzcyk7XG4gIH1cblxuICBjb25uZWN0V2FpdCgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gaWYgKHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAvLyAgIHJlc29sdmUoKTtcbiAgICAgIC8vICAgcmV0dXJuO1xuICAgICAgLy8gfVxuICAgICAgdGhpcy5lbWl0dGVyLm9uY2UoJ3N0YXR1c3VwZGF0ZScsIHBhcmFtcyA9PiB7XG4gICAgICAgIGlmIChwYXJhbXMuc3RhdHVzID09PSAnY29ubmVjdGVkJykge1xuICAgICAgICAgIHJlc29sdmUodHJ1ZSk7IC8vIGZvciBjb21wYXRpYmlsaXR5XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVqZWN0KFxuICAgICAgICAgICAgbmV3IEVycm9yKFxuICAgICAgICAgICAgICBgY29ubmVjdGlvbiB0byBwZXJpcGhlcmFsIG5hbWU9JHt0aGlzLmxvY2FsTmFtZX0gYWRkcmVzcz0ke1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkcmVzc1xuICAgICAgICAgICAgICB9IGNhbid0IGJlIGVzdGFibGlzaGVkYFxuICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhpcy5jb25uZWN0KCk7XG4gICAgfSk7XG4gIH1cblxuICBkaXNjb25uZWN0KCkge1xuICAgIHRoaXMub2JuaXpCbGUuY2VudHJhbEJpbmRpbmdzLmRpc2Nvbm5lY3QodGhpcy5hZGRyZXNzKTtcbiAgfVxuXG4gIGRpc2Nvbm5lY3RXYWl0KCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBpZiAoIXRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAvLyAgIHJlc29sdmUoKTtcbiAgICAgIC8vICAgcmV0dXJuO1xuICAgICAgLy8gfVxuICAgICAgdGhpcy5lbWl0dGVyLm9uY2UoJ3N0YXR1c3VwZGF0ZScsIHBhcmFtcyA9PiB7XG4gICAgICAgIGlmIChwYXJhbXMuc3RhdHVzID09PSAnZGlzY29ubmVjdGVkJykge1xuICAgICAgICAgIHJlc29sdmUodHJ1ZSk7IC8vIGZvciBjb21wYXRpYmlsaXR5XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVqZWN0KFxuICAgICAgICAgICAgbmV3IEVycm9yKFxuICAgICAgICAgICAgICBgY3V0dGluZyBjb25uZWN0aW9uIHRvIHBlcmlwaGVyYWwgbmFtZT0ke1xuICAgICAgICAgICAgICAgIHRoaXMubG9jYWxOYW1lXG4gICAgICAgICAgICAgIH0gYWRkcmVzcz0ke3RoaXMuYWRkcmVzc30gd2FzIGZhaWxlZGBcbiAgICAgICAgICAgIClcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMuZGlzY29ubmVjdCgpO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0IHNlcnZpY2VzKCkge1xuICAgIHJldHVybiB0aGlzLl9zZXJ2aWNlcztcbiAgfVxuXG4gIGdldFNlcnZpY2UodXVpZCkge1xuICAgIHV1aWQgPSBCbGVIZWxwZXIudXVpZEZpbHRlcih1dWlkKTtcbiAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5fc2VydmljZXMpIHtcbiAgICAgIGlmICh0aGlzLl9zZXJ2aWNlc1trZXldLnV1aWQgPT09IHV1aWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NlcnZpY2VzW2tleV07XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBmaW5kU2VydmljZShwYXJhbSkge1xuICAgIGxldCBzZXJ2aWNlVXVpZCA9IEJsZUhlbHBlci51dWlkRmlsdGVyKHBhcmFtLnNlcnZpY2VfdXVpZCk7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VydmljZShzZXJ2aWNlVXVpZCk7XG4gIH1cblxuICBmaW5kQ2hhcmFjdGVyaXN0aWMocGFyYW0pIHtcbiAgICBsZXQgc2VydmljZVV1aWQgPSBCbGVIZWxwZXIudXVpZEZpbHRlcihwYXJhbS5zZXJ2aWNlX3V1aWQpO1xuICAgIGxldCBjaGFyYWN0ZXJpc3RpY1V1aWQgPSBCbGVIZWxwZXIudXVpZEZpbHRlcihwYXJhbS5jaGFyYWN0ZXJpc3RpY191dWlkKTtcbiAgICBsZXQgcyA9IHRoaXMuZ2V0U2VydmljZShzZXJ2aWNlVXVpZCk7XG4gICAgaWYgKHMpIHtcbiAgICAgIHJldHVybiBzLmdldENoYXJhY3RlcmlzdGljKGNoYXJhY3RlcmlzdGljVXVpZCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZmluZERlc2NyaXB0b3IocGFyYW0pIHtcbiAgICBsZXQgZGVzY3JpcHRvclV1aWQgPSBCbGVIZWxwZXIudXVpZEZpbHRlcihwYXJhbS5kZXNjcmlwdG9yX3V1aWQpO1xuICAgIGxldCBjID0gdGhpcy5maW5kQ2hhcmFjdGVyaXN0aWMocGFyYW0pO1xuICAgIGlmIChjKSB7XG4gICAgICByZXR1cm4gYy5nZXREZXNjcmlwdG9yKGRlc2NyaXB0b3JVdWlkKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBkaXNjb3ZlckFsbFNlcnZpY2VzKCkge1xuICAgIHRoaXMub2JuaXpCbGUuY2VudHJhbEJpbmRpbmdzLmRpc2NvdmVyU2VydmljZXModGhpcy5hZGRyZXNzKTtcbiAgfVxuXG4gIGRpc2NvdmVyQWxsU2VydmljZXNXYWl0KCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIHRoaXMuZW1pdHRlci5vbmNlKCdkaXNjb3ZlcmZpbmlzaGVkJywgKCkgPT4ge1xuICAgICAgICBsZXQgY2hpbGRyZW4gPSB0aGlzLl9zZXJ2aWNlcy5maWx0ZXIoZWxtID0+IHtcbiAgICAgICAgICByZXR1cm4gZWxtLmRpc2NvdmVyZE9uUmVtb3RlO1xuICAgICAgICB9KTtcbiAgICAgICAgcmVzb2x2ZShjaGlsZHJlbik7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuZGlzY292ZXJBbGxTZXJ2aWNlcygpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZGlzY292ZXJBbGxIYW5kbGVzV2FpdCgpIHtcbiAgICBsZXQgQXJyYXlGbGF0ID0gZnVuY3Rpb24oYXJyYXksIGRlcHRoKSB7XG4gICAgICBsZXQgZmxhdHRlbmQgPSBbXTtcbiAgICAgIChmdW5jdGlvbiBmbGF0KGFycmF5LCBkZXB0aCkge1xuICAgICAgICBmb3IgKGxldCBlbCBvZiBhcnJheSkge1xuICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGVsKSAmJiBkZXB0aCA+IDApIHtcbiAgICAgICAgICAgIGZsYXQoZWwsIGRlcHRoIC0gMSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZsYXR0ZW5kLnB1c2goZWwpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSkoYXJyYXksIE1hdGguZmxvb3IoZGVwdGgpIHx8IDEpO1xuICAgICAgcmV0dXJuIGZsYXR0ZW5kO1xuICAgIH07XG5cbiAgICBsZXQgc2VydmljZXMgPSBhd2FpdCB0aGlzLmRpc2NvdmVyQWxsU2VydmljZXNXYWl0KCk7XG4gICAgbGV0IGNoYXJzTmVzdCA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgc2VydmljZXMubWFwKHMgPT4gcy5kaXNjb3ZlckFsbENoYXJhY3RlcmlzdGljc1dhaXQoKSlcbiAgICApO1xuICAgIGxldCBjaGFycyA9IEFycmF5RmxhdChjaGFyc05lc3QpO1xuICAgIGxldCBkZXNjcmlwdG9yc05lc3QgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIGNoYXJzLm1hcChjID0+IGMuZGlzY292ZXJBbGxEZXNjcmlwdG9yc1dhaXQoKSlcbiAgICApO1xuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzXG4gICAgbGV0IGRlc2NyaXB0b3JzID0gQXJyYXlGbGF0KGRlc2NyaXB0b3JzTmVzdCk7XG4gIH1cblxuICBvbmNvbm5lY3QoKSB7fVxuXG4gIG9uZGlzY29ubmVjdCgpIHt9XG5cbiAgb25kaXNjb3ZlcnNlcnZpY2UoKSB7fVxuXG4gIG9uZGlzY292ZXJzZXJ2aWNlZmluaXNoZWQoKSB7fVxuXG4gIG9uZGlzY292ZXIoKSB7fVxuXG4gIG9uZGlzY292ZXJmaW5pc2hlZCgpIHt9XG5cbiAgbm90aWZ5RnJvbVNlcnZlcihub3RpZnlOYW1lLCBwYXJhbXMpIHtcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdChub3RpZnlOYW1lLCBwYXJhbXMpO1xuICAgIHN3aXRjaCAobm90aWZ5TmFtZSkge1xuICAgICAgY2FzZSAnc3RhdHVzdXBkYXRlJzoge1xuICAgICAgICBpZiAocGFyYW1zLnN0YXR1cyA9PT0gJ2Nvbm5lY3RlZCcpIHtcbiAgICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IHRydWU7XG4gICAgICAgICAgdGhpcy5vbmNvbm5lY3QoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocGFyYW1zLnN0YXR1cyA9PT0gJ2Rpc2Nvbm5lY3RlZCcpIHtcbiAgICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgICAgIHRoaXMub25kaXNjb25uZWN0KCk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlICdkaXNjb3Zlcic6IHtcbiAgICAgICAgbGV0IHV1aWQgPSBwYXJhbXMuc2VydmljZV91dWlkO1xuICAgICAgICBsZXQgY2hpbGQgPSB0aGlzLmdldFNlcnZpY2UodXVpZCk7XG4gICAgICAgIGlmICghY2hpbGQpIHtcbiAgICAgICAgICBsZXQgbmV3U2VydmljZSA9IG5ldyBCbGVSZW1vdGVTZXJ2aWNlKHsgdXVpZCB9KTtcbiAgICAgICAgICBuZXdTZXJ2aWNlLnBhcmVudCA9IHRoaXM7XG4gICAgICAgICAgdGhpcy5fc2VydmljZXMucHVzaChuZXdTZXJ2aWNlKTtcbiAgICAgICAgICBjaGlsZCA9IG5ld1NlcnZpY2U7XG4gICAgICAgIH1cbiAgICAgICAgY2hpbGQuZGlzY292ZXJkT25SZW1vdGUgPSB0cnVlO1xuICAgICAgICB0aGlzLm9uZGlzY292ZXJzZXJ2aWNlKGNoaWxkKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlICdkaXNjb3ZlcmZpbmlzaGVkJzoge1xuICAgICAgICBsZXQgY2hpbGRyZW4gPSB0aGlzLl9zZXJ2aWNlcy5maWx0ZXIoZWxtID0+IHtcbiAgICAgICAgICByZXR1cm4gZWxtLmRpc2NvdmVyZE9uUmVtb3RlO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5vbmRpc2NvdmVyc2VydmljZWZpbmlzaGVkKGNoaWxkcmVuKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgb25lcnJvcigpIHt9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQmxlUmVtb3RlUGVyaXBoZXJhbDtcbiJdfQ==

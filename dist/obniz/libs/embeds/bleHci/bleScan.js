"use strict";
const emitter = require('eventemitter3');
const BleHelper = require('./bleHelper');
class BleScan {
    constructor(obnizBle) {
        this.scanTarget = null;
        this.scanSettings = {};
        this.obnizBle = obnizBle;
        this.emitter = new emitter();
        this.scanedPeripherals = [];
        this._timeoutTimer = null;
    }
    start(target, settings) {
        this.obnizBle.warningIfNotInitialize();
        if (!settings) {
            settings = {};
        }
        let timeout = settings.duration || 30;
        settings.duplicate = settings.duplicate === true ? true : false;
        this.scanSettings = settings;
        target = target || {};
        this.scanTarget = target;
        if (this.scanTarget &&
            this.scanTarget.uuids &&
            Array.isArray(this.scanTarget.uuids)) {
            this.scanTarget.uuids = this.scanTarget.uuids.map(elm => {
                return BleHelper.uuidFilter(elm);
            });
        }
        this.scanedPeripherals = [];
        this.obnizBle.centralBindings.startScanning(null, false);
        this.clearTimeoutTimer();
        this._timeoutTimer = setTimeout(() => {
            this._timeoutTimer = null;
            this.end();
        }, timeout * 1000);
    }
    startOneWait(target, settings) {
        let state = 0;
        return new Promise(resolve => {
            this.emitter.once('onfind', param => {
                if (state === 0) {
                    state = 1;
                    this.end();
                    resolve(param);
                }
            });
            this.emitter.once('onfinish', () => {
                if (state === 0) {
                    state = 1;
                    resolve(null);
                }
            });
            this.start(target, settings);
        });
    }
    startAllWait(target, settings) {
        return new Promise(resolve => {
            this.emitter.once('onfinish', () => {
                resolve(this.scanedPeripherals);
            });
            this.start(target, settings);
        });
    }
    end() {
        this.clearTimeoutTimer();
        this.obnizBle.centralBindings.stopScanning();
    }
    isTarget(peripheral) {
        if (this.scanTarget &&
            this.scanTarget.localName &&
            peripheral.localName !== this.scanTarget.localName) {
            return false;
        }
        if (this.scanTarget && this.scanTarget.uuids) {
            let uuids = peripheral.advertisementServiceUuids().map(e => {
                return BleHelper.uuidFilter(e);
            });
            for (let uuid of this.scanTarget.uuids) {
                if (!uuids.includes(uuid)) {
                    return false;
                }
            }
        }
        return true;
    }
    onfinish() { } //dummy
    onfind() { } //dummy
    notifyFromServer(notifyName, params) {
        switch (notifyName) {
            case 'onfind': {
                if (this.scanSettings.duplicate === false) {
                    //duplicate filter
                    if (this.scanedPeripherals.find(e => e.address === params.address)) {
                        break;
                    }
                }
                if (this.isTarget(params)) {
                    this.scanedPeripherals.push(params);
                    this.emitter.emit(notifyName, params);
                    this.onfind(params);
                }
                break;
            }
            case 'onfinish': {
                this.clearTimeoutTimer();
                this.emitter.emit(notifyName, this.scanedPeripherals);
                this.onfinish(this.scanedPeripherals);
                break;
            }
        }
    }
    clearTimeoutTimer() {
        if (this._timeoutTimer) {
            clearTimeout(this._timeoutTimer);
            this._timeoutTimer = null;
        }
    }
}
module.exports = BleScan;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvYmxlU2Nhbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUV6QyxNQUFNLE9BQU87SUFDWCxZQUFZLFFBQVE7UUFDbEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDdkIsSUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBRTdCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7SUFDNUIsQ0FBQztJQUVELEtBQUssQ0FBQyxNQUFNLEVBQUUsUUFBUTtRQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLHNCQUFzQixFQUFFLENBQUM7UUFFdkMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNiLFFBQVEsR0FBRyxFQUFFLENBQUM7U0FDZjtRQUNELElBQUksT0FBTyxHQUFHLFFBQVEsQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDO1FBQ3RDLFFBQVEsQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLFNBQVMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDO1FBQzdCLE1BQU0sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDO1FBQ3pCLElBQ0UsSUFBSSxDQUFDLFVBQVU7WUFDZixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUs7WUFDckIs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SUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztnQkFDdEMsTUFBTTthQUNQO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsaUJBQWlCO1FBQ2YsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3RCLFlBQVksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDakMsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7U0FDM0I7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyIsImZpbGUiOiJvYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvYmxlU2Nhbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGVtaXR0ZXIgPSByZXF1aXJlKCdldmVudGVtaXR0ZXIzJyk7XG5jb25zdCBCbGVIZWxwZXIgPSByZXF1aXJlKCcuL2JsZUhlbHBlcicpO1xuXG5jbGFzcyBCbGVTY2FuIHtcbiAgY29uc3RydWN0b3Iob2JuaXpCbGUpIHtcbiAgICB0aGlzLnNjYW5UYXJnZXQgPSBudWxsO1xuICAgIHRoaXMuc2NhblNldHRpbmdzID0ge307XG4gICAgdGhpcy5vYm5pekJsZSA9IG9ibml6QmxlO1xuICAgIHRoaXMuZW1pdHRlciA9IG5ldyBlbWl0dGVyKCk7XG5cbiAgICB0aGlzLnNjYW5lZFBlcmlwaGVyYWxzID0gW107XG4gICAgdGhpcy5fdGltZW91dFRpbWVyID0gbnVsbDtcbiAgfVxuXG4gIHN0YXJ0KHRhcmdldCwgc2V0dGluZ3MpIHtcbiAgICB0aGlzLm9ibml6QmxlLndhcm5pbmdJZk5vdEluaXRpYWxpemUoKTtcblxuICAgIGlmICghc2V0dGluZ3MpIHtcbiAgICAgIHNldHRpbmdzID0ge307XG4gICAgfVxuICAgIGxldCB0aW1lb3V0ID0gc2V0dGluZ3MuZHVyYXRpb24gfHwgMzA7XG4gICAgc2V0dGluZ3MuZHVwbGljYXRlID0gc2V0dGluZ3MuZHVwbGljYXRlID09PSB0cnVlID8gdHJ1ZSA6IGZhbHNlO1xuICAgIHRoaXMuc2NhblNldHRpbmdzID0gc2V0dGluZ3M7XG4gICAgdGFyZ2V0ID0gdGFyZ2V0IHx8IHt9O1xuICAgIHRoaXMuc2NhblRhcmdldCA9IHRhcmdldDtcbiAgICBpZiAoXG4gICAgICB0aGlzLnNjYW5UYXJnZXQgJiZcbiAgICAgIHRoaXMuc2NhblRhcmdldC51dWlkcyAmJlxuICAgICAgQXJyYXkuaXNBcnJheSh0aGlzLnNjYW5UYXJnZXQudXVpZHMpXG4gICAgKSB7XG4gICAgICB0aGlzLnNjYW5UYXJnZXQudXVpZHMgPSB0aGlzLnNjYW5UYXJnZXQudXVpZHMubWFwKGVsbSA9PiB7XG4gICAgICAgIHJldHVybiBCbGVIZWxwZXIudXVpZEZpbHRlcihlbG0pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHRoaXMuc2NhbmVkUGVyaXBoZXJhbHMgPSBbXTtcblxuICAgIHRoaXMub2JuaXpCbGUuY2VudHJhbEJpbmRpbmdzLnN0YXJ0U2Nhbm5pbmcobnVsbCwgZmFsc2UpO1xuXG4gICAgdGhpcy5jbGVhclRpbWVvdXRUaW1lcigpO1xuICAgIHRoaXMuX3RpbWVvdXRUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5fdGltZW91dFRpbWVyID0gbnVsbDtcbiAgICAgIHRoaXMuZW5kKCk7XG4gICAgfSwgdGltZW91dCAqIDEwMDApO1xuICB9XG5cbiAgc3RhcnRPbmVXYWl0KHRhcmdldCwgc2V0dGluZ3MpIHtcbiAgICBsZXQgc3RhdGUgPSAwO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgdGhpcy5lbWl0dGVyLm9uY2UoJ29uZmluZCcsIHBhcmFtID0+IHtcbiAgICAgICAgaWYgKHN0YXRlID09PSAwKSB7XG4gICAgICAgICAgc3RhdGUgPSAxO1xuICAgICAgICAgIHRoaXMuZW5kKCk7XG4gICAgICAgICAgcmVzb2x2ZShwYXJhbSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmVtaXR0ZXIub25jZSgnb25maW5pc2gnLCAoKSA9PiB7XG4gICAgICAgIGlmIChzdGF0ZSA9PT0gMCkge1xuICAgICAgICAgIHN0YXRlID0gMTtcbiAgICAgICAgICByZXNvbHZlKG51bGwpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5zdGFydCh0YXJnZXQsIHNldHRpbmdzKTtcbiAgICB9KTtcbiAgfVxuXG4gIHN0YXJ0QWxsV2FpdCh0YXJnZXQsIHNldHRpbmdzKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgdGhpcy5lbWl0dGVyLm9uY2UoJ29uZmluaXNoJywgKCkgPT4ge1xuICAgICAgICByZXNvbHZlKHRoaXMuc2NhbmVkUGVyaXBoZXJhbHMpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuc3RhcnQodGFyZ2V0LCBzZXR0aW5ncyk7XG4gICAgfSk7XG4gIH1cblxuICBlbmQoKSB7XG4gICAgdGhpcy5jbGVhclRpbWVvdXRUaW1lcigpO1xuICAgIHRoaXMub2JuaXpCbGUuY2VudHJhbEJpbmRpbmdzLnN0b3BTY2FubmluZygpO1xuICB9XG5cbiAgaXNUYXJnZXQocGVyaXBoZXJhbCkge1xuICAgIGlmIChcbiAgICAgIHRoaXMuc2NhblRhcmdldCAmJlxuICAgICAgdGhpcy5zY2FuVGFyZ2V0LmxvY2FsTmFtZSAmJlxuICAgICAgcGVyaXBoZXJhbC5sb2NhbE5hbWUgIT09IHRoaXMuc2NhblRhcmdldC5sb2NhbE5hbWVcbiAgICApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKHRoaXMuc2NhblRhcmdldCAmJiB0aGlzLnNjYW5UYXJnZXQudXVpZHMpIHtcbiAgICAgIGxldCB1dWlkcyA9IHBlcmlwaGVyYWwuYWR2ZXJ0aXNlbWVudFNlcnZpY2VVdWlkcygpLm1hcChlID0+IHtcbiAgICAgICAgcmV0dXJuIEJsZUhlbHBlci51dWlkRmlsdGVyKGUpO1xuICAgICAgfSk7XG4gICAgICBmb3IgKGxldCB1dWlkIG9mIHRoaXMuc2NhblRhcmdldC51dWlkcykge1xuICAgICAgICBpZiAoIXV1aWRzLmluY2x1ZGVzKHV1aWQpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgb25maW5pc2goKSB7fSAvL2R1bW15XG4gIG9uZmluZCgpIHt9IC8vZHVtbXlcblxuICBub3RpZnlGcm9tU2VydmVyKG5vdGlmeU5hbWUsIHBhcmFtcykge1xuICAgIHN3aXRjaCAobm90aWZ5TmFtZSkge1xuICAgICAgY2FzZSAnb25maW5kJzoge1xuICAgICAgICBpZiAodGhpcy5zY2FuU2V0dGluZ3MuZHVwbGljYXRlID09PSBmYWxzZSkge1xuICAgICAgICAgIC8vZHVwbGljYXRlIGZpbHRlclxuICAgICAgICAgIGlmICh0aGlzLnNjYW5lZFBlcmlwaGVyYWxzLmZpbmQoZSA9PiBlLmFkZHJlc3MgPT09IHBhcmFtcy5hZGRyZXNzKSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmlzVGFyZ2V0KHBhcmFtcykpIHtcbiAgICAgICAgICB0aGlzLnNjYW5lZFBlcmlwaGVyYWxzLnB1c2gocGFyYW1zKTtcbiAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdChub3RpZnlOYW1lLCBwYXJhbXMpO1xuICAgICAgICAgIHRoaXMub25maW5kKHBhcmFtcyk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlICdvbmZpbmlzaCc6IHtcbiAgICAgICAgdGhpcy5jbGVhclRpbWVvdXRUaW1lcigpO1xuICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdChub3RpZnlOYW1lLCB0aGlzLnNjYW5lZFBlcmlwaGVyYWxzKTtcbiAgICAgICAgdGhpcy5vbmZpbmlzaCh0aGlzLnNjYW5lZFBlcmlwaGVyYWxzKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY2xlYXJUaW1lb3V0VGltZXIoKSB7XG4gICAgaWYgKHRoaXMuX3RpbWVvdXRUaW1lcikge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXRUaW1lcik7XG4gICAgICB0aGlzLl90aW1lb3V0VGltZXIgPSBudWxsO1xuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEJsZVNjYW47XG4iXX0=

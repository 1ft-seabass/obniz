"use strict";
const BleDescriptor = require('./bleDescriptor');
const BleLocalAttributeAbstract = require('./bleLocalAttributeAbstract');
class BleCharacteristic extends BleLocalAttributeAbstract {
    constructor(obj) {
        super(obj);
        this._maxValueSize = null;
        this._updateValueCallback = null;
        this.addDescriptor = this.addChild;
        this.getDescriptor = this.getChild;
        this.properties = obj.properties || [];
        if (!Array.isArray(this.properties)) {
            this.properties = [this.properties];
        }
        this.permissions = obj.permissions || [];
        if (!Array.isArray(this.permissions)) {
            this.permissions = [this.permissions];
        }
    }
    get parentName() {
        return 'service';
    }
    get childrenClass() {
        return BleDescriptor;
    }
    get childrenName() {
        return 'descriptors';
    }
    get descriptors() {
        return this.children;
    }
    toJSON() {
        let obj = super.toJSON();
        if (this.properties.length > 0) {
            obj.properties = this.properties;
        }
        if (this.permissions.length > 0) {
            obj.permissions = this.permissions;
        }
        return obj;
    }
    toBufferObj() {
        let obj = super.toBufferObj();
        obj.properties = this.properties;
        obj.secure = [];
        return obj;
    }
    addProperty(param) {
        if (!this.properties.includes(param)) {
            this.properties.push(param);
        }
    }
    removeProperty(param) {
        this.properties = this.properties.filter(elm => {
            return elm !== param;
        });
    }
    addPermission(param) {
        if (!this.permissions.includes(param)) {
            this.permissions.push(param);
        }
    }
    removePermission(param) {
        this.permissions = this.permissions.filter(elm => {
            return elm !== param;
        });
    }
    emit(name, ...params) {
        let result = super.emit(name, ...params);
        if (result) {
            return result;
        }
        switch (name) {
            case 'subscribe':
                this._onSubscribe(...params);
                return true;
            case 'unsubscribe':
                this._onUnsubscribe(...params);
                return true;
            case 'notify':
                this._onNotify(...params);
                return true;
            case 'indicate':
                this._onIndicate(...params);
                return true;
            default:
                throw new Error('unknown emit');
        }
    }
    _onSubscribe(maxValueSize, updateValueCallback) {
        // console.log('_onSubscribe');
        this._maxValueSize = maxValueSize;
        this._updateValueCallback = updateValueCallback;
    }
    _onUnsubscribe() {
        this._maxValueSize = null;
        this._updateValueCallback = null;
    }
    _onNotify() { }
    _onIndicate() { }
    notify() {
        if (this._updateValueCallback) {
            this._updateValueCallback(Buffer.from(this.data));
        }
    }
}
module.exports = BleCharacteristic;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvYmxlQ2hhcmFjdGVyaXN0aWMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ2pELE1BQU0seUJBQXlCLEdBQUcsT0FBTyxDQUFDLDZCQUE2QixDQUFDLENBQUM7QUFFekUsTUFBTSxpQkFBa0IsU0FBUSx5QkFBeUI7SUFDdkQsWUFBWSxHQUFHO1FBQ2IsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRVgsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7UUFDMUIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQztRQUVqQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDbkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBRW5DLElBQUksQ0FBQyxVQUFVLEdBQUcsR0FBRyxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUM7UUFDdkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ25DLElBQUksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDckM7UUFFRCxJQUFJLENBQUMsV0FBVyxHQUFHLEdBQUcsQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUNwQyxJQUFJLENBQUMsV0FBVyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ3ZDO0lBQ0gsQ0FBQztJQUVELElBQUksVUFBVTtRQUNaLE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFRCxJQUFJLGFBQWE7UUFDZixPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFD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RyxZQUFZLENBQUM7UUFDbEMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLG1CQUFtQixDQUFDO0lBQ2xELENBQUM7SUFFRCxjQUFjO1FBQ1osSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7UUFDMUIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQztJQUNuQyxDQUFDO0lBRUQsU0FBUyxLQUFJLENBQUM7SUFFZCxXQUFXLEtBQUksQ0FBQztJQUVoQixNQUFNO1FBQ0osSUFBSSxJQUFJLENBQUMsb0JBQW9CLEVBQUU7WUFDN0IsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDbkQ7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLGlCQUFpQixDQUFDIiwiZmlsZSI6Im9ibml6L2xpYnMvZW1iZWRzL2JsZUhjaS9ibGVDaGFyYWN0ZXJpc3RpYy5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEJsZURlc2NyaXB0b3IgPSByZXF1aXJlKCcuL2JsZURlc2NyaXB0b3InKTtcbmNvbnN0IEJsZUxvY2FsQXR0cmlidXRlQWJzdHJhY3QgPSByZXF1aXJlKCcuL2JsZUxvY2FsQXR0cmlidXRlQWJzdHJhY3QnKTtcblxuY2xhc3MgQmxlQ2hhcmFjdGVyaXN0aWMgZXh0ZW5kcyBCbGVMb2NhbEF0dHJpYnV0ZUFic3RyYWN0IHtcbiAgY29uc3RydWN0b3Iob2JqKSB7XG4gICAgc3VwZXIob2JqKTtcblxuICAgIHRoaXMuX21heFZhbHVlU2l6ZSA9IG51bGw7XG4gICAgdGhpcy5fdXBkYXRlVmFsdWVDYWxsYmFjayA9IG51bGw7XG5cbiAgICB0aGlzLmFkZERlc2NyaXB0b3IgPSB0aGlzLmFkZENoaWxkO1xuICAgIHRoaXMuZ2V0RGVzY3JpcHRvciA9IHRoaXMuZ2V0Q2hpbGQ7XG5cbiAgICB0aGlzLnByb3BlcnRpZXMgPSBvYmoucHJvcGVydGllcyB8fCBbXTtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkodGhpcy5wcm9wZXJ0aWVzKSkge1xuICAgICAgdGhpcy5wcm9wZXJ0aWVzID0gW3RoaXMucHJvcGVydGllc107XG4gICAgfVxuXG4gICAgdGhpcy5wZXJtaXNzaW9ucyA9IG9iai5wZXJtaXNzaW9ucyB8fCBbXTtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkodGhpcy5wZXJtaXNzaW9ucykpIHtcbiAgICAgIHRoaXMucGVybWlzc2lvbnMgPSBbdGhpcy5wZXJtaXNzaW9uc107XG4gICAgfVxuICB9XG5cbiAgZ2V0IHBhcmVudE5hbWUoKSB7XG4gICAgcmV0dXJuICdzZXJ2aWNlJztcbiAgfVxuXG4gIGdldCBjaGlsZHJlbkNsYXNzKCkge1xuICAgIHJldHVybiBCbGVEZXNjcmlwdG9yO1xuICB9XG5cbiAgZ2V0IGNoaWxkcmVuTmFtZSgpIHtcbiAgICByZXR1cm4gJ2Rlc2NyaXB0b3JzJztcbiAgfVxuXG4gIGdldCBkZXNjcmlwdG9ycygpIHtcbiAgICByZXR1cm4gdGhpcy5jaGlsZHJlbjtcbiAgfVxuXG4gIHRvSlNPTigpIHtcbiAgICBsZXQgb2JqID0gc3VwZXIudG9KU09OKCk7XG5cbiAgICBpZiAodGhpcy5wcm9wZXJ0aWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIG9iai5wcm9wZXJ0aWVzID0gdGhpcy5wcm9wZXJ0aWVzO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnBlcm1pc3Npb25zLmxlbmd0aCA+IDApIHtcbiAgICAgIG9iai5wZXJtaXNzaW9ucyA9IHRoaXMucGVybWlzc2lvbnM7XG4gICAgfVxuICAgIHJldHVybiBvYmo7XG4gIH1cblxuICB0b0J1ZmZlck9iaigpIHtcbiAgICBsZXQgb2JqID0gc3VwZXIudG9CdWZmZXJPYmooKTtcblxuICAgIG9iai5wcm9wZXJ0aWVzID0gdGhpcy5wcm9wZXJ0aWVzO1xuICAgIG9iai5zZWN1cmUgPSBbXTtcblxuICAgIHJldHVybiBvYmo7XG4gIH1cblxuICBhZGRQcm9wZXJ0eShwYXJhbSkge1xuICAgIGlmICghdGhpcy5wcm9wZXJ0aWVzLmluY2x1ZGVzKHBhcmFtKSkge1xuICAgICAgdGhpcy5wcm9wZXJ0aWVzLnB1c2gocGFyYW0pO1xuICAgIH1cbiAgfVxuXG4gIHJlbW92ZVByb3BlcnR5KHBhcmFtKSB7XG4gICAgdGhpcy5wcm9wZXJ0aWVzID0gdGhpcy5wcm9wZXJ0aWVzLmZpbHRlcihlbG0gPT4ge1xuICAgICAgcmV0dXJuIGVsbSAhPT0gcGFyYW07XG4gICAgfSk7XG4gIH1cblxuICBhZGRQZXJtaXNzaW9uKHBhcmFtKSB7XG4gICAgaWYgKCF0aGlzLnBlcm1pc3Npb25zLmluY2x1ZGVzKHBhcmFtKSkge1xuICAgICAgdGhpcy5wZXJtaXNzaW9ucy5wdXNoKHBhcmFtKTtcbiAgICB9XG4gIH1cblxuICByZW1vdmVQZXJtaXNzaW9uKHBhcmFtKSB7XG4gICAgdGhpcy5wZXJtaXNzaW9ucyA9IHRoaXMucGVybWlzc2lvbnMuZmlsdGVyKGVsbSA9PiB7XG4gICAgICByZXR1cm4gZWxtICE9PSBwYXJhbTtcbiAgICB9KTtcbiAgfVxuXG4gIGVtaXQobmFtZSwgLi4ucGFyYW1zKSB7XG4gICAgbGV0IHJlc3VsdCA9IHN1cGVyLmVtaXQobmFtZSwgLi4ucGFyYW1zKTtcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICBzd2l0Y2ggKG5hbWUpIHtcbiAgICAgIGNhc2UgJ3N1YnNjcmliZSc6XG4gICAgICAgIHRoaXMuX29uU3Vic2NyaWJlKC4uLnBhcmFtcyk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgY2FzZSAndW5zdWJzY3JpYmUnOlxuICAgICAgICB0aGlzLl9vblVuc3Vic2NyaWJlKC4uLnBhcmFtcyk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgY2FzZSAnbm90aWZ5JzpcbiAgICAgICAgdGhpcy5fb25Ob3RpZnkoLi4ucGFyYW1zKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICBjYXNlICdpbmRpY2F0ZSc6XG4gICAgICAgIHRoaXMuX29uSW5kaWNhdGUoLi4ucGFyYW1zKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Vua25vd24gZW1pdCcpO1xuICAgIH1cbiAgfVxuXG4gIF9vblN1YnNjcmliZShtYXhWYWx1ZVNpemUsIHVwZGF0ZVZhbHVlQ2FsbGJhY2spIHtcbiAgICAvLyBjb25zb2xlLmxvZygnX29uU3Vic2NyaWJlJyk7XG4gICAgdGhpcy5fbWF4VmFsdWVTaXplID0gbWF4VmFsdWVTaXplO1xuICAgIHRoaXMuX3VwZGF0ZVZhbHVlQ2FsbGJhY2sgPSB1cGRhdGVWYWx1ZUNhbGxiYWNrO1xuICB9XG5cbiAgX29uVW5zdWJzY3JpYmUoKSB7XG4gICAgdGhpcy5fbWF4VmFsdWVTaXplID0gbnVsbDtcbiAgICB0aGlzLl91cGRhdGVWYWx1ZUNhbGxiYWNrID0gbnVsbDtcbiAgfVxuXG4gIF9vbk5vdGlmeSgpIHt9XG5cbiAgX29uSW5kaWNhdGUoKSB7fVxuXG4gIG5vdGlmeSgpIHtcbiAgICBpZiAodGhpcy5fdXBkYXRlVmFsdWVDYWxsYmFjaykge1xuICAgICAgdGhpcy5fdXBkYXRlVmFsdWVDYWxsYmFjayhCdWZmZXIuZnJvbSh0aGlzLmRhdGEpKTtcbiAgICB9XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBCbGVDaGFyYWN0ZXJpc3RpYztcbiJdfQ==

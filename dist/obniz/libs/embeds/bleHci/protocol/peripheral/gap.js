"use strict";
// var debug = require('debug')('gap');
const debug = () => { };
let events = require('events');
let os = require('os');
let Hci = require('../hci');
let isLinux = os.platform() === 'linux';
let isIntelEdison = isLinux && os.release().indexOf('edison') !== -1;
let isYocto = isLinux && os.release().indexOf('yocto') !== -1;
class Gap extends events.EventEmitter {
    constructor(hci) {
        super();
        this._hci = hci;
        this._advertiseState = null;
        this._hci.on('error', this.onHciError.bind(this));
        this._hci.on('leAdvertisingParametersSet', this.onHciLeAdvertisingParametersSet.bind(this));
        this._hci.on('leAdvertisingDataSet', this.onHciLeAdvertisingDataSet.bind(this));
        this._hci.on('leScanResponseDataSet', this.onHciLeScanResponseDataSet.bind(this));
        this._hci.on('leAdvertiseEnableSet', this.onHciLeAdvertiseEnableSet.bind(this));
    }
    startAdvertising(name, serviceUuids) {
        debug('startAdvertising: name = ' +
            name +
            ', serviceUuids = ' +
            JSON.stringify(serviceUuids, null, 2));
        let advertisementDataLength = 3;
        let scanDataLength = 0;
        let serviceUuids16bit = [];
        let serviceUuids128bit = [];
        let i = 0;
        if (name && name.length) {
            scanDataLength += 2 + name.length;
        }
        if (serviceUuids && serviceUuids.length) {
            for (i = 0; i < serviceUuids.length; i++) {
                let serviceUuid = Buffer.from(serviceUuids[i]
                    .match(/.{1,2}/g)
                    .reverse()
                    .join(''), 'hex');
                if (serviceUuid.length === 2) {
                    serviceUuids16bit.push(serviceUuid);
                }
                else if (serviceUuid.length === 16) {
                    serviceUuids128bit.push(serviceUuid);
                }
            }
        }
        if (serviceUuids16bit.length) {
            advertisementDataLength += 2 + 2 * serviceUuids16bit.length;
        }
        if (serviceUuids128bit.length) {
            advertisementDataLength += 2 + 16 * serviceUuids128bit.length;
        }
        let advertisementData = Buffer.alloc(advertisementDataLength);
        let scanData = Buffer.alloc(scanDataLength);
        // flags
        advertisementData.writeUInt8(2, 0);
        advertisementData.writeUInt8(0x01, 1);
        advertisementData.writeUInt8(0x06, 2);
        let advertisementDataOffset = 3;
        if (serviceUuids16bit.length) {
            advertisementData.writeUInt8(1 + 2 * serviceUuids16bit.length, advertisementDataOffset);
            advertisementDataOffset++;
            advertisementData.writeUInt8(0x03, advertisementDataOffset);
            advertisementDataOffset++;
            for (i = 0; i < serviceUuids16bit.length; i++) {
                serviceUuids16bit[i].copy(advertisementData, advertisementDataOffset);
                advertisementDataOffset += serviceUuids16bit[i].length;
            }
        }
        if (serviceUuids128bit.length) {
            advertisementData.writeUInt8(1 + 16 * serviceUuids128bit.length, advertisementDataOffset);
            advertisementDataOffset++;
            advertisementData.writeUInt8(0x06, advertisementDataOffset);
            advertisementDataOffset++;
            for (i = 0; i < serviceUuids128bit.length; i++) {
                serviceUuids128bit[i].copy(advertisementData, advertisementDataOffset);
                advertisementDataOffset += serviceUuids128bit[i].length;
            }
        }
        // name
        if (name && name.length) {
            let nameBuffer = Buffer.alloc(name);
            scanData.writeUInt8(1 + nameBuffer.length, 0);
            scanData.writeUInt8(0x08, 1);
            nameBuffer.copy(scanData, 2);
        }
        this.startAdvertisingWithEIRData(advertisementData, scanData);
    }
    startAdvertisingIBeacon(data) {
        debug('startAdvertisingIBeacon: data = ' + data.toString('hex'));
        let dataLength = data.length;
        let manufacturerDataLength = 4 + dataLength;
        let advertisementDataLength = 5 + manufacturerDataLength;
        // let scanDataLength = 0;
        let advertisementData = Buffer.alloc(advertisementDataLength);
        let scanData = Buffer.alloc(0);
        // flags
        advertisementData.writeUInt8(2, 0);
        advertisementData.writeUInt8(0x01, 1);
        advertisementData.writeUInt8(0x06, 2);
        advertisementData.writeUInt8(manufacturerDataLength + 1, 3);
        advertisementData.writeUInt8(0xff, 4);
        advertisementData.writeUInt16LE(0x004c, 5); // Apple Company Identifier LE (16 bit)
        advertisementData.writeUInt8(0x02, 7); // type, 2 => iBeacon
        advertisementData.writeUInt8(dataLength, 8);
        data.copy(advertisementData, 9);
        this.startAdvertisingWithEIRData(advertisementData, scanData);
    }
    startAdvertisingWithEIRData(advertisementData, scanData) {
        advertisementData = advertisementData || Buffer.alloc(0);
        scanData = scanData || Buffer.alloc(0);
        debug('startAdvertisingWithEIRData: advertisement data = ' +
            advertisementData.toString('hex') +
            ', scan data = ' +
            scanData.toString('hex'));
        let error = null;
        if (advertisementData.length > 31) {
            error = new Error('Advertisement data is over maximum limit of 31 bytes');
        }
        else if (scanData.length > 31) {
            error = new Error('Scan data is over maximum limit of 31 bytes');
        }
        if (error) {
            this.emit('advertisingStart', error);
        }
        else {
            this._advertiseState = 'starting';
            if (isIntelEdison || isYocto) {
                // work around for Intel Edison
                debug('skipping first set of scan response and advertisement data');
            }
            else {
                this._hci.setScanResponseData(scanData);
                this._hci.setAdvertisingData(advertisementData);
            }
            this._hci.setAdvertiseEnable(true);
            this._hci.setScanResponseData(scanData);
            this._hci.setAdvertisingData(advertisementData);
        }
    }
    restartAdvertising() {
        this._advertiseState = 'restarting';
        this._hci.setAdvertiseEnable(true);
    }
    stopAdvertising() {
        this._advertiseState = 'stopping';
        this._hci.setAdvertiseEnable(false);
    }
    onHciError(error) { }
    onHciLeAdvertisingParametersSet(status) { }
    onHciLeAdvertisingDataSet(status) { }
    onHciLeScanResponseDataSet(status) { }
    onHciLeAdvertiseEnableSet(status) {
        if (this._advertiseState === 'starting') {
            this._advertiseState = 'started';
            let error = null;
            if (status) {
                error = new Error(Hci.STATUS_MAPPER[status] || 'Unknown (' + status + ')');
            }
            this.emit('advertisingStart', error);
        }
        else if (this._advertiseState === 'stopping') {
            this._advertiseState = 'stopped';
            this.emit('advertisingStop');
        }
    }
}
module.exports = Gap;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvcHJvdG9jb2wvcGVyaXBoZXJhbC9nYXAuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHVDQUF1QztBQUN2QyxNQUFNLEtBQUssR0FBRyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUM7QUFFdkIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUV2QixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFFNUIsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDLFFBQVEsRUFBRSxLQUFLLE9BQU8sQ0FBQztBQUN4QyxJQUFJLGFBQWEsR0FBRyxPQUFPLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUNyRSxJQUFJLE9BQU8sR0FBRyxPQUFPLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUU5RCxNQUFNLEdBQUksU0FBUSxNQUFNLENBQUMsWUFBWTtJQUNuQyxZQUFZLEdBQUc7UUFDYixLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO1FBRWhCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1FBRTVCLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRWxELElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUNWLDRCQUE0QixFQUM1QixJQUFJLENBQUMsK0JBQStCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUNoRCxDQUFDO1FBQ0Ys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QUMsTUFBTSxDQUFDLElBQUksV0FBVyxHQUFHLE1BQU0sR0FBRyxHQUFHLENBQ3hELENBQUM7YUFDSDtZQUVELElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdEM7YUFBTSxJQUFJLElBQUksQ0FBQyxlQUFlLEtBQUssVUFBVSxFQUFFO1lBQzlDLElBQUksQ0FBQyxlQUFlLEdBQUcsU0FBUyxDQUFDO1lBRWpDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztTQUM5QjtJQUNILENBQUM7Q0FDRjtBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDIiwiZmlsZSI6Im9ibml6L2xpYnMvZW1iZWRzL2JsZUhjaS9wcm90b2NvbC9wZXJpcGhlcmFsL2dhcC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHZhciBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJykoJ2dhcCcpO1xuY29uc3QgZGVidWcgPSAoKSA9PiB7fTtcblxubGV0IGV2ZW50cyA9IHJlcXVpcmUoJ2V2ZW50cycpO1xubGV0IG9zID0gcmVxdWlyZSgnb3MnKTtcblxubGV0IEhjaSA9IHJlcXVpcmUoJy4uL2hjaScpO1xuXG5sZXQgaXNMaW51eCA9IG9zLnBsYXRmb3JtKCkgPT09ICdsaW51eCc7XG5sZXQgaXNJbnRlbEVkaXNvbiA9IGlzTGludXggJiYgb3MucmVsZWFzZSgpLmluZGV4T2YoJ2VkaXNvbicpICE9PSAtMTtcbmxldCBpc1lvY3RvID0gaXNMaW51eCAmJiBvcy5yZWxlYXNlKCkuaW5kZXhPZigneW9jdG8nKSAhPT0gLTE7XG5cbmNsYXNzIEdhcCBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvcihoY2kpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX2hjaSA9IGhjaTtcblxuICAgIHRoaXMuX2FkdmVydGlzZVN0YXRlID0gbnVsbDtcblxuICAgIHRoaXMuX2hjaS5vbignZXJyb3InLCB0aGlzLm9uSGNpRXJyb3IuYmluZCh0aGlzKSk7XG5cbiAgICB0aGlzLl9oY2kub24oXG4gICAgICAnbGVBZHZlcnRpc2luZ1BhcmFtZXRlcnNTZXQnLFxuICAgICAgdGhpcy5vbkhjaUxlQWR2ZXJ0aXNpbmdQYXJhbWV0ZXJzU2V0LmJpbmQodGhpcylcbiAgICApO1xuICAgIHRoaXMuX2hjaS5vbihcbiAgICAgICdsZUFkdmVydGlzaW5nRGF0YVNldCcsXG4gICAgICB0aGlzLm9uSGNpTGVBZHZlcnRpc2luZ0RhdGFTZXQuYmluZCh0aGlzKVxuICAgICk7XG4gICAgdGhpcy5faGNpLm9uKFxuICAgICAgJ2xlU2NhblJlc3BvbnNlRGF0YVNldCcsXG4gICAgICB0aGlzLm9uSGNpTGVTY2FuUmVzcG9uc2VEYXRhU2V0LmJpbmQodGhpcylcbiAgICApO1xuICAgIHRoaXMuX2hjaS5vbihcbiAgICAgICdsZUFkdmVydGlzZUVuYWJsZVNldCcsXG4gICAgICB0aGlzLm9uSGNpTGVBZHZlcnRpc2VFbmFibGVTZXQuYmluZCh0aGlzKVxuICAgICk7XG4gIH1cblxuICBzdGFydEFkdmVydGlzaW5nKG5hbWUsIHNlcnZpY2VVdWlkcykge1xuICAgIGRlYnVnKFxuICAgICAgJ3N0YXJ0QWR2ZXJ0aXNpbmc6IG5hbWUgPSAnICtcbiAgICAgICAgbmFtZSArXG4gICAgICAgICcsIHNlcnZpY2VVdWlkcyA9ICcgK1xuICAgICAgICBKU09OLnN0cmluZ2lmeShzZXJ2aWNlVXVpZHMsIG51bGwsIDIpXG4gICAgKTtcblxuICAgIGxldCBhZHZlcnRpc2VtZW50RGF0YUxlbmd0aCA9IDM7XG4gICAgbGV0IHNjYW5EYXRhTGVuZ3RoID0gMDtcblxuICAgIGxldCBzZXJ2aWNlVXVpZHMxNmJpdCA9IFtdO1xuICAgIGxldCBzZXJ2aWNlVXVpZHMxMjhiaXQgPSBbXTtcbiAgICBsZXQgaSA9IDA7XG5cbiAgICBpZiAobmFtZSAmJiBuYW1lLmxlbmd0aCkge1xuICAgICAgc2NhbkRhdGFMZW5ndGggKz0gMiArIG5hbWUubGVuZ3RoO1xuICAgIH1cblxuICAgIGlmIChzZXJ2aWNlVXVpZHMgJiYgc2VydmljZVV1aWRzLmxlbmd0aCkge1xuICAgICAgZm9yIChpID0gMDsgaSA8IHNlcnZpY2VVdWlkcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBsZXQgc2VydmljZVV1aWQgPSBCdWZmZXIuZnJvbShcbiAgICAgICAgICBzZXJ2aWNlVXVpZHNbaV1cbiAgICAgICAgICAgIC5tYXRjaCgvLnsxLDJ9L2cpXG4gICAgICAgICAgICAucmV2ZXJzZSgpXG4gICAgICAgICAgICAuam9pbignJyksXG4gICAgICAgICAgJ2hleCdcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoc2VydmljZVV1aWQubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgc2VydmljZVV1aWRzMTZiaXQucHVzaChzZXJ2aWNlVXVpZCk7XG4gICAgICAgIH0gZWxzZSBpZiAoc2VydmljZVV1aWQubGVuZ3RoID09PSAxNikge1xuICAgICAgICAgIHNlcnZpY2VVdWlkczEyOGJpdC5wdXNoKHNlcnZpY2VVdWlkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChzZXJ2aWNlVXVpZHMxNmJpdC5sZW5ndGgpIHtcbiAgICAgIGFkdmVydGlzZW1lbnREYXRhTGVuZ3RoICs9IDIgKyAyICogc2VydmljZVV1aWRzMTZiaXQubGVuZ3RoO1xuICAgIH1cblxuICAgIGlmIChzZXJ2aWNlVXVpZHMxMjhiaXQubGVuZ3RoKSB7XG4gICAgICBhZHZlcnRpc2VtZW50RGF0YUxlbmd0aCArPSAyICsgMTYgKiBzZXJ2aWNlVXVpZHMxMjhiaXQubGVuZ3RoO1xuICAgIH1cblxuICAgIGxldCBhZHZlcnRpc2VtZW50RGF0YSA9IEJ1ZmZlci5hbGxvYyhhZHZlcnRpc2VtZW50RGF0YUxlbmd0aCk7XG4gICAgbGV0IHNjYW5EYXRhID0gQnVmZmVyLmFsbG9jKHNjYW5EYXRhTGVuZ3RoKTtcblxuICAgIC8vIGZsYWdzXG4gICAgYWR2ZXJ0aXNlbWVudERhdGEud3JpdGVVSW50OCgyLCAwKTtcbiAgICBhZHZlcnRpc2VtZW50RGF0YS53cml0ZVVJbnQ4KDB4MDEsIDEpO1xuICAgIGFkdmVydGlzZW1lbnREYXRhLndyaXRlVUludDgoMHgwNiwgMik7XG5cbiAgICBsZXQgYWR2ZXJ0aXNlbWVudERhdGFPZmZzZXQgPSAzO1xuXG4gICAgaWYgKHNlcnZpY2VVdWlkczE2Yml0Lmxlbmd0aCkge1xuICAgICAgYWR2ZXJ0aXNlbWVudERhdGEud3JpdGVVSW50OChcbiAgICAgICAgMSArIDIgKiBzZXJ2aWNlVXVpZHMxNmJpdC5sZW5ndGgsXG4gICAgICAgIGFkdmVydGlzZW1lbnREYXRhT2Zmc2V0XG4gICAgICApO1xuICAgICAgYWR2ZXJ0aXNlbWVudERhdGFPZmZzZXQrKztcblxuICAgICAgYWR2ZXJ0aXNlbWVudERhdGEud3JpdGVVSW50OCgweDAzLCBhZHZlcnRpc2VtZW50RGF0YU9mZnNldCk7XG4gICAgICBhZHZlcnRpc2VtZW50RGF0YU9mZnNldCsrO1xuXG4gICAgICBmb3IgKGkgPSAwOyBpIDwgc2VydmljZVV1aWRzMTZiaXQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgc2VydmljZVV1aWRzMTZiaXRbaV0uY29weShhZHZlcnRpc2VtZW50RGF0YSwgYWR2ZXJ0aXNlbWVudERhdGFPZmZzZXQpO1xuICAgICAgICBhZHZlcnRpc2VtZW50RGF0YU9mZnNldCArPSBzZXJ2aWNlVXVpZHMxNmJpdFtpXS5sZW5ndGg7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHNlcnZpY2VVdWlkczEyOGJpdC5sZW5ndGgpIHtcbiAgICAgIGFkdmVydGlzZW1lbnREYXRhLndyaXRlVUludDgoXG4gICAgICAgIDEgKyAxNiAqIHNlcnZpY2VVdWlkczEyOGJpdC5sZW5ndGgsXG4gICAgICAgIGFkdmVydGlzZW1lbnREYXRhT2Zmc2V0XG4gICAgICApO1xuICAgICAgYWR2ZXJ0aXNlbWVudERhdGFPZmZzZXQrKztcblxuICAgICAgYWR2ZXJ0aXNlbWVudERhdGEud3JpdGVVSW50OCgweDA2LCBhZHZlcnRpc2VtZW50RGF0YU9mZnNldCk7XG4gICAgICBhZHZlcnRpc2VtZW50RGF0YU9mZnNldCsrO1xuXG4gICAgICBmb3IgKGkgPSAwOyBpIDwgc2VydmljZVV1aWRzMTI4Yml0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHNlcnZpY2VVdWlkczEyOGJpdFtpXS5jb3B5KGFkdmVydGlzZW1lbnREYXRhLCBhZHZlcnRpc2VtZW50RGF0YU9mZnNldCk7XG4gICAgICAgIGFkdmVydGlzZW1lbnREYXRhT2Zmc2V0ICs9IHNlcnZpY2VVdWlkczEyOGJpdFtpXS5sZW5ndGg7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gbmFtZVxuICAgIGlmIChuYW1lICYmIG5hbWUubGVuZ3RoKSB7XG4gICAgICBsZXQgbmFtZUJ1ZmZlciA9IEJ1ZmZlci5hbGxvYyhuYW1lKTtcblxuICAgICAgc2NhbkRhdGEud3JpdGVVSW50OCgxICsgbmFtZUJ1ZmZlci5sZW5ndGgsIDApO1xuICAgICAgc2NhbkRhdGEud3JpdGVVSW50OCgweDA4LCAxKTtcbiAgICAgIG5hbWVCdWZmZXIuY29weShzY2FuRGF0YSwgMik7XG4gICAgfVxuXG4gICAgdGhpcy5zdGFydEFkdmVydGlzaW5nV2l0aEVJUkRhdGEoYWR2ZXJ0aXNlbWVudERhdGEsIHNjYW5EYXRhKTtcbiAgfVxuXG4gIHN0YXJ0QWR2ZXJ0aXNpbmdJQmVhY29uKGRhdGEpIHtcbiAgICBkZWJ1Zygnc3RhcnRBZHZlcnRpc2luZ0lCZWFjb246IGRhdGEgPSAnICsgZGF0YS50b1N0cmluZygnaGV4JykpO1xuXG4gICAgbGV0IGRhdGFMZW5ndGggPSBkYXRhLmxlbmd0aDtcbiAgICBsZXQgbWFudWZhY3R1cmVyRGF0YUxlbmd0aCA9IDQgKyBkYXRhTGVuZ3RoO1xuICAgIGxldCBhZHZlcnRpc2VtZW50RGF0YUxlbmd0aCA9IDUgKyBtYW51ZmFjdHVyZXJEYXRhTGVuZ3RoO1xuICAgIC8vIGxldCBzY2FuRGF0YUxlbmd0aCA9IDA7XG5cbiAgICBsZXQgYWR2ZXJ0aXNlbWVudERhdGEgPSBCdWZmZXIuYWxsb2MoYWR2ZXJ0aXNlbWVudERhdGFMZW5ndGgpO1xuICAgIGxldCBzY2FuRGF0YSA9IEJ1ZmZlci5hbGxvYygwKTtcblxuICAgIC8vIGZsYWdzXG4gICAgYWR2ZXJ0aXNlbWVudERhdGEud3JpdGVVSW50OCgyLCAwKTtcbiAgICBhZHZlcnRpc2VtZW50RGF0YS53cml0ZVVJbnQ4KDB4MDEsIDEpO1xuICAgIGFkdmVydGlzZW1lbnREYXRhLndyaXRlVUludDgoMHgwNiwgMik7XG5cbiAgICBhZHZlcnRpc2VtZW50RGF0YS53cml0ZVVJbnQ4KG1hbnVmYWN0dXJlckRhdGFMZW5ndGggKyAxLCAzKTtcbiAgICBhZHZlcnRpc2VtZW50RGF0YS53cml0ZVVJbnQ4KDB4ZmYsIDQpO1xuICAgIGFkdmVydGlzZW1lbnREYXRhLndyaXRlVUludDE2TEUoMHgwMDRjLCA1KTsgLy8gQXBwbGUgQ29tcGFueSBJZGVudGlmaWVyIExFICgxNiBiaXQpXG4gICAgYWR2ZXJ0aXNlbWVudERhdGEud3JpdGVVSW50OCgweDAyLCA3KTsgLy8gdHlwZSwgMiA9PiBpQmVhY29uXG4gICAgYWR2ZXJ0aXNlbWVudERhdGEud3JpdGVVSW50OChkYXRhTGVuZ3RoLCA4KTtcblxuICAgIGRhdGEuY29weShhZHZlcnRpc2VtZW50RGF0YSwgOSk7XG5cbiAgICB0aGlzLnN0YXJ0QWR2ZXJ0aXNpbmdXaXRoRUlSRGF0YShhZHZlcnRpc2VtZW50RGF0YSwgc2NhbkRhdGEpO1xuICB9XG5cbiAgc3RhcnRBZHZlcnRpc2luZ1dpdGhFSVJEYXRhKGFkdmVydGlzZW1lbnREYXRhLCBzY2FuRGF0YSkge1xuICAgIGFkdmVydGlzZW1lbnREYXRhID0gYWR2ZXJ0aXNlbWVudERhdGEgfHwgQnVmZmVyLmFsbG9jKDApO1xuICAgIHNjYW5EYXRhID0gc2NhbkRhdGEgfHwgQnVmZmVyLmFsbG9jKDApO1xuXG4gICAgZGVidWcoXG4gICAgICAnc3RhcnRBZHZlcnRpc2luZ1dpdGhFSVJEYXRhOiBhZHZlcnRpc2VtZW50IGRhdGEgPSAnICtcbiAgICAgICAgYWR2ZXJ0aXNlbWVudERhdGEudG9TdHJpbmcoJ2hleCcpICtcbiAgICAgICAgJywgc2NhbiBkYXRhID0gJyArXG4gICAgICAgIHNjYW5EYXRhLnRvU3RyaW5nKCdoZXgnKVxuICAgICk7XG5cbiAgICBsZXQgZXJyb3IgPSBudWxsO1xuXG4gICAgaWYgKGFkdmVydGlzZW1lbnREYXRhLmxlbmd0aCA+IDMxKSB7XG4gICAgICBlcnJvciA9IG5ldyBFcnJvcignQWR2ZXJ0aXNlbWVudCBkYXRhIGlzIG92ZXIgbWF4aW11bSBsaW1pdCBvZiAzMSBieXRlcycpO1xuICAgIH0gZWxzZSBpZiAoc2NhbkRhdGEubGVuZ3RoID4gMzEpIHtcbiAgICAgIGVycm9yID0gbmV3IEVycm9yKCdTY2FuIGRhdGEgaXMgb3ZlciBtYXhpbXVtIGxpbWl0IG9mIDMxIGJ5dGVzJyk7XG4gICAgfVxuXG4gICAgaWYgKGVycm9yKSB7XG4gICAgICB0aGlzLmVtaXQoJ2FkdmVydGlzaW5nU3RhcnQnLCBlcnJvcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2FkdmVydGlzZVN0YXRlID0gJ3N0YXJ0aW5nJztcblxuICAgICAgaWYgKGlzSW50ZWxFZGlzb24gfHwgaXNZb2N0bykge1xuICAgICAgICAvLyB3b3JrIGFyb3VuZCBmb3IgSW50ZWwgRWRpc29uXG4gICAgICAgIGRlYnVnKCdza2lwcGluZyBmaXJzdCBzZXQgb2Ygc2NhbiByZXNwb25zZSBhbmQgYWR2ZXJ0aXNlbWVudCBkYXRhJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLl9oY2kuc2V0U2NhblJlc3BvbnNlRGF0YShzY2FuRGF0YSk7XG4gICAgICAgIHRoaXMuX2hjaS5zZXRBZHZlcnRpc2luZ0RhdGEoYWR2ZXJ0aXNlbWVudERhdGEpO1xuICAgICAgfVxuICAgICAgdGhpcy5faGNpLnNldEFkdmVydGlzZUVuYWJsZSh0cnVlKTtcbiAgICAgIHRoaXMuX2hjaS5zZXRTY2FuUmVzcG9uc2VEYXRhKHNjYW5EYXRhKTtcbiAgICAgIHRoaXMuX2hjaS5zZXRBZHZlcnRpc2luZ0RhdGEoYWR2ZXJ0aXNlbWVudERhdGEpO1xuICAgIH1cbiAgfVxuXG4gIHJlc3RhcnRBZHZlcnRpc2luZygpIHtcbiAgICB0aGlzLl9hZHZlcnRpc2VTdGF0ZSA9ICdyZXN0YXJ0aW5nJztcblxuICAgIHRoaXMuX2hjaS5zZXRBZHZlcnRpc2VFbmFibGUodHJ1ZSk7XG4gIH1cblxuICBzdG9wQWR2ZXJ0aXNpbmcoKSB7XG4gICAgdGhpcy5fYWR2ZXJ0aXNlU3RhdGUgPSAnc3RvcHBpbmcnO1xuXG4gICAgdGhpcy5faGNpLnNldEFkdmVydGlzZUVuYWJsZShmYWxzZSk7XG4gIH1cblxuICBvbkhjaUVycm9yKGVycm9yKSB7fVxuXG4gIG9uSGNpTGVBZHZlcnRpc2luZ1BhcmFtZXRlcnNTZXQoc3RhdHVzKSB7fVxuXG4gIG9uSGNpTGVBZHZlcnRpc2luZ0RhdGFTZXQoc3RhdHVzKSB7fVxuXG4gIG9uSGNpTGVTY2FuUmVzcG9uc2VEYXRhU2V0KHN0YXR1cykge31cblxuICBvbkhjaUxlQWR2ZXJ0aXNlRW5hYmxlU2V0KHN0YXR1cykge1xuICAgIGlmICh0aGlzLl9hZHZlcnRpc2VTdGF0ZSA9PT0gJ3N0YXJ0aW5nJykge1xuICAgICAgdGhpcy5fYWR2ZXJ0aXNlU3RhdGUgPSAnc3RhcnRlZCc7XG5cbiAgICAgIGxldCBlcnJvciA9IG51bGw7XG5cbiAgICAgIGlmIChzdGF0dXMpIHtcbiAgICAgICAgZXJyb3IgPSBuZXcgRXJyb3IoXG4gICAgICAgICAgSGNpLlNUQVRVU19NQVBQRVJbc3RhdHVzXSB8fCAnVW5rbm93biAoJyArIHN0YXR1cyArICcpJ1xuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmVtaXQoJ2FkdmVydGlzaW5nU3RhcnQnLCBlcnJvcik7XG4gICAgfSBlbHNlIGlmICh0aGlzLl9hZHZlcnRpc2VTdGF0ZSA9PT0gJ3N0b3BwaW5nJykge1xuICAgICAgdGhpcy5fYWR2ZXJ0aXNlU3RhdGUgPSAnc3RvcHBlZCc7XG5cbiAgICAgIHRoaXMuZW1pdCgnYWR2ZXJ0aXNpbmdTdG9wJyk7XG4gICAgfVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gR2FwO1xuIl19

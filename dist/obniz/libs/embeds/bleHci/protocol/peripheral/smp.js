"use strict";
let events = require('events');
let crypto = require('./crypto');
let Mgmt = require('./mgmt');
let SMP_CID = 0x0006;
let SMP_PAIRING_REQUEST = 0x01;
let SMP_PAIRING_RESPONSE = 0x02;
let SMP_PAIRING_CONFIRM = 0x03;
let SMP_PAIRING_RANDOM = 0x04;
let SMP_PAIRING_FAILED = 0x05;
let SMP_ENCRYPT_INFO = 0x06;
let SMP_MASTER_IDENT = 0x07;
let SMP_UNSPECIFIED = 0x08;
class Smp extends events.EventEmitter {
    constructor(aclStream, localAddressType, localAddress, remoteAddressType, remoteAddress, hciProtocol) {
        super();
        this._aclStream = aclStream;
        this._mgmt = new Mgmt(hciProtocol);
        this._iat = Buffer.from([remoteAddressType === 'random' ? 0x01 : 0x00]);
        this._ia = Buffer.from(remoteAddress
            .split(':')
            .reverse()
            .join(''), 'hex');
        this._rat = Buffer.from([localAddressType === 'random' ? 0x01 : 0x00]);
        this._ra = Buffer.from(localAddress
            .split(':')
            .reverse()
            .join(''), 'hex');
        this._stk = null;
        this._random = null;
        this._diversifier = null;
        this.onAclStreamDataBinded = this.onAclStreamData.bind(this);
        this.onAclStreamEncryptChangeBinded = this.onAclStreamEncryptChange.bind(this);
        this.onAclStreamLtkNegReplyBinded = this.onAclStreamLtkNegReply.bind(this);
        this.onAclStreamEndBinded = this.onAclStreamEnd.bind(this);
        this._aclStream.on('data', this.onAclStreamDataBinded);
        this._aclStream.on('encryptChange', this.onAclStreamEncryptChangeBinded);
        this._aclStream.on('ltkNegReply', this.onAclStreamLtkNegReplyBinded);
        this._aclStream.on('end', this.onAclStreamEndBinded);
    }
    nAclStreamData(cid, data) {
        if (cid !== SMP_CID) {
            return;
        }
        let code = data.readUInt8(0);
        if (SMP_PAIRING_REQUEST === code) {
            this.handlePairingRequest(data);
        }
        else if (SMP_PAIRING_CONFIRM === code) {
            this.handlePairingConfirm(data);
        }
        else if (SMP_PAIRING_RANDOM === code) {
            this.handlePairingRandom(data);
        }
        else if (SMP_PAIRING_FAILED === code) {
            this.handlePairingFailed(data);
        }
    }
    nAclStreamEncryptChange(encrypted) {
        if (encrypted) {
            if (this._stk && this._diversifier && this._random) {
                this.write(Buffer.concat([Buffer.from([SMP_ENCRYPT_INFO]), this._stk]));
                this.write(Buffer.concat([
                    Buffer.from([SMP_MASTER_IDENT]),
                    this._diversifier,
                    this._random,
                ]));
            }
        }
    }
    nAclStreamLtkNegReply() {
        this.write(Buffer.from([SMP_PAIRING_FAILED, SMP_UNSPECIFIED]));
        this.emit('fail');
    }
    nAclStreamEnd() {
        this._aclStream.removeListener('data', this.onAclStreamDataBinded);
        this._aclStream.removeListener('encryptChange', this.onAclStreamEncryptChangeBinded);
        this._aclStream.removeListener('ltkNegReply', this.onAclStreamLtkNegReplyBinded);
        this._aclStream.removeListener('end', this.onAclStreamEndBinded);
    }
    andlePairingRequest(data) {
        this._preq = data;
        this._pres = Buffer.from([
            SMP_PAIRING_RESPONSE,
            0x03,
            0x00,
            0x01,
            0x10,
            0x00,
            0x01,
        ]);
        this.write(this._pres);
    }
    andlePairingConfirm(data) {
        this._pcnf = data;
        this._tk = Buffer.from('00000000000000000000000000000000', 'hex');
        this._r = crypto.r();
        this.write(Buffer.concat([
            Buffer.from([SMP_PAIRING_CONFIRM]),
            crypto.c1(this._tk, this._r, this._pres, this._preq, this._iat, this._ia, this._rat, this._ra),
        ]));
    }
    andlePairingRandom(data) {
        let r = data.slice(1);
        let pcnf = Buffer.concat([
            Buffer.from([SMP_PAIRING_CONFIRM]),
            crypto.c1(this._tk, r, this._pres, this._preq, this._iat, this._ia, this._rat, this._ra),
        ]);
        if (this._pcnf.toString('hex') === pcnf.toString('hex')) {
            this._diversifier = Buffer.from('0000', 'hex');
            this._random = Buffer.from('0000000000000000', 'hex');
            this._stk = crypto.s1(this._tk, this._r, r);
            this._mgmt.addLongTermKey(this._ia, this._iat, 0, 0, this._diversifier, this._random, this._stk);
            this.write(Buffer.concat([Buffer.from([SMP_PAIRING_RANDOM]), this._r]));
        }
        else {
            this.write(Buffer.from([SMP_PAIRING_FAILED, SMP_PAIRING_CONFIRM]));
            this.emit('fail');
        }
    }
    andlePairingFailed(data) {
        this.emit('fail');
    }
    rite(data) {
        this._aclStream.write(SMP_CID, data);
    }
}
module.exports = Smp;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvcHJvdG9jb2wvcGVyaXBoZXJhbC9zbXAuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUUvQixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDakMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRTdCLElBQUksT0FBTyxHQUFHLE1BQU0sQ0FBQztBQUVyQixJQUFJLG1CQUFtQixHQUFHLElBQUksQ0FBQztBQUMvQixJQUFJLG9CQUFvQixHQUFHLElBQUksQ0FBQztBQUNoQyxJQUFJLG1CQUFtQixHQUFHLElBQUksQ0FBQztBQUMvQixJQUFJLGtCQUFrQixHQUFHLElBQUksQ0FBQztBQUM5QixJQUFJLGtCQUFrQixHQUFHLElBQUksQ0FBQztBQUM5QixJQUFJLGdCQUFnQixHQUFHLElBQUksQ0FBQztBQUM1QixJQUFJLGdCQUFnQixHQUFHLElBQUksQ0FBQztBQUU1QixJQUFJLGVBQWUsR0FBRyxJQUFJLENBQUM7QUFFM0IsTUFBTSxHQUFJLFNBQVEsTUFBTSxDQUFDLFlBQVk7SUFDbkMsWUFDRSxTQUFTLEVBQ1QsZ0JBQWdCLEVBQ2hCLFlBQVksRUFDWixpQkFBaUIsRUFDakIsYUFBYSxFQUNiLFdBQVc7UUFFWCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO1FBQzVCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFbkMsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsaUJBQWlCLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDLEdB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QUNGO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMiLCJmaWxlIjoib2JuaXovbGlicy9lbWJlZHMvYmxlSGNpL3Byb3RvY29sL3BlcmlwaGVyYWwvc21wLmpzIiwic291cmNlc0NvbnRlbnQiOlsibGV0IGV2ZW50cyA9IHJlcXVpcmUoJ2V2ZW50cycpO1xuXG5sZXQgY3J5cHRvID0gcmVxdWlyZSgnLi9jcnlwdG8nKTtcbmxldCBNZ210ID0gcmVxdWlyZSgnLi9tZ210Jyk7XG5cbmxldCBTTVBfQ0lEID0gMHgwMDA2O1xuXG5sZXQgU01QX1BBSVJJTkdfUkVRVUVTVCA9IDB4MDE7XG5sZXQgU01QX1BBSVJJTkdfUkVTUE9OU0UgPSAweDAyO1xubGV0IFNNUF9QQUlSSU5HX0NPTkZJUk0gPSAweDAzO1xubGV0IFNNUF9QQUlSSU5HX1JBTkRPTSA9IDB4MDQ7XG5sZXQgU01QX1BBSVJJTkdfRkFJTEVEID0gMHgwNTtcbmxldCBTTVBfRU5DUllQVF9JTkZPID0gMHgwNjtcbmxldCBTTVBfTUFTVEVSX0lERU5UID0gMHgwNztcblxubGV0IFNNUF9VTlNQRUNJRklFRCA9IDB4MDg7XG5cbmNsYXNzIFNtcCBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBhY2xTdHJlYW0sXG4gICAgbG9jYWxBZGRyZXNzVHlwZSxcbiAgICBsb2NhbEFkZHJlc3MsXG4gICAgcmVtb3RlQWRkcmVzc1R5cGUsXG4gICAgcmVtb3RlQWRkcmVzcyxcbiAgICBoY2lQcm90b2NvbFxuICApIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX2FjbFN0cmVhbSA9IGFjbFN0cmVhbTtcbiAgICB0aGlzLl9tZ210ID0gbmV3IE1nbXQoaGNpUHJvdG9jb2wpO1xuXG4gICAgdGhpcy5faWF0ID0gQnVmZmVyLmZyb20oW3JlbW90ZUFkZHJlc3NUeXBlID09PSAncmFuZG9tJyA/IDB4MDEgOiAweDAwXSk7XG4gICAgdGhpcy5faWEgPSBCdWZmZXIuZnJvbShcbiAgICAgIHJlbW90ZUFkZHJlc3NcbiAgICAgICAgLnNwbGl0KCc6JylcbiAgICAgICAgLnJldmVyc2UoKVxuICAgICAgICAuam9pbignJyksXG4gICAgICAnaGV4J1xuICAgICk7XG4gICAgdGhpcy5fcmF0ID0gQnVmZmVyLmZyb20oW2xvY2FsQWRkcmVzc1R5cGUgPT09ICdyYW5kb20nID8gMHgwMSA6IDB4MDBdKTtcbiAgICB0aGlzLl9yYSA9IEJ1ZmZlci5mcm9tKFxuICAgICAgbG9jYWxBZGRyZXNzXG4gICAgICAgIC5zcGxpdCgnOicpXG4gICAgICAgIC5yZXZlcnNlKClcbiAgICAgICAgLmpvaW4oJycpLFxuICAgICAgJ2hleCdcbiAgICApO1xuXG4gICAgdGhpcy5fc3RrID0gbnVsbDtcbiAgICB0aGlzLl9yYW5kb20gPSBudWxsO1xuICAgIHRoaXMuX2RpdmVyc2lmaWVyID0gbnVsbDtcblxuICAgIHRoaXMub25BY2xTdHJlYW1EYXRhQmluZGVkID0gdGhpcy5vbkFjbFN0cmVhbURhdGEuYmluZCh0aGlzKTtcbiAgICB0aGlzLm9uQWNsU3RyZWFtRW5jcnlwdENoYW5nZUJpbmRlZCA9IHRoaXMub25BY2xTdHJlYW1FbmNyeXB0Q2hhbmdlLmJpbmQoXG4gICAgICB0aGlzXG4gICAgKTtcbiAgICB0aGlzLm9uQWNsU3RyZWFtTHRrTmVnUmVwbHlCaW5kZWQgPSB0aGlzLm9uQWNsU3RyZWFtTHRrTmVnUmVwbHkuYmluZCh0aGlzKTtcbiAgICB0aGlzLm9uQWNsU3RyZWFtRW5kQmluZGVkID0gdGhpcy5vbkFjbFN0cmVhbUVuZC5iaW5kKHRoaXMpO1xuXG4gICAgdGhpcy5fYWNsU3RyZWFtLm9uKCdkYXRhJywgdGhpcy5vbkFjbFN0cmVhbURhdGFCaW5kZWQpO1xuICAgIHRoaXMuX2FjbFN0cmVhbS5vbignZW5jcnlwdENoYW5nZScsIHRoaXMub25BY2xTdHJlYW1FbmNyeXB0Q2hhbmdlQmluZGVkKTtcbiAgICB0aGlzLl9hY2xTdHJlYW0ub24oJ2x0a05lZ1JlcGx5JywgdGhpcy5vbkFjbFN0cmVhbUx0a05lZ1JlcGx5QmluZGVkKTtcbiAgICB0aGlzLl9hY2xTdHJlYW0ub24oJ2VuZCcsIHRoaXMub25BY2xTdHJlYW1FbmRCaW5kZWQpO1xuICB9XG5cbiAgbkFjbFN0cmVhbURhdGEoY2lkLCBkYXRhKSB7XG4gICAgaWYgKGNpZCAhPT0gU01QX0NJRCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBjb2RlID0gZGF0YS5yZWFkVUludDgoMCk7XG5cbiAgICBpZiAoU01QX1BBSVJJTkdfUkVRVUVTVCA9PT0gY29kZSkge1xuICAgICAgdGhpcy5oYW5kbGVQYWlyaW5nUmVxdWVzdChkYXRhKTtcbiAgICB9IGVsc2UgaWYgKFNNUF9QQUlSSU5HX0NPTkZJUk0gPT09IGNvZGUpIHtcbiAgICAgIHRoaXMuaGFuZGxlUGFpcmluZ0NvbmZpcm0oZGF0YSk7XG4gICAgfSBlbHNlIGlmIChTTVBfUEFJUklOR19SQU5ET00gPT09IGNvZGUpIHtcbiAgICAgIHRoaXMuaGFuZGxlUGFpcmluZ1JhbmRvbShkYXRhKTtcbiAgICB9IGVsc2UgaWYgKFNNUF9QQUlSSU5HX0ZBSUxFRCA9PT0gY29kZSkge1xuICAgICAgdGhpcy5oYW5kbGVQYWlyaW5nRmFpbGVkKGRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIG5BY2xTdHJlYW1FbmNyeXB0Q2hhbmdlKGVuY3J5cHRlZCkge1xuICAgIGlmIChlbmNyeXB0ZWQpIHtcbiAgICAgIGlmICh0aGlzLl9zdGsgJiYgdGhpcy5fZGl2ZXJzaWZpZXIgJiYgdGhpcy5fcmFuZG9tKSB7XG4gICAgICAgIHRoaXMud3JpdGUoQnVmZmVyLmNvbmNhdChbQnVmZmVyLmZyb20oW1NNUF9FTkNSWVBUX0lORk9dKSwgdGhpcy5fc3RrXSkpO1xuXG4gICAgICAgIHRoaXMud3JpdGUoXG4gICAgICAgICAgQnVmZmVyLmNvbmNhdChbXG4gICAgICAgICAgICBCdWZmZXIuZnJvbShbU01QX01BU1RFUl9JREVOVF0pLFxuICAgICAgICAgICAgdGhpcy5fZGl2ZXJzaWZpZXIsXG4gICAgICAgICAgICB0aGlzLl9yYW5kb20sXG4gICAgICAgICAgXSlcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBuQWNsU3RyZWFtTHRrTmVnUmVwbHkoKSB7XG4gICAgdGhpcy53cml0ZShCdWZmZXIuZnJvbShbU01QX1BBSVJJTkdfRkFJTEVELCBTTVBfVU5TUEVDSUZJRURdKSk7XG5cbiAgICB0aGlzLmVtaXQoJ2ZhaWwnKTtcbiAgfVxuXG4gIG5BY2xTdHJlYW1FbmQoKSB7XG4gICAgdGhpcy5fYWNsU3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgdGhpcy5vbkFjbFN0cmVhbURhdGFCaW5kZWQpO1xuICAgIHRoaXMuX2FjbFN0cmVhbS5yZW1vdmVMaXN0ZW5lcihcbiAgICAgICdlbmNyeXB0Q2hhbmdlJyxcbiAgICAgIHRoaXMub25BY2xTdHJlYW1FbmNyeXB0Q2hhbmdlQmluZGVkXG4gICAgKTtcbiAgICB0aGlzLl9hY2xTdHJlYW0ucmVtb3ZlTGlzdGVuZXIoXG4gICAgICAnbHRrTmVnUmVwbHknLFxuICAgICAgdGhpcy5vbkFjbFN0cmVhbUx0a05lZ1JlcGx5QmluZGVkXG4gICAgKTtcbiAgICB0aGlzLl9hY2xTdHJlYW0ucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIHRoaXMub25BY2xTdHJlYW1FbmRCaW5kZWQpO1xuICB9XG5cbiAgYW5kbGVQYWlyaW5nUmVxdWVzdChkYXRhKSB7XG4gICAgdGhpcy5fcHJlcSA9IGRhdGE7XG4gICAgdGhpcy5fcHJlcyA9IEJ1ZmZlci5mcm9tKFtcbiAgICAgIFNNUF9QQUlSSU5HX1JFU1BPTlNFLFxuICAgICAgMHgwMywgLy8gSU8gY2FwYWJpbGl0eTogTm9JbnB1dE5vT3V0cHV0XG4gICAgICAweDAwLCAvLyBPT0IgZGF0YTogQXV0aGVudGljYXRpb24gZGF0YSBub3QgcHJlc2VudFxuICAgICAgMHgwMSwgLy8gQXV0aGVudGljYXRpb24gcmVxdWlyZW1lbnQ6IEJvbmRpbmcgLSBObyBNSVRNXG4gICAgICAweDEwLCAvLyBNYXggZW5jcnlwdGlvbiBrZXkgc2l6ZVxuICAgICAgMHgwMCwgLy8gSW5pdGlhdG9yIGtleSBkaXN0cmlidXRpb246IDxub25lPlxuICAgICAgMHgwMSwgLy8gUmVzcG9uZGVyIGtleSBkaXN0cmlidXRpb246IEVuY0tleVxuICAgIF0pO1xuXG4gICAgdGhpcy53cml0ZSh0aGlzLl9wcmVzKTtcbiAgfVxuXG4gIGFuZGxlUGFpcmluZ0NvbmZpcm0oZGF0YSkge1xuICAgIHRoaXMuX3BjbmYgPSBkYXRhO1xuXG4gICAgdGhpcy5fdGsgPSBCdWZmZXIuZnJvbSgnMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAnLCAnaGV4Jyk7XG4gICAgdGhpcy5fciA9IGNyeXB0by5yKCk7XG5cbiAgICB0aGlzLndyaXRlKFxuICAgICAgQnVmZmVyLmNvbmNhdChbXG4gICAgICAgIEJ1ZmZlci5mcm9tKFtTTVBfUEFJUklOR19DT05GSVJNXSksXG4gICAgICAgIGNyeXB0by5jMShcbiAgICAgICAgICB0aGlzLl90ayxcbiAgICAgICAgICB0aGlzLl9yLFxuICAgICAgICAgIHRoaXMuX3ByZXMsXG4gICAgICAgICAgdGhpcy5fcHJlcSxcbiAgICAgICAgICB0aGlzLl9pYXQsXG4gICAgICAgICAgdGhpcy5faWEsXG4gICAgICAgICAgdGhpcy5fcmF0LFxuICAgICAgICAgIHRoaXMuX3JhXG4gICAgICAgICksXG4gICAgICBdKVxuICAgICk7XG4gIH1cblxuICBhbmRsZVBhaXJpbmdSYW5kb20oZGF0YSkge1xuICAgIGxldCByID0gZGF0YS5zbGljZSgxKTtcblxuICAgIGxldCBwY25mID0gQnVmZmVyLmNvbmNhdChbXG4gICAgICBCdWZmZXIuZnJvbShbU01QX1BBSVJJTkdfQ09ORklSTV0pLFxuICAgICAgY3J5cHRvLmMxKFxuICAgICAgICB0aGlzLl90ayxcbiAgICAgICAgcixcbiAgICAgICAgdGhpcy5fcHJlcyxcbiAgICAgICAgdGhpcy5fcHJlcSxcbiAgICAgICAgdGhpcy5faWF0LFxuICAgICAgICB0aGlzLl9pYSxcbiAgICAgICAgdGhpcy5fcmF0LFxuICAgICAgICB0aGlzLl9yYVxuICAgICAgKSxcbiAgICBdKTtcblxuICAgIGlmICh0aGlzLl9wY25mLnRvU3RyaW5nKCdoZXgnKSA9PT0gcGNuZi50b1N0cmluZygnaGV4JykpIHtcbiAgICAgIHRoaXMuX2RpdmVyc2lmaWVyID0gQnVmZmVyLmZyb20oJzAwMDAnLCAnaGV4Jyk7XG4gICAgICB0aGlzLl9yYW5kb20gPSBCdWZmZXIuZnJvbSgnMDAwMDAwMDAwMDAwMDAwMCcsICdoZXgnKTtcbiAgICAgIHRoaXMuX3N0ayA9IGNyeXB0by5zMSh0aGlzLl90aywgdGhpcy5fciwgcik7XG5cbiAgICAgIHRoaXMuX21nbXQuYWRkTG9uZ1Rlcm1LZXkoXG4gICAgICAgIHRoaXMuX2lhLFxuICAgICAgICB0aGlzLl9pYXQsXG4gICAgICAgIDAsXG4gICAgICAgIDAsXG4gICAgICAgIHRoaXMuX2RpdmVyc2lmaWVyLFxuICAgICAgICB0aGlzLl9yYW5kb20sXG4gICAgICAgIHRoaXMuX3N0a1xuICAgICAgKTtcblxuICAgICAgdGhpcy53cml0ZShCdWZmZXIuY29uY2F0KFtCdWZmZXIuZnJvbShbU01QX1BBSVJJTkdfUkFORE9NXSksIHRoaXMuX3JdKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMud3JpdGUoQnVmZmVyLmZyb20oW1NNUF9QQUlSSU5HX0ZBSUxFRCwgU01QX1BBSVJJTkdfQ09ORklSTV0pKTtcblxuICAgICAgdGhpcy5lbWl0KCdmYWlsJyk7XG4gICAgfVxuICB9XG5cbiAgYW5kbGVQYWlyaW5nRmFpbGVkKGRhdGEpIHtcbiAgICB0aGlzLmVtaXQoJ2ZhaWwnKTtcbiAgfVxuXG4gIHJpdGUoZGF0YSkge1xuICAgIHRoaXMuX2FjbFN0cmVhbS53cml0ZShTTVBfQ0lELCBkYXRhKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFNtcDtcbiJdfQ==

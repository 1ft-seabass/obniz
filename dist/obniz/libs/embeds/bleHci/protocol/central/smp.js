"use strict";
let events = require('events');
let crypto = require('./crypto');
let SMP_CID = 0x0006;
let SMP_PAIRING_REQUEST = 0x01;
let SMP_PAIRING_RESPONSE = 0x02;
let SMP_PAIRING_CONFIRM = 0x03;
let SMP_PAIRING_RANDOM = 0x04;
let SMP_PAIRING_FAILED = 0x05;
let SMP_ENCRYPT_INFO = 0x06;
let SMP_MASTER_IDENT = 0x07;
class Smp extends events.EventEmitter {
    constructor(aclStream, localAddressType, localAddress, remoteAddressType, remoteAddress) {
        super();
        this._aclStream = aclStream;
        this._iat = Buffer.from([localAddressType === 'random' ? 0x01 : 0x00]);
        this._ia = Buffer.from(localAddress
            .split(':')
            .reverse()
            .join(''), 'hex');
        this._rat = Buffer.from([remoteAddressType === 'random' ? 0x01 : 0x00]);
        this._ra = Buffer.from(remoteAddress
            .split(':')
            .reverse()
            .join(''), 'hex');
        this.onAclStreamDataBinded = this.onAclStreamData.bind(this);
        this.onAclStreamEndBinded = this.onAclStreamEnd.bind(this);
        this._aclStream.on('data', this.onAclStreamDataBinded);
        this._aclStream.on('end', this.onAclStreamEndBinded);
    }
    sendPairingRequest() {
        this._preq = Buffer.from([
            SMP_PAIRING_REQUEST,
            0x03,
            0x00,
            0x01,
            0x10,
            0x00,
            0x01,
        ]);
        this.write(this._preq);
    }
    onAclStreamData(cid, data) {
        if (cid !== SMP_CID) {
            return;
        }
        let code = data.readUInt8(0);
        if (SMP_PAIRING_RESPONSE === code) {
            this.handlePairingResponse(data);
        }
        else if (SMP_PAIRING_CONFIRM === code) {
            this.handlePairingConfirm(data);
        }
        else if (SMP_PAIRING_RANDOM === code) {
            this.handlePairingRandom(data);
        }
        else if (SMP_PAIRING_FAILED === code) {
            this.handlePairingFailed(data);
        }
        else if (SMP_ENCRYPT_INFO === code) {
            this.handleEncryptInfo(data);
        }
        else if (SMP_MASTER_IDENT === code) {
            this.handleMasterIdent(data);
        }
    }
    onAclStreamEnd() {
        this._aclStream.removeListener('data', this.onAclStreamDataBinded);
        this._aclStream.removeListener('end', this.onAclStreamEndBinded);
        this.emit('end');
    }
    handlePairingResponse(data) {
        this._pres = data;
        this._tk = Buffer.from('00000000000000000000000000000000', 'hex');
        this._r = crypto.r();
        this.write(Buffer.concat([
            Buffer.from([SMP_PAIRING_CONFIRM]),
            crypto.c1(this._tk, this._r, this._pres, this._preq, this._iat, this._ia, this._rat, this._ra),
        ]));
    }
    handlePairingConfirm(data) {
        this._pcnf = data;
        this.write(Buffer.concat([Buffer.from([SMP_PAIRING_RANDOM]), this._r]));
    }
    handlePairingRandom(data) {
        let r = data.slice(1);
        let pcnf = Buffer.concat([
            Buffer.from([SMP_PAIRING_CONFIRM]),
            crypto.c1(this._tk, r, this._pres, this._preq, this._iat, this._ia, this._rat, this._ra),
        ]);
        if (this._pcnf.toString('hex') === pcnf.toString('hex')) {
            let stk = crypto.s1(this._tk, r, this._r);
            this.emit('stk', stk);
        }
        else {
            this.write(Buffer.from([SMP_PAIRING_RANDOM, SMP_PAIRING_CONFIRM]));
            this.emit('fail');
        }
    }
    handlePairingFailed(data) {
        this.emit('fail');
    }
    handleEncryptInfo(data) {
        let ltk = data.slice(1);
        this.emit('ltk', ltk);
    }
    handleMasterIdent(data) {
        let ediv = data.slice(1, 3);
        let rand = data.slice(3);
        this.emit('masterIdent', ediv, rand);
    }
    write(data) {
        this._aclStream.write(SMP_CID, data);
    }
}
module.exports = Smp;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vYm5pei9saWJzL2VtYmVkcy9ibGVIY2kvcHJvdG9jb2wvY2VudHJhbC9zbXAuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUUvQixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFFakMsSUFBSSxPQUFPLEdBQUcsTUFBTSxDQUFDO0FBRXJCLElBQUksbUJBQW1CLEdBQUcsSUFBSSxDQUFDO0FBQy9CLElBQUksb0JBQW9CLEdBQUcsSUFBSSxDQUFDO0FBQ2hDLElBQUksbUJBQW1CLEdBQUcsSUFBSSxDQUFDO0FBQy9CLElBQUksa0JBQWtCLEdBQUcsSUFBSSxDQUFDO0FBQzlCLElBQUksa0JBQWtCLEdBQUcsSUFBSSxDQUFDO0FBQzlCLElBQUksZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO0FBQzVCLElBQUksZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO0FBRTVCLE1BQU0sR0FBSSxTQUFRLE1BQU0sQ0FBQyxZQUFZO0lBQ25DLFlBQ0UsU0FBUyxFQUNULGdCQUFnQixFQUNoQixZQUFZLEVBQ1osaUJBQWlCLEVBQ2pCLGFBQWE7UUFFYixLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO1FBRTVCLElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLGdCQUFnQixLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FDcEIsWUFBWTthQUNULEtBQUssQ0FBQyxHQUFHLENBQUM7YUFDVixPQUFPLEVBQUU7YUFDVCxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQ1gsS0FBSyxDQUNOLENBQUM7UUFDRixJQUFJLENBQUMsSUFBSSxHQUFHLE1B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aWJzL2VtYmVkcy9ibGVIY2kvcHJvdG9jb2wvY2VudHJhbC9zbXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJsZXQgZXZlbnRzID0gcmVxdWlyZSgnZXZlbnRzJyk7XG5cbmxldCBjcnlwdG8gPSByZXF1aXJlKCcuL2NyeXB0bycpO1xuXG5sZXQgU01QX0NJRCA9IDB4MDAwNjtcblxubGV0IFNNUF9QQUlSSU5HX1JFUVVFU1QgPSAweDAxO1xubGV0IFNNUF9QQUlSSU5HX1JFU1BPTlNFID0gMHgwMjtcbmxldCBTTVBfUEFJUklOR19DT05GSVJNID0gMHgwMztcbmxldCBTTVBfUEFJUklOR19SQU5ET00gPSAweDA0O1xubGV0IFNNUF9QQUlSSU5HX0ZBSUxFRCA9IDB4MDU7XG5sZXQgU01QX0VOQ1JZUFRfSU5GTyA9IDB4MDY7XG5sZXQgU01QX01BU1RFUl9JREVOVCA9IDB4MDc7XG5cbmNsYXNzIFNtcCBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBhY2xTdHJlYW0sXG4gICAgbG9jYWxBZGRyZXNzVHlwZSxcbiAgICBsb2NhbEFkZHJlc3MsXG4gICAgcmVtb3RlQWRkcmVzc1R5cGUsXG4gICAgcmVtb3RlQWRkcmVzc1xuICApIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX2FjbFN0cmVhbSA9IGFjbFN0cmVhbTtcblxuICAgIHRoaXMuX2lhdCA9IEJ1ZmZlci5mcm9tKFtsb2NhbEFkZHJlc3NUeXBlID09PSAncmFuZG9tJyA/IDB4MDEgOiAweDAwXSk7XG4gICAgdGhpcy5faWEgPSBCdWZmZXIuZnJvbShcbiAgICAgIGxvY2FsQWRkcmVzc1xuICAgICAgICAuc3BsaXQoJzonKVxuICAgICAgICAucmV2ZXJzZSgpXG4gICAgICAgIC5qb2luKCcnKSxcbiAgICAgICdoZXgnXG4gICAgKTtcbiAgICB0aGlzLl9yYXQgPSBCdWZmZXIuZnJvbShbcmVtb3RlQWRkcmVzc1R5cGUgPT09ICdyYW5kb20nID8gMHgwMSA6IDB4MDBdKTtcbiAgICB0aGlzLl9yYSA9IEJ1ZmZlci5mcm9tKFxuICAgICAgcmVtb3RlQWRkcmVzc1xuICAgICAgICAuc3BsaXQoJzonKVxuICAgICAgICAucmV2ZXJzZSgpXG4gICAgICAgIC5qb2luKCcnKSxcbiAgICAgICdoZXgnXG4gICAgKTtcblxuICAgIHRoaXMub25BY2xTdHJlYW1EYXRhQmluZGVkID0gdGhpcy5vbkFjbFN0cmVhbURhdGEuYmluZCh0aGlzKTtcbiAgICB0aGlzLm9uQWNsU3RyZWFtRW5kQmluZGVkID0gdGhpcy5vbkFjbFN0cmVhbUVuZC5iaW5kKHRoaXMpO1xuXG4gICAgdGhpcy5fYWNsU3RyZWFtLm9uKCdkYXRhJywgdGhpcy5vbkFjbFN0cmVhbURhdGFCaW5kZWQpO1xuICAgIHRoaXMuX2FjbFN0cmVhbS5vbignZW5kJywgdGhpcy5vbkFjbFN0cmVhbUVuZEJpbmRlZCk7XG4gIH1cblxuICBzZW5kUGFpcmluZ1JlcXVlc3QoKSB7XG4gICAgdGhpcy5fcHJlcSA9IEJ1ZmZlci5mcm9tKFtcbiAgICAgIFNNUF9QQUlSSU5HX1JFUVVFU1QsXG4gICAgICAweDAzLCAvLyBJTyBjYXBhYmlsaXR5OiBOb0lucHV0Tm9PdXRwdXRcbiAgICAgIDB4MDAsIC8vIE9PQiBkYXRhOiBBdXRoZW50aWNhdGlvbiBkYXRhIG5vdCBwcmVzZW50XG4gICAgICAweDAxLCAvLyBBdXRoZW50aWNhdGlvbiByZXF1aXJlbWVudDogQm9uZGluZyAtIE5vIE1JVE1cbiAgICAgIDB4MTAsIC8vIE1heCBlbmNyeXB0aW9uIGtleSBzaXplXG4gICAgICAweDAwLCAvLyBJbml0aWF0b3Iga2V5IGRpc3RyaWJ1dGlvbjogPG5vbmU+XG4gICAgICAweDAxLCAvLyBSZXNwb25kZXIga2V5IGRpc3RyaWJ1dGlvbjogRW5jS2V5XG4gICAgXSk7XG5cbiAgICB0aGlzLndyaXRlKHRoaXMuX3ByZXEpO1xuICB9XG5cbiAgb25BY2xTdHJlYW1EYXRhKGNpZCwgZGF0YSkge1xuICAgIGlmIChjaWQgIT09IFNNUF9DSUQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgY29kZSA9IGRhdGEucmVhZFVJbnQ4KDApO1xuXG4gICAgaWYgKFNNUF9QQUlSSU5HX1JFU1BPTlNFID09PSBjb2RlKSB7XG4gICAgICB0aGlzLmhhbmRsZVBhaXJpbmdSZXNwb25zZShkYXRhKTtcbiAgICB9IGVsc2UgaWYgKFNNUF9QQUlSSU5HX0NPTkZJUk0gPT09IGNvZGUpIHtcbiAgICAgIHRoaXMuaGFuZGxlUGFpcmluZ0NvbmZpcm0oZGF0YSk7XG4gICAgfSBlbHNlIGlmIChTTVBfUEFJUklOR19SQU5ET00gPT09IGNvZGUpIHtcbiAgICAgIHRoaXMuaGFuZGxlUGFpcmluZ1JhbmRvbShkYXRhKTtcbiAgICB9IGVsc2UgaWYgKFNNUF9QQUlSSU5HX0ZBSUxFRCA9PT0gY29kZSkge1xuICAgICAgdGhpcy5oYW5kbGVQYWlyaW5nRmFpbGVkKGRhdGEpO1xuICAgIH0gZWxzZSBpZiAoU01QX0VOQ1JZUFRfSU5GTyA9PT0gY29kZSkge1xuICAgICAgdGhpcy5oYW5kbGVFbmNyeXB0SW5mbyhkYXRhKTtcbiAgICB9IGVsc2UgaWYgKFNNUF9NQVNURVJfSURFTlQgPT09IGNvZGUpIHtcbiAgICAgIHRoaXMuaGFuZGxlTWFzdGVySWRlbnQoZGF0YSk7XG4gICAgfVxuICB9XG5cbiAgb25BY2xTdHJlYW1FbmQoKSB7XG4gICAgdGhpcy5fYWNsU3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgdGhpcy5vbkFjbFN0cmVhbURhdGFCaW5kZWQpO1xuICAgIHRoaXMuX2FjbFN0cmVhbS5yZW1vdmVMaXN0ZW5lcignZW5kJywgdGhpcy5vbkFjbFN0cmVhbUVuZEJpbmRlZCk7XG5cbiAgICB0aGlzLmVtaXQoJ2VuZCcpO1xuICB9XG5cbiAgaGFuZGxlUGFpcmluZ1Jlc3BvbnNlKGRhdGEpIHtcbiAgICB0aGlzLl9wcmVzID0gZGF0YTtcblxuICAgIHRoaXMuX3RrID0gQnVmZmVyLmZyb20oJzAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwJywgJ2hleCcpO1xuICAgIHRoaXMuX3IgPSBjcnlwdG8ucigpO1xuXG4gICAgdGhpcy53cml0ZShcbiAgICAgIEJ1ZmZlci5jb25jYXQoW1xuICAgICAgICBCdWZmZXIuZnJvbShbU01QX1BBSVJJTkdfQ09ORklSTV0pLFxuICAgICAgICBjcnlwdG8uYzEoXG4gICAgICAgICAgdGhpcy5fdGssXG4gICAgICAgICAgdGhpcy5fcixcbiAgICAgICAgICB0aGlzLl9wcmVzLFxuICAgICAgICAgIHRoaXMuX3ByZXEsXG4gICAgICAgICAgdGhpcy5faWF0LFxuICAgICAgICAgIHRoaXMuX2lhLFxuICAgICAgICAgIHRoaXMuX3JhdCxcbiAgICAgICAgICB0aGlzLl9yYVxuICAgICAgICApLFxuICAgICAgXSlcbiAgICApO1xuICB9XG5cbiAgaGFuZGxlUGFpcmluZ0NvbmZpcm0oZGF0YSkge1xuICAgIHRoaXMuX3BjbmYgPSBkYXRhO1xuXG4gICAgdGhpcy53cml0ZShCdWZmZXIuY29uY2F0KFtCdWZmZXIuZnJvbShbU01QX1BBSVJJTkdfUkFORE9NXSksIHRoaXMuX3JdKSk7XG4gIH1cblxuICBoYW5kbGVQYWlyaW5nUmFuZG9tKGRhdGEpIHtcbiAgICBsZXQgciA9IGRhdGEuc2xpY2UoMSk7XG5cbiAgICBsZXQgcGNuZiA9IEJ1ZmZlci5jb25jYXQoW1xuICAgICAgQnVmZmVyLmZyb20oW1NNUF9QQUlSSU5HX0NPTkZJUk1dKSxcbiAgICAgIGNyeXB0by5jMShcbiAgICAgICAgdGhpcy5fdGssXG4gICAgICAgIHIsXG4gICAgICAgIHRoaXMuX3ByZXMsXG4gICAgICAgIHRoaXMuX3ByZXEsXG4gICAgICAgIHRoaXMuX2lhdCxcbiAgICAgICAgdGhpcy5faWEsXG4gICAgICAgIHRoaXMuX3JhdCxcbiAgICAgICAgdGhpcy5fcmFcbiAgICAgICksXG4gICAgXSk7XG5cbiAgICBpZiAodGhpcy5fcGNuZi50b1N0cmluZygnaGV4JykgPT09IHBjbmYudG9TdHJpbmcoJ2hleCcpKSB7XG4gICAgICBsZXQgc3RrID0gY3J5cHRvLnMxKHRoaXMuX3RrLCByLCB0aGlzLl9yKTtcblxuICAgICAgdGhpcy5lbWl0KCdzdGsnLCBzdGspO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndyaXRlKEJ1ZmZlci5mcm9tKFtTTVBfUEFJUklOR19SQU5ET00sIFNNUF9QQUlSSU5HX0NPTkZJUk1dKSk7XG5cbiAgICAgIHRoaXMuZW1pdCgnZmFpbCcpO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZVBhaXJpbmdGYWlsZWQoZGF0YSkge1xuICAgIHRoaXMuZW1pdCgnZmFpbCcpO1xuICB9XG5cbiAgaGFuZGxlRW5jcnlwdEluZm8oZGF0YSkge1xuICAgIGxldCBsdGsgPSBkYXRhLnNsaWNlKDEpO1xuXG4gICAgdGhpcy5lbWl0KCdsdGsnLCBsdGspO1xuICB9XG5cbiAgaGFuZGxlTWFzdGVySWRlbnQoZGF0YSkge1xuICAgIGxldCBlZGl2ID0gZGF0YS5zbGljZSgxLCAzKTtcbiAgICBsZXQgcmFuZCA9IGRhdGEuc2xpY2UoMyk7XG5cbiAgICB0aGlzLmVtaXQoJ21hc3RlcklkZW50JywgZWRpdiwgcmFuZCk7XG4gIH1cblxuICB3cml0ZShkYXRhKSB7XG4gICAgdGhpcy5fYWNsU3RyZWFtLndyaXRlKFNNUF9DSUQsIGRhdGEpO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU21wO1xuIl19

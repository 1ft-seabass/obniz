"use strict";
class SharpMemoryTFT {
    constructor() {
        this.keys = [
            'vcc',
            'gnd',
            'vcc_a',
            'gnd_a',
            'sclk',
            'mosi',
            'cs',
            'disp',
            'extcomin',
            'extmode',
            'width',
            'height',
        ];
        this.requiredKeys = ['sclk', 'mosi', 'cs', 'width', 'height'];
        this.commands = {};
        this.commands.write = 0x80;
        this.commands.clear = 0x20;
        this.commands.vcom = 0x40;
        this._canvas = null;
        this._reset();
    }
    static info() {
        return {
            name: 'SharpMemoryTFT',
        };
    }
    wired(obniz) {
        this.obniz = obniz;
        this.io_cs = obniz.getIO(this.params.cs);
        if (this.params.disp && this.params.extcomin && this.params.extmode) {
            this.io_disp = obniz.getIO(this.params.disp);
            this.io_extcomin = obniz.getIO(this.params.extcomin);
            this.io_extmode = obniz.getIO(this.params.extmode);
            this.io_disp.output(true);
            this.io_extcomin.output(false);
            this.io_extmode.output(false);
        }
        obniz.setVccGnd(this.params.vcc, this.params.gnd, '5v');
        obniz.setVccGnd(this.params.vcc_a, this.params.gnd_a, '5v');
        this.params.mode = 'master';
        this.params.frequency = parseInt(1000 * 1000);
        this.params.clk = this.params.sclk;
        this.params.drive = '5v'; // It over spec for frequency. But VIN-HI require 0.7VCC<=.
        this.spi = this.obniz.getSpiWithConfig(this.params);
        this.width = this.params.width;
        this.height = this.params.height;
        this.obniz.wait(100);
    }
    _reverseBits(data) {
        let revData = 0;
        for (let i = 0; i < 8; i++) {
            revData += data & 0x01;
            data >>= 1;
            if (i < 7)
                revData <<= 1;
        }
        return revData;
    }
    sendLSB(data) {
        this.spi.write([this._reverseBits(data)]);
    }
    sendClear() {
        this.io_cs.output(true);
        this.spi.write([this.commands.clear | 0x00, 0x00]);
        this.io_cs.output(false);
    }
    raw(rawData) {
        let oldline, currentline;
        let totalbytes = (this.width * this.height) / 8;
        let array = new Array(1024);
        let index = 0;
        array[index++] = this.commands.write | this.commands.vcom;
        oldline = currentline = 1;
        array[index++] = this._reverseBits(currentline);
        this.io_cs.output(true);
        for (let i = 0; i < totalbytes; i++) {
            array[index++] = rawData[i]; //lsb
            currentline = parseInt((i + 1) / (this.width / 8) + 1, 10);
            if (currentline != oldline) {
                array[index++] = 0x00;
                if (currentline <= this.height)
                    array[index++] = this._reverseBits(currentline);
                oldline = currentline;
            }
            if (index >= 1021) {
                // regarding SPI max.
                this.spi.write(array.slice(0, index));
                array = new Array(1024);
                index = 0;
            }
        }
        if (index > 0) {
            this.spi.write(array.slice(0, index));
        }
        this.spi.write([0x00]);
        this.io_cs.output(false);
    }
    // copy from display.js
    _reset() {
        this._pos = { x: 0, y: 0 };
        this.autoFlush = true;
    }
    warnCanvasAvailability() {
        if (this.obniz.isNode) {
            throw new Error('MemoryDisplay require node-canvas to draw rich contents. see more detail on docs');
        }
        else {
            throw new Error('MemoryDisplay cant create canvas element to body');
        }
    }
    _preparedCanvas() {
        if (this._canvas) {
            return this._canvas;
        }
        if (this.obniz.isNode) {
            try {
                const { createCanvas } = require('canvas');
                this._canvas = createCanvas(this.width, this.height);
            }
            catch (e) {
                // this.warnCanvasAvailability();
                return null;
            }
        }
        else {
            const identifier = 'MemoryDispCanvas-' + this.obniz.id;
            let canvas = document.getElementById(identifier);
            if (!canvas) {
                canvas = document.createElement('canvas');
                canvas.setAttribute('id', identifier);
                canvas.style.visibility = 'hidden';
                canvas.width = this.width;
                canvas.height = this.height;
                canvas.style['-webkit-font-smoothing'] = 'none';
                let body = document.getElementsByTagName('body')[0];
                body.appendChild(canvas);
            }
            this._canvas = canvas;
        }
        const ctx = this._canvas.getContext('2d');
        ctx.fillStyle = '#FFF';
        ctx.fillRect(0, 0, this.width, this.height);
        ctx.fillStyle = '#000';
        ctx.strokeStyle = '#000';
        this._pos.x = 0;
        this._pos.y = 0;
        this.fontSize = 16;
        ctx.font = `${this.fontSize}px Arial`;
        return this._canvas;
    }
    _ctx() {
        const canvas = this._preparedCanvas();
        if (canvas) {
            return canvas.getContext('2d');
        }
    }
    font(font, size) {
        const ctx = this._ctx();
        if (typeof size !== 'number') {
            size = 16;
        }
        if (typeof font !== 'string') {
            font = 'Arial';
        }
        this.fontSize = size;
        ctx.font = '' + size + 'px ' + font;
    }
    clear() {
        const ctx = this._ctx();
        this._pos.x = 0;
        this._pos.y = 0;
        if (ctx) {
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, this.width, this.height);
            ctx.fillStyle = '#000';
            ctx.strokeStyle = '#000';
            this.draw(ctx);
        }
        else {
            this.sendClear();
        }
    }
    pos(x, y) {
        this._ctx(); //crete first
        if (typeof x == 'number') {
            this._pos.x = x;
        }
        if (typeof y == 'number') {
            this._pos.y = y;
        }
        return this._pos;
    }
    print(text) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.fillText(text, this._pos.x, this._pos.y + this.fontSize);
            this.draw(ctx);
            this._pos.y += this.fontSize;
        }
        else {
            /*
            let obj = {};
            obj['display'] = {
              text: '' + text,
            };
            this.obniz.send(obj);
            */
        }
    }
    line(x_0, y_0, x_1, y_1) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.beginPath();
            ctx.moveTo(x_0, y_0);
            ctx.lineTo(x_1, y_1);
            ctx.stroke();
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    rect(x, y, width, height, mustFill) {
        const ctx = this._ctx();
        if (ctx) {
            if (mustFill) {
                ctx.fillRect(x, y, width, height);
            }
            else {
                ctx.strokeRect(x, y, width, height);
            }
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    circle(x, y, r, mustFill) {
        const ctx = this._ctx();
        if (ctx) {
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            if (mustFill) {
                ctx.fill();
            }
            else {
                ctx.stroke();
            }
            this.draw(ctx);
        }
        else {
            this.warnCanvasAvailability();
        }
    }
    _draw(ctx) {
        const stride = this.width / 8;
        let vram = new Array(stride * 64);
        const imageData = ctx.getImageData(0, 0, this.width, this.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            let brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];
            let index = parseInt(i / 4);
            let line = parseInt(index / this.width);
            let col = parseInt((index - line * this.width) / 8);
            let bits = parseInt(index - line * this.width) % 8;
            if (bits == 0)
                vram[line * stride + col] = 0x00;
            if (brightness > 0x73)
                vram[line * stride + col] |= 0x80 >> bits;
        }
        this.raw(vram);
    }
    draw(ctx) {
        if (this.autoFlush) {
            this._draw(ctx);
        }
    }
    drawing(autoFlush) {
        this.autoFlush = autoFlush == true;
        const ctx = this._ctx();
        if (ctx) {
            this.draw(ctx);
        }
    }
}
if (typeof module === 'object') {
    module.exports = SharpMemoryTFT;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXJ0cy9EaXNwbGF5L1NoYXJwTWVtb3J5VEZUL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxNQUFNLGNBQWM7SUFDbEI7UUFDRSxJQUFJLENBQUMsSUFBSSxHQUFHO1lBQ1YsS0FBSztZQUNMLEtBQUs7WUFDTCxPQUFPO1lBQ1AsT0FBTztZQUNQLE1BQU07WUFDTixNQUFNO1lBQ04sSUFBSTtZQUNKLE1BQU07WUFDTixVQUFVO1lBQ1YsU0FBUztZQUNULE9BQU87WUFDUCxRQUFRO1NBQ1QsQ0FBQztRQUVGLElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFOUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQzNCLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUMzQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFFMUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxNQUFNLENBQUMsSUFBSTtRQUNULE9BQU87WUFDTCxJQUFJLEVBQUUsZ0JBQWdCO1NBQ3ZCLENBQUM7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUs7UUFDVCxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUVuQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUV6QyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFO1lBQ25FLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3JELElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQy9CO1FBRUQsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN4RCxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTVELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQztRQUM1QixJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQzlDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ25DLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLDJEQUEyRDtRQUNyRixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxL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U0FDaEI7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsRUFBRTtJQUM5QixNQUFNLENBQUMsT0FBTyxHQUFHLGNBQWMsQ0FBQztDQUNqQyIsImZpbGUiOiJwYXJ0cy9EaXNwbGF5L1NoYXJwTWVtb3J5VEZUL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY2xhc3MgU2hhcnBNZW1vcnlURlQge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmtleXMgPSBbXG4gICAgICAndmNjJyxcbiAgICAgICdnbmQnLFxuICAgICAgJ3ZjY19hJyxcbiAgICAgICdnbmRfYScsXG4gICAgICAnc2NsaycsXG4gICAgICAnbW9zaScsXG4gICAgICAnY3MnLFxuICAgICAgJ2Rpc3AnLFxuICAgICAgJ2V4dGNvbWluJyxcbiAgICAgICdleHRtb2RlJyxcbiAgICAgICd3aWR0aCcsXG4gICAgICAnaGVpZ2h0JyxcbiAgICBdO1xuXG4gICAgdGhpcy5yZXF1aXJlZEtleXMgPSBbJ3NjbGsnLCAnbW9zaScsICdjcycsICd3aWR0aCcsICdoZWlnaHQnXTtcblxuICAgIHRoaXMuY29tbWFuZHMgPSB7fTtcbiAgICB0aGlzLmNvbW1hbmRzLndyaXRlID0gMHg4MDtcbiAgICB0aGlzLmNvbW1hbmRzLmNsZWFyID0gMHgyMDtcbiAgICB0aGlzLmNvbW1hbmRzLnZjb20gPSAweDQwO1xuXG4gICAgdGhpcy5fY2FudmFzID0gbnVsbDtcbiAgICB0aGlzLl9yZXNldCgpO1xuICB9XG5cbiAgc3RhdGljIGluZm8oKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6ICdTaGFycE1lbW9yeVRGVCcsXG4gICAgfTtcbiAgfVxuXG4gIHdpcmVkKG9ibml6KSB7XG4gICAgdGhpcy5vYm5peiA9IG9ibml6O1xuXG4gICAgdGhpcy5pb19jcyA9IG9ibml6LmdldElPKHRoaXMucGFyYW1zLmNzKTtcblxuICAgIGlmICh0aGlzLnBhcmFtcy5kaXNwICYmIHRoaXMucGFyYW1zLmV4dGNvbWluICYmIHRoaXMucGFyYW1zLmV4dG1vZGUpIHtcbiAgICAgIHRoaXMuaW9fZGlzcCA9IG9ibml6LmdldElPKHRoaXMucGFyYW1zLmRpc3ApO1xuICAgICAgdGhpcy5pb19leHRjb21pbiA9IG9ibml6LmdldElPKHRoaXMucGFyYW1zLmV4dGNvbWluKTtcbiAgICAgIHRoaXMuaW9fZXh0bW9kZSA9IG9ibml6LmdldElPKHRoaXMucGFyYW1zLmV4dG1vZGUpO1xuICAgICAgdGhpcy5pb19kaXNwLm91dHB1dCh0cnVlKTtcbiAgICAgIHRoaXMuaW9fZXh0Y29taW4ub3V0cHV0KGZhbHNlKTtcbiAgICAgIHRoaXMuaW9fZXh0bW9kZS5vdXRwdXQoZmFsc2UpO1xuICAgIH1cblxuICAgIG9ibml6LnNldFZjY0duZCh0aGlzLnBhcmFtcy52Y2MsIHRoaXMucGFyYW1zLmduZCwgJzV2Jyk7XG4gICAgb2JuaXouc2V0VmNjR25kKHRoaXMucGFyYW1zLnZjY19hLCB0aGlzLnBhcmFtcy5nbmRfYSwgJzV2Jyk7XG5cbiAgICB0aGlzLnBhcmFtcy5tb2RlID0gJ21hc3Rlcic7XG4gICAgdGhpcy5wYXJhbXMuZnJlcXVlbmN5ID0gcGFyc2VJbnQoMTAwMCAqIDEwMDApO1xuICAgIHRoaXMucGFyYW1zLmNsayA9IHRoaXMucGFyYW1zLnNjbGs7XG4gICAgdGhpcy5wYXJhbXMuZHJpdmUgPSAnNXYnOyAvLyBJdCBvdmVyIHNwZWMgZm9yIGZyZXF1ZW5jeS4gQnV0IFZJTi1ISSByZXF1aXJlIDAuN1ZDQzw9LlxuICAgIHRoaXMuc3BpID0gdGhpcy5vYm5pei5nZXRTcGlXaXRoQ29uZmlnKHRoaXMucGFyYW1zKTtcblxuICAgIHRoaXMud2lkdGggPSB0aGlzLnBhcmFtcy53aWR0aDtcbiAgICB0aGlzLmhlaWdodCA9IHRoaXMucGFyYW1zLmhlaWdodDtcblxuICAgIHRoaXMub2JuaXoud2FpdCgxMDApO1xuICB9XG5cbiAgX3JldmVyc2VCaXRzKGRhdGEpIHtcbiAgICBsZXQgcmV2RGF0YSA9IDA7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA4OyBpKyspIHtcbiAgICAgIHJldkRhdGEgKz0gZGF0YSAmIDB4MDE7XG4gICAgICBkYXRhID4+PSAxO1xuICAgICAgaWYgKGkgPCA3KSByZXZEYXRhIDw8PSAxO1xuICAgIH1cbiAgICByZXR1cm4gcmV2RGF0YTtcbiAgfVxuXG4gIHNlbmRMU0IoZGF0YSkge1xuICAgIHRoaXMuc3BpLndyaXRlKFt0aGlzLl9yZXZlcnNlQml0cyhkYXRhKV0pO1xuICB9XG5cbiAgc2VuZENsZWFyKCkge1xuICAgIHRoaXMuaW9fY3Mub3V0cHV0KHRydWUpO1xuICAgIHRoaXMuc3BpLndyaXRlKFt0aGlzLmNvbW1hbmRzLmNsZWFyIHwgMHgwMCwgMHgwMF0pO1xuICAgIHRoaXMuaW9fY3Mub3V0cHV0KGZhbHNlKTtcbiAgfVxuXG4gIHJhdyhyYXdEYXRhKSB7XG4gICAgbGV0IG9sZGxpbmUsIGN1cnJlbnRsaW5lO1xuICAgIGxldCB0b3RhbGJ5dGVzID0gKHRoaXMud2lkdGggKiB0aGlzLmhlaWdodCkgLyA4O1xuICAgIGxldCBhcnJheSA9IG5ldyBBcnJheSgxMDI0KTtcbiAgICBsZXQgaW5kZXggPSAwO1xuICAgIGFycmF5W2luZGV4KytdID0gdGhpcy5jb21tYW5kcy53cml0ZSB8IHRoaXMuY29tbWFuZHMudmNvbTtcbiAgICBvbGRsaW5lID0gY3VycmVudGxpbmUgPSAxO1xuICAgIGFycmF5W2luZGV4KytdID0gdGhpcy5fcmV2ZXJzZUJpdHMoY3VycmVudGxpbmUpO1xuICAgIHRoaXMuaW9fY3Mub3V0cHV0KHRydWUpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG90YWxieXRlczsgaSsrKSB7XG4gICAgICBhcnJheVtpbmRleCsrXSA9IHJhd0RhdGFbaV07IC8vbHNiXG4gICAgICBjdXJyZW50bGluZSA9IHBhcnNlSW50KChpICsgMSkgLyAodGhpcy53aWR0aCAvIDgpICsgMSwgMTApO1xuICAgICAgaWYgKGN1cnJlbnRsaW5lICE9IG9sZGxpbmUpIHtcbiAgICAgICAgYXJyYXlbaW5kZXgrK10gPSAweDAwO1xuICAgICAgICBpZiAoY3VycmVudGxpbmUgPD0gdGhpcy5oZWlnaHQpXG4gICAgICAgICAgYXJyYXlbaW5kZXgrK10gPSB0aGlzLl9yZXZlcnNlQml0cyhjdXJyZW50bGluZSk7XG4gICAgICAgIG9sZGxpbmUgPSBjdXJyZW50bGluZTtcbiAgICAgIH1cbiAgICAgIGlmIChpbmRleCA+PSAxMDIxKSB7XG4gICAgICAgIC8vIHJlZ2FyZGluZyBTUEkgbWF4LlxuICAgICAgICB0aGlzLnNwaS53cml0ZShhcnJheS5zbGljZSgwLCBpbmRleCkpO1xuICAgICAgICBhcnJheSA9IG5ldyBBcnJheSgxMDI0KTtcbiAgICAgICAgaW5kZXggPSAwO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoaW5kZXggPiAwKSB7XG4gICAgICB0aGlzLnNwaS53cml0ZShhcnJheS5zbGljZSgwLCBpbmRleCkpO1xuICAgIH1cbiAgICB0aGlzLnNwaS53cml0ZShbMHgwMF0pO1xuICAgIHRoaXMuaW9fY3Mub3V0cHV0KGZhbHNlKTtcbiAgfVxuXG4gIC8vIGNvcHkgZnJvbSBkaXNwbGF5LmpzXG5cbiAgX3Jlc2V0KCkge1xuICAgIHRoaXMuX3BvcyA9IHsgeDogMCwgeTogMCB9O1xuICAgIHRoaXMuYXV0b0ZsdXNoID0gdHJ1ZTtcbiAgfVxuXG4gIHdhcm5DYW52YXNBdmFpbGFiaWxpdHkoKSB7XG4gICAgaWYgKHRoaXMub2JuaXouaXNOb2RlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdNZW1vcnlEaXNwbGF5IHJlcXVpcmUgbm9kZS1jYW52YXMgdG8gZHJhdyByaWNoIGNvbnRlbnRzLiBzZWUgbW9yZSBkZXRhaWwgb24gZG9jcydcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTWVtb3J5RGlzcGxheSBjYW50IGNyZWF0ZSBjYW52YXMgZWxlbWVudCB0byBib2R5Jyk7XG4gICAgfVxuICB9XG5cbiAgX3ByZXBhcmVkQ2FudmFzKCkge1xuICAgIGlmICh0aGlzLl9jYW52YXMpIHtcbiAgICAgIHJldHVybiB0aGlzLl9jYW52YXM7XG4gICAgfVxuICAgIGlmICh0aGlzLm9ibml6LmlzTm9kZSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyBjcmVhdGVDYW52YXMgfSA9IHJlcXVpcmUoJ2NhbnZhcycpO1xuICAgICAgICB0aGlzLl9jYW52YXMgPSBjcmVhdGVDYW52YXModGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvLyB0aGlzLndhcm5DYW52YXNBdmFpbGFiaWxpdHkoKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGlkZW50aWZpZXIgPSAnTWVtb3J5RGlzcENhbnZhcy0nICsgdGhpcy5vYm5pei5pZDtcbiAgICAgIGxldCBjYW52YXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZGVudGlmaWVyKTtcbiAgICAgIGlmICghY2FudmFzKSB7XG4gICAgICAgIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgICBjYW52YXMuc2V0QXR0cmlidXRlKCdpZCcsIGlkZW50aWZpZXIpO1xuICAgICAgICBjYW52YXMuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nO1xuICAgICAgICBjYW52YXMud2lkdGggPSB0aGlzLndpZHRoO1xuICAgICAgICBjYW52YXMuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7XG4gICAgICAgIGNhbnZhcy5zdHlsZVsnLXdlYmtpdC1mb250LXNtb290aGluZyddID0gJ25vbmUnO1xuICAgICAgICBsZXQgYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF07XG4gICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQoY2FudmFzKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2NhbnZhcyA9IGNhbnZhcztcbiAgICB9XG4gICAgY29uc3QgY3R4ID0gdGhpcy5fY2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgY3R4LmZpbGxTdHlsZSA9ICcjRkZGJztcbiAgICBjdHguZmlsbFJlY3QoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpO1xuICAgIGN0eC5maWxsU3R5bGUgPSAnIzAwMCc7XG4gICAgY3R4LnN0cm9rZVN0eWxlID0gJyMwMDAnO1xuICAgIHRoaXMuX3Bvcy54ID0gMDtcbiAgICB0aGlzLl9wb3MueSA9IDA7XG4gICAgdGhpcy5mb250U2l6ZSA9IDE2O1xuICAgIGN0eC5mb250ID0gYCR7dGhpcy5mb250U2l6ZX1weCBBcmlhbGA7XG4gICAgcmV0dXJuIHRoaXMuX2NhbnZhcztcbiAgfVxuXG4gIF9jdHgoKSB7XG4gICAgY29uc3QgY2FudmFzID0gdGhpcy5fcHJlcGFyZWRDYW52YXMoKTtcbiAgICBpZiAoY2FudmFzKSB7XG4gICAgICByZXR1cm4gY2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgfVxuICB9XG5cbiAgZm9udChmb250LCBzaXplKSB7XG4gICAgY29uc3QgY3R4ID0gdGhpcy5fY3R4KCk7XG4gICAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJykge1xuICAgICAgc2l6ZSA9IDE2O1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGZvbnQgIT09ICdzdHJpbmcnKSB7XG4gICAgICBmb250ID0gJ0FyaWFsJztcbiAgICB9XG4gICAgdGhpcy5mb250U2l6ZSA9IHNpemU7XG4gICAgY3R4LmZvbnQgPSAnJyArIHNpemUgKyAncHggJyArIGZvbnQ7XG4gIH1cblxuICBjbGVhcigpIHtcbiAgICBjb25zdCBjdHggPSB0aGlzLl9jdHgoKTtcbiAgICB0aGlzLl9wb3MueCA9IDA7XG4gICAgdGhpcy5fcG9zLnkgPSAwO1xuICAgIGlmIChjdHgpIHtcbiAgICAgIGN0eC5maWxsU3R5bGUgPSAnI2ZmZic7XG4gICAgICBjdHguZmlsbFJlY3QoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpO1xuICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMDAwJztcbiAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICcjMDAwJztcbiAgICAgIHRoaXMuZHJhdyhjdHgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNlbmRDbGVhcigpO1xuICAgIH1cbiAgfVxuXG4gIHBvcyh4LCB5KSB7XG4gICAgdGhpcy5fY3R4KCk7IC8vY3JldGUgZmlyc3RcbiAgICBpZiAodHlwZW9mIHggPT0gJ251bWJlcicpIHtcbiAgICAgIHRoaXMuX3Bvcy54ID0geDtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB5ID09ICdudW1iZXInKSB7XG4gICAgICB0aGlzLl9wb3MueSA9IHk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9wb3M7XG4gIH1cblxuICBwcmludCh0ZXh0KSB7XG4gICAgY29uc3QgY3R4ID0gdGhpcy5fY3R4KCk7XG4gICAgaWYgKGN0eCkge1xuICAgICAgY3R4LmZpbGxUZXh0KHRleHQsIHRoaXMuX3Bvcy54LCB0aGlzLl9wb3MueSArIHRoaXMuZm9udFNpemUpO1xuICAgICAgdGhpcy5kcmF3KGN0eCk7XG4gICAgICB0aGlzLl9wb3MueSArPSB0aGlzLmZvbnRTaXplO1xuICAgIH0gZWxzZSB7XG4gICAgICAvKlxuICAgICAgbGV0IG9iaiA9IHt9O1xuICAgICAgb2JqWydkaXNwbGF5J10gPSB7XG4gICAgICAgIHRleHQ6ICcnICsgdGV4dCxcbiAgICAgIH07XG4gICAgICB0aGlzLm9ibml6LnNlbmQob2JqKTtcbiAgICAgICovXG4gICAgfVxuICB9XG5cbiAgbGluZSh4XzAsIHlfMCwgeF8xLCB5XzEpIHtcbiAgICBjb25zdCBjdHggPSB0aGlzLl9jdHgoKTtcbiAgICBpZiAoY3R4KSB7XG4gICAgICBjdHguYmVnaW5QYXRoKCk7XG4gICAgICBjdHgubW92ZVRvKHhfMCwgeV8wKTtcbiAgICAgIGN0eC5saW5lVG8oeF8xLCB5XzEpO1xuICAgICAgY3R4LnN0cm9rZSgpO1xuICAgICAgdGhpcy5kcmF3KGN0eCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMud2FybkNhbnZhc0F2YWlsYWJpbGl0eSgpO1xuICAgIH1cbiAgfVxuXG4gIHJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCwgbXVzdEZpbGwpIHtcbiAgICBjb25zdCBjdHggPSB0aGlzLl9jdHgoKTtcbiAgICBpZiAoY3R4KSB7XG4gICAgICBpZiAobXVzdEZpbGwpIHtcbiAgICAgICAgY3R4LmZpbGxSZWN0KHgsIHksIHdpZHRoLCBoZWlnaHQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY3R4LnN0cm9rZVJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7XG4gICAgICB9XG4gICAgICB0aGlzLmRyYXcoY3R4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy53YXJuQ2FudmFzQXZhaWxhYmlsaXR5KCk7XG4gICAgfVxuICB9XG5cbiAgY2lyY2xlKHgsIHksIHIsIG11c3RGaWxsKSB7XG4gICAgY29uc3QgY3R4ID0gdGhpcy5fY3R4KCk7XG4gICAgaWYgKGN0eCkge1xuICAgICAgY3R4LmJlZ2luUGF0aCgpO1xuICAgICAgY3R4LmFyYyh4LCB5LCByLCAwLCBNYXRoLlBJICogMik7XG4gICAgICBpZiAobXVzdEZpbGwpIHtcbiAgICAgICAgY3R4LmZpbGwoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGN0eC5zdHJva2UoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZHJhdyhjdHgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndhcm5DYW52YXNBdmFpbGFiaWxpdHkoKTtcbiAgICB9XG4gIH1cblxuICBfZHJhdyhjdHgpIHtcbiAgICBjb25zdCBzdHJpZGUgPSB0aGlzLndpZHRoIC8gODtcbiAgICBsZXQgdnJhbSA9IG5ldyBBcnJheShzdHJpZGUgKiA2NCk7XG4gICAgY29uc3QgaW1hZ2VEYXRhID0gY3R4LmdldEltYWdlRGF0YSgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7XG4gICAgY29uc3QgZGF0YSA9IGltYWdlRGF0YS5kYXRhO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArPSA0KSB7XG4gICAgICBsZXQgYnJpZ2h0bmVzcyA9IDAuMzQgKiBkYXRhW2ldICsgMC41ICogZGF0YVtpICsgMV0gKyAwLjE2ICogZGF0YVtpICsgMl07XG4gICAgICBsZXQgaW5kZXggPSBwYXJzZUludChpIC8gNCk7XG4gICAgICBsZXQgbGluZSA9IHBhcnNlSW50KGluZGV4IC8gdGhpcy53aWR0aCk7XG4gICAgICBsZXQgY29sID0gcGFyc2VJbnQoKGluZGV4IC0gbGluZSAqIHRoaXMud2lkdGgpIC8gOCk7XG4gICAgICBsZXQgYml0cyA9IHBhcnNlSW50KGluZGV4IC0gbGluZSAqIHRoaXMud2lkdGgpICUgODtcbiAgICAgIGlmIChiaXRzID09IDApIHZyYW1bbGluZSAqIHN0cmlkZSArIGNvbF0gPSAweDAwO1xuICAgICAgaWYgKGJyaWdodG5lc3MgPiAweDczKSB2cmFtW2xpbmUgKiBzdHJpZGUgKyBjb2xdIHw9IDB4ODAgPj4gYml0cztcbiAgICB9XG4gICAgdGhpcy5yYXcodnJhbSk7XG4gIH1cblxuICBkcmF3KGN0eCkge1xuICAgIGlmICh0aGlzLmF1dG9GbHVzaCkge1xuICAgICAgdGhpcy5fZHJhdyhjdHgpO1xuICAgIH1cbiAgfVxuXG4gIGRyYXdpbmcoYXV0b0ZsdXNoKSB7XG4gICAgdGhpcy5hdXRvRmx1c2ggPSBhdXRvRmx1c2ggPT0gdHJ1ZTtcbiAgICBjb25zdCBjdHggPSB0aGlzLl9jdHgoKTtcbiAgICBpZiAoY3R4KSB7XG4gICAgICB0aGlzLmRyYXcoY3R4KTtcbiAgICB9XG4gIH1cbn1cblxuaWYgKHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnKSB7XG4gIG1vZHVsZS5leHBvcnRzID0gU2hhcnBNZW1vcnlURlQ7XG59XG4iXX0=

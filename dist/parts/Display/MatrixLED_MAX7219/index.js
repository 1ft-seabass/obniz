"use strict";
class MatrixLED_MAX7219 {
    constructor() {
        this.keys = ['vcc', 'gnd', 'din', 'cs', 'clk'];
        this.requiredKeys = ['din', 'cs', 'clk'];
    }
    static info() {
        return {
            name: 'MatrixLED_MAX7219',
        };
    }
    wired(obniz) {
        this.cs = obniz.getIO(this.params.cs);
        // logich high must 3.5v <=
        if (obniz.isValidIO(this.params.vcc)) {
            obniz.getIO(this.params.vcc).output(true);
        }
        if (obniz.isValidIO(this.params.gnd)) {
            obniz.getIO(this.params.gnd).output(false);
        }
        // max 10Mhz but motor driver can't
        this.params.frequency = this.params.frequency || 10 * 1000 * 1000;
        this.params.mode = 'master';
        this.params.mosi = this.params.din;
        this.params.drive = '3v';
        this.spi = this.obniz.getSpiWithConfig(this.params);
        // reset a onece
        this.cs.output(true);
        this.cs.output(false);
        this.cs.output(true);
    }
    init(width, height) {
        this.width = width;
        this.height = height;
        this.preparevram(width, height);
        this.initModule();
    }
    initModule() {
        this.write([0x09, 0x00]); // Code B decode for digits 3-0 No decode for digits 7-4
        this.write([0x0a, 0x05]); // brightness 9/32 0 to f
        this.write([0x0b, 0x07]); // Display digits 0 1 2 3 4 567
        this.write([0x0c, 0x01]); // Shutdown to normal operation
        this.write([0x0f, 0x00]);
        this.passingCommands();
        this.obniz.wait(10);
    }
    test() {
        this.write([0x0f, 0x00]); // test command
        this.passingCommands();
    }
    passingCommands() {
        for (let i = 8; i < this.width; i += 8) {
            // this needed for number of unit
            this.write([0x00, 0x00]);
        }
    }
    brightness(val) {
        this.write([0x0a, val]); // 0 to 15;
        this.passingCommands();
    }
    preparevram(width, height) {
        this.vram = [];
        for (let i = 0; i < height; i++) {
            let dots = new Array(width / 8);
            for (let ii = 0; ii < dots.length; ii++) {
                dots[ii] = 0x00;
            }
            this.vram.push(dots);
        }
    }
    write(data) {
        this.cs.output(false);
        this.spi.write(data);
        this.cs.output(true);
    }
    writeVram() {
        for (let line_num = 0; line_num < this.height; line_num++) {
            let addr = line_num + 1;
            let line = this.vram[line_num];
            let data = [];
            for (let col = 0; col < line.length; col++) {
                data.push(addr);
                data.push(line[col]);
            }
            this.write(data);
        }
    }
    clear() {
        for (let line_num = 0; line_num < this.height; line_num++) {
            let line = this.vram[line_num];
            for (let col = 0; col < line.length; col++) {
                this.vram[line_num][col] = 0x00;
            }
            this.writeVram();
        }
    }
    draw(ctx) {
        const imageData = ctx.getImageData(0, 0, this.width, this.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            let brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];
            let index = parseInt(i / 4);
            let line = parseInt(index / this.width);
            let col = parseInt((index - line * this.width) / 8);
            let bits = parseInt(index - line * this.width) % 8;
            if (bits === 0)
                this.vram[line][col] = 0x00;
            if (brightness > 0x7f)
                this.vram[line][col] |= 0x80 >> bits;
        }
        this.writeVram();
    }
}
if (typeof module === 'object') {
    module.exports = MatrixLED_MAX7219;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXJ0cy9EaXNwbGF5L01hdHJpeExFRF9NQVg3MjE5L2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxNQUFNLGlCQUFpQjtJQUNyQjtRQUNFLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFJO1FBQ1QsT0FBTztZQUNMLElBQUksRUFBRSxtQkFBbUI7U0FDMUIsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSztRQUNULElBQUksQ0FBQyxFQUFFLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3RDLDJCQUEyQjtRQUMzQixJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNwQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzNDO1FBQ0QsSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDcEMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM1QztRQUVELG1DQUFtQztRQUNuQyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsSUFBSSxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNsRSxJ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LEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxFQUFFO2dCQUMxQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQzthQUNqQztZQUNELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUNsQjtJQUNILENBQUM7SUFFRCxJQUFJLENBQUMsR0FBRztRQUNOLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNsRSxNQUFNLElBQUksR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDO1FBRTVCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDdkMsSUFBSSxVQUFVLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN6RSxJQUFJLEtBQUssR0FBRyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzVCLElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3hDLElBQUksR0FBRyxHQUFHLFFBQVEsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3BELElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxLQUFLLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbkQsSUFBSSxJQUFJLEtBQUssQ0FBQztnQkFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztZQUM1QyxJQUFJLFVBQVUsR0FBRyxJQUFJO2dCQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQztTQUM3RDtRQUVELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNuQixDQUFDO0NBQ0Y7QUFFRCxJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsRUFBRTtJQUM5QixNQUFNLENBQUMsT0FBTyxHQUFHLGlCQUFpQixDQUFDO0NBQ3BDIiwiZmlsZSI6InBhcnRzL0Rpc3BsYXkvTWF0cml4TEVEX01BWDcyMTkvaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJjbGFzcyBNYXRyaXhMRURfTUFYNzIxOSB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMua2V5cyA9IFsndmNjJywgJ2duZCcsICdkaW4nLCAnY3MnLCAnY2xrJ107XG4gICAgdGhpcy5yZXF1aXJlZEtleXMgPSBbJ2RpbicsICdjcycsICdjbGsnXTtcbiAgfVxuXG4gIHN0YXRpYyBpbmZvKCkge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiAnTWF0cml4TEVEX01BWDcyMTknLFxuICAgIH07XG4gIH1cblxuICB3aXJlZChvYm5peikge1xuICAgIHRoaXMuY3MgPSBvYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5jcyk7XG4gICAgLy8gbG9naWNoIGhpZ2ggbXVzdCAzLjV2IDw9XG4gICAgaWYgKG9ibml6LmlzVmFsaWRJTyh0aGlzLnBhcmFtcy52Y2MpKSB7XG4gICAgICBvYm5pei5nZXRJTyh0aGlzLnBhcmFtcy52Y2MpLm91dHB1dCh0cnVlKTtcbiAgICB9XG4gICAgaWYgKG9ibml6LmlzVmFsaWRJTyh0aGlzLnBhcmFtcy5nbmQpKSB7XG4gICAgICBvYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5nbmQpLm91dHB1dChmYWxzZSk7XG4gICAgfVxuXG4gICAgLy8gbWF4IDEwTWh6IGJ1dCBtb3RvciBkcml2ZXIgY2FuJ3RcbiAgICB0aGlzLnBhcmFtcy5mcmVxdWVuY3kgPSB0aGlzLnBhcmFtcy5mcmVxdWVuY3kgfHwgMTAgKiAxMDAwICogMTAwMDtcbiAgICB0aGlzLnBhcmFtcy5tb2RlID0gJ21hc3Rlcic7XG4gICAgdGhpcy5wYXJhbXMubW9zaSA9IHRoaXMucGFyYW1zLmRpbjtcbiAgICB0aGlzLnBhcmFtcy5kcml2ZSA9ICczdic7XG4gICAgdGhpcy5zcGkgPSB0aGlzLm9ibml6LmdldFNwaVdpdGhDb25maWcodGhpcy5wYXJhbXMpO1xuXG4gICAgLy8gcmVzZXQgYSBvbmVjZVxuICAgIHRoaXMuY3Mub3V0cHV0KHRydWUpO1xuICAgIHRoaXMuY3Mub3V0cHV0KGZhbHNlKTtcbiAgICB0aGlzLmNzLm91dHB1dCh0cnVlKTtcbiAgfVxuXG4gIGluaXQod2lkdGgsIGhlaWdodCkge1xuICAgIHRoaXMud2lkdGggPSB3aWR0aDtcbiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDtcbiAgICB0aGlzLnByZXBhcmV2cmFtKHdpZHRoLCBoZWlnaHQpO1xuICAgIHRoaXMuaW5pdE1vZHVsZSgpO1xuICB9XG5cbiAgaW5pdE1vZHVsZSgpIHtcbiAgICB0aGlzLndyaXRlKFsweDA5LCAweDAwXSk7IC8vIENvZGUgQiBkZWNvZGUgZm9yIGRpZ2l0cyAzLTAgTm8gZGVjb2RlIGZvciBkaWdpdHMgNy00XG4gICAgdGhpcy53cml0ZShbMHgwYSwgMHgwNV0pOyAvLyBicmlnaHRuZXNzIDkvMzIgMCB0byBmXG4gICAgdGhpcy53cml0ZShbMHgwYiwgMHgwN10pOyAvLyBEaXNwbGF5IGRpZ2l0cyAwIDEgMiAzIDQgNTY3XG4gICAgdGhpcy53cml0ZShbMHgwYywgMHgwMV0pOyAvLyBTaHV0ZG93biB0byBub3JtYWwgb3BlcmF0aW9uXG4gICAgdGhpcy53cml0ZShbMHgwZiwgMHgwMF0pO1xuICAgIHRoaXMucGFzc2luZ0NvbW1hbmRzKCk7XG4gICAgdGhpcy5vYm5pei53YWl0KDEwKTtcbiAgfVxuXG4gIHRlc3QoKSB7XG4gICAgdGhpcy53cml0ZShbMHgwZiwgMHgwMF0pOyAvLyB0ZXN0IGNvbW1hbmRcbiAgICB0aGlzLnBhc3NpbmdDb21tYW5kcygpO1xuICB9XG5cbiAgcGFzc2luZ0NvbW1hbmRzKCkge1xuICAgIGZvciAobGV0IGkgPSA4OyBpIDwgdGhpcy53aWR0aDsgaSArPSA4KSB7XG4gICAgICAvLyB0aGlzIG5lZWRlZCBmb3IgbnVtYmVyIG9mIHVuaXRcbiAgICAgIHRoaXMud3JpdGUoWzB4MDAsIDB4MDBdKTtcbiAgICB9XG4gIH1cblxuICBicmlnaHRuZXNzKHZhbCkge1xuICAgIHRoaXMud3JpdGUoWzB4MGEsIHZhbF0pOyAvLyAwIHRvIDE1O1xuICAgIHRoaXMucGFzc2luZ0NvbW1hbmRzKCk7XG4gIH1cblxuICBwcmVwYXJldnJhbSh3aWR0aCwgaGVpZ2h0KSB7XG4gICAgdGhpcy52cmFtID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoZWlnaHQ7IGkrKykge1xuICAgICAgbGV0IGRvdHMgPSBuZXcgQXJyYXkod2lkdGggLyA4KTtcbiAgICAgIGZvciAobGV0IGlpID0gMDsgaWkgPCBkb3RzLmxlbmd0aDsgaWkrKykge1xuICAgICAgICBkb3RzW2lpXSA9IDB4MDA7XG4gICAgICB9XG4gICAgICB0aGlzLnZyYW0ucHVzaChkb3RzKTtcbiAgICB9XG4gIH1cblxuICB3cml0ZShkYXRhKSB7XG4gICAgdGhpcy5jcy5vdXRwdXQoZmFsc2UpO1xuICAgIHRoaXMuc3BpLndyaXRlKGRhdGEpO1xuICAgIHRoaXMuY3Mub3V0cHV0KHRydWUpO1xuICB9XG5cbiAgd3JpdGVWcmFtKCkge1xuICAgIGZvciAobGV0IGxpbmVfbnVtID0gMDsgbGluZV9udW0gPCB0aGlzLmhlaWdodDsgbGluZV9udW0rKykge1xuICAgICAgbGV0IGFkZHIgPSBsaW5lX251bSArIDE7XG4gICAgICBsZXQgbGluZSA9IHRoaXMudnJhbVtsaW5lX251bV07XG4gICAgICBsZXQgZGF0YSA9IFtdO1xuICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgbGluZS5sZW5ndGg7IGNvbCsrKSB7XG4gICAgICAgIGRhdGEucHVzaChhZGRyKTtcbiAgICAgICAgZGF0YS5wdXNoKGxpbmVbY29sXSk7XG4gICAgICB9XG4gICAgICB0aGlzLndyaXRlKGRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIGNsZWFyKCkge1xuICAgIGZvciAobGV0IGxpbmVfbnVtID0gMDsgbGluZV9udW0gPCB0aGlzLmhlaWdodDsgbGluZV9udW0rKykge1xuICAgICAgbGV0IGxpbmUgPSB0aGlzLnZyYW1bbGluZV9udW1dO1xuICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgbGluZS5sZW5ndGg7IGNvbCsrKSB7XG4gICAgICAgIHRoaXMudnJhbVtsaW5lX251bV1bY29sXSA9IDB4MDA7XG4gICAgICB9XG4gICAgICB0aGlzLndyaXRlVnJhbSgpO1xuICAgIH1cbiAgfVxuXG4gIGRyYXcoY3R4KSB7XG4gICAgY29uc3QgaW1hZ2VEYXRhID0gY3R4LmdldEltYWdlRGF0YSgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7XG4gICAgY29uc3QgZGF0YSA9IGltYWdlRGF0YS5kYXRhO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArPSA0KSB7XG4gICAgICBsZXQgYnJpZ2h0bmVzcyA9IDAuMzQgKiBkYXRhW2ldICsgMC41ICogZGF0YVtpICsgMV0gKyAwLjE2ICogZGF0YVtpICsgMl07XG4gICAgICBsZXQgaW5kZXggPSBwYXJzZUludChpIC8gNCk7XG4gICAgICBsZXQgbGluZSA9IHBhcnNlSW50KGluZGV4IC8gdGhpcy53aWR0aCk7XG4gICAgICBsZXQgY29sID0gcGFyc2VJbnQoKGluZGV4IC0gbGluZSAqIHRoaXMud2lkdGgpIC8gOCk7XG4gICAgICBsZXQgYml0cyA9IHBhcnNlSW50KGluZGV4IC0gbGluZSAqIHRoaXMud2lkdGgpICUgODtcbiAgICAgIGlmIChiaXRzID09PSAwKSB0aGlzLnZyYW1bbGluZV1bY29sXSA9IDB4MDA7XG4gICAgICBpZiAoYnJpZ2h0bmVzcyA+IDB4N2YpIHRoaXMudnJhbVtsaW5lXVtjb2xdIHw9IDB4ODAgPj4gYml0cztcbiAgICB9XG5cbiAgICB0aGlzLndyaXRlVnJhbSgpO1xuICB9XG59XG5cbmlmICh0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0Jykge1xuICBtb2R1bGUuZXhwb3J0cyA9IE1hdHJpeExFRF9NQVg3MjE5O1xufVxuIl19

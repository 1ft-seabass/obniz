"use strict";
class PCA9685 {
    constructor() {
        /* https://www.nxp.com/docs/en/data-sheet/PCA9685.pdf */
        this.keys = [
            'gnd',
            'vcc',
            'scl',
            'sda',
            'oe',
            'i2c',
            'enabled',
            'address',
            'drive',
        ];
        this.requiredKeys = [];
        this.address = 0x40;
        this._commands = {
            MODE1: 0x00,
            MODE2: 0x01,
            SUBADR1: 0x02,
            SUBADR2: 0x03,
            SUBADR3: 0x04,
            PRESCALE: 0xfe,
            LED0_ON_L: 0x06,
            ALL_LED_ON_L: 0xfa,
            bits: {
                ALLCALL: 0x01,
                SLEEP_ENABLE: 0x10,
                AUTO_INCREMENT_ENABLED: 0x20,
                RESTART: 0x80,
                OUTDRV: 0x04,
                INVRT: 0x10,
            },
        };
        this._regs = new Array(1);
        this.pwmNum = 16;
        this.pwms = [];
        this._preparePWM(this.pwmNum);
    }
    static info() {
        return {
            name: 'PCA9685',
        };
    }
    wired(obniz) {
        this.obniz = obniz;
        if (obniz.isValidIO(this.params.oe)) {
            this.io_oe = obniz.getIO(this.params.oe);
        }
        this.obniz.setVccGnd(this.params.vcc, this.params.gnd, '5v');
        if (typeof this.params.address === 'number') {
            this.address = this.params.address;
        }
        this.params.clock = this.params.clock || 400 * 1000; //for i2c
        this.params.mode = this.params.mode || 'master'; //for i2c
        this.params.pull = this.params.pull || '5v'; //for i2c
        this.i2c = obniz.getI2CWithConfig(this.params);
        if (this.obniz.isValidIO(this.params.srclr)) {
            this.io_srclr = this.obniz.getIO(this.params.srclr);
            this.io_srclr.output(true);
        }
        if (typeof this.params.enabled !== 'boolean') {
            this.params.enabled = true;
        }
        if (this.io_oe && this.params.enabled) {
            this.io_oe.output(false);
        }
        if (this.params.drive === 'open-drain') {
            this.i2c.write(this.address, [
                this._commands.MODE2,
                this._commands.bits.OUTDRV,
            ]);
        }
        let mode1 = this._commands.bits.AUTO_INCREMENT_ENABLED;
        mode1 = mode1 & ~this._commands.bits.SLEEP_ENABLE;
        this.i2c.write(this.address, [this._commands.MODE1, mode1]);
        this.i2c.write(this.address, [
            this._commands.MODE1,
            mode1 | this._commands.bits.RESTART,
        ]);
        this._regs[this._commands.MODE1] = mode1;
        obniz.wait(10);
    }
    _preparePWM(num) {
        class PCA9685_PWM {
            constructor(chip, id) {
                this.chip = chip;
                this.id = id;
                this.value = 0;
                this.state = {};
            }
            freq(frequency) {
                this.chip.freq(frequency);
            }
            pulse(value) {
                this.chip.pulse(this.id, value);
            }
            duty(value) {
                this.chip.duty(this.id, value);
            }
        }
        for (let i = 0; i < num; i++) {
            this.pwms.push(new PCA9685_PWM(this, i));
        }
    }
    isValidPWM(id) {
        return typeof id === 'number' && id >= 0 && id < this.pwmNum;
    }
    getPWM(id) {
        if (!this.isValidPWM(id)) {
            throw new Error('pwm ' + id + ' is not valid pwm');
        }
        return this.pwms[id];
    }
    freq(frequency) {
        if (typeof frequency !== 'number') {
            return;
        }
        if (frequency < 24 || 1526 < frequency) {
            throw new Error('freq must be within 24-1526 hz');
        }
        if (this._freq === frequency) {
            return;
        }
        let prescaleval = 25000000.0; // 25MHz
        prescaleval /= 4096.0; //12bit
        prescaleval /= frequency * 0.9;
        prescaleval -= 1.0;
        const prescale = parseInt(Math.floor(prescaleval + 0.5));
        const mode1 = this._regs[this._commands.MODE1];
        this.i2c.write(this.address, [
            this._commands.MODE1,
            (mode1 & 0x7f) | this._commands.bits.SLEEP_ENABLE,
        ]); // enter sleep
        this.i2c.write(this.address, [this._commands.PRESCALE, prescale]);
        this.i2c.write(this.address, [this._commands.MODE1, mode1]); // recover from sleep
        this.obniz.wait(5);
        // save
        this._freq = frequency;
        for (let i = 0; i < this.pwms.length; i++) {
            this.pwms[i].state.freq = this._freq;
        }
    }
    pulse(id, pulse_width) {
        if (typeof this._freq !== 'number' || this._freq <= 0) {
            throw new Error('please provide freq first.');
        }
        this.duty(id, (pulse_width / 1000.0 / (1.0 / this._freq)) * 100);
    }
    duty(id, duty) {
        duty *= 1.0;
        if (typeof this._freq !== 'number' || this._freq <= 0) {
            throw new Error('please provide freq first.');
        }
        if (typeof duty !== 'number') {
            throw new Error('please provide duty in number');
        }
        if (duty < 0) {
            duty = 0;
        }
        if (duty > 100) {
            duty = 100;
        }
        this.getPWM(id).state.duty = duty;
        this.writeSingleONOFF(id, 0, (duty / 100.0) * 4095);
    }
    writeSingleONOFF(id, on, off) {
        this.i2c.write(this.address, [
            this._commands.LED0_ON_L + 4 * id,
            on & 0xff,
            on >> 8,
            off & 0xff,
            off >> 8,
        ]);
    }
    setEnable(enable) {
        if (!this.io_oe && enable == false) {
            throw new Error('pin "oe" is not specified');
        }
        this.io_oe.output(!enable);
    }
}
if (typeof module === 'object') {
    module.exports = PCA9685;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXJ0cy9Nb3ZpbmcvUENBOTY4NS9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsTUFBTSxPQUFPO0lBQ1g7UUFDRSx3REFBd0Q7UUFDeEQsSUFBSSxDQUFDLElBQUksR0FBRztZQUNWLEtBQUs7WUFDTCxLQUFLO1lBQ0wsS0FBSztZQUNMLEtBQUs7WUFDTCxJQUFJO1lBQ0osS0FBSztZQUNMLFNBQVM7WUFDVCxTQUFTO1lBQ1QsT0FBTztTQUNSLENBQUM7UUFDRixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUV2QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUVwQixJQUFJLENBQUMsU0FBUyxHQUFHO1lBQ2YsS0FBSyxFQUFFLElBQUk7WUFDWCxLQUFLLEVBQUUsSUFBSTtZQUNYLE9BQU8sRUFBRSxJQUFJO1lBQ2IsT0FBTyxFQUFFLElBQUk7WUFDYixPQUFPLEVBQUUsSUFBSTtZQUNiLFFBQVEsRUFBRSxJQUFJO1lBQ2QsU0FBUyxFQUFFLElBQUk7WUFDZixZQUFZLEVBQUUsSUFBSTtZQUNsQixJQUFJLEVBQUU7Z0JBQ0osT0FBTyxFQUFFLElBQUk7Z0JBQ2IsWUFBWSxFQUFFLElBQUk7Z0JBQ2xCLHNCQUFzQixFQUFFLElBQUk7Z0JBQzVCLE9BQU8sRUFBRSxJQUFJO2dCQUViLE1BQU0sRUFBRSxJQUFJO2dCQUNaLEtBQUssRUFBRSxJQUFJO2FBQ1o7U0FDRixDQUFDO1FBRUYsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUUxQixJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxNQUFNLENBQUMsSUFBSTtRQUNULE9BQU87WUFDTCxJQUFJLEVBQUUsU0FB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UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzdCLENBQUM7Q0FDRjtBQUVELElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFO0lBQzlCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0NBQzFCIiwiZmlsZSI6InBhcnRzL01vdmluZy9QQ0E5Njg1L2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY2xhc3MgUENBOTY4NSB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIC8qIGh0dHBzOi8vd3d3Lm54cC5jb20vZG9jcy9lbi9kYXRhLXNoZWV0L1BDQTk2ODUucGRmICovXG4gICAgdGhpcy5rZXlzID0gW1xuICAgICAgJ2duZCcsXG4gICAgICAndmNjJyxcbiAgICAgICdzY2wnLFxuICAgICAgJ3NkYScsXG4gICAgICAnb2UnLFxuICAgICAgJ2kyYycsXG4gICAgICAnZW5hYmxlZCcsXG4gICAgICAnYWRkcmVzcycsXG4gICAgICAnZHJpdmUnLFxuICAgIF07XG4gICAgdGhpcy5yZXF1aXJlZEtleXMgPSBbXTtcblxuICAgIHRoaXMuYWRkcmVzcyA9IDB4NDA7XG5cbiAgICB0aGlzLl9jb21tYW5kcyA9IHtcbiAgICAgIE1PREUxOiAweDAwLFxuICAgICAgTU9ERTI6IDB4MDEsXG4gICAgICBTVUJBRFIxOiAweDAyLFxuICAgICAgU1VCQURSMjogMHgwMyxcbiAgICAgIFNVQkFEUjM6IDB4MDQsXG4gICAgICBQUkVTQ0FMRTogMHhmZSxcbiAgICAgIExFRDBfT05fTDogMHgwNixcbiAgICAgIEFMTF9MRURfT05fTDogMHhmYSxcbiAgICAgIGJpdHM6IHtcbiAgICAgICAgQUxMQ0FMTDogMHgwMSxcbiAgICAgICAgU0xFRVBfRU5BQkxFOiAweDEwLFxuICAgICAgICBBVVRPX0lOQ1JFTUVOVF9FTkFCTEVEOiAweDIwLFxuICAgICAgICBSRVNUQVJUOiAweDgwLFxuXG4gICAgICAgIE9VVERSVjogMHgwNCxcbiAgICAgICAgSU5WUlQ6IDB4MTAsXG4gICAgICB9LFxuICAgIH07XG5cbiAgICB0aGlzLl9yZWdzID0gbmV3IEFycmF5KDEpO1xuXG4gICAgdGhpcy5wd21OdW0gPSAxNjtcbiAgICB0aGlzLnB3bXMgPSBbXTtcbiAgICB0aGlzLl9wcmVwYXJlUFdNKHRoaXMucHdtTnVtKTtcbiAgfVxuXG4gIHN0YXRpYyBpbmZvKCkge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiAnUENBOTY4NScsXG4gICAgfTtcbiAgfVxuXG4gIHdpcmVkKG9ibml6KSB7XG4gICAgdGhpcy5vYm5peiA9IG9ibml6O1xuXG4gICAgaWYgKG9ibml6LmlzVmFsaWRJTyh0aGlzLnBhcmFtcy5vZSkpIHtcbiAgICAgIHRoaXMuaW9fb2UgPSBvYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5vZSk7XG4gICAgfVxuXG4gICAgdGhpcy5vYm5pei5zZXRWY2NHbmQodGhpcy5wYXJhbXMudmNjLCB0aGlzLnBhcmFtcy5nbmQsICc1dicpO1xuXG4gICAgaWYgKHR5cGVvZiB0aGlzLnBhcmFtcy5hZGRyZXNzID09PSAnbnVtYmVyJykge1xuICAgICAgdGhpcy5hZGRyZXNzID0gdGhpcy5wYXJhbXMuYWRkcmVzcztcbiAgICB9XG5cbiAgICB0aGlzLnBhcmFtcy5jbG9jayA9IHRoaXMucGFyYW1zLmNsb2NrIHx8IDQwMCAqIDEwMDA7IC8vZm9yIGkyY1xuICAgIHRoaXMucGFyYW1zLm1vZGUgPSB0aGlzLnBhcmFtcy5tb2RlIHx8ICdtYXN0ZXInOyAvL2ZvciBpMmNcbiAgICB0aGlzLnBhcmFtcy5wdWxsID0gdGhpcy5wYXJhbXMucHVsbCB8fCAnNXYnOyAvL2ZvciBpMmNcbiAgICB0aGlzLmkyYyA9IG9ibml6LmdldEkyQ1dpdGhDb25maWcodGhpcy5wYXJhbXMpO1xuXG4gICAgaWYgKHRoaXMub2JuaXouaXNWYWxpZElPKHRoaXMucGFyYW1zLnNyY2xyKSkge1xuICAgICAgdGhpcy5pb19zcmNsciA9IHRoaXMub2JuaXouZ2V0SU8odGhpcy5wYXJhbXMuc3JjbHIpO1xuICAgICAgdGhpcy5pb19zcmNsci5vdXRwdXQodHJ1ZSk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiB0aGlzLnBhcmFtcy5lbmFibGVkICE9PSAnYm9vbGVhbicpIHtcbiAgICAgIHRoaXMucGFyYW1zLmVuYWJsZWQgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAodGhpcy5pb19vZSAmJiB0aGlzLnBhcmFtcy5lbmFibGVkKSB7XG4gICAgICB0aGlzLmlvX29lLm91dHB1dChmYWxzZSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucGFyYW1zLmRyaXZlID09PSAnb3Blbi1kcmFpbicpIHtcbiAgICAgIHRoaXMuaTJjLndyaXRlKHRoaXMuYWRkcmVzcywgW1xuICAgICAgICB0aGlzLl9jb21tYW5kcy5NT0RFMixcbiAgICAgICAgdGhpcy5fY29tbWFuZHMuYml0cy5PVVREUlYsXG4gICAgICBdKTtcbiAgICB9XG5cbiAgICBsZXQgbW9kZTEgPSB0aGlzLl9jb21tYW5kcy5iaXRzLkFVVE9fSU5DUkVNRU5UX0VOQUJMRUQ7XG4gICAgbW9kZTEgPSBtb2RlMSAmIH50aGlzLl9jb21tYW5kcy5iaXRzLlNMRUVQX0VOQUJMRTtcbiAgICB0aGlzLmkyYy53cml0ZSh0aGlzLmFkZHJlc3MsIFt0aGlzLl9jb21tYW5kcy5NT0RFMSwgbW9kZTFdKTtcbiAgICB0aGlzLmkyYy53cml0ZSh0aGlzLmFkZHJlc3MsIFtcbiAgICAgIHRoaXMuX2NvbW1hbmRzLk1PREUxLFxuICAgICAgbW9kZTEgfCB0aGlzLl9jb21tYW5kcy5iaXRzLlJFU1RBUlQsXG4gICAgXSk7XG5cbiAgICB0aGlzLl9yZWdzW3RoaXMuX2NvbW1hbmRzLk1PREUxXSA9IG1vZGUxO1xuXG4gICAgb2JuaXoud2FpdCgxMCk7XG4gIH1cblxuICBfcHJlcGFyZVBXTShudW0pIHtcbiAgICBjbGFzcyBQQ0E5Njg1X1BXTSB7XG4gICAgICBjb25zdHJ1Y3RvcihjaGlwLCBpZCkge1xuICAgICAgICB0aGlzLmNoaXAgPSBjaGlwO1xuICAgICAgICB0aGlzLmlkID0gaWQ7XG4gICAgICAgIHRoaXMudmFsdWUgPSAwO1xuICAgICAgICB0aGlzLnN0YXRlID0ge307XG4gICAgICB9XG5cbiAgICAgIGZyZXEoZnJlcXVlbmN5KSB7XG4gICAgICAgIHRoaXMuY2hpcC5mcmVxKGZyZXF1ZW5jeSk7XG4gICAgICB9XG4gICAgICBwdWxzZSh2YWx1ZSkge1xuICAgICAgICB0aGlzLmNoaXAucHVsc2UodGhpcy5pZCwgdmFsdWUpO1xuICAgICAgfVxuICAgICAgZHV0eSh2YWx1ZSkge1xuICAgICAgICB0aGlzLmNoaXAuZHV0eSh0aGlzLmlkLCB2YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW07IGkrKykge1xuICAgICAgdGhpcy5wd21zLnB1c2gobmV3IFBDQTk2ODVfUFdNKHRoaXMsIGkpKTtcbiAgICB9XG4gIH1cblxuICBpc1ZhbGlkUFdNKGlkKSB7XG4gICAgcmV0dXJuIHR5cGVvZiBpZCA9PT0gJ251bWJlcicgJiYgaWQgPj0gMCAmJiBpZCA8IHRoaXMucHdtTnVtO1xuICB9XG5cbiAgZ2V0UFdNKGlkKSB7XG4gICAgaWYgKCF0aGlzLmlzVmFsaWRQV00oaWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3B3bSAnICsgaWQgKyAnIGlzIG5vdCB2YWxpZCBwd20nKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHdtc1tpZF07XG4gIH1cblxuICBmcmVxKGZyZXF1ZW5jeSkge1xuICAgIGlmICh0eXBlb2YgZnJlcXVlbmN5ICE9PSAnbnVtYmVyJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoZnJlcXVlbmN5IDwgMjQgfHwgMTUyNiA8IGZyZXF1ZW5jeSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdmcmVxIG11c3QgYmUgd2l0aGluIDI0LTE1MjYgaHonKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2ZyZXEgPT09IGZyZXF1ZW5jeSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgcHJlc2NhbGV2YWwgPSAyNTAwMDAwMC4wOyAvLyAyNU1IelxuICAgIHByZXNjYWxldmFsIC89IDQwOTYuMDsgLy8xMmJpdFxuICAgIHByZXNjYWxldmFsIC89IGZyZXF1ZW5jeSAqIDAuOTtcbiAgICBwcmVzY2FsZXZhbCAtPSAxLjA7XG5cbiAgICBjb25zdCBwcmVzY2FsZSA9IHBhcnNlSW50KE1hdGguZmxvb3IocHJlc2NhbGV2YWwgKyAwLjUpKTtcbiAgICBjb25zdCBtb2RlMSA9IHRoaXMuX3JlZ3NbdGhpcy5fY29tbWFuZHMuTU9ERTFdO1xuXG4gICAgdGhpcy5pMmMud3JpdGUodGhpcy5hZGRyZXNzLCBbXG4gICAgICB0aGlzLl9jb21tYW5kcy5NT0RFMSxcbiAgICAgIChtb2RlMSAmIDB4N2YpIHwgdGhpcy5fY29tbWFuZHMuYml0cy5TTEVFUF9FTkFCTEUsXG4gICAgXSk7IC8vIGVudGVyIHNsZWVwXG4gICAgdGhpcy5pMmMud3JpdGUodGhpcy5hZGRyZXNzLCBbdGhpcy5fY29tbWFuZHMuUFJFU0NBTEUsIHByZXNjYWxlXSk7XG4gICAgdGhpcy5pMmMud3JpdGUodGhpcy5hZGRyZXNzLCBbdGhpcy5fY29tbWFuZHMuTU9ERTEsIG1vZGUxXSk7IC8vIHJlY292ZXIgZnJvbSBzbGVlcFxuXG4gICAgdGhpcy5vYm5pei53YWl0KDUpO1xuXG4gICAgLy8gc2F2ZVxuICAgIHRoaXMuX2ZyZXEgPSBmcmVxdWVuY3k7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnB3bXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRoaXMucHdtc1tpXS5zdGF0ZS5mcmVxID0gdGhpcy5fZnJlcTtcbiAgICB9XG4gIH1cblxuICBwdWxzZShpZCwgcHVsc2Vfd2lkdGgpIHtcbiAgICBpZiAodHlwZW9mIHRoaXMuX2ZyZXEgIT09ICdudW1iZXInIHx8IHRoaXMuX2ZyZXEgPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdwbGVhc2UgcHJvdmlkZSBmcmVxIGZpcnN0LicpO1xuICAgIH1cbiAgICB0aGlzLmR1dHkoaWQsIChwdWxzZV93aWR0aCAvIDEwMDAuMCAvICgxLjAgLyB0aGlzLl9mcmVxKSkgKiAxMDApO1xuICB9XG5cbiAgZHV0eShpZCwgZHV0eSkge1xuICAgIGR1dHkgKj0gMS4wO1xuICAgIGlmICh0eXBlb2YgdGhpcy5fZnJlcSAhPT0gJ251bWJlcicgfHwgdGhpcy5fZnJlcSA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3BsZWFzZSBwcm92aWRlIGZyZXEgZmlyc3QuJyk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgZHV0eSAhPT0gJ251bWJlcicpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigncGxlYXNlIHByb3ZpZGUgZHV0eSBpbiBudW1iZXInKTtcbiAgICB9XG4gICAgaWYgKGR1dHkgPCAwKSB7XG4gICAgICBkdXR5ID0gMDtcbiAgICB9XG4gICAgaWYgKGR1dHkgPiAxMDApIHtcbiAgICAgIGR1dHkgPSAxMDA7XG4gICAgfVxuICAgIHRoaXMuZ2V0UFdNKGlkKS5zdGF0ZS5kdXR5ID0gZHV0eTtcbiAgICB0aGlzLndyaXRlU2luZ2xlT05PRkYoaWQsIDAsIChkdXR5IC8gMTAwLjApICogNDA5NSk7XG4gIH1cblxuICB3cml0ZVNpbmdsZU9OT0ZGKGlkLCBvbiwgb2ZmKSB7XG4gICAgdGhpcy5pMmMud3JpdGUodGhpcy5hZGRyZXNzLCBbXG4gICAgICB0aGlzLl9jb21tYW5kcy5MRUQwX09OX0wgKyA0ICogaWQsXG4gICAgICBvbiAmIDB4ZmYsXG4gICAgICBvbiA+PiA4LFxuICAgICAgb2ZmICYgMHhmZixcbiAgICAgIG9mZiA+PiA4LFxuICAgIF0pO1xuICB9XG5cbiAgc2V0RW5hYmxlKGVuYWJsZSkge1xuICAgIGlmICghdGhpcy5pb19vZSAmJiBlbmFibGUgPT0gZmFsc2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigncGluIFwib2VcIiBpcyBub3Qgc3BlY2lmaWVkJyk7XG4gICAgfVxuICAgIHRoaXMuaW9fb2Uub3V0cHV0KCFlbmFibGUpO1xuICB9XG59XG5cbmlmICh0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0Jykge1xuICBtb2R1bGUuZXhwb3J0cyA9IFBDQTk2ODU7XG59XG4iXX0=

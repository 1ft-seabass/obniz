"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
class hx711 {
    constructor() {
        this.keys = ['vcc', 'gnd', 'sck', 'dout'];
        this.requiredKeys = ['sck', 'dout'];
        this._offset = 0;
        this._scale = 1;
    }
    static info() {
        return {
            name: 'hx711',
        };
    }
    wired(obniz) {
        this.obniz = obniz;
        this.spi = obniz.getFreeSpi();
        obniz.setVccGnd(this.params.vcc, this.params.gnd, '5v');
        let ioKeys = ['clk', 'dout'];
        for (let key of ioKeys) {
            if (this.params[key] && !this.obniz.isValidIO(this.params[key])) {
                throw new Error("spi start param '" + key + "' are to be valid io no");
            }
        }
        this.sck = obniz.getIO(this.params.sck);
        this.dout = obniz.getIO(this.params.dout);
        this.sck.output(true);
        obniz.wait(500);
    }
    readWait() {
        return __awaiter(this, void 0, void 0, function* () {
            this.sck.output(false);
            while (true) {
                let val = yield this.dout.inputWait();
                if (val == false)
                    break;
            }
            this.spi.start({
                mode: 'master',
                mosi: this.params.sck,
                miso: this.params.dout,
                frequency: 500 * 1000,
            });
            let ret_double = yield this.spi.writeWait([
                0xaa,
                0xaa,
                0xaa,
                0xaa,
                0xaa,
                0xaa,
                0x80,
            ]);
            this.spi.end(true);
            this.sck.output(false);
            let ret = [
                this.doubleBit2singleBit(ret_double[0], ret_double[1]),
                this.doubleBit2singleBit(ret_double[2], ret_double[3]),
                this.doubleBit2singleBit(ret_double[4], ret_double[5]),
            ];
            let flag = (ret[0] & 0x80) === 0 ? 1 : -1;
            return flag * (((ret[0] & 0x7f) << 16) + (ret[1] << 8) + (ret[2] << 0));
        });
    }
    doubleBit2singleBit(a, b) {
        return ((this.bit(a, 7) << 7) |
            (this.bit(a, 5) << 6) |
            (this.bit(a, 3) << 5) |
            (this.bit(a, 1) << 4) |
            (this.bit(b, 7) << 3) |
            (this.bit(b, 5) << 2) |
            (this.bit(b, 3) << 1) |
            (this.bit(b, 1) << 0));
    }
    bit(a, n) {
        return a & (1 << n) ? 1 : 0;
    }
    readAverageWait(times) {
        return __awaiter(this, void 0, void 0, function* () {
            let results = [];
            for (let i = 0; i < times; i++) {
                results.push(yield this.readWait());
            }
            return (results.reduce((prev, current, i) => {
                return prev + current;
            }, 0) / results.length);
        });
    }
    powerDown() {
        this.sck.output(true);
    }
    powerUp() {
        this.sck.output(false);
    }
    zeroAdjustWait(times) {
        return __awaiter(this, void 0, void 0, function* () {
            times = parseInt(times) || 1;
            this._offset = yield this.readAverageWait(times);
        });
    }
    getValueWait(times) {
        return __awaiter(this, void 0, void 0, function* () {
            times = parseInt(times) || 1;
            let val = yield this.readAverageWait(times);
            return (val - this._offset) / this._scale;
        });
    }
    setOffset(offset) {
        if (typeof offset !== 'number') {
            throw new Error('offset variable is Number');
        }
        this._offset = offset;
    }
    setScale(scale) {
        if (typeof scale !== 'number') {
            throw new Error('scale variable is Number');
        }
        this._scale = scale;
    }
}
if (typeof module === 'object') {
    module.exports = hx711;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXJ0cy9BRENvbnZlcnRlci9oeDcxMS9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsTUFBTSxLQUFLO0lBQ1Q7UUFDRSxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDMUMsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQUk7UUFDVCxPQUFPO1lBQ0wsSUFBSSxFQUFFLE9BQU87U0FDZCxDQUFDO0lBQ0osQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLO1FBQ1QsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDOUIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUV4RCxJQUFJLE1BQU0sR0FBRyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM3QixLQUFLLElBQUksR0FBRyxJQUFJLE1BQU0sRUFBRTtZQUN0QixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7Z0JBQy9ELE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLEdBQUcsR0FBRyxHQUFHLHlCQUF5QixDQUFDLENBQUM7YUFDeEU7U0FDRjtRQUNELElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUVLLFFBQVE7O1lBQ1osSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFdkIsT0FBTyxJQUFJLEVBQUU7Z0JBQ1gsSUFBSSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUN0QyxJQUFJLEdBQUcsSUFBSSxLQUFLO29CQUFFLE1BQU07YUFDekI7WUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQztnQkFDYixJQUFJLEVBQUUsUUFBUTtnQkFDZCxJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHO2dCQUNyQixJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJO2dCQUN0QixTQUFTLEVBQUUsR0FBRyxHQUFHLElBQUk7YUFDdEIsQ0FBQyxDQUFDO1lBRUgsSUFBSSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQztnQkFDeEMsSUFBSTtnQkFDSixJQUFJO2dCQUNKLElBQUk7Z0JBQ0osSUFBSTtnQkFDSixJQUFJO2dCQUNKLElBQUk7Z0JBQ0osSUFBSTthQUNMLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25CLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZCLElBQUksR0FBRyxHQUFHO2dCQUNSLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN0RCxJQUFJLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEQsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDdkQsQ0FBQztZQUNGLElBQUksSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQyxPQUFPLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxRSxDQUFDO0tBQUE7SUFFRCxtQkFBbUIsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUN0QixPQUFPLENBQ0wsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FDdEIsQ0FBQztJQUNKLENBQUM7SUFFRCxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDTixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVLLGVBQWUsQ0FBQyxLQUFLOztZQUN6QixJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7WUFDakIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDOUIsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO2FBQ3JDO1lBQ0QsT0FBTyxDQUNMLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUNsQyxPQUFPLElBQUksR0FBRyxPQUFPLENBQUM7WUFDeEIsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQ3ZCLENBQUM7UUFDSixDQUFDO0tBQUE7SUFFRCxTQUFTO1FBQ1AsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVELE9BQU87UUFDTCxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRUssY0FBYyxDQUFDLEtBQUs7O1lBQ3hCLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdCLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25ELENBQUM7S0FBQTtJQUVLLFlBQVksQ0FBQyxLQUFLOztZQUN0QixLQUFLLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM3QixJQUFJLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDNUMsT0FBTyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUM1QyxDQUFDO0tBQUE7SUFFRCxTQUFTLENBQUMsTUFBTTtRQUNkLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFO1lBQzlCLE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztTQUM5QztRQUNELElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxRQUFRLENBQUMsS0FBSztRQUNaLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFO1lBQzdCLE1BQU0sSUFBSSxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztTQUM3QztRQUNELElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO0lBQ3RCLENBQUM7Q0FDRjtBQUVELElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFO0lBQzlCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0NBQ3hCIiwiZmlsZSI6InBhcnRzL0FEQ29udmVydGVyL2h4NzExL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY2xhc3MgaHg3MTEge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmtleXMgPSBbJ3ZjYycsICdnbmQnLCAnc2NrJywgJ2RvdXQnXTtcbiAgICB0aGlzLnJlcXVpcmVkS2V5cyA9IFsnc2NrJywgJ2RvdXQnXTtcbiAgICB0aGlzLl9vZmZzZXQgPSAwO1xuICAgIHRoaXMuX3NjYWxlID0gMTtcbiAgfVxuXG4gIHN0YXRpYyBpbmZvKCkge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiAnaHg3MTEnLFxuICAgIH07XG4gIH1cblxuICB3aXJlZChvYm5peikge1xuICAgIHRoaXMub2JuaXogPSBvYm5pejtcbiAgICB0aGlzLnNwaSA9IG9ibml6LmdldEZyZWVTcGkoKTtcbiAgICBvYm5pei5zZXRWY2NHbmQodGhpcy5wYXJhbXMudmNjLCB0aGlzLnBhcmFtcy5nbmQsICc1dicpO1xuXG4gICAgbGV0IGlvS2V5cyA9IFsnY2xrJywgJ2RvdXQnXTtcbiAgICBmb3IgKGxldCBrZXkgb2YgaW9LZXlzKSB7XG4gICAgICBpZiAodGhpcy5wYXJhbXNba2V5XSAmJiAhdGhpcy5vYm5pei5pc1ZhbGlkSU8odGhpcy5wYXJhbXNba2V5XSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwic3BpIHN0YXJ0IHBhcmFtICdcIiArIGtleSArIFwiJyBhcmUgdG8gYmUgdmFsaWQgaW8gbm9cIik7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuc2NrID0gb2JuaXouZ2V0SU8odGhpcy5wYXJhbXMuc2NrKTtcbiAgICB0aGlzLmRvdXQgPSBvYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5kb3V0KTtcblxuICAgIHRoaXMuc2NrLm91dHB1dCh0cnVlKTtcbiAgICBvYm5pei53YWl0KDUwMCk7XG4gIH1cblxuICBhc3luYyByZWFkV2FpdCgpIHtcbiAgICB0aGlzLnNjay5vdXRwdXQoZmFsc2UpO1xuXG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIGxldCB2YWwgPSBhd2FpdCB0aGlzLmRvdXQuaW5wdXRXYWl0KCk7XG4gICAgICBpZiAodmFsID09IGZhbHNlKSBicmVhaztcbiAgICB9XG4gICAgdGhpcy5zcGkuc3RhcnQoe1xuICAgICAgbW9kZTogJ21hc3RlcicsXG4gICAgICBtb3NpOiB0aGlzLnBhcmFtcy5zY2ssXG4gICAgICBtaXNvOiB0aGlzLnBhcmFtcy5kb3V0LFxuICAgICAgZnJlcXVlbmN5OiA1MDAgKiAxMDAwLFxuICAgIH0pO1xuXG4gICAgbGV0IHJldF9kb3VibGUgPSBhd2FpdCB0aGlzLnNwaS53cml0ZVdhaXQoW1xuICAgICAgMHhhYSxcbiAgICAgIDB4YWEsXG4gICAgICAweGFhLFxuICAgICAgMHhhYSxcbiAgICAgIDB4YWEsXG4gICAgICAweGFhLFxuICAgICAgMHg4MCxcbiAgICBdKTtcbiAgICB0aGlzLnNwaS5lbmQodHJ1ZSk7XG4gICAgdGhpcy5zY2sub3V0cHV0KGZhbHNlKTtcbiAgICBsZXQgcmV0ID0gW1xuICAgICAgdGhpcy5kb3VibGVCaXQyc2luZ2xlQml0KHJldF9kb3VibGVbMF0sIHJldF9kb3VibGVbMV0pLFxuICAgICAgdGhpcy5kb3VibGVCaXQyc2luZ2xlQml0KHJldF9kb3VibGVbMl0sIHJldF9kb3VibGVbM10pLFxuICAgICAgdGhpcy5kb3VibGVCaXQyc2luZ2xlQml0KHJldF9kb3VibGVbNF0sIHJldF9kb3VibGVbNV0pLFxuICAgIF07XG4gICAgbGV0IGZsYWcgPSAocmV0WzBdICYgMHg4MCkgPT09IDAgPyAxIDogLTE7XG4gICAgcmV0dXJuIGZsYWcgKiAoKChyZXRbMF0gJiAweDdmKSA8PCAxNikgKyAocmV0WzFdIDw8IDgpICsgKHJldFsyXSA8PCAwKSk7XG4gIH1cblxuICBkb3VibGVCaXQyc2luZ2xlQml0KGEsIGIpIHtcbiAgICByZXR1cm4gKFxuICAgICAgKHRoaXMuYml0KGEsIDcpIDw8IDcpIHxcbiAgICAgICh0aGlzLmJpdChhLCA1KSA8PCA2KSB8XG4gICAgICAodGhpcy5iaXQoYSwgMykgPDwgNSkgfFxuICAgICAgKHRoaXMuYml0KGEsIDEpIDw8IDQpIHxcbiAgICAgICh0aGlzLmJpdChiLCA3KSA8PCAzKSB8XG4gICAgICAodGhpcy5iaXQoYiwgNSkgPDwgMikgfFxuICAgICAgKHRoaXMuYml0KGIsIDMpIDw8IDEpIHxcbiAgICAgICh0aGlzLmJpdChiLCAxKSA8PCAwKVxuICAgICk7XG4gIH1cblxuICBiaXQoYSwgbikge1xuICAgIHJldHVybiBhICYgKDEgPDwgbikgPyAxIDogMDtcbiAgfVxuXG4gIGFzeW5jIHJlYWRBdmVyYWdlV2FpdCh0aW1lcykge1xuICAgIGxldCByZXN1bHRzID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aW1lczsgaSsrKSB7XG4gICAgICByZXN1bHRzLnB1c2goYXdhaXQgdGhpcy5yZWFkV2FpdCgpKTtcbiAgICB9XG4gICAgcmV0dXJuIChcbiAgICAgIHJlc3VsdHMucmVkdWNlKChwcmV2LCBjdXJyZW50LCBpKSA9PiB7XG4gICAgICAgIHJldHVybiBwcmV2ICsgY3VycmVudDtcbiAgICAgIH0sIDApIC8gcmVzdWx0cy5sZW5ndGhcbiAgICApO1xuICB9XG5cbiAgcG93ZXJEb3duKCkge1xuICAgIHRoaXMuc2NrLm91dHB1dCh0cnVlKTtcbiAgfVxuXG4gIHBvd2VyVXAoKSB7XG4gICAgdGhpcy5zY2sub3V0cHV0KGZhbHNlKTtcbiAgfVxuXG4gIGFzeW5jIHplcm9BZGp1c3RXYWl0KHRpbWVzKSB7XG4gICAgdGltZXMgPSBwYXJzZUludCh0aW1lcykgfHwgMTtcbiAgICB0aGlzLl9vZmZzZXQgPSBhd2FpdCB0aGlzLnJlYWRBdmVyYWdlV2FpdCh0aW1lcyk7XG4gIH1cblxuICBhc3luYyBnZXRWYWx1ZVdhaXQodGltZXMpIHtcbiAgICB0aW1lcyA9IHBhcnNlSW50KHRpbWVzKSB8fCAxO1xuICAgIGxldCB2YWwgPSBhd2FpdCB0aGlzLnJlYWRBdmVyYWdlV2FpdCh0aW1lcyk7XG4gICAgcmV0dXJuICh2YWwgLSB0aGlzLl9vZmZzZXQpIC8gdGhpcy5fc2NhbGU7XG4gIH1cblxuICBzZXRPZmZzZXQob2Zmc2V0KSB7XG4gICAgaWYgKHR5cGVvZiBvZmZzZXQgIT09ICdudW1iZXInKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ29mZnNldCB2YXJpYWJsZSBpcyBOdW1iZXInKTtcbiAgICB9XG4gICAgdGhpcy5fb2Zmc2V0ID0gb2Zmc2V0O1xuICB9XG5cbiAgc2V0U2NhbGUoc2NhbGUpIHtcbiAgICBpZiAodHlwZW9mIHNjYWxlICE9PSAnbnVtYmVyJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdzY2FsZSB2YXJpYWJsZSBpcyBOdW1iZXInKTtcbiAgICB9XG4gICAgdGhpcy5fc2NhbGUgPSBzY2FsZTtcbiAgfVxufVxuXG5pZiAodHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcpIHtcbiAgbW9kdWxlLmV4cG9ydHMgPSBoeDcxMTtcbn1cbiJdfQ==

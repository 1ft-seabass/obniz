"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
class BME280 {
    constructor() {
        this.requiredKeys = [];
        this.keys = [
            'vcore',
            'vio',
            'gnd',
            'csb',
            'sdi',
            'sck',
            'sdo',
            'i2c',
            'address',
        ];
        this.ioKeys = ['vcore', 'vio', 'gnd', 'csb', 'sdi', 'sdo', 'sck'];
        this.configration = {
            sampling: {
                temp: 1,
                hum: 1,
                pres: 1,
            },
            interval: 5,
            iir_strength: 0,
            mode: 3,
            Modes: {
                sleep: 0,
                forced: 1,
                normal: 3,
            },
        };
        this.commands = {};
        this.commands.addresses = {
            config: 0xf5,
            ctrl_meas: 0xf4,
            ctrl_hum: 0xf2,
        };
    }
    static info() {
        return {
            name: 'BME280',
            datasheet: 'https://ae-bst.resource.bosch.com/media/_tech/media/datasheets/BST-BME280_DS001-12.pdf',
        };
    }
    wired(obniz) {
        this.obniz = obniz;
        if (obniz.isValidIO(this.params.csb)) {
            // selecting I2C mode before powerup
            this.io_csb = obniz.getIO(this.params.csb);
            this.io_csb.drive('3v');
            this.io_csb.output(true);
        }
        this.obniz.setVccGnd(this.params.vio, null, '3v');
        this.obniz.setVccGnd(this.params.vcore, null, '3v');
        this.obniz.setVccGnd(null, this.params.gnd, '5v');
        this.obniz.wait(10);
        this.address = 0x76;
        if (this.params.address === 0x76) {
            this.address = 0x76;
        }
        else if (this.params.address === 0x77) {
            this.address = 0x77;
        }
        else if (this.params.address !== undefined) {
            throw new Error('address must be 0x76 or 0x77');
        }
        if (obniz.isValidIO(this.params.sdo)) {
            this.io_sdo = obniz.getIO(this.params.sdo);
            this.io_sdo.drive('3v');
            this.io_sdo.output(this.address === 0x76 ? false : true);
        }
        this.params.sda = this.params.sda || this.params.sdi;
        this.params.scl = this.params.scl || this.params.sck;
        this.params.clock = this.params.clock || 100 * 1000;
        this.params.mode = 'master';
        this.params.pull = '3v';
        this.i2c = obniz.getI2CWithConfig(this.params);
        this.obniz.wait(10);
        this.config();
        this.obniz.wait(10);
    }
    config() {
        return __awaiter(this, void 0, void 0, function* () {
            this.write([
                this.commands.addresses.config,
                (this.configration.interval << 5) |
                    (this.configration.iir_strength << 2) |
                    0,
            ]);
            this.write([
                this.commands.addresses.ctrl_hum,
                this.configration.sampling.hum,
            ]);
            this.write([
                this.commands.addresses.ctrl_meas,
                (this.configration.sampling.temp << 5) |
                    (this.configration.sampling.pres << 2) |
                    this.configration.mode,
            ]);
        });
    }
    setIIRStrength(strengh) {
        return __awaiter(this, void 0, void 0, function* () {
            this.configration.iir_strength = strengh;
            this.config();
        });
    }
    applyCalibration() {
        return __awaiter(this, void 0, void 0, function* () {
            this.i2c.write(this.address, [0x88]);
            let data = yield this.i2c.readWait(this.address, 24);
            this.i2c.write(this.address, [0xa1]);
            let data_next = yield this.i2c.readWait(this.address, 1);
            data.push(...data_next);
            this.i2c.write(this.address, [0xe1]);
            data_next = yield this.i2c.readWait(this.address, 7);
            data.push(...data_next);
            this._calibrated = {
                dig_T1: (data[1] << 8) | data[0],
                dig_T2: this._readSigned16((data[3] << 8) | data[2]),
                dig_T3: this._readSigned16((data[5] << 8) | data[4]),
                dig_P1: (data[7] << 8) | data[6],
                dig_P2: this._readSigned16((data[9] << 8) | data[8]),
                dig_P3: this._readSigned16((data[11] << 8) | data[10]),
                dig_P4: this._readSigned16((data[13] << 8) | data[12]),
                dig_P5: this._readSigned16((data[15] << 8) | data[14]),
                dig_P6: this._readSigned16((data[17] << 8) | data[16]),
                dig_P7: this._readSigned16((data[19] << 8) | data[18]),
                dig_P8: this._readSigned16((data[21] << 8) | data[20]),
                dig_P9: this._readSigned16((data[23] << 8) | data[22]),
                dig_H1: this._readSigned8(data[24]),
                dig_H2: this._readSigned16((data[26] << 8) | data[25]),
                dig_H3: this._readSigned8(data[27]),
                dig_H4: this._readSigned16((data[28] << 4) | (0x0f & data[29])),
                dig_H5: this._readSigned16((data[30] << 4) | ((data[29] >> 4) & 0x0f)),
                dig_H6: this._readSigned8(data[31]),
            };
            this._t_fine = 0;
        });
    }
    _readSigned16(value) {
        if (value >= 0x8000) {
            value = value - 0x10000;
        }
        return value;
    }
    _readSigned8(value) {
        if (value >= 0x80) {
            value = value - 0x100;
        }
        return value;
    }
    write(data) {
        this.obniz.i2c0.write(this.address, data);
    }
    getData() {
        return __awaiter(this, void 0, void 0, function* () {
            this.i2c.write(this.address, [0xf7]);
            return yield this.i2c.readWait(this.address, 8);
        });
    }
    getAllWait() {
        return __awaiter(this, void 0, void 0, function* () {
            let data = yield this.getData();
            const press_raw = (data[0] << 12) | (data[1] << 4) | (data[2] >> 4);
            const temp_raw = (data[3] << 12) | (data[4] << 4) | (data[5] >> 4);
            const hum_raw = (data[6] << 8) | data[7];
            let temperature = this.calibration_T(temp_raw) / 100.0;
            let pressure = this.calibration_P(press_raw) / 100.0;
            let humidity = this.calibration_H(hum_raw);
            return { temperature, humidity, pressure };
        });
    }
    calibration_T(adc_T) {
        let var1, var2, T;
        var1 =
            (((adc_T >> 3) - (this._calibrated.dig_T1 << 1)) *
                this._calibrated.dig_T2) >>
                11;
        var2 =
            (((((adc_T >> 4) - this._calibrated.dig_T1) *
                ((adc_T >> 4) - this._calibrated.dig_T1)) >>
                12) *
                this._calibrated.dig_T3) >>
                14;
        this._t_fine = var1 + var2;
        T = (this._t_fine * 5 + 128) >> 8;
        return T;
    }
    calibration_P(adc_P) {
        let pvar1 = this._t_fine / 2 - 64000;
        let pvar2 = (pvar1 * pvar1 * this._calibrated.dig_P6) / 32768;
        pvar2 = pvar2 + pvar1 * this._calibrated.dig_P5 * 2;
        pvar2 = pvar2 / 4 + this._calibrated.dig_P4 * 65536;
        pvar1 =
            ((this._calibrated.dig_P3 * pvar1 * pvar1) / 524288 +
                this._calibrated.dig_P2 * pvar1) /
                524288;
        pvar1 = (1 + pvar1 / 32768) * this._calibrated.dig_P1;
        if (pvar1 !== 0) {
            let p = 1048576 - adc_P;
            p = ((p - pvar2 / 4096) * 6250) / pvar1;
            pvar1 = (this._calibrated.dig_P9 * p * p) / 2147483648;
            pvar2 = (p * this._calibrated.dig_P8) / 32768;
            p = p + (pvar1 + pvar2 + this._calibrated.dig_P7) / 16;
            return p;
        }
        return 0;
    }
    calibration_H(adc_H) {
        let h = this._t_fine - 76800;
        h =
            (adc_H -
                (this._calibrated.dig_H4 * 64 +
                    (this._calibrated.dig_H5 / 16384) * h)) *
                ((this._calibrated.dig_H2 / 65536) *
                    (1 +
                        (this._calibrated.dig_H6 / 67108864) *
                            h *
                            (1 + (this._calibrated.dig_H3 / 67108864) * h)));
        h = h * (1 - (this._calibrated.dig_H1 * h) / 524288);
        return h;
    }
    getTempWait() {
        return __awaiter(this, void 0, void 0, function* () {
            return (yield this.getAllWait()).temperature;
        });
    }
    getHumdWait() {
        return __awaiter(this, void 0, void 0, function* () {
            return (yield this.getAllWait()).humidity;
        });
    }
    getPressureWait() {
        return __awaiter(this, void 0, void 0, function* () {
            return (yield this.getAllWait()).pressure;
        });
    }
    getAltitudeWait() {
        return __awaiter(this, void 0, void 0, function* () {
            const pressure = yield this.getPressureWait();
            return this.calcAltitude(pressure);
        });
    }
    calcAltitude(pressure, seaLevel = 1013.25) {
        return ((1.0 - Math.pow(pressure / seaLevel, 1 / 5.2553)) * 145366.45 * 0.3048);
    }
}
if (typeof module === 'object') {
    module.exports = BME280;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXJ0cy9UZW1wZXJhdHVyZVNlbnNvci9pMmMvQk1FMjgwL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSxNQUFNLE1BQU07SUFDVjtRQUNFLElBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLEdBQUc7WUFDVixPQUFPO1lBQ1AsS0FBSztZQUNMLEtBQUs7WUFDTCxLQUFLO1lBQ0wsS0FBSztZQUNMLEtBQUs7WUFDTCxLQUFLO1lBQ0wsS0FBSztZQUNMLFNBQVM7U0FDVixDQUFDO1FBRUYsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRWxFLElBQUksQ0FBQyxZQUFZLEdBQUc7WUFDbEIsUUFBUSxFQUFFO2dCQUNSLElBQUksRUFBRSxDQUFDO2dCQUNQLEdBQUcsRUFBRSxDQUFDO2dCQUNOLElBQUksRUFBRSxDQUFDO2FBQ1I7WUFDRCxRQUFRLEVBQUUsQ0FBQztZQUNYLFlBQVksRUFBRSxDQUFDO1lBQ2YsSUFBSSxFQUFFLENBQUM7WUFFUCxLQUFLLEVBQUU7Z0JBQ0wsS0FBSyxFQUFFLENBQUM7Z0JBQ1IsTUFBTSxFQUFFLENBQUM7Z0JBQ1QsTUFBTSxFQUFFLENBQUM7YUFDVjtTQUNGLENBQUM7UUFFRixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUVuQixJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsR0FBRztZQUN4QixNQUFNLEVBQUUsSUFBSTtZQUNaLFNBQVMsRUFBRSxJQUFJO1lBQ2YsUUFBUSxFQUFFLElBQUk7U0FDZixDQUFDO0lBQ0osQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFJO1FBQ1QsT0FBTztZQUNMLElBQUksRUFBRSxRQUFRO1lBQ2QsU0FBUyxFQUNQLHdGQUF3RjtTQUMzRixDQUFDO0lBQ0osQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLO1FBQ1QsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFFbkIsSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDcEMsb0NBQW9DO1lBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzFCO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFcEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sS0FBSyxJQUFJLEVBQUU7WUFDaEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7U0FDckI7YUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxLQUFLLElBQUksRUFBRTtZQUN2QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztTQUNyQjthQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEtBQUssU0FBUyxFQUFFO1lBQzVDLE1BQU0sSUFBSSxLQUFLLENBQUMsOEJBQThCLENBQUMsQ0FBQztTQUNqRDtRQUVELElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzFEO1FBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFDckQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFDckQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQztRQUNwRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUvQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVwQixJQUFJLENBQUMsTUFBTSxF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LEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BELE1BQU0sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN0RCxNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3RELE1BQU0sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN0RCxNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3RELE1BQU0sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FB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T0FBTyxDQUNMLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLFFBQVEsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsR0FBRyxTQUFTLEdBQUcsTUFBTSxDQUN2RSxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBRUQsSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7SUFDOUIsTUFBTSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7Q0FDekIiLCJmaWxlIjoicGFydHMvVGVtcGVyYXR1cmVTZW5zb3IvaTJjL0JNRTI4MC9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIEJNRTI4MCB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMucmVxdWlyZWRLZXlzID0gW107XG4gICAgdGhpcy5rZXlzID0gW1xuICAgICAgJ3Zjb3JlJyxcbiAgICAgICd2aW8nLFxuICAgICAgJ2duZCcsXG4gICAgICAnY3NiJyxcbiAgICAgICdzZGknLFxuICAgICAgJ3NjaycsXG4gICAgICAnc2RvJyxcbiAgICAgICdpMmMnLFxuICAgICAgJ2FkZHJlc3MnLFxuICAgIF07XG5cbiAgICB0aGlzLmlvS2V5cyA9IFsndmNvcmUnLCAndmlvJywgJ2duZCcsICdjc2InLCAnc2RpJywgJ3NkbycsICdzY2snXTtcblxuICAgIHRoaXMuY29uZmlncmF0aW9uID0ge1xuICAgICAgc2FtcGxpbmc6IHtcbiAgICAgICAgdGVtcDogMSwgLy8gMCBuZXZlci4gMGIwMDEgdG8gMGIxMDFcbiAgICAgICAgaHVtOiAxLFxuICAgICAgICBwcmVzOiAxLFxuICAgICAgfSxcbiAgICAgIGludGVydmFsOiA1LCAvLyAwYjAwMCB0byAwYjExMVxuICAgICAgaWlyX3N0cmVuZ3RoOiAwLCAvLyAwMDAgdG8gMTAwICgwPWRpc2FibGUpXG4gICAgICBtb2RlOiAzLFxuXG4gICAgICBNb2Rlczoge1xuICAgICAgICBzbGVlcDogMCxcbiAgICAgICAgZm9yY2VkOiAxLCAvLyBvciAyXG4gICAgICAgIG5vcm1hbDogMyxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHRoaXMuY29tbWFuZHMgPSB7fTtcblxuICAgIHRoaXMuY29tbWFuZHMuYWRkcmVzc2VzID0ge1xuICAgICAgY29uZmlnOiAweGY1LFxuICAgICAgY3RybF9tZWFzOiAweGY0LFxuICAgICAgY3RybF9odW06IDB4ZjIsXG4gICAgfTtcbiAgfVxuXG4gIHN0YXRpYyBpbmZvKCkge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiAnQk1FMjgwJyxcbiAgICAgIGRhdGFzaGVldDpcbiAgICAgICAgJ2h0dHBzOi8vYWUtYnN0LnJlc291cmNlLmJvc2NoLmNvbS9tZWRpYS9fdGVjaC9tZWRpYS9kYXRhc2hlZXRzL0JTVC1CTUUyODBfRFMwMDEtMTIucGRmJyxcbiAgICB9O1xuICB9XG5cbiAgd2lyZWQob2JuaXopIHtcbiAgICB0aGlzLm9ibml6ID0gb2JuaXo7XG5cbiAgICBpZiAob2JuaXouaXNWYWxpZElPKHRoaXMucGFyYW1zLmNzYikpIHtcbiAgICAgIC8vIHNlbGVjdGluZyBJMkMgbW9kZSBiZWZvcmUgcG93ZXJ1cFxuICAgICAgdGhpcy5pb19jc2IgPSBvYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5jc2IpO1xuICAgICAgdGhpcy5pb19jc2IuZHJpdmUoJzN2Jyk7XG4gICAgICB0aGlzLmlvX2NzYi5vdXRwdXQodHJ1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy5vYm5pei5zZXRWY2NHbmQodGhpcy5wYXJhbXMudmlvLCBudWxsLCAnM3YnKTtcbiAgICB0aGlzLm9ibml6LnNldFZjY0duZCh0aGlzLnBhcmFtcy52Y29yZSwgbnVsbCwgJzN2Jyk7XG4gICAgdGhpcy5vYm5pei5zZXRWY2NHbmQobnVsbCwgdGhpcy5wYXJhbXMuZ25kLCAnNXYnKTtcbiAgICB0aGlzLm9ibml6LndhaXQoMTApO1xuXG4gICAgdGhpcy5hZGRyZXNzID0gMHg3NjtcbiAgICBpZiAodGhpcy5wYXJhbXMuYWRkcmVzcyA9PT0gMHg3Nikge1xuICAgICAgdGhpcy5hZGRyZXNzID0gMHg3NjtcbiAgICB9IGVsc2UgaWYgKHRoaXMucGFyYW1zLmFkZHJlc3MgPT09IDB4NzcpIHtcbiAgICAgIHRoaXMuYWRkcmVzcyA9IDB4Nzc7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBhcmFtcy5hZGRyZXNzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignYWRkcmVzcyBtdXN0IGJlIDB4NzYgb3IgMHg3NycpO1xuICAgIH1cblxuICAgIGlmIChvYm5pei5pc1ZhbGlkSU8odGhpcy5wYXJhbXMuc2RvKSkge1xuICAgICAgdGhpcy5pb19zZG8gPSBvYm5pei5nZXRJTyh0aGlzLnBhcmFtcy5zZG8pO1xuICAgICAgdGhpcy5pb19zZG8uZHJpdmUoJzN2Jyk7XG4gICAgICB0aGlzLmlvX3Nkby5vdXRwdXQodGhpcy5hZGRyZXNzID09PSAweDc2ID8gZmFsc2UgOiB0cnVlKTtcbiAgICB9XG5cbiAgICB0aGlzLnBhcmFtcy5zZGEgPSB0aGlzLnBhcmFtcy5zZGEgfHwgdGhpcy5wYXJhbXMuc2RpO1xuICAgIHRoaXMucGFyYW1zLnNjbCA9IHRoaXMucGFyYW1zLnNjbCB8fCB0aGlzLnBhcmFtcy5zY2s7XG4gICAgdGhpcy5wYXJhbXMuY2xvY2sgPSB0aGlzLnBhcmFtcy5jbG9jayB8fCAxMDAgKiAxMDAwO1xuICAgIHRoaXMucGFyYW1zLm1vZGUgPSAnbWFzdGVyJztcbiAgICB0aGlzLnBhcmFtcy5wdWxsID0gJzN2JztcbiAgICB0aGlzLmkyYyA9IG9ibml6LmdldEkyQ1dpdGhDb25maWcodGhpcy5wYXJhbXMpO1xuXG4gICAgdGhpcy5vYm5pei53YWl0KDEwKTtcblxuICAgIHRoaXMuY29uZmlnKCk7XG5cbiAgICB0aGlzLm9ibml6LndhaXQoMTApO1xuICB9XG5cbiAgYXN5bmMgY29uZmlnKCkge1xuICAgIHRoaXMud3JpdGUoW1xuICAgICAgdGhpcy5jb21tYW5kcy5hZGRyZXNzZXMuY29uZmlnLFxuICAgICAgKHRoaXMuY29uZmlncmF0aW9uLmludGVydmFsIDw8IDUpIHxcbiAgICAgICAgKHRoaXMuY29uZmlncmF0aW9uLmlpcl9zdHJlbmd0aCA8PCAyKSB8XG4gICAgICAgIDAsXG4gICAgXSk7XG4gICAgdGhpcy53cml0ZShbXG4gICAgICB0aGlzLmNvbW1hbmRzLmFkZHJlc3Nlcy5jdHJsX2h1bSxcbiAgICAgIHRoaXMuY29uZmlncmF0aW9uLnNhbXBsaW5nLmh1bSxcbiAgICBdKTtcbiAgICB0aGlzLndyaXRlKFtcbiAgICAgIHRoaXMuY29tbWFuZHMuYWRkcmVzc2VzLmN0cmxfbWVhcyxcbiAgICAgICh0aGlzLmNvbmZpZ3JhdGlvbi5zYW1wbGluZy50ZW1wIDw8IDUpIHxcbiAgICAgICAgKHRoaXMuY29uZmlncmF0aW9uLnNhbXBsaW5nLnByZXMgPDwgMikgfFxuICAgICAgICB0aGlzLmNvbmZpZ3JhdGlvbi5tb2RlLFxuICAgIF0pO1xuICB9XG5cbiAgYXN5bmMgc2V0SUlSU3RyZW5ndGgoc3RyZW5naCkge1xuICAgIHRoaXMuY29uZmlncmF0aW9uLmlpcl9zdHJlbmd0aCA9IHN0cmVuZ2g7XG4gICAgdGhpcy5jb25maWcoKTtcbiAgfVxuXG4gIGFzeW5jIGFwcGx5Q2FsaWJyYXRpb24oKSB7XG4gICAgdGhpcy5pMmMud3JpdGUodGhpcy5hZGRyZXNzLCBbMHg4OF0pO1xuICAgIGxldCBkYXRhID0gYXdhaXQgdGhpcy5pMmMucmVhZFdhaXQodGhpcy5hZGRyZXNzLCAyNCk7XG4gICAgdGhpcy5pMmMud3JpdGUodGhpcy5hZGRyZXNzLCBbMHhhMV0pO1xuICAgIGxldCBkYXRhX25leHQgPSBhd2FpdCB0aGlzLmkyYy5yZWFkV2FpdCh0aGlzLmFkZHJlc3MsIDEpO1xuICAgIGRhdGEucHVzaCguLi5kYXRhX25leHQpO1xuICAgIHRoaXMuaTJjLndyaXRlKHRoaXMuYWRkcmVzcywgWzB4ZTFdKTtcbiAgICBkYXRhX25leHQgPSBhd2FpdCB0aGlzLmkyYy5yZWFkV2FpdCh0aGlzLmFkZHJlc3MsIDcpO1xuICAgIGRhdGEucHVzaCguLi5kYXRhX25leHQpO1xuICAgIHRoaXMuX2NhbGlicmF0ZWQgPSB7XG4gICAgICBkaWdfVDE6IChkYXRhWzFdIDw8IDgpIHwgZGF0YVswXSxcbiAgICAgIGRpZ19UMjogdGhpcy5fcmVhZFNpZ25lZDE2KChkYXRhWzNdIDw8IDgpIHwgZGF0YVsyXSksXG4gICAgICBkaWdfVDM6IHRoaXMuX3JlYWRTaWduZWQxNigoZGF0YVs1XSA8PCA4KSB8IGRhdGFbNF0pLFxuICAgICAgZGlnX1AxOiAoZGF0YVs3XSA8PCA4KSB8IGRhdGFbNl0sXG4gICAgICBkaWdfUDI6IHRoaXMuX3JlYWRTaWduZWQxNigoZGF0YVs5XSA8PCA4KSB8IGRhdGFbOF0pLFxuICAgICAgZGlnX1AzOiB0aGlzLl9yZWFkU2lnbmVkMTYoKGRhdGFbMTFdIDw8IDgpIHwgZGF0YVsxMF0pLFxuICAgICAgZGlnX1A0OiB0aGlzLl9yZWFkU2lnbmVkMTYoKGRhdGFbMTNdIDw8IDgpIHwgZGF0YVsxMl0pLFxuICAgICAgZGlnX1A1OiB0aGlzLl9yZWFkU2lnbmVkMTYoKGRhdGFbMTVdIDw8IDgpIHwgZGF0YVsxNF0pLFxuICAgICAgZGlnX1A2OiB0aGlzLl9yZWFkU2lnbmVkMTYoKGRhdGFbMTddIDw8IDgpIHwgZGF0YVsxNl0pLFxuICAgICAgZGlnX1A3OiB0aGlzLl9yZWFkU2lnbmVkMTYoKGRhdGFbMTldIDw8IDgpIHwgZGF0YVsxOF0pLFxuICAgICAgZGlnX1A4OiB0aGlzLl9yZWFkU2lnbmVkMTYoKGRhdGFbMjFdIDw8IDgpIHwgZGF0YVsyMF0pLFxuICAgICAgZGlnX1A5OiB0aGlzLl9yZWFkU2lnbmVkMTYoKGRhdGFbMjNdIDw8IDgpIHwgZGF0YVsyMl0pLFxuICAgICAgZGlnX0gxOiB0aGlzLl9yZWFkU2lnbmVkOChkYXRhWzI0XSksXG4gICAgICBkaWdfSDI6IHRoaXMuX3JlYWRTaWduZWQxNigoZGF0YVsyNl0gPDwgOCkgfCBkYXRhWzI1XSksXG4gICAgICBkaWdfSDM6IHRoaXMuX3JlYWRTaWduZWQ4KGRhdGFbMjddKSxcbiAgICAgIGRpZ19INDogdGhpcy5fcmVhZFNpZ25lZDE2KChkYXRhWzI4XSA8PCA0KSB8ICgweDBmICYgZGF0YVsyOV0pKSxcbiAgICAgIGRpZ19INTogdGhpcy5fcmVhZFNpZ25lZDE2KChkYXRhWzMwXSA8PCA0KSB8ICgoZGF0YVsyOV0gPj4gNCkgJiAweDBmKSksXG4gICAgICBkaWdfSDY6IHRoaXMuX3JlYWRTaWduZWQ4KGRhdGFbMzFdKSxcbiAgICB9O1xuICAgIHRoaXMuX3RfZmluZSA9IDA7XG4gIH1cblxuICBfcmVhZFNpZ25lZDE2KHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlID49IDB4ODAwMCkge1xuICAgICAgdmFsdWUgPSB2YWx1ZSAtIDB4MTAwMDA7XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuICBfcmVhZFNpZ25lZDgodmFsdWUpIHtcbiAgICBpZiAodmFsdWUgPj0gMHg4MCkge1xuICAgICAgdmFsdWUgPSB2YWx1ZSAtIDB4MTAwO1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICB3cml0ZShkYXRhKSB7XG4gICAgdGhpcy5vYm5pei5pMmMwLndyaXRlKHRoaXMuYWRkcmVzcywgZGF0YSk7XG4gIH1cblxuICBhc3luYyBnZXREYXRhKCkge1xuICAgIHRoaXMuaTJjLndyaXRlKHRoaXMuYWRkcmVzcywgWzB4ZjddKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5pMmMucmVhZFdhaXQodGhpcy5hZGRyZXNzLCA4KTtcbiAgfVxuXG4gIGFzeW5jIGdldEFsbFdhaXQoKSB7XG4gICAgbGV0IGRhdGEgPSBhd2FpdCB0aGlzLmdldERhdGEoKTtcblxuICAgIGNvbnN0IHByZXNzX3JhdyA9IChkYXRhWzBdIDw8IDEyKSB8IChkYXRhWzFdIDw8IDQpIHwgKGRhdGFbMl0gPj4gNCk7XG4gICAgY29uc3QgdGVtcF9yYXcgPSAoZGF0YVszXSA8PCAxMikgfCAoZGF0YVs0XSA8PCA0KSB8IChkYXRhWzVdID4+IDQpO1xuICAgIGNvbnN0IGh1bV9yYXcgPSAoZGF0YVs2XSA8PCA4KSB8IGRhdGFbN107XG5cbiAgICBsZXQgdGVtcGVyYXR1cmUgPSB0aGlzLmNhbGlicmF0aW9uX1QodGVtcF9yYXcpIC8gMTAwLjA7XG4gICAgbGV0IHByZXNzdXJlID0gdGhpcy5jYWxpYnJhdGlvbl9QKHByZXNzX3JhdykgLyAxMDAuMDtcbiAgICBsZXQgaHVtaWRpdHkgPSB0aGlzLmNhbGlicmF0aW9uX0goaHVtX3Jhdyk7XG5cbiAgICByZXR1cm4geyB0ZW1wZXJhdHVyZSwgaHVtaWRpdHksIHByZXNzdXJlIH07XG4gIH1cblxuICBjYWxpYnJhdGlvbl9UKGFkY19UKSB7XG4gICAgbGV0IHZhcjEsIHZhcjIsIFQ7XG4gICAgdmFyMSA9XG4gICAgICAoKChhZGNfVCA+PiAzKSAtICh0aGlzLl9jYWxpYnJhdGVkLmRpZ19UMSA8PCAxKSkgKlxuICAgICAgICB0aGlzLl9jYWxpYnJhdGVkLmRpZ19UMikgPj5cbiAgICAgIDExO1xuICAgIHZhcjIgPVxuICAgICAgKCgoKChhZGNfVCA+PiA0KSAtIHRoaXMuX2NhbGlicmF0ZWQuZGlnX1QxKSAqXG4gICAgICAgICgoYWRjX1QgPj4gNCkgLSB0aGlzLl9jYWxpYnJhdGVkLmRpZ19UMSkpID4+XG4gICAgICAgIDEyKSAqXG4gICAgICAgIHRoaXMuX2NhbGlicmF0ZWQuZGlnX1QzKSA+PlxuICAgICAgMTQ7XG5cbiAgICB0aGlzLl90X2ZpbmUgPSB2YXIxICsgdmFyMjtcbiAgICBUID0gKHRoaXMuX3RfZmluZSAqIDUgKyAxMjgpID4+IDg7XG4gICAgcmV0dXJuIFQ7XG4gIH1cblxuICBjYWxpYnJhdGlvbl9QKGFkY19QKSB7XG4gICAgbGV0IHB2YXIxID0gdGhpcy5fdF9maW5lIC8gMiAtIDY0MDAwO1xuICAgIGxldCBwdmFyMiA9IChwdmFyMSAqIHB2YXIxICogdGhpcy5fY2FsaWJyYXRlZC5kaWdfUDYpIC8gMzI3Njg7XG4gICAgcHZhcjIgPSBwdmFyMiArIHB2YXIxICogdGhpcy5fY2FsaWJyYXRlZC5kaWdfUDUgKiAyO1xuICAgIHB2YXIyID0gcHZhcjIgLyA0ICsgdGhpcy5fY2FsaWJyYXRlZC5kaWdfUDQgKiA2NTUzNjtcbiAgICBwdmFyMSA9XG4gICAgICAoKHRoaXMuX2NhbGlicmF0ZWQuZGlnX1AzICogcHZhcjEgKiBwdmFyMSkgLyA1MjQyODggK1xuICAgICAgICB0aGlzLl9jYWxpYnJhdGVkLmRpZ19QMiAqIHB2YXIxKSAvXG4gICAgICA1MjQyODg7XG4gICAgcHZhcjEgPSAoMSArIHB2YXIxIC8gMzI3NjgpICogdGhpcy5fY2FsaWJyYXRlZC5kaWdfUDE7XG5cbiAgICBpZiAocHZhcjEgIT09IDApIHtcbiAgICAgIGxldCBwID0gMTA0ODU3NiAtIGFkY19QO1xuICAgICAgcCA9ICgocCAtIHB2YXIyIC8gNDA5NikgKiA2MjUwKSAvIHB2YXIxO1xuICAgICAgcHZhcjEgPSAodGhpcy5fY2FsaWJyYXRlZC5kaWdfUDkgKiBwICogcCkgLyAyMTQ3NDgzNjQ4O1xuICAgICAgcHZhcjIgPSAocCAqIHRoaXMuX2NhbGlicmF0ZWQuZGlnX1A4KSAvIDMyNzY4O1xuICAgICAgcCA9IHAgKyAocHZhcjEgKyBwdmFyMiArIHRoaXMuX2NhbGlicmF0ZWQuZGlnX1A3KSAvIDE2O1xuICAgICAgcmV0dXJuIHA7XG4gICAgfVxuICAgIHJldHVybiAwO1xuICB9XG5cbiAgY2FsaWJyYXRpb25fSChhZGNfSCkge1xuICAgIGxldCBoID0gdGhpcy5fdF9maW5lIC0gNzY4MDA7XG4gICAgaCA9XG4gICAgICAoYWRjX0ggLVxuICAgICAgICAodGhpcy5fY2FsaWJyYXRlZC5kaWdfSDQgKiA2NCArXG4gICAgICAgICAgKHRoaXMuX2NhbGlicmF0ZWQuZGlnX0g1IC8gMTYzODQpICogaCkpICpcbiAgICAgICgodGhpcy5fY2FsaWJyYXRlZC5kaWdfSDIgLyA2NTUzNikgKlxuICAgICAgICAoMSArXG4gICAgICAgICAgKHRoaXMuX2NhbGlicmF0ZWQuZGlnX0g2IC8gNjcxMDg4NjQpICpcbiAgICAgICAgICAgIGggKlxuICAgICAgICAgICAgKDEgKyAodGhpcy5fY2FsaWJyYXRlZC5kaWdfSDMgLyA2NzEwODg2NCkgKiBoKSkpO1xuICAgIGggPSBoICogKDEgLSAodGhpcy5fY2FsaWJyYXRlZC5kaWdfSDEgKiBoKSAvIDUyNDI4OCk7XG4gICAgcmV0dXJuIGg7XG4gIH1cblxuICBhc3luYyBnZXRUZW1wV2FpdCgpIHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0QWxsV2FpdCgpKS50ZW1wZXJhdHVyZTtcbiAgfVxuXG4gIGFzeW5jIGdldEh1bWRXYWl0KCkge1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRBbGxXYWl0KCkpLmh1bWlkaXR5O1xuICB9XG5cbiAgYXN5bmMgZ2V0UHJlc3N1cmVXYWl0KCkge1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRBbGxXYWl0KCkpLnByZXNzdXJlO1xuICB9XG5cbiAgYXN5bmMgZ2V0QWx0aXR1ZGVXYWl0KCkge1xuICAgIGNvbnN0IHByZXNzdXJlID0gYXdhaXQgdGhpcy5nZXRQcmVzc3VyZVdhaXQoKTtcbiAgICByZXR1cm4gdGhpcy5jYWxjQWx0aXR1ZGUocHJlc3N1cmUpO1xuICB9XG5cbiAgY2FsY0FsdGl0dWRlKHByZXNzdXJlLCBzZWFMZXZlbCA9IDEwMTMuMjUpIHtcbiAgICByZXR1cm4gKFxuICAgICAgKDEuMCAtIE1hdGgucG93KHByZXNzdXJlIC8gc2VhTGV2ZWwsIDEgLyA1LjI1NTMpKSAqIDE0NTM2Ni40NSAqIDAuMzA0OFxuICAgICk7XG4gIH1cbn1cblxuaWYgKHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnKSB7XG4gIG1vZHVsZS5leHBvcnRzID0gQk1FMjgwO1xufVxuIl19
